/*!
 *
 * SpreadJS Library 14.2.5
 *
 * Copyright(c) GrapeCity, Inc.  All rights reserved.
 *
 * Licensed under the SpreadJS Commercial License.
 * us.sales@grapecity.com
 * http://www.grapecity.com/en/licensing/grapecity/
 *
 *
 */
module.exports = function (GC) {
    var GC = typeof GC === 'object' ? GC : {};
    GC['Spread'] = GC['Spread'] || {};
    GC['Spread']['Sheets'] = (function (modules) {
        var installedModules = {};
        function __webpack_require__(moduleId) {
            if (installedModules[moduleId]) {
                return installedModules[moduleId].exports;
            }
            var module = installedModules[moduleId] = {
                i: moduleId,
                l: false,
                exports: {}
            };
            modules[moduleId].call(module.exports, module, module.exports, __webpack_require__);
            module.l = true;
            return module.exports;
        }
        __webpack_require__.m = modules;
        __webpack_require__.c = installedModules;
        __webpack_require__.d = function (exports, name, getter) {
            if (!__webpack_require__.o(exports, name)) {
                Object.defineProperty(exports, name, {
                    enumerable: true,
                    get: getter
                });
            }
        };
        __webpack_require__.r = function (exports) {
            if (typeof Symbol !== 'undefined' && Symbol.toStringTag) {
                Object.defineProperty(exports, Symbol.toStringTag, {
                    value: 'Module'
                });
            }
            Object.defineProperty(exports, '__esModule', {
                value: true
            });
        };
        __webpack_require__.t = function (value, mode) {
            if (mode & 1) value = __webpack_require__(value);
            if (mode & 8) return value;
            if ((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;
            var ns = Object.create(null);
            __webpack_require__.r(ns);
            Object.defineProperty(ns, 'default', { enumerable: true, value: value });
            if (mode & 2 && typeof value != 'string')
                for (var key in value)
                    __webpack_require__.d(ns, key, function (key) {
                        return value[key];
                    }.bind(null, key));
            return ns;
        };
        __webpack_require__.n = function (module) {
            var getter = module && module.__esModule ? function getDefault() {
                return module['default'];
            } : function getModuleExports() {
                return module;
            };
            __webpack_require__.d(getter, 'a', getter);
            return getter;
        };
        __webpack_require__.o = function (object, property) {
            return Object.prototype.hasOwnProperty.call(object, property);
        };
        __webpack_require__.p = '/assets/';
        return __webpack_require__(__webpack_require__.s = './dist/core/core.entry.js');
    })({
        './dist/core/celltype/basecelltype.js': (function (module, exports, __webpack_require__) {
            Object.defineProperty(exports, '__esModule', { value: true });
            var Common_1 = __webpack_require__(/*! Common */ 'Common');
            var domUtil_1 = __webpack_require__(/*! ../util/domUtil */ './dist/core/util/domUtil.js');
            var common_1 = __webpack_require__(/*! ../util/common */ './dist/core/util/common.js');
            var stylehelper_1 = __webpack_require__(/*! ../worksheet/stylehelper */ './dist/core/worksheet/stylehelper.js');
            var core_enum_1 = __webpack_require__(/*! ../core.enum */ './dist/core/core.enum.js');
            var celltype_ns_1 = __webpack_require__(/*! ./celltype.ns */ './dist/core/celltype/celltype.ns.js');
            var CalcEngine = __webpack_require__(/*! CalcEngine */ 'CalcEngine');
            var _isInstanceOf = Common_1.Common._isInstanceOf;
            var CultureManager = Common_1.Common.CultureManager;
            var _NumberHelper = Common_1.Common._NumberHelper;
            var _DateTimeHelper = Common_1.Common._DateTimeHelper;
            var _ColorHelper = Common_1.Common._ColorHelper;
            var _Types = Common_1.Common._Types;
            var _isNullOrUndefined = _Types._isNullOrUndefined;
            var _isType = _Types._isType;
            var getFontHeight = common_1._util._getFontHeight;
            var getHAlignByValueType = common_1._util._getHAlignByValueType;
            var _isCJKText = common_1._util._isCJKText;
            var setContextFont = common_1._util._setContextFont;
            var adjustFontWithFallback = common_1._util._adjustFontWithFallback;
            var convertRichTextValue = common_1._util._convertRichTextValue;
            var measureTextWidth = common_1._util._measureTextWidth;
            var isNeedUseSymbolFormDataType = common_1._util._isNeedUseSymbolFormDataType;
            var isformatString = common_1._util._isFormatString;
            var extend = domUtil_1.GC$.extend;
            var browser = common_1._util._browser;
            var cssLeft = 'left';
            var cssRight = 'right';
            var cssCenter = 'center';
            var textBaseline = 'alphabetic';
            var ICONSET_SIZE = 16;
            var const_string = 'string';
            var const_number = 'number';
            var keyword_null = null;
            var keyword_undefined = void 0;
            var Math_floor = Math.floor;
            var Math_ceil = Math.ceil;
            var Math_sin = Math.sin;
            var Math_cos = Math.cos;
            var Math_tan = Math.tan;
            var Math_abs = Math.abs;
            var cssNone = 'none';
            var const_general = 'General';
            var Math_max = Math.max;
            var subscriptAndSuperscriptScale = 0.7;
            var textWidthCache = {};
            var ELLIPSIS_TEXT = '...';

            // 位置类型
            var positionType;
            (function (positionType) {
                positionType[positionType['top'] = 0] = 'top';
                positionType[positionType['right'] = 1] = 'right';
                positionType[positionType['bottom'] = 2] = 'bottom';
                positionType[positionType['left'] = 3] = 'left';
            })(positionType || (positionType = {}));

            // 是否存在缩放因子
            function isPrintZoomFactorExist(option) {
                var isPrinting = option.isPrinting;
                var printZoomFactor = option.printZoomFactor;
                return (isPrinting && typeof printZoomFactor === const_number && printZoomFactor !== 1);
            }

            // 单元格类型上下文
            var CellTypeContext = (function () {
                function CellTypeContext() { }
                // 尝试从科学计数法获取数字的真实长度
                CellTypeContext._tryToGetRightNumLengthFromScientificotation = function (valueString) {
                    var rightPart = valueString.split('e')[1];
                    var isAdd;
                    var length;
                    if (rightPart && rightPart.length > 0) {
                        if (rightPart[0] === '+') {
                            isAdd = true;
                        } else if (rightPart[0] === '-') {
                            isAdd = false;
                        }
                        length = rightPart.slice(1);
                    }
                    if (isAdd !== undefined) {
                        return {
                            isAdd: isAdd,
                            length: length
                        };
                    }
                };
                // 获取文字宽度的缓存
                CellTypeContext._getTextWidthCache = function (ctx, font, string) {
                    var _measureTextWidthCache = CellTypeContext._measureTextWidthCache;
                    var result = _measureTextWidthCache[font + string];
                    if (!result) {
                        result = measureTextWidth(ctx, font, string);
                        _measureTextWidthCache[font + string] = result;
                    }
                    return result;
                };
                // 获取数值格式
                CellTypeContext._getFormatForNumberValue = function (ctx, value, width, style, zoom) {
                    var font = style.font;
                    width = width - 1 - 3 * zoom;
                    var isHasTextIndent = style.textIndent && style.textIndent !== 0;
                    var isVerticalText = style.isVerticalText;
                    if (
                        typeof value === const_number
                        && style.shrinkToFit !== true
                        && !isVerticalText && !isHasTextIndent
                    ) {
                        var isNegativeValue = value < 0;
                        value = Math_abs(value);
                        var negativeLength = isNegativeValue ? CellTypeContext._getTextWidthCache(ctx, font, '-') : 0;
                        var valueString = value.toString();
                        var result = CellTypeContext._tryToGetRightNumLengthFromScientificotation(valueString);
                        var rightNumlength = void 0;
                        var minDecimalsNumberBeforeE = CellTypeContext._getMinDecimalsNumberBeforeE(style._autoFormatter, value);
                        if (result) {
                            rightNumlength = (result.length).toString().length;
                            rightNumlength = Math_max(rightNumlength, 2);
                            return CellTypeContext._getScientificotationNFormatString(ctx, width, style, rightNumlength, negativeLength, result.isAdd, minDecimalsNumberBeforeE);
                        }
                        var allNumberLength = negativeLength;
                        var lengthWidthNumber = CellTypeContext._getTextWidthCache(ctx, font, '0');
                        var numArray = valueString.split('.');
                        var intPartNumber = Math.round(value).toString().length;
                        var intStringLength = lengthWidthNumber * intPartNumber;
                        allNumberLength += intStringLength;
                        var lengthWidthecimalPoint = CellTypeContext._getTextWidthCache(ctx, font, '.');
                        var formatString = void 0;
                        if (intStringLength <= width) {
                            if (!numArray[1] || numArray[1].length === 0) {
                                return style._autoFormatter;
                            }
                            allNumberLength = allNumberLength + numArray[1].length * lengthWidthNumber + lengthWidthecimalPoint;
                            if (allNumberLength <= width) {
                                return style._autoFormatter;
                            }
                            if (value < 0.001) {
                                rightNumlength = (numArray[1].length).toString().length;
                                rightNumlength = Math_max(rightNumlength, 2);
                                return CellTypeContext._getScientificotationNFormatString(ctx, width, style, rightNumlength, negativeLength, false, minDecimalsNumberBeforeE);
                            }
                            var decimalsLength = width - negativeLength - intStringLength - lengthWidthecimalPoint;
                            var decimalsNumber = Math.floor(decimalsLength / lengthWidthNumber);
                            decimalsNumber = Math.min(decimalsNumber, numArray[1].length);
                            formatString = '0';
                            if (decimalsNumber > 0) {
                                formatString += '.';
                            }
                            for (var i = 0; i < decimalsNumber; i++) {
                                formatString += '0';
                            }
                            return formatString;
                        }
                        var tempValue = Math.round(value);
                        rightNumlength = (tempValue.toString().length).toString().length;
                        rightNumlength = Math_max(rightNumlength, 2);
                        return CellTypeContext._getScientificotationNFormatString(ctx, width, style, rightNumlength, negativeLength, true, minDecimalsNumberBeforeE);
                    }
                    return style._autoFormatter;
                };
                CellTypeContext._getScientificotationNFormatString = function (ctx, width, style, rightNumlength, negativeLength, isAdd, minDecimalsNumberBeforeE) {
                    var font = style.font;
                    var lengthWidthNumber = CellTypeContext._getTextWidthCache(ctx, font, '0');
                    var lengthWidthE = CellTypeContext._getTextWidthCache(ctx, font, 'E');
                    var lengthWidthAdd = CellTypeContext._getTextWidthCache(ctx, font, '+');
                    var lengthWithSubtract = CellTypeContext._getTextWidthCache(ctx, font, '-');
                    var symbolWith = isAdd ? lengthWidthAdd : lengthWithSubtract;
                    var lengthWidthecimalPoint = CellTypeContext._getTextWidthCache(ctx, font, '.');
                    var leftNumWithoutDecimalPointLength = width - negativeLength - (rightNumlength * lengthWidthNumber) - lengthWidthE - symbolWith - lengthWidthNumber;
                    var leftNumLength = leftNumWithoutDecimalPointLength - lengthWidthecimalPoint;
                    if (leftNumLength <= lengthWidthNumber) {
                        if (isAdd) {
                            return '0E+00';
                        } else if (leftNumWithoutDecimalPointLength > 0) {
                            return '0E-00';
                        }
                        return '0';
                    }
                    var decimalsNumberBeforeE = Math.floor(leftNumLength / lengthWidthNumber);
                    decimalsNumberBeforeE = Math.min(decimalsNumberBeforeE, minDecimalsNumberBeforeE);
                    var formatString = '0';
                    for (var j = 0; j < decimalsNumberBeforeE; j++) {
                        if (j === 0) {
                            formatString += '.';
                        }
                        formatString += '0';
                    }
                    formatString += isAdd ? 'E+00' : 'E-00';
                    return formatString;
                };
                // 将文本更改为符号
                CellTypeContext._changeTextToSymbol = function (ctx, text, width, style, zoom) {
                    var font = style.font;
                    width = width - 1 - 3 * zoom;
                    var textIndent = style.textIndent || 0;
                    var hAlign = style.hAlign;
                    var widthTemp = width;
                    if (hAlign !== 1 && textIndent > 0) {
                        widthTemp = width - textIndent * 8;
                    }
                    var defaultWidth = measureTextWidth(ctx, style.font, text);
                    if (widthTemp < defaultWidth) {
                        var lengthWidthSymbol = CellTypeContext._getTextWidthCache(ctx, font, '#');
                        var symbolNumber = Math.floor(width / lengthWidthSymbol);
                        var resultText = '';
                        for (var i = 0; i < symbolNumber; i++) {
                            resultText += '#';
                        }
                        return resultText;
                    }
                    return text;
                };
                // 绘制背景图
                CellTypeContext._paintBackgroundImage = function (ctx, x, y, w, h, backgroundImage, backgroundImageLayout, imageLoader) {
                    if (backgroundImage && backgroundImage !== 'none' && imageLoader) {
                        try {
                            if (imageLoader._getState(backgroundImage)) {
                                var bkImg = imageLoader._getImage(backgroundImage);
                                var div = void 0;
                                if (browser.msie) {
                                    div = document.createElement('div');
                                    div.appendChild(bkImg);
                                    document.body.appendChild(div);
                                }
                                var imgWidth = bkImg.width;
                                var imgHeight = bkImg.height;
                                if (browser.msie) {
                                    div.removeChild(bkImg);
                                    document.body.removeChild(div);
                                }
                                var sx = 0;
                                var sy = 0;
                                var swidth = imgWidth;
                                var sheight = imgHeight;
                                var useWidth = w;
                                var useHeight = h;
                                var px = x;
                                var py = y;
                                if (backgroundImageLayout === 1) {
                                    swidth = w >= imgWidth ? imgWidth : w;
                                    sheight = h >= imgHeight ? imgHeight : h;
                                    px = (w > imgWidth) && (imgWidth > 0) ? Math_ceil(x + w / 2 - imgWidth / 2) : x;
                                    py = (h > imgHeight) && (imgHeight > 0) ? Math_ceil(y + h / 2 - imgHeight / 2) : y;
                                    useWidth = swidth;
                                    useHeight = sheight;
                                } else if (backgroundImageLayout === 2) {
                                    if (h > 0 && imgHeight > 0 && w / h > imgWidth / imgHeight) {
                                        useWidth = imgWidth / imgHeight * h;
                                        px = x + w / 2 - useWidth / 2;
                                    } else if (w > 0 && imgWidth > 0 && h / w > imgHeight / imgWidth) {
                                        useHeight = imgHeight / imgWidth * w;
                                        py = y + h / 2 - useHeight / 2;
                                    }
                                } else if (backgroundImageLayout === 3) {
                                    swidth = w >= imgWidth ? imgWidth : w;
                                    sheight = h >= imgHeight ? imgHeight : h;
                                    useWidth = swidth;
                                    useHeight = sheight;
                                }
                                ctx.drawImage(bkImg, sx, sy, swidth, sheight, px, py, useWidth, useHeight);
                            } else {
                                imageLoader._addImage(backgroundImage);
                            }
                        } catch (ex) { }
                    }
                };
                // 获取自适应宽度
                CellTypeContext._getAutoFitWidth = function (value, text, cellStyle, zoomFactor, context) {
                    var width = 0;
                    var sheet = context && context.sheet;
                    var textIndent = cellStyle.textIndent;
                    var hAlign = cellStyle.hAlign;
                    var isVerticalText = cellStyle.isVerticalText;
                    var textOrientation = cellStyle.textOrientation;
                    var hasBorder = cellStyle.borderTop || cellStyle.borderBottom || cellStyle.borderLeft || cellStyle.borderRight;
                    var i;
                    var sintextOrientation;
                    var costextOrientation;
                    var defaultFont = cellStyle.font;
                    var row = context.row;
                    var col = context.col;
                    if (textOrientation && -90 <= textOrientation && textOrientation <= 90) {
                        var textOrientationRadian = Math_abs(textOrientation * Math.PI / 180);
                        sintextOrientation = Math_sin(textOrientationRadian);
                        costextOrientation = Math_cos(textOrientationRadian);
                    }
                    if (sheet && typeof text === const_string && text) {
                        var lines = [];
                        var richText = void 0;
                        if (value && value.richText) {
                            var formatter = cellStyle.formatter || cellStyle._autoFormatter;
                            var cellType = sheet.getCellType(row, col);
                            var isRichTextAvailable = cellType._isRichTextAvailable(formatter, value.text);
                            richText = extend(true, [], cellType._getRichTextValue(value, text, isRichTextAvailable, defaultFont, cellStyle.foreColor));
                            scaleFontByZoomFactor(richText, defaultFont, zoomFactor);
                            if (isVerticalText) {
                                if (cellStyle.wordWrap) {
                                    var sheetArea = context.sheetArea;
                                    var rowHeight = sheet._getZoomRowHeight(row);
                                    var span = sheet._modelManager.findSpan(row, col, sheetArea);
                                    if (span && span.row >= row && span.col >= col && span.rowCount > 1) {
                                        for (var rowIndex = (row + 1); rowIndex < (row + span.rowCount); rowIndex++) {
                                            rowHeight += sheet._getZoomRowHeight(rowIndex);
                                        }
                                    }
                                    var indent = 0;
                                    if (textIndent > 0) {
                                        indent = textIndent * 8;
                                    }
                                    var topOffset = getPositionOffset(cellStyle, 0);
                                    var bottomOffset = getPositionOffset(cellStyle, 2);
                                    if (topOffset > 0) {
                                        rowHeight -= topOffset;
                                    }
                                    if (bottomOffset > 0) {
                                        rowHeight -= bottomOffset;
                                    }
                                    rowHeight++;
                                    lines = common_1._WordWrapHelper._getWordWrapInfo(text, rowHeight - 3 - indent, defaultFont, richText, isVerticalText);
                                    for (i = 0; i < lines.length; i++) {
                                        width += getMaxHeightInLine(lines[i].textInfos, defaultFont, zoomFactor);
                                    }
                                } else {
                                    width = getMaxHeightInLine(richText, defaultFont, zoomFactor);
                                }
                            } else {
                                if (cellStyle.wordWrap) {
                                    var linesByLineBreak = text.split(/\r\n|\r|\n/);
                                    for (i = 0; i < linesByLineBreak.length; i++) {
                                        var line = [];
                                        line.push(linesByLineBreak[i]);
                                        lines.push(line);
                                    }
                                    lines = common_1._WordWrapHelper._composeTextInfos(lines, common_1._WordWrapHelper._trimLineBreaksInRichText(richText));
                                    for (i = 0; i < lines.length; i++) {
                                        width = Math.max(width, getTextLengthInLine(lines[i], defaultFont, zoomFactor, isVerticalText, true));
                                    }
                                } else {
                                    width = getTextLengthInLine(richText, defaultFont, zoomFactor);
                                }
                                if (hAlign !== 1 && textIndent > 0) {
                                    width += textIndent * 8 / zoomFactor;
                                }
                                if (cellTypeContext_hasIconSet(sheet, row, col, context.sheetArea)) {
                                    width += cellTypeContext_getIconSetSize(sheet);
                                }
                            }
                        } else {
                            lines = text.split(/\r\n|\r|\n/);
                            var font = cellStyle.font;
                            var lineHeight = getFontHeight(font) / zoomFactor;
                            if (isVerticalText) {
                                if (cellStyle.wordWrap) {
                                    for (i = 0; i < lines.length; i++) {
                                        width += lineHeight;
                                    }
                                } else {
                                    width = lineHeight;
                                }
                            } else {
                                if (cellStyle.wordWrap) {
                                    if (textOrientation) {
                                        var cellHeight = sheet._getZoomRowHeight(row);
                                        return common_1._WordWrapHelper._getRotateTextWordWrapWidth(row, col, sintextOrientation, costextOrientation, text, font, cellHeight);
                                    }
                                    for (i = 0; i < lines.length; i++) {
                                        width = Math.max(width, common_1._WordWrapHelper._measureText(lines[i], font, true) / zoomFactor);
                                    }
                                } else if (textOrientation) {
                                    if (hasBorder) {
                                        width = (lineHeight + 4) / sintextOrientation;
                                    } else {
                                        width = costextOrientation * (sheet._getStringWidthByCanvas(text, font) / zoomFactor) + lineHeight * sintextOrientation;
                                    }
                                } else {
                                    width = sheet._getStringWidthByCanvas(text, font) / zoomFactor;
                                }
                                if (hAlign !== 1 && textIndent > 0) {
                                    width += textIndent * 8 / zoomFactor;
                                }
                                if (cellTypeContext_hasIconSet(sheet, row, col, context.sheetArea)) {
                                    width += ICONSET_SIZE;
                                }
                            }
                        }
                    }
                    return width;
                };
                // 获取自适应高度
                CellTypeContext._getAutoFitHeight = function (value, text, cellStyle, zoomFactor, context) {
                    var height = 0, i;
                    var sheet = context && context.sheet;
                    var defaultFont = cellStyle.font;
                    var isVerticalText = cellStyle.isVerticalText;
                    var textIndent = cellStyle.textIndent;
                    var vAlign = cellStyle.vAlign;
                    var textOrientation = cellStyle.textOrientation;
                    var row = context.row;
                    var col = context.col;
                    var sheetArea;
                    var columnWidth;
                    var rowHeight;
                    var textWidth;
                    var span;
                    var colIdx;
                    var rowIdx;
                    var indent;
                    var rightOffset;
                    var leftOffset;
                    var topOffset;
                    var bottomOffset;
                    var sintextOrientation;
                    var costextOrientation;
                    if (textOrientation && -90 <= textOrientation && textOrientation <= 90) {
                        var textOrientationRadian = Math_abs(textOrientation * Math.PI / 180);
                        sintextOrientation = Math_sin(textOrientationRadian);
                        costextOrientation = Math_cos(textOrientationRadian);
                    }
                    if (sheet && typeof text === const_string && text) {
                        var lines = [];
                        var richText = void 0;
                        if (value && value.richText) {
                            var formatter = cellStyle.formatter || cellStyle._autoFormatter;
                            var cellType = sheet.getCellType(row, col);
                            var isRichTextAvailable = cellType._isRichTextAvailable(formatter, value.text);
                            richText = extend(true, [], cellType._getRichTextValue(value, text, isRichTextAvailable, defaultFont, cellStyle.foreColor));
                            scaleFontByZoomFactor(richText, defaultFont, zoomFactor);
                            if (isVerticalText) {
                                if (cellStyle.wordWrap) {
                                    var linesByLineBreak = text.split(/\r\n|\r|\n/);
                                    for (i = 0; i < linesByLineBreak.length; i++) {
                                        var line = [];
                                        line.push(linesByLineBreak[i]);
                                        lines.push(line);
                                    }
                                    lines = common_1._WordWrapHelper._composeTextInfos(lines, common_1._WordWrapHelper._trimLineBreaksInRichText(richText));
                                    for (i = 0; i < lines.length; i++) {
                                        height = Math.max(height, getTextLengthInLine(lines[i], defaultFont, zoomFactor, isVerticalText, true));
                                    }
                                } else {
                                    height = getTextLengthInLine(richText, defaultFont, zoomFactor, isVerticalText);
                                }
                                if (vAlign !== 1 && textIndent > 0) {
                                    height += textIndent * 8 / zoomFactor;
                                }
                            } else if (cellStyle.wordWrap) {
                                sheetArea = context.sheetArea;
                                columnWidth = sheet._getZoomColumnWidth(col);
                                span = sheet._modelManager.findSpan(row, col, sheetArea);
                                if (span && span.row >= row && span.col >= col && span.colCount > 1) {
                                    for (colIdx = (col + 1); colIdx < (col + span.colCount); colIdx++) {
                                        columnWidth += sheet._getZoomColumnWidth(colIdx);
                                    }
                                }
                                indent = 0;
                                if (textIndent > 0) {
                                    indent = textIndent * 8;
                                }
                                rightOffset = getPositionOffset(cellStyle, 1);
                                leftOffset = getPositionOffset(cellStyle, 3);
                                if (leftOffset > 0) {
                                    columnWidth -= leftOffset;
                                }
                                if (rightOffset > 0) {
                                    columnWidth -= rightOffset;
                                }
                                columnWidth++;
                                lines = common_1._WordWrapHelper._getWordWrapInfo(text, columnWidth - 3 - indent, defaultFont, richText);
                                for (i = 0; i < lines.length; i++) {
                                    height += getMaxHeightInLine(lines[i].textInfos, defaultFont, zoomFactor);
                                }
                            } else {
                                height = getMaxHeightInLine(richText, defaultFont, zoomFactor);
                            }
                        } else {
                            var font = cellStyle.font;
                            var lineHeight = getFontHeight(font) / zoomFactor;
                            if (isVerticalText) {
                                if (cellStyle.wordWrap) {
                                    lines = text.split(/\r\n|\r|\n/);
                                    for (i = 0; i < lines.length; i++) {
                                        var textLength = lines[i].length * lineHeight;
                                        height = Math.max(height, textLength);
                                    }
                                } else {
                                    height = text.length * lineHeight;
                                }
                                if (vAlign !== 1 && textIndent > 0) {
                                    height += textIndent * 8 / zoomFactor;
                                }
                            } else if (cellStyle.wordWrap) {
                                sheetArea = context.sheetArea;
                                columnWidth = sheet._getZoomColumnWidth(col);
                                rowHeight = sheet._getZoomRowHeight(row);
                                span = sheet._modelManager.findSpan(row, col, sheetArea);
                                if (span && span.row >= row && span.col >= col && span.colCount > 1) {
                                    for (colIdx = (col + 1); colIdx < (col + span.colCount); colIdx++) {
                                        columnWidth += sheet._getZoomColumnWidth(colIdx);
                                    }
                                    for (rowIdx = (row + 1); rowIdx < (row + span.colCount); rowIdx++) {
                                        rowHeight += sheet._getZoomRowHeight(rowIdx);
                                    }
                                }
                                indent = 0;
                                if (textIndent > 0) {
                                    indent = textIndent * 8;
                                }
                                rightOffset = getPositionOffset(cellStyle, 1);
                                leftOffset = getPositionOffset(cellStyle, 3);
                                topOffset = getPositionOffset(cellStyle, 0);
                                bottomOffset = getPositionOffset(cellStyle, 2);
                                if (leftOffset > 0) {
                                    columnWidth -= leftOffset;
                                }
                                if (rightOffset > 0) {
                                    columnWidth -= rightOffset;
                                }
                                if (topOffset > 0) {
                                    rowHeight -= topOffset;
                                }
                                if (bottomOffset > 0) {
                                    rowHeight -= bottomOffset;
                                }
                                if (sheetArea === 1) {
                                    var rowFilter = sheet.rowFilter && sheet.rowFilter();
                                    var hasFilterHeader = !!(rowFilter && rowFilter._isFilterHeader(row, col, sheetArea) && rowFilter.filterButtonVisible(col));
                                    if (hasFilterHeader) {
                                        columnWidth -= sheet._getFilterButtonRect(new common_1.Rect(0, 0, columnWidth, rowHeight), sheetArea).width;
                                    }
                                }
                                if (textOrientation) {
                                    var wordWrapWidth = (rowHeight - lineHeight * costextOrientation) / sintextOrientation;
                                    lines = common_1._WordWrapHelper._getWrapInfo(text, wordWrapWidth, font);
                                    textWidth = sheet._getStringWidthByCanvas(lines[0], font) / zoomFactor;
                                    height = sintextOrientation * textWidth + lineHeight * costextOrientation;
                                    return height;
                                }
                                if (isNeedUseSymbolFormDataType(value)) {
                                    lines = [text];
                                } else {
                                    lines = common_1._WordWrapHelper._getWrapInfo(text, columnWidth - 3 - indent, font);
                                }
                                height = lines.length * lineHeight;
                            } else if (textOrientation) {
                                textWidth = sheet._getStringWidthByCanvas(text, font) / zoomFactor;
                                height = sintextOrientation * textWidth + lineHeight * costextOrientation;
                            } else {
                                height = lineHeight;
                            }
                        }
                    }
                    return height;
                };
                // 绘制标题单元格网格线
                CellTypeContext._paintHeaderCellGridline = function (ctx, x, y, w, h, style, headerTypeString, themeStyle, sheetArea, needTopGridline, needLeftGridline) {
                    var strokeStyle;
                    if (sheetArea === 1) {
                        ctx.beginPath();
                        strokeStyle = ctx.createLinearGradient(x, y + 1, x, y + h - 2);
                        strokeStyle.addColorStop(0, themeStyle.borderLeftColor);
                        strokeStyle.addColorStop(1, themeStyle.borderRightColor);
                        if (ctx.strokeStyle !== strokeStyle) {
                            ctx.strokeStyle = strokeStyle;
                        }
                        if (!style.borderLeft) {
                            ctx.moveTo(x + 0.5, y);
                            ctx.lineTo(x + 0.5, y + h);
                        }
                        if (!style.borderRight) {
                            ctx.moveTo(x + w - 0.5, y);
                            ctx.lineTo(x + w - 0.5, y + h);
                        }
                        if (needTopGridline && !style.borderTop) {
                            ctx.moveTo(x, y + 0.5);
                            ctx.lineTo(x + w, y + 0.5);
                        }
                        ctx.stroke();
                        if (themeStyle.borderBottomWidth && !style.borderBottom) {
                            ctx.beginPath();
                            if (ctx.strokeStyle !== themeStyle.borderBottomColor) {
                                ctx.strokeStyle = themeStyle.borderBottomColor;
                            }
                            ctx.moveTo(x + 1, y + h - 0.5);
                            ctx.lineTo(x + w, y + h - 0.5);
                            ctx.stroke();
                        }
                    } else {
                        ctx.beginPath();
                        strokeStyle = ctx.createLinearGradient(x, y, x + w - 2, y);
                        strokeStyle.addColorStop(0, themeStyle.borderTopColor);
                        strokeStyle.addColorStop(1, themeStyle.borderBottomColor);
                        if (ctx.strokeStyle !== strokeStyle) {
                            ctx.strokeStyle = strokeStyle;
                        }
                        if (!style.borderTop) {
                            ctx.moveTo(x, y + 0.5);
                            ctx.lineTo(x + w, y + 0.5);
                        }
                        if (!style.borderBottom) {
                            ctx.moveTo(x, y + h - 0.5);
                            ctx.lineTo(x + w, y + h - 0.5);
                        }
                        if (needLeftGridline && !style.borderLeft) {
                            ctx.moveTo(x + 0.5, y);
                            ctx.lineTo(x + 0.5, y + h);
                        }
                        ctx.stroke();
                        if (themeStyle.borderRightWidth && !style.borderRight) {
                            ctx.beginPath();
                            if (ctx.strokeStyle !== themeStyle.borderRightColor) {
                                ctx.strokeStyle = themeStyle.borderRightColor;
                            }
                            ctx.moveTo(x + w - 0.5, y + 1);
                            ctx.lineTo(x + w - 0.5, y + h);
                            ctx.stroke();
                        }
                    }
                };
                // 设置输入法
                CellTypeContext._setImeMode = function (element, imeMode) {
                    var cssImeModeString;
                    if (imeMode === 2) {
                        cssImeModeString = 'active';
                    } else if (imeMode === 4) {
                        cssImeModeString = 'inactive';
                    } else if (imeMode === 0) {
                        cssImeModeString = 'disabled';
                    } else {
                        cssImeModeString = 'auto';
                    }
                    domUtil_1.GC$(element).css('ime-mode', cssImeModeString);
                };
                // 绘制迷你线
                CellTypeContext._paintSparklineEx = function (ctx, value, x, y, w, h, option) {
                    if (value && value.typeName === 'SparklineExValue') {
                        var sheet = option.sheet;
                        var sp = sheet && sheet.parent;
                        if (sp) {
                            var sparklineEx = sp.getSparklineEx(value.name);
                            if (sparklineEx) {
                                var zoomFactor = isPrintZoomFactorExist(option) ? option.printZoomFactor : sheet.zoom();
                                var paintOption = {
                                    zoomFactor: zoomFactor,
                                    sheet: sheet,
                                    rowIndex: option.row,
                                    columnIndex: option.col,
                                };
                                sparklineEx.paint(ctx, value.value, x, y, w, h, paintOption);
                                return true;
                            }
                        }
                    }
                    return false;
                };
                // 测量文本宽度缓存
                CellTypeContext._measureTextWidthCache = {};
                // 获取E之前的最小小数
                CellTypeContext._getMinDecimalsNumberBeforeE = function (autoFormatter, value) {
                    if (autoFormatter && autoFormatter._getFormatInfo) {
                        var formatInfo = autoFormatter._getFormatInfo(value);
                        var formatResult = formatInfo.format(value);
                        if (formatResult && formatResult[1] && formatResult[1].type === 'decimalSeparator') {
                            var formatResultItem = formatResult[2];
                            if (formatResultItem && formatResultItem.type === const_number) {
                                var numberValue = formatResultItem.value;
                                var EFormatResult = formatResult[3];
                                var isScientificotationNFormat = EFormatResult && EFormatResult.type === 'exponent' && EFormatResult.value && EFormatResult.value.indexOf('E') > -1;
                                if (!_isNullOrUndefined(numberValue) && isScientificotationNFormat) {
                                    return numberValue.length;
                                }
                                return 5;
                            }
                            return 0;
                        }
                    }
                    return 5;
                };
                // 获取位置偏移
                CellTypeContext._getPositionOffset = getPositionOffset;
                return CellTypeContext;
            }());
            exports.Context = CellTypeContext;

            // 获取线偏移
            function getLineOffset(fontSize, lineHeight) {
                var baselineOffset = fontSize > 8 ? Math_floor((fontSize - 8) / 5 + 2) : 1;
                return lineHeight / 2 - fontSize / 2 + baselineOffset - 1;
            }
            var bracketsMap = {
                9001: 65087,
                9002: 65088,
                10216: 65087,
                10217: 65088,
                10092: 65087,
                10093: 65088,
                10096: 65087,
                10097: 65088,
                12296: 65087,
                12297: 65088,
                9121: 65089,
                9126: 65090,
                12300: 65089,
                12301: 65090,
                65378: 65089,
                65379: 65090,
                40: 9180,
                41: 9181,
                91: 9140,
                93: 9141,
                65339: 9140,
                65341: 9141,
                123: 9182,
                125: 9183,
                10100: 9182,
                10101: 9183,
                65115: 9182,
                65116: 9183,
                65371: 9182,
                65373: 9183,
                12310: 65047,
                12311: 65048,
                10098: 65081,
                10099: 65082,
                12308: 65081,
                12309: 65082,
                65117: 65081,
                65118: 65082,
                12304: 65083,
                12305: 65084,
                10218: 65085,
                10219: 65086,
                12298: 65085,
                12299: 65086,
                12302: 65091,
                12303: 65092
            };
            function replaceVerticalBrackets(char) {
                var verticalBracketsUnicode = bracketsMap[char.charCodeAt(0)];
                return verticalBracketsUnicode ? String.fromCharCode(verticalBracketsUnicode) : char;
            }
            // 获取编辑的矩形
            function getEditorRect(contentRect, leftExternalRect, rightExternalRect) {
                if (!_isNullOrUndefined(contentRect.x)) {
                    contentRect.x += leftExternalRect.width;
                }
                contentRect.width = contentRect.width - leftExternalRect.width - rightExternalRect.width;
                return contentRect;
            }
            // 重置填充样式
            function resetFillStyle(ctx, sheet, style, opacity) {
                var fillStyle = style.foreColor;
                fillStyle = common_1._ThemeStyleHelper._getColorStringFromThemeColor(sheet, fillStyle);
                opacity = !_isNullOrUndefined(style.opacity) ? style.opacity : opacity;
                if (!_isNullOrUndefined(opacity)) {
                    var color = _ColorHelper._fromString(fillStyle);
                    color.a = opacity;
                    fillStyle = _ColorHelper._toString(color);
                }
                if (ctx.fillStyle !== fillStyle) {
                    ctx.fillStyle = fillStyle || '#000000';
                }
            }
            var BaseCellType = (function () {
                function BaseCellType() {
                    this.allowOverflow = false;
                    this.typeName = 0 + '';
                }
                // 调用绘制单元格填充功能处理程序
                BaseCellType.prototype._callPaintCellPaddingFeatureHandler = function (ctx, cellRect, context, value) {
                    var args = {
                        ctx: ctx,
                        options: {
                            rect: cellRect,
                            context: context,
                            value: value
                        }
                    };
                    BaseCellType._callFeatureHandler(context.sheet, 'paintCellPadding', args);
                    return args.options.rect;
                };
                // 调用创建单元编辑器功能处理程序
                BaseCellType.prototype._callOnCreateCellEditorFeatureHandler = function (context, dom, cellRect) {
                    var args = {
                        context: context,
                        options: {
                            dom: dom,
                            cellRect: cellRect,
                            contentRect: cellRect.clone(),
                            leftExternalRect: new common_1.Rect(0, 0, 0, 0),
                            rightExternalRect: new common_1.Rect(0, 0, 0, 0)
                        }
                    };
                    BaseCellType._callFeatureHandler(context.sheet, 'onCreateCellEditor', args);
                    return args.options.dom;
                };
                // 调用获取单元格按钮矩形功能处理程序
                BaseCellType.prototype._callGetCellButtonRectFeatureHandler = function (context, cellRect, style) {
                    var cellButtonArgs = {
                        ctx: null,
                        options: {
                            rect: cellRect.clone(),
                            context: context,
                            value: null,
                            style: style
                        }
                    };
                    BaseCellType._callFeatureHandler(context.sheet, 'getCellButtonRect', cellButtonArgs);
                    return cellButtonArgs.options.rect;
                };
                // 调用激活单元格编辑器功能处理程序
                BaseCellType.prototype._callOnActivateCellEditorFeatureHandler = function (context, dom, cellRect, cellStyle) {
                    var activateArgs = {
                        context: context,
                        options: {
                            dom: dom,
                            cellRect: cellRect,
                            cellStyle: cellStyle,
                            contentRect: cellRect.clone(),
                            leftExternalRect: new common_1.Rect(0, 0, 0, 0),
                            rightExternalRect: new common_1.Rect(0, 0, 0, 0)
                        }
                    };
                    BaseCellType._callFeatureHandler(context.sheet, 'onActivateCellEditor', activateArgs);
                    return activateArgs;
                };
                // 调用更新编辑器容器功能处理程序
                BaseCellType.prototype._callUpdateEditorContainerFeatureHandler = function (context, contentContainer, editorBounds, cellStyle) {
                    var args = {
                        context: context,
                        contentContainer: contentContainer,
                        editorBounds: editorBounds,
                        cellStyle: cellStyle,
                        contentRect: editorBounds.clone(),
                        leftExternalRect: new common_1.Rect(0, 0, 0, 0),
                        rightExternalRect: new common_1.Rect(0, 0, 0, 0)
                    };
                    BaseCellType._callFeatureHandler(context.sheet, 'onUpdateContainer', args);
                    return args;
                };
                // 调用停用编辑器容器功能处理程序
                BaseCellType.prototype._callOnDeactivateEditorContainerFeatureHandler = function (context, dom, cellRect) {
                    var deactivateArgs = {
                        context: context,
                        options: {
                            dom: dom,
                            cellRect: cellRect,
                            contentRect: cellRect.clone(),
                            leftExternalRect: new common_1.Rect(0, 0, 0, 0),
                            rightExternalRect: new common_1.Rect(0, 0, 0, 0)
                        }
                    };
                    BaseCellType._callFeatureHandler(context.sheet, 'onDeactivateCellEditor', deactivateArgs);
                    return deactivateArgs.options.dom;
                };
                // 停用编辑器包装器
                BaseCellType.prototype._deactivateEditorWrapper = function (editorContext, context, cellRect) {
                    var self = this;
                    self.deactivateEditor(editorContext, context);
                    self._callOnDeactivateEditorContainerFeatureHandler(context, editorContext, cellRect);
                };
                // 绘制标签
                BaseCellType.prototype._paintLabel = function (ctx, cellRect, cellStyle, context) {
                    var labelOptions = cellStyle.labelOptions;
                    if (!labelOptions) {
                        return;
                    }
                    var sheet = context.sheet;
                    var watermark = cellStyle.watermark;
                    if (watermark) {
                        var labelVisibility = labelOptions.visibility;
                        var cellText = sheet.getText(context.row, context.col, context.sheetArea);
                        if (labelVisibility === 1 || ((labelVisibility === 2 || labelVisibility === keyword_undefined) && cellText === '')) {
                            return;
                        }
                        var zoomFactor = sheet.zoom();
                        var labelFont = labelOptions.font, fontInfo = void 0;
                        if (labelFont) {
                            fontInfo = stylehelper_1._StyleHelper._scaleFont(labelFont, zoomFactor);
                        } else {
                            fontInfo = stylehelper_1._StyleHelper._scaleFont(cellStyle.font, 1);
                        }
                        var lineHeight = getFontHeight(fontInfo.font);
                        var clipRect = getClipRect(cellRect, cellStyle), labelPosition = void 0;
                        if (isPaintLabel(cellStyle, cellRect)) {
                            labelPosition = getLabelPosition(cellRect, cellStyle, fontInfo, lineHeight);
                        }
                        if (labelPosition) {
                            ctx.save();
                            ctx.textAlign = getTextAlign(labelOptions.alignment);
                            ctx.textBaseline = 'alphabetic';
                            setContextFont(ctx, fontInfo.font);
                            ctx.fillStyle = labelOptions.foreColor || cellStyle.foreColor || 'grey';
                            ctx.rect(clipRect.x, clipRect.y, clipRect.width, clipRect.height);
                            ctx.clip();
                            ctx.beginPath();
                            ctx.fillText(watermark, labelPosition.x, labelPosition.y);
                            ctx.restore();
                        }
                    }
                };
                // 获取内容矩形
                BaseCellType.prototype._getContentRect = function (cellRect, cellStyle, zoomFactor) {
                    var newRect = cellRect.clone();
                    var topOffset = getPositionOffset(cellStyle, 0, false, zoomFactor);
                    var rightOffset = getPositionOffset(cellStyle, 1, false, zoomFactor);
                    var bottomOffset = getPositionOffset(cellStyle, 2, false, zoomFactor);
                    var leftOffset = getPositionOffset(cellStyle, 3, false, zoomFactor);
                    if (topOffset > 0) {
                        newRect.y += topOffset;
                        newRect.height -= topOffset;
                    }
                    if (bottomOffset > 0) {
                        newRect.height -= bottomOffset;
                    }
                    if (leftOffset > 0) {
                        newRect.x += leftOffset;
                        newRect.width -= leftOffset;
                    }
                    if (rightOffset > 0) {
                        newRect.width -= rightOffset;
                    }
                    if (rightOffset + leftOffset >= cellRect.width) {
                        newRect.width = 0;
                    }
                    if (topOffset + bottomOffset >= cellRect.height) {
                        newRect.height = 0;
                    }
                    return newRect;
                };
                // 获取内容矩形 的具体实现
                BaseCellType.prototype._getContentRectImp = function (ctx, cellRect, cellStyle, context) {
                    var self = this;
                    var zoomFactor = isPrintZoomFactorExist(context) ? context.printZoomFactor : context.sheet.zoom();
                    cellRect = self._getContentRect(cellRect, cellStyle, zoomFactor);
                    var args = {
                        ctx: ctx,
                        options: {
                            rect: cellRect,
                            context: context
                        }
                    };
                    BaseCellType._callFeatureHandler(context.sheet, 'getCellPaddingRect', args);
                    return args.options.rect;
                };
                // 创建标签元素
                BaseCellType.prototype._createLabelElement = function (cellWrapperElement, cellRect, cellStyle, context) {
                    var labelOptions = cellStyle.labelOptions;
                    if (!labelOptions) {
                        return;
                    }
                    var sheet = context.sheet;
                    var cellText = sheet.getText(context.row, context.col, context.sheetArea);
                    var watermark = cellStyle.watermark;
                    var labelVisibility = labelOptions.visibility;
                    if (labelVisibility !== 1 && watermark) {
                        var labelFont = labelOptions.font || cellStyle.font || sheet._render._getDefaultFont();
                        var zoomFactor = sheet.zoom();
                        if (zoomFactor !== 1) {
                            labelFont = sheet._render._getZoomFont(labelFont);
                        }
                        var fontHeight = getFontHeight(labelFont), labelRect_1;
                        if (isPaintLabel(cellStyle, cellRect)) {
                            labelRect_1 = getLabelRect(cellRect, cellStyle);
                        }
                        if (labelRect_1) {
                            var $span_1 = domUtil_1.GC$(common_1._util._createElement('span'));
                            $span_1.text(watermark);
                            var isMoveSpan = (labelVisibility === 2 || labelVisibility === keyword_undefined) && cellText === '';
                            var animationOffset = labelRect_1.height - fontHeight;
                            var topStartValue_1 = labelRect_1.y + (isMoveSpan && animationOffset > 0 ? animationOffset : 0);
                            $span_1.css({
                                display: 'block',
                                position: 'absolute',
                                left: labelRect_1.x,
                                top: topStartValue_1,
                                width: labelRect_1.width,
                                height: labelRect_1.height,
                                font: adjustFontWithFallback(labelFont),
                                color: labelOptions.foreColor || cellStyle.foreColor || 'grey',
                                textAlign: getTextAlign(labelOptions.alignment),
                                overflow: 'hidden',
                                whiteSpace: 'nowrap'
                            }).attr('gcUIElement', 'gcEditorLabel');
                            domUtil_1.GC$(cellWrapperElement).append($span_1);
                            if (isMoveSpan) {
                                var timer_1 = setInterval(function () {
                                    topStartValue_1--;
                                    $span_1.css('top', topStartValue_1);
                                    if (topStartValue_1 <= labelRect_1.y) {
                                        clearInterval(timer_1);
                                    }
                                }, 20);
                            }
                        }
                    }
                };
                // 创建单元类型元素
                BaseCellType.prototype._createCellTypeElement = function (context) {
                    var self = this;
                    var cellWrapperElement = common_1._util._createElement('div');
                    var themeStyle = common_1._ThemeStyleHelper._getCssClassThemeStyle('gc-selection')
                    cellWrapperElement.style.cssText = 'position: absolute; margin: 0;padding: 0 ;overflow: hidden; box-sizing: content-box;resize: none;outline: none;border: 2px ' + themeStyle.borderColor + ' solid;box-shadow: 1px 2px 5px rgba(0,0,0,0.4);background-color: white';
                    var contentContainer = common_1._util._createElement('div');
                    contentContainer.style.cssText = 'position: absolute; outline: none; border: none';
                    domUtil_1.GC$(cellWrapperElement).append(domUtil_1.GC$(contentContainer));
                    // 创建编辑器元素
                    var contentElement = self.createEditorElement(context, cellWrapperElement);
                    if (contentElement) {
                        domUtil_1.GC$(contentContainer).append(domUtil_1.GC$(contentElement)).addClass('gcEditingInput-wrapper');
                    }
                    self._callOnCreateCellEditorFeatureHandler(context, cellWrapperElement, context.sheet.getCellRect(context.row, context.col));
                    return cellWrapperElement;
                };
                // 激活编辑器包装器
                BaseCellType.prototype._activateEditorWrapper = function (cellWrapperElement, cellStyle, cellRect, context) {
                    if (cellWrapperElement && cellWrapperElement.firstChild) {
                        var self_1 = this;
                        var tempCellRect = getDomRect(cellRect);
                        updateEditorPosition(cellWrapperElement, cellStyle, tempCellRect, context);
                        var result = self_1._callOnActivateCellEditorFeatureHandler(context, cellWrapperElement, tempCellRect, cellStyle);
                        var contentRect = result.options.contentRect;
                        var wrapperRect = result.options.cellRect;
                        var leftExternalRect = result.options.leftExternalRect;
                        var rightExternalRect = result.options.rightExternalRect;
                        if (self_1._createLabelElement) {
                            self_1._createLabelElement(cellWrapperElement, contentRect, cellStyle, context);
                        }
                        var zoomFactor = context.sheet.zoom();
                        contentRect = self_1._getContentRect ? self_1._getContentRect(contentRect, cellStyle, zoomFactor) : contentRect;
                        var editorRect = getEditorRect(contentRect, leftExternalRect, rightExternalRect);
                        var firstChild = cellWrapperElement.firstChild;
                        domUtil_1.GC$(firstChild).css({
                            left: (+(domUtil_1.GC$(firstChild).css('left')).replace('px', '') || 0) + getPositionOffset(cellStyle, 3, false, zoomFactor),
                            top: (+(domUtil_1.GC$(firstChild).css('top')).replace('px', '') || 0) + getPositionOffset(cellStyle, 0, false, zoomFactor)
                        });
                        self_1.activateEditor(cellWrapperElement.firstChild.firstChild, cellStyle, editorRect, context, wrapperRect, leftExternalRect, rightExternalRect);
                    }
                };
                // 更新编辑器容器
                BaseCellType.prototype.updateEditorContainer = function (editorContext, editorBounds, cellStyle, context, wrapperBounds, leftExternalBounds, rightExternalBounds) {
                    if (editorContext && editorBounds) {
                        var contentContainer = editorContext.parentNode;
                        var cellWrapperElement = contentContainer ? contentContainer.parentNode : keyword_undefined;
                        if (cellWrapperElement && wrapperBounds) {
                            var $cellWrapperElement = domUtil_1.GC$(cellWrapperElement);
                            var newWidth = wrapperBounds.width;
                            var newHeight = wrapperBounds.height;
                            if (newWidth > 0) {
                                $cellWrapperElement.width(newWidth);
                                var spanElement = cellWrapperElement.lastChild;
                                if (cellStyle && spanElement.getAttribute('gcUIElement') === 'gcEditorLabel') {
                                    domUtil_1.GC$(spanElement).width(newWidth - getPositionOffset(cellStyle, 3, true) - getPositionOffset(cellStyle, 1, true) - 2);
                                }
                            }
                            if (newHeight > 0) {
                                $cellWrapperElement.height(newHeight);
                            }
                            if (!_isNullOrUndefined(wrapperBounds.x)) {
                                $cellWrapperElement.css('left', wrapperBounds.x + 'px');
                            }
                            if (!_isNullOrUndefined(wrapperBounds.y)) {
                                $cellWrapperElement.css('top', wrapperBounds.y + 'px');
                            }
                        }
                    }
                };
                // 更新编辑器包装器
                BaseCellType.prototype._updateEditorWrapper = function (cellWrapperElement, cellStyle, cellRect, context) {
                    var self = this;
                    var contentContainer = cellWrapperElement.firstChild;
                    var tempCellRect = getDomRect(cellRect);
                    updateEditorPosition(cellWrapperElement, cellStyle, tempCellRect, context);
                    var result = self._callUpdateEditorContainerFeatureHandler(context, contentContainer, tempCellRect, cellStyle);
                    var wrapperRect = result.editorBounds;
                    var contentRect = result.contentRect;
                    var leftExternalRect = result.leftExternalRect;
                    var rightExternalRect = result.rightExternalRect;
                    var editor = contentContainer.firstChild;
                    contentRect = self._getContentRect ? self._getContentRect(contentRect, cellStyle, context.sheet.zoom()) : contentRect;
                    var editorRect = getEditorRect(contentRect, leftExternalRect, rightExternalRect);
                    var editorBounds = self.updateEditor(editor, cellStyle, editorRect, context, wrapperRect, leftExternalRect, rightExternalRect);
                    var leftExternalBounds;
                    var rightExternalBounds;
                    var wrapperBounds;
                    leftExternalBounds = {
                        width: leftExternalRect.width,
                        height: leftExternalRect.height
                    };
                    rightExternalBounds = {
                        width: rightExternalRect.width,
                        height: rightExternalRect.height
                    };
                    var wrapperBoundsWidth = !isNaN(editorBounds && editorBounds.width) &&
                        (editorBounds.width + leftExternalBounds.width + rightExternalBounds.width) > wrapperRect.width ? editorBounds.width + leftExternalBounds.width + rightExternalBounds.width : wrapperRect.width;
                    var wrapperBoundsHeight = !isNaN(editorBounds && editorBounds.height) &&
                        (editorBounds.height + leftExternalBounds.height + rightExternalBounds.height) > wrapperRect.height ? editorBounds.height + leftExternalBounds.height + rightExternalBounds.height : wrapperRect.height;
                    wrapperBounds = {
                        width: wrapperBoundsWidth,
                        height: wrapperBoundsHeight
                    };
                    self.updateEditorContainer(editor, editorBounds, cellStyle, context, wrapperBounds, leftExternalBounds, rightExternalBounds);
                };
                // 获取命中信息包装器
                BaseCellType.prototype._getHitInfoWrapper = function (x, y, cellStyle, cellRect, context) {
                    return this.getCellAndPaddingHitInfo(x, y, cellStyle, cellRect, context);
                };
                // 获取自动调整容器宽度
                BaseCellType.prototype._getAutoFitContainerWidth = function (value, text, cellStyle, zoomFactor, context) {
                    var width = getCellButtonAutoWidth(context, cellStyle) + getOutlineColumnOffset(context) + getSpecialIconsAutoWidth(context, cellStyle);
                    var textWidth = this.getAutoFitWidth(value, text, cellStyle, zoomFactor, context);
                    if (textWidth > 0) {
                        width += textWidth + getPositionOffset(cellStyle, 3, false) + getPositionOffset(cellStyle, 1, false);
                    }
                    return width;
                };
                // 获取自动调整容器高度
                BaseCellType.prototype._getAutoFitContainerHeight = function (value, text, cellStyle, zoomFactor, context) {
                    var height = 0;
                    var textHeight = this.getAutoFitHeight(value, text, cellStyle, zoomFactor, context);
                    if (textHeight > 0) {
                        height += textHeight + getPositionOffset(cellStyle, 0, false) + getPositionOffset(cellStyle, 2, false);
                    }
                    return Math.max(getCellButtonAutoHeight(context, cellStyle), height);
                };
                // 绘制值
                BaseCellType.prototype.paintValue = function (ctx, value, x, y, w, h, style, options) {
                    var self = this;
                    var formattedData = {};
                    var text;
                    options.quotePrefix = style.quotePrefix;
                    text = this.format(convertRichTextValue(value), style.formatter || style._autoFormatter, formattedData, options);
                    if (text) {
                        var rect = new common_1.Rect(x, y, w, h);
                        this.adjustRectForIconSet(style.hAlign, options.sheet, options.row, options.col, options.sheetArea, rect, (formattedData.content && this.hasInfilling(formattedData.content)));
                        x = rect.x;
                        w = rect.width;
                        var beforePaintTextArgs = self._callBeforePaintTextHandler(ctx, text, style, options, x, y, w, h);
                        this.paintText(ctx, value, x, y, w, h, style, options, text, formattedData, keyword_undefined, beforePaintTextArgs.externals);
                    }
                };
                // 获取缩进
                BaseCellType.prototype._getIndent = function (textIndent, outlineColumn, col) {
                    var indent = 0;
                    if (textIndent > 0) {
                        indent = textIndent * 8;
                    }
                    if (outlineColumn && outlineColumn._isOutlineColumn(col)) {
                        indent = 0;
                    }
                    return indent;
                };
                // 富文本是否可用
                BaseCellType.prototype._isRichTextAvailable = function (formatter, text) {
                    if (
                        !formatter
                        || ((_isType(formatter, const_string) && formatter === const_general)
                            || (formatter && formatter.formatString && formatter.formatString() === const_general))
                    ) {
                        return true;
                    } else if (
                        text
                        && (!isNaN(text) || text.toUpperCase() === 'TRUE' || text.toUpperCase() === 'FALSE')
                        && formatter !== '@'
                    ) {
                        return false;
                    }
                    return true;
                };
                // 获取水平对齐扩展元素的宽度
                BaseCellType.prototype._getHorizontalAlignExternalElementsWidth = function (externalElementsInfos) {
                    var width = 0;
                    for (var i = 0; i < externalElementsInfos.length; i++) {
                        width += externalElementsInfos[i].width;
                    }
                    return width;
                };
                // 获取垂直对齐扩展元素的宽度
                BaseCellType.prototype._getVerticalAlignExternalElementsHeight = function (externalElementsInfos) {
                    var height = 0;
                    for (var i = 0; i < externalElementsInfos.length; i++) {
                        height += externalElementsInfos[i].height;
                    }
                    return height;
                };
                // 调用绘制标签前的处理程序
                BaseCellType.prototype._callBeforePaintLabelHandler = function (ctx, context, rect, value, style) {
                    var args = {
                        ctx: ctx,
                        options: {
                            rect: rect,
                            context: context,
                            value: value,
                            style: style
                        }
                    };
                    BaseCellType._callFeatureHandler(context.sheet, 'beforePaintLabel', args);
                };
                // 调用绘制文本前的处理程序
                BaseCellType.prototype._callBeforePaintTextHandler = function (ctx, text, style, context, x, y, w, h) {
                    var beforePaintTextArgs = {
                        ctx: ctx,
                        text: text,
                        rect: new common_1.Rect(x, y, w, h),
                        style: style,
                        context: context,
                        externals: {
                            left: [],
                            right: []
                        }
                    };
                    BaseCellType._callFeatureHandler(context.sheet, 'beforePaintText', beforePaintTextArgs);
                    return beforePaintTextArgs;
                };
                // 调用填充文本区域处理程序
                BaseCellType.prototype._callFillTextAreaHandler = function (ctx, style, context, x, y, w, h, availRect, type) {
                    var fillTextAreaArgs = {
                        ctx: ctx,
                        style: style,
                        context: context,
                        textRect: new common_1.Rect(x, y, w, h),
                        availRect: availRect
                    };
                    BaseCellType._callFeatureHandler(context.sheet, type, fillTextAreaArgs);
                    return fillTextAreaArgs;
                };
                // 调用填充文本区域前的处理程序
                BaseCellType.prototype._callBeforeFillTextAreaHandler = function (ctx, style, context, x, y, w, h, availRect) {
                    return this._callFillTextAreaHandler(ctx, style, context, x, y, w, h, availRect, 'beforeFillTextArea');
                };
                // 调用填充文本区域后的处理程序
                BaseCellType.prototype._callAfterFillTextAreaHandler = function (ctx, style, context, x, y, w, h, availRect) {
                    return this._callFillTextAreaHandler(ctx, style, context, x, y, w, h, availRect, 'afterFillTextArea');
                };
                // 绘画文本
                BaseCellType.prototype.paintText = function (ctx, value, x, y, w, h, style, options, text, formattedData, opacity, externals) {
                    var self = this;
                    ctx.save();
                    ctx.beginPath();
                    var textOrientation = style.textOrientation;
                    var textIndent = style.textIndent && style.textIndent !== 0;
                    var isVerticalText = style.isVerticalText;
                    if ((value && value.richText && value.richText.length > 0)
                        || isVerticalText) {
                        self._paintRichTextOrVerticalText(ctx, value, x, y, w, h, style, options, text, formattedData, opacity, externals);
                    } else if (textOrientation !== 0 && !_isNullOrUndefined(textOrientation) && -90 <= textOrientation && textOrientation <= 90 && !textIndent && !isVerticalText) {
                        self._paintRotateText(ctx, value, x, y, w, h, style, options, text, formattedData, opacity, externals);
                    } else {
                        self._paintHorizontalText(ctx, value, x, y, w, h, style, options, text, formattedData, opacity, externals);
                    }
                    ctx.restore();
                };
                // 计算垂直省略号文本
                BaseCellType.prototype._calculateVerticalEllipsisText = function (ctx, options, data, linesStyle, style, h, y, indent, paintPositions, ellipsis) {
                    var sheet = options.sheet;
                    var row = options.row;
                    var col = options.col;
                    var vAlign = style.vAlign;
                    var sheetArea = options.sheetArea;
                    for (var k = 0; k < data.length; k++) {
                        var showText = data[k].text;
                        var lineHeight = linesStyle[k].lineHeight;
                        var indentLength = vAlign === 1 ? 0 : indent;
                        var defaultEllipsisWidth = this._getTextWidthWithTextWidthCache(ctx, '0');
                        var paintText = '';
                        var height = h;
                        if ((height - 1 - 2 - indentLength) < (showText.length * lineHeight)) {
                            if (height < 3 * defaultEllipsisWidth) {
                                ellipsis.push(0);
                                paintText = ELLIPSIS_TEXT;
                            } else {
                                var showTextLen = Math_floor((height - 1 - 2 - defaultEllipsisWidth * 3 - (vAlign === 1 ? 0 : indent)) / lineHeight);
                                var ellipsisInCenterIndex = 0;
                                if (vAlign === 0) {
                                    for (var i = 0; i < showTextLen; i++) {
                                        paintText = paintText + showText[i];
                                    }
                                    var ellipsisIndex = paintText.length;
                                    paintText = paintText + ELLIPSIS_TEXT;
                                    if (defaultEllipsisWidth * 3 + (paintText.length - 3) * lineHeight + indent > height - 1 - 2) {
                                        paintText = paintText.substring(0, paintText.length - 4) + ELLIPSIS_TEXT;
                                        ellipsis.push(paintText.split(ELLIPSIS_TEXT)[0].length);
                                    } else {
                                        ellipsis.push(ellipsisIndex);
                                    }
                                } else if (vAlign === 1) {
                                    for (var j = 0; j < Math_ceil(showTextLen / 2); j++) {
                                        var charCode = showText.charAt(j);
                                        paintText = paintText + charCode;
                                        ellipsisInCenterIndex = j;
                                    }
                                    var ellipsisIndex = paintText.length;
                                    paintText = paintText + ELLIPSIS_TEXT;
                                    for (var j = Math_ceil(showText.length - showTextLen / 2); j < showText.length; j++) {
                                        var charCode = showText.charAt(j);
                                        paintText = paintText + charCode;
                                    }
                                    if (defaultEllipsisWidth * 3 + (paintText.length - 3) * lineHeight + indent > height - 1 - 2) {
                                        paintText = paintText.replace(showText[ellipsisInCenterIndex], '');
                                        ellipsis.push(paintText.split(ELLIPSIS_TEXT)[0].length);
                                    } else {
                                        ellipsis.push(ellipsisIndex);
                                    }
                                    paintPositions[k].y = y + (h - (defaultEllipsisWidth * 3 + (paintText.length - 3) * lineHeight)) / 2;
                                } else {
                                    ellipsis.push(0);
                                    for (var i = showText.length - 1; i >= showText.length - showTextLen; i--) {
                                        paintText = showText[i] + paintText;
                                    }
                                    paintText = ELLIPSIS_TEXT + paintText;
                                    if (defaultEllipsisWidth * 3 + (paintText.length - 3) * lineHeight + indent > height - 1 - 2) {
                                        paintText = paintText.replace(showText[showText.length - showTextLen], '');
                                    }
                                    paintPositions[k].y = y + h - indent - (defaultEllipsisWidth * 3 + (paintText.length - 3) * lineHeight) - 2;
                                }
                            }
                            data[k].textInfos[0].text = paintText;
                            sheet._modelManager._setCellNodeTipContent(row, col, showText, sheetArea);
                        } else {
                            sheet._modelManager._setCellNodeTipContent(row, col, null, sheetArea);
                        }
                    }
                };
                // 绘制富文本或垂直文本
                BaseCellType.prototype._paintRichTextOrVerticalText = function (ctx, value, x, y, w, h, style, options, text, formattedData, opacity, externals) {
                    var self = this;
                    var availRect = new common_1.Rect(x, y, w, h);
                    var indent = self._getIndent(style.textIndent, options.sheet.outlineColumn, options.col);
                    var hAlign = style.hAlign;
                    if (hAlign === 3) {
                        hAlign = getHAlignByValueType(hAlign, value, style.formatter);
                    }
                    var isVerticalText = style.isVerticalText;
                    var isCJKText = isVerticalText ? _isCJKText(text) : false;
                    var defaultFont = style.font;
                    var formatter = style.formatter || style._autoFormatter;
                    var isRichTextAvailable = self._isRichTextAvailable(formatter, value.text);
                    var richText = extend(true, [], self._getRichTextValue(value, text, isRichTextAvailable, defaultFont, style.foreColor));
                    resetFillStyle(ctx, options.sheet, style, opacity);
                    if (value && value.richText && value.richText.length > 0) {
                        var zoomFactor = options.sheet ? options.sheet.zoom() : 1;
                        var printZoomFactor = options.printZoomFactor;
                        printZoomFactor = isPrintZoomFactorExist(options) ? printZoomFactor : keyword_null;
                        self._scaleFontByZoomFactor(richText, defaultFont, zoomFactor, printZoomFactor);
                    }
                    var leftExternalElementsWidth = 0;
                    var rightExternalElementsWidth = 0;
                    if (externals) {
                        leftExternalElementsWidth = self._getHorizontalAlignExternalElementsWidth(externals.left);
                        rightExternalElementsWidth = self._getHorizontalAlignExternalElementsWidth(externals.right);
                    }
                    var horizontalExternalElementsWidth = leftExternalElementsWidth + rightExternalElementsWidth;
                    var externalElementsSize = {
                        left: leftExternalElementsWidth,
                        right: rightExternalElementsWidth
                    };
                    if (!style.wordWrap && style.shrinkToFit) {
                        self._scaleFontByShrinkToFit(richText, w - horizontalExternalElementsWidth, h, style, defaultFont, 1, isVerticalText);
                    }
                    var data = self._processDataByWordWrap(ctx, text, style.font, isVerticalText ? h : w - horizontalExternalElementsWidth, indent, isVerticalText ? style.vAlign : style.hAlign, style.wordWrap, isVerticalText, richText);
                    var linesStyle = self._getLinesStyle(data, style, hAlign, opacity);
                    var rect = self._clipRect(ctx, style, x, y, w, h, style.wordWrap, options.cellOverflowLayout, hAlign, indent, isVerticalText, data[0].textLength, linesStyle[0].lineHeight);
                    var textShowEllipsis = false;
                    if (style.showEllipsis && isVerticalText && !value.richText) {
                        textShowEllipsis = true;
                    }
                    var paintPositions = self._calcPaintPositions(x, y, w, h, hAlign, style.vAlign, indent, isVerticalText, isCJKText, data, linesStyle, externalElementsSize, textShowEllipsis);
                    var count = data.length;
                    var ellipsis = [];
                    if (textShowEllipsis && formattedData && ((formattedData.content && formattedData.content.length === 1 && formattedData.content[0].type === 'text') || (!formattedData.content && data.length === 1 && data[0].text))) {
                        this._calculateVerticalEllipsisText(ctx, options, data, linesStyle, style, h, y, indent, paintPositions, ellipsis);
                    }
                    if (count === 1 && formattedData && !isRichTextAvailable) {
                        self._paintFormattedData(ctx, options.sheet, text, formattedData, paintPositions[0].x, paintPositions[0].y, w, h, hAlign, style, rect.width, rect.height, indent, isVerticalText, data[0].textLength, options, externalElementsSize, availRect);
                    } else {
                        var textWidth = self._getTextWidthOfRichText(data);
                        var textAreaStartX = paintPositions[0].x;
                        if (ctx.textAlign === cssCenter) {
                            textAreaStartX -= textWidth / 2;
                        } else if (ctx.textAlign === cssRight) {
                            textAreaStartX -= textWidth;
                        }
                        self._callBeforeFillTextAreaHandler(ctx, style, options, textAreaStartX, paintPositions[0].y, textWidth, 0, availRect);
                        for (var i = 0; i < count; i++) {
                            self._paintEntireLineOfText(ctx, options.sheet, paintPositions[i].x, paintPositions[i].y, linesStyle[i], hAlign, data[i], ellipsis[i]);
                        }
                        self._callBeforeFillTextAreaHandler(ctx, style, options, textAreaStartX, paintPositions[0].x, textWidth, 0, availRect);
                    }
                };
                // 获取富文本宽度
                BaseCellType.prototype._getTextWidthOfRichText = function (data) {
                    var textWidth = data[0].textLength;
                    for (var i = 0; i < data.length; i++) {
                        textWidth = Math_max(textWidth, data[i].textLength);
                    }
                    return textWidth;
                };
                // 从文本宽度缓存中获取文本宽度
                BaseCellType.prototype._getTextWidthWithTextWidthCache = function (ctx, text) {
                    var textWidth = 0;
                    var paintText = ctx.font + text;
                    if (textWidthCache[paintText]) {
                        textWidth = textWidthCache[paintText];
                    } else {
                        textWidth = measureTextWidth(ctx, ctx.font, text);
                        textWidthCache[paintText] = textWidth;
                    }
                    return textWidth;
                };
                // 计算水平省略号文本
                BaseCellType.prototype._calculateHorizontalEllipsisText = function (options, formattedData, text, ctx, w, hAlign, indent) {
                    var tempValue;
                    var sheetArea = options.sheetArea;
                    tempValue = text;
                    var contentTextWidth = this._getTextWidthWithTextWidthCache(ctx, tempValue);
                    var sheet = options.sheet;
                    var row = options.row;
                    var col = options.col;
                    var width = w;
                    var omitWidth = 0;
                    var defaultWordWidth = this._getTextWidthWithTextWidthCache(ctx, '0');
                    var defaultEllipsisWidth = this._getTextWidthWithTextWidthCache(ctx, ELLIPSIS_TEXT);
                    omitWidth = defaultEllipsisWidth;
                    var indentLength = hAlign === 1 ? 0 : indent;
                    if (contentTextWidth > width - 1 - 2 - indentLength) {
                        var paintText = '';
                        if (hAlign === 2) {
                            for (var j = tempValue.length - 1; j >= 0; j--) {
                                if (omitWidth > (width - 1 - 2 - indent)) {
                                    var paintTextlength = paintText.length;
                                    paintText = ELLIPSIS_TEXT + paintText.substring(1, paintTextlength);
                                    break;
                                }
                                var charCode = tempValue.charAt(j);
                                paintText = charCode + paintText;
                                var charCodeWidth = this._getTextWidthWithTextWidthCache(ctx, charCode);
                                omitWidth = omitWidth + charCodeWidth;
                            }
                        } else if (hAlign === 1) {
                            var paintWordNum = Math_ceil((width - omitWidth) / defaultWordWidth);
                            for (var j = 0; j < paintWordNum / 2; j++) {
                                var charCode = tempValue.charAt(j);
                                paintText = paintText + charCode;
                            }
                            paintText = paintText + ELLIPSIS_TEXT;
                            for (var j = Math_floor(tempValue.length - paintWordNum / 2); j < tempValue.length; j++) {
                                var charCode = tempValue.charAt(j);
                                paintText = paintText + charCode;
                            }
                            var paintTextWidth = this._getTextWidthWithTextWidthCache(ctx, paintText);
                            while ((paintTextWidth) > (width - 1 - 2) && paintText !== ELLIPSIS_TEXT) {
                                var paintTextSplitArr = paintText.split(ELLIPSIS_TEXT), slplitFir = paintTextSplitArr[0], splitSec = paintTextSplitArr[1];
                                if (slplitFir.length > splitSec.length) {
                                    paintText = slplitFir.substring(0, slplitFir.length - 1) + ELLIPSIS_TEXT + splitSec;
                                } else {
                                    paintText = slplitFir + ELLIPSIS_TEXT + splitSec.substring(1, splitSec.length);
                                }
                                paintTextWidth = this._getTextWidthWithTextWidthCache(ctx, paintText);
                            }
                        } else {
                            for (var j = 0; j < tempValue.length; j++) {
                                if (omitWidth > (width - 1 - 2 - indent)) {
                                    var paintTextlength = paintText.length;
                                    paintText = paintText.substring(0, paintTextlength - 1) + ELLIPSIS_TEXT;
                                    break;
                                }
                                var charCode = tempValue.charAt(j);
                                paintText = paintText + charCode;
                                var charCodeWidth = this._getTextWidthWithTextWidthCache(ctx, charCode);
                                omitWidth = omitWidth + charCodeWidth;
                            }
                        }
                        formattedData.content = [
                            {
                                value: paintText,
                                type: 'text'
                            }
                        ];
                        sheet._modelManager._setCellNodeTipContent(row, col, tempValue, sheetArea);
                    }
                };
                // 绘制水平文本
                BaseCellType.prototype._paintHorizontalText = function (ctx, value, x, y, w, h, style, options, text, formattedData, opacity, externals) {
                    var self = this;
                    var indent = 0;
                    var textIndent = style.textIndent;
                    var wordWrap = style.wordWrap;
                    var hAlign = style.hAlign;
                    var vAlign = style.vAlign;
                    var shrinkToFit = style.shrinkToFit;
                    var textDecoration = style.textDecoration;
                    var textAlign = 'left';
                    var adjX = 2;
                    var adjY = 2;
                    var font = style.font;
                    var textHeight = 0;
                    var lines = [];
                    var lineCount = 0;
                    var sheet = options.sheet;
                    var availRect = new common_1.Rect(x, y, w, h);
                    if (_isNullOrUndefined(options.fontInfo)) {
                        options.fontInfo = stylehelper_1._StyleHelper._scaleFont(style.font, sheet.zoom());
                        if (isPrintZoomFactorExist(options)) {
                            options.fontInfo = stylehelper_1._StyleHelper._scaleFont(options.fontInfo.font, options.printZoomFactor);
                        }
                    }
                    var fontSize = parseInt(options.fontInfo.fontSize, 10);
                    if (_isNullOrUndefined(options.lineHeight)) {
                        options.lineHeight = getFontHeight(stylehelper_1._StyleHelper._scaleFont(style.font, sheet.zoom()).font, false, _isCJKText(text));
                    }
                    var lineHeight = options.lineHeight;
                    if (externals && externals.isWatermark) {
                        ctx.fillStyle = '#c0c0ca';
                    } else {
                        resetFillStyle(ctx, sheet, style, opacity);
                    }
                    if (textIndent > 0) {
                        indent = textIndent * 8;
                    }
                    if (sheet.outlineColumn && sheet.outlineColumn._isOutlineColumn(options.col)) {
                        indent = 0;
                    }
                    if (hAlign === 3) {
                        hAlign = getHAlignByValueType(hAlign, value, style.formatter);
                    }
                    setContextFont(ctx, font);
                    var leftExternalElementsWidth = 0;
                    var rightExternalElementsWidth = 0;
                    if (externals && externals.left) {
                        leftExternalElementsWidth = self._getHorizontalAlignExternalElementsWidth(externals.left);
                        rightExternalElementsWidth = self._getHorizontalAlignExternalElementsWidth(externals.right);
                    }
                    var horizontalExternalElementsWidth = leftExternalElementsWidth + rightExternalElementsWidth;
                    var externalElementsSize = {
                        left: leftExternalElementsWidth,
                        right: rightExternalElementsWidth
                    };
                    if (!wordWrap && shrinkToFit) {
                        var space = 0;
                        var minFont = {
                            value: false
                        };
                        for (var i = 0; i < 3 && minFont.value === false; i++) {
                            var textLength = ctx.measureText(text).width;
                            space = Math_max(0, w - 4 - (hAlign === 1 ? 0 : indent) - horizontalExternalElementsWidth);
                            if (space < textLength) {
                                font = stylehelper_1._StyleHelper._scaleFont(font, space / textLength, minFont, true).font;
                                setContextFont(ctx, font);
                            } else {
                                break;
                            }
                        }
                    }
                    var isText = (sheet.parent && sheet.parent.options.numbersFitMode === core_enum_1.NumbersFitMode.overflow) || false;
                    if (!isText) {
                        if (formattedData && formattedData.content) {
                            isText = !!(formattedData.content && formattedData.content.length === 1 && formattedData.content[0].type === 'text');
                        } else {
                            isText = (typeof value === 'string' && value === text);
                        }
                    }
                    if (!wordWrap && !shrinkToFit && style.showEllipsis && isText) {
                        this._calculateHorizontalEllipsisText(options, formattedData, text, ctx, w, hAlign, indent);
                    }
                    adjX += (indent + leftExternalElementsWidth);
                    if (hAlign === 1) {
                        adjX = (w + leftExternalElementsWidth - rightExternalElementsWidth) / 2;
                        textAlign = cssCenter;
                    } else if (hAlign === 2) {
                        adjX = w - rightExternalElementsWidth - 1 - 2;
                        adjX -= indent;
                        textAlign = cssRight;
                    }
                    if (ctx.textAlign !== textAlign) {
                        ctx.textAlign = textAlign;
                    }
                    var wordWrapWidth = 0;
                    if (wordWrap) {
                        wordWrapWidth = w - horizontalExternalElementsWidth - 3 - indent;
                        wordWrapWidth -= 1;
                        lines = common_1._WordWrapHelper._getWrapInfo(text, wordWrapWidth, font, false, ctx);
                        lineCount = lines.length;
                        if (lineCount > 1 && vAlign !== 0) {
                            textHeight = (lineCount - 1) * lineHeight;
                        }
                    }
                    var baselineOffset = fontSize > 8 ? Math_floor((fontSize - 8) / 5 + 2) : 1, lineOffset = lineHeight / 2 - fontSize / 2 + baselineOffset - 1;
                    adjY += lineHeight - lineOffset;
                    if (vAlign === 1) {
                        adjY = (h - textHeight) / 2 + lineHeight / 2 - lineOffset;
                    } else if (vAlign === 2) {
                        adjY = h - textHeight - 2 - lineOffset;
                    }
                    if (ctx.textBaseline !== textBaseline) {
                        ctx.textBaseline = textBaseline;
                    }
                    var cellOverflowlayout = options.cellOverflowLayout;
                    var layout = (cellOverflowlayout && cellOverflowlayout.layout);
                    var clipRect = {
                        x: layout ? layout.x : x + 1,
                        y: layout ? layout.y : y + 1,
                        width: layout ? layout.width : w - 2,
                        height: layout ? layout.height : h - 2
                    };
                    var hasOverflowed = layout && layout.width > w;
                    var clipX = clipRect.x;
                    var clipY = clipRect.y;
                    var clipWidth = clipRect.width;
                    var clipHeight = clipRect.height;
                    if (wordWrap) {
                        ctx.rect(clipX, clipY, clipWidth, clipHeight);
                        ctx.clip();
                        ctx.beginPath();
                        var vpos = y + adjY;
                        if (lineCount > 1) {
                            var textAreaStartX = x + adjX;
                            if (ctx.textAlign === cssCenter) {
                                textAreaStartX -= wordWrapWidth / 2;
                            } else if (ctx.textAlign === cssRight) {
                                textAreaStartX -= wordWrapWidth;
                            }
                            self._callBeforeFillTextAreaHandler(ctx, style, options, textAreaStartX, vpos, wordWrapWidth, lineHeight * lineCount, availRect);
                            for (var i = 0; i < lineCount; i++) {
                                ctx.fillText(lines[i], x + adjX, vpos);
                                if (textDecoration) {
                                    var textLength = ctx.measureText(lines[i]).width;
                                    self._renderTextDecoration(ctx, textDecoration, x + adjX, vpos, textLength, fontSize, baselineOffset);
                                }
                                vpos += lineHeight;
                            }
                            self._callBeforeFillTextAreaHandler(ctx, style, options, textAreaStartX, vpos, wordWrapWidth, lineHeight * lineCount, availRect);
                        } else {
                            self._renderCellTextNormal(ctx, text, formattedData, x + adjX, y + adjY, hAlign, clipWidth, indent, textDecoration, baselineOffset, fontSize, options, style, externalElementsSize, availRect, hasOverflowed);
                        }
                    } else {
                        var txtWidth = measureTextWidth(ctx, ctx.font, text) + horizontalExternalElementsWidth;
                        var needClip = (txtWidth > clipWidth - ((x + 1) - clipX) || lineHeight > clipHeight);
                        var topOffset = getPositionOffset(style, 0);
                        var rightOffset = getPositionOffset(style, 1);
                        var bottomOffset = getPositionOffset(style, 2);
                        var leftOffset = getPositionOffset(style, 3);
                        if (!needClip) {
                            if (hAlign === 1) {
                                if (cellOverflowlayout) {
                                    var txtHalfWidth = txtWidth / 2;
                                    if (txtHalfWidth > cellOverflowlayout.backgroundLeftWidth || txtHalfWidth > cellOverflowlayout.backgroundRightWidth) {
                                        needClip = true;
                                    }
                                }
                            } else if (txtWidth + indent + topOffset + bottomOffset > clipWidth || textHeight + leftOffset + rightOffset > clipHeight) {
                                needClip = true;
                            }
                        }
                        if (needClip) {
                            ctx.rect(clipX, clipY, clipWidth, clipHeight);
                            ctx.clip();
                            ctx.beginPath();
                        }
                        self._renderCellTextNormal(ctx, text, formattedData, x + adjX, y + adjY, hAlign, clipWidth, indent, textDecoration, baselineOffset, fontSize, options, style, externalElementsSize, availRect, hasOverflowed);
                    }
                };
                // 绘制旋转文本
                BaseCellType.prototype._paintRotateText = function (ctx, value, x, y, w, h, style, options, text, formattedData, opacity, externals) {
                    var self = this;
                    var wordWrap = style.wordWrap;
                    var hAlign = style.hAlign;
                    var vAlign = style.vAlign;
                    var shrinkToFit = style.shrinkToFit;
                    var textDecoration = style.textDecoration;
                    var adjX = 2;
                    var adjY = 2;
                    var font = style.font;
                    var lines = [];
                    var lineCount = 0;
                    var tempX;
                    var tempY;
                    var rotatedTextHeight;
                    var fontSize = parseInt(options.fontInfo.fontSize, 10);
                    var sheet = options.sheet;
                    var isRotatePositiveAngle;
                    var availRect = new common_1.Rect(x, y, w, h);
                    var cellOverflowlayout = options.cellOverflowLayout;
                    var layout = (cellOverflowlayout && cellOverflowlayout.layout);
                    var hasBorder = style && (style.borderLeft || style.borderTop || style.borderRight || style.borderBottom) && !sheet.getSpan(options.row, options.col);
                    var textOrientation = style.textOrientation;
                    var textOrientationRadian = textOrientation * Math.PI / 180;
                    var abstextOrientationRadian = Math_abs(textOrientationRadian);
                    var costextOrientation = Math_cos(abstextOrientationRadian);
                    var sintextOrientation = Math_sin(abstextOrientationRadian);
                    var tantextOrientation = Math_tan(abstextOrientationRadian);
                    var lineHeight = options.lineHeight;
                    var isRotate90 = textOrientation === 90 || textOrientation === -90;
                    if (hasBorder) {
                        if (textOrientation > -90 && textOrientation < 0) {
                            isRotatePositiveAngle = false;
                        }
                        if (textOrientation > 0 && textOrientation < 90) {
                            isRotatePositiveAngle = true;
                        }
                    }
                    var clipRect = {
                        x: layout ? layout.x : x + 1,
                        y: layout ? layout.y : y + 1,
                        width: layout ? layout.width : w - 2,
                        height: layout ? layout.height : h - 2
                    };
                    var clipX = clipRect.x;
                    var clipY = clipRect.y;
                    var clipWidth = clipRect.width;
                    var clipHeight = clipRect.height;
                    var lineSizeSinAdj = (lineHeight / 2) * Math_sin(abstextOrientationRadian);
                    var lineSizeCosAdj = (lineHeight / 2) * Math_cos(abstextOrientationRadian);
                    var baselineOffset = fontSize > 8 ? Math_floor((fontSize - 8) / 5 + 2) : 1;
                    var lineOffset = lineHeight / 2 - fontSize / 2 + baselineOffset - 1;
                    if (formattedData && formattedData.content && formattedData.content.length > 0 && !shrinkToFit) {
                        text = self._getFormatedTextFitCellWhenRotate(ctx, formattedData.content, h - 4, font);
                    }
                    var textWidth = sheet._getStringWidthByCanvas(text, font);
                    resetFillStyle(ctx, sheet, style, opacity);
                    if (hAlign === 3) {
                        hAlign = getHAlignByValueType(hAlign, value, style.formatter, textOrientation);
                    }
                    setContextFont(ctx, font);
                    var leftExternalElementsWidth = 0;
                    var rightExternalElementsWidth = 0;
                    if (externals) {
                        leftExternalElementsWidth = self._getHorizontalAlignExternalElementsWidth(externals.left);
                        rightExternalElementsWidth = self._getHorizontalAlignExternalElementsWidth(externals.right);
                    }
                    if (!wordWrap && shrinkToFit) {
                        var space = 0;
                        var minFont = {
                            value: false
                        };
                        for (var i = 0; i < 3 && minFont.value === false; i++) {
                            space = Math_max(0, (h - 4 - 2 * lineSizeCosAdj) / sintextOrientation);
                            if (space < textWidth) {
                                font = stylehelper_1._StyleHelper._scaleFont(font, space / textWidth, minFont, true).font;
                                setContextFont(ctx, font);
                                fontSize = parseInt(options.fontInfo.fontSize, 10);
                                textWidth = sheet._getStringWidthByCanvas(text, font);
                                lineHeight = common_1._util._getFontHeight(font);
                                lineSizeSinAdj = (lineHeight / 2) * Math_sin(abstextOrientationRadian);
                                lineSizeCosAdj = (lineHeight / 2) * Math_cos(abstextOrientationRadian);
                            } else {
                                break;
                            }
                        }
                    }
                    var maxLineWidth = 0;
                    var wordWrapWidth = 0;
                    if (wordWrap) {
                        wordWrapWidth = (h - 4 - 2 * lineSizeCosAdj) / sintextOrientation;
                        lines = common_1._WordWrapHelper._getWrapInfo(text, wordWrapWidth, font, false, ctx);
                        lineCount = lines.length;
                        textWidth = sheet._getStringWidthByCanvas(lines[0], font);
                        for (var l = 0; l < lineCount; l++) {
                            var lineWidth = sheet._getStringWidthByCanvas(lines[l], font);
                            if (lineWidth > maxLineWidth) {
                                maxLineWidth = lineWidth;
                            }
                        }
                    }
                    rotatedTextHeight = (wordWrap ? maxLineWidth : textWidth) * sintextOrientation + lineSizeCosAdj * 2;
                    if (h <= rotatedTextHeight) {
                        vAlign = 2;
                    }
                    tempX = textWidth / 2 * costextOrientation;
                    tempY = (wordWrap ? maxLineWidth : textWidth) / 2 * sintextOrientation;
                    var position = '' + hAlign + vAlign;
                    switch (position) {
                        case '00':
                            adjX += tempX + lineSizeSinAdj + leftExternalElementsWidth;
                            adjY += tempY;
                            if (!isRotate90) {
                                adjY += lineSizeCosAdj;
                            }
                            if (hasBorder) {
                                adjX = (isRotatePositiveAngle ? 1 : -1) * ((h - adjY) / tantextOrientation) + (lineHeight / 2 + 2) / sintextOrientation;
                            }
                            break;
                        case '01':
                            adjX += tempX + lineSizeSinAdj + leftExternalElementsWidth;
                            adjY = h / 2;
                            if (hasBorder) {
                                adjX = (isRotatePositiveAngle ? 1 : -1) * ((h - adjY) / tantextOrientation) + (lineHeight / 2 + 2) / sintextOrientation;
                            }
                            break;
                        case '02':
                            adjX += tempX + lineSizeSinAdj + leftExternalElementsWidth;
                            adjY += tempY;
                            if (!isRotate90) {
                                adjY += lineSizeCosAdj;
                            }
                            if (hasBorder) {
                                adjX = (isRotatePositiveAngle ? 1 : -1) * (adjY / tantextOrientation) + (lineHeight / 2 + 2) / sintextOrientation;
                            }
                            adjY = h - adjY;
                            break;
                        case '10':
                            adjX = (w + leftExternalElementsWidth - rightExternalElementsWidth) / 2;
                            adjY += tempY;
                            if (!isRotate90) {
                                adjY += lineSizeCosAdj;
                            }
                            if (hasBorder) {
                                adjX += (isRotatePositiveAngle ? 1 : -1) * (h - adjY) / tantextOrientation;
                            }
                            break;
                        case '11':
                            adjX = (w + leftExternalElementsWidth - rightExternalElementsWidth) / 2;
                            adjY = h / 2;
                            if (hasBorder) {
                                adjX += (isRotatePositiveAngle ? 1 : -1) * (h - adjY) / tantextOrientation;
                            }
                            break;
                        case '12':
                            adjX = (w + leftExternalElementsWidth - rightExternalElementsWidth) / 2;
                            adjY += tempY;
                            if (!isRotate90) {
                                adjY += lineSizeCosAdj;
                            }
                            if (hasBorder) {
                                adjX += (isRotatePositiveAngle ? 1 : -1) * adjY / tantextOrientation;
                            }
                            adjY = h - adjY;
                            break;
                        case '20':
                            adjX = w - 2 - tempX - lineSizeSinAdj - rightExternalElementsWidth;
                            adjY += tempY;
                            if (!isRotate90) {
                                adjY += lineSizeCosAdj;
                            }
                            if (hasBorder) {
                                adjX = w + (isRotatePositiveAngle ? 1 : -1) * ((h - adjY) / tantextOrientation) - (lineHeight / 2 + 2) / sintextOrientation;
                            }
                            break;
                        case '21':
                            adjX = w - 2 - tempX - lineSizeSinAdj - rightExternalElementsWidth;
                            adjY = h / 2;
                            if (hasBorder) {
                                adjX = w + (isRotatePositiveAngle ? 1 : -1) * ((h - adjY) / tantextOrientation) - (lineHeight / 2 + 2) / sintextOrientation;
                            }
                            break;
                        case '22':
                            adjX = w - 2 - tempX - lineSizeSinAdj - rightExternalElementsWidth;
                            adjY += tempY;
                            if (!isRotate90) {
                                adjY += lineSizeCosAdj;
                            }
                            if (hasBorder) {
                                adjX = w + (isRotatePositiveAngle ? 1 : -1) * (adjY / tantextOrientation) - (lineHeight / 2 + 2) / sintextOrientation;
                            }
                            adjY = h - adjY;
                            break;
                    }
                    if (wordWrap) {
                        var xpos = x + adjX;
                        var moveLength = lineHeight / sintextOrientation;
                        var index = void 0;
                        if (lineCount > 1) {
                            var isLineCountOddNumber = lineCount % 2 !== 0;
                            if (hAlign === 1) {
                                if (isLineCountOddNumber) {
                                    xpos -= moveLength * (lineCount - 1) / 2;
                                } else {
                                    xpos -= moveLength * (lineCount / 2) - 0.5 * moveLength;
                                }
                            }
                            var singleRotateTextAreaRect = getSingleRotateTextRect(xpos, y + adjY, textWidth, textOrientationRadian, lineHeight);
                            var textAreaWidth = singleRotateTextAreaRect.width + moveLength * (lineCount - 1);
                            var textAreaHeight = singleRotateTextAreaRect.height;
                            var textAreaX = hAlign === 2 ? singleRotateTextAreaRect.x - moveLength * (lineCount - 1) : singleRotateTextAreaRect.x + moveLength * (lineCount - 1);
                            var textAreaY = singleRotateTextAreaRect.y;
                            self._callBeforeFillTextAreaHandler(ctx, style, options, textAreaX, textAreaY, textAreaWidth, textAreaHeight, availRect);
                            for (var i = 0; i < lineCount; i++) {
                                index = i;
                                if (style.textOrientation > 0 && hAlign === 2 || style.textOrientation < 0 && (hAlign === 0 || hAlign === 1)) {
                                    index = lineCount - i - 1;
                                }
                                self._paintRotateTextImp(ctx, textOrientationRadian, lines[index], xpos, y + adjY, textDecoration, fontSize, baselineOffset, lineOffset);
                                xpos = hAlign === 2 ? xpos - moveLength : xpos + moveLength;
                            }
                            self._callBeforeFillTextAreaHandler(ctx, style, options, textAreaX, textAreaY, textAreaWidth, textAreaHeight, availRect);
                        } else {
                            self._paintRotateTextNormal(ctx, text, x, y, adjX, adjY, options, style, textWidth, textOrientationRadian, textDecoration, fontSize, baselineOffset, lineHeight, lineOffset, availRect);
                        }
                    } else {
                        var txtHeight = textWidth * sintextOrientation + fontSize * sintextOrientation + 2;
                        var topOffset = getPositionOffset(style, 0);
                        var bottomOffset = getPositionOffset(style, 2);
                        var needClip = (txtHeight > clipHeight - ((y + 1) - clipY) || lineHeight > clipHeight) || txtHeight + topOffset + bottomOffset > clipHeight;
                        if (needClip) {
                            ctx.rect(clipX, clipY, clipWidth, clipHeight);
                            ctx.clip();
                        }
                        self._paintRotateTextNormal(ctx, text, x, y, adjX, adjY, options, style, textWidth, textOrientationRadian, textDecoration, fontSize, baselineOffset, lineHeight, lineOffset, availRect);
                    }
                };
                // 
                BaseCellType.prototype._paintRotateTextNormal = function (ctx, text, x, y, adjX, adjY, options, style, textWidth, textOrientationRadian, textDecoration, fontSize, baselineOffset, lineHeight, lineOffset, availRect) {
                    var self = this;
                    var textAreaRect = getSingleRotateTextRect(x, y, textWidth, textOrientationRadian, lineHeight);
                    var textAreaWidth = textAreaRect.width;
                    var textAreaHeight = textAreaRect.height;
                    var textAreaX = textAreaRect.x;
                    var textAreaY = textAreaRect.y;
                    self._callBeforeFillTextAreaHandler(ctx, style, options, textAreaX, textAreaY, textAreaWidth, textAreaHeight, availRect);
                    self._paintRotateTextImp(ctx, textOrientationRadian, text, x + adjX, y + adjY, textDecoration, fontSize, baselineOffset, lineOffset);
                    self._callBeforeFillTextAreaHandler(ctx, style, options, textAreaX, textAreaY, textAreaWidth, textAreaHeight, availRect);
                };
                // 按缩放因子缩放字体
                BaseCellType.prototype._scaleFontByZoomFactor = function (richText, defaultFont, zoomFactor, printZoomFactor) {
                    scaleFontByZoomFactor(richText, defaultFont, zoomFactor, printZoomFactor);
                };
                // 缩放字体以适应
                BaseCellType.prototype._scaleFontByShrinkToFit = function (richText, width, height, style, defaultFont, zoomFactor, isVerticalText) {
                    var space = 0;
                    var minFont = {
                        value: false
                    };
                    for (var i = 0; i < 3 && minFont.value === false; i++) {
                        var textLength = getTextLengthInLine(richText, defaultFont, zoomFactor, isVerticalText);
                        space = Math_max(0, (isVerticalText ? height : width) - 4);
                        if (isVerticalText ? style.vAlign : style.hAlign !== 1 && style.textIndent) {
                            space = Math_max(0, space - style.textIndent * 8);
                        }
                        if (space < textLength) {
                            for (var j = 0; j < richText.length; j++) {
                                richText[j].style.font = stylehelper_1._StyleHelper._scaleFont(richText[j].style.font, space / textLength, minFont, true).font;
                            }
                        } else {
                            break;
                        }
                    }
                };
                // 获取富文本值
                BaseCellType.prototype._getRichTextValue = function (value, text, isRichTextAvailable, defaultFont, foreColor) {
                    var richText = value.richText;
                    if (_isNullOrUndefined(richText) || !isRichTextAvailable) {
                        richText = [{
                            style: {
                                font: defaultFont,
                                foreColor: foreColor
                            },
                            text: text
                        }];
                    }
                    return richText;
                };
                // 裁剪矩形
                BaseCellType.prototype._clipRect = function (ctx, style, x, y, w, h, wordWrap, cellOverflowLayout, hAlign, indent, isVertical, textLength, lineHeight) {
                    var layout = cellOverflowLayout && cellOverflowLayout.layout;
                    var clipRect = {
                        x: layout ? layout.x : x + 1,
                        y: layout ? layout.y : y + 1,
                        width: layout ? layout.width : w - 2,
                        height: layout ? layout.height : h - 2
                    };
                    var clipX = clipRect.x;
                    var clipY = clipRect.y;
                    var clipWidth = clipRect.width;
                    var clipHeight = clipRect.height;
                    if (wordWrap) {
                        ctx.rect(clipX, clipY, clipWidth, clipHeight);
                        ctx.clip();
                        ctx.beginPath();
                    } else {
                        var needClip = this._needClip(style, hAlign, style.vAlign, x, y, clipHeight, clipWidth, clipX, clipY, textLength, lineHeight, indent, isVertical, cellOverflowLayout);
                        if (needClip) {
                            ctx.rect(clipX, clipY, clipWidth, clipHeight);
                            ctx.clip();
                            ctx.beginPath();
                        }
                    }
                    return clipRect;
                };
                // 需要裁剪
                BaseCellType.prototype._needClip = function (style, hAlign, vAlign, x, y, clipHeight, clipWidth, clipX, clipY, textLength, lineHeight, indent, isVertical, cellOverflowlayout) {
                    var needClip;
                    var topOffset = getPositionOffset(style, 0);
                    var rightOffset = getPositionOffset(style, 1);
                    var bottomOffset = getPositionOffset(style, 2);
                    var leftOffset = getPositionOffset(style, 3);
                    if (isVertical) {
                        needClip = textLength > clipHeight - ((y + 1) - clipY) || lineHeight > clipWidth;
                        if (!needClip && vAlign !== 1 && textLength + indent + topOffset + bottomOffset > clipHeight || lineHeight + leftOffset + rightOffset > clipWidth) {
                            needClip = true;
                        }
                    } else {
                        needClip = textLength > clipWidth - ((x + 1) - clipX) || lineHeight > clipHeight;
                        if (!needClip) {
                            if (hAlign === 1) {
                                if (cellOverflowlayout) {
                                    var txtHalfWidth = textLength / 2;
                                    if (txtHalfWidth > cellOverflowlayout.backgroundLeftWidth || txtHalfWidth > cellOverflowlayout.backgroundRightWidth) {
                                        needClip = true;
                                    }
                                }
                            } else if (textLength + indent + leftOffset + rightOffset > clipWidth || lineHeight + topOffset + bottomOffset > clipHeight) {
                                needClip = true;
                            }
                        }
                    }
                    return needClip;
                };
                // 按换行处理数据
                BaseCellType.prototype._processDataByWordWrap = function (ctx, text, font, size, indent, textAlign, wordWrap, isVerticalText, richText) {
                    if (textAlign !== 1) {
                        size = size - 3 - indent;
                    } else {
                        size = size - 3;
                    }
                    if (wordWrap) {
                        return common_1._WordWrapHelper._getWordWrapInfo(text, size, font, richText, isVerticalText, ctx);
                    }
                    var textLength = 0;
                    for (var i = 0; i < richText.length; i++) {
                        var richText_text = richText[i].text;
                        if (isVerticalText) {
                            textLength += getFontHeight(richText[i].style.font) * (richText_text ? richText_text.length : 0);
                        } else {
                            var fontInfo = stylehelper_1._StyleHelper._scaleFont(richText[i].style.font, 1);
                            var fontSize = richText[i].style.vertAlign ? fontInfo.fontSize * subscriptAndSuperscriptScale + 'px ' + fontInfo.fontFamily : richText[i].style.font;
                            textLength += measureTextWidth(ctx, fontSize, richText_text);
                        }
                    }
                    return [
                        {
                            textLength: textLength,
                            text: text,
                            textInfos: richText
                        }
                    ];
                };
                // 绘制格式化数据
                BaseCellType.prototype._paintFormattedData = function (ctx, sheet, text, formattedData, x, y, w, h, hAlign, style, clipWidth, clipHeight, indent, isVertical, textLength, context, externalElementsSize, availRect) {
                    var font = style.font;
                    var fontSize = stylehelper_1._StyleHelper._scaleFont(font, 1).fontSize;
                    var baselineOffset = fontSize > 8 ? Math_floor((fontSize - 8) / 5 + 2) : 1;
                    this._setContext(ctx, sheet, style);
                    if (isVertical) {
                        this._renderVerticalFormattedData(ctx, text, formattedData, style, x, y, clipHeight, indent, clipHeight, context, externalElementsSize, availRect);
                    } else {
                        var hasOverflowed = clipWidth > w;
                        this._renderCellTextNormal(ctx, text, formattedData, x, y, hAlign, clipWidth, indent, style.textDecoration, baselineOffset, fontSize, context, style, externalElementsSize, availRect, hasOverflowed, textLength);
                    }
                };
                // 渲染垂直格式化数据
                BaseCellType.prototype._renderVerticalFormattedData = function (ctx, text, formattedData, style, x, y, clipHeight, indent, lineHeight, context, externalElementsSize, availRect) {
                    var self = this;
                    var textContent = formattedData.content;
                    var i;
                    var originalY = y;
                    self._callBeforeFillTextAreaHandler(ctx, style, context, x, originalY, lineHeight, lineHeight * text.length, availRect);
                    if (textContent && textContent.length > 0) {
                        var textHeight = getTextContentWidth(ctx, textContent, true);
                        var infillingHeight = clipHeight - indent - textHeight - 2;
                        infillingHeight = infillingHeight > 0 ? infillingHeight : 0;
                        var filledHeight = void 0;
                        for (i = 0; i < textContent.length; i++) {
                            if (textContent[i].type === 'fillingChar') {
                                var fillText = createInfillingText(ctx, infillingHeight, textContent[i].value, true);
                                this._fillVerticalText(ctx, fillText, x, y);
                                y += infillingHeight;
                            } else if (textContent[i].type === 'placeholder') {
                                y += textContent[i].value ? textContent[i].value.length * lineHeight : 0;
                            } else if (textContent[i].type === 'numberPlaceholder') {
                                y += lineHeight;
                            } else {
                                this._fillVerticalText(ctx, textContent[i].value, x, y);
                                filledHeight = textContent[i].value ? textContent[i].value.length * lineHeight : 0;
                                y += filledHeight;
                            }
                        }
                    } else if (text) {
                        for (i = 0; i < text.length; i++) {
                            y = this._fillVerticalText(ctx, text[i], x, y, lineHeight).y;
                        }
                    }
                    self._callAfterFillTextAreaHandler(ctx, style, context, x, originalY, lineHeight, y - originalY, availRect);
                };
                // 获取文本对齐方式
                BaseCellType.prototype._getTextAlign = function (hAlign) {
                    var textAlign = cssLeft;
                    if (hAlign === 1) {
                        textAlign = cssCenter;
                    } else if (hAlign === 2) {
                        textAlign = cssRight;
                    }
                    return textAlign;
                };
                // 绘制整行文本
                BaseCellType.prototype._paintEntireLineOfText = function (ctx, sheet, x, y, lineStyle, textAlign, data, ellipsisIndex) {
                    var actualStyles = [], textInfos = data.textInfos;
                    for (var i = 0; i < textInfos.length; i++) {
                        actualStyles.push(extend(true, {}, lineStyle, textInfos[i].style));
                    }
                    for (var i = 0; i < textInfos.length; i++) {
                        var pos = this._paintText(ctx, sheet, x, y, actualStyles[i], textInfos[i].text, ellipsisIndex);
                        x = pos.x;
                        y = pos.y;
                    }
                };
                // 获取线样式
                BaseCellType.prototype._getLinesStyle = function (data, style, hAlign, opacity) {
                    var linesStyle = [];
                    var count = data.length;
                    for (var i = 0; i < count; i++) {
                        var lineStyle = this._getLineStyle(style, hAlign, opacity, data[i].textInfos);
                        linesStyle.push(lineStyle);
                    }
                    return linesStyle;
                };
                // 获取线样式
                BaseCellType.prototype._getLineStyle = function (style, hAlign, opacity, data) {
                    var self = this;
                    var maxHeightInLine = 0;
                    var maxFontSizeInline = 0;
                    for (var i = 0; i < data.length; i++) {
                        var font = void 0;
                        if (data[i].style && data[i].style.font) {
                            font = data[i].style.font;
                        } else {
                            font = style.font;
                        }
                        maxHeightInLine = Math.max(getFontHeight(font, keyword_undefined, _isCJKText(data[i].text)), maxHeightInLine);
                        maxFontSizeInline = Math.max(stylehelper_1._StyleHelper._scaleFont(font, 1).fontSize, maxFontSizeInline);
                        if (data[i].style && (data[i].style.vertAlign === 1) || (data[i].style.vertAlign === 2)) {
                            maxHeightInLine = Math.max(getFontHeight(font, keyword_undefined, _isCJKText(data[i].text)) + stylehelper_1._StyleHelper._scaleFont(font, subscriptAndSuperscriptScale).fontSize * 2 * 0.218, maxHeightInLine);
                        }
                    }
                    var baselineOffset = maxFontSizeInline > 8 ? Math_floor((maxFontSizeInline - 8) / 5 + 2) : 1;
                    var lineOffset = maxHeightInLine / 2 - maxFontSizeInline / 2 + baselineOffset - 1;
                    return {
                        lineHeight: maxHeightInLine,
                        fontSize: maxFontSizeInline,
                        baselineOffset: baselineOffset,
                        lineOffset: lineOffset,
                        font: style.font,
                        foreColor: style.foreColor,
                        textDecoration: style.textDecoration,
                        isVerticalText: style.isVerticalText,
                        textAlign: self._getTextAlign(hAlign),
                        textBaseline: textBaseline,
                        opacity: opacity
                    };
                };
                // 计算文本大小
                BaseCellType.prototype._calcTextSize = function (data, linesStyle, isVertical) {
                    var width = 0;
                    var height = 0;
                    var i;
                    for (i = 0; i < data.length; i++) {
                        height += linesStyle[i].lineHeight;
                        width = Math.max(data[i].textLength, width);
                    }
                    return {
                        width: isVertical ? height : width,
                        height: isVertical ? width : height
                    };
                };
                // 计算绘制位置
                BaseCellType.prototype._calcPaintPositions = function (x, y, w, h, hAlign, vAlign, indent, isVertical, isCJKText, data, linesStyle, externalElementsSize, showEllipsis) {
                    var textSize = this._calcTextSize(data, linesStyle, isVertical);
                    var textHeight = textSize.height;
                    var textWidth = textSize.width;
                    var positions = [];
                    var i;
                    if (isVertical) {
                        for (i = 0; i < data.length; i++) {
                            positions.push(this._calcVerticalPaintPosition(x, y, w, h, hAlign, vAlign, indent, textWidth, data[i].textLength, linesStyle[i].lineHeight, linesStyle[i].lineOffset, isCJKText, externalElementsSize, data[i], showEllipsis));
                            if (isCJKText) {
                                x -= linesStyle[i].lineHeight;
                            } else {
                                x += linesStyle[i].lineHeight;
                            }
                        }
                    } else {
                        for (i = 0; i < data.length; i++) {
                            positions.push(this._calcHorizontalPaintPosition(x, y, w, h, hAlign, vAlign, indent, data[i].textLength, textHeight, linesStyle[i].lineHeight, linesStyle[i].lineOffset, externalElementsSize));
                            y += linesStyle[i].lineHeight;
                        }
                    }
                    return positions;
                };
                // 计算水平绘制位置
                BaseCellType.prototype._calcHorizontalPaintPosition = function (x, y, w, h, hAlign, vAlign, indent, textWidth, textHeight, lineHeight, lineOffset, externalElementsSize) {
                    var deltaX = 0;
                    var deltaY = 0;
                    var leftExternalElementsWidth = externalElementsSize.left;
                    var rightExternalElementsWidth = externalElementsSize.right;
                    if (vAlign === 1) {
                        deltaY = (h - textHeight) / 2 + lineHeight - lineOffset;
                    } else if (vAlign === 2) {
                        deltaY = h - textHeight - 2 + lineHeight - lineOffset;
                    } else {
                        deltaY = 2 + lineHeight - lineOffset;
                    }
                    if (hAlign === 1) {
                        deltaX = (w - textWidth + leftExternalElementsWidth - rightExternalElementsWidth) / 2;
                    } else if (hAlign === 2) {
                        deltaX = w - 1 - 2 - textWidth - rightExternalElementsWidth;
                        deltaX -= indent;
                    } else {
                        deltaX = 2 + indent + leftExternalElementsWidth;
                    }
                    return {
                        x: x + deltaX,
                        y: y + deltaY
                    };
                };
                // 计算垂直绘制位置
                BaseCellType.prototype._calcVerticalPaintPosition = function (x, y, w, h, hAlign, vAlign, indent, textWidth, textHeight, lineHeight, lineOffset, isCJKText, externalElementsSize, data, showEllipsis) {
                    var deltaX = 0;
                    var deltaY = 0;
                    var fontSize;
                    var leftExternalElementsWidth = externalElementsSize.left;
                    var rightExternalElementsWidth = externalElementsSize.right;
                    if (isCJKText) {
                        if (hAlign === 0) {
                            deltaX = 2 + textWidth + rightExternalElementsWidth - lineHeight / 2;
                        } else if (hAlign === 1) {
                            deltaX = (w - leftExternalElementsWidth + rightExternalElementsWidth + textWidth) / 2 - lineHeight / 2;
                        } else if (hAlign === 2) {
                            deltaX = w - leftExternalElementsWidth - 1 - 2 - lineHeight / 2;
                        }
                    } else if (hAlign === 1) {
                        deltaX = (w - textWidth + leftExternalElementsWidth - rightExternalElementsWidth) / 2 + lineHeight / 2;
                    } else if (hAlign === 2) {
                        deltaX = w - 1 - 2 - rightExternalElementsWidth - textWidth + lineHeight / 2;
                    } else if (hAlign === 0) {
                        deltaX = 2 + leftExternalElementsWidth + lineHeight / 2;
                    }
                    if (vAlign === 1) {
                        deltaY = (h - textHeight) / 2;
                    } else if (vAlign === 2) {
                        deltaY = h - indent - textHeight - 2;
                    } else {
                        deltaY = 2 + indent;
                    }
                    return {
                        x: x + deltaX,
                        y: y + deltaY
                    };
                };
                // 绘制文本
                BaseCellType.prototype._paintText = function (ctx, sheet, x, y, style, text, ellipsisIndex) {
                    ctx.save();
                    this._setContext(ctx, sheet, style);
                    var subscriptOrSuperscriptInfo = style.vertAlign;
                    var pos;
                    if (style.isVerticalText) {
                        pos = this._fillVerticalText(ctx, text, x, y, style.textDecoration, style.baselineOffset, ellipsisIndex);
                    } else {
                        pos = this._fillHorizontalText(ctx, x, y, style, text, subscriptOrSuperscriptInfo);
                    }
                    ctx.restore();
                    return pos;
                };
                // 设置上下文
                BaseCellType.prototype._setContext = function (ctx, sheet, style) {
                    resetFillStyle(ctx, sheet, style);
                    var font = style.vertAlign ? this._getSubscriptOrSuperscriptFontInfo(style.font) : style.font;
                    if (!_isNullOrUndefined(style.textBaseline) && ctx.textBaseline !== style.textBaseline) {
                        ctx.textBaseline = style.textBaseline;
                    } else if (_isNullOrUndefined(ctx.textBaseline) && ctx.textBaseline !== textBaseline) {
                        ctx.textBaseline = textBaseline;
                    }
                    if (style.isVerticalText) {
                        if (ctx.textAlign !== cssCenter) {
                            ctx.textAlign = cssCenter;
                        }
                    } else if (ctx.textAlign !== cssLeft) {
                        ctx.textAlign = cssLeft;
                    }
                    setContextFont(ctx, font);
                };
                // 获取下标或上标字体信息
                BaseCellType.prototype._getSubscriptOrSuperscriptFontInfo = function (font) {
                    var originalFontInfo = stylehelper_1._StyleHelper._splitFont(font);
                    var fontSize = parseFloat(originalFontInfo.fontSize) * subscriptAndSuperscriptScale;
                    originalFontInfo.fontSize = fontSize + 'px';
                    return this._buildSubscriptOrSuperscriptFontInfoString(originalFontInfo);
                };
                // 生成下标或上标字体信息字符串
                BaseCellType.prototype._buildSubscriptOrSuperscriptFontInfoString = function (fontInfo) {
                    var f = '';
                    var normal = 'normal';
                    var defaultFontFamily = 'Calibri';
                    var fontStyle = fontInfo.fontStyle;
                    var fontSize = fontInfo.fontSize;
                    var fontWeight = fontInfo.fontWeight;
                    var fontFamily = fontInfo.fontFamily;
                    if (fontStyle !== undefined) {
                        f = fontStyle;
                    } else {
                        f = normal;
                    }
                    if (fontWeight !== undefined) {
                        f += (f ? ' ' : '') + fontWeight;
                    } else {
                        f += (f ? ' ' : '') + normal;
                    }
                    f += (f ? ' ' : '') + fontSize;
                    if (fontFamily !== undefined) {
                        f += (f ? ' ' : '') + fontFamily;
                    } else {
                        f += (f ? ' ' : '') + defaultFontFamily;
                    }
                    return f;
                };
                // 填充垂直文本
                BaseCellType.prototype._fillVerticalText = function (ctx, text, x, y, textDecoration, baselineOffset, ellipsisIndex) {
                    if (text && text.length > 0) {
                        var fontSize = ctx.font;
                        var lineHeight = getFontHeight(fontSize, keyword_undefined, _isCJKText(text));
                        var lineOffset = getLineOffset(stylehelper_1._StyleHelper._scaleFont(fontSize, 1).fontSize, lineHeight);
                        var ellipsisLineHeight = this._getTextWidthWithTextWidthCache(ctx, '0');
                        var ellipsisLineOffset = ellipsisLineHeight / 2;
                        for (var i = 0; i < text.length; i++) {
                            var char = replaceVerticalBrackets(text[i]);
                            var isEllipsisChar = ellipsisIndex !== undefined
                                && (i >= ellipsisIndex && i <= ellipsisIndex + 2)
                                && ((ellipsisIndex + 3 === text.length)
                                    || (ellipsisIndex === 0 && ellipsisIndex + 3 < text.length)
                                    || (ellipsisIndex !== 0 && ellipsisIndex + 3 < text.length));
                            var actualLineHeight = isEllipsisChar ? ellipsisLineHeight : lineHeight;
                            var actualLineOffset = isEllipsisChar ? ellipsisLineOffset : lineOffset;
                            y = y + actualLineHeight - actualLineOffset;
                            ctx.fillText(char, x, y);
                            this._renderTextDecorationForVerticalText(ctx, textDecoration, x, y, measureTextWidth(ctx, ctx.font, char), stylehelper_1._StyleHelper._scaleFont(ctx.font, 1).fontSize, baselineOffset);
                            y += actualLineOffset;
                        }
                    }
                    return {
                        x: x,
                        y: y
                    };
                };
                // 渲染垂直文本的文本装饰
                BaseCellType.prototype._renderTextDecorationForVerticalText = function (ctx, textDecoration, x, y, textLength, fontSize, offset) {
                    if (ctx.strokeStyle !== ctx.fillStyle) {
                        ctx.strokeStyle = ctx.fillStyle;
                    }
                    var vposY = 0;
                    var lineWidth = 0;
                    var posOffset = 0.5;
                    var fontSizeTemp;
                    fontSizeTemp = fontSize <= 12 ? 12 : fontSize;
                    lineWidth = Math_floor((fontSizeTemp - 12) / 21 + 1);
                    if (ctx.lineWidth !== lineWidth) {
                        ctx.lineWidth = lineWidth;
                    }
                    if ((lineWidth & 1) === 0) {
                        posOffset = 0;
                    }
                    var textAlign = ctx.textAlign;
                    if (textAlign === cssCenter) {
                        x = x - textLength / 2;
                    } else if (textAlign === cssRight) {
                        x = x - textLength;
                    }
                    ctx.beginPath();
                    if ((textDecoration & 2) === 2) {
                        vposY = Math_ceil(y + offset - fontSize / 2) - posOffset;
                        ctx.moveTo(x, vposY);
                        ctx.lineTo(x + textLength, vposY);
                    }
                    ctx.stroke();
                };
                // 填充水平文本
                BaseCellType.prototype._fillHorizontalText = function (ctx, x, y, style, text, subscriptOrSuperscriptInfo) {
                    if (_isNullOrUndefined(text)) {
                        return {
                            x: x,
                            y: y
                        };
                    }
                    var fontSize = stylehelper_1._StyleHelper._scaleFont(ctx.font, 1).fontSize;
                    var offset = fontSize > 8 ? Math_floor((fontSize - 8) / 5 + 2) : 1;
                    var subscriptOrSuperscriptOffset = 0;
                    if (subscriptOrSuperscriptInfo) {
                        if (subscriptOrSuperscriptInfo === 1) {
                            subscriptOrSuperscriptOffset = fontSize * 0.74;
                        } else {
                            subscriptOrSuperscriptOffset = -fontSize * 0.28;
                        }
                        ctx.fillText(text, x, y - subscriptOrSuperscriptOffset);
                    } else {
                        ctx.fillText(text, x, y);
                    }
                    var length = measureTextWidth(ctx, ctx.font, text);
                    var textDecoration = style.textDecoration;
                    this._renderTextDecoration(ctx, textDecoration, x, y, length, fontSize, offset - subscriptOrSuperscriptOffset);
                    return {
                        x: x + length,
                        y: y
                    };
                };
                // 绘制
                BaseCellType.prototype._paint = function (ctx, value, x, y, w, h, style, context) {
                    var hyperlinkPaintInfo = {
                        row: context.row,
                        col: context.col,
                        sheet: context.sheet,
                        sheetArea: context.sheetArea,
                        style: style,
                        underline: style.textDecoration,
                        foreColor: style.foreColor,
                    };
                    BaseCellType._callFeatureHandler(context.sheet, 'applyHyperlinkStyle', hyperlinkPaintInfo);
                    this.paint(ctx, value, x, y, w, h, style, context);
                };
                // 绘制
                BaseCellType.prototype.paint = function (ctx, value, x, y, w, h, style, context) {
                    if (!ctx) {
                        return;
                    }
                    var styleBackColor = style.backColor;
                    if (context.parentBackColor !== styleBackColor) {
                        cellTypeContext_paintBackground(ctx, x, y, w, h, context.imageLoader, style, value, context);
                    }
                    var self = this;
                    var rect = new common_1.Rect(x, y, w, h);
                    self._callBeforePaintLabelHandler(ctx, context, rect, value, style);
                    if (self._paintLabel) {
                        self._paintLabel(ctx, rect, style, context);
                        rect = self._getContentRect(rect, style, isPrintZoomFactorExist(context) ? context.printZoomFactor : context.sheet.zoom());
                    }
                    if (!context.cellOverflowLayout) {
                        self._callPaintCellPaddingFeatureHandler(ctx, rect, context, convertRichTextValue(value));
                    }
                    if (rect.width > 0 && rect.height > 0) {
                        if (style && style.showEllipsis) {
                            context.sheet._modelManager._setCellNodeTipContent(context.row, context.col, null, context.sheetArea);
                        }
                        self.paintContent(ctx, value, rect.x, rect.y, rect.width, rect.height, style, context);
                    }
                };
                // 绘制上下文
                BaseCellType.prototype.paintContent = function (ctx, value, x, y, w, h, style, context) {
                    var sheetArea = context.sheetArea;
                    if (sheetArea === 2 || sheetArea === 1) {
                        var visualState = context.visualState || 0;
                        var headerTypeString = 'columnHeader';
                        if (sheetArea === 2) {
                            headerTypeString = 'rowHeader';
                        }
                        var themeStyle = this.getThemeStyle(context.visualState, 'gc-' + headerTypeString + '-' + common_1._ThemeStyleHelper._getString(visualState));
                        CellTypeContext._paintHeaderCellGridline(ctx, x, y, w, h, style, headerTypeString, themeStyle, sheetArea);
                    }
                    var showBarIconOnly;
                    var conditionalFormats = context.conditionalFormats;
                    if (conditionalFormats) {
                        showBarIconOnly = conditionalFormats._paint(ctx, convertRichTextValue(value), x, y, w, h, style, context);
                    }
                    context.showBarIconOnly = showBarIconOnly;
                    var sparkline = context.sparkline;
                    if (sparkline) {
                        sparkline.paintSparkline(ctx, x, y, w, h);
                    }
                    var showSparklineEx = CellTypeContext._paintSparklineEx(ctx, convertRichTextValue(value), x, y, w, h, context);
                    if (!context.cellOverflowLayout && !showBarIconOnly && !showSparklineEx) {
                        var rect = new common_1.Rect(x, y, w, h);
                        this.paintValue(ctx, value, rect.x, rect.y, rect.width, rect.height, style, context);
                    }
                };
                // 调整图标集的矩形
                BaseCellType.prototype.adjustRectForIconSet = function (hAlign, sheet, row, col, sheetArea, rect, hasFillingChar) {
                    cellTypeContext_adjustRectForIconSet(hAlign, sheet, row, col, sheetArea, rect, hasFillingChar);
                };
                // 是否有填充
                BaseCellType.prototype.hasInfilling = function (textContent) {
                    for (var i = 0; i < textContent.length; i++) {
                        if ((textContent[i]).type === 'fillingChar') {
                            return true;
                        }
                    }
                    return false;
                };
                // 创建编辑器元素
                BaseCellType.prototype.createEditorElement = function (context, cellWrapperElement) {
                    return keyword_null;
                };
                // 获取编辑器值
                BaseCellType.prototype.getEditorValue = function (editorContext, context) {
                    return keyword_null;
                };
                // 格式化编辑器值
                BaseCellType.prototype._formatEditorValue = function (editorContext, cellStyle, value, context) {
                    return value;
                };
                // 设置编辑器值
                BaseCellType.prototype.setEditorValue = function (editorContext, value, context) { };
                // 获取正在编辑的元素
                BaseCellType.prototype.getEditingElement = function () {
                    return keyword_null;
                };
                // 解析
                BaseCellType.prototype.parse = function (text, formatStr, context) {
                    var formatStrIsNull = _isNullOrUndefined(formatStr);
                    var textIsNull = _isNullOrUndefined(text);
                    try {
                        var GeneralFormatter = Common_1.Formatter && Common_1.Formatter.GeneralFormatter;
                        if (!formatStrIsNull && !textIsNull && GeneralFormatter) {
                            var formatter = (typeof (formatStr) === const_string ? new GeneralFormatter(formatStr) : formatStr);
                            return formatter.parse(text);
                        }
                    } catch (ex) { }
                    return textIsNull ? '' : text.toString();
                };
                // 格式化
                BaseCellType.prototype.format = function (value, format, formattedData, context) {
                    var isformatStr = isformatString(format);
                    if (context && isformatStr) {
                        var sheet = context.sheet;
                        var formatStringResult = sheet._getFormatStringResult(context.row, context.col, format);
                        if (!_isNullOrUndefined(formatStringResult)) {
                            value = formatStringResult;
                        }
                    }
                    if (_isNullOrUndefined(value) || value === '') {
                        return '';
                    }
                    if (context && context.quotePrefix && typeof value === const_string) {
                        return value.toString();
                    }
                    if (!isformatStr && typeof format === const_string && typeof value !== 'object') {
                        return common_1._CacheMgr._getFormattedText(value, format, formattedData);
                    }
                    if ((!format || format === 'General') || isformatStr) {
                        if (typeof value === 'boolean' || value instanceof Boolean) {
                            if (CalcEngine) {
                                value = value ? CalcEngine.getBoolean().boolean_true : CalcEngine.getBoolean().boolean_false;
                            }
                            return value.toString().toUpperCase();
                        } else if (value instanceof Date) {
                            var DateTimeFormat = CultureManager._getCultureInfo(CultureManager.culture()).DateTimeFormat, defaultFormat = DateTimeFormat.shortDatePattern;
                            if (!(value.getHours() === 0 && value.getMinutes() === 0 && value.getSeconds() === 0 && value.getMilliseconds() === 0)) {
                                defaultFormat = DateTimeFormat.defaultDatePattern;
                            }
                            return _DateTimeHelper._localeFormat(value, defaultFormat);
                        }
                        if (typeof value === const_number) {
                            value = _NumberHelper._replaceNormalToCultureSymbol(value.toString());
                        }
                        return value.toString();
                    }
                    try {
                        var GeneralFormatter = Common_1.Formatter && Common_1.Formatter.GeneralFormatter;
                        if (GeneralFormatter) {
                            var formatter = keyword_null;
                            if (typeof format === const_string) {
                                formatter = common_1._CacheMgr._getFormatter(format);
                            } else {
                                formatter = format;
                            }
                            return formatter.format(value, formattedData);
                        }
                        return value.toString();
                    } catch (ex) {
                        return value.toString();
                    }
                };
                // 聚焦
                BaseCellType.prototype.focus = function (editorContext, context) {
                    if (editorContext && editorContext.focus) {
                        editorContext.focus();
                    }
                };
                // 获取主题样式
                BaseCellType.prototype.getThemeStyle = function (visualState, defaultClass) {
                    return common_1._ThemeStyleHelper._getVisualStateThemeStyle(visualState, defaultClass);
                };
                // 激活编辑器
                BaseCellType.prototype.activateEditor = function (editorContext, cellStyle, cellRect, context, wrapperRect, leftExternalRect, rightExternalRect) { };
                // 停用编辑器
                BaseCellType.prototype.deactivateEditor = function (editorContext, context) { };
                // 全部选择
                BaseCellType.prototype.selectAll = function (editorContext, context) {
                    if (editorContext && editorContext.select) {
                        editorContext.select();
                    }
                };
                // 更新编辑器
                BaseCellType.prototype.updateEditor = function (editorContext, cellStyle, cellRect, context, editorBounds, leftExternalBounds, rightExternalBounds) { };
                // 设置输入法模式
                BaseCellType.prototype.setImeMode = function (editorContext, imeMode, context) {
                    if (this.isImeAware(context)) {
                        this.updateImeMode(editorContext, imeMode, context);
                    } else if (editorContext) {
                        CellTypeContext._setImeMode(editorContext, 0);
                    }
                };
                // 更新输入法模式
                BaseCellType.prototype.updateImeMode = function (editorContext, imeMode, context) {
                    if (editorContext) {
                        CellTypeContext._setImeMode(editorContext, imeMode);
                    }
                };
                // 获取命中信息
                BaseCellType.prototype.getHitInfo = function (x, y, cellStyle, cellRect, context) {
                    return keyword_null;
                };
                // 获取单元格和填充命中信息
                BaseCellType.prototype.getCellAndPaddingHitInfo = function (x, y, cellStyle, cellRect, context) {
                    var self = this;
                    if (context) {
                        var args_1 = {
                            x: x,
                            y: y,
                            context: context,
                            cellStyle: cellStyle,
                            cellRect: cellRect,
                            paddingHitInfo: null
                        };
                        BaseCellType._callFeatureHandler(context.sheet, 'getCellButtonHitInfo', args_1, function () {
                            return args_1.paddingHitInfo !== null && args_1.paddingHitInfo !== undefined;
                        });
                        var info = args_1.paddingHitInfo;
                        if (args_1.paddingHitInfo && !_isNullOrUndefined(args_1.paddingHitInfo.cellButtonHitInfo) && !_isNullOrUndefined(args_1.paddingHitInfo.cellButtonHitInfo.buttonConfig)) {
                            return args_1.paddingHitInfo;
                        }
                        args_1.cellRect = self._getContentRect ? self._getContentRect(args_1.cellRect, cellStyle, context.sheet.zoom()) : args_1.cellRect;
                        BaseCellType._callFeatureHandler(context.sheet, 'getCellTextHitInfo', args_1, function () {
                            return !_isNullOrUndefined(args_1.paddingHitInfo) && args_1.paddingHitInfo.isReservedLocation;
                        });
                        if (args_1.paddingHitInfo && args_1.paddingHitInfo.isReservedLocation) {
                            return args_1.paddingHitInfo;
                        }
                        if (context.sheetArea === 3) {
                            BaseCellType._callFeatureHandler(context.sheet, 'getCellPaddingHitInfo', args_1, function () {
                                return !_isNullOrUndefined(args_1.paddingHitInfo) && args_1.paddingHitInfo.isReservedLocation;
                            });
                            if (args_1.paddingHitInfo) {
                                return args_1.paddingHitInfo;
                            }
                            if (info) {
                                return info;
                            } else {
                                return this.getHitInfo(x, y, cellStyle, cellRect, context);
                            }
                        }
                    }
                    return this.getHitInfo(x, y, cellStyle, cellRect, context);
                };
                // 处理单元格并向下填鼠标点击
                BaseCellType.prototype.processCellAndPaddingMouseDown = function (hitInfo) {
                    BaseCellType._callFeatureHandler(hitInfo.sheet, 'processMouseDownOnCellPadding', hitInfo);
                    return this.processMouseDown(hitInfo);
                };
                // 处理鼠标点击
                BaseCellType.prototype.processMouseDown = function (hitInfo) {
                    return false;
                };
                // 处理鼠标移动
                BaseCellType.prototype._onProcessMouseMove = function (hitInfo) {
                    BaseCellType._callFeatureHandler(hitInfo.sheet, 'processMouseMoveOnCellPadding', hitInfo);
                    return this.processMouseMove(hitInfo);
                };
                // 处理鼠标移动
                BaseCellType.prototype.processMouseMove = function (hitInfo) {
                    return false;
                };
                // 处理鼠标释放
                BaseCellType.prototype._onProcessMouseUp = function (hitInfo) {
                    BaseCellType._callFeatureHandler(hitInfo.sheet, 'processMouseUpOnCellPadding', hitInfo);
                    return this.processMouseUp(hitInfo);
                };
                // 处理鼠标释放
                BaseCellType.prototype.processMouseUp = function (hitInfo) {
                    return false;
                };
                // 处理鼠标进入
                BaseCellType.prototype.processMouseEnter = function (hitInfo) {
                    return false;
                };
                // 处理鼠标离开
                BaseCellType.prototype._onProcessMouseLeave = function (hitInfo) {
                    BaseCellType._callFeatureHandler(hitInfo.sheet, 'processMouseLeaveOnCellPadding', hitInfo);
                    return this.processMouseLeave(hitInfo);
                };
                // 处理鼠标离开
                BaseCellType.prototype.processMouseLeave = function (hitInfo) {
                    return false;
                };
                // 是否保留密钥
                BaseCellType.prototype.isReservedKey = function (e, context) {
                    return false;
                };
                // 正在编辑状态是否已更改
                BaseCellType.prototype.isEditingValueChanged = function (oldValue, newValue, context) {
                    var sheet = context.sheet;
                    var row = context.row;
                    var col = context.col;
                    var value = sheet && sheet.getValue(row, col, 3, core_enum_1.ValueType.richText);
                    if (value && value.richText) {
                        oldValue = oldValue && oldValue.replace(/\r\n?/g, '\n');
                    }
                    if (oldValue === keyword_null) {
                        oldValue = keyword_undefined;
                    }
                    if (newValue === keyword_null) {
                        newValue = keyword_undefined;
                    }
                    return oldValue !== newValue;
                };
                // 处理合成开始
                BaseCellType.prototype.processCompositionStart = function (event, context) {
                    return false;
                };
                // 处理键按下
                BaseCellType.prototype.processKeyDown = function (event, context) {
                    return false;
                };
                // 处理键释放
                BaseCellType.prototype.processKeyUp = function (event, context) {
                    return false;
                };
                // 获取自动调整宽度
                BaseCellType.prototype.getAutoFitWidth = function (value, text, cellStyle, zoomFactor, context) {
                    return CellTypeContext._getAutoFitWidth(value, text, cellStyle, zoomFactor, context);
                };
                // 获取自动调整高度
                BaseCellType.prototype.getAutoFitHeight = function (value, text, cellStyle, zoomFactor, context) {
                    return CellTypeContext._getAutoFitHeight(value, text, cellStyle, zoomFactor, context);
                };
                // 渲染单元格普通文本
                BaseCellType.prototype._renderCellTextNormal = function (ctx, text, formattedData, adjustedX, adjustedY, hAlign, clipWidth, indent, textDecoration, baselineOffset, fontSize, context, style, externalsSize, availRect, hasOverflowed, textLength, showEllipsis) {
                    var self = this;
                    if (formattedData && formattedData.content && formattedData.content.length > 0 && (showEllipsis || !hasOverflowed)) {
                        this._paintTextObject(ctx, formattedData.content, adjustedX, adjustedY, hAlign, clipWidth, indent, textDecoration, baselineOffset, fontSize, context, style, externalsSize, availRect, textLength);
                    } else {
                        textLength = textLength ? textLength : measureTextWidth(ctx, ctx.font, text);
                        var textAreaStartX = adjustedX;
                        if (ctx.textAlign === cssCenter) {
                            textAreaStartX -= textLength / 2;
                        } else if (ctx.textAlign === cssRight) {
                            textAreaStartX -= textLength;
                        }

                        self._callBeforeFillTextAreaHandler(ctx, style, context, textAreaStartX, adjustedY, textLength, context.lineHeight, availRect);
                        ctx.fillText(text, adjustedX, adjustedY);
                        if (textDecoration) {
                            this._renderTextDecoration(ctx, textDecoration, adjustedX, adjustedY, textLength, fontSize, baselineOffset);
                        }
                        self._callAfterFillTextAreaHandler(ctx, style, context, textAreaStartX, adjustedY, textLength, context.lineHeight, availRect);
                    }
                };
                // 绘制旋转文字的实现
                BaseCellType.prototype._paintRotateTextImp = function (ctx, textOrientationRadian, text, x, y, textDecoration, fontSize, offset, lineHeight) {
                    ctx.save();
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.translate(x, y);
                    ctx.rotate(-textOrientationRadian);
                    ctx.fillText(text, 0, 0);
                    if (textDecoration) {
                        var textLength = ctx.measureText(text).width;
                        this._renderTextDecoration(ctx, textDecoration, 0, lineHeight, textLength, fontSize, offset);
                    }
                    ctx.restore();
                };
                // 旋转时获取格式化文本来调整单元格
                BaseCellType.prototype._getFormatedTextFitCellWhenRotate = function (ctx, textContent, clipHeight, font) {
                    if (!ctx.font) {
                        setContextFont(ctx, font);
                    }
                    var textContentWidth = getTextContentWidth(ctx, textContent);
                    var infillingWidth = clipHeight - textContentWidth;
                    infillingWidth = infillingWidth > 0 ? infillingWidth : 0;
                    var strArray = [];
                    for (var i = 0; i < textContent.length; i++) {
                        if (textContent[i].type === 'fillingChar') {
                            strArray.push(createInfillingText(ctx, infillingWidth, textContent[i].value));
                        } else if (textContent[i].type === 'placeholder' || textContent[i].type === 'numberPlaceholder') {
                            continue;
                        } else {
                            strArray.push(textContent[i].value);
                        }
                    }
                    return strArray.join('');
                };
                // 绘制文本对象
                BaseCellType.prototype._paintTextObject = function (ctx, textContent, x, y, hAlign, clipWidth, indent, textDecoration, baselineOffset, fontSize, context, style, externalsSize, availRect, textLength) {
                    ctx.save();
                    if (ctx.textAlign !== cssLeft) {
                        ctx.textAlign = cssLeft;
                    }
                    var self = this;
                    var textContentWidth = getTextContentWidth(ctx, textContent);
                    var leftExternalElementsWidth = (externalsSize ? externalsSize.left : 0);
                    var rightExternalElementsWidth = (externalsSize ? externalsSize.right : 0);
                    var horizontalExternalElementsWidth = leftExternalElementsWidth + rightExternalElementsWidth;
                    var infillingWidth = clipWidth - indent - textContentWidth - horizontalExternalElementsWidth - 2;
                    infillingWidth = infillingWidth > 0 ? infillingWidth : 0;
                    if (!_isNullOrUndefined(textLength)) {
                        if (this.hasInfilling(textContent)) {
                            if (hAlign === 1) {
                                x = x + (textLength ? textLength : textContentWidth) / 2 - (clipWidth + leftExternalElementsWidth - rightExternalElementsWidth) / 2;
                                x += (indent + leftExternalElementsWidth);
                            } else if (hAlign === 2) {
                                x = x + (textLength ? textLength : textContentWidth) - clipWidth + rightExternalElementsWidth + 2;
                                x += (indent + leftExternalElementsWidth);
                            }
                        } else if (!_isNullOrUndefined(textContentWidth)) {
                            if (hAlign === 1) {
                                x = x + textLength / 2 - textContentWidth / 2;
                            } else if (hAlign === 2) {
                                x = x + textLength - textContentWidth;
                            }
                        }
                    } else if (this.hasInfilling(textContent)) {
                        if (hAlign === 1) {
                            x -= (clipWidth + leftExternalElementsWidth - rightExternalElementsWidth) / 2;
                            x += (indent + leftExternalElementsWidth);
                        } else if (hAlign === 2) {
                            x = x - clipWidth + rightExternalElementsWidth + 2;
                            x += (indent + leftExternalElementsWidth);
                        }
                    } else if (!_isNullOrUndefined(textContentWidth)) {
                        if (hAlign === 1) {
                            x -= textContentWidth / 2;
                        } else if (hAlign === 2) {
                            x -= textContentWidth;
                        }
                    }
                    self._callBeforeFillTextAreaHandler(ctx, style, context, x, y, textContentWidth, context.lineHeight, availRect);
                    var end = this._paintTextItem(ctx, textContent, x, y, infillingWidth, textDecoration, baselineOffset, fontSize);
                    self._callAfterFillTextAreaHandler(ctx, style, context, x, y, end - x, context.lineHeight, availRect);
                    ctx.restore();
                };
                // 绘制文本项
                BaseCellType.prototype._paintTextItem = function (ctx, text, x, y, infillingWidth, textDecoration, baselineOffset, fontSize, options) {
                    var defaultWordWidth = 0;
                    if (textWidthCache[ctx.font + '0']) {
                        defaultWordWidth = textWidthCache[ctx.font + '0'];
                    } else {
                        defaultWordWidth = measureTextWidth(ctx, ctx.font, '0');
                        textWidthCache[ctx.font + '0'] = defaultWordWidth;
                    }
                    for (var i = 0; i < text.length; i++) {
                        if (text[i].type === 'fillingChar') {
                            ctx.fillText(createInfillingText(ctx, infillingWidth, text[i].value), x, y);
                            if (textDecoration) {
                                this._renderTextDecoration(ctx, textDecoration, x, y, infillingWidth, fontSize, baselineOffset);
                            }
                            x += infillingWidth;
                        } else if (text[i].type === 'placeholder') {
                            x += measureTextWidth(ctx, ctx.font, text[i].value);
                        } else if (text[i].type === 'numberPlaceholder') {
                            x += defaultWordWidth;
                        } else {
                            var tempValue = text[i].value;
                            if (tempValue !== keyword_null) {
                                ctx.fillText(tempValue, x, y);
                            }
                            var filledWidth = measureTextWidth(ctx, ctx.font, tempValue);
                            if (textDecoration) {
                                this._renderTextDecoration(ctx, textDecoration, x, y, filledWidth, fontSize, baselineOffset);
                            }
                            x += filledWidth;
                        }
                    }
                    return x;
                };
                // 渲染文本装饰
                BaseCellType.prototype._renderTextDecoration = function (ctx, textDecoration, x, y, textLength, fontSize, offset) {
                    if (ctx.strokeStyle !== ctx.fillStyle) {
                        ctx.strokeStyle = ctx.fillStyle;
                    }
                    var textAlign = ctx.textAlign;
                    var vposY = 0;
                    var lineWidth = 0;
                    var posOffset = 0.5;
                    var fontSizeTemp;
                    fontSizeTemp = fontSize <= 12 ? 12 : fontSize;
                    lineWidth = Math_floor((fontSizeTemp - 12) / 21 + 1);
                    if (ctx.lineWidth !== lineWidth) {
                        ctx.lineWidth = lineWidth;
                    }
                    if ((lineWidth & 1) === 0) {
                        posOffset = 0;
                    }
                    if (textAlign === cssCenter) {
                        x = x - textLength / 2;
                    } else if (textAlign === cssRight) {
                        x = x - textLength;
                    }
                    ctx.beginPath();
                    if ((textDecoration & 4) === 4) {
                        vposY = Math_ceil(y + offset - fontSize - 1) - posOffset;
                        ctx.moveTo(x, vposY);
                        ctx.lineTo(x + textLength, vposY);
                    }
                    if ((textDecoration & 2) === 2) {
                        vposY = Math_ceil(y + offset - fontSize / 2) - posOffset;
                        ctx.moveTo(x, vposY);
                        ctx.lineTo(x + textLength, vposY);
                    }
                    if ((textDecoration & 1) === 1) {
                        vposY = Math_ceil(y + offset - 1) - posOffset;
                        ctx.moveTo(x, vposY);
                        ctx.lineTo(x + textLength, vposY);
                    }
                    if ((textDecoration & 8) === 8) {
                        vposY = Math_ceil(y + offset - 1) - posOffset;
                        ctx.moveTo(x, vposY - lineWidth);
                        ctx.lineTo(x + textLength, vposY - lineWidth);
                        ctx.moveTo(x, vposY + lineWidth);
                        ctx.lineTo(x + textLength, vposY + lineWidth);
                    }
                    ctx.stroke();
                };
                // 设置文本装饰
                BaseCellType.prototype._setTextDecoration = function (content, textDecorationType) {
                    var textDecoration = '';
                    if ((textDecorationType & 4) === 4) {
                        textDecoration = 'overline';
                    }
                    if ((textDecorationType & 2) === 2) {
                        textDecoration += ' line-through';
                    }
                    if ((textDecorationType & 1) === 1) {
                        textDecoration += ' underline';
                    }
                    content.css('text-decoration', textDecoration);
                };
                // 克隆单元格类型
                BaseCellType.prototype._cloneCellType = function () {
                    return keyword_null;
                };
                // 
                BaseCellType.prototype.isImeAware = function (context) {
                    return false;
                };
                // 正在编辑
                BaseCellType.prototype.isEditting = function () {
                    return false;
                };
                // 来自选项
                BaseCellType.prototype._fromOptions = function (options) { };
                // 转换为JSON
                BaseCellType.prototype.toJSON = function () {
                    var settings = {};
                    var self = this;
                    for (var p in self) {
                        if (self.hasOwnProperty(p)) {
                            settings[p] = self[p];
                        }
                    }
                    return settings;
                };
                // 从JSON解析
                BaseCellType.prototype.fromJSON = function (settings) {
                    if (settings) {
                        for (var p in settings) {
                            if (!_isNullOrUndefined(settings[p])) {
                                this[p] = settings[p];
                            }
                        }
                    }
                };
                return BaseCellType;
            }());
            exports.Base = BaseCellType;
            common_1._defineFeature(BaseCellType);
            celltype_ns_1._typeDict[0] = BaseCellType;

            // 单元格类型上下文是否已设置图标集
            function cellTypeContext_hasIconSet(sheet, row, col, sheetArea) {
                var cfs = sheet.conditionalFormats;
                if (cfs) {
                    var value = sheet.getValue(row, col, sheetArea);
                    var iconSet = cfs._getIconSetAndDataBar(sheet, row, col, value).iconSet;
                    return cfs._hasIconSet(row, col, sheetArea) && iconSet;
                }
            }
            // 获取最大行高度
            function getMaxHeightInLine(line, defaultFont, zoomFactor) {
                var maxHeightInLine = 0;
                for (var i = 0; i < line.length; i++) {
                    var font = void 0;
                    if (line[i].style && line[i].style.font) {
                        font = line[i].style.font;
                    } else {
                        font = defaultFont;
                    }
                    maxHeightInLine = Math.max(getFontHeight(font, keyword_undefined, _isCJKText(line[i].text)) / zoomFactor, maxHeightInLine);
                    if (line[i].style && (line[i].style.vertAlign === 1) || (line[i].style.vertAlign === 2)) {
                        maxHeightInLine = Math.max(getFontHeight(font, keyword_undefined, _isCJKText(line[i].text)) / zoomFactor + stylehelper_1._StyleHelper._scaleFont(font, subscriptAndSuperscriptScale).fontSize * 2 * 0.218, maxHeightInLine);
                    }
                }
                return maxHeightInLine;
            }
            // 获取文本行长度
            function getTextLengthInLine(line, defaultFont, zoomFactor, isVerticalText, withoutEndSpaces) {
                var ctx = common_1._WordWrapHelper._getCtx();
                if (!ctx) {
                    return 0;
                }
                var textLength = 0;
                for (var i = 0; i < line.length; i++) {
                    var font = void 0;
                    if (line[i].style && line[i].style.font) {
                        font = line[i].style.font;
                    } else {
                        font = defaultFont;
                    }
                    if (line[i].style && line[i].style.vertAlign) {
                        font = stylehelper_1._StyleHelper._scaleFont(font, subscriptAndSuperscriptScale).font;
                    }
                    setContextFont(ctx, font);
                    var text = '';
                    if (i === line.length - 1 && withoutEndSpaces) {
                        text = common_1._WordWrapHelper._removeEndSpace(line[i].text);
                    } else {
                        text = line[i].text;
                    }
                    var tempLength = 0;
                    if (isVerticalText) {
                        tempLength = getFontHeight(font) * text.length / zoomFactor;
                    } else if (!_isNullOrUndefined(line[i].text)) {
                        tempLength = measureTextWidth(ctx, font, line[i].text) / zoomFactor;
                    }
                    textLength += tempLength;
                }
                return textLength;
            }
            // 单元格上下文_绘画背景
            function cellTypeContext_paintBackground(ctx, x, y, w, h, imageLoader, style, value, context) {
                var backColor = style.backColor;
                var backgroundImage = style.backgroundImage;
                var textOrientation = style.textOrientation;
                var isVerticalText = style.isVerticalText;
                var textIndent = style.textIndent && style.textIndent !== 0;
                var backgroundImageLayout = style.backgroundImageLayout;
                var row = context.row, col = context.col;
                var isMerge = context.sheet && context.sheet.getSpan(row, col);
                var hasBorder = style && (style.borderLeft || style.borderTop || style.borderRight || style.borderBottom);
                var textOrientationRadian;
                var tantextOrientation;
                var moveLength = 0;
                var newX = x;
                var haveClip = false;
                ctx.save();
                var fillFunc;
                if (textOrientation && textOrientation !== 0 && hasBorder && value && !isMerge && !isVerticalText && !textIndent) {
                    textOrientationRadian = Math_abs(textOrientation * Math.PI / 180);
                    tantextOrientation = Math_tan(textOrientationRadian);
                    moveLength = Math_floor(h / tantextOrientation);
                    if (textOrientation > -90 && textOrientation < 0) {
                        newX = x - moveLength;
                    }
                    if (textOrientation > 0 && textOrientation < 90) {
                        newX = x + moveLength;
                    }
                    fillFunc = function () {
                        ctx.beginPath();
                        ctx.moveTo(newX, y);
                        ctx.lineTo(newX + w, y);
                        ctx.lineTo(x + w, y + h);
                        ctx.lineTo(x, y + h);
                        ctx.fill();
                    };
                } else {
                    fillFunc = function () {
                        ctx.fillRect(x, y, w, h);
                    };
                }
                if (backColor || backgroundImage) {
                    if (backColor) {
                        stylehelper_1._StyleHelper.setFillStyle(ctx, backColor, Math.min(newX, x), y, w + moveLength, h, fillFunc);
                    }

                    CellTypeContext._paintBackgroundImage(ctx, x, y, w, h, backgroundImage, backgroundImageLayout, imageLoader);
                }
                ctx.restore();
            }
            // 单元格上下文_为图标集调整矩形
            function cellTypeContext_adjustRectForIconSet(hAlign, sheet, row, col, sheetArea, rect, hasFillingChar) {
                if ((hAlign === 0 || hasFillingChar) && cellTypeContext_hasIconSet(sheet, row, col, sheetArea)) {
                    var iconSize = cellTypeContext_getIconSetSize(sheet);
                    rect.x += iconSize;
                    rect.width -= iconSize;
                }
            }
            // 单元格上下文_获取图标集大小
            function cellTypeContext_getIconSetSize(sheet) {
                return parseInt((ICONSET_SIZE * sheet.zoom()), 10);
            }
            // 获取位置偏移
            function getPositionOffset(cellStyle, position, isMargin, zoomFactor) {
                var cellPadding = cellStyle.cellPadding;
                var offsetValue = 0;
                var labelOptions = cellStyle.labelOptions;
                if (isMargin) {
                    cellPadding = labelOptions ? labelOptions.margin : '0';
                }
                if (cellPadding) {
                    offsetValue = parseInt(getCellOffsetArray(cellPadding)[position], 10);
                    offsetValue = (typeof offsetValue === const_number) && (offsetValue > 0) ? offsetValue : 0;
                }
                return (zoomFactor === keyword_undefined) ? offsetValue : offsetValue * zoomFactor;
            }
            // 获取 列偏移量
            function getOutlineColumnOffset(context) {
                var args = {
                    context: context,
                    value: 0
                };
                BaseCellType._callFeatureHandler(context.sheet, 'getOutlineColumnOffset', args);
                return args.value;
            }
            // 获取单元格按钮自适应宽度
            function getCellButtonAutoWidth(context, cellStyle) {
                var args = {
                    context: context,
                    value: 0,
                    cellStyle: cellStyle
                };
                BaseCellType._callFeatureHandler(context.sheet, 'getCellButtonAutoWidth', args);
                return args.value;
            }
            // 获取特殊图标自适应宽度
            function getSpecialIconsAutoWidth(context, cellStyle) {
                var args = {
                    context: context,
                    value: 0,
                    cellStyle: cellStyle
                };
                BaseCellType._callFeatureHandler(context.sheet, 'getSpecialIconsAutoWidth', args);
                return args.value;
            }
            // 获取单元格按钮自适应高度
            function getCellButtonAutoHeight(context, cellStyle) {
                var heightArgs = {
                    context: context,
                    value: 0,
                    cellStyle: cellStyle
                };
                BaseCellType._callFeatureHandler(context.sheet, 'getCellButtonAutoHeight', heightArgs);
                return heightArgs.value;
            }
            // 更新编辑器容器的位置
            function updateEditorPosition(cellWrapperElement, cellStyle, cellRect, context) {
                var sheet = context && context.sheet;
                if (sheet && cellRect) {
                    var offset = context.canvasOffset || sheet._eventHandler._getCanvasPosition();
                    var bounds = sheet._getBounds();
                    var backColor = cellStyle.backColor || 'white';
                    if (backColor.stops) {
                        var stops = backColor.stops;
                        backColor = stops[0] && stops[0].color;
                    }
                    if (backColor.backgroundColor) {
                        backColor = backColor.backgroundColor;
                    }
                    domUtil_1.GC$(cellWrapperElement)
                        .width(cellRect.width)
                        .height(cellRect.height)
                        .css({
                            'top': offset.top + bounds.y + cellRect.y - 2,
                            'left': offset.left + bounds.x + cellRect.x - 2,
                            'background-color': backColor
                        });
                }
            }
            // 获取单元格偏移数组
            function getCellOffsetArray(cellPadding) {
                var retArray = ['0', '0', '0', '0'];
                if (typeof cellPadding === const_string) {
                    var offsetArray = cellPadding.split(' ', 4);
                    var length_1 = offsetArray.length;
                    var topOffset = void 0;
                    var rightOffset = void 0;
                    if (length_1 === 1) {
                        topOffset = offsetArray[0];
                        retArray = [topOffset, topOffset, topOffset, topOffset];
                    } else if (length_1 === 2) {
                        topOffset = offsetArray[0];
                        rightOffset = offsetArray[1];
                        retArray = [topOffset, rightOffset, topOffset, rightOffset];
                    } else if (length_1 === 3) {
                        rightOffset = offsetArray[1];
                        retArray = [offsetArray[0], rightOffset, offsetArray[2], rightOffset];
                    } else if (length_1 === 4) {
                        retArray = [offsetArray[0], offsetArray[1], offsetArray[2], offsetArray[3]];
                    }
                }
                return retArray;
            }
            // 是否绘制标签
            function isPaintLabel(cellStyle, cellRect) {
                var paddingTop = getPositionOffset(cellStyle, 0);
                var paddingBottom = getPositionOffset(cellStyle, 2);
                var marginTop = getPositionOffset(cellStyle, 0, true);
                var marginBottom = getPositionOffset(cellStyle, 2, true);
                if (getPositionOffset(cellStyle, 3, true) + getPositionOffset(cellStyle, 1, true) >= cellRect.width) {
                    return false;
                }
                var labelAlignment = cellStyle.labelOptions.alignment;
                if (labelAlignment === keyword_undefined) {
                    labelAlignment = cellStyle.labelOptions.alignment = 0;
                }
                if (labelAlignment === 0 || labelAlignment === 1 || labelAlignment === 2) {
                    if (paddingTop > 0 && (marginTop + marginBottom < paddingTop)) {
                        return true;
                    }
                } else if (labelAlignment === 3 || labelAlignment === 4 || labelAlignment === 5) {
                    if (paddingTop < cellRect.height && paddingBottom > 0 && (marginTop + marginBottom < paddingBottom)) {
                        return true;
                    }
                }
                return false;
            }
            // 获取裁剪矩形
            function getClipRect(cellRect, cellStyle) {
                var paddingTop = getPositionOffset(cellStyle, 0);
                var marginLeft = getPositionOffset(cellStyle, 3, true);
                var marginBottom = getPositionOffset(cellStyle, 2, true);
                var newRect = cellRect.clone();
                var labelAlignment = cellStyle.labelOptions.alignment;
                if ((labelAlignment === 0 || labelAlignment === 1 || labelAlignment === 2)) {
                    if (paddingTop < cellRect.height) {
                        newRect.height = paddingTop - marginBottom + 1;
                    }
                } else if (labelAlignment === 3 || labelAlignment === 4 || labelAlignment === 5) {
                    newRect.height = cellRect.height - marginBottom;
                }
                newRect.x += marginLeft;
                newRect.width -= marginLeft + getPositionOffset(cellStyle, 1, true);
                return newRect;
            }
            // 获取文本对齐方式
            function getTextAlign(labelAlignment) {
                var align = 'left';
                if (labelAlignment === 1 || labelAlignment === 4) {
                    align = 'center';
                } else if (labelAlignment === 2 || labelAlignment === 5) {
                    align = 'right';
                }
                return align;
            }
            // 获取标签位置
            function getLabelPosition(cellRect, cellStyle, fontInfo, lineHeight) {
                var labelPosition = new common_1.Point(cellRect.x, cellRect.y);
                var fontSize = parseInt(fontInfo.fontSize, 10);
                var paddingTop = getPositionOffset(cellStyle, 0);
                var paddingBottom = getPositionOffset(cellStyle, 2);
                var marginLeft = getPositionOffset(cellStyle, 3, true);
                var marginRight = getPositionOffset(cellStyle, 1, true);
                var rectWidth = cellRect.width, rectHeight = cellRect.height;
                var baselineOffset = fontSize > 8 ? Math.floor((fontSize - 8) / 5 + 2) : 1;
                var lineOffset = lineHeight / 2 - fontSize / 2 + baselineOffset - 1;
                var adjX = fontSize > 8 ? 1 : 2;
                var adjY = lineHeight - lineOffset + getPositionOffset(cellStyle, 0, true);
                var topYOffset = adjY + 1;
                var bottomYOffset = (paddingTop + paddingBottom > rectHeight) ? (paddingTop + adjY) : (rectHeight - paddingBottom + adjY - 1);
                switch (cellStyle.labelOptions.alignment) {
                    case 0:
                        labelPosition.x += marginLeft + adjX + 1;
                        labelPosition.y += topYOffset;
                        break;
                    case 1:
                        labelPosition.x += marginLeft + (rectWidth - marginLeft - marginRight) / 2;
                        labelPosition.y += topYOffset;
                        break;
                    case 2:
                        labelPosition.x += rectWidth - marginRight - 2;
                        labelPosition.y += topYOffset;
                        break;
                    case 3:
                        labelPosition.x += marginLeft + adjX + 1;
                        labelPosition.y += bottomYOffset;
                        break;
                    case 4:
                        labelPosition.x += marginLeft + (rectWidth - marginLeft - marginRight) / 2;
                        labelPosition.y += bottomYOffset;
                        break;
                    case 5:
                        labelPosition.x += rectWidth - marginRight - 2;
                        labelPosition.y += bottomYOffset;
                        break;
                }
                return labelPosition;
            }
            // 获取标签矩形
            function getLabelRect(cellRect, cellStyle) {
                var marginLeft = getPositionOffset(cellStyle, 3, true);
                var marginRight = getPositionOffset(cellStyle, 1, true);
                var marginTop = getPositionOffset(cellStyle, 0, true);
                var marginBottom = getPositionOffset(cellStyle, 2, true);
                var labelRect = cellRect.clone();
                var labelAlignment = cellStyle.labelOptions.alignment;
                labelRect.x = marginLeft + 1;
                labelRect.width -= marginLeft + marginRight;
                if (labelAlignment === 0 || labelAlignment === 1 || labelAlignment === 2) {
                    labelRect.y = marginTop;
                    labelRect.height = getPositionOffset(cellStyle, 0) - marginTop - marginBottom;
                } else if (labelAlignment === 3 || labelAlignment === 4 || labelAlignment === 5) {
                    labelRect.y = cellRect.height - getPositionOffset(cellStyle, 2) + marginTop;
                    labelRect.height = getPositionOffset(cellStyle, 2) - marginTop - marginBottom;
                }
                if (labelAlignment === 2 || labelAlignment === 5) {
                    labelRect.width -= 2;
                }
                return labelRect;
            }
            // 获取文本上下文宽度
            function getTextContentWidth(ctx, textContent, isVerticalText) {
                if (_isType(textContent, const_string)) {
                    var contentWidth = 0;
                    if (textWidthCache[ctx.font + textContent]) {
                        contentWidth = textWidthCache[ctx.font + textContent];
                    } else {
                        contentWidth = measureTextWidth(ctx, ctx.font, textContent);
                        textWidthCache[ctx.font + textContent] = contentWidth;
                    }
                    return contentWidth;
                } else if (isVerticalText && textContent && textContent[0] && textContent[0].value) {
                    return textContent[0].value.length * getFontHeight(ctx.font);
                }
                var width = 0;
                for (var i = 0; i < textContent.length; i++) {
                    if (textContent[i].type !== 'fillingChar') {
                        var contentWidth = 0;
                        if (textWidthCache[ctx.font + textContent[i].value]) {
                            contentWidth = textWidthCache[ctx.font + textContent[i].value];
                        } else {
                            contentWidth = measureTextWidth(ctx, ctx.font, textContent[i].value);
                            textWidthCache[ctx.font + textContent[i].value] = contentWidth;
                        }
                        width += contentWidth;
                    }
                }
                return width;
            }
            // 创建填充文本
            function createInfillingText(ctx, infillingWidth, charactor, isVerticalText, lineHeight) {
                var count;
                if (isVerticalText) {
                    count = Math.floor(infillingWidth / lineHeight);
                } else {
                    count = Math.floor(infillingWidth / measureTextWidth(ctx, ctx.font, charactor));
                }
                return new Array(count + 1).join(charactor);
            }
            // 获取dom矩形
            function getDomRect(cellRect) {
                var retCellRect = cellRect.clone();
                retCellRect.width--;
                retCellRect.height--;
                return retCellRect;
            }
            // 按缩放因子缩放字体
            function scaleFontByZoomFactor(richText, defaultFont, zoomFactor, printZoomFactor) {
                for (var i = 0; i < richText.length; i++) {
                    var font = void 0;
                    richText[i].style = richText[i].style || {};
                    var style = richText[i].style;
                    if (style.font) {
                        font = stylehelper_1._StyleHelper._scaleFont(style.font, zoomFactor).font;
                    } else {
                        font = defaultFont;
                    }
                    if (!_isNullOrUndefined(printZoomFactor)) {
                        font = stylehelper_1._StyleHelper._scaleFont(font, printZoomFactor).font;
                    }
                    style.font = font;
                }
            }
            // 获取单旋转文本矩形
            function getSingleRotateTextRect(x, y, textWidth, textOrientationRadian, lineHeight) {
                var textAreaWidth = textWidth * Math_cos(-textOrientationRadian) + lineHeight * Math_sin(-textOrientationRadian);
                var textAreaHeight = textWidth * Math_cos(-textOrientationRadian) + lineHeight * Math_sin(-textOrientationRadian);
                var textAreaX = x - textAreaWidth / 2;
                var textAreaY = y - textAreaHeight / 2;
                return new common_1.Rect(textAreaX, textAreaY, textAreaWidth, textAreaHeight);
            }
        }),
        './dist/core/celltype/cellType.entry.js': (function (module, exports, __webpack_require__) {
            function __export(m) {
                for (var p in m)
                    if (!exports.hasOwnProperty(p))
                        exports[p] = m[p];
            }
            Object.defineProperty(exports, '__esModule', { value: true });
            __export(__webpack_require__(/*! ./celltype.ns */ './dist/core/celltype/celltype.ns.js'));
            __export(__webpack_require__(/*! ./basecelltype */ './dist/core/celltype/basecelltype.js'));
            __export(__webpack_require__(/*! ./textcelltype */ './dist/core/celltype/textcelltype.js'));
            __export(__webpack_require__(/*! ./headercelltype */ './dist/core/celltype/headercelltype.js'));
        }),
        './dist/core/celltype/celltype.ns.js': (function (module, exports, __webpack_require__) {
            Object.defineProperty(exports, '__esModule', { value: true });
            exports._typeDict = {};
        }),
        './dist/core/celltype/headercelltype.js': (function (module, exports, __webpack_require__) {
            var __extends = (this && this.__extends) || (function () {
                var extendStatics = function (d, b) {
                    extendStatics = Object.setPrototypeOf ||
                        ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
                        function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };
                    return extendStatics(d, b);
                };
                return function (d, b) {
                    extendStatics(d, b);
                    function __() { this.constructor = d; }
                    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
                };
            })();
            Object.defineProperty(exports, '__esModule', { value: true });

            var Common_1 = __webpack_require__(/*! Common */ 'Common');
            var domUtil_1 = __webpack_require__(/*! ../util/domUtil */ './dist/core/util/domUtil.js');
            var util_common = __webpack_require__(/*! ../util/common */ './dist/core/util/common.js');
            var stylehelper_1 = __webpack_require__(/*! ../worksheet/stylehelper */ './dist/core/worksheet/stylehelper.js');
            var celltype_ns_1 = __webpack_require__(/*! ./celltype.ns */ './dist/core/celltype/celltype.ns.js');
            var basecelltype_1 = __webpack_require__(/*! ./basecelltype */ './dist/core/celltype/basecelltype.js');
            var core_enum_1 = __webpack_require__(/*! ../core.enum */ './dist/core/core.enum.js');
            var _ThemeStyleHelper = util_common._ThemeStyleHelper;
            var _WordWrapHelper = util_common._WordWrapHelper;
            var getLinearGradientColors = util_common._util._getLinearGradientColors;
            var _isCJKText = util_common._util._isCJKText;
            var setContextFont = util_common._util._setContextFont;
            var isNullOrUndefined = Common_1.Common._Types._isNullOrUndefined;
            var convertRichTextValue = util_common._util._convertRichTextValue;
            var cloneObject = domUtil_1.GC$.extend;
            var cssNone = 'none', keyword_undefined = void 0, Math_floor = Math.floor;
            var Rect = util_common.Rect;

            // 获取绘画主题样式
            function getThemeStyleForPaint(visualState, headerTypeString) {
                visualState = visualState || 0;
                return _ThemeStyleHelper._getVisualStateThemeStyle(visualState, 'gc-' + headerTypeString + '-' + _ThemeStyleHelper._getString(visualState));
            }
            // 标头单元格类型_绘制背景图
            function headerCellType_paintCSSBackgroundImage(ctx, x, y, w, h, backgroundImg) {
                var img = new Image();
                var src = backgroundImg;
                src = src.replace('url("', '');
                src = src.replace('")', '');
                img.src = src;
                ctx.drawImage(img, x, y, w, h);
            }
            // 标头单元格类型_绘制背景
            function headerCellType_paintBackground(ctx, x, y, w, h, style, options, visualState, themeStyle) {
                function fillFunc() {
                    ctx.fillRect(x + 1, y + 1, w - 1, h - 1);
                }
                if (!isNullOrUndefined(visualState)) {
                    ctx.save();
                    ctx.beginPath();
                    var backColor = style.backColor;
                    if (visualState === 0 && backColor) {
                        stylehelper_1._StyleHelper.setFillStyle(ctx, backColor, x, y, w, h, fillFunc);
                    } else {
                        try {
                            backColor = themeStyle && themeStyle.backgroundColor;
                            var backgroundImg = themeStyle && themeStyle.backgroundImage;
                            var sheet = options.sheet;
                            var row = options.row;
                            var col = options.col;
                            var sheetArea = options.sheetArea;
                            var cellStatesStyle = void 0;
                            var useCellStateColor = false;
                            if (sheet.cellStates && visualState === core_enum_1.VisualState.hover) {
                                cellStatesStyle = sheet.cellStates.getStyle(row, col, sheetArea);
                                if (cellStatesStyle && cellStatesStyle.backColor) {
                                    backColor = cellStatesStyle.backColor;
                                    useCellStateColor = true;
                                }
                            }
                            if (!useCellStateColor && backgroundImg && backgroundImg.indexOf('linear-gradient') !== -1) {
                                var colors = getLinearGradientColors(backgroundImg);
                                var gradientColor = { degree: 90, stops: [] };
                                for (var i = 0, len = colors.length; i < len; i++) {
                                    var color = colors[i];
                                    gradientColor.stops.push({ position: color.point, color: color.color });
                                }
                                stylehelper_1._StyleHelper.setFillStyle_Gradient(ctx, gradientColor, x, y, w, h, fillFunc);
                            } else if (backColor) {
                                ctx.fillStyle = backColor;
                                fillFunc();
                            } else if (backgroundImg && backgroundImg !== cssNone) {
                                headerCellType_paintCSSBackgroundImage(ctx, x + 1, y + 1, w - 1, h - 1, backgroundImg);
                            }
                        } catch (ex) { }
                    }
                    basecelltype_1.Context._paintBackgroundImage(ctx, x, y, w, h, style.backgroundImage, style.backgroundImageLayout, options.imageLoader);
                    ctx.restore();
                }
            }
            // 标头单元格类型_绘制
            function headerCellType_paint(cellType, ctx, value, x, y, w, h, style, options, headerTypeString, sheetArea, tableFilter) {
                if (ctx) {
                    var visualState = options.visualState || 0;
                    var themeStyle = getThemeStyleForPaint(visualState, headerTypeString);
                    headerCellType_paintBackground(ctx, x, y, w, h, style, options, visualState, themeStyle);
                    basecelltype_1.Context._paintHeaderCellGridline(ctx, x, y, w, h, style, headerTypeString, themeStyle, sheetArea, options.needTopGridline, options.needLeftGridline);
                    var rect = new util_common.Rect(x, y, w, h);
                    cellType._callBeforePaintLabelHandler(ctx, options, rect, value, style);
                    if (cellType._paintLabel) {
                        cellType._paintLabel(ctx, rect, style, options);
                        var printZoomFactor = options.printZoomFactor;
                        var zoomFactor = (options.isPrinting && typeof printZoomFactor === 'number' && printZoomFactor !== 1) ? printZoomFactor : options.sheet.zoom();
                        rect = cellType._getContentRect(rect, style, zoomFactor);
                    }
                    if (rect.width > 0 && rect.height > 0) {
                        cellType.paintContent(ctx, value, rect.x, rect.y, rect.width, rect.height, style, options, tableFilter);
                    }
                }
            }
            // 按视觉状态获取字体
            function getFontByVisualStatus(getThemeStyleFunc, font, fillStyle, options, sheetArea, themeStyle) {
                var fontInfo = {
                    font: font,
                    fillStyle: fillStyle
                };
                var sheet = options.sheet;
                if (options.visualState !== 0 && parseInt(themeStyle.zIndex, 10) > 2007
                    && sheet._isSelected(options.row, options.col, sheetArea)) {
                    var hlThemeStyle = void 0;
                    if (sheet._isAllSelected(options.row, options.col, sheetArea)) {
                        hlThemeStyle = getThemeStyleFunc(options.visualState, 'gc-columnHeader-selected');
                    } else {
                        hlThemeStyle = getThemeStyleFunc(options.visualState, 'gc-columnHeader-highlight');
                    }
                    fontInfo.fillStyle = hlThemeStyle.color;
                    fontInfo.font = stylehelper_1._StyleHelper._setStringFont(fontInfo.font);
                }
                return fontInfo;
            }
            // 标头单元格类型_绘制文本
            function headerCellType_paintText(cellType, ctx, value, x, y, w, h, style, options, sheetArea, themeStyle, tableFilter) {
                var formattedData = {};
                var text = cellType.format(convertRichTextValue(value), style.formatter, formattedData);
                var sheet = options.sheet;
                if (text) {
                    ctx.save();
                    ctx.beginPath();
                    var rowFilter = sheet.rowFilter && sheet.rowFilter();
                    var hasFilterHeader = !!(rowFilter && rowFilter._isFilterHeader(options.row, options.col, sheetArea) && rowFilter.filterButtonVisible(options.col));
                    if (hasFilterHeader || tableFilter) {
                        w -= sheet._getFilterButtonRect(new util_common.Rect(x, y, w, h), sheetArea).width;
                    }
                    var fillStyle = style.foreColor;
                    if (!fillStyle) {
                        fillStyle = themeStyle.color;
                    }
                    if (fillStyle && ctx.fillStyle !== fillStyle) {
                        ctx.fillStyle = fillStyle;
                    }
                    if ((value && value.richText && value.richText.length > 0)
                        || style.isVerticalText) {
                        headerCellType_paintRichTextOrVerticalText(cellType, sheet, ctx, value, x, y, w, h, style, text, formattedData, options, sheetArea, themeStyle);
                    } else {
                        headerCellType_paintHorizontalText(cellType, ctx, value, x, y, w, h, style, text, formattedData, options, sheetArea, themeStyle);
                    }
                    ctx.restore();
                }
            }
            // 标头单元格类型_绘制富文本或垂直文本
            function headerCellType_paintRichTextOrVerticalText(cellType, sheet, ctx, value, x, y, w, h, style, text, formattedData, options, sheetArea, themeStyle) {
                var clipRect = new Rect(x, y, w, h);
                var defaultFont = getFontByVisualStatus(cellType.getThemeStyle, style.font || ctx.font, ctx.fillStyle, options, sheetArea, themeStyle);
                var isVerticalText = style.isVerticalText;
                var hAlign = style.hAlign;
                var indent = getIndent(style);
                var isRichTextAvailable = cellType._isRichTextAvailable(style.formatter || style._autoFormatter, value.text);
                var richText = cloneObject(true, [], cellType._getRichTextValue(value, text, isRichTextAvailable, defaultFont.font, defaultFont.fillStyle));
                if (value && value.richText && value.richText.length > 0) {
                    var zoomFactor = options.sheet ? options.sheet.zoom() : 1;
                    var printZoomFactor = options.printZoomFactor;
                    printZoomFactor = (options.isPrinting && typeof printZoomFactor === 'number' && printZoomFactor !== 1) ? printZoomFactor : keyword_undefined;
                    cellType._scaleFontByZoomFactor(richText, defaultFont, zoomFactor, printZoomFactor);
                }
                var beforePaintTextArgs = cellType._callBeforePaintTextHandler(ctx, convertRichTextValue(value), style, options, x, y, w, h);
                var leftExternalElementsWidth = cellType._getHorizontalAlignExternalElementsWidth(beforePaintTextArgs.externals.left);
                var rightExternalElementsWidth = cellType._getHorizontalAlignExternalElementsWidth(beforePaintTextArgs.externals.right);
                var horizontalExternalElementsWidth = leftExternalElementsWidth + rightExternalElementsWidth;
                var externalElementsSize = {
                    left: leftExternalElementsWidth,
                    right: rightExternalElementsWidth
                };
                if (!style.wordWrap && style.shrinkToFit) {
                    cellType._scaleFontByShrinkToFit(richText, w - horizontalExternalElementsWidth, h, style, defaultFont, 1, isVerticalText);
                }
                var data = cellType._processDataByWordWrap(ctx, text, style.font, isVerticalText ? h : w - horizontalExternalElementsWidth, indent, isVerticalText ? style.vAlign : style.hAlign, style.wordWrap, isVerticalText, richText);
                var linesStyle = cellType._getLinesStyle(data, style, hAlign);
                clipRectangle(ctx, style, x, y, w, h, indent, data[0].textLength, linesStyle[0].lineHeight);
                var isCJKText = isVerticalText ? _isCJKText(text) : keyword_undefined;
                var textShowEllipsis = false;
                if (!style.wordWrap && !style.shrinkToFit && style.showEllipsis && isVerticalText && !value.richText) {
                    textShowEllipsis = true;
                }
                var paintPositions = cellType._calcPaintPositions(clipRect.x, clipRect.y, clipRect.width, clipRect.height, hAlign, style.vAlign, indent, isVerticalText, isCJKText, data, linesStyle, externalElementsSize, textShowEllipsis);
                var ellipsis = [];
                if (textShowEllipsis && formattedData && ((formattedData.content && formattedData.content.length === 1 && formattedData.content[0].type === 'text') || (!formattedData.content && data.length === 1 && data[0].text))) {
                    cellType._calculateVerticalEllipsisText(ctx, options, data, linesStyle, style, h, y, indent, paintPositions, ellipsis);
                }
                var count = data.length;
                if (count === 1 && formattedData.content && !isRichTextAvailable) {
                    cellType._paintFormattedData(ctx, sheet, text, formattedData, paintPositions[0].x, paintPositions[0].y, w, h, hAlign, style, clipRect.width, clipRect.height, indent, isVerticalText, data[0].textLength, options, externalElementsSize, clipRect);
                } else {
                    for (var i = 0; i < count; i++) {
                        var textWidth = cellType._getTextWidthOfRichText(data);
                        var textAreaStartX = paintPositions[0].x;
                        if (ctx.textAlign === 'center') {
                            textAreaStartX -= textWidth / 2;
                        } else if (ctx.textAlign === 'right') {
                            textAreaStartX -= textWidth;
                        }
                        cellType._callBeforeFillTextAreaHandler(ctx, style, options, textAreaStartX, paintPositions[0].y, textWidth, 0, clipRect);
                        cellType._paintEntireLineOfText(ctx, sheet, paintPositions[i].x, paintPositions[i].y, linesStyle[i], hAlign, data[i], ellipsis[i]);
                        cellType._callBeforeFillTextAreaHandler(ctx, style, options, textAreaStartX, paintPositions[0].x, textWidth, 0, clipRect);
                    }
                }
            }
            // 标头单元格类型_绘制水平文本
            function headerCellType_paintHorizontalText(cellType, ctx, value, x, y, w, h, style, text, formattedData, options, sheetArea, themeStyle) {
                var clipRect = new Rect(x, y, w, h);
                var fontInfo = getFontByVisualStatus(cellType.getThemeStyle, style.font || ctx.font, ctx.fillStyle, options, sheetArea, themeStyle);
                setContextFont(ctx, fontInfo.font);
                ctx.fillStyle = fontInfo.fillStyle;
                var indent = 0, textIndent = style.textIndent;
                if (textIndent > 0) {
                    indent = textIndent * 8;
                }
                var fontSize = parseInt(options.fontInfo.fontSize, 10);
                var hAlign = style.hAlign, vAlign = style.vAlign;
                var textAlign = 'left', adjX = 2;
                var beforePaintTextArgs = cellType._callBeforePaintTextHandler(ctx, text, style, options, x, y, w, h);
                var leftExternalElementsWidth = cellType._getHorizontalAlignExternalElementsWidth(beforePaintTextArgs.externals.left), rightExternalElementsWidth = cellType._getHorizontalAlignExternalElementsWidth(beforePaintTextArgs.externals.right);
                var horizontalExternalElementsWidth = leftExternalElementsWidth + rightExternalElementsWidth;
                var externalElementsSize = {
                    left: leftExternalElementsWidth,
                    right: rightExternalElementsWidth,
                };
                adjX += (indent + leftExternalElementsWidth);
                if (hAlign === 1) {
                    adjX = (w + leftExternalElementsWidth - rightExternalElementsWidth) / 2;
                    textAlign = 'center';
                } else if (hAlign === 2) {
                    adjX = w - rightExternalElementsWidth - 1;
                    adjX -= indent;
                    textAlign = 'right';
                }
                if (ctx.textAlign !== textAlign) {
                    ctx.textAlign = textAlign;
                }
                var textHeight = 0;
                var textBaseline = 'alphabetic';
                var adjY = 2;
                var wordWrap = style.wordWrap;
                var shrinkToFit = style.shrinkToFit;
                var font = style.font;
                var lineHeight = options.lineHeight;
                var lines = [];
                var lineCount = 0;
                if (!wordWrap && shrinkToFit) {
                    var space = 0;
                    var minFont = {
                        value: false
                    };
                    for (var i = 0; i < 3 && minFont.value === false; i++) {
                        var textLength = ctx.measureText(text).width;
                        space = Math.max(0, w - 4 - (hAlign === 1 ? 0 : indent));
                        if (space < textLength) {
                            font = stylehelper_1._StyleHelper._scaleFont(font, space / textLength, minFont, true).font;
                            setContextFont(ctx, font);
                        } else {
                            break;
                        }
                    }
                }
                var wordWrapWidth = 0;
                if (wordWrap) {
                    wordWrapWidth = w - horizontalExternalElementsWidth - 3 - indent;
                    wordWrapWidth -= 1;
                    lines = _WordWrapHelper._getWrapInfo(text, wordWrapWidth, fontInfo.font);
                    lineCount = lines.length;
                    if (lineCount > 1 && vAlign !== 0) {
                        textHeight = (lineCount - 1) * lineHeight;
                    }
                }
                var baselineOffset = fontSize > 8 ? Math_floor((fontSize - 8) / 5 + 2) : 1;
                var lineOffset = lineHeight / 2 - fontSize / 2 + baselineOffset - 1;
                if (!wordWrap && style.showEllipsis) {
                    cellType._calculateHorizontalEllipsisText(options, formattedData, text, ctx, w, hAlign, indent);
                }
                adjY += lineHeight - lineOffset;
                if (vAlign === 1) {
                    adjY = (h - textHeight) / 2 + lineHeight / 2 - lineOffset;
                } else if (vAlign === 2) {
                    adjY = h - textHeight - 2 - lineOffset;
                }
                if (ctx.textBaseline !== textBaseline) {
                    ctx.textBaseline = textBaseline;
                }
                var textDecoration = style.textDecoration;
                var clipX = clipRect.x;
                var clipY = clipRect.y;
                var clipWidth = clipRect.width;
                var clipHeight = clipRect.height;
                if (style.wordWrap) {
                    ctx.rect(clipX, clipY, clipWidth, clipHeight);
                    ctx.clip();
                    ctx.beginPath();
                    var vpos = y + adjY;
                    if (lineCount > 1) {
                        cellType._callBeforeFillTextAreaHandler(ctx, style, options, x + adjX, vpos, wordWrapWidth, lineHeight * lineCount, clipRect);
                        for (var i = 0; i < lineCount; i++) {
                            ctx.fillText(lines[i], x + adjX, vpos);
                            if (textDecoration) {
                                var textLength = ctx.measureText(lines[i]).width;
                                cellType._renderTextDecoration(ctx, textDecoration, x + adjX, vpos, textLength, fontSize, baselineOffset);
                            }
                            vpos += lineHeight;
                        }
                        cellType._callBeforeFillTextAreaHandler(ctx, style, options, x + adjX, vpos, wordWrapWidth, lineHeight * lineCount, clipRect);
                    } else {
                        cellType._renderCellTextNormal(ctx, text, formattedData, x + adjX, y + adjY, hAlign, clipWidth, indent, textDecoration, baselineOffset, fontSize, options, style, externalElementsSize, clipRect);
                    }
                } else {
                    var txtWidth = ctx.measureText(text).width;
                    if (txtWidth > clipWidth || lineHeight > clipHeight) {
                        ctx.rect(clipX, clipY, clipWidth, clipHeight);
                        ctx.clip();
                        ctx.beginPath();
                    }
                    cellType._renderCellTextNormal(ctx, text, formattedData, x + adjX, y + adjY, hAlign, clipWidth, indent, textDecoration, baselineOffset, fontSize, options, style, externalElementsSize, clipRect, undefined, undefined, style.showEllipsis);
                }
            }
            // 裁剪矩形
            function clipRectangle(ctx, style, clipX, clipY, clipWidth, clipHeight, indent, txtLength, lineHeight) {
                var needClip = false;
                if (style.wordWrap) {
                    needClip = true;
                } else if (style.isVerticalText) {
                    needClip = txtLength + indent > clipHeight || lineHeight > clipWidth;
                } else {
                    needClip = txtLength + indent > clipWidth || lineHeight > clipHeight;
                }
                if (needClip) {
                    ctx.rect(clipX, clipY, clipWidth, clipHeight);
                    ctx.clip();
                    ctx.beginPath();
                }
            }
            // 获取缩进
            function getIndent(style) {
                var indent = 0;
                var textIndent = style.textIndent;
                if (textIndent > 0) {
                    indent = textIndent * 8;
                }
                return indent;
            }
            // 列标题单元格类型
            var ColumnHeaderCellType = (function (_super) {
                __extends(ColumnHeaderCellType, _super);
                function ColumnHeaderCellType() {
                    var _this = _super.call(this) || this;
                    _this.typeName = 2 + '';
                    return _this;
                }
                // 绘制
                ColumnHeaderCellType.prototype.paint = function (ctx, value, x, y, w, h, style, context, tableFilter) {
                    headerCellType_paint(this, ctx, value, x, y, w, h, style, context, 'columnHeader', 1, tableFilter);
                };
                // 绘制上下文
                ColumnHeaderCellType.prototype.paintContent = function (ctx, value, x, y, w, h, style, context, tableFilter) {
                    var showSparklineEx = basecelltype_1.Context._paintSparklineEx(ctx, convertRichTextValue(value), x, y, w, h, context);
                    if (!showSparklineEx) {
                        var themeStyle = getThemeStyleForPaint(context.visualState, 'columnHeader');
                        headerCellType_paintText(this, ctx, value, x, y, w, h, style, context, 1, themeStyle, tableFilter);
                    }
                };
                return ColumnHeaderCellType;
            }(basecelltype_1.Base));
            exports.ColumnHeader = ColumnHeaderCellType;
            celltype_ns_1._typeDict[2] = ColumnHeaderCellType;

            // 行标题单元格类型
            var RowHeaderCellType = (function (_super) {
                __extends(RowHeaderCellType, _super);
                function RowHeaderCellType() {
                    var _this = _super.call(this) || this;
                    _this.typeName = 3 + '';
                    return _this;
                }
                // 绘制
                RowHeaderCellType.prototype.paint = function (ctx, value, x, y, w, h, style, context) {
                    headerCellType_paint(this, ctx, value, x, y, w, h, style, context, 'rowHeader', 2);
                };
                // 绘制上下文
                RowHeaderCellType.prototype.paintContent = function (ctx, value, x, y, w, h, style, context) {
                    var showSparklineEx = basecelltype_1.Context._paintSparklineEx(ctx, convertRichTextValue(value), x, y, w, h, context);
                    if (!showSparklineEx) {
                        var themeStyle = getThemeStyleForPaint(context.visualState, 'rowHeader');
                        headerCellType_paintText(this, ctx, value, x, y, w, h, style, context, 2, themeStyle);
                    }
                };
                return RowHeaderCellType;
            }(basecelltype_1.Base));
            exports.RowHeader = RowHeaderCellType;
            celltype_ns_1._typeDict[3] = RowHeaderCellType;

            // 拐角单元格类型（左上角那个）
            var CornerCellType = (function (_super) {
                __extends(CornerCellType, _super);
                function CornerCellType() {
                    var _this = _super.call(this) || this;
                    _this.typeName = 4 + '';
                    return _this;
                }
                // 绘制
                CornerCellType.prototype.paint = function (ctx, value, x, y, w, h, style, context) {
                    if (!ctx) {
                        return;
                    }
                    ctx.save();
                    ctx.rect(x, y, w, h);
                    ctx.clip();
                    ctx.beginPath();
                    var self = this;
                    var visualState = context.visualState || 0;
                    try {
                        var tmpStyle = self.getThemeStyle(context.visualState, 'gc-corner-' + _ThemeStyleHelper._getString(visualState));
                        var backColor = (tmpStyle && tmpStyle.backgroundColor);
                        var backImg = (tmpStyle && tmpStyle.backgroundImage);
                        if (backColor) {
                            ctx.fillStyle = backColor;
                            ctx.fillRect(x, y, w, h);
                        } else if (backImg && backImg !== cssNone) {
                            headerCellType_paintCSSBackgroundImage(ctx, x, y, w, h, backImg);
                        }
                    } catch (ex) { }
                    var hoverStyle = self.getThemeStyle(4, 'gc-corner-triangle-' + _ThemeStyleHelper._getString(visualState));
                    var backgroundImg = hoverStyle && hoverStyle.backgroundImage;
                    var backgroundColor = hoverStyle && hoverStyle.backgroundColor;
                    var gradient = ctx.createLinearGradient(x + w / 2, y, x + w / 2, y + h);
                    if (backgroundImg && backgroundImg.indexOf('linear-gradient') !== -1) {
                        var colors = getLinearGradientColors(backgroundImg);
                        for (var i = 0, len = colors.length; i < len; i++) {
                            var color = colors[i];
                            gradient.addColorStop(color.point, color.color);
                        }
                        ctx.fillStyle = gradient;
                    } else if (backgroundColor) {
                        gradient.addColorStop(0.125, '#f6fafb');
                        gradient.addColorStop(1.0, backgroundColor);
                        ctx.fillStyle = gradient;
                    }
                    var rightStrokeStyle = ctx.createLinearGradient(x + w, y + 1, x + w, y + h - 2);
                    rightStrokeStyle.addColorStop(0, hoverStyle.borderLeftColor);
                    rightStrokeStyle.addColorStop(1, hoverStyle.borderRightColor);
                    ctx.beginPath();
                    ctx.strokeStyle = rightStrokeStyle;
                    ctx.moveTo(x + w - 0.5, y);
                    ctx.lineTo(x + w - 0.5, y + h);
                    ctx.stroke();
                    if (context.needLeftGridline) {
                        ctx.beginPath();
                        ctx.strokeStyle = hoverStyle.borderLeftColor;
                        ctx.moveTo(x + 0.5, y);
                        ctx.lineTo(x + 0.5, y + h);
                        ctx.stroke();
                    }
                    var bottomStrokeStyle = ctx.createLinearGradient(x, y, x + w - 2, y);
                    bottomStrokeStyle.addColorStop(0, hoverStyle.borderTopColor);
                    bottomStrokeStyle.addColorStop(1, hoverStyle.borderBottomColor);
                    ctx.beginPath();
                    ctx.strokeStyle = bottomStrokeStyle;
                    ctx.moveTo(x, y + h - 0.5);
                    ctx.lineTo(x + w, y + h - 0.5);
                    ctx.stroke();
                    if (context.needTopGridline) {
                        ctx.beginPath();
                        ctx.strokeStyle = hoverStyle.borderTopColor;
                        ctx.moveTo(x, y + 0.5);
                        ctx.lineTo(x + w, y + 0.5);
                        ctx.stroke();
                    }
                    ctx.beginPath();
                    var padding = 3;
                    var sizeWidth = 8;
                    var sizeHeight = 6;
                    ctx.moveTo(x + w - sizeWidth - padding, y + h - padding);
                    ctx.lineTo(x + w - padding, y + h - padding);
                    ctx.lineTo(x + w - padding, y + h - sizeHeight - padding);
                    ctx.fill();
                    ctx.restore();
                };
                return CornerCellType;
            }(basecelltype_1.Base));
            exports.Corner = CornerCellType;
            celltype_ns_1._typeDict[4] = CornerCellType;
        }),
        './dist/core/celltype/textcelltype.js': (function (module, exports, __webpack_require__) {
            var __extends = (this && this.__extends) || (function () {
                var extendStatics = function (d, b) {
                    extendStatics = Object.setPrototypeOf ||
                        ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
                        function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };
                    return extendStatics(d, b);
                };
                return function (d, b) {
                    extendStatics(d, b);
                    function __() { this.constructor = d; }
                    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
                };
            })();
            Object.defineProperty(exports, '__esModule', { value: true });
            var Common_1 = __webpack_require__(/*! Common */ 'Common');
            var worksheet_1 = __webpack_require__(/*! ../worksheet/worksheet */ './dist/core/worksheet/worksheet.js');
            var domUtil_1 = __webpack_require__(/*! ../util/domUtil */ './dist/core/util/domUtil.js');
            var util_common = __webpack_require__(/*! ../util/common */ './dist/core/util/common.js');
            var celltype_ns_1 = __webpack_require__(/*! ./celltype.ns */ './dist/core/celltype/celltype.ns.js');
            var basecelltype_1 = __webpack_require__(/*! ./basecelltype */ './dist/core/celltype/basecelltype.js');
            var core_enum_1 = __webpack_require__(/*! ../core.enum */ './dist/core/core.enum.js');
            var common_1 = __webpack_require__(/*! ../util/common */ './dist/core/util/common.js');
            var isNullOrUndefined = Common_1.Common._Types._isNullOrUndefined;
            var _WordWrapHelper = util_common._WordWrapHelper;
            var Events_EditChange = util_common.Events.EditChange;
            var _FocusHelper = util_common._FocusHelper;
            var util_common_util = util_common._util;
            var _EditorDomHelper = util_common._EditorDomHelper;
            var isformatString = util_common_util._isFormatString;
            var createElement = util_common_util._createElement;
            var browser = util_common_util._browser;
            var browser_msie = browser.msie;
            var browser_edge = browser.edge;
            var browser_chrome = browser.chrome;
            var cancelDefault = util_common_util._cancelDefault;
            var getHAlignByValueType = util_common_util._getHAlignByValueType;
            var formatValue2Text = util_common_util._formatValue2Text;
            var getPreferredZIndex = util_common_util._getPreferredZIndex;
            var util_device = util_common_util._device();
            var getFontHeight = util_common_util._getFontHeight;
            var getTextHeight = util_common_util._getTextHeight;
            var measureTextWidth = util_common_util._measureTextWidth;
            var replaceSpaceChar = util_common_util._replaceSpaceChar;
            var adjustFontWithFallback = util_common_util._adjustFontWithFallback;
            var convertRichTextValue = util_common_util._convertRichTextValue;
            var isNeedUseSymbolFormDataType = util_common_util._isNeedUseSymbolFormDataType;
            var cssLeft = 'left';
            var cssRight = 'right';
            var cssCenter = 'center';
            var cssTop = 'top';
            var attrGcUIElement = 'gcUIElement';
            var cssNone = 'none';
            var _gcEditingInput = '.gcEditingInput';
            var cssWidth = 'width';
            var cssHeight = 'height';
            var cssTextAlign = 'text-align';
            var cssHidden = 'hidden';
            var cssWordWrap = 'word-wrap';
            var cssOverflow = 'overflow';
            var cssVerticalAlign = 'vertical-align';
            var cssNormal = 'normal';
            var cssBreakWord = 'break-word';
            var cssOverflowY = 'overflow-y';
            var cssScroll = 'scroll';
            var cssWordBreak = 'word-break';
            var cssFloat = 'float';
            var WINDOW = window;
            var DOCUMENT = document;
            var IS_IPAD = util_device.ipad;
            var IS_MOBILE_DEVICE = util_device.iphone || IS_IPAD || util_device.android;
            var keyword_null = null;
            var keyword_undefined = void 0;
            var Math_ceil = Math.ceil;
            var Math_min = Math.min;
            var Math_sin = Math.sin;
            var Math_cos = Math.cos;
            var Math_abs = Math.abs;
            var Math_max = Math.max;
            var parseIntFunc = parseInt;
            var NBSP_SPACE_CHAR = '\u00a0';
            var ZERO_WIDTH_CHAR = '\u200b';
            var const_string = 'string';
            var const_number = 'number';
            // 编辑器类型是否文本区域
            function isTextareaAsEditor(editorType) {
                return IS_MOBILE_DEVICE || editorType === 0;
            }
            // 获取dom元素
            function getDOMElement(editorType) {
                return isTextareaAsEditor(editorType) ? domUtil_1.GC$(createElement('textarea')) : domUtil_1.GC$(createElement('div'));
            }
            // 是否是可编辑的div元素
            function isEditableDIVElement(element) {
                return element && element.tagName === 'DIV' && element.contentEditable === 'true';
            }
            // 获取编辑器上下文
            function getEditorContent(editor) {
                if (isEditableDIVElement(editor)) {
                    if (browser_msie && parseFloat(browser.version) < 10) {
                        return util_common_util._getEditableDivValue(editor);
                    }
                    return editor.innerText;
                }
                return editor.value;
            }
            // 设置编辑器上下文
            function setEditorContent(editor, value) {
                if (isEditableDIVElement(editor)) {
                    editor.innerText = isNullOrUndefined(value) ? '' : value;
                } else {
                    editor.value = value;
                }
            }
            // 将光标移到末尾
            function moveCaretToEnd(editor) {
                if (isEditableDIVElement(editor)) {
                    var selection = WINDOW.getSelection();
                    selection.selectAllChildren(editor);
                    if (selection.rangeCount > 0) {
                        selection.collapseToEnd();
                    }
                } else {
                    editor.selectionStart = editor.selectionEnd = editor.value.length;
                }
            }
            // 获取光标初始位置
            function getCaretStartPosition(editor) {
                if (isEditableDIVElement(editor)) {
                    var selection = WINDOW.getSelection();
                    if (selection.rangeCount > 0) {
                        var range = selection.getRangeAt(0);
                        return range.startOffset;
                    }
                    return 0;
                }
                return editor.selectionStart;
            }
            // 获取光标结束位置
            function getCaretEndPosition(editor) {
                if (isEditableDIVElement(editor)) {
                    var selection = WINDOW.getSelection();
                    if (selection.rangeCount > 0) {
                        var range = selection.getRangeAt(0);
                        return range.endOffset;
                    }
                    return 0;
                }
                return editor.selectionEnd;
            }
            // 从KeyCode获取Ascii码
            function getAsciiCodeFromKeyCode(event) {
                var keyCode = event.keyCode;
                var shiftKey = event.shiftKey;
                var keyMap = {
                    106: 42,
                    107: 43,
                    109: 45,
                    110: 46,
                    111: 47,
                    173: 45
                };
                var generalKeyMap = {
                    186: 59,
                    187: 61,
                    188: 44,
                    189: 45,
                    190: 46,
                    191: 47,
                    192: 96,
                    219: 91,
                    220: 92,
                    221: 93,
                    222: 39
                };
                var shiftKeyMap = {
                    186: 58,
                    187: 43,
                    188: 60,
                    189: 95,
                    190: 62,
                    191: 63,
                    192: 126,
                    219: 123,
                    220: 124,
                    221: 125,
                    222: 34
                };
                var retCode = keyCode;
                if (keyCode >= 96 && keyCode <= 105) {
                    retCode = keyCode - 48;
                } else if (keyMap[keyCode]) {
                    retCode = keyMap[keyCode];
                } else if (shiftKey && shiftKeyMap[keyCode]) {
                    retCode = shiftKeyMap[keyCode];
                } else if (!shiftKey && generalKeyMap[keyCode]) {
                    retCode = generalKeyMap[keyCode];
                } else if (!shiftKey && keyCode >= 65 && keyCode <= 90) {
                    retCode = keyCode + 32;
                }
                return retCode;
            }
            // 是否br元素
            function isBrElement(element) {
                return element && element.tagName === 'BR';
            }
            // 是否span元素
            function isSpanElement(element) {
                return element && element.tagName === 'SPAN';
            }
            // 是否div元素
            function isDivElement(element) {
                return element && element.tagName === 'DIV';
            }
            // 是否文本节点
            function isTextNode(element) {
                return element instanceof Text;
            }
            // 是否零宽度字符
            function isZeroWidthChar(letter) {
                return letter === ZERO_WIDTH_CHAR;
            }
            // 获取光标选择输入值
            function getCaretSelectionInputtingValue(value, start, end, letter) {
                var preValue = value.substr(0, start);
                var endValue = value.substr(end, value.length - end);
                return preValue + letter + endValue;
            }
            // 获取元素内部文本
            function getElementInnerText(element, range, start, end, letter, isNodeInSelection) {
                var content = '';
                var childNodes = element.childNodes;
                var length = childNodes.length;
                for (var i = 0; i < length; i++) {
                    var item = childNodes[i];
                    if (isSpanElement(item)) {
                        content += getElementInnerText(item, range, start, end, letter, isNodeInSelection);
                    } else if (isTextNode(item)) {
                        var startContainer = range && range.startContainer;
                        var endContainer = range && range.endContainer;
                        var tempContent = item.textContent;
                        if (item === startContainer || item === endContainer) {
                            if (startContainer !== endContainer) {
                                if (item === startContainer) {
                                    content += getCaretSelectionInputtingValue(tempContent, start, tempContent.length, letter);
                                    isNodeInSelection = true;
                                } else {
                                    content += getCaretSelectionInputtingValue(tempContent, 0, end, '');
                                    isNodeInSelection = false;
                                }
                            } else {
                                content += getCaretSelectionInputtingValue(tempContent, start, end, letter);
                            }
                        } else if (!isNodeInSelection) {
                            content += tempContent;
                        }
                    } else if (isBrElement(item) && !isNodeInSelection) {
                        content += '\n';
                    }
                }
                return content;
            }
            // 获取编辑器输入值
            function getEditorInputtingValue(editor, value, startCaretPos, endCaretPos, event) {
                var letter = String.fromCharCode(getAsciiCodeFromKeyCode(event));
                if (!isEditableDIVElement(editor)) {
                    return getCaretSelectionInputtingValue(value, startCaretPos, endCaretPos, letter);
                }
                var selection = WINDOW.getSelection(), range;
                if (selection.rangeCount > 0) {
                    range = selection.getRangeAt(0);
                    if (isTextNode(range.startContainer)) {
                        return getElementInnerText(editor, range, startCaretPos, endCaretPos, letter);
                    }
                }
                if (range && range.startOffset === range.endOffset) {
                    return value + letter;
                }
                return letter;
            }
            // 获取已处理的编辑器值
            function getProcessedEditorValue(text) {
                var editorValue = addZeroWidthCharToText(text);
                if (editorValue && editorValue.indexOf(' ') >= 0) {
                    editorValue = replaceSpaceChar(editorValue, ' ', NBSP_SPACE_CHAR);
                }
                return editorValue;
            }
            // 文本单元格类型_处理编辑器包装器
            function textCellType_processEditingWrap(event, context, isImeInputing, wrapperBounds, leftExternalBounds, rightExternalBounds) {
                var src = event.srcElement || event.target;
                if (src && src.getAttribute(attrGcUIElement) === 'gcEditingInput' && (event.keyCode === 13 && (event.ctrlKey || event.altKey))) {
                    var ae = _FocusHelper._getActiveElement();
                    if (ae instanceof worksheet_1.Worksheet) {
                        var ct = ae.getCellType(ae._activeRowIndex, ae._activeColIndex);
                        if (ct) {
                            if (isEditableDIVElement(src)) {
                                if (isImeInputing) {
                                    src.blur();
                                    src.focus();
                                }
                                var selection = WINDOW.getSelection();
                                if (selection.rangeCount > 0) {
                                    var range = selection.getRangeAt(0);
                                    var textNode = DOCUMENT.createElement('span');
                                    textNode.innerHTML = '<br/>' + ZERO_WIDTH_CHAR;
                                    range.insertNode(textNode);
                                    var newRange = DOCUMENT.createRange();
                                    newRange.setStartAfter(textNode);
                                    newRange.setEndAfter(textNode);
                                    newRange.collapse(false);
                                    selection.removeAllRanges();
                                    selection.addRange(newRange);
                                }
                            } else {
                                var index = src.selectionStart;
                                var value = src.value;
                                var preValue = value.substr(0, index);
                                var endValue = value.substr(index, value.length - index);
                                src.value = preValue + '\n' + endValue;
                                src.selectionStart = index + 1;
                                src.selectionEnd = index + 1;
                            }
                            ct._updateEditorByKeyDown(ae._editor, keyword_null, keyword_null, event, context, true);
                        }
                    }
                    cancelDefault(event);
                }
            }
            // 从文本中删除零宽度字符
            function removeZeroWidthCharFromText(text) {
                var retValue = text;
                if (!retValue) {
                    return retValue;
                }
                if (retValue.indexOf(ZERO_WIDTH_CHAR) < 0 && retValue.indexOf('\n') < 0) {
                    return retValue;
                }
                var valueArray = text.split('\n');
                valueArray.forEach(function (item, index, array) {
                    if (isZeroWidthChar(item[0])) {
                        array[index] = item.substr(1);
                    }
                });
                return valueArray.join('\n');
            }
            // 将零宽度字符添加到文本
            function addZeroWidthCharToText(text) {
                var retValue = text;
                if (!retValue) {
                    return retValue;
                }
                var length = retValue.length;
                if (length > 0 && retValue[length - 1] === '\n') {
                    retValue += ZERO_WIDTH_CHAR;
                }
                return retValue;
            }
            // 获取元素选择文本
            function getElementSelectionText(editor) {
                var selection = WINDOW.getSelection();
                var startFlag = false;
                var index = 0;
                var endPosition = 0;
                var content = '';
                if (selection.rangeCount > 0) {
                    var range = selection.getRangeAt(0);
                    var startCaretPos = getCaretStartPosition(editor);
                    var endCaretPos = getCaretEndPosition(editor);
                    var startRangeContainer = range.startContainer;
                    var endRangeContainer = range.endContainer;
                    if (isDivElement(startRangeContainer)) {
                        startFlag = true;
                        index = startCaretPos;
                    } else {
                        var nodes = startRangeContainer.childNodes;
                        var length_1 = nodes.length, startIndex = void 0;
                        if (length_1 > 0) {
                            for (startIndex = 0; startIndex < length_1; startIndex++) {
                                var node = nodes[startIndex];
                                if (!node.tagName || node.tagName.toLocaleLowerCase() !== 'br') {
                                    startRangeContainer = node;
                                    break;
                                } else {
                                    content += '\n';
                                }
                            }
                        }
                    }
                    if (isDivElement(endRangeContainer)) {
                        endPosition = endCaretPos;
                    }
                    var result = getElementSelectionInnerText(editor, startCaretPos, endCaretPos, startRangeContainer, endRangeContainer, startFlag, index, endPosition);
                    return content + result.content;
                }
            }
            // 获取元素选择内部文本
            function getElementSelectionInnerText(element, start, end, startContainer, endContainer, startFlag, index, endPosition) {
                if (startContainer === endContainer && !startFlag) {
                    return { content: removeZeroWidthCharFromText(startContainer.textContent.slice(start, end)) };
                }
                var content = '';
                var i = index;
                var tempContent;
                var endFlag;
                var childNodes = element.childNodes;
                var length = endPosition || childNodes.length;
                for (i; i < length; i++) {
                    var item = childNodes[i];
                    if (isSpanElement(item)) {
                        tempContent = getElementSelectionInnerText(item, start, end, startContainer, endContainer, startFlag, 0, 0);
                        content += tempContent.content;
                        if (tempContent.startFlag) {
                            startFlag = true;
                        }
                        if (tempContent.endFlag) {
                            endFlag = true;
                            break;
                        }
                    } else if (isTextNode(item) && item === startContainer) {
                        content += item.textContent.slice(start, item.textContent.length);
                        startFlag = true;
                    } else if (isTextNode(item) && item === endContainer) {
                        content += item.textContent.slice(0, end);
                        endFlag = true;
                        break;
                    } else if (startFlag) {
                        if (isBrElement(item)) {
                            content += '\n';
                        } else {
                            content += item.innerText || item.textContent;
                        }
                    }
                }
                return {
                    content: removeZeroWidthCharFromText(content),
                    startFlag: startFlag,
                    endFlag: endFlag
                };
            }
            // 获取行高度数组
            function getLineHeightArray(lines, font) {
                var length = lines.length, lineHeightArray = [];
                for (var i = 0; i < length; i++) {
                    lineHeightArray.push(getTextHeight(lines[i], font));
                }
                return lineHeightArray;
            }
            // 获取编辑器高度
            function getEditorHeight(lineHeightArray) {
                var length = lineHeightArray.length, totalHeight = 0;
                for (var i = 0; i < length; i++) {
                    totalHeight += lineHeightArray[i];
                }
                return totalHeight;
            }
            // 获取文本包裹高度
            function getTextWrapHeight(lineWidthArray, editorWidth, lineHeight, lineHeightArray) {
                var wrapHeight = 0, tempLineHeight = lineHeight;
                for (var i = 0; i < lineWidthArray.length; i++) {
                    if (browser_chrome) {
                        tempLineHeight = lineHeightArray[i];
                    }
                    if (lineWidthArray[i] > editorWidth) {
                        var rowCount = Math_ceil(lineWidthArray[i] / editorWidth);
                        wrapHeight += tempLineHeight * rowCount;
                    } else {
                        wrapHeight += tempLineHeight;
                    }
                }
                return wrapHeight;
            }
            // 是否公式编辑器
            function isFormulaEditor(editor, pasteValue, caretStartPosition) {
                var editorValue = getEditorContent(editor);
                return (editorValue && editorValue[0] === '=') || (editorValue === '' && pasteValue[0] === '=') ||
                    (caretStartPosition === 0 && pasteValue[0] === '=');
            }

            // 编辑器类型
            var EditorType;
            (function (EditorType) {
                EditorType[EditorType['textarea'] = 0] = 'textarea';
                EditorType[EditorType['editableDiv'] = 1] = 'editableDiv';
            })(EditorType = exports.EditorType || (exports.EditorType = {}));


            // 文本单元格类型
            var TextCellType = (function (_super) {
                __extends(TextCellType, _super);
                function TextCellType(editorType) {
                    var _this = _super.call(this) || this;
                    _this.allowOverflow = true;
                    _this.typeName = 1 + '';
                    _this.editorType = isNullOrUndefined(editorType) ? 1 : editorType;
                    return _this;
                }
                // 获取文本
                TextCellType.prototype.getText = function (value, context) {
                    return value;
                };
                // 绘制值
                TextCellType.prototype.paintValue = function (ctx, value, x, y, w, h, style, options) {
                    var self = this;
                    var sheet = options.sheet;
                    var zoom = sheet.zoom ? sheet.zoom() : 1;
                    value = self.getText(value, options);
                    var formattedData = {};
                    var text;
                    options.quotePrefix = style.quotePrefix;
                    var formatter = style.formatter;
                    var hasFormat = formatter && formatter !== 'General';
                    var _isFormatStr = isformatString(formatter);
                    if (typeof (formatter) === 'string') {
                        hasFormat = hasFormat && !_isFormatStr;
                    }
                    var textOrientation = style.textOrientation;
                    var textIndent = style.textIndent && style.textIndent !== 0;
                    var isVerticalText = style.isVerticalText;
                    var newW = w;
                    if (textOrientation && -90 <= textOrientation && textOrientation <= 90 && !textIndent && !isVerticalText) {
                        var abstextOrientationRadian = Math_abs(textOrientation * Math.PI / 180);
                        newW = (h - options.lineHeight * Math_cos(abstextOrientationRadian)) / Math_sin(abstextOrientationRadian);
                    }
                    var externals;
                    var beforePaintTextArgs = self._callBeforePaintTextHandler(ctx, text, style, options, x, y, w, h);
                    externals = beforePaintTextArgs.externals;
                    var leftExternalElementsWidth = self._getHorizontalAlignExternalElementsWidth(externals.left);
                    var rightExternalElementsWidth = self._getHorizontalAlignExternalElementsWidth(externals.right);
                    var hAlign = style.hAlign;
                    if (hAlign === 3) {
                        hAlign = getHAlignByValueType(hAlign, value, style.formatter);
                    }
                    if (hAlign === 2) {
                        newW -= rightExternalElementsWidth;
                    } else if (hAlign === 0) {
                        newW -= leftExternalElementsWidth;
                    }
                    var hasAutoFormat = style._autoFormatter && style._autoFormatter.formatCached && style._autoFormatter.formatCached !== 'General';
                    var format;
                    if (hasFormat) {
                        format = style.formatter;
                    } else if (hasAutoFormat) {
                        format = style._autoFormatter;
                    } else if (sheet.parent && sheet.parent.options.numbersFitMode === core_enum_1.NumbersFitMode.mask) {
                        format = basecelltype_1.Context._getFormatForNumberValue(ctx, value, newW, style, zoom);
                    } else if (sheet.parent && sheet.parent.options.numbersFitMode === core_enum_1.NumbersFitMode.overflow) {
                        format = style._autoFormatter;
                    }
                    if (_isFormatStr && (value instanceof Date || typeof value === 'boolean' || value instanceof Boolean || typeof value === 'number')) {
                        text = self.format(value, formatter, {});
                    } else {
                        text = self.format(convertRichTextValue(value), format, formattedData, options);
                    }
                    var rect = new common_1.Rect(x, y, w, h);
                    this.adjustRectForIconSet(style.hAlign, options.sheet, options.row, options.col, options.sheetArea, rect, (formattedData.content && this.hasInfilling(formattedData.content)));
                    x = rect.x;
                    w = rect.width;
                    if (style.shrinkToFit !== true && !isVerticalText) {
                        if (isNeedUseSymbolFormDataType(value)) {
                            if (sheet.parent) {
                                var tempText = text;
                                switch (sheet.parent.options.numbersFitMode) {
                                    case core_enum_1.NumbersFitMode.mask:
                                        tempText = this._mask(ctx, text, newW, style, zoom, options, formattedData, sheet);
                                        break;
                                    case core_enum_1.NumbersFitMode.overflow:
                                        tempText = this._overflow(ctx, options, value, style, sheet, text, formattedData);
                                        break;
                                }
                                text = tempText;
                            }
                        } else if (sheet._modelManager._getCellNodeTipContent(options.row, options.col, options.sheetArea) !== undefined && !style.showEllipsis) {
                            sheet._modelManager._setCellNodeTipContent(options.row, options.col, undefined, options.sheetArea);
                        }
                    }
                    var labelOptions = style.labelOptions;
                    var watermark = style.watermark;
                    var needPaintWatermark = !labelOptions || labelOptions.visibility !== 0;
                    if (watermark && !text && needPaintWatermark) {
                        self.paintText(ctx, watermark, x, y, w, h, style, options, watermark, formattedData, 0.337, { isWatermark: true });
                        return;
                    }
                    if (!text && (!formattedData.content || !formattedData.content.length)) {
                        return;
                    }
                    if (style.vAlign === 1 && browser_chrome) {
                        y--;
                    }
                    self.paintText(ctx, value, x, y, w, h, style, options, text, formattedData, keyword_undefined, externals);
                };
                // 指示将数据内容替换为“###”并显示提示。
                TextCellType.prototype._mask = function (ctx, text, newW, style, zoom, options, formattedData, sheet) {
                    var tempText = basecelltype_1.Context._changeTextToSymbol(ctx, text, newW, style, zoom);
                    var row = options.row;
                    var col = options.col;
                    if (text !== tempText) {
                        delete formattedData.content;
                        style.textIndent = 0;
                        sheet._modelManager._setCellNodeTipContent(row, col, sheet.getText(row, col, options.sheetArea), options.sheetArea);
                    } else {
                        sheet._modelManager._setCellNodeTipContent(row, col, undefined, options.sheetArea);
                    }
                    return tempText;
                };
                // 溢出
                TextCellType.prototype._overflow = function (ctx, options, value, style, sheet, text, formattedData) {
                    var row = options.row;
                    var col = options.col;
                    if (style.wordWrap) {
                        style.wordWrap = false;
                    }
                    var textWidth = measureTextWidth(ctx, style.font, text);
                    var colWidth = sheet._cachePool._getZoomColWidth(col);
                    var overflowLayout = options.cellOverflowLayout;
                    var tipContent = void 0;
                    if (!overflowLayout && colWidth < textWidth) {
                        tipContent = sheet.getText(row, col, options.sheetArea);
                    } else if (overflowLayout && colWidth < textWidth && this._notNullOrUndefined(overflowLayout.backgroundWidth) && this._notNullOrUndefined(overflowLayout.valueWidth)) {
                        if (!this._notNullOrUndefined(style.hAlign)) {
                            return;
                        }
                        var cellBeCut = void 0;
                        if (style.hAlign !== 1) {
                            cellBeCut = overflowLayout.valueWidth > overflowLayout.backgroundWidth;
                        } else {
                            cellBeCut = overflowLayout.valueWidth / 2 > overflowLayout.backgroundLeftWidth || overflowLayout.valueWidth / 2 > overflowLayout.backgroundRightWidth;
                        }
                        tipContent = cellBeCut ? sheet.getText(row, col, options.sheetArea) : void 0;
                    }
                    sheet._modelManager._setCellNodeTipContent(row, col, tipContent, options.sheetArea);
                    return text;
                };
                // 
                TextCellType.prototype._notNullOrUndefined = function (value) {
                    return value !== null && value !== undefined;
                };
                // 创建编辑器元素
                TextCellType.prototype.createEditorElement = function (context, cellWrapperElement) {
                    var host = context && context.sheet && context.sheet.parent && context.sheet.parent._host;
                    var zindex = getPreferredZIndex(host) + 1000;
                    domUtil_1.GC$(cellWrapperElement).css('z-index', zindex);
                    var editor = getDOMElement(this.editorType);
                    domUtil_1.GC$(editor)
                        .css({
                            'font': 'normal 11pt calibri',
                            'outline': cssNone,
                            'resize': cssNone,
                            'border': cssNone,
                            'padding': '1px',
                            'vertical-align': 'top',
                            'min-height': '0px',
                            'box-sizing': 'content-box',
                            'background': 'transparent'
                        })
                        .css(cssWordWrap, cssNormal)
                        .attr({
                            tabindex: -1,
                            autocomplete: 'off',
                            contenteditable: true,
                            'data-editorSource': 'TextCell'
                        })
                        .css(cssOverflow, cssHidden)
                        .attr(attrGcUIElement, 'gcEditingInput');
                    if (browser.safari) {
                        domUtil_1.GC$(editor).css('-webkit-user-select', 'auto');
                    }
                    var isDIVElement = isEditableDIVElement(domUtil_1.GC$(editor)[0]);
                    if (isDIVElement) {
                        domUtil_1.GC$(editor).css('display', 'table-cell');
                        domUtil_1.GC$(editor).css(cssWordBreak, cssNormal);
                    }
                    return domUtil_1.GC$(editor)[0];
                };
                // 获取编辑器值
                TextCellType.prototype.getEditorValue = function (editorContext, context) {
                    if (editorContext) {
                        var v = getEditorContent(editorContext);
                        if (isNullOrUndefined(v) || v.length === 0)
                            return keyword_null;
                        v = v.replace(/\u200b/mg, '');
                        if (v.length) {
                            var retValue = removeZeroWidthCharFromText(v);
                            retValue = retValue.replace(/\r\n?/g, '\n');
                            if (retValue.indexOf(NBSP_SPACE_CHAR) < 0) {
                                return retValue;
                            }
                            return replaceSpaceChar(retValue, NBSP_SPACE_CHAR, ' ');
                        }
                    }
                    return keyword_null;
                };
                // 设置编辑器值
                TextCellType.prototype.setEditorValue = function (editorContext, value, context, addPercent) {
                    if (editorContext) {
                        var startEditByKeydown = context && context.sheet && context.sheet._startEditByKeydown;
                        var editorValue = getProcessedEditorValue(value);
                        if (browser_msie) {
                            if (!startEditByKeydown || !context.isImeInput) {
                                setEditorContent(editorContext, isNullOrUndefined(editorValue) ? (addPercent ? '%' : '') : editorValue);
                            }
                        } else {
                            setEditorContent(editorContext, startEditByKeydown ? (addPercent ? '%' : '') : editorValue);
                        }
                    }
                };
                // 全选
                TextCellType.prototype.selectAll = function (editorContext, context) {
                    if (editorContext && editorContext.select) {
                        editorContext.select();
                    } else {
                        var selection = WINDOW.getSelection();
                        selection.selectAllChildren(editorContext);
                    }
                };
                // 聚焦
                TextCellType.prototype.focus = function (editorContext, context) {
                    if (this.isImeAware() && editorContext) {
                        editorContext.focus();
                        moveCaretToEnd(editorContext);
                    } else {
                        editorContext.parentNode.parentNode.focus();
                    }
                };
                // 格式化编辑器值
                TextCellType.prototype._formatEditorValue = function (editorContext, cellStyle, value, context) {
                    var sheet = editorContext && context && context.sheet, formatterRef = {};
                    var text = formatValue2Text(cellStyle, value, sheet, formatterRef);
                    editorContext._editingFormatter = formatterRef.formatter || keyword_undefined;
                    return text;
                };
                // 激活编辑器
                TextCellType.prototype.activateEditor = function (editorContext, cellStyle, editorRect, context, wrapperRect, leftExternalRect, rightExternalRect) {
                    var sheet = context && context.sheet;
                    if (sheet) {
                        var self_1 = this;
                        var editor_1 = editorContext;
                        if (editor_1) {
                            var $editor = domUtil_1.GC$(editor_1);
                            var isDIVElement_1 = isEditableDIVElement(editor_1);
                            self_1._editingElement = editor_1;
                            if (util_device.android) {
                                $editor.bind('input' + _gcEditingInput, function (event) {
                                    try {
                                        self_1._updateEditorByKeyDown(editor_1, cellStyle, editorRect, event, context, false, wrapperRect, leftExternalRect, rightExternalRect);
                                    } catch (ex) { }
                                });
                            }
                            $editor.bind('keydown' + _gcEditingInput, function (event) {
                                try {
                                    var keyCode = event.keyCode;
                                    if (isDIVElement_1) {
                                        if (keyCode === 8) {
                                            _EditorDomHelper.processBackspaceAndLeftArrowKeyEvent(event, true);
                                        } else if (keyCode === 46) {
                                            _EditorDomHelper.processDeleteAndRightArrowKeyEvent(event, true);
                                        } else if (keyCode === 37) {
                                            _EditorDomHelper.processBackspaceAndLeftArrowKeyEvent(event, false);
                                        } else if (keyCode === 39) {
                                            _EditorDomHelper.processDeleteAndRightArrowKeyEvent(event, false);
                                        }
                                    }
                                    var isIme = keyCode === 229 || keyCode === 0;
                                    if (!(isIme || self_1._isImeInputing)) {
                                        self_1._updateEditorByKeyDown(editor_1, cellStyle, editorRect, event, context, true, wrapperRect, leftExternalRect, rightExternalRect);
                                    }
                                    textCellType_processEditingWrap(event, context, self_1._isImeInputing, wrapperRect, leftExternalRect, rightExternalRect);
                                } catch (ex) { }
                            });
                            $editor.bind('keyup' + _gcEditingInput, function (event) {
                                var keyCode = event.keyCode;
                                var ctrlKey = event.ctrlKey;
                                var altKey = event.altKey;
                                var isIme = keyCode === 229 || keyCode === 0;
                                if (!isIme && !self_1._isImeInputing) {
                                    if ((keyCode === 46 || keyCode === 8) ||
                                        ((keyCode === 90 || keyCode === 89) && ctrlKey && !altKey)) {
                                        if (isDIVElement_1 && editor_1.innerText === '\n') {
                                            domUtil_1.GC$(editor_1).empty();
                                        }
                                        self_1._updateEditorByKeyDown(editor_1, cellStyle, editorRect, event, context, false, wrapperRect, leftExternalRect, rightExternalRect);
                                    }
                                    if ((keyCode !== 13 && keyCode !== 9 && keyCode !== 27 && keyCode !== 16) || ctrlKey || altKey) {
                                        sheet._trigger(Events_EditChange, {
                                            sheet: sheet,
                                            sheetName: sheet.name(),
                                            row: sheet._activeRowIndex,
                                            col: sheet._activeColIndex,
                                            editingText: self_1.getEditorValue(editor_1, context)
                                        });
                                    }
                                }
                            });
                            $editor.bind('mousedown' + _gcEditingInput, function () {
                                if (sheet._editorStatus === 1) {
                                    sheet._editorStatus = 2;
                                    sheet._raiseEditorStatusChanged(1, 2);
                                }
                            });
                            $editor.bind('textInput' + _gcEditingInput, function (event) {
                                if (event.data && (self_1.probabilityAddPercentSpec || self_1.probabilityAddPercent) && /^[0-9]+.?[0-9]*/.test(event.data)) {
                                    var p = document.createElement('span');
                                    p.innerText = '%';
                                    p.id = 'updateEditorImpAddPercent';
                                    if (editor_1.firstChild.nodeName === '#text') {
                                        editor_1.appendChild(p);
                                    } else {
                                        editor_1.firstChild.appendChild(p);
                                    }
                                    delete self_1.probabilityAddPercentSpec;
                                    delete self_1.probabilityAddPercent;
                                }
                            });
                            $editor.bind('compositionstart' + _gcEditingInput, function () {
                                self_1._isImeInputing = true;
                                self_1._oldValueBeforeImeInputting = getEditorContent(editor_1);
                            });
                            $editor.bind('compositionupdate' + _gcEditingInput, function (event) {
                                self_1._updateEditorByKeyDown(editor_1, cellStyle, editorRect, event ? event : keyword_null, context, true, wrapperRect, leftExternalRect, rightExternalRect);
                            });
                            $editor.bind('compositionend' + _gcEditingInput, function (event) {
                                self_1._updateEditorByKeyDown(editor_1, cellStyle, editorRect, event ? event : keyword_null, context, false, wrapperRect, leftExternalRect, rightExternalRect);
                                self_1._isImeInputing = false;
                                var keyCode = event.keyCode;
                                var ctrlKey = event.ctrlKey;
                                var altKey = event.altKey;
                                var editingText = self_1.getEditorValue(editor_1, context) || '';
                                if ((self_1._oldValueBeforeImeInputting !== editingText) &&
                                    (keyCode === keyword_undefined || (keyCode !== 13 && keyCode !== 9) || ctrlKey || altKey)) {
                                    sheet._trigger(Events_EditChange, {
                                        sheet: sheet,
                                        sheetName: sheet.name(),
                                        row: sheet._activeRowIndex,
                                        col: sheet._activeColIndex,
                                        editingText: editingText
                                    });
                                }
                            });
                            if (isDIVElement_1) {
                                $editor.bind('copy' + _gcEditingInput, function (event) {
                                    var window_clipboardData = WINDOW.clipboardData;
                                    var clipboardData = event.clipboardData;
                                    var textContent = getElementSelectionText(event.currentTarget);
                                    if (!isNullOrUndefined(textContent)) {
                                        if (window_clipboardData && window_clipboardData.setData) {
                                            window_clipboardData.setData('text', textContent);
                                            cancelDefault(event);
                                        } else if (clipboardData && clipboardData.setData) {
                                            clipboardData.setData('text/plain', textContent);
                                            cancelDefault(event);
                                        }
                                    }
                                });
                                $editor.bind('paste' + _gcEditingInput, function (event) {
                                    var needCancelDefault = false;
                                    if (isDIVElement_1) {
                                        try {
                                            var pasteValue = void 0;
                                            if (browser_msie && !browser_edge && WINDOW.clipboardData && WINDOW.clipboardData.getData) {
                                                pasteValue = WINDOW.clipboardData.getData('text');
                                            } else if (event.clipboardData && event.clipboardData.getData) {
                                                pasteValue = event.clipboardData.getData('text/plain');
                                            }
                                            pasteValue = pasteValue.replace(/\r\n?/g, '\n');
                                            pasteValue = getProcessedEditorValue(pasteValue);
                                            var selection = WINDOW.getSelection();
                                            if (selection.rangeCount > 0) {
                                                var range = selection.getRangeAt(0);
                                                var caretStartPosition = range.startOffset;
                                                var caretEndPosition = range.endOffset;
                                                if (caretStartPosition !== caretEndPosition) {
                                                    range.deleteContents();
                                                }
                                                if (!isFormulaEditor(editor_1, pasteValue, caretStartPosition)) {
                                                    var textNode = DOCUMENT.createElement('span');
                                                    pasteValue = pasteValue.replace(/\u200B/g, '');
                                                    var length_2 = pasteValue.length;
                                                    if (pasteValue[length_2 - 1] === '\n') {
                                                        if (pasteValue[length_2 - 2] === '\r') {
                                                            pasteValue = pasteValue.substr(0, length_2 - 2);
                                                        } else {
                                                            pasteValue = pasteValue.substr(0, length_2 - 1);
                                                        }
                                                    }
                                                    textNode.innerText = pasteValue;
                                                    range.insertNode(textNode);
                                                    var newRange = document.createRange();
                                                    newRange.setStartAfter(textNode);
                                                    newRange.setEndAfter(textNode);
                                                    newRange.collapse(false);
                                                    selection.removeAllRanges();
                                                    selection.addRange(newRange);
                                                    needCancelDefault = true;
                                                }
                                            }
                                        } catch (ex) { }
                                    }
                                    self_1._pasteInputSizingToken = WINDOW.setTimeout(function () {
                                        self_1._updateEditorByKeyDown(editor_1, cellStyle, editorRect, event, context, false, wrapperRect, leftExternalRect, rightExternalRect);
                                        if (self_1._pasteInputSizingToken) {
                                            clearTimeout(self_1._pasteInputSizingToken);
                                            delete self_1._pasteInputSizingToken;
                                        }
                                    }, 10);
                                    if (needCancelDefault) {
                                        return false;
                                    }
                                });
                            }
                        }
                    }
                };
                // 停用编辑器
                TextCellType.prototype.deactivateEditor = function (editorContext, context) {
                    if (editorContext) {
                        var editor = editorContext;
                        if (this._isImeInputing && IS_IPAD && context && context.sheet && context.sheet._isTouchMode) {
                            try {
                                if (editor) {
                                    domUtil_1.GC$(editor).trigger('compositionend' + _gcEditingInput);
                                }
                            } catch (e) { }
                        }
                        var padding = context.sheet.getActualStyle(context.row, context.col, context.sheetArea).cellPadding;
                        if (padding) {
                            var position = [cssLeft, cssTop];
                            var positionIndex = [3, 0];
                            for (var i = 0; i < position.length; i++) {
                                var offsetValue = parseInt(getCellOffsetArray(padding)[positionIndex[i]], 10);
                                offsetValue = (typeof offsetValue === const_number) && (offsetValue > 0) ? offsetValue : 0;
                                this.shiftPadding(editor, position[i], offsetValue);
                            }
                        }
                        domUtil_1.GC$(editorContext).unbind(_gcEditingInput);
                        context.sheet._eventHandler._changeFocusHolder();
                    }
                    this._editingElement = keyword_null;
                };
                // 填充移位
                TextCellType.prototype.shiftPadding = function (editor, position, offsetValue) {
                    var container = domUtil_1.GC$(editor).parent();
                    if (!container) {
                        return;
                    }
                    if (position === cssLeft) {
                        container.css({
                            left: (+(domUtil_1.GC$(container).css(cssLeft)).replace('px', '') || 0) - offsetValue
                        });
                    } else if (position === cssTop) {
                        container.css({
                            top: (+(domUtil_1.GC$(container).css(cssTop)).replace('px', '') || 0) - offsetValue
                        });
                    }
                };
                // 获取正在编辑的元素
                TextCellType.prototype.getEditingElement = function () {
                    return this._editingElement;
                };
                // 更新编辑器的实现
                TextCellType.prototype._updateEditorImp = function (editorContext, cellStyle, editorBounds, event, context, startEditByKeyDown, wrapperBounds, leftExternalBounds, rightExternalBounds) {
                    var sheet = context && context.sheet;
                    var self = this;
                    var sheetAreaOffset = sheet.options.sheetAreaOffset;
                    var editor = editorContext;
                    if (editor && sheet) {
                        var $editor = domUtil_1.GC$(editor);
                        var render = sheet._render;
                        var preventOverflow = context.preventOverflow;
                        var editorValue = getEditorContent(editor);
                        if (sheet.isEditing()) {
                            var isDIVElement = isEditableDIVElement(editor);
                            var hAlign = void 0;
                            var hAlignValue = cssLeft;
                            var font = void 0;
                            var getPositionOffset = basecelltype_1.Context._getPositionOffset;
                            var paddingTop = 0;
                            var paddingRight = 0;
                            var paddingBottom = 0;
                            var paddingLeft = 0;
                            if (cellStyle) {
                                var zoomFactor = sheet.zoom();
                                paddingTop = getPositionOffset(cellStyle, 0, false, zoomFactor);
                                paddingRight = getPositionOffset(cellStyle, 1, false, zoomFactor);
                                paddingBottom = getPositionOffset(cellStyle, 2, false, zoomFactor);
                                paddingLeft = getPositionOffset(cellStyle, 3, false, zoomFactor);
                                hAlign = getHAlignByValueType(cellStyle.hAlign, editorContext._originalValue);
                                if (hAlign === 1) {
                                    hAlignValue = cssCenter;
                                } else if (hAlign === 2) {
                                    hAlignValue = cssRight;
                                }
                                $editor.css(cssTextAlign, hAlignValue);
                                if (cellStyle.foreColor) {
                                    $editor.css('color', cellStyle.foreColor);
                                }
                                font = cellStyle.font || render._getDefaultFont();
                                if (font) {
                                    if (sheet.zoom() > 1) {
                                        font = render._getZoomFont(font);
                                    }
                                    $editor.css('font', adjustFontWithFallback(font));
                                }
                                if (cellStyle.textDecoration) {
                                    self._setTextDecoration($editor, cellStyle.textDecoration);
                                }
                            }
                            var adjustWidth = parseIntFunc($editor.css('padding-left'), 10) || 0 + parseIntFunc($editor.css('padding-right'), 10) || 0;
                            var adjustHeight = parseIntFunc($editor.css('padding-top'), 10) || 0 + parseIntFunc($editor.css('padding-bottom'), 10) || 0;
                            if (isNullOrUndefined(wrapperBounds)) {
                                wrapperBounds = editorBounds;
                            }
                            if (wrapperBounds) {
                                var sheetLayout = sheet._getSheetLayout();
                                var width = editorBounds.width;
                                if (wrapperBounds.x + wrapperBounds.width - sheetAreaOffset.left > sheetLayout.width) {
                                    editorBounds.width = sheetLayout.width - editorBounds.x;
                                    wrapperBounds.width = sheetLayout.width - wrapperBounds.x;
                                }
                                $editor.css(cssWidth, width - adjustWidth).css(cssHeight, editorBounds.height - adjustHeight);
                                editor.maxWidth = sheetAreaOffset.left + sheetLayout.width - editorBounds.x - adjustWidth - paddingRight;
                                $editor.css('max-width', editor.maxWidth + 'px');
                                editor.maxHeight = sheetAreaOffset.top + sheetLayout.height - editorBounds.y - adjustHeight - paddingBottom;
                                editor.minWidth = parseIntFunc(editor.style.width, 10);
                                editor.minHeight = parseIntFunc(editor.style.height, 10);
                            }
                            var startCaretPos = getCaretStartPosition(editor);
                            var endCaretPos = getCaretEndPosition(editor);
                            startEditByKeyDown = startEditByKeyDown && event && event.keyCode && sheet._eventHandler._allowEnterEditing(event) && startCaretPos === 0 && endCaretPos === editorValue.length;
                            startEditByKeyDown = startEditByKeyDown || sheet._startEditByKeydown;
                            var value = startEditByKeyDown ? '' : editorValue;
                            font = editor.style.font;
                            if (!font) {
                                font = render._getZoomFont(render._getDefaultFont());
                            }
                            var lineHeight = getFontHeight(font);
                            if (event && self.probabilityAddPercent) {
                                var keyCode = event.keyCode;
                                if (keyCode && ((keyCode >= 96 && keyCode <= 105) || (keyCode >= 48 && keyCode <= 57))) {
                                    if (!sheet.parent.options.enableFormulaTextbox) {
                                        var p = document.createElement('span');
                                        p.innerText = '%';
                                        p.id = 'updateEditorImpAddPercent';
                                        editor.firstChild.appendChild(p);
                                        delete self.probabilityAddPercent;
                                    } else {
                                        var editorText = editor.innerText;
                                        if (!(/[a-z]/i.test(editorText))) {
                                            var p = document.createElement('span');
                                            p.innerText = '%';
                                            p.id = 'updateEditorImpAddPercent';
                                            editor.appendChild(p);
                                            delete self.probabilityAddPercent;
                                        } else {
                                            self.probabilityAddPercent = false;
                                        }
                                    }
                                }
                            }
                            if (!startEditByKeyDown && event) {
                                if (sheet._eventHandler._allowEnterEditing(event) && event.keyCode !== 8) {
                                    value = getEditorInputtingValue(editor, value, startCaretPos, endCaretPos, event);
                                }
                                if (self._isImeInputing) {
                                    if (browser_msie) {
                                        value = editorValue;
                                    } else {
                                        value = self._oldValueBeforeImeInputting + event.data;
                                    }
                                }
                            }
                            var lines = [];
                            if (cellStyle && cellStyle.wordWrap) {
                                lines = _WordWrapHelper._getWrapInfo(value, parseIntFunc(editor.style.width) - adjustWidth, font);
                            } else {
                                lines = value.split(/\r\n|\r|\n/);
                            }
                            var i = void 0;
                            var lineWidth = void 0;
                            var linesLength = lines.length;
                            editor.minWidth = Math_min(editor.minWidth, editor.maxWidth);
                            editor.minHeight = Math_min(editor.minHeight, editor.maxHeight);
                            if ((cellStyle && cellStyle.wordWrap) || linesLength > 0) {
                                var wrapHeight = void 0;
                                var lineHeightArray = void 0;
                                if (browser_chrome) {
                                    lineHeightArray = getLineHeightArray(lines, font);
                                    wrapHeight = getEditorHeight(lineHeightArray);
                                } else {
                                    wrapHeight = linesLength * lineHeight;
                                }
                                if (cellStyle && cellStyle.wordWrap) {
                                    $editor
                                        .css(cssWordWrap, cssBreakWord)
                                        .css(cssOverflow, cssHidden)
                                        .css('max-width', editor.style.width);
                                } else {
                                    var maxLineWidth = 0;
                                    var lineWidthTemps = [];
                                    for (i = 0; i < linesLength; i++) {
                                        lineWidth = Math_ceil(sheet._getStringWidth(lines[i], font));
                                        lineWidthTemps.push(lineWidth);
                                        maxLineWidth = Math_max(maxLineWidth, lineWidth);
                                    }
                                    var wordWrapStyle = $editor.css(cssWordWrap);
                                    var editorWidth = parseIntFunc(editor.style.width);
                                    if (cellStyle || wordWrapStyle !== cssBreakWord) {
                                        if (maxLineWidth <= editor.minWidth) {
                                            $editor
                                                .css(cssWidth, editor.minWidth)
                                                .css(cssWordWrap, cssNormal)
                                                .css(cssOverflow, cssHidden);
                                            if (isDIVElement) {
                                                $editor.css(cssWordBreak, cssNormal);
                                            }
                                        } else if (maxLineWidth > editor.minWidth && maxLineWidth <= editor.maxWidth && !preventOverflow) {
                                            $editor
                                                .css(cssWidth, maxLineWidth)
                                                .css(cssWordWrap, cssNormal)
                                                .css(cssOverflow, cssHidden);
                                            if (isDIVElement) {
                                                $editor.css(cssWordBreak, cssNormal);
                                            }
                                        } else if (maxLineWidth > editor.maxWidth && !preventOverflow) {
                                            $editor
                                                .css(cssWidth, editor.maxWidth - 2)
                                                .css(cssWordWrap, cssBreakWord)
                                                .css(cssOverflow, cssHidden);
                                            wrapHeight = getTextWrapHeight(lineWidthTemps, editor.maxWidth, lineHeight, lineHeightArray);
                                        }
                                    } else if (maxLineWidth > editorWidth && !preventOverflow) {
                                        wrapHeight = getTextWrapHeight(lineWidthTemps, editorWidth, lineHeight, lineHeightArray);
                                    }
                                }
                                if (wrapHeight <= editor.minHeight) {
                                    $editor
                                        .css(cssHeight, editor.minHeight)
                                        .css(cssFloat, cssNone);
                                } else if (wrapHeight > editor.minHeight && wrapHeight <= editor.maxHeight) {
                                    $editor
                                        .css(cssHeight, wrapHeight)
                                        .css(cssFloat, cssNone);
                                } else if (wrapHeight > editor.maxHeight) {
                                    $editor
                                        .css(cssHeight, editor.maxHeight - 1)
                                        .css(cssOverflowY, cssScroll)
                                        .css(cssFloat, cssLeft);
                                }
                            }
                            hAlign = $editor.css(cssTextAlign);
                            var flowWidth = $editor.width() - editor.minWidth;
                            if (!isNullOrUndefined(hAlign) && hAlign !== cssLeft) {
                                if (hAlign === cssCenter) {
                                    $editor.css(cssLeft, editor.originalLeft - flowWidth / 2);
                                } else if (hAlign === cssRight) {
                                    $editor.css(cssLeft, editor.originalLeft - flowWidth);
                                }
                            }
                            if (cellStyle && isDIVElement) {
                                var vAlign = cellStyle.vAlign;
                                if (vAlign === 1) {
                                    $editor.css(cssVerticalAlign, 'middle');
                                } else if (vAlign === 2) {
                                    $editor.css(cssVerticalAlign, 'bottom');
                                }
                            }
                            var editorContainerHeight = parseIntFunc(editor.style.height) + adjustHeight + paddingTop + paddingBottom;
                            var editorContextOffset = adjustWidth + paddingLeft + paddingRight;
                            if ($editor.css(cssOverflowY) === cssScroll) {
                                return {
                                    width: editor.offsetWidth + editorContextOffset,
                                    height: startEditByKeyDown ? 0 : editorContainerHeight
                                };
                            } else {
                                return {
                                    width: parseIntFunc(editor.style.width) + editorContextOffset,
                                    height: editorContainerHeight
                                };
                            }
                        }
                    }
                };
                // 更新编辑器
                TextCellType.prototype.updateEditor = function (editorContext, cellStyle, editorBounds, context, wrapperBounds, leftExternalBounds, rightExternalBounds) {
                    editorBounds = this._updateEditorImp(editorContext, cellStyle, editorBounds, keyword_null, context, false, wrapperBounds, leftExternalBounds, rightExternalBounds);
                    if (browser_msie && editorContext) {
                        var $editor = domUtil_1.GC$(editorContext);
                        var width = $editor[0].style.width;
                        $editor.width(width + 1).width(width);
                    }
                    var editorRect;
                    if (!isNullOrUndefined(editorBounds) && editorContext) {
                        editorRect = new common_1.Rect(editorContext.style.left ? parseFloat(editorContext.style.left) : 0, editorContext.style.top ? parseFloat(editorContext.style.top) : 0, editorBounds.width, editorBounds.height);
                    }
                    return editorRect;
                };
                // 按向下键更新编辑器
                TextCellType.prototype._updateEditorByKeyDown = function (editorContext, cellStyle, editorBounds, event, context, startEditByKeyDown, wrapperBounds, leftExternalBounds, rightExternalBounds) {
                    editorBounds = this._updateEditorImp(editorContext, cellStyle, editorBounds, event, context, startEditByKeyDown, wrapperBounds, leftExternalBounds, rightExternalBounds);
                    if (browser_msie && editorContext) {
                        var $editor = domUtil_1.GC$(editorContext);
                        var width = $editor[0].style.width;
                        $editor.width(width + 1).width(width);
                    }
                    if (!isNullOrUndefined(editorBounds) && editorContext) {
                        if (!isNullOrUndefined(wrapperBounds)) {
                            wrapperBounds.x = keyword_undefined;
                            wrapperBounds.y = keyword_undefined;
                        } else {
                            wrapperBounds = editorBounds;
                        }
                        this.updateEditorContainer(editorContext, editorBounds, cellStyle, context, wrapperBounds, leftExternalBounds, rightExternalBounds);
                    }
                };
                // 更新编辑器容器
                TextCellType.prototype.updateEditorContainer = function (editorContext, editorBounds, cellStyle, context, wrapperBounds, leftExternalBounds, rightExternalBounds) {
                    if (context && context.preventOverflow) {
                        _super.prototype.updateEditorContainer.call(this, editorContext, editorBounds, cellStyle, context, wrapperBounds, leftExternalBounds, rightExternalBounds);
                        var contentContainer = editorContext.parentNode;
                        if (contentContainer && editorBounds) {
                            var $contentContainer = domUtil_1.GC$(contentContainer);
                            var newWidth = editorBounds.width;
                            if (newWidth > 0) {
                                $contentContainer.width(newWidth);
                            }
                        }
                    } else {
                        if (editorBounds && editorBounds.width && wrapperBounds && wrapperBounds.width) {
                            wrapperBounds.width = editorBounds.width;
                        }
                        if (editorBounds && editorBounds.height && wrapperBounds && wrapperBounds.height) {
                            wrapperBounds.height = editorBounds.height;
                        }
                        _super.prototype.updateEditorContainer.call(this, editorContext, editorBounds, cellStyle, context, wrapperBounds, leftExternalBounds, rightExternalBounds);
                    }
                };
                // 更新输入法模式
                TextCellType.prototype.updateImeMode = function (editorContext, imeMode, context) {
                    if (this.isImeAware() && editorContext) {
                        basecelltype_1.Context._setImeMode(editorContext, imeMode);
                    }
                };
                // 是否保留key
                TextCellType.prototype.isReservedKey = function (event, context) {
                    var src = event.srcElement || event.target;
                    var keyCode = event.keyCode;
                    var ctrlKey = event.ctrlKey;
                    var altKey = event.altKey;
                    var metaKey = event.metaKey;
                    if (src && context && context.isEditing && src.getAttribute(attrGcUIElement) === 'gcEditingInput') {
                        return keyCode === 13 && (ctrlKey && !event.shiftKey || altKey) ||
                            (keyCode === 90 && ctrlKey && !altKey) ||
                            (keyCode === 89 && ctrlKey && !altKey) ||
                            (keyCode === 67 && (ctrlKey || metaKey) && !altKey) ||
                            (keyCode === 88 && (ctrlKey || metaKey) && !altKey);
                    }
                    return false;
                };
                // 
                TextCellType.prototype.isImeAware = function (context) {
                    return true;
                };
                // 
                TextCellType.prototype.toJSON = function () {
                    var settings = {};
                    var self = this;
                    for (var p in self) {
                        if (self.hasOwnProperty(p) && p !== '_editingElement') {
                            settings[p] = self[p];
                        }
                    }
                    return settings;
                };
                return TextCellType;
            }(basecelltype_1.Base));
            exports.Text = TextCellType;

            // 
            function getCellOffsetArray(cellPadding) {
                var retArray = ['0', '0', '0', '0'];
                if (typeof cellPadding === const_string) {
                    var offsetArray = cellPadding.split(' ', 4);
                    var length_3 = offsetArray.length;
                    var topOffset = void 0;
                    var rightOffset = void 0;
                    if (length_3 === 1) {
                        topOffset = offsetArray[0];
                        retArray = [topOffset, topOffset, topOffset, topOffset];
                    } else if (length_3 === 2) {
                        topOffset = offsetArray[0];
                        rightOffset = offsetArray[1];
                        retArray = [topOffset, rightOffset, topOffset, rightOffset];
                    } else if (length_3 === 3) {
                        rightOffset = offsetArray[1];
                        retArray = [offsetArray[0], rightOffset, offsetArray[2], rightOffset];
                    } else if (length_3 === 4) {
                        retArray = [offsetArray[0], offsetArray[1], offsetArray[2], offsetArray[3]];
                    }
                }
                return retArray;
            }
            celltype_ns_1._typeDict[1] = TextCellType;
        }),
        './dist/core/core.definition.js': (function (module, exports) { }),
        './dist/core/core.entry.js': (function (module, exports, __webpack_require__) {
            function __export(m) {
                for (var p in m)
                    if (!exports.hasOwnProperty(p))
                        exports[p] = m[p];
            }
            Object.defineProperty(exports, '__esModule', { value: true });
            __webpack_require__(/*! ./core.res.en */ './dist/core/core.res.en.js');
            __export(__webpack_require__(/*! ./core.ns */ './dist/core/core.ns.js'));
            __export(__webpack_require__(/*! ./core.enum */ './dist/core/core.enum.js'));
            __export(__webpack_require__(/*! ./util/common */ './dist/core/util/common.js'));
            __export(__webpack_require__(/*! ./util/domUtil */ './dist/core/util/domUtil.js'));
            __webpack_require__(/*! ./core.definition */ './dist/core/core.definition.js');
            var UtilCommon = __webpack_require__(/*! ./util/common */ './dist/core/util/common.js');
            Object.defineProperty(exports, 'getTypeFromString', {
                set: function (value) {
                    UtilCommon.getTypeFromString = value;
                },
                get: function () {
                    return UtilCommon.getTypeFromString;
                }
            });
            var ls = __webpack_require__(/*! license2 */ './dist/core/lc/debugLc.js');
            var pt = ls._pt;
            var seed = -1;
            if (pt === 1) {
                seed = Math.floor(Math.random() * 5);
                exports['G'.concat('C', '$')]['s'.concat('d')] = seed;
            }
            __export(__webpack_require__(/*! ./util/theme */ './dist/core/util/theme.js'));
            __export(__webpack_require__(/*! ./util/basedialog */ './dist/core/util/basedialog.js'));
            __export(__webpack_require__(/*! ./util/imageLoader */ './dist/core/util/imageLoader.js'));
            __export(__webpack_require__(/*! ./util/tasks */ './dist/core/util/tasks.js'));
            if (seed === 0) {
                __webpack_require__(/*! licenseReg */ './dist/core/lc/debugLc.js');
            }
            __export(__webpack_require__(/*! ./worksheet/stylehelper */ './dist/core/worksheet/stylehelper.js'));
            if (seed === 1) {
                __webpack_require__(/*! licenseReg */ './dist/core/lc/debugLc.js');
            }
            __export(__webpack_require__(/*! ./worksheet/style */ './dist/core/worksheet/style.js'));
            if (seed === 2) {
                __webpack_require__(/*! licenseReg */ './dist/core/lc/debugLc.js');
            }
            __export(__webpack_require__(/*! ./worksheet/clipboardhelper */ './dist/core/worksheet/clipboardhelper.js'));
            if (seed === 3) {
                __webpack_require__(/*! licenseReg */ './dist/core/lc/debugLc.js');
            }
            __export(__webpack_require__(/*! ./worksheet/worksheet-model */ './dist/core/worksheet/worksheet-model.js'));
            if (seed === 4) {
                __webpack_require__(/*! licenseReg */ './dist/core/lc/debugLc.js');
            }
            __export(__webpack_require__(/*! ./worksheet/worksheet */ './dist/core/worksheet/worksheet.js'));
            __webpack_require__(/*! ./worksheet/worksheet-formatter */ './dist/core/worksheet/worksheet-formatter.js');
            __export(__webpack_require__(/*! ./worksheet/worksheet-actions */ './dist/core/worksheet/worksheet-actions.js'));
            __export(__webpack_require__(/*! ./worksheet/worksheet-border */ './dist/core/worksheet/worksheet-border.js'));
            __webpack_require__(/*! ./worksheet/worksheet-edit */ './dist/core/worksheet/worksheet-edit.js');
            __export(__webpack_require__(/*! ./worksheet/worksheet-event */ './dist/core/worksheet/worksheet-event.js'));
            __webpack_require__(/*! ./worksheet/worksheet-json */ './dist/core/worksheet/worksheet-json.js');
            __export(__webpack_require__(/*! ./worksheet/worksheet-render */ './dist/core/worksheet/worksheet-render.js'));
            __webpack_require__(/*! ./worksheet/worksheet-selection */ './dist/core/worksheet/worksheet-selection.js');
            __webpack_require__(/*! ./worksheet/worksheet-sort */ './dist/core/worksheet/worksheet-sort.js');
            __export(__webpack_require__(/*! ./worksheet/worksheet-ui */ './dist/core/worksheet/worksheet-ui.js'));
            __export(__webpack_require__(/*! ./worksheet/worksheet-static */ './dist/core/worksheet/worksheet-static.js'));
            __export(__webpack_require__(/*! ./workbook/workbook */ './dist/core/workbook/workbook.js'));
            __webpack_require__(/*! ./workbook/workbook-json */ './dist/core/workbook/workbook-json.js');
            __export(__webpack_require__(/*! ./workbook/sheettabbase */ './dist/core/workbook/sheettabbase.js'));
            __export(__webpack_require__(/*! ./workbook/sheettab */ './dist/core/workbook/sheettab.js'));
            __export(__webpack_require__(/*! ./workbook/sheettab2007 */ './dist/core/workbook/sheettab2007.js'));
            __export(__webpack_require__(/*! ./workbook/workbookpanelex */ './dist/core/workbook/workbookpanelex.js'));

            var CellTypes = __webpack_require__(/*! ./celltype/cellType.entry */ './dist/core/celltype/cellType.entry.js');
            exports.CellTypes = CellTypes;
            var HeaderCellTypes = __webpack_require__(/*! ./celltype/headercelltype */ './dist/core/celltype/headercelltype.js');
            Object.defineProperty(CellTypes, 'Corner', {
                set: function (value) {
                    if (value === HeaderCellTypes.Corner) {
                        return;
                    }
                    HeaderCellTypes.Corner = value;
                },
                get: function () {
                    return HeaderCellTypes.Corner;
                }
            });
            Object.defineProperty(CellTypes, 'ColumnHeader', {
                set: function (value) {
                    if (value === HeaderCellTypes.ColumnHeader) {
                        return;
                    }
                    HeaderCellTypes.ColumnHeader = value;
                },
                get: function () {
                    return HeaderCellTypes.ColumnHeader;
                }
            });
            Object.defineProperty(CellTypes, 'RowHeader', {
                set: function (value) {
                    if (value === HeaderCellTypes.RowHeader) {
                        return;
                    }
                    HeaderCellTypes.RowHeader = value;
                },
                get: function () {
                    return HeaderCellTypes.RowHeader;
                }
            });
            var TextCellTypes = __webpack_require__(/*! ./celltype/textcelltype */ './dist/core/celltype/textcelltype.js');
            Object.defineProperty(CellTypes, 'Text', {
                set: function (value) {
                    if (value === TextCellTypes.Text) {
                        return;
                    }
                    TextCellTypes.Text = value;
                },
                get: function () {
                    return TextCellTypes.Text;
                }
            });
            CellTypes._HeaderCellTypes = HeaderCellTypes;
            CellTypes._TextCellTypes = TextCellTypes;
            if (pt === 1 || pt === 2) {
                ls._replace(exports);
            }
        }),
        './dist/core/core.enum.js': (function (module, exports, __webpack_require__) {
            Object.defineProperty(exports, '__esModule', { value: true });
            var ScrollType;
            (function (ScrollType) {
                ScrollType[ScrollType['pixels'] = 0] = 'pixels';
                ScrollType[ScrollType['continuous'] = 1] = 'continuous';
            })(ScrollType = exports.ScrollType || (exports.ScrollType = {}));

            var AxisInfoChangeType;
            (function (AxisInfoChangeType) {
                AxisInfoChangeType[AxisInfoChangeType['setRowCount'] = 0] = 'setRowCount';
                AxisInfoChangeType[AxisInfoChangeType['setColumnCount'] = 1] = 'setColumnCount';
                AxisInfoChangeType[AxisInfoChangeType['addRows'] = 2] = 'addRows';
                AxisInfoChangeType[AxisInfoChangeType['deleteRows'] = 3] = 'deleteRows';
                AxisInfoChangeType[AxisInfoChangeType['addColumns'] = 4] = 'addColumns';
                AxisInfoChangeType[AxisInfoChangeType['deleteColumns'] = 5] = 'deleteColumns';
                AxisInfoChangeType[AxisInfoChangeType['setRowHeight'] = 6] = 'setRowHeight';
                AxisInfoChangeType[AxisInfoChangeType['setColumnWidth'] = 7] = 'setColumnWidth';
                AxisInfoChangeType[AxisInfoChangeType['setRowVisible'] = 8] = 'setRowVisible';
                AxisInfoChangeType[AxisInfoChangeType['setColumnVisible'] = 9] = 'setColumnVisible';
                AxisInfoChangeType[AxisInfoChangeType['filterRows'] = 10] = 'filterRows';
                AxisInfoChangeType[AxisInfoChangeType['outlineExpandRows'] = 11] = 'outlineExpandRows';
                AxisInfoChangeType[AxisInfoChangeType['outlineExpandColumns'] = 12] = 'outlineExpandColumns';
            })(AxisInfoChangeType = exports.AxisInfoChangeType || (exports.AxisInfoChangeType = {}));

            var ScrollbarState;
            (function (ScrollbarState) {
                ScrollbarState[ScrollbarState['hide'] = 0] = 'hide';
                ScrollbarState[ScrollbarState['show'] = 1] = 'show';
                ScrollbarState[ScrollbarState['active'] = 2] = 'active';
                ScrollbarState[ScrollbarState['inactive'] = 3] = 'inactive';
            })(ScrollbarState = exports.ScrollbarState || (exports.ScrollbarState = {}));

            var ShowResizeTip;
            (function (ShowResizeTip) {
                ShowResizeTip[ShowResizeTip['none'] = 0] = 'none';
                ShowResizeTip[ShowResizeTip['column'] = 1] = 'column';
                ShowResizeTip[ShowResizeTip['row'] = 2] = 'row';
                ShowResizeTip[ShowResizeTip['both'] = 3] = 'both';
            })(ShowResizeTip = exports.ShowResizeTip || (exports.ShowResizeTip = {}));

            var ScrollbarAppearance;
            (function (ScrollbarAppearance) {
                // 指定类似于 excel 的经典滚动条外观。
                ScrollbarAppearance[ScrollbarAppearance['skin'] = 0] = 'skin';
                // 指定可定制的时尚移动滚动条外观。
                ScrollbarAppearance[ScrollbarAppearance['mobile'] = 1] = 'mobile';
            })(ScrollbarAppearance = exports.ScrollbarAppearance || (exports.ScrollbarAppearance = {}));

            var ShowScrollTip;
            (function (ShowScrollTip) {
                ShowScrollTip[ShowScrollTip['none'] = 0] = 'none';
                ShowScrollTip[ShowScrollTip['horizontal'] = 1] = 'horizontal';
                ShowScrollTip[ShowScrollTip['vertical'] = 2] = 'vertical';
                ShowScrollTip[ShowScrollTip['both'] = 3] = 'both';
            })(ShowScrollTip = exports.ShowScrollTip || (exports.ShowScrollTip = {}));

            var InsertShiftCell;
            (function (InsertShiftCell) {
                InsertShiftCell[InsertShiftCell['right'] = 0] = 'right';
                InsertShiftCell[InsertShiftCell['down'] = 1] = 'down';
            })(InsertShiftCell = exports.InsertShiftCell || (exports.InsertShiftCell = {}));

            var ResizeMode;
            (function (ResizeMode) {
                ResizeMode[ResizeMode['normal'] = 0] = 'normal';
                ResizeMode[ResizeMode['split'] = 1] = 'split';
            })(ResizeMode = exports.ResizeMode || (exports.ResizeMode = {}));

            // 指定复制或粘贴数据时包含哪些标题
            var CopyPasteHeaderOptions;
            (function (CopyPasteHeaderOptions) {
                CopyPasteHeaderOptions[CopyPasteHeaderOptions['noHeaders'] = 0] = 'noHeaders';
                CopyPasteHeaderOptions[CopyPasteHeaderOptions['rowHeaders'] = 1] = 'rowHeaders';
                CopyPasteHeaderOptions[CopyPasteHeaderOptions['columnHeaders'] = 2] = 'columnHeaders';
                CopyPasteHeaderOptions[CopyPasteHeaderOptions['allHeaders'] = 3] = 'allHeaders';
            })(CopyPasteHeaderOptions = exports.CopyPasteHeaderOptions || (exports.CopyPasteHeaderOptions = {}));

            // 
            var HeaderOptions;
            (function (HeaderOptions) {
                HeaderOptions[HeaderOptions['noHeaders'] = 0] = 'noHeaders';
                HeaderOptions[HeaderOptions['rowHeaders'] = 1] = 'rowHeaders';
                HeaderOptions[HeaderOptions['columnHeaders'] = 2] = 'columnHeaders';
                HeaderOptions[HeaderOptions['allHeaders'] = 3] = 'allHeaders';
            })(HeaderOptions = exports.HeaderOptions || (exports.HeaderOptions = {}));

            // 行或列调整为零时的绘图策略
            var ResizeZeroIndicator;
            (function (ResizeZeroIndicator) {
                // 
                ResizeZeroIndicator[ResizeZeroIndicator['default'] = 0] = 'default';
                // 将行或列的大小调整为零时绘制两条短线
                ResizeZeroIndicator[ResizeZeroIndicator['enhanced'] = 1] = 'enhanced';
            })(ResizeZeroIndicator = exports.ResizeZeroIndicator || (exports.ResizeZeroIndicator = {}));

            // 标识哪个操作无效
            var InvalidOperationType;
            (function (InvalidOperationType) {
                InvalidOperationType[InvalidOperationType['setFormula'] = 0] = 'setFormula';
                InvalidOperationType[InvalidOperationType['copyPaste'] = 1] = 'copyPaste';
                InvalidOperationType[InvalidOperationType['dragFill'] = 2] = 'dragFill';
                InvalidOperationType[InvalidOperationType['dragDrop'] = 3] = 'dragDrop';
                InvalidOperationType[InvalidOperationType['changePartOfArrayFormula'] = 4] = 'changePartOfArrayFormula';
                InvalidOperationType[InvalidOperationType['changeSheetName'] = 5] = 'changeSheetName';
                InvalidOperationType[InvalidOperationType['table'] = 6] = 'table';
                InvalidOperationType[InvalidOperationType['filter'] = 7] = 'filter';
                InvalidOperationType[InvalidOperationType['hideSheet'] = 8] = 'hideSheet';
                InvalidOperationType[InvalidOperationType['sort'] = 9] = 'sort';
                InvalidOperationType[InvalidOperationType['pivotTable'] = 10] = 'pivotTable';
                InvalidOperationType[InvalidOperationType['ptOverlapValue'] = 11] = 'ptOverlapValue';
                InvalidOperationType[InvalidOperationType['groupProtected'] = 12] = 'groupProtected';
            })(InvalidOperationType = exports.InvalidOperationType || (exports.InvalidOperationType = {}));

            // 表示组件是否自动调整单元格或标题的大小
            var AutoFitType;
            (function (AutoFitType) {
                AutoFitType[AutoFitType['cell'] = 0] = 'cell';
                AutoFitType[AutoFitType['cellWithHeader'] = 1] = 'cellWithHeader';
            })(AutoFitType = exports.AutoFitType || (exports.AutoFitType = {}));

            // 指定从剪贴板粘贴的数据
            var ClipboardPasteOptions;
            (function (ClipboardPasteOptions) {
                // 粘贴所有数据对象，包括值、格式和公式。
                ClipboardPasteOptions[ClipboardPasteOptions['all'] = 0] = 'all';
                ClipboardPasteOptions[ClipboardPasteOptions['values'] = 1] = 'values';
                ClipboardPasteOptions[ClipboardPasteOptions['formatting'] = 2] = 'formatting';
                ClipboardPasteOptions[ClipboardPasteOptions['formulas'] = 3] = 'formulas';
                ClipboardPasteOptions[ClipboardPasteOptions['valuesAndFormatting'] = 4] = 'valuesAndFormatting';
                ClipboardPasteOptions[ClipboardPasteOptions['formulasAndFormatting'] = 5] = 'formulasAndFormatting';
            })(ClipboardPasteOptions = exports.ClipboardPasteOptions || (exports.ClipboardPasteOptions = {}));

            // 指定单元格标签位置
            var LabelAlignment;
            (function (LabelAlignment) {
                LabelAlignment[LabelAlignment['topLeft'] = 0] = 'topLeft';
                LabelAlignment[LabelAlignment['topCenter'] = 1] = 'topCenter';
                LabelAlignment[LabelAlignment['topRight'] = 2] = 'topRight';
                LabelAlignment[LabelAlignment['bottomLeft'] = 3] = 'bottomLeft';
                LabelAlignment[LabelAlignment['bottomCenter'] = 4] = 'bottomCenter';
                LabelAlignment[LabelAlignment['bottomRight'] = 5] = 'bottomRight';
            })(LabelAlignment = exports.LabelAlignment || (exports.LabelAlignment = {}));

            // 单元标签可见性
            var LabelVisibility;
            (function (LabelVisibility) {
                LabelVisibility[LabelVisibility['visible'] = 0] = 'visible';
                LabelVisibility[LabelVisibility['hidden'] = 1] = 'hidden';
                LabelVisibility[LabelVisibility['auto'] = 2] = 'auto';
            })(LabelVisibility = exports.LabelVisibility || (exports.LabelVisibility = {}));

            // 定义文本装饰的类型
            var TextDecorationType;
            (function (TextDecorationType) {
                TextDecorationType[TextDecorationType['underline'] = 1] = 'underline';
                TextDecorationType[TextDecorationType['lineThrough'] = 2] = 'lineThrough';
                TextDecorationType[TextDecorationType['overline'] = 4] = 'overline';
                TextDecorationType[TextDecorationType['doubleUnderline'] = 8] = 'doubleUnderline';
                TextDecorationType[TextDecorationType['none'] = 0] = 'none';
            })(TextDecorationType = exports.TextDecorationType || (exports.TextDecorationType = {}));

            var HorizontalAlign;
            (function (HorizontalAlign) {
                HorizontalAlign[HorizontalAlign['left'] = 0] = 'left';
                HorizontalAlign[HorizontalAlign['center'] = 1] = 'center';
                HorizontalAlign[HorizontalAlign['right'] = 2] = 'right';
                HorizontalAlign[HorizontalAlign['general'] = 3] = 'general';
            })(HorizontalAlign = exports.HorizontalAlign || (exports.HorizontalAlign = {}));

            var VerticalAlign;
            (function (VerticalAlign) {
                VerticalAlign[VerticalAlign['top'] = 0] = 'top';
                VerticalAlign[VerticalAlign['center'] = 1] = 'center';
                VerticalAlign[VerticalAlign['bottom'] = 2] = 'bottom';
            })(VerticalAlign = exports.VerticalAlign || (exports.VerticalAlign = {}));

            // 
            var VertAlign;
            (function (VertAlign) {
                VertAlign[VertAlign['normal'] = 0] = 'normal';
                VertAlign[VertAlign['superscript'] = 1] = 'superscript';
                VertAlign[VertAlign['subscript'] = 2] = 'subscript';
            })(VertAlign = exports.VertAlign || (exports.VertAlign = {}));

            // 滚动事件类型
            var _ScrollEventType;
            (function (_ScrollEventType) {
                _ScrollEventType[_ScrollEventType['smallDecrement'] = 0] = 'smallDecrement';
                _ScrollEventType[_ScrollEventType['smallIncrement'] = 1] = 'smallIncrement';
                _ScrollEventType[_ScrollEventType['largeDecrement'] = 2] = 'largeDecrement';
                _ScrollEventType[_ScrollEventType['largeIncrement'] = 3] = 'largeIncrement';
                _ScrollEventType[_ScrollEventType['thumbPosition'] = 4] = 'thumbPosition';
                _ScrollEventType[_ScrollEventType['thumbTrack'] = 5] = 'thumbTrack';
                _ScrollEventType[_ScrollEventType['endScroll'] = 6] = 'endScroll';
            })(_ScrollEventType = exports._ScrollEventType || (exports._ScrollEventType = {}));

            // 视觉状态
            var VisualState;
            (function (VisualState) {
                VisualState[VisualState['normal'] = 0] = 'normal';
                VisualState[VisualState['highlight'] = 1] = 'highlight';
                VisualState[VisualState['selected'] = 2] = 'selected';
                VisualState[VisualState['active'] = 3] = 'active';
                VisualState[VisualState['hover'] = 4] = 'hover';
                VisualState[VisualState['activeNotSelected'] = 5] = 'activeNotSelected';
            })(VisualState = exports.VisualState || (exports.VisualState = {}));

            // 编辑状态
            var EditorStatus;
            (function (EditorStatus) {
                EditorStatus[EditorStatus['ready'] = 0] = 'ready';
                EditorStatus[EditorStatus['enter'] = 1] = 'enter';
                EditorStatus[EditorStatus['edit'] = 2] = 'edit';
            })(EditorStatus = exports.EditorStatus || (exports.EditorStatus = {}));

            var ImeMode;
            (function (ImeMode) {
                ImeMode[ImeMode['auto'] = 1] = 'auto';
                ImeMode[ImeMode['active'] = 2] = 'active';
                ImeMode[ImeMode['inactive'] = 4] = 'inactive';
                ImeMode[ImeMode['disabled'] = 0] = 'disabled';
            })(ImeMode = exports.ImeMode || (exports.ImeMode = {}));

            // 用户如何选择控件中的项
            var SelectionPolicy;
            (function (SelectionPolicy) {
                // 允许用户仅选择单个单元格
                SelectionPolicy[SelectionPolicy['single'] = 0] = 'single';
                // 允许用户选择单个项目和项目范围，但不能选择多个范围
                SelectionPolicy[SelectionPolicy['range'] = 1] = 'range';
                // 允许用户选择单个项目和项目范围，包括多个范围。
                SelectionPolicy[SelectionPolicy['multiRange'] = 2] = 'multiRange';
            })(SelectionPolicy = exports.SelectionPolicy || (exports.SelectionPolicy = {}));

            // 用户或应用程序可以选择的最小单位。
            var SelectionUnit;
            (function (SelectionUnit) {
                // 单元格
                SelectionUnit[SelectionUnit['cell'] = 0] = 'cell';
                // 行
                SelectionUnit[SelectionUnit['row'] = 1] = 'row';
                // 列
                SelectionUnit[SelectionUnit['column'] = 2] = 'column';
            })(SelectionUnit = exports.SelectionUnit || (exports.SelectionUnit = {}));

            // 表示存储数据类型
            var StorageType;
            (function (StorageType) {
                // 数据
                StorageType[StorageType['data'] = 1] = 'data';
                // 样式
                StorageType[StorageType['style'] = 2] = 'style';
                // 注释
                StorageType[StorageType['comment'] = 4] = 'comment';
                // 标记
                StorageType[StorageType['tag'] = 8] = 'tag';
                // 迷你图
                StorageType[StorageType['sparkline'] = 16] = 'sparkline';
                // 轴信息
                StorageType[StorageType['axis'] = 32] = 'axis';
                // 数据绑定路径
                StorageType[StorageType['bindingPath'] = 64] = 'bindingPath';
                // 数据超链接
                StorageType[StorageType['hyperlink'] = 256] = 'hyperlink';
            })(StorageType = exports.StorageType || (exports.StorageType = {}));

            // 指定在标题中显示哪些默认标签
            var HeaderAutoText;
            (function (HeaderAutoText) {
                // 空白
                HeaderAutoText[HeaderAutoText['blank'] = 0] = 'blank';
                // 数字
                HeaderAutoText[HeaderAutoText['numbers'] = 1] = 'numbers';
                // 字母
                HeaderAutoText[HeaderAutoText['letters'] = 2] = 'letters';
            })(HeaderAutoText = exports.HeaderAutoText || (exports.HeaderAutoText = {}));

            // 定义引发“范围改变”事件的操作类型
            var RangeChangedAction;
            (function (RangeChangedAction) {
                // 拖放
                RangeChangedAction[RangeChangedAction['dragDrop'] = 0] = 'dragDrop';
                // 拖动填充
                RangeChangedAction[RangeChangedAction['dragFill'] = 1] = 'dragFill';
                // 清空
                RangeChangedAction[RangeChangedAction['clear'] = 2] = 'clear';
                // 黏贴
                RangeChangedAction[RangeChangedAction['paste'] = 3] = 'paste';
                // 排序
                RangeChangedAction[RangeChangedAction['sort'] = 4] = 'sort';
                // 设置数组公式
                RangeChangedAction[RangeChangedAction['setArrayFormula'] = 5] = 'setArrayFormula';
                // 计算公式
                RangeChangedAction[RangeChangedAction['evaluateFormula'] = 6] = 'evaluateFormula';
            })(RangeChangedAction = exports.RangeChangedAction || (exports.RangeChangedAction = {}));

            var ValueType;
            (function (ValueType) {
                ValueType[ValueType['normal'] = 0] = 'normal';
                ValueType[ValueType['richText'] = 1] = 'richText';
            })(ValueType = exports.ValueType || (exports.ValueType = {}));

            // 定义背景图像布局
            var ImageLayout;
            (function (ImageLayout) {
                // 填充该区域
                ImageLayout[ImageLayout['stretch'] = 0] = 'stretch';
                // 显示在区域的中心
                ImageLayout[ImageLayout['center'] = 1] = 'center';
                // 以其原始纵横比显示在区域中
                ImageLayout[ImageLayout['zoom'] = 2] = 'zoom';
                // 以其原始大小显示在区域的左上角
                ImageLayout[ImageLayout['none'] = 3] = 'none';
            })(ImageLayout = exports.ImageLayout || (exports.ImageLayout = {}));

            // 
            var _ThumbButtonElement;
            (function (_ThumbButtonElement) {
                _ThumbButtonElement['ThumbButton'] = 'thumbButton';
                _ThumbButtonElement['TrackButton'] = 'trackButton';
                _ThumbButtonElement['LeftButton'] = 'leftButton';
                _ThumbButtonElement['RightButton'] = 'rightButton';
                _ThumbButtonElement['UpButton'] = 'upButton';
                _ThumbButtonElement['DownButton'] = 'downButton';
            })(_ThumbButtonElement = exports._ThumbButtonElement || (exports._ThumbButtonElement = {}));

            // 
            var HorizontalPosition;
            (function (HorizontalPosition) {
                HorizontalPosition[HorizontalPosition['left'] = 0] = 'left';
                HorizontalPosition[HorizontalPosition['center'] = 1] = 'center';
                HorizontalPosition[HorizontalPosition['right'] = 2] = 'right';
                HorizontalPosition[HorizontalPosition['nearest'] = 3] = 'nearest';
            })(HorizontalPosition = exports.HorizontalPosition || (exports.HorizontalPosition = {}));

            var VerticalPosition;
            (function (VerticalPosition) {
                VerticalPosition[VerticalPosition['top'] = 0] = 'top';
                VerticalPosition[VerticalPosition['center'] = 1] = 'center';
                VerticalPosition[VerticalPosition['bottom'] = 2] = 'bottom';
                VerticalPosition[VerticalPosition['nearest'] = 3] = 'nearest';
            })(VerticalPosition = exports.VerticalPosition || (exports.VerticalPosition = {}));

            // 在表格中的区域
            var SheetArea;
            (function (SheetArea) {
                // 左上角
                SheetArea[SheetArea['corner'] = 0] = 'corner';
                // 列标题
                SheetArea[SheetArea['colHeader'] = 1] = 'colHeader';
                // 行标题
                SheetArea[SheetArea['rowHeader'] = 2] = 'rowHeader';
                // 视口
                SheetArea[SheetArea['viewport'] = 3] = 'viewport';
            })(SheetArea = exports.SheetArea || (exports.SheetArea = {}));

            var SortState;
            (function (SortState) {
                SortState[SortState['none'] = 0] = 'none';
                SortState[SortState['ascending'] = 1] = 'ascending';
                SortState[SortState['descending'] = 2] = 'descending';
            })(SortState = exports.SortState || (exports.SortState = {}));

            var CellStatesType;
            (function (CellStatesType) {
                // 当鼠标悬停在单元格上时，单元格状态包括“悬停”状态。
                CellStatesType[CellStatesType['hover'] = 1] = 'hover';
                // 当数据验证条件求值失败时，单元格状态包括“无效”状态。
                CellStatesType[CellStatesType['invalid'] = 2] = 'invalid';
                // 当单元格锁定在保护工作表中时，单元格状态包括“只读”状态。
                CellStatesType[CellStatesType['readonly'] = 4] = 'readonly';
                // 编辑单元格时，单元格状态包括“编辑”状态。
                CellStatesType[CellStatesType['edit'] = 8] = 'edit';
                // 当单元格是焦点时，单元格状态包括“活动”状态
                CellStatesType[CellStatesType['active'] = 16] = 'active';
                // 当单元格在选择范围内时，单元格状态包括“选定”状态。
                CellStatesType[CellStatesType['selected'] = 32] = 'selected';
                // 当单元格值更改时，单元格状态包括“脏”状态。
                CellStatesType[CellStatesType['dirty'] = 64] = 'dirty';
            })(CellStatesType = exports.CellStatesType || (exports.CellStatesType = {}));

            var StatesType;
            (function (StatesType) {
                StatesType[StatesType['hover'] = 1] = 'hover';
                StatesType[StatesType['invalid'] = 2] = 'invalid';
                StatesType[StatesType['readonly'] = 4] = 'readonly';
                StatesType[StatesType['edit'] = 8] = 'edit';
                StatesType[StatesType['active'] = 16] = 'active';
                StatesType[StatesType['selected'] = 32] = 'selected';
                StatesType[StatesType['dirty'] = 64] = 'dirty';
                StatesType[StatesType['inserted'] = 128] = 'inserted';
                StatesType[StatesType['updated'] = 256] = 'updated';
            })(StatesType = exports.StatesType || (exports.StatesType = {}));

            var ButtonVisibility;
            (function (ButtonVisibility) {
                // 始终可见
                ButtonVisibility[ButtonVisibility['always'] = 0] = 'always';
                // 单元格处于活动状态时可见的单元格按钮
                ButtonVisibility[ButtonVisibility['onSelected'] = 1] = 'onSelected';
                // 单元格进入编辑时可见的单元格按钮
                ButtonVisibility[ButtonVisibility['onEditing'] = 2] = 'onEditing';
            })(ButtonVisibility = exports.ButtonVisibility || (exports.ButtonVisibility = {}));

            var ButtonImageType;
            (function (ButtonImageType) {
                ButtonImageType[ButtonImageType['none'] = 0] = 'none';
                // 自定义
                ButtonImageType[ButtonImageType['custom'] = 1] = 'custom';
                // 清除
                ButtonImageType[ButtonImageType['clear'] = 2] = 'clear';
                // 取消
                ButtonImageType[ButtonImageType['cancel'] = 3] = 'cancel';
                ButtonImageType[ButtonImageType['ok'] = 4] = 'ok';
                // 下拉框
                ButtonImageType[ButtonImageType['dropdown'] = 5] = 'dropdown';
                // 省略号
                ButtonImageType[ButtonImageType['ellipsis'] = 6] = 'ellipsis';
                ButtonImageType[ButtonImageType['left'] = 7] = 'left';
                ButtonImageType[ButtonImageType['right'] = 8] = 'right';
                ButtonImageType[ButtonImageType['plus'] = 9] = 'plus';
                ButtonImageType[ButtonImageType['minus'] = 10] = 'minus';
                ButtonImageType[ButtonImageType['undo'] = 11] = 'undo';
                ButtonImageType[ButtonImageType['redo'] = 12] = 'redo';
                // 搜索
                ButtonImageType[ButtonImageType['search'] = 13] = 'search';
                // 分隔符
                ButtonImageType[ButtonImageType['separator'] = 14] = 'separator';
                // 向左旋转
                ButtonImageType[ButtonImageType['spinLeft'] = 15] = 'spinLeft';
                // 向右旋转
                ButtonImageType[ButtonImageType['spinRight'] = 16] = 'spinRight';
                // 折叠
                ButtonImageType[ButtonImageType['collapse'] = 17] = 'collapse';
                // 展开
                ButtonImageType[ButtonImageType['expand'] = 18] = 'expand';
                // 日历
                ButtonImageType[ButtonImageType['calendar'] = 51] = 'calendar';
            })(ButtonImageType = exports.ButtonImageType || (exports.ButtonImageType = {}));
            ButtonImageType.calcel = ButtonImageType.cancel;

            // 指定下拉列表的类型。
            var DropDownType;
            (function (DropDownType) {
                // 颜色选择器
                DropDownType[DropDownType['colorPicker'] = 0] = 'colorPicker';
                // 日期时间选择器
                DropDownType[DropDownType['dateTimePicker'] = 1] = 'dateTimePicker';
                // 时间选择器
                DropDownType[DropDownType['timePicker'] = 2] = 'timePicker';
                // 月份选择器
                DropDownType[DropDownType['monthPicker'] = 3] = 'monthPicker';
                // 列表
                DropDownType[DropDownType['list'] = 4] = 'list';
                // 滑块
                DropDownType[DropDownType['slider'] = 5] = 'slider';
                // 计算器
                DropDownType[DropDownType['calculator'] = 6] = 'calculator';
                // 工作流列表
                DropDownType[DropDownType['workflowList'] = 7] = 'workflowList';
                // 多列
                DropDownType[DropDownType['multiColumn'] = 8] = 'multiColumn';
            })(DropDownType = exports.DropDownType || (exports.DropDownType = {}));

            var ButtonPosition;
            (function (ButtonPosition) {
                ButtonPosition[ButtonPosition['left'] = 0] = 'left';
                ButtonPosition[ButtonPosition['right'] = 1] = 'right';
                ButtonPosition[ButtonPosition['leftOfText'] = 2] = 'leftOfText';
                ButtonPosition[ButtonPosition['rightOfText'] = 3] = 'rightOfText';
            })(ButtonPosition = exports.ButtonPosition || (exports.ButtonPosition = {}));

            // 标题对齐方式
            var CaptionAlignment;
            (function (CaptionAlignment) {
                CaptionAlignment[CaptionAlignment['left'] = 0] = 'left';
                CaptionAlignment[CaptionAlignment['right'] = 1] = 'right';
            })(CaptionAlignment = exports.CaptionAlignment || (exports.CaptionAlignment = {}));

            // 布局方向
            var LayoutDirection;
            (function (LayoutDirection) {
                LayoutDirection[LayoutDirection['horizontal'] = 0] = 'horizontal';
                LayoutDirection[LayoutDirection['vertical'] = 1] = 'vertical';
            })(LayoutDirection = exports.LayoutDirection || (exports.LayoutDirection = {}));

            // 布局显示
            var LayoutDisplayAs;
            (function (LayoutDisplayAs) {
                // 线性
                LayoutDisplayAs[LayoutDisplayAs['inline'] = 0] = 'inline';
                // 弹出窗口
                LayoutDisplayAs[LayoutDisplayAs['popup'] = 1] = 'popup';
                // 树
                LayoutDisplayAs[LayoutDisplayAs['tree'] = 2] = 'tree';
            })(LayoutDisplayAs = exports.LayoutDisplayAs || (exports.LayoutDisplayAs = {}));

            var CalendarPage;
            (function (CalendarPage) {
                CalendarPage[CalendarPage['year'] = 1] = 'year';
                CalendarPage[CalendarPage['month'] = 2] = 'month';
                CalendarPage[CalendarPage['day'] = 3] = 'day';
            })(CalendarPage = exports.CalendarPage || (exports.CalendarPage = {}));

            var CalendarStartDay;
            (function (CalendarStartDay) {
                CalendarStartDay[CalendarStartDay['monday'] = 1] = 'monday';
                CalendarStartDay[CalendarStartDay['tuesday'] = 2] = 'tuesday';
                CalendarStartDay[CalendarStartDay['wednesday'] = 3] = 'wednesday';
                CalendarStartDay[CalendarStartDay['thursday'] = 4] = 'thursday';
                CalendarStartDay[CalendarStartDay['friday'] = 5] = 'friday';
                CalendarStartDay[CalendarStartDay['saturday'] = 6] = 'saturday';
                CalendarStartDay[CalendarStartDay['sunday'] = 7] = 'sunday';
            })(CalendarStartDay = exports.CalendarStartDay || (exports.CalendarStartDay = {}));

            // 按组排序时的方法
            var GroupSort;
            (function (GroupSort) {
                // 排序不移动组
                GroupSort[GroupSort['none'] = 0] = 'none';
                // 移动组的排序
                GroupSort[GroupSort['group'] = 1] = 'group';
                // 仅在组内部排序
                GroupSort[GroupSort['child'] = 2] = 'child';
                // 对组和组内部进行排序
                GroupSort[GroupSort['full'] = 3] = 'full';
            })(GroupSort = exports.GroupSort || (exports.GroupSort = {}));

            var DropdownListValue;
            (function (DropdownListValue) {
                DropdownListValue[DropdownListValue['string'] = 0] = 'string';
                DropdownListValue[DropdownListValue['array'] = 1] = 'array';
            })(DropdownListValue = exports.DropdownListValue || (exports.DropdownListValue = {}));

            // 指定下拉列表结果的单元格值类型
            var PatternType;
            (function (PatternType) {
                PatternType[PatternType['solid'] = 1] = 'solid';
                PatternType[PatternType['darkGray'] = 2] = 'darkGray';
                PatternType[PatternType['mediumGray'] = 3] = 'mediumGray';
                PatternType[PatternType['lightGray'] = 4] = 'lightGray';
                PatternType[PatternType['gray125'] = 5] = 'gray125';
                PatternType[PatternType['gray0625'] = 6] = 'gray0625';
                PatternType[PatternType['darkHorizontal'] = 7] = 'darkHorizontal';
                PatternType[PatternType['darkVertical'] = 8] = 'darkVertical';
                PatternType[PatternType['darkDown'] = 9] = 'darkDown';
                PatternType[PatternType['darkUp'] = 10] = 'darkUp';
                PatternType[PatternType['darkGrid'] = 11] = 'darkGrid';
                PatternType[PatternType['darkTrellis'] = 12] = 'darkTrellis';
                PatternType[PatternType['lightHorizontal'] = 13] = 'lightHorizontal';
                PatternType[PatternType['lightVertical'] = 14] = 'lightVertical';
                PatternType[PatternType['lightDown'] = 15] = 'lightDown';
                PatternType[PatternType['lightUp'] = 16] = 'lightUp';
                PatternType[PatternType['lightGrid'] = 17] = 'lightGrid';
                PatternType[PatternType['lightTrellis'] = 18] = 'lightTrellis';
            })(PatternType = exports.PatternType || (exports.PatternType = {}));

            // 当日期/数字数据宽度大于列宽时，更改显示模式
            var NumbersFitMode;
            (function (NumbersFitMode) {
                // 将数据内容替换为“###”并显示提示
                NumbersFitMode[NumbersFitMode['mask'] = 0] = 'mask';
                // 将数据内容显示为字符串，如果下一个单元格为空，则溢出内容。
                NumbersFitMode[NumbersFitMode['overflow'] = 1] = 'overflow';
            })(NumbersFitMode = exports.NumbersFitMode || (exports.NumbersFitMode = {}));

            // 指定选项卡条相对于工作簿的位置
            var TabStripPosition;
            (function (TabStripPosition) {
                TabStripPosition[TabStripPosition['bottom'] = 0] = 'bottom';
                TabStripPosition[TabStripPosition['top'] = 1] = 'top';
                TabStripPosition[TabStripPosition['left'] = 2] = 'left';
                TabStripPosition[TabStripPosition['right'] = 3] = 'right';
            })(TabStripPosition = exports.TabStripPosition || (exports.TabStripPosition = {}));

            // 演示用户打开超链接文档的方式。默认值为空
            var HyperlinkTargetType;
            (function (HyperlinkTargetType) {
                HyperlinkTargetType[HyperlinkTargetType['blank'] = 0] = 'blank';
                HyperlinkTargetType[HyperlinkTargetType['self'] = 1] = 'self';
                HyperlinkTargetType[HyperlinkTargetType['parent'] = 2] = 'parent';
                HyperlinkTargetType[HyperlinkTargetType['top'] = 3] = 'top';
            })(HyperlinkTargetType = exports.HyperlinkTargetType || (exports.HyperlinkTargetType = {}));

            // 显示图纸选项卡的类型
            var SheetType;
            (function (SheetType) {
                SheetType[SheetType['tableSheet'] = 0] = 'tableSheet';
            })(SheetType = exports.SheetType || (exports.SheetType = {}));
        }),
        './dist/core/core.ns.js': (function (module, exports, __webpack_require__) {
            Object.defineProperty(exports, '__esModule', { value: true });
            var en = __webpack_require__(/*! ./core.res.en */ './dist/core/core.res.en.js');
            exports.SR = {
                en: en
            };
        }),
        './dist/core/core.res.en.js': (function (module, exports, __webpack_require__) {
            Object.defineProperty(exports, '__esModule', { value: true });
            exports.Exp_NotSupported = 'NotSupportException';
            exports.Exp_PasteExtentIsNull = 'pasteExtent is null';
            exports.Exp_InvalidPastedArea = 'The pasted area should have the same size as the copy or cut area.';
            exports.Exp_MultipleSelections = 'This action won\'t work on multiple selections.';
            exports.Exp_ChangePartOfArray = 'Cannot change part of an array.';
            exports.Exp_InvalidAndSpace = 'Invalid {0}: {1} (must be between {2} and {3}).';
            exports.Exp_SrcIsNull = 'The argument \'src\' is null';
            exports.Exp_DestIsNull = 'The argument \'dest\' is null';
            exports.Exp_InvalidCustomFunction = 'invalid custom function';
            exports.Exp_InvalidCustomName = 'invalid custom name';
            exports.Exp_IndexOutOfRange = 'Index is out of range!';
            exports.Exp_InvalidRange = 'Invalid range';
            exports.Exp_NotAFunction = 'Not A Function';
            exports.Exp_ArgumentOutOfRange = 'ArgumentOutOfRange';
            exports.Exp_PasteSourceCellsLocked = 'Source sheet\'s cells are locked.';
            exports.Exp_InvalidCopyPasteSize = 'The copy and paste areas are not the same size.';
            exports.Exp_PasteDestinationCellsLocked = 'The cell you are trying to change is protected and therefore read-only.';
            exports.Exp_PasteChangeMergeCell = 'Cannot change part of a merged cell.';
            exports.Tip_Row = 'Row: ';
            exports.Tip_Column = 'Column: ';
            exports.Tip_Height = 'Height: {0} pixels';
            exports.Tip_Width = 'Width: {0} pixels';
            exports.NewTab = 'New...';
            exports.Exp_EmptyNamedStyle = 'The name of named style cannot be empty or null';
            exports.Exp_SheetNameInvalid = 'The sheet name can not be blank or contains these characters : *, :, [, ], ?, \\, /';
            exports.Exp_SheetNameConflict = 'That name is already taken. Try a different one.';
            exports.Exp_ArrayFormulaSpan = 'Array formulas are not valid in merged cells.';
            exports.Exp_DestSheetIsNull = 'destSheet is null';
            exports.Exp_SheetIsNull = 'sheet is null.';
            exports.Exp_OverlappingSpans = 'This operation will cause overlapping spans.';
            exports.NeedCanvasSupport = 'You need a browser which full supports HTML5 Canvas to run SpreadJS';
            exports.ARIA_Resize = 'resize';
            exports.ARIA_First = 'first';
            exports.ARIA_PreviousArrow = 'previous arrow';
            exports.ARIA_NextArrow = 'next arrow';
            exports.ARIA_Last = 'last';
            exports.ARIA_PreviousButton = 'previous button';
            exports.ARIA_NextButton = 'next button';
            exports.ARIA_SheetTab = 'sheet tab';
            exports.ARIA_NewSheet = 'new sheet';
            exports.ARIA_Blank = 'blank';
            exports.ARIA_Scrollbar_Left_Button = 'scrollbar left button';
            exports.ARIA_Scrollbar_Top_Button = 'scrollbar top button';
            exports.ARIA_Scrollbar_Thumb_Button = 'scrollbar thumb button';
            exports.ARIA_Scrollbar_Right_Button = 'scrollbar right button';
            exports.ARIA_Scrollbar_Bottom_Button = 'scrollbar bottom button';
            exports.ARIA_Scrollbar_TRACK_Button = 'scrollbar track button';
            exports.ARIA_Cell = 'cell';
            exports.ARIA_HasValue = 'has value {0}';
            exports.ARIA_HasFormula = 'has formula {0}';
            exports.ARIA_HasComment = 'has comment {0}';
            exports.ARIA_RowHeader = 'row header';
            exports.ARIA_ColumnHeader = 'column header';
            exports.SHEET_NAME = 'Sheet';
            exports.lsru = ['', '6465706c6f796d656e74'];
            exports.lsde = ['', '64657369676e6572'];
            exports.ls1 = ['', '506f776572656420627920477261706543697479205370726561644a532e0d0a596f752063616e206f6e6c79206465706c6f792074686973204556414c554154494f4e2076657273696f6e206c6f63616c6c792e0d0a54656d706f72617279207b317d206b6579732061726520617661696c61626c6520666f722074657374696e672e0d0a456d61696c2075732e73616c6573406772617065636974792e636f6d2e'];
            exports.ls2 = ['', '506f776572656420627920477261706543697479205370726561644a532e0d0a596f75722074656d706f72617279207b317d206b6579206578706972657320696e207b307d206461792873292e'];
            exports.ls3 = ['', '4c6963656e7365204e6f7420466f756e640d0a596f75206e65656420612076616c6964206c6963656e7365206b657920746f2072756e205370726561644a532e0d0a54656d706f72617279206b6579732061726520617661696c61626c6520666f72206576616c756174696f6e2e0d0a496620796f75207075726368617365642061206c6963656e73652c20796f7572206b657920697320696e20796f757220707572636861736520636f6e6669726d6174696f6e20656d61696c2e0d0a456d61696c2075732e73616c6573406772617065636974792e636f6d20696620796f75206e65656420617373697374616e6365206f7220726571756573742061206b6579206174206763676f2e746f2f736a736b65792e'];
            exports.ls4 = ['', '496e76616c6964206c6963656e7365206b65792e20456d61696c2075732e73616c6573406772617065636974792e636f6d20696620796f75206e6565642068656c702e'];
            exports.ls5 = ['', '506f776572656420627920477261706543697479205370726561644a532e0d0a596f75722074656d706f72617279207b317d206b65792068617320657870697265642e0d0a456d61696c2075732e73616c6573406772617065636974792e636f6d20666f722068656c702e'];
            exports.ls6 = ['', '506f776572656420627920477261706543697479205370726561644a53204576616c756174696f6e2056657273696f6e0d0a4e6f74204c6963656e73656420666f7220446973747269627574696f6e'];
            exports.ls7 = ['', '457863656c20494f204c6963656e7365204e6f7420466f756e640d0a596f75206e65656420612076616c6964206c6963656e7365206b657920746f2072756e205370726561644a5320457863656c20494f2e2054656d706f72617279206b6579732061726520617661696c61626c6520666f72206576616c756174696f6e2e20496620796f75207075726368617365642061206c6963656e73652c20796f7572206b657920697320696e20796f757220707572636861736520636f6e6669726d6174696f6e20656d61696c2e20456d61696c2075732e73616c6573406772617065636974792e636f6d20696620796f75206e65656420617373697374616e63652e'];
            exports.ls8 = ['', '496e76616c696420457863656c20494f206c6963656e7365206b65792e200d0a456d61696c2075732e73616c6573406772617065636974792e636f6d20696620796f75206e65656420617373697374616e63652e'];
            exports.Exp_InsertCopiedCutCells = 'This selection is not valid. The copy/paste area must be the same size';
            exports.Exp_InsertCopiedCutCellsOnSpanTable = 'This won\u2019t work because it would move cells in a table on your worksheet or will cause some merged cells to unmerge.';
            exports.Exp_InsertCopiedCutCellsNoRange = 'New cells can not be inserted as there are non-empty cells that would extend beyond the worksheet.';
            exports.Exp_InvalidSortArrayFormulaInRange = 'Can\'t sort current range as array formula exist.';
            exports.Exp_InvalidSortSpanInRange = 'Can\'t sort current range as span exist.';
            exports.Exp_InvalidSortPartTableOrMultiTableInRange = 'Can\'t sort current range as part table or more than one table exist.';
        }),
        './dist/core/lc/debugLc.js': (function (module, exports, __webpack_require__) {
            Object.defineProperty(exports, '__esModule', { value: true });
            var domUtil_1 = __webpack_require__(/*! ../util/domUtil */ './dist/core/util/domUtil.js');
            var sd = domUtil_1.GC$.sd;
            domUtil_1.GC$[sd] = function (obj) { };
            function _pri() { }
            exports._pri = _pri;
            exports._pt = 0;
        }),
        './dist/core/util/basedialog.js': (function (module, exports, __webpack_require__) {
            Object.defineProperty(exports, '__esModule', { value: true });
            var common_1 = __webpack_require__(/*! ./common */ './dist/core/util/common.js');
            var domUtil_1 = __webpack_require__(/*! ./domUtil */ './dist/core/util/domUtil.js');
            var $ = domUtil_1.GC$;
            var createElement = common_1.util._createElement;
            var browser = common_1.util._browser;
            var cancelDefault = common_1.util._cancelDefault;
            var DOCUMENT = document;
            var WINDOW = window;
            var gcGlobal = WINDOW._gcGlobal;
            var _BaseDialog = (function () {
                function _BaseDialog(host, zindex, isModal) {
                    this._gcPopupClass = 'gc-popup';
                    this._overlayClass = 'gc-overlay';
                    this._overlay = null;
                    var self = this;
                    self._host = host;
                    self._isModal = isModal;
                    zindex = zindex || 0;
                    self._defaultOverlayCSS = {
                        position: 'fixed',
                        width: '100%',
                        height: '100%',
                        margin: 0,
                        padding: 0,
                        top: 0,
                        left: 0,
                        border: 'none',
                        zIndex: zindex,
                        backgroundColor: 'rgba(0,0,0,0)'
                    };
                    self._defaultContainerCSS = {
                        position: 'absolute',
                        padding: 0,
                        margin: 0,
                        height: 'auto',
                        zIndex: zindex + 1,
                        outline: 'none'
                    };
                    self._init();
                }
                _BaseDialog.prototype._init = function () {
                    var self = this;
                    if (!self._hasTargetContainer(self._name)) {
                        self._name = self._generateName();
                        self._container = $(createElement('div')).addClass(self._gcPopupClass + ' ui-widget').attr({
                            id: self._name,
                            tabIndex: -1
                        }).css(self._defaultContainerCSS);
                    } else {
                        self._container = $('#' + self._name);
                    }
                };
                _BaseDialog.prototype._generateName = function () {
                    var num = 0;
                    var prefix = 'gc-dialog';
                    while (this._hasTargetContainer(prefix + num.toString())) {
                        num++;
                    }
                    return prefix + num.toString();
                };
                _BaseDialog.prototype._getContainer = function () {
                    if (this._container) {
                        return this._container;
                    }
                };
                _BaseDialog.prototype._getHost = function () {
                    if (this._host) {
                        return this._host;
                    }
                    return DOCUMENT.body;
                };
                _BaseDialog.prototype._show = function (callback) {
                    var self = this;
                    var container = self._container;
                    if (!self._hasOverlay()) {
                        self._createOverlay();
                    }
                    gcGlobal._suspendEvent();
                    if (!self._hasTargetContainer(self._name)) {
                        $(self._getHost()).append(container);
                        self._resetDialogPosition();
                        container.css('display', 'none');
                    }
                    container.show(callback);
                };
                _BaseDialog.prototype._isShow = function () {
                    return this._container.css('display') === 'block';
                };
                _BaseDialog.prototype.close = function () {
                    var self = this;
                    if (self._hasTargetContainer(self._name)) {
                        self._container.remove();
                    }
                    if (!$('.' + self._gcPopupClass).isVisible()) {
                        self._closeOverlay();
                    }
                    gcGlobal._resumeEvent();
                };
                _BaseDialog.prototype._closeOverlay = function () {
                    $('.' + this._overlayClass).remove();
                    this._overlay = null;
                };
                _BaseDialog.prototype._resetDialogPosition = function () {
                    var container = this._container;
                    var host = this._getHost();
                    if (container.length === 0) {
                        return;
                    }
                    var hostOffset = $(host).offset();
                    var left = parseInt(container.css('left'), 10) + hostOffset.left;
                    var top = parseInt(container.css('top'), 10) + hostOffset.top;
                    var dialogWidth = container.width();
                    var dialogHeight = container.height();
                    if (isNaN(left) || isNaN(top) || isNaN(dialogWidth) || isNaN(dialogHeight)) {
                        return;
                    }
                    var bottomCross = 0;
                    var rightCross = 0;
                    var docElement = DOCUMENT.documentElement;
                    var clientWidth = docElement.clientWidth;
                    var clientHeight = docElement.clientHeight;
                    var pos = container[0].getBoundingClientRect();
                    if (pos.left + dialogWidth > clientWidth) {
                        rightCross = pos.left + dialogWidth - clientWidth;
                    }
                    if (pos.top + dialogHeight > clientHeight) {
                        bottomCross = pos.top + dialogHeight - clientHeight;
                    }
                    if (left < 0 || top < 0 || bottomCross > 0 || rightCross > 0) {
                        left -= rightCross;
                        top -= bottomCross;
                        if (left < 0) {
                            left = 0;
                        }
                        if (top < 0) {
                            top = 0;
                        }
                        container.css({
                            left: (left - hostOffset.left) + 'px',
                            top: (top - hostOffset.top) + 'px'
                        });
                    }
                };
                _BaseDialog.prototype._hasTargetContainer = function (target) {
                    return $('#' + target).length > 0;
                };
                _BaseDialog.prototype._createOverlay = function () {
                    var self = this;
                    var overlay = $(createElement('div')).addClass(self._overlayClass);
                    var container = self._container;
                    this._overlay = overlay;
                    overlay.css(self._defaultOverlayCSS);
                    $(self._host).append(overlay);
                    var isFirefox = browser && browser.mozilla;
                    var openTime;
                    if (isFirefox) {
                        openTime = new Date().valueOf();
                    }
                    overlay.bind('mousedown', function (e) {
                        if (!self._isModal) {
                            if (isFirefox) {
                                var closeTime = new Date().valueOf();
                                if (closeTime - openTime < 100) {
                                    return;
                                }
                            }
                            self.close();
                            if (isFirefox && self._delayCloseTimeout) {
                                clearTimeout(self._delayCloseTimeout);
                            }
                        }
                        cancelDefault(e);
                    });
                    overlay.bind('contextmenu', function (e) {
                        if (self._isModal) {
                            cancelDefault(e);
                        }
                    });
                    container.bind('contextmenu', function (e) {
                        cancelDefault(e);
                    });
                    'touchstart MSPointerDown pointerdown'.split(' ').forEach(function (value) {
                        overlay.bind(value, function (e) {
                            if (!self._isModal) {
                                if (isFirefox) {
                                    self._delayCloseTimeout = WINDOW.setTimeout(function () {
                                        self.close();
                                    }, 100);
                                } else {
                                    self.close();
                                }
                            }
                            cancelDefault(e);
                        });
                    });
                };
                _BaseDialog.prototype._hasOverlay = function () {
                    return $('.' + this._overlayClass).length > 0;
                };
                return _BaseDialog;
            }());
            exports._BaseDialog = _BaseDialog;
        }),
        './dist/core/util/common.js': (function (module, exports, __webpack_require__) {
            Object.defineProperty(exports, '__esModule', { value: true });
            var Common_1 = __webpack_require__(/*! Common */ 'Common');
            var domUtil_1 = __webpack_require__(/*! ./domUtil */ './dist/core/util/domUtil.js');
            var core_ns_1 = __webpack_require__(/*! ../core.ns */ './dist/core/core.ns.js');
            var core_enum_1 = __webpack_require__(/*! ../core.enum */ './dist/core/core.enum.js');
            var CalcEngine = __webpack_require__(/*! CalcEngine */ 'CalcEngine');
            var $$ = domUtil_1.GC$;
            var $$_extend = $$.extend;
            var _NumberHelper = Common_1.Common._NumberHelper;
            var cloneArray = Common_1.Common._ArrayHelper._clone;
            var GeneralFormatter = Common_1.Formatter && Common_1.Formatter.GeneralFormatter;
            var numberFormatDateTime = Common_1.Formatter && Common_1.Formatter._NumberFormatDateTime;
            var isNullOrUndefined = Common_1.Common._Types._isNullOrUndefined;
            var StringHelper = Common_1.Common._StringHelper;
            var rm = new Common_1.Common.ResourceManager(core_ns_1.SR);
            var getSR = rm.getResource.bind(rm);
            exports.FallbackFontFamily = '"Helvetica Neue", Arial, sans-serif';
            var WINDOW = window, DOCUMENT = document;
            var const_boolean = 'boolean';
            var const_date = 'date';
            var const_undefined = 'undefined';
            var const_function = 'function';
            var keyword_undefined = void 0;
            var keyword_null = null;
            var Math_floor = Math.floor;
            var Math_ceil = Math.ceil;
            var Math_min = Math.min;
            var Math_max = Math.max;
            var Math_round = Math.round;
            var convertToInt = parseInt;
            var convertToFloat = parseFloat;
            var isNotANumber = isNaN;
            var subscriptAndSuperscriptScale = 0.7;
            var CSS_PX = 'px';
            var SPECE_STR = ' ';
            var DOT_STR = '.';
            var const_string = 'string';
            var const_number = 'number';
            var CONST_TOUCH = 'touch';
            var MSPOINTER_TYPE_TOUCH = 'MSPOINTER_TYPE_TOUCH';
            var _jsonDateRegExp = new RegExp('^/Date\\((-?\\d+)([-+]{1}\\d+)?\\)/\\s*$');
            var _jsonOADateRegExp = new RegExp('^/OADate\\(([-+]?(\\d+(\\.\\d*)?|\\.\\d+)([eE][-+]?\\d+)?)\\)/\\s*$');
            var ZERO_WIDTH_CHAR = '\u200b';
            function isDefined(t) {
                return typeof t !== const_undefined;
            }
            function createElement(tag) {
                return DOCUMENT.createElement(tag);
            }
            function documentInsertBefore(element) {
                DOCUMENT.body && DOCUMENT.body.insertBefore(element, keyword_null);
            }
            function defineProperty(obj, pn, callback) {
                Object.defineProperty(obj, pn, {
                    get: function () {
                        return this._ps[pn];
                    },
                    set: function (value) {
                        var old = this._ps[pn];
                        if (old !== value) {
                            this._ps[pn] = value;
                            if (callback) {
                                callback(pn, value, old);
                            }
                        }
                    },
                    enumerable: true
                });
            }
            exports.productInfo = {
                productVersion: '14.2.5'
            };
            // 光标资源
            exports.CursorResource = {
                ResizeCol: 'col-Resize',
                ResizeRow: 'row-resize',
                ResizeHiddenCol: 'w-resize',
                ResizeHiddenRow: 'n-resize'
            };
            // 从字符串获取类型
            exports.getTypeFromString = function (typeString) {
                var found = false;
                var t = WINDOW;
                if (typeof typeString === const_string) {
                    var arr = typeString.split(DOT_STR);
                    var i = 0;
                    var length_1 = arr.length;
                    for (; i < length_1; i++) {
                        if (!t) {
                            break;
                        }
                        t = t[arr[i]];
                    }
                    if (t && i === length_1 && length_1 > 0) {
                        found = true;
                    }
                }
                return found ? t : keyword_undefined;
            };
            // 查找控件
            exports.findControl = function (host) {
                if (typeof host === const_string) {
                    host = DOCUMENT.getElementById(host);
                }
                return $$(host).data('workbook');
            };
            function cancelDefault(e) {
                if (e.preventDefault) {
                    e.preventDefault();
                    e.stopPropagation();
                } else {
                    e.cancelBubble = false;
                    e.returnValue = false;
                }
                return false;
            }
            // 是中日韩文本
            function isCJKText(text) {
                var isCJKTextFlag = false;
                if (text) {
                    for (var i = 0; i < text.length; i++) {
                        var charCode = text.charCodeAt(i);
                        if ((charCode >= 0x2E80 && charCode < 0x2F00) ||
                            (charCode >= 0x3000 && charCode < 0xA000) ||
                            (charCode >= 0xA960 && charCode < 0xA980) ||
                            (charCode >= 0xF900 && charCode < 0xFB00)) {
                            isCJKTextFlag = true;
                            break;
                        }
                    }
                }
                return isCJKTextFlag;
            }

            var util = (function () {
                function util() { }
                // 字母索引
                util._indexToLetters = function (index) {
                    var sb = '';
                    for (; index > 0; index = parseInt((index - 1) / 26 + '', 10)) {
                        var n = (index - 1) % 26;
                        sb = String.fromCharCode(65 + n) + sb;
                    }
                    return sb;
                };
                // 按值类型获取HAlign
                util._getHAlignByValueType = function (hAlign, value, formatter, textOrientation) {
                    if (hAlign === 3) {
                        var type = $$.getType(value);
                        if (formatter && formatter === '@') {
                            hAlign = 0;
                        } else if (type === const_boolean) {
                            hAlign = 1;
                        } else if (type === const_number || type === const_date) {
                            hAlign = 2;
                        } else if (type === const_string && util._isArabic(value)) {
                            hAlign = 2;
                        } else {
                            hAlign = 0;
                        }
                        if (textOrientation && textOrientation !== 0) {
                            if (textOrientation > 0) {
                                hAlign = 0;
                            } else if (textOrientation < 0) {
                                hAlign = 2;
                            }
                            if (textOrientation === -90) {
                                hAlign = 0;
                            } else if (textOrientation === 90) {
                                hAlign = 2;
                            }
                        }
                    }
                    return hAlign;
                };
                // 是阿拉伯语数字
                util._isArabic = function (s) {
                    return util._ARABIC_REG.test(s);
                };
                util._toString = function (value) {
                    var type = $$.getType(value);
                    if (value === keyword_null || value === keyword_undefined) {
                        value = '';
                    } else if (type === const_boolean) {
                        value = value.toString().toUpperCase();
                    } else if (type === const_date) {
                        var onlyDate = value.getHours() === 0 && value.getMinutes() === 0 && value.getSeconds() === 0 && value.getMilliseconds() === 0;
                        value = Common_1.Common._DateTimeHelper._localeFormat(value, onlyDate ? 'M/d/yyyy' : 'M/d/yyyy h:mm:ss');
                    } else if (value.richText) {
                        value = util._convertRichTextValue(value);
                    } else {
                        value = value.toString();
                    }
                    return value;
                };
                // 应用背景图像布局
                util._applyBackgroundImageLayout = function (element, contentWidth, contentHeight, imgWidth, imgHeight, layout, backgroundInfo) {
                    var content = $$(element);
                    var width = contentWidth;
                    var height = contentHeight;
                    var cssBackgroundPosition = 'background-position';
                    var cssBackgroundSize = 'background-size';
                    var CSS_AUTO = 'auto';
                    var ZERO_PERCENT = '0%';
                    var FIFTY_PERCENT = '50%';
                    var A_HUNDRED_PERCENT = '100%';
                    switch (layout) {
                        case 0:
                            if (backgroundInfo) {
                                content
                                    .css(cssBackgroundPosition, backgroundInfo.position)
                                    .css(cssBackgroundSize, backgroundInfo.size);
                            } else {
                                content
                                    .css(cssBackgroundPosition, ZERO_PERCENT + SPECE_STR + ZERO_PERCENT)
                                    .css(cssBackgroundSize, A_HUNDRED_PERCENT + SPECE_STR + A_HUNDRED_PERCENT);
                            }
                            break;
                        case 1:
                            var posX = FIFTY_PERCENT;
                            var posY = FIFTY_PERCENT;
                            if (imgWidth > width) {
                                posX = ZERO_PERCENT;
                            }
                            if (imgHeight > height) {
                                posY = ZERO_PERCENT;
                            }
                            content
                                .css(cssBackgroundPosition, posX + SPECE_STR + posY)
                                .css(cssBackgroundSize, CSS_AUTO + SPECE_STR + CSS_AUTO);
                            break;
                        case 2:
                            var posX1 = 0;
                            var posY1 = 0;
                            var sizeW = width;
                            var sizeH = height;
                            if (height > 0 && imgHeight > 0 && width / height > imgWidth / imgHeight) {
                                sizeW = imgWidth / imgHeight * height;
                                posX1 = posX1 + width / 2 - sizeW / 2;
                            } else if (width > 0 && imgWidth > 0 && height / width > imgHeight / imgWidth) {
                                sizeH = imgHeight / imgWidth * width;
                                posY1 = posY1 + height / 2 - sizeH / 2;
                            }
                            content
                                .css(cssBackgroundPosition, posX1 + CSS_PX + SPECE_STR + posY1 + CSS_PX)
                                .css(cssBackgroundSize, sizeW + CSS_PX + SPECE_STR + sizeH + CSS_PX);
                            break;
                        case 3:
                            content
                                .css(cssBackgroundPosition, ZERO_PERCENT + SPECE_STR + ZERO_PERCENT)
                                .css(cssBackgroundSize, CSS_AUTO + SPECE_STR + CSS_AUTO);
                            break;
                        default:
                            break;
                    }
                };
                // 设备
                util.device = function () {
                    var ua = navigator.userAgent;
                    var result = ua.match(/iPad/i);
                    var firstMatch;
                    var isIpad;
                    var isIphone;
                    var isAndroid;
                    if (result) {
                        firstMatch = result[0];
                        if (firstMatch) {
                            isIpad = firstMatch.toLowerCase() === 'ipad';
                        }
                    } else {
                        result = ua.match(/Macintosh/i);
                        if (result) {
                            firstMatch = result[0];
                            if (firstMatch) {
                                try {
                                    document.createEvent('TouchEvent');
                                    isIpad = firstMatch.toLowerCase() === 'macintosh';
                                } catch (e) { }
                            }
                        }
                    }
                    result = ua.match(/iPhone/i);
                    if (result) {
                        firstMatch = result[0];
                        if (firstMatch) {
                            isIphone = firstMatch.toLowerCase() === 'iphone';
                        }
                    }
                    result = ua.match(/android/i);
                    if (result) {
                        firstMatch = result[0];
                        if (firstMatch) {
                            isAndroid = firstMatch.toLowerCase() === 'android';
                        }
                    }
                    return {
                        ipad: isIpad,
                        iphone: isIphone,
                        android: isAndroid
                    };
                };
                util._isMacOS = function () {
                    var platform = navigator.platform;
                    return platform && platform.indexOf('Mac') > -1;
                };
                util._isStringNumber = function (obj) {
                    if (obj === keyword_undefined || obj === keyword_null) {
                        return false;
                    }
                    var objStr = obj.toString();
                    objStr = _NumberHelper._replaceCultureSymbolToNormal(objStr);
                    return !isNotANumber(Number(objStr.trim() === '' ? NaN : objStr)) || /^[1-9]\d{0,2}(?:(,\d{3})*|\d*)(?:\.\d*)?$/.test(objStr);
                };
                util._parseText2Value = function (style, text, autoFormat, formaterRef, editingFormatter) {
                    var cellFormatter = keyword_null;
                    var needRecheck = false;
                    if (style) {
                        var formatter = style.formatter;
                        if (formatter) {
                            if (editingFormatter) {
                                cellFormatter = editingFormatter;
                            } else if (!util._isFormatString(formatter)) {
                                cellFormatter = formatter;
                                needRecheck = true;
                            }
                            if (typeof cellFormatter === const_string && GeneralFormatter) {
                                cellFormatter = new GeneralFormatter(cellFormatter);
                            }
                        } else {
                            cellFormatter = style._autoFormatter;
                        }
                    }
                    if (cellFormatter && !cellFormatter.isAuto) {
                        var customerValue = keyword_null;
                        try {
                            customerValue = cellFormatter.parse(text);
                            if (needRecheck && customerValue instanceof Date) {
                                var recheckFormatter = new GeneralFormatter().getPreferredDisplayFormatter(text, editingFormatter);
                                if (recheckFormatter) {
                                    customerValue = recheckFormatter.parse(text);
                                }
                            }
                            if (typeof customerValue === const_number) {
                                return customerValue;
                            }
                        } catch (ex) { }
                        return customerValue === keyword_undefined || customerValue === keyword_null ? text : customerValue;
                    } else if (autoFormat) {
                        var aValRef = void 0;
                        aValRef = {};
                        var aValRef_value = void 0;
                        var autoDisplayFormatter = keyword_null;
                        if (GeneralFormatter) {
                            try {
                                autoDisplayFormatter = new GeneralFormatter().getPreferredDisplayFormatter(text, aValRef);
                            } catch (ex) { }
                        }
                        aValRef_value = aValRef.value;
                        if (typeof aValRef_value === const_number) {
                            text = aValRef_value;
                        } else if (util._isStringNumber(text)) {
                            aValRef_value = aValRef.value = text;
                        }
                        if (formaterRef) {
                            formaterRef.value = autoDisplayFormatter;
                        }
                        return aValRef_value !== keyword_undefined && aValRef_value !== keyword_null ? aValRef_value : text;
                    }
                    return text;
                };
                // 获取首选ZIndex
                util._getPreferredZIndex = function (context) {
                    var body = DOCUMENT.body;
                    var element = context;
                    while (element && element.parentElement && element.parentElement !== body) {
                        element = element.parentElement;
                    }
                    var zIndex = 1000;
                    var index;
                    if (element && element.parentElement === body) {
                        index = convertToInt($$(element).css('z-index'));
                        if (!isNotANumber(index)) {
                            zIndex += index;
                        }
                    }
                    return zIndex;
                };
                // 获取线性渐变颜色
                util._getLinearGradientColors = function (backgroundImg) {
                    if (!backgroundImg) {
                        return [];
                    }
                    var colorsStart = backgroundImg.indexOf('(');
                    var colorsEnd = backgroundImg.lastIndexOf(')');
                    var colorsStr = backgroundImg.substring(colorsStart + 1, colorsEnd);
                    if (!colorsStr) {
                        return [];
                    }
                    var colorStrArray = [];
                    var searchStartIndex = 0;
                    var subStr = '';
                    var rgbStartIndex = 0;
                    var rgbEndIndex = 0;
                    while (rgbEndIndex < colorsStr.length) {
                        rgbStartIndex = colorsStr.indexOf('rgb', searchStartIndex);
                        rgbEndIndex = colorsStr.indexOf('rgb', searchStartIndex + 1);
                        if (rgbEndIndex === -1) {
                            rgbEndIndex = colorsStr.length;
                        }
                        subStr = colorsStr.substring(rgbStartIndex, rgbEndIndex);
                        colorStrArray.push(subStr);
                        searchStartIndex = rgbEndIndex;
                    }
                    var colors = [];
                    for (var i = 0, len = colorStrArray.length; i < len; i++) {
                        var temp = colorStrArray[i];
                        var rightBracketIndex = temp.indexOf(')');
                        var color = temp.substring(0, rightBracketIndex + 1);
                        var point = convertToFloat(temp.substring(rightBracketIndex + 1, temp.length));
                        if (isNotANumber(point)) {
                            if (i === len - 1) {
                                point = 100;
                            } else if (i <= 1) {
                                point = 0;
                            }
                        }
                        if (!color && i === 0) {
                            continue;
                        }
                        point = point / 100.0;
                        colors.push({
                            color: color,
                            point: point
                        });
                    }
                    return colors;
                };
                // 获取列自适应值
                util._getColumnAutoFitValue = function (col, sheet, sheetArea, autoFitType, endRowIndex) {
                    var render = sheet._render;
                    var width = 0;
                    var areas = [sheetArea];
                    var zoomFactor = sheet.zoom();
                    if (autoFitType === core_enum_1.AutoFitType.cellWithHeader) {
                        if (sheetArea === core_enum_1.SheetArea.viewport) {
                            areas.push(1);
                        } else if (sheetArea === core_enum_1.SheetArea.rowHeader) {
                            areas.push(0);
                        }
                    }
                    for (var i = 0; i < areas.length; i++) {
                        var row = 0;
                        var area = areas[i];
                        var rowCount = endRowIndex ? endRowIndex : sheet.getRowCount(area);
                        while (row >= 0 && row < rowCount) {
                            var span = sheet._modelManager.findSpan(row, col, area);
                            if (span && (span.col < col || span.colCount > 1 || span.row < row)) {
                                row = span.row + span.rowCount;
                                continue;
                            }
                            if (sheet.getRowHeight(row, area) > 0) {
                                var style = sheet.getActualStyle(row, col, area);
                                var valueWidth = 0;
                                var cellType = style.cellType || sheet._getDefaultCellType(area);
                                if (cellType) {
                                    var font = style.font || render._getDefaultFont();
                                    style.font = render._getZoomFont(font);
                                    var rowFilter = sheet.rowFilter && sheet.rowFilter();
                                    var isFilterHeader = !!(rowFilter && rowFilter._isFilterHeader(row, col, area));
                                    if (!isFilterHeader && area === 3) {
                                        var table = sheet.tables ? sheet.tables.find(row, col) : keyword_null;
                                        if (table && table.showHeader() && table.headerIndex() === row && table.rowFilter() && table.filterButtonVisible(col - table.range().col)) {
                                            isFilterHeader = true;
                                        }
                                    }
                                    var fmt = style.formatter ? style.formatter : style._autoFormatter;
                                    var context = {
                                        sheet: sheet,
                                        row: row,
                                        col: col,
                                        sheetArea: area,
                                        quotePrefix: style.quotePrefix
                                    };
                                    var formattedData = {};
                                    var value = sheet.getValue(row, col, area, core_enum_1.ValueType.richText);
                                    var formula = sheet._getTextForShowFormulasMode(row, col, sheetArea);
                                    var text = '';
                                    if (value && value.richText) {
                                        text = sheet.getText(row, col, area);
                                    } else if (!isNullOrUndefined(formula)) {
                                        text = formula;
                                    } else {
                                        text = cellType.format(value, fmt, formattedData, context);
                                    }
                                    valueWidth = cellType._getAutoFitContainerWidth(value, text, style, zoomFactor, context);
                                    if (isFilterHeader) {
                                        var filterButtonZoom = Math_min(zoomFactor, 1);
                                        var buttonWidth = convertToInt((sheet.defaults.rowHeight * filterButtonZoom).toString(), 10);
                                        valueWidth += buttonWidth;
                                    }
                                }
                                var cellButtons = style.cellButtons;
                                if (endRowIndex && cellButtons) {
                                    for (var k = 0; k < cellButtons.length; k++) {
                                        var cellButton = cellButtons[k];
                                        if (cellButton.imageSize) {
                                            valueWidth += cellButton.imageSize.width + 7;
                                        }
                                    }
                                }
                                if (valueWidth > width) {
                                    width = valueWidth;
                                }
                            }
                            if (area === core_enum_1.SheetArea.viewport) {
                                row = util._nextAutoFitRow(row, col, sheet, area);
                            } else {
                                row++;
                            }
                        }
                    }
                    if (width === 0) {
                        width = sheet.defaults.colWidth;
                    } else {
                        width += Math_ceil(3);
                    }
                    return Math_ceil(width);
                };
                // 下一个自适应行
                util._nextAutoFitRow = function (row, col, sheet, sheetArea) {
                    var nextNonNullRow = -1;
                    var rowCount = sheet.getRowCount(sheetArea);
                    for (var i = row + 1; i < rowCount; i++) {
                        var text = sheet.getText(i, col, sheetArea);
                        if (text) {
                            nextNonNullRow = i;
                            break;
                        }
                        var style = sheet.getActualStyle(i, col, sheetArea);
                        if (style && (style.cellType || (style.cellButtons && style.cellButtons.length > 0))) {
                            nextNonNullRow = i;
                            break;
                        }
                    }
                    return nextNonNullRow;
                };
                // 获取行自适应值
                util._getRowAutoFitValue = function (row, sheet, sheetArea, autoFitType) {
                    var render = sheet._render;
                    var height = 0;
                    var areas = [sheetArea];
                    var zoomFactor = sheet.zoom();
                    if (autoFitType === 1) {
                        if (sheetArea === 3) {
                            areas.push(2);
                        } else if (sheetArea === 1) {
                            areas.push(0);
                        }
                    }
                    for (var i = 0; i < areas.length; i++) {
                        sheetArea = areas[i];
                        var col = 0;
                        var colCount = sheet.getColumnCount(sheetArea);
                        while (col >= 0 && col < colCount) {
                            var span = sheet._modelManager.findSpan(row, col, sheetArea);
                            if (span && (span.row < row || span.rowCount > 1 || span.col < col)) {
                                col = span.col + span.colCount;
                                continue;
                            }
                            if (sheet.getColumnWidth(col, sheetArea) > 0) {
                                var style = sheet.getActualStyle(row, col, sheetArea);
                                var font = style.font || render._getDefaultFont();
                                style.font = render._getZoomFont(font);
                                var valueHeight = 0;
                                var cellType = sheet.getCellType(row, col, sheetArea);
                                if (cellType) {
                                    var text = sheet.getText(row, col, sheetArea);
                                    var value = sheet.getValue(row, col, sheetArea, 1);
                                    var context = {
                                        sheet: sheet,
                                        row: row,
                                        col: col,
                                        sheetArea: sheetArea
                                    };
                                    valueHeight = cellType._getAutoFitContainerHeight(value, text, style, zoomFactor, context);
                                }
                                if (valueHeight > height) {
                                    height = valueHeight;
                                }
                            }
                            if (sheetArea === 3) {
                                col = util._nextAutoFitColumn(row, col, sheet, sheetArea);
                            } else {
                                col++;
                            }
                        }
                    }
                    if (height === 0) {
                        height = sheet.defaults.rowHeight;
                    } else {
                        height += Math_ceil(3);
                    }
                    return Math_ceil(height);
                };
                // 下一个自适应整列
                util._nextAutoFitColumn = function (row, col, sheet, sheetArea) {
                    var nextNonNullCol = -1;
                    var colCount = sheet.getColumnCount(sheetArea);
                    for (var j = col + 1; j < colCount; j++) {
                        var text = sheet.getText(row, j, sheetArea);
                        if (text) {
                            nextNonNullCol = j;
                            break;
                        }
                        var style = sheet.getActualStyle(row, j, sheetArea);
                        if (style && style.cellType) {
                            nextNonNullCol = j;
                            break;
                        }
                    }
                    return nextNonNullCol;
                };
                // 格式化值转为文本
                util._formatValue2Text = function (cellStyle, value, sheet, editingFormatterRef) {
                    if (sheet) {
                        var r = sheet._activeRowIndex;
                        var c = sheet._activeColIndex;
                        var formatter = cellStyle.formatter ? cellStyle.formatter : cellStyle._autoFormatter;
                        var formatterRef = editingFormatterRef || {};
                        if (GeneralFormatter && value !== keyword_null && value !== keyword_undefined) {
                            var isNumber = void 0;
                            if (formatter && formatter.isAuto) {
                                isNumber = typeof value === const_number;
                                var isNumberString = util._isStringNumber(value);
                                if (!isNumber && isNumberString) {
                                    value = _NumberHelper._replaceCultureSymbolToNormal(value);
                                }
                                value = formatter.getPreferredEditingFormatter ? formatter.getPreferredEditingFormatter(value).format(value) : value;
                            } else {
                                if (typeof formatter === const_string && !util._isFormatString(formatter)) {
                                    formatter = new GeneralFormatter(formatter);
                                }
                                if (formatter) {
                                    try {
                                        if (value instanceof Date) {
                                            var dateTime = CalcEngine && CalcEngine.Convert._toDateTime(value);
                                            if (dateTime) {
                                                value = dateTime;
                                            }
                                            var df = Common_1.Common.CultureManager._getCultureInfo().DateTimeFormat;
                                            var oaValue = Common_1.Common._DateTimeHelper._toOADate(value);
                                            if (!numberFormatDateTime._evaluateFormat(formatter.formatString(), ['d', 'y']) && (oaValue >= 0 && oaValue < 1)) {
                                                formatter = new GeneralFormatter(df.longTimePattern);
                                            } else if (value.getHours() === 0 && value.getMinutes() === 0 && value.getSeconds() === 0 && value.getMilliseconds() === 0) {
                                                formatter = new GeneralFormatter(df.shortDatePattern);
                                            } else {
                                                formatter = new GeneralFormatter(df.shortDatePattern + SPECE_STR + df.longTimePattern);
                                            }
                                            sheet._editingTimeValue = true;
                                            value = formatter.format(value);
                                            formatterRef.formatter = formatter;
                                        } else if (typeof value === const_number) {
                                            value = _NumberHelper._replaceNormalToCultureSymbol(value.toString());
                                        }
                                    } catch (ex) {
                                        value = sheet.getText(r, c);
                                    }
                                } else {
                                    value = sheet.getText(r, c, 3);
                                }
                            }
                        }
                    }
                    if (value !== keyword_null && value !== keyword_undefined) {
                        value = util._toString(value);
                    }
                    return value;
                };
                // 格式化单元格值转化为公式文本
                util._formatCellValue2FormulaText = function (cellStyle, value, sheet, editingFormatterRef) {
                    if (sheet) {
                        var formatter = cellStyle.formatter ? cellStyle.formatter : cellStyle._autoFormatter;
                        var formatterRef = editingFormatterRef || {};
                        if (GeneralFormatter && value !== keyword_null && value !== keyword_undefined) {
                            var isNumber = void 0;
                            if (formatter && formatter.isAuto) {
                                isNumber = typeof value === const_number;
                                var isNumberString = util._isStringNumber(value);
                                if (!isNumber && isNumberString) {
                                    value = _NumberHelper._replaceCultureSymbolToNormal(value);
                                }
                                value = formatter.getPreferredEditingFormatter ? formatter.getPreferredEditingFormatter(value).format(value) : value;
                            } else {
                                if (typeof formatter === const_string && !util._isFormatString(formatter)) {
                                    formatter = new GeneralFormatter(formatter);
                                }
                                if (formatter) {
                                    try {
                                        if (value instanceof Date) {
                                            var dateTime = CalcEngine && CalcEngine.Convert._toDateTime(value);
                                            if (dateTime) {
                                                value = dateTime;
                                            }
                                            var df = Common_1.Common.CultureManager._getCultureInfo().DateTimeFormat;
                                            var oaValue = Common_1.Common._DateTimeHelper._toOADate(value);
                                            if (!numberFormatDateTime._evaluateFormat(formatter.formatString(), ['d', 'y']) && (oaValue >= 0 && oaValue < 1)) {
                                                formatter = new GeneralFormatter(df.longTimePattern);
                                            } else if (value.getHours() === 0 && value.getMinutes() === 0 && value.getSeconds() === 0 && value.getMilliseconds() === 0) {
                                                formatter = new GeneralFormatter(df.shortDatePattern);
                                            } else {
                                                formatter = new GeneralFormatter(df.shortDatePattern + SPECE_STR + df.longTimePattern);
                                            }
                                            value = formatter.format(value);
                                            formatterRef.formatter = formatter;
                                        } else if (typeof value === const_number) {
                                            value = _NumberHelper._replaceNormalToCultureSymbol(value.toString());
                                        }
                                    } catch (ex) { }
                                }
                            }
                        }
                    }
                    if (value !== keyword_null && value !== keyword_undefined) {
                        value = util._toString(value);
                    }
                    return value;
                };
                // 获取公式文本框值
                util._getFormulaTextBoxValue = function (sheet, row, col) {
                    var text = '';
                    if (sheet) {
                        var parent_1 = sheet.parent, options = parent_1 && parent_1.options;
                        var formulaInfo = sheet.getFormulaInformation(row, col);
                        if (formulaInfo && formulaInfo.hasFormula) {
                            text = '=' + formulaInfo.formulaWithCulture;
                            if (formulaInfo.isDynamicArray) {
                                return '';
                            }
                        } else {
                            var cellStyle = sheet.getActualStyle(row, col);
                            var value = sheet.getValue(row, col);
                            if ((typeof value === 'string' && cellStyle.quotePrefix) || (text.length > 0 && text[0] === '=' && options && options.allowUserEditFormula)) {
                                text = '\'' + value;
                            } else {
                                text = util._formatCellValue2FormulaText(cellStyle, value, sheet) || '';
                            }
                        }
                    }
                    return text;
                };
                // 是否百分比格式设置工具
                util._isPercentFormatter = function (formatter, culture) {
                    var formatStrings = formatter;
                    var cultureInfo = Common_1.Common.CultureManager._getCultureInfo(culture).NumberFormat;
                    var percentSymbol = cultureInfo && cultureInfo.percentSymbol;
                    if (!percentSymbol || !formatter) {
                        return false;
                    }
                    if (typeof formatter === 'object' && formatter.formatCached) {
                        formatStrings = formatter.formatCached;
                    }
                    if (typeof formatStrings === 'object') {
                        return false;
                    }
                    if (typeof formatStrings === 'string') {
                        var parseFormat = _NumberHelper._parseCustomNumberFormatter(formatStrings);
                        return parseFormat._percent > 0;
                    }
                    return false;
                };
                // 是否ie或者edge设备
                util._isIEOrEdgeInTouchDevice = function (onlyWithMs) {
                    var isIEOrEdge = util._browser.msie || util._browser.edge;
                    var withMs = isIEOrEdge && WINDOW.MSPointerEvent && (navigator.msMaxTouchPoints || 0) > 1;
                    if (onlyWithMs) {
                        return withMs;
                    }
                    var withOutMs = isIEOrEdge && WINDOW.PointerEvent && (navigator.maxTouchPoints || 0) > 1;
                    return withMs || withOutMs;
                };
                // 转换富文本值
                util._convertRichTextValue = function (value) {
                    if (value && value.richText && value.richText.length > 0) {
                        if (!value.text) {
                            value = util._tryAddCacheToRichText(value);
                        }
                        return value.text;
                    }
                    return value;
                };
                // 尝试将缓存添加到富文本
                util._tryAddCacheToRichText = function (value) {
                    if (!value) {
                        return value;
                    }
                    var richText = value.richText;
                    if (richText && richText.length > 0) {
                        var plainTextArr = [];
                        for (var i = 0; i < richText.length; i++) {
                            plainTextArr.push(richText[i].text ? richText[i].text : '');
                        }
                        value.text = plainTextArr.join('');
                    }
                    return value;
                };
                // 是否格式字符串
                util._isFormatString = function (value) {
                    return typeof value === 'string' && (value.charAt(0) === '=' || (value.indexOf('{{') >= 0 && value.indexOf('}}') >= 0));
                };
                // 定义属性
                util._defProperty = function (propertyName, initValue, callback, valueCheck) {
                    var pname = propertyName;
                    var defValue = initValue;
                    var t;
                    t = function (value, shouldCallback) {
                        var self = this;
                        if (!self.hasOwnProperty('_ps')) {
                            self._ps = {};
                        }
                        var ps = self._ps;
                        if (arguments.length === 0) {
                            if (ps[pname] !== keyword_undefined) {
                                return ps[pname];
                            }
                            return defValue;
                        }
                        if (shouldCallback === false || (!valueCheck || valueCheck.call(self, value))) {
                            var old = ps[pname] !== keyword_undefined ? ps[pname] : defValue;
                            if (old !== value) {
                                ps[pname] = value;
                                if (shouldCallback !== false && callback) {
                                    callback.call(self, value, old);
                                }
                            }
                        }
                        return self;
                    };
                    t.isDefault = function (value) {
                        return value === defValue;
                    };
                    return t;
                };
                // 创建选项
                util._createOptions = function (pns, callback) {
                    var ops = {
                        _ps: {}
                    };
                    Common_1.Common._Types._each(pns, function (pn) {
                        defineProperty(ops, pn, callback);
                    });
                    return ops;
                };
                // 获取距离
                util._getDistance = function (sheet, index, index2, isRow, max) {
                    var start = Math_min(index, index2);
                    var end = Math_max(index, index2);
                    var total = 0;
                    for (var i = start; i < end; i++) {
                        if (isRow) {
                            total += sheet._getZoomRowHeight(i, 3);
                        } else {
                            total += sheet._getZoomColumnWidth(i, 3);
                        }
                        if (max && total > max) {
                            break;
                        }
                    }
                    return total;
                };
                // 获取可视距离
                util._getVisibleDistance = function (sheet, index, index2, isRow, max) {
                    var start = Math_min(index, index2);
                    var end = Math_max(index, index2);
                    var total = 0;
                    for (var i = start; i < end; i++) {
                        if (isRow) {
                            var viewportIndex = sheet._getRowViewportIndex(i);
                            if (sheet.getViewportTopRow(viewportIndex) <= i && sheet.getViewportBottomRow(viewportIndex) >= i) {
                                total += sheet._getZoomRowHeight(i, 3);
                            }
                        } else {
                            var viewportIndex = sheet._getColumnViewportIndex(i);
                            if (sheet.getViewportLeftColumn(viewportIndex) <= i && sheet.getViewportRightColumn(viewportIndex) >= i) {
                                total += sheet._getZoomColumnWidth(i, 3);
                            }
                        }
                        if (max && total > max) {
                            break;
                        }
                    }
                    return total;
                };
                // 获取相对偏移
                util._getRelativeOffset = function (target, element) {
                    var left = 0, top = 0;
                    if (target !== element) {
                        var targetOffset = $$(target).offset(), canvasOffset = $$(element).offset();
                        left = targetOffset.left - canvasOffset.left;
                        top = targetOffset.top - canvasOffset.top;
                    }
                    return {
                        _top: top,
                        _left: left
                    };
                };
                // 有效工作表名称
                util._isValidSheetName = function (sheetName, sheetTabs, currentSheetTab, errorMessage) {
                    var error = errorMessage || {};
                    if (!sheetName || typeof sheetName !== 'string') {
                        error.message = getSR().Exp_SheetNameInvalid;
                        return false;
                    }
                    var currentChar, i;
                    for (i = 0; i < sheetName.length; i++) {
                        currentChar = sheetName.charAt(i);
                        if (currentChar === '*' || currentChar === ':' || currentChar === '[' || currentChar === ']' ||
                            currentChar === '?' || currentChar === '\\' || currentChar === '/') {
                            error.message = getSR().Exp_SheetNameInvalid;
                            return false;
                        }
                    }
                    if (sheetName.charAt(0) === '\'' || sheetName.charAt(sheetName.length - 1) === '\'') {
                        error.message = getSR().Exp_SheetNameInvalid;
                        return false;
                    }
                    if (!sheetTabs) {
                        return true;
                    }
                    var length = sheetTabs.length;
                    for (i = 0; i < length; i++) {
                        var sheet = sheetTabs[i];
                        if (currentSheetTab !== sheet && sheetName.toUpperCase() === sheet.name().toUpperCase()) {
                            error.message = getSR().Exp_SheetNameConflict;
                            return false;
                        }
                    }
                    return true;
                };
                // 替换空格字符
                util._replaceSpaceChar = function (text, findChar, replaceChar) {
                    if (!text) {
                        return text;
                    }
                    var i = 0, length = text.length;
                    var retValueArray = [];
                    while (i < length) {
                        if (text[i] === findChar) {
                            retValueArray[i] = replaceChar;
                        } else {
                            retValueArray[i] = text[i];
                        }
                        i++;
                    }
                    return retValueArray.join('');
                };
                // 获取编辑范围
                util._getEditingSpan = function () {
                    var self = util;
                    if (!self._editingSpan) {
                        var span = createElement('span');
                        var spanStyle = span.style;
                        var NEGATIVE_TEN_THOUSANDS_PX = '-10000px';
                        spanStyle.visibility = 'hidden';
                        spanStyle.top = NEGATIVE_TEN_THOUSANDS_PX;
                        spanStyle.left = NEGATIVE_TEN_THOUSANDS_PX;
                        spanStyle.position = 'absolute';
                        span.setAttribute('gcUIElement', 'gcStringWidthSpan');
                        DOCUMENT.body.insertBefore(span, keyword_null);
                        self._editingSpan = span;
                    }
                    return self._editingSpan;
                };
                // 获取字体高度
                util._getFontHeight = function (font, ignoreCache, hasCJKText) {
                    var self = util;
                    var cache = self._fontHeightCache;
                    if (!ignoreCache) {
                        if (cache) {
                            if (hasCJKText) {
                                cache = cache.CJKFontCache;
                            }
                            var h = cache[font];
                            if (h) {
                                return h;
                            }
                        } else {
                            cache = self._fontHeightCache = {
                                CJKFontCache: {}
                            };
                            if (hasCJKText) {
                                cache = cache.CJKFontCache;
                            }
                        }
                    }
                    var htmlSpan = self._getEditingSpan();
                    htmlSpan.style.font = util._adjustFontWithFallback(font);
                    if (util._browser && util._browser.safari) {
                        htmlSpan.style.lineHeight = 'normal';
                    }
                    htmlSpan.innerHTML = hasCJKText ? String.fromCharCode(20013) : 'H';
                    var fontHeight = htmlSpan.offsetHeight;
                    if (!ignoreCache) {
                        cache[font] = fontHeight;
                    }
                    return fontHeight;
                };
                util._getFontObject = function (font) {
                    var self = util;
                    var cache = self._fontObjectCache;
                    var fontObj;
                    if (cache) {
                        if (cache[font]) {
                            return cache[font];
                        }
                    } else {
                        cache = self._fontObjectCache = {};
                    }
                    var htmlSpan = self._getEditingSpan();
                    htmlSpan.style.font = font;
                    htmlSpan.innerHTML = 'H';
                    fontObj = {};
                    fontObj.fontFamily = htmlSpan.style.fontFamily;
                    fontObj.fontSize = htmlSpan.style.fontSize;
                    fontObj.fontStyle = htmlSpan.style.fontStyle;
                    fontObj.fontWeight = htmlSpan.style.fontWeight;
                    cache[font] = fontObj;
                    return fontObj;
                };
                // 获取文本高度
                util._getTextHeight = function (text, font) {
                    var htmlSpan = util._getEditingSpan();
                    htmlSpan.style.font = util._adjustFontWithFallback(font);

                    if (util._browser && util._browser.safari) {
                        htmlSpan.style.lineHeight = 'normal';
                    }
                    htmlSpan.innerHTML = StringHelper._escapeHtml(text || 'H');
                    return htmlSpan.offsetHeight;
                };
                // 获取回退字体
                util._getFallbackFont = function (font) {
                    var self = util;
                    if (font.indexOf(exports.FallbackFontFamily) >= 0) {
                        return font;
                    }
                    font = font.replace('(' + String.fromCharCode(27491) + String.fromCharCode(25991) + ')', '')
                        .replace('(Body)', '')
                        .replace('(' + String.fromCharCode(26631) + String.fromCharCode(39064) + ')', '');
                    var htmlSpan = self._getEditingSpan(), style = htmlSpan.style;
                    style.font = font;
                    style.fontFamily = [].concat(style.fontFamily.split(','), exports.FallbackFontFamily.split(',')).join(',');
                    return style.font;
                };
                // 带回退的调整字体
                util._adjustFontWithFallback = function (font) {
                    var self = util;
                    if (!font || !self.__isMac) {
                        return font;
                    }
                    var cache = self._adjustFontCache;
                    if (!cache) {
                        cache = self._adjustFontCache = {};
                    }
                    var result = cache[font];
                    if (!result) {
                        result = cache[font] = self._getFallbackFont(font);
                    }
                    return result;
                };
                // 设置上下文字体
                util._setContextFont = function (ctx, font) {
                    if (!font) {
                        return;
                    }
                    font = util._adjustFontWithFallback(font);
                    if (ctx.font !== font) {
                        ctx.font = font;
                    }
                };
                // 测量文本宽度
                util._measureTextWidth = function (ctx, font, text) {
                    if (!font || isNullOrUndefined(text)) {
                        return 0;
                    }
                    util._setContextFont(ctx, font);
                    return ctx.measureText(text).width;
                };
                // 处置
                util._dispose = function () {
                    var self = util;
                    var span = self._editingSpan;
                    if (span) {
                        $$(span).remove();
                        self._editingSpan = keyword_undefined;
                    }
                    self._fontHeightCache = keyword_undefined;
                    self._fontObjectCache = keyword_undefined;
                    if (util._helpDiv) {
                        util._helpDiv = keyword_undefined;
                    }
                    self._adjustFontCache = keyword_undefined;
                };
                // 获取可编辑Div的值
                util._getEditableDivValue = function (editableDiv) {
                    var helpDiv = util._helpDiv;
                    if (!helpDiv) {
                        helpDiv = util._helpDiv = createElement('div');
                    }
                    var htmlContent = editableDiv.innerHTML;
                    helpDiv.innerHTML = htmlContent;
                    return helpDiv.innerText;
                };
                // 是有效的自定义名称
                util._isValidCustomName = function (name) {
                    return name && /^[A-Za-z_\\\u0080-\uFFFF][A-Za-z0-9_\.\\\?\u0080-\uFFFF]*$/.test(name) &&
                        (!(['C', 'c', 'R', 'r'].indexOf(name) !== -1 ||
                            /^[A-Za-z]{1,3}(\$)?\d+$/.test(name) ||
                            /^[Rr]\d*[Cc]\d*$/.test(name) ||
                            name.length >= 255));
                };
                // 从JSON调整条件公式
                util._adjustConditionFormulaWhenFromJSON = function (condition) {
                    if (condition) {
                        condition._setFlagForInitExpression(true);
                        condition.initExpression();
                        condition._removeFlagForInitExpression();
                    }
                };
                // 获取基线行基线列
                util._getBaseRowBaseCol = function (ranges) {
                    var baseRow = 0, baseCol = 0;
                    var length = ranges.length;
                    if (length > 0) {
                        baseRow = ranges[0].row;
                        baseCol = ranges[0].col;
                    }
                    for (var i = 1; i < length; i++) {
                        var range = ranges[i];
                        if (baseRow > range.row) {
                            baseRow = range.row;
                        }
                        if (baseCol > range.col) {
                            baseCol = range.col;
                        }
                    }
                    baseRow = baseRow < 0 ? 0 : baseRow;
                    baseCol = baseCol < 0 ? 0 : baseCol;
                    return {
                        r: baseRow,
                        c: baseCol
                    };
                };
                // 尝试将OA日期转换为日期
                util._tryConvertOADateToDate = function (t) {
                    var result;
                    if (typeof (t) === const_string && t.charAt(0) === '/') {
                        var x = void 0;
                        if (_jsonOADateRegExp.test(t)) {
                            x = t.match(_jsonOADateRegExp);
                            result = Common_1.Common._DateTimeHelper._fromOADate(convertToFloat(x[1]));
                        } else if (_jsonDateRegExp.test(t)) {
                            x = t.match(_jsonDateRegExp);
                            result = new Date(convertToFloat(x[1]));
                        } else {
                            result = t;
                        }
                    } else {
                        result = t;
                    }
                    return result;
                };
                // 尝试将日期转换为OA日期
                util._tryConvertDateToOADate = function (value) {
                    var result;
                    if (!isNullOrUndefined(value) && Common_1.Common._DateTimeHelper._isDate(value)) {
                        result = Common_1.Common._DateTimeHelper._toOADateString(value);
                    } else {
                        result = value;
                    }
                    return result;
                };
                // 应用黑白
                util._applyBlackAndWhite = function (ctx, rect) {
                    var imageData = ctx.getImageData(rect.x, rect.y, rect.width, rect.height);
                    var data = imageData.data;
                    for (var i = 0; i < data.length - 4; i += 4) {
                        var gray = Math_floor((data[i] * 30 + data[i + 1] * 59 + data[i + 2] * 11 + 50) / 100);
                        data[i] = gray;
                        data[i + 1] = gray;
                        data[i + 2] = gray;
                    }
                    ctx.putImageData(imageData, rect.x, rect.y);
                };
                // 调整表选择行列计数
                util._adjustSheetSelectionRowColumnCount = function (selection, sheetRowCount, sheetColumnCount) {
                    if (selection.rowCount > sheetRowCount) {
                        selection.rowCount = sheetRowCount;
                    }
                    if (selection.colCount > sheetColumnCount) {
                        selection.colCount = sheetColumnCount;
                    }
                };
                util._ARABIC_REG = /[\u0600-\u06FF\u0750-\u077F]/;
                util._cancelDefault = cancelDefault;
                util._device = util.device;
                util._browser = (function () {
                    function uaMatch(ua) {
                        ua = ua.toLowerCase();
                        var match = /(chrome)[ \/]([\w.]+)/.exec(ua) || /(webkit)[ \/]([\w.]+)/.exec(ua) || /(opera)(?:.*version|)[ \/]([\w.]+)/.exec(ua) || /(msie) ([\w.]+)/.exec(ua) || ua.indexOf('compatible') < 0 && /(mozilla)(?:.*? rv:([\w.]+)|)/.exec(ua) || [];
                        return {
                            browser: match[1] || '',
                            version: match[2] || '0'
                        };
                    }
                    var userAgent = navigator.userAgent;
                    var matched = uaMatch(userAgent);
                    var browser = {
                        version: keyword_undefined,
                        chrome: keyword_undefined,
                        webkit: keyword_undefined,
                        safari: keyword_undefined,
                        mozilla: keyword_undefined,
                        msie: keyword_undefined,
                        metroMode: keyword_undefined,
                        edge: keyword_undefined
                    };
                    if (matched.browser) {
                        browser[matched.browser] = true;
                        browser.version = matched.version;
                    }
                    if (browser.chrome) {
                        browser.webkit = true;
                    } else if (browser.webkit) {
                        browser.safari = true;
                    }
                    var isPhantomJS = userAgent.indexOf('PhantomJS') >= 0;
                    if (isPhantomJS) {
                        browser.safari = false;
                        browser.chrome = true;
                    }
                    var uaForIE = userAgent.toLowerCase();
                    var isIE11 = uaForIE.indexOf('compatible') < 0 && /(trident)(?:.*? rv ([\w.]+)|)/.exec(uaForIE) !== keyword_null;
                    if (isIE11) {
                        browser.mozilla = keyword_undefined;
                        browser.msie = true;
                    }
                    var result = /Edge\/\d+/.exec(userAgent);
                    if (result !== keyword_null && result.length > 0) {
                        browser.webkit = keyword_undefined;
                        browser.chrome = keyword_undefined;
                        browser.msie = true;
                        browser.edge = true;
                        browser.version = result[0].substr(result[0].indexOf('/') + 1);
                    }
                    function metrotest() {
                        var errorName = keyword_null;
                        var supported = false;
                        try {
                            new ActiveXObject('');
                        } catch (e) {
                            errorName = e.name;
                        }
                        try {
                            supported = !!new ActiveXObject('htmlfile');
                        } catch (e) {
                            supported = false;
                        }
                        if (errorName !== 'ReferenceError' && supported === false) {
                            supported = false;
                        } else {
                            supported = true;
                        }
                        return !supported;
                    }
                    if (browser.msie && metrotest()) {
                        browser.metroMode = true;
                    }
                    return browser;
                })();
                util.browser = util._browser;
                util._createElement = createElement;
                util._isDefined = isDefined;
                util._isCJKText = isCJKText;
                util.__isMac = util._isMacOS();
                util._isNeedUseSymbolFormDataType = function (value) {
                    if (!isNullOrUndefined(value)) {
                        return typeof value === const_number || typeof value === const_boolean || value instanceof Date || (CalcEngine && value instanceof CalcEngine.CalcError);
                    }
                    return false;
                };
                return util;
            }());
            exports.util = util;
            exports._util = util;
            var measureTextWidth = util._measureTextWidth;

            var _FocusHelper = (function () {
                function _FocusHelper() { }
                // 是活动元素
                _FocusHelper._isActiveElement = function (sheet) {
                    return !!(_FocusHelper._getActiveElement() === sheet && sheet._eventHandler && sheet._eventHandler._focusElem);
                };
                // 获取活动元素
                _FocusHelper._getActiveElement = function () {
                    return WINDOW && WINDOW._gcGlobal && WINDOW._gcGlobal.activeElement;
                };
                // 隐藏选择区域的实现
                _FocusHelper._hideSelectionImp = function (sheet) {
                    var layout, render, ctx;
                    function paintHeaderSelection(headerRectFunc) {
                        for (var r = 0; r <= 2; r++) {
                            var rect = headerRectFunc.call(layout, r);
                            if (rect && rect.width !== 0 && rect.height !== 0) {
                                sheet._dirty = true;
                                render._paintBody(ctx, rect);
                            }
                        }
                    }
                    if (sheet && !_FocusHelper._isActiveElement(sheet) && sheet.parent && sheet.parent.options.hideSelection) {
                        layout = sheet._getSheetLayout();
                        render = sheet._render;
                        ctx = render._getCtx();
                        var selections = sheet.getSelections();
                        var i = void 0;
                        var rect = void 0;
                        for (i = 0; i < selections.length; i++) {
                            var sel = selections[i];
                            rect = sheet._getRangeWholeRect(sel);
                            if (rect.width >= 0 && rect.height >= 0) {
                                rect.x -= 9;
                                rect.y -= 9;
                                rect.width += 18;
                                rect.height += 30;
                                render._copyDoubleBufferRect(rect);
                            }
                        }
                        rect = layout._headerCornerRect();
                        sheet._dirty = true;
                        render._paintBody(ctx, rect);
                        paintHeaderSelection(layout._rowHeaderRect);
                        paintHeaderSelection(layout._colHeaderRect);
                    }
                };
                // 设置活动元素
                _FocusHelper._setActiveElement = function (sheet, ignoreRepaintSelection) {
                    var oldActiveElement = _FocusHelper._getActiveElement();
                    WINDOW._gcGlobal.activeElement = sheet;
                    if (sheet !== oldActiveElement && !ignoreRepaintSelection) {
                        if (oldActiveElement) {
                            oldActiveElement.endEdit();
                            _FocusHelper._hideSelectionImp(oldActiveElement);
                            oldActiveElement._disposeValidationUI && oldActiveElement._disposeValidationUI();
                        }
                        if (sheet) {
                            sheet._render._repaintSelection();
                        }
                    }
                };
                return _FocusHelper;
            }());
            exports._FocusHelper = _FocusHelper;

            // 创建span元素
            function createSpanElement(className, id) {
                var t = createElement('span');
                t.className = className;
                if (id) {
                    t.id = id;
                }
                t.style.display = 'none';
                documentInsertBefore(t);
                return t;
            }
            function bindEventListener(elem, type, listener, useCapture) {
                elem.addEventListener(type, listener, useCapture);
            }
            // 获取当前样式或计算样式
            function getCurrentStyleOrComputedStyle(t) {
                var ts = t.currentStyle;
                var defaultView = DOCUMENT.defaultView;
                if (defaultView && defaultView.getComputedStyle) {
                    ts = defaultView.getComputedStyle(t, '');
                }
                return ts;
            }
            function global_keyDown(event) {
                var gcGlobal = WINDOW._gcGlobal;
                if (gcGlobal._eventSuspended > 0) {
                    return;
                }
                if (event.keyCode !== 16) {
                    gcGlobal._keyDown = true;
                }
                var activeElement = _FocusHelper._getActiveElement();
                var validationSelect = activeElement && activeElement._validationSelect;
                if (validationSelect) {
                    var $select = $$(validationSelect);
                    if ($select.isVisible()) {
                        return;
                    }
                }
                if (activeElement && activeElement._eventHandler && activeElement._eventHandler._doKeyDown) {
                    activeElement._eventHandler._doKeyDown(event);
                    if (!activeElement.isEditing()) {
                        var keyCode = event.keyCode;
                        var ctrlKey = event.ctrlKey;
                        var altKey = event.altKey;
                        var shiftKey = event.shiftKey;
                        if ((keyCode === 90 || keyCode === 89) && ctrlKey && !altKey) {
                            cancelDefault(event);
                        } else if (keyCode === 86 && ctrlKey && !altKey && !shiftKey) {
                            if (event.stopPropagation) {
                                event.stopPropagation();
                            }
                        }
                    }
                }
            }
            function global_keyUp(event) {
                var gcGlobal = WINDOW._gcGlobal;
                if (gcGlobal._eventSuspended > 0) {
                    return;
                }
                gcGlobal._keyDown = false;
                var activeElement = _FocusHelper._getActiveElement();
                if (activeElement && activeElement._eventHandler && activeElement._eventHandler._doKeyUp) {
                    activeElement._eventHandler._doKeyUp(event);
                }
            }
            // 全局_合成开始
            function global_compositionStart(event) {
                var gcGlobal = WINDOW._gcGlobal;
                if (gcGlobal._eventSuspended > 0) {
                    return;
                }
                var activeElement = _FocusHelper._getActiveElement();
                if (activeElement && activeElement._eventHandler && activeElement._eventHandler._doCompositionStart) {
                    activeElement._eventHandler._doCompositionStart(event);
                }
            }
            // 全局_文本输入
            function global_textInput(event) {
                var gcGlobal = WINDOW._gcGlobal;
                if (gcGlobal._eventSuspended > 0) {
                    return;
                }
                if (gcGlobal._keyDown === true) {
                    return;
                }
                var activeElement = _FocusHelper._getActiveElement();
                if (activeElement && activeElement._eventHandler && activeElement._eventHandler._doCompositionStart) {
                    activeElement._eventHandler._doCompositionStart(event);
                }
            }
            // 全局_文档选择开始
            function global_docSelectStart(event) {
                if (DOCUMENT.all === keyword_undefined && _FocusHelper._getActiveElement()) {
                    cancelDefault(event);
                }
                return false;
            }
            var _Global = (function () {
                function _Global() {
                    this._eventSuspended = 0;
                    this._clickOutsideSheetCallBack = [];
                    this._keyDown = false;
                    this._init();
                }
                // 获取虚拟标题
                _Global.prototype._getDummyHeader = function () {
                    var className = 'gc-theme-version ui-widget-header ui-state-default wijmoThemeHelper btn-default';
                    var selector = 'span.' + className.split(SPECE_STR).join(DOT_STR);
                    if (!globalPrototype._dummyHeader) {
                        globalPrototype._dummyHeader = createSpanElement(className);
                    } else if ($$(DOCUMENT).find(selector).length <= 0) {
                        documentInsertBefore(globalPrototype._dummyHeader);
                    }
                    return globalPrototype._dummyHeader;
                };
                // 获取虚拟内容
                _Global.prototype._getDummyContent = function () {
                    var className = 'gc-theme-version ui-widget-content wijmoThemeHelper btn-default';
                    var selector = 'span.' + className.split(SPECE_STR).join(DOT_STR);
                    if (!globalPrototype._dummyContent) {
                        globalPrototype._dummyContent = createSpanElement(className);
                    } else if ($$(DOCUMENT).find(selector).length <= 0) {
                        documentInsertBefore(globalPrototype._dummyContent);
                    }
                    return globalPrototype._dummyContent;
                };
                // 获取虚拟悬停
                _Global.prototype._getDummyHover = function () {
                    var className = 'gc-theme-version ui-state-hover wijmoThemeHelper btn-primary';
                    var selector = 'span.' + className.split(SPECE_STR).join(DOT_STR);
                    if (!globalPrototype._dummyHover) {
                        globalPrototype._dummyHover = createSpanElement(className);
                    } else if ($$(DOCUMENT).find(selector).length <= 0) {
                        documentInsertBefore(globalPrototype._dummyHover);
                    }
                    return globalPrototype._dummyHover;
                };
                // 获取虚拟高亮
                _Global.prototype._getDummyHighlight = function () {
                    var className = 'gc-theme-version ui-state-highlight wijmoThemeHelper btn-warning';
                    var selector = 'span.' + className.split(SPECE_STR).join(DOT_STR);
                    if (!globalPrototype._dummyHighlight) {
                        globalPrototype._dummyHighlight = createSpanElement(className);
                    } else if ($$(DOCUMENT).find(selector).length <= 0) {
                        documentInsertBefore(globalPrototype._dummyHighlight);
                    }
                    return globalPrototype._dummyHighlight;
                };
                // 获取虚拟元素
                _Global.prototype._getDummyElement = function () {
                    var className = 'gc-theme-version';
                    var id = 'gcDummyElement';
                    if (!globalPrototype._dummyElement) {
                        globalPrototype._dummyElement = createSpanElement(className, id);
                    } else if ($$(DOCUMENT).find('#' + id).length <= 0) {
                        documentInsertBefore(globalPrototype._dummyElement);
                    }
                    return globalPrototype._dummyElement;
                };
                // 创建虚拟对象
                _Global.prototype._createDummyObjects = function () {
                    globalPrototype._getDummyHeader();
                    globalPrototype._getDummyContent();
                    globalPrototype._getDummyHover();
                    globalPrototype._getDummyHighlight();
                };
                // 初始化
                _Global.prototype._init = function () {
                    var self = this;
                    self._eventSuspended = 0;
                    bindEventListener(WINDOW, 'keydown', global_keyDown, true);
                    bindEventListener(WINDOW, 'keyup', global_keyUp, true);
                    bindEventListener(WINDOW, 'compositionstart', global_compositionStart, true);
                    bindEventListener(WINDOW, 'selectstart', global_docSelectStart, true);
                    var device = util._device();
                    var isIPhoneOrIPad = device.ipad || device.iphone;
                    if (util.browser.safari && !isIPhoneOrIPad) {
                        bindEventListener(WINDOW, 'textInput', global_textInput, true);
                    }
                    function hitAnotherSpread(hitElement, activeElement) {
                        var isAnotherSpread = false;
                        var element = hitElement;
                        while (element) {
                            if ($$(element).attr('gcUIElement') === 'gcSpread') {
                                isAnotherSpread = activeElement._getHost() !== element;
                                break;
                            }
                            element = element.parentElement;
                        }
                        return isAnotherSpread;
                    }
                    function processDocumentMouseDown(e) {
                        var activeElement = _FocusHelper._getActiveElement();
                        if (activeElement) {
                            var hitElement_1 = globalPrototype._getUIElement(e.target);
                            var ignoreFormulaTextBox = activeElement._formulaTextBox && activeElement._formulaTextBox._isSelectMode;
                            self._clickOutsideSheetCallBack.forEach(function (callBack) {
                                callBack && callBack(activeElement, hitElement_1);
                            });
                            if (!hitElement_1 || hitAnotherSpread(hitElement_1, activeElement)) {
                                if (activeElement._endEditImp(keyword_undefined, keyword_undefined, ignoreFormulaTextBox)) {
                                    if (isIPhoneOrIPad) {
                                        var eventHanlder = activeElement._eventHandler;
                                        if (eventHanlder && eventHanlder._setFocusToReadonlyFocusElem) {
                                            eventHanlder._setFocusToReadonlyFocusElem();
                                        }
                                    }
                                    _FocusHelper._setActiveElement(keyword_null);
                                } else if (e.cancelable) {
                                    return false;
                                }
                            }
                        }
                    }
                    function processTouch(e) {
                        var pointerType = e.pointerType;
                        if (pointerType === e[MSPOINTER_TYPE_TOUCH] || pointerType === CONST_TOUCH) {
                            processDocumentMouseDown(e);
                        }
                    }
                    if (util._isIEOrEdgeInTouchDevice()) {
                        $$(DOCUMENT).bind('MSPointerDown', processTouch);
                        $$(DOCUMENT).bind('pointerdown', processTouch);
                    } else {
                        $$(DOCUMENT).bind('touchstart', processDocumentMouseDown);
                    }
                    bindEventListener(DOCUMENT, 'mousedown', function (e) {
                        if (!e._eventFromSpreadCanvas) {
                            var returnValue = processDocumentMouseDown(e);
                            if (returnValue === false) {
                                cancelDefault(e);
                            }
                        }
                    }, true);
                    $$(DOCUMENT).bind('DOMContentLoaded', function () {
                        globalPrototype._createDummyObjects();
                    });
                };
                // 获取UI元素
                _Global.prototype._getUIElement = function (e) {
                    var w = e;
                    while (w && w.tagName !== 'BODY') {
                        if (typeof w.getAttribute !== const_function) {
                            break;
                        }
                        var t = w.getAttribute('gcUIElement');
                        if (!t) {
                            t = w.gcUIElement;
                        }
                        if (t) {
                            return w;
                        }
                        w = w.parentNode;
                    }
                    return keyword_null;
                };
                // 获取扩展主题样式
                _Global.prototype._getExternalThemeStyle = function (visualState, defaultClass) {
                    var t = globalPrototype._getDummyHeader();
                    if (visualState === core_enum_1.VisualState.highlight || visualState === core_enum_1.VisualState.selected) {
                        t = globalPrototype._getDummyHighlight();
                    } else if (visualState === core_enum_1.VisualState.hover) {
                        t = globalPrototype._getDummyHover();
                    }
                    var className = t.className;
                    $$(t).removeClass(className).addClass(defaultClass);
                    var ts = getCurrentStyleOrComputedStyle(t);
                    var defaultCss = {
                        backgroundColor: ts.backgroundColor,
                        backgroundImage: ts.backgroundImage
                    };
                    $$(t).addClass(className);
                    ts = getCurrentStyleOrComputedStyle(t);
                    var resultCss = {
                        backgroundColor: ts.backgroundColor,
                        backgroundImage: ts.backgroundImage,
                        color: ts.color,
                        zIndex: ts.zIndex
                    };
                    resultCss.borderLeftColor = ts.borderLeftColor;
                    resultCss.borderRightColor = ts.borderRightColor;
                    resultCss.borderBottomColor = ts.borderBottomColor;
                    resultCss.borderBottomWidth = ts.borderBottomWidth;
                    resultCss.borderTopColor = ts.borderTopColor;
                    resultCss.borderRightWidth = ts.borderRightWidth;
                    if (resultCss.backgroundImage === defaultCss.backgroundImage && resultCss.backgroundColor !== defaultCss.backgroundColor) {
                        resultCss.backgroundImage = keyword_undefined;
                    }
                    $$(t).removeClass(defaultClass);
                    return resultCss;
                };
                _Global.prototype._getStyleByCssClass = function (cssClass) {
                    var t = globalPrototype._getDummyElement();
                    $$(t).removeClass(t.className).addClass('gc-theme-version ' + cssClass);
                    var ts = getCurrentStyleOrComputedStyle(t);
                    return $$_extend({}, ts);
                };
                _Global.prototype._getThemeContentStyle = function (cssClass) {
                    var t = globalPrototype._getDummyContent();
                    $$(t).removeClass(t.className).addClass('gc-theme-version ui-widget-content wijmoThemeHelper btn-default ' + cssClass);
                    var ts = getCurrentStyleOrComputedStyle(t);
                    return $$_extend({}, ts);
                };
                // 暂停事件
                _Global.prototype._suspendEvent = function () {
                    var gcGlobal = WINDOW._gcGlobal;
                    gcGlobal._eventSuspended++;
                };
                // 恢复事件
                _Global.prototype._resumeEvent = function () {
                    var gcGlobal = WINDOW._gcGlobal;
                    gcGlobal._eventSuspended--;
                    if (gcGlobal._eventSuspended < 0) {
                        gcGlobal._eventSuspended = 0;
                    }
                };
                return _Global;
            }());
            var globalPrototype = _Global.prototype;
            if (!WINDOW._gcGlobal) {
                WINDOW._gcGlobal = new _Global();
            }
            var _ThemeStyleHelper = (function () {
                function _ThemeStyleHelper() { }
                _ThemeStyleHelper._getString = function (visualState) {
                    var dict = {
                        0: 'normal',
                        1: 'highlight',
                        2: 'selected',
                        3: 'active',
                        4: 'hover',
                        5: 'activeNotSelected'
                    };
                    return dict[visualState] || '';
                };
                _ThemeStyleHelper._getVisualStateThemeStyle = function (visualState, cssClass) {
                    var cacheName = _ThemeStyleHelper._getString(visualState) + cssClass;
                    var styleCache = _ThemeStyleHelper.styleCache;
                    if (!styleCache[cacheName]) {
                        styleCache[cacheName] = globalPrototype._getExternalThemeStyle(visualState, cssClass);
                    }
                    return styleCache[cacheName];
                };
                _ThemeStyleHelper._getCssClassThemeStyle = function (cssClass) {
                    var cacheName = cssClass;
                    var styleCache = _ThemeStyleHelper.styleCache;
                    if (!styleCache[cacheName]) {
                        styleCache[cacheName] = globalPrototype._getStyleByCssClass(cssClass);
                    }
                    return styleCache[cacheName];
                };
                _ThemeStyleHelper._getContentThemeStyle = function (cssClass) {
                    var cacheName = 'content' + cssClass;
                    var styleCache = _ThemeStyleHelper.styleCache;
                    if (!styleCache[cacheName]) {
                        styleCache[cacheName] = globalPrototype._getThemeContentStyle(cssClass);
                    }
                    return styleCache[cacheName];
                };
                _ThemeStyleHelper._getColorStringFromThemeColor = function (sheet, color) {
                    var theme = sheet._currentTheme;
                    if (theme && theme.getColor) {
                        color = theme.getColor(color);
                    }
                    return color;
                };
                _ThemeStyleHelper._clearCache = function () {
                    _ThemeStyleHelper.styleCache = {};
                };
                _ThemeStyleHelper.styleCache = {};
                return _ThemeStyleHelper;
            }());
            exports._ThemeStyleHelper = _ThemeStyleHelper;

            var Point = (function () {
                function Point(x, y) {
                    this.x = x;
                    this.y = y;
                }
                Point.prototype.clone = function () {
                    return new Point(this.x, this.y);
                };
                return Point;
            }());
            exports.Point = Point;

            var Rect = (function () {
                function Rect(x, y, w, h) {
                    var self = this;
                    self.x = x;
                    self.y = y;
                    self.width = w;
                    self.height = h;
                }
                // 相交
                Rect.prototype.intersect = function (x, y, width, height) {
                    var self = this;
                    return x < self.x + self.width && self.x < x + width && y < self.y + self.height && self.y < y + height;
                };
                // 相交矩形
                Rect.prototype.intersectRect = function (rect) {
                    return this.intersect(rect.x, rect.y, rect.width, rect.height);
                };
                // 包含
                Rect.prototype.contains = function (x, y, includeEdge) {
                    var self = this;
                    if (includeEdge) {
                        return self.x <= x && x <= self.x + self.width && self.y <= y && y <= self.y + self.height;
                    }
                    return self.x < x && x < self.x + self.width && self.y < y && y < self.y + self.height;
                };
                // 包含矩形
                Rect.prototype.containsRect = function (rect, includeEdge) {
                    return this.contains(rect.x, rect.y, includeEdge) && this.contains(rect.x + rect.width, rect.y + rect.height, includeEdge);
                };
                // 获取相交矩形
                Rect.prototype.getIntersectRect = function (rect) {
                    return this.getIntersect(rect.x, rect.y, rect.width, rect.height);
                };
                // 获取相交
                Rect.prototype.getIntersect = function (x, y, width, height) {
                    var self = this, x1_s = self.x, y1_s = self.y, x1_e = self.x + self.width, y1_e = self.y + self.height, x2_s = x, y2_s = y, x2_e = x + width, y2_e = y + height, intersectX_s = Math_max(x1_s, x2_s), intersectY_s = Math_max(y1_s, y2_s), intersectX_e = Math_min(x1_e, x2_e), intersectY_e = Math_min(y1_e, y2_e), newX = intersectX_s, newY = intersectY_s, newWidth = intersectX_e - intersectX_s, newHeight = intersectY_e - intersectY_s;
                    if (newWidth > 0 && newHeight > 0) {
                        return new Rect(newX, newY, newWidth, newHeight);
                    }
                    return keyword_null;
                };
                // 圆形的
                Rect.prototype.round = function () {
                    var self = this;
                    self.x = Math_floor(self.x);
                    self.y = Math_floor(self.y);
                    self.width = Math_ceil(self.width);
                    self.height = Math_ceil(self.height);
                };
                // 克隆
                Rect.prototype.clone = function () {
                    var self = this;
                    return new Rect(self.x, self.y, self.width, self.height);
                };
                return Rect;
            }());
            exports.Rect = Rect;

            var Range = (function () {
                function Range(r, c, rc, cc) {
                    var self = this;
                    self.row = r;
                    self.rowCount = rc;
                    self.col = c;
                    self.colCount = cc;
                }
                // 相交
                Range.prototype.intersect = function (row, col, rowCount, colCount) {
                    var self = this;
                    return (row === -1 || self.row === -1 || self.row < row + rowCount && row < self.row + self.rowCount) &&
                        (col === -1 || self.col === -1 || self.col < col + colCount && col < self.col + self.colCount);
                };
                // 获取相交
                Range.prototype.getIntersect = function (range, maxRowCount, maxColumnCount) {
                    var self = this;
                    if (!range || !self.intersect(range.row, range.col, range.rowCount, range.colCount)) {
                        return keyword_null;
                    }
                    var num1 = self.col === -1 ? maxColumnCount - 1 : self.col + self.colCount - 1;
                    var num2 = range.col === -1 ? maxColumnCount - 1 : range.col + range.colCount - 1;
                    var num3 = self.row === -1 ? maxRowCount - 1 : self.row + self.rowCount - 1;
                    var num4 = range.row === -1 ? maxRowCount - 1 : range.row + range.rowCount - 1;
                    var column = Math_max(self.col, range.col);
                    var num6 = Math_min(num1, num2);
                    var row = Math_max(self.row, range.row);
                    var num8 = Math_min(num3, num4);
                    var rowCount = row === -1 ? -1 : num8 - row + 1;
                    var columnCount = column === -1 ? -1 : num6 - column + 1;
                    return new Range(row, column, rowCount, columnCount);
                };
                // 包含
                Range.prototype.contains = function (row, col, rowCount, colCount) {
                    var self = this, argumentsLength = arguments.length, contains = false;
                    if (argumentsLength === 2 || argumentsLength === 4) {
                        if (argumentsLength === 2) {
                            rowCount = 1;
                            colCount = 1;
                        }
                        contains = (self.row === -1 || self.row <= row && row + rowCount <= self.row + self.rowCount) &&
                            (self.col === -1 || self.col <= col && col + colCount <= self.col + self.colCount);
                    }
                    return contains;
                };
                // 包含区域
                Range.prototype.containsRange = function (range) {
                    return this.contains(range.row, range.col, range.rowCount, range.colCount);
                };
                // 
                Range.prototype.offset = function (x, y) {
                    var self = this;
                    var column = self.col;
                    var row = self.row;
                    if (column !== -1) {
                        column += x;
                    }
                    if (row !== -1) {
                        row += y;
                    }
                    return new Range(row, column, self.rowCount, self.colCount);
                };
                // 联合
                Range.prototype.union = function (range) {
                    return getUnionRange(this, range);
                };
                Range.prototype.equals = function (range) {
                    var self = this;
                    return range instanceof Range && self.row === range.row && self.col === range.col && self.rowCount === range.rowCount && self.colCount === range.colCount;
                };
                return Range;
            }());
            exports.Range = Range;
            exports._createRange = function (r, c, rc, cc) {
                return new Range(r, c, rc, cc);
            };
            // 获取联合范围
            function getUnionRange(range1, range2) {
                var ltr = Math_min(range1.row, range2.row);
                var ltc = Math_min(range1.col, range2.col);
                var rbr = Math_max(range1.row + range1.rowCount - 1, range2.row + range2.rowCount - 1);
                var rbc = Math_max(range1.col + range1.colCount - 1, range2.col + range2.colCount - 1);
                if (ltr >= 0 && ltc >= 0) {
                    return new Range(ltr, ltc, rbr - ltr + 1, rbc - ltc + 1);
                } else if (ltr >= 0) {
                    return new Range(ltr, -1, rbr - ltr + 1, -1);
                } else if (ltc >= 0) {
                    return new Range(-1, ltc, -1, rbc - ltc + 1);
                }
                return new Range(-1, -1, -1, -1);
            }
            exports.getUnionRange = getUnionRange;
            var _ThemeContext = (function () {
                function _ThemeContext() { }
                _ThemeContext._getColor = function (owner, name) {
                    if (owner && name) {
                        var currentTheme = owner.currentTheme();
                        if (currentTheme) {
                            return currentTheme.getColor(name);
                        }
                    }
                    return name;
                };
                _ThemeContext._getFont = function (owner, name) {
                    if (owner && name) {
                        var currentTheme = owner.currentTheme();
                        if (currentTheme) {
                            return currentTheme.getFont(name);
                        }
                        return name;
                    }
                    return keyword_null;
                };
                return _ThemeContext;
            }());
            exports._ThemeContext = _ThemeContext;

            var Events = (function () {
                function Events() { }
                // 验证错误
                Events.ValidationError = 'ValidationError';
                // 单元格单击
                Events.CellClick = 'CellClick';
                // 单元格双击
                Events.CellDoubleClick = 'CellDoubleClick';
                // 列更改
                Events.ColumnChanging = 'ColumnChanging';
                // 行更改
                Events.RowChanging = 'RowChanging';
                // 进入单元格
                Events.EnterCell = 'EnterCell';
                // 离开单元格
                Events.LeaveCell = 'LeaveCell';
                // 值已改变
                Events.ValueChanged = 'ValueChanged';
                // 顶行已更改
                Events.TopRowChanged = 'TopRowChanged';
                // 工作表更改中
                Events.SheetChanging = 'SheetChanging';
                // 工作表已更改
                Events.SheetChanged = 'SheetChanged';
                // 数据透视表已更改
                Events.PivotTableChanged = 'PivotTableChanged';
                // 左侧列已更改
                Events.LeftColumnChanged = 'LeftColumnChanged';
                // 无效的操作
                Events.InvalidOperation = 'InvalidOperation';
                // 范围过滤中
                Events.RangeFiltering = 'RangeFiltering';
                // 范围已过滤
                Events.RangeFiltered = 'RangeFiltered';
                // 范围过滤器清除
                Events.RangeFilterClearing = 'RangeFilterClearing';
                // 表筛选器清除中
                Events.TableFilterClearing = 'TableFilterClearing';
                // 表筛选器已清除
                Events.RangeFilterCleared = 'RangeFilterCleared'
                // 表筛选器已清除
                Events.TableFilterCleared = 'TableFilterCleared';
                // 表过滤器清除中
                Events.TableFiltering = 'TableFiltering';
                // 表过滤器已清除
                Events.TableFiltered = 'TableFiltered';
                // 范围排序中
                Events.RangeSorting = 'RangeSorting';
                // 范围已排序
                Events.RangeSorted = 'RangeSorted';
                // 剪贴板更改中
                Events.ClipboardChanging = 'ClipboardChanging';
                // 剪贴板已更改
                Events.ClipboardChanged = 'ClipboardChanged';
                // 剪贴板黏贴中
                Events.ClipboardPasting = 'ClipboardPasting';
                // 剪贴板已黏贴
                Events.ClipboardPasted = 'ClipboardPasted';
                // 列宽度更改
                Events.ColumnWidthChanging = 'ColumnWidthChanging';
                Events.ColumnWidthChanged = 'ColumnWidthChanged';
                // 行高度更改
                Events.RowHeightChanging = 'RowHeightChanging';
                Events.RowHeightChanged = 'RowHeightChanged';
                // 拖放块
                Events.DragDropBlock = 'DragDropBlock';
                // 拖放块已完成
                Events.DragDropBlockCompleted = 'DragDropBlockCompleted';
                // 拖动填充块
                Events.DragFillBlock = 'DragFillBlock';
                Events.DragFillBlockCompleted = 'DragFillBlockCompleted';
                // 编辑开始
                Events.EditStarting = 'EditStarting';
                Events.EditStarted = 'EditStarted';
                Events.EditChange = 'EditChange';
                Events.EditEnding = 'EditEnding';
                Events.EditEnd = 'EditEnd';
                Events.EditEnded = 'EditEnded';
                // 范围组状态更改
                Events.RangeGroupStateChanging = 'RangeGroupStateChanging';
                Events.RangeGroupStateChanged = 'RangeGroupStateChanged';
                // 选择更改
                Events.SelectionChanging = 'SelectionChanging';
                Events.SelectionChanged = 'SelectionChanged';
                // 工作表选项卡单击
                Events.SheetTabClick = 'SheetTabClick';
                Events.SheetTabDoubleClick = 'SheetTabDoubleClick';
                // 工作表名修改
                Events.SheetNameChanging = 'SheetNameChanging';
                Events.SheetNameChanged = 'SheetNameChanged';
                // 试图缩放
                Events.ViewZooming = 'ViewZooming';
                Events.ViewZoomed = 'ViewZoomed';
                // 用户缩放
                Events.UserZooming = 'UserZooming';
                Events.UserFormulaEntered = 'UserFormulaEntered';
                // 单元格改变
                Events.CellChanged = 'CellChanged';
                // 列改变
                Events.ColumnChanged = 'ColumnChanged';
                // 行改变
                Events.RowChanged = 'RowChanged';
                // 活动工作表更改
                Events.ActiveSheetChanging = 'ActiveSheetChanging';
                Events.ActiveSheetChanged = 'ActiveSheetChanged';
                // 迷你图已更改
                Events.SparklineChanged = 'SparklineChanged';
                // 大纲列检查状态已更改
                Events.OutlineColumnCheckStatusChanged = 'OutlineColumnCheckStatusChanged';
                // 区域更改
                Events.RangeChanged = 'RangeChanged';
                // 按钮点击
                Events.ButtonClicked = 'ButtonClicked';
                // 编辑状态更新
                Events.EditorStatusChanged = 'EditorStatusChanged';
                // 浮动对象已更改
                Events.FloatingObjectChanged = 'FloatingObjectChanged';
                // 绘制中的元素z-index已更改
                Events.DrawingElementZIndexChanged = 'DrawingElementZIndexChanged';
                // 浮动对象选择已更改
                Events.FloatingObjectSelectionChanged = 'FloatingObjectSelectionChanged';
                // 形状已更改
                Events.ShapeChanged = 'ShapeChanged';
                // 形状选择已更改
                Events.ShapeSelectionChanged = 'ShapeSelectionChanged';
                // 图片已更改
                Events.PictureChanged = 'PictureChanged';
                Events.FloatingObjectRemoving = 'FloatingObjectRemoving';
                Events.ShapeRemoving = 'ShapeRemoving';
                Events.FloatingObjectRemoved = 'FloatingObjectRemoved';
                Events.ShapeRemoved = 'ShapeRemoved';
                Events.PictureSelectionChanged = 'PictureSelectionChanged';
                Events.FloatingObjectLoaded = 'FloatingObjectLoaded';
                // 触摸工具栏打开
                Events.TouchToolStripOpening = 'TouchToolStripOpening';
                // 注释已更改
                Events.CommentChanged = 'CommentChanged';
                Events.CommentRemoving = 'CommentRemoving';
                Events.CommentRemoved = 'CommentRemoved';
                // 切片器已更改
                Events.SlicerChanged = 'SlicerChanged';
                // 拖放之前
                Events.BeforeDragDrop = 'BeforeDragDrop';
                // 公式文本框活动工作表更改
                Events.FormulatextboxActiveSheetChanging = 'FormulatextboxActiveSheetChanging';
                Events.FormulatextboxActiveSheetChanged = 'FormulatextboxActiveSheetChanged';
                Events.FormulatextboxEditStarted = 'FormulatextboxEditStarted';
                Events.FormulatextboxEnterCell = 'FormulatextboxEnterCell';
                Events.FormulatextboxEditEnded = 'FormulatextboxEditEnded';
                Events.FormulatextboxRangeChanged = 'FormulatextboxRangeChanged';
                Events.SheetMoving = 'SheetMoving';
                Events.SheetMoved = 'SheetMoved';
                Events.DragMerging = 'DragMerging';
                Events.DragMerged = 'DragMerged';
                Events.ChartClicked = 'ChartClicked';
                Events.FloatingElementSelected = 'FloatingElementSelected';
                Events.BeforePrint = 'BeforePrint';
                // 调整表格大小
                Events.TableResizing = 'TableResizing';
                Events.TableResized = 'TableResized';
                Events.TableRowsChanged = 'TableRowsChanged';
                Events.TableColumnsChanged = 'TableColumnsChanged';
                // 下拉展开鼠标单击
                Events.DropdownSpreadMouseClick = 'DropdownSpreadMouseClick';
                Events.DropdownSpreadKeyboardEnter = 'DropdownSpreadKeyboardEnter';
                // 粘贴结束
                Events.PasteEnd = 'PasteEnd';
                return Events;
            }());
            exports.Events = Events;

            // 缓存池
            var _CachePool = (function () {
                function _CachePool(sheet) {
                    this._sheet = sheet;
                }
                _CachePool.prototype._dispose = function () {
                    this._sheet = keyword_null;
                };
                // 获取单元格溢出生成器
                _CachePool.prototype._getCellOverflowBuilder = function (rowViewportIndex, colViewportIndex, createBuilder) {
                    var caches = this._cellOverflowBuilderCache, index = rowViewportIndex << 4 + colViewportIndex;
                    if (!caches) {
                        return createBuilder();
                    }
                    var cache = caches[index];
                    if (!cache) {
                        cache = createBuilder();
                        caches[index] = cache;
                    }
                    return cache;
                };
                // 获取条件格式
                _CachePool.prototype._getConditionalFormat = function (row, col) {
                    var caches = this._conditionalFormatCache;
                    if (caches) {
                        var rowCaches = caches[row];
                        if (rowCaches) {
                            return rowCaches[col];
                        }
                    }
                    return keyword_null;
                };
                _CachePool.prototype._setConditionalFormat = function (row, col, dataBar, iconSet) {
                    var caches = this._conditionalFormatCache;
                    if (caches) {
                        if (!caches[row]) {
                            caches[row] = {};
                        }
                        var rowCaches = caches[row];
                        rowCaches[col] = {
                            d: dataBar,
                            i: iconSet
                        };
                    }
                };
                // 获取显示值
                _CachePool.prototype._getDisplayValue = function (row, col, sheetArea, valueType, style) {
                    var self = this, sheet = self._sheet;
                    if (sheetArea === keyword_undefined) {
                        sheetArea = 3;
                    }
                    var formula = sheet._getTextForShowFormulasMode(row, col, sheetArea);
                    if (!isNullOrUndefined(formula)) {
                        return formula;
                    }
                    if (!isNullOrUndefined(style) && util._isFormatString(style.formatter)) {
                        return _CacheMgr._getFormattedTextByStyle(sheet, style, self._getValue(row, col, sheetArea, 0), {}, { row: row, col: col, sheet: sheet });
                    }
                    return self._getValue(row, col, sheetArea, valueType);
                };
                _CachePool.prototype._getValue = function (row, col, sheetArea, valueType) {
                    var self = this;
                    var sheet = self._sheet;
                    var cache = self._valueCache;
                    if (sheetArea === keyword_undefined) {
                        sheetArea = 3;
                    }
                    if (!cache) {
                        return sheet.getValue(row, col, sheetArea, valueType);
                    }
                    var sCache = cache[sheetArea], rowCache, cellCache;
                    if (!sCache) {
                        sCache = {};
                        cache[sheetArea] = sCache;
                    }
                    rowCache = sCache[row];
                    if (!rowCache) {
                        rowCache = {};
                        sCache[row] = rowCache;
                    }
                    cellCache = rowCache[col];
                    if (cellCache === keyword_undefined) {
                        cellCache = sheet.getValue(row, col, sheetArea, valueType);
                        rowCache[col] = cellCache;
                    }
                    return cellCache;
                };
                // 获取实际样式
                _CachePool.prototype._getActualStyle = function (row, col, sheetArea) {
                    var self = this, sheet = self._sheet, cache = self._styleCache;
                    if (sheetArea === keyword_undefined) {
                        sheetArea = 3;
                    }
                    if (!cache) {
                        return sheet._getActualStyleImp(row, col, sheetArea, false, false);
                    }
                    var sCache = cache[sheetArea], rowCache, cellCache;
                    if (!sCache) {
                        sCache = {};
                        cache[sheetArea] = sCache;
                    }
                    rowCache = sCache[row];
                    if (!rowCache) {
                        rowCache = {};
                        sCache[row] = rowCache;
                    }
                    cellCache = rowCache[col];
                    if (!cellCache) {
                        cellCache = sheet._getActualStyleImp(row, col, sheetArea, false, true);
                        rowCache[col] = cellCache;
                    }
                    return cellCache.clone(true);
                };
                // 获取缩放行高度
                _CachePool.prototype._getZoomRowHeight = function (row) {
                    var self = this, sheet = self._sheet, cache = self._rowHeightCache;
                    if (!cache) {
                        return sheet._getZoomRowHeight(row);
                    }
                    var c = cache[row];
                    if (c === keyword_undefined) {
                        c = cache[row] = sheet._getZoomRowHeight(row);
                    }
                    return c;
                };
                // 获取缩放列宽度
                _CachePool.prototype._getZoomColWidth = function (col) {
                    var self = this, sheet = self._sheet, cache = self._colWidthCache;
                    if (!cache) {
                        return sheet._getZoomColumnWidth(col);
                    }
                    var c = cache[col];
                    if (c === keyword_undefined) {
                        c = cache[col] = sheet._getZoomColumnWidth(col);
                    }
                    return c;
                };
                // 获取行组
                _CachePool.prototype._getRowGroups = function (createFunction) {
                    var self = this;
                    if (!self._valueCache) {
                        return createFunction();
                    }
                    if (!self._rowGroups) {
                        self._rowGroups = createFunction();
                    }
                    return self._rowGroups;
                };
                // 获取列组
                _CachePool.prototype._getColGroups = function (createFunction) {
                    var self = this;
                    if (!self._valueCache) {
                        return createFunction();
                    }
                    if (!self._colGroups) {
                        self._colGroups = createFunction();
                    }
                    return self._colGroups;
                };
                // 开始平移前缓存
                _CachePool.prototype._startCacheBeforPan = function () {
                    var self = this;
                    self._isCaching = true;
                    self._cellOverflowBuilderCache = {};
                    self._conditionalFormatCache = {};
                    self._valueCache = {};
                    self._styleCache = {};
                    self._rowHeightCache = {};
                    self._colWidthCache = {};
                };
                // 结束缓存
                _CachePool.prototype._endCache = function () {
                    this._isCaching = false;
                };
                // 结束平移清除缓存
                _CachePool.prototype._clearCacheEndPan = function () {
                    var self = this;
                    self._isCaching = false;
                    self._cellOverflowBuilderCache = keyword_null;
                    self._conditionalFormatCache = keyword_null;
                    self._valueCache = keyword_null;
                    self._styleCache = keyword_null;
                    self._colWidthCache = keyword_null;
                    self._rowHeightCache = keyword_null;
                    self._rowGroups = keyword_null;
                    self._colGroups = keyword_null;
                };
                return _CachePool;
            }());
            exports._CachePool = _CachePool;
            // 缓存管理器
            var _CacheMgr = (function () {
                function _CacheMgr() { }
                _CacheMgr._startCache = function (sheet, startRow, startColumn, endRow, endColumn) {
                    _CacheMgr._cached = true;
                    var tables = sheet.tables;
                    if (tables && tables._has(startRow, startColumn, endRow - startRow + 1, endColumn - startColumn + 1)) {
                        var vIndex = -1;
                        var vIndexCache = _CacheMgr._visibleRowIndexCache = [];
                        for (var r = 0; r <= endRow; r++) {
                            if (sheet.getRowVisible(r)) {
                                vIndex++;
                                vIndexCache[r] = vIndex;
                            } else {
                                vIndexCache[r] = -1;
                            }
                        }
                    }
                };
                _CacheMgr._clearCache = function () {
                    _CacheMgr._visibleRowIndexCache = keyword_null;
                    _CacheMgr._cached = false;
                };
                _CacheMgr._getFormatter = function (format) {
                    var formatterCache = _CacheMgr._formatterCache;
                    if (!formatterCache[format]) {
                        formatterCache[format] = GeneralFormatter ? new GeneralFormatter(format) : keyword_null;
                    }
                    return formatterCache[format];
                };
                _CacheMgr._getFormattedText = function (value, format, formattedData) {
                    var mgrCache = _CacheMgr._formattedTextCache;
                    var valueKey = value + '_' + (typeof value);
                    if (GeneralFormatter) {
                        if (!mgrCache[format]) {
                            mgrCache[format] = {};
                        }
                        var formatCache = mgrCache[format];
                        var formattedResultCache = formatCache[valueKey];
                        if (formattedResultCache) {
                            if (formattedData) {
                                formattedData.conditionalForeColor = formattedData.value = formattedResultCache.color;
                                formattedData.content = cloneArray(formattedResultCache.content);
                            }
                            return formattedResultCache.text;
                        }
                        var formatterCache = _CacheMgr._formatterCache;
                        if (!formatterCache[format]) {
                            formatterCache[format] = new GeneralFormatter(format);
                        }
                        var formatter = formatterCache[format];
                        var tempFormattedResult = {};
                        var result = formatter.format(value, tempFormattedResult);
                        var formatResult = formatCache[valueKey] = {};
                        formatResult.text = result;
                        formatResult.color = tempFormattedResult.conditionalForeColor;
                        formatResult.content = tempFormattedResult.content;
                        if (formattedData) {
                            formattedData.conditionalForeColor = formattedData.value = tempFormattedResult.conditionalForeColor;
                            formattedData.content = cloneArray(tempFormattedResult.content);
                        }
                        return result;
                    }
                    return value.toString();
                };
                // 按样式获取格式化文本
                _CacheMgr._getFormattedTextByStyle = function (sheet, style, value, formattedData, context) {
                    if (value && value.typeName === 'SparklineExValue') {
                        return '';
                    }
                    var ct = style.cellType || sheet._getDefaultCellType();
                    var format = style.formatter || style._autoFormatter;
                    return ct.format(value, format, formattedData, context);
                };
                _CacheMgr._clearFormatCache = function () {
                    _CacheMgr._formatterCache = {};
                    _CacheMgr._formattedTextCache = {};
                };
                _CacheMgr._cached = false;
                _CacheMgr._formatterCache = {};
                _CacheMgr._formattedTextCache = {};
                _CacheMgr._visibleRowIndexCache = [];
                return _CacheMgr;
            }());
            exports._CacheMgr = _CacheMgr;
            // 创建矩阵
            function createMatrix(ctx) {
                var matrix = ctx._matrix || {
                    scaleX: 1,
                    scaleY: 1,
                    translateX: 0,
                    translateY: 0,
                    skewX: 0,
                    skewY: 0,
                    orgTranslateX: 0,
                    orgTranslateY: 0
                };
                ctx._matrix = matrix;
                return matrix;
            }
            // 画布助手
            var _CanvasHelper = (function () {
                function _CanvasHelper() { }
                // 缩放到
                _CanvasHelper._scaleTo = function (ctx, scaleX, scaleY) {
                    var matrix = createMatrix(ctx);
                    matrix.scaleX = scaleX;
                    matrix.scaleY = scaleY;
                    matrix.translateX = matrix.orgTranslateX * scaleX;
                    matrix.translateY = matrix.orgTranslateY * scaleY;
                    ctx.setTransform(matrix.scaleX, matrix.skewX, matrix.skewY, matrix.scaleY, matrix.translateX, matrix.translateY);
                };
                _CanvasHelper._translate = function (ctx, translateX, translateY) {
                    var matrix = createMatrix(ctx);
                    matrix.orgTranslateX += translateX;
                    matrix.orgTranslateY += translateY;
                    matrix.translateX = matrix.orgTranslateX * matrix.scaleX;
                    matrix.translateY = matrix.orgTranslateY * matrix.scaleY;
                    ctx.setTransform(matrix.scaleX, matrix.skewX, matrix.skewY, matrix.scaleY, matrix.translateX, matrix.translateY);
                };
                return _CanvasHelper;
            }());
            exports._CanvasHelper = _CanvasHelper;
            var CanvasHelper = _CanvasHelper;

            // DPI帮助_设置缩放比例X
            function DPIHelper_setScaleX(canvas, scaleX) {
                if (canvas) {
                    canvas._gcDPIScaleX = scaleX;
                }
            }
            // DPI帮助_设置缩放比例Y
            function DPIHelper_setScaleY(canvas, scaleY) {
                if (canvas) {
                    canvas._gcDPIScaleY = scaleY;
                }
            }
            // DPI帮助_设置逻辑宽度
            function DPIHelper_setLogicWidth(canvas, width) {
                canvas._gcLogicWidth = width;
            }
            function DPIHelper_setLogicHeight(canvas, height) {
                canvas._gcLogicHeight = height;
            }
            var _DPIHelper = (function () {
                function _DPIHelper() { }
                // 获取设备像素
                _DPIHelper._getDevicePixel = function () {
                    var screen = WINDOW.screen, deviceXDPI = screen.deviceXDPI;
                    var ratio = WINDOW.devicePixelRatio || (deviceXDPI ? deviceXDPI / screen.logicalXDPI : 1);
                    var x = ratio * 20;
                    var rx = Math_round(x);
                    return rx - x > 0.82 ? rx / 20 : Math_round(ratio * 100) / 100;
                };
                // 调整设备像素
                _DPIHelper._adjustDevicePixel = function (canvas, workbook, sheet) {
                    var self = _DPIHelper;
                    DPIHelper_setScaleX(canvas, 1);
                    DPIHelper_setScaleY(canvas, 1);
                    var ratio = _DPIHelper._getDevicePixel();
                    if (ratio === 1 && self.dpr === 1) {
                        return;
                    }
                    self.dpr = ratio;
                    var ownerWorkbook = workbook ? workbook : sheet && sheet.parent;
                    if (ownerWorkbook) {
                        var cache = self._spreadCanvasCaches;
                        var spreadCache = void 0;
                        for (var i = 0; i < cache.length; i++) {
                            if (ownerWorkbook === cache[i].workbook) {
                                spreadCache = cache[i];
                                break;
                            }
                        }
                        if (!spreadCache) {
                            spreadCache = {
                                workbook: ownerWorkbook,
                                sheets: [],
                                canvases: []
                            };
                            cache.push(spreadCache);
                        }
                        if (workbook) {
                            spreadCache.canvases.push(canvas);
                        } else {
                            var cacheSheet = void 0;
                            var sheets = spreadCache.sheets;
                            for (var j = 0; j < sheets.length; j++) {
                                if (sheets[j].sheet === sheet) {
                                    cacheSheet = sheets[j];
                                    break;
                                }
                            }
                            if (!cacheSheet) {
                                cacheSheet = {
                                    sheet: sheet,
                                    canvases: []
                                };
                                sheets.push(cacheSheet);
                            }
                            cacheSheet.canvases.push(canvas);
                        }
                    }
                };
                // 获取缩放X
                _DPIHelper._getScaleX = function (canvas) {
                    return canvas && canvas._gcDPIScaleX || 1;
                };
                _DPIHelper._getScaleY = function (canvas) {
                    return canvas && canvas._gcDPIScaleY || 1;
                };
                // 获取逻辑宽度
                _DPIHelper._getLogicWidth = function (canvas) {
                    return canvas._gcLogicWidth;
                };
                _DPIHelper._getLogicHeight = function (canvas) {
                    return canvas._gcLogicHeight;
                };
                _DPIHelper._setSize = function (canvas, width, height) {
                    var self = _DPIHelper, ratio = self.dpr;
                    var oldScaleX = self._getScaleX(canvas), oldScaleY = self._getScaleY(canvas);
                    DPIHelper_setLogicWidth(canvas, width);
                    DPIHelper_setLogicHeight(canvas, height);
                    if (ratio === 1 && oldScaleX === 1 && oldScaleY === 1) {
                        canvas.width = width;
                        canvas.height = height;
                    } else {
                        var ctx = canvas.getContext('2d');
                        CanvasHelper._scaleTo(ctx, 1, 1);
                        if (util._browser.mozilla) {
                            canvas.width = Math_ceil(width * ratio);
                            canvas.height = Math_ceil(height * ratio);
                        } else {
                            canvas.width = Math_round(width * ratio);
                            canvas.height = Math_round(height * ratio);
                        }
                        canvas.style.width = width + CSS_PX;
                        canvas.style.height = height + CSS_PX;
                        var newScaleX = canvas.width / width, newScaleY = canvas.height / height;
                        if (newScaleX !== oldScaleX || newScaleY !== oldScaleY) {
                            DPIHelper_setScaleX(canvas, newScaleX);
                            DPIHelper_setScaleY(canvas, newScaleY);
                        }
                        CanvasHelper._scaleTo(ctx, newScaleX, newScaleY);
                    }
                };
                // 处理工作表的画布
                _DPIHelper._disposeCanvasForSheet = function (sheet, canvas) {
                    var caches = _DPIHelper._spreadCanvasCaches;
                    var workbook = sheet.parent;
                    var sheets;
                    var canvases;
                    for (var i = 0; i < caches.length; i++) {
                        if (!workbook || caches[i].workbook === workbook) {
                            sheets = caches[i].sheets;
                            for (var j = 0; j < sheets.length; j++) {
                                if (sheets[j].sheet === sheet) {
                                    canvases = sheets[j].canvases;
                                    for (var k = 0; k < canvases.length; k++) {
                                        if (canvases[k] === canvas) {
                                            canvases.splice(k, 1);
                                            break;
                                        }
                                    }
                                    break;
                                }
                            }
                        }
                    }
                };
                // 处理Spread画布
                _DPIHelper._disposeCanvasForSpread = function (workbook, canvas) {
                    var caches = _DPIHelper._spreadCanvasCaches;
                    var canvases;
                    for (var i = 0; i < caches.length; i++) {
                        if (caches[i].workbook === workbook) {
                            canvases = caches[i].canvases;
                            for (var k = 0; k < canvases.length; k++) {
                                if (canvases[k] === canvas) {
                                    canvases.splice(k, 1);
                                    break;
                                }
                            }
                        }
                    }
                };
                // 处置工作表
                _DPIHelper._disposeSheet = function (sheet) {
                    var caches = _DPIHelper._spreadCanvasCaches;
                    var workbook = sheet.parent;
                    var sheets;
                    for (var i = 0; i < caches.length; i++) {
                        if (!workbook || caches[i].workbook === workbook) {
                            sheets = caches[i].sheets;
                            for (var j = 0; j < sheets.length; j++) {
                                if (sheets[j].sheet === sheet) {
                                    sheets.splice(j, 1);
                                }
                            }
                            return;
                        }
                    }
                };
                // 处置Spread
                _DPIHelper._disposeSpread = function (workbook) {
                    var caches = _DPIHelper._spreadCanvasCaches;
                    for (var i = 0; i < caches.length; i++) {
                        if (caches[i].workbook === workbook) {
                            caches.splice(i, 1);
                            return;
                        }
                    }
                };
                // 更新DPI
                _DPIHelper._updateDPI = function () {
                    var self = _DPIHelper;
                    var dpr = self._getDevicePixel();
                    if (self.dpr !== dpr) {
                        var caches_1 = self._spreadCanvasCaches, sheets = void 0, spreadCache = void 0, canvases = void 0, canvas = void 0;
                        self.dpr = dpr;
                        for (var i = 0; i < caches_1.length; i++) {
                            spreadCache = caches_1[i];
                            canvases = spreadCache.canvases;
                            sheets = spreadCache.sheets;
                            for (var sIndex = 0; sIndex < sheets.length; sIndex++) {
                                canvases = canvases.concat(sheets[sIndex].canvases);
                            }
                            for (var j = 0; j < canvases.length; j++) {
                                canvas = canvases[j];
                                self._setSize(canvas, self._getLogicWidth(canvas), self._getLogicHeight(canvas));
                            }
                        }
                    }
                };
                _DPIHelper.dpr = 1;
                _DPIHelper._spreadCanvasCaches = [];
                return _DPIHelper;
            }());
            exports._DPIHelper = _DPIHelper;
            // 自动换行助手_获取canvas上下文
            function _WordWrapHelper_getCtx() {
                if (!_WordWrapHelper._ctx) {
                    var c = createElement('canvas');
                    document.body.append(c);
                    _WordWrapHelper._ctx = c.getContext('2d');
                }
                return _WordWrapHelper._ctx;
            }
            // 自动换行助手_获取文字
            function _WordWrapHelper_getTextWords(text) {
                var lines = [];
                var startIndex = 0;
                var space = SPECE_STR;
                for (var i = 0; i < text.length; i++) {
                    if (lines[startIndex] === keyword_undefined) {
                        lines[startIndex] = '';
                    }
                    var currentChar = text.charAt(i);
                    var nextChar = '';
                    if (i + 1 < text.length) {
                        nextChar = text.charAt(i + 1);
                    }
                    if ((currentChar === space && nextChar !== space) || (currentChar === '-' && nextChar !== '-')) {
                        lines[startIndex] += currentChar;
                        startIndex++;
                    } else {
                        lines[startIndex] += currentChar;
                    }
                }
                return lines;
            }
            // 自动换行助手_删除结尾空格
            function _WordWrapHelper_removeEndSpace(text) {
                var index = text.length - 1;
                while (text.charAt(index) === ' ') {
                    index--;
                }
                if (index !== text.length - 1) {
                    text = text.substring(0, index + 1);
                }
                return text;
            }
            function objDeepCopy(source) {
                var sourceCopy = source instanceof Array ? [] : {};
                for (var item in source) {
                    if (source.hasOwnProperty(item)) {
                        sourceCopy[item] = (typeof source[item] === 'object' && source[item] !== keyword_null) ? objDeepCopy(source[item]) : source[item];
                    }
                }
                return sourceCopy;
            }
            // 自动换行助手_按字符获取包装信息
            function _WordWrapHelper_getWrapInfoByCharacter(text, size, isVerticalText, lineHeight, context2D) {
                var lines = [];
                var ctx = context2D ? context2D : _WordWrapHelper_getCtx();
                if (!ctx) {
                    return lines;
                }
                var charSize;
                var orgtLength, totalSize;
                if (isVerticalText) {
                    totalSize = text.length * lineHeight;
                    orgtLength = Math_ceil(size / lineHeight);
                } else {
                    totalSize = measureTextWidth(ctx, ctx.font, text);
                    charSize = totalSize / text.length;
                    orgtLength = Math_ceil(size / charSize);
                }
                while (totalSize > size && text) {
                    var isLong = false;
                    var targetLength = orgtLength;
                    while (true) {
                        if (text.length < targetLength) {
                            lines.push(text);
                            text = '';
                            break;
                        }
                        var subText = text.substring(0, targetLength);
                        var subSize = isVerticalText ? targetLength * lineHeight : measureTextWidth(ctx, ctx.font, subText);
                        if (subText.charAt(subText.length - 1) === '-') {
                            subSize = isVerticalText ? targetLength * lineHeight : measureTextWidth(ctx, ctx.font, subText) - measureTextWidth(ctx, ctx.font, '-');
                        }
                        if (subSize === size || isLong && subSize < size) {
                            lines.push(subText);
                            text = text.substring(targetLength);
                            totalSize = totalSize - subSize;
                            break;
                        } else if (subSize > size) {
                            if (subText.length === 1) {
                                var remainText = text.substring(subText.length);
                                if (remainText.trim()) {
                                    lines.push(subText);
                                    text = text.substring(targetLength);
                                    totalSize = totalSize - subSize;
                                } else {
                                    lines.push(text);
                                    text = '';
                                }
                                break;
                            }
                            targetLength -= 1;
                            isLong = true;
                        } else {
                            var step = isVerticalText ? (size - subSize) / lineHeight : (size - subSize) / charSize;
                            step = step >= 1 ? step : 1;
                            targetLength += step;
                        }
                    }
                }
                if (text && text.search(/^[ ]*$/) === -1) {
                    lines.push(text);
                }
                return lines;
            }
            // 自动换行助手_按字符获取富文本换行信息
            function _WordWrapHelper_getRichTextWrapInfoByCharacter(word, availSizeInFirstLine, size, isVerticalText, defaultFont, context2D) {
                var ctx = context2D ? context2D : _WordWrapHelper_getCtx();
                if (!ctx) {
                    return [word];
                }
                var parts = [];
                var tempSize = 0;
                var availSize = availSizeInFirstLine;
                var line = [];
                for (var j = 0; j < word.length; j++) {
                    var font = (word[j].style && word[j].style.font) || defaultFont;
                    var lineHeight = util._getFontHeight(font);
                    if (word[j].text && word[j].text.length > 0) {
                        tempSize += isVerticalText ? lineHeight * word[j].text.length : measureTextWidth(ctx, font, word[j].text);
                    } else {
                        tempSize = 0;
                    }
                    if (tempSize < availSize) {
                        line.push(word[j]);
                    } else {
                        tempSize = tempSize - (isVerticalText ? lineHeight * word[j].text.length : measureTextWidth(ctx, font, word[j].text));
                        for (var i = 0; i < word[j].text.length; i++) {
                            var charSize = isVerticalText ? lineHeight : measureTextWidth(ctx, font, word[j].text.charAt(i));
                            if (charSize > size && i === 0) {
                                if (line.length > 0) {
                                    parts.push(line);
                                    line = [];
                                }
                                line.push({
                                    style: word[j].style,
                                    text: word[j].text.substring(0, 1)
                                });
                                parts.push(line);
                                line = [];
                                var remainLetters = word[j].text.substring(1, word[j].text.length);
                                if (remainLetters.length) {
                                    word.splice(j + 1, 0, {
                                        style: word[j].style,
                                        text: remainLetters
                                    });
                                }
                                tempSize = 0;
                                availSize = size;
                                break;
                            } else {
                                tempSize += charSize;
                                if (tempSize > availSize) {
                                    line.push({
                                        style: word[j].style,
                                        text: word[j].text.substring(0, i)
                                    });
                                    parts.push(line);
                                    line = [];
                                    var remainLetters = word[j].text.substring(i, word[j].text.length);
                                    if (remainLetters.length) {
                                        word.splice(j + 1, 0, {
                                            style: word[j].style,
                                            text: remainLetters
                                        });
                                    }
                                    tempSize = 0;
                                    availSize = size;
                                    break;
                                }
                            }
                        }
                    }
                }
                if (line.length > 0) {
                    parts.push(line);
                }
                return parts;
            }
            // 自动换行助手_按单词获取包装信息
            function _WordWrapHelper_getWrapInfoByWord(text, size, isVerticalText, lineHeight, context2D) {
                var lines = [];
                var words = _WordWrapHelper_getTextWords(text);
                var ctx = context2D ? context2D : _WordWrapHelper_getCtx();
                if (!ctx) {
                    return lines;
                }
                var totalSize = measureTextWidth(ctx, ctx.font, text);
                var charSize = isVerticalText ? lineHeight : totalSize / text.length;
                var averageLength = convertToInt(size / charSize + '', 10);
                var lineIndex = 0, stackCharCount = 0, tempCount = 0, index = 0;
                var stack = [];
                var isLong = false;
                while (index < words.length) {
                    if (isLong === false) {
                        var word = words[index];
                        stack.push(word);
                        stackCharCount += word.length;
                        if (stackCharCount < averageLength && (index < words.length - 1)) {
                            index++;
                            continue;
                        } else {
                            tempCount = stackCharCount;
                            stackCharCount = 0;
                        }
                    }
                    var subSize = isVerticalText ? stack.join('').length * lineHeight :
                        _WordWrapHelper._measureText(stack.join(''), ctx.font, true, ctx);
                    if (stack.join('').charAt(stack.join('').length - 1) === '-') {
                        subSize = isVerticalText ? stack.join('').length * lineHeight : measureTextWidth(ctx, ctx.font, stack.join('')) - measureTextWidth(ctx, ctx.font, '-');
                    }
                    if (subSize > size) {
                        var tempWord = stack.pop();
                        if (stack.length === 0) {
                            var parts = _WordWrapHelper_getWrapInfoByCharacter(tempWord, size, isVerticalText, lineHeight, ctx);
                            for (var i = 0; i < parts.length - 1; i++) {
                                lines[lineIndex] = parts[i];
                                lineIndex++;
                            }
                            if (parts.length === 1) {
                                lines[lineIndex] = parts[0];
                                lineIndex++;
                            }
                            if (parts.length >= 2) {
                                words[index] = parts[parts.length - 1];
                            } else {
                                index++;
                            }
                            isLong = false;
                        } else {
                            isLong = true;
                            index--;
                        }
                    } else if (subSize < size && isLong === true || subSize === size) {
                        isLong = false;
                        lines[lineIndex] = _WordWrapHelper_removeEndSpace(stack.join(''));
                        lineIndex++;
                        stack = [];
                        index++;
                    } else if (subSize < size) {
                        index++;
                        stackCharCount = tempCount;
                    }
                }
                if (stack.length !== 0) {
                    lines[lineIndex] = _WordWrapHelper_removeEndSpace(stack.join(''));
                }
                return lines;
            }
            // // 自动换行助手_按单词获取富文本包装信息
            function _WordWrapHelper_getRichTextWrapInfoByWord(words, size, lineDefaultFont, isVerticalText, context2D) {
                var lines = [];
                var ctx = context2D ? context2D : _WordWrapHelper_getCtx();
                if (!ctx) {
                    return lines;
                }
                if (words.length === 0) {
                    lines.push({
                        textLength: 0,
                        text: '',
                        textInfos: [
                            {
                                style: {
                                    font: lineDefaultFont
                                },
                                text: ''
                            }
                        ]
                    });
                    return lines;
                }
                var tempSize = 0, stack = [];
                for (var i = 0; i < words.length; i++) {
                    var word = words[i], wordSize = 0, lineHeight = 0;
                    for (var j = 0; j < word.length; j++) {
                        var font = void 0;
                        if (word[j].style && word[j].style.font) {
                            font = word[j].style.font;
                        } else {
                            font = lineDefaultFont;
                        }
                        if (isVerticalText) {
                            lineHeight = util._getFontHeight(font);
                            wordSize += lineHeight * word[j].text.length;
                        } else if (!isNullOrUndefined(word[j].text)) {
                            wordSize += measureTextWidth(ctx, font, word[j].text);
                        }
                    }
                    if (wordSize > size) {
                        if (stack.length > 0) {
                            lines.push({
                                textLength: tempSize,
                                text: _WordWrapHelper_removeEndSpace(mergeArrayText(stack)),
                                textInfos: objDeepCopy(stack)
                            });
                            stack = [];
                            tempSize = 0;
                        }
                        var parts = _WordWrapHelper_getRichTextWrapInfoByCharacter(word, size - tempSize, size, isVerticalText, lineDefaultFont, ctx);
                        stack = stack.concat(parts[0]);
                        if (!isNullOrUndefined(parts[0])) {
                            lines.push({
                                textLength: tempSize + getRichTextsLength(parts[0], lineDefaultFont, isVerticalText, ctx),
                                text: _WordWrapHelper_removeEndSpace(mergeArrayText(stack)),
                                textInfos: objDeepCopy(stack)
                            });
                        }
                        stack = [];
                        tempSize = 0;
                        for (var k = 1; k < parts.length - 1; k++) {
                            if (!isNullOrUndefined(parts[k])) {
                                lines.push({
                                    textLength: getRichTextsLength(parts[k], lineDefaultFont, isVerticalText, ctx),
                                    text: _WordWrapHelper_removeEndSpace(mergeArrayText(parts[k])),
                                    textInfos: objDeepCopy(parts[k])
                                });
                            }
                        }
                        if (parts.length > 1) {
                            var lastPart = parts[parts.length - 1];
                            stack = stack.concat(lastPart);
                            if (!isNullOrUndefined(lastPart)) {
                                tempSize += getRichTextsLength(lastPart, lineDefaultFont, isVerticalText, ctx);
                            }
                        }
                    } else if (tempSize + wordSize > size) {
                        lines.push({
                            textLength: tempSize,
                            text: _WordWrapHelper_removeEndSpace(mergeArrayText(stack)),
                            textInfos: objDeepCopy(stack)
                        });
                        stack = [];
                        stack = stack.concat(word);
                        tempSize = wordSize;
                    } else {
                        stack = stack.concat(word);
                        tempSize += wordSize;
                    }
                }
                if (stack.length > 0) {
                    lines.push({
                        textLength: tempSize,
                        text: _WordWrapHelper_removeEndSpace(mergeArrayText(stack)),
                        textInfos: objDeepCopy(stack)
                    });
                }
                return lines;
            }
            // 获取富文本长度
            function getRichTextsLength(richTexts, defaultFont, isVertical, context2D) {
                var textLength = 0, ctx = context2D ? context2D : _WordWrapHelper_getCtx();
                for (var i = 0; i < richTexts.length; i++) {
                    var font = (richTexts[i].style && richTexts[i].style.font) || defaultFont;
                    textLength += isVertical ? util._getFontHeight(font) * richTexts[i].text.length : measureTextWidth(ctx, font, richTexts[i].text);
                }
                return textLength;
            }
            // 合并数组文本
            function mergeArrayText(stack) {
                var text = '';
                for (var i = 0; i < stack.length; i++) {
                    text += stack[i].text;
                }
                return text;
            }
            // 重置大小
            function resetSize(ctx, richText, font, isVerticalText) {
                var charMinSize = -1;
                var flag = true;
                for (var i = 0; i < richText.length; i++) {
                    if (isNullOrUndefined(richText[i].text)) {
                        continue;
                    }
                    for (var j = 0; j < richText[i].text.length; j++) {
                        var tempChar = richText[i].text.charAt(j);
                        var actualFont = richText[i].style ? richText[i].style.font : font;
                        util._setContextFont(ctx, actualFont);
                        var lineHeight = util._getFontHeight(actualFont);
                        if (tempChar !== SPECE_STR && !flag) {
                            charMinSize = Math_min(charMinSize, isVerticalText ? lineHeight : measureTextWidth(ctx, font, tempChar));
                        } else if (tempChar !== SPECE_STR && flag) {
                            charMinSize = isVerticalText ? lineHeight : measureTextWidth(ctx, font, tempChar);
                            flag = false;
                        }
                    }
                }
                return charMinSize;
            }
            // 自动换行帮助程序
            var _WordWrapHelper = (function () {
                function _WordWrapHelper() { }
                _WordWrapHelper._getWrapInfo = function (text, size, font, isVerticalText, context2D) {
                    var wrapLines = [];
                    if (!text || text.length === 0) {
                        return wrapLines;
                    }
                    var ctx = context2D ? context2D : _WordWrapHelper_getCtx();
                    if (!ctx) {
                        return wrapLines;
                    }
                    util._setContextFont(ctx, font);
                    var lineHeight = util._getFontHeight(font);
                    if (size <= 0) {
                        var charMinSize = -1;
                        var flag = true;
                        for (var index = 0; index < text.length; index++) {
                            var tempChar = text.charAt(index);
                            if (tempChar !== SPECE_STR && !flag) {
                                charMinSize = Math_min(charMinSize, isVerticalText ? lineHeight : measureTextWidth(ctx, ctx.font, tempChar));
                            } else if (tempChar !== SPECE_STR && flag) {
                                charMinSize = isVerticalText ? lineHeight : measureTextWidth(ctx, ctx.font, tempChar);
                                flag = false;
                            }
                        }
                        size = charMinSize;
                        if (size <= 0) {
                            return [text];
                        }
                    }
                    var lines = text.split(/\r\n|\r|\n/);
                    for (var i = 0; i < lines.length; i++) {
                        var wrapLine = _WordWrapHelper_getWrapInfoByWord(lines[i], size, isVerticalText, lineHeight, ctx);
                        if (wrapLine) {
                            if (wrapLine.length === 0) {
                                wrapLines.push('');
                            } else {
                                for (var j = 0; j < wrapLine.length; j++) {
                                    wrapLines.push(wrapLine[j]);
                                }
                            }
                        }
                    }
                    return wrapLines;
                };
                // 获取垂直信息
                _WordWrapHelper._getVerticalInfo = function (ctx, text, font, wordWrap, wordWrapHeight) {
                    var verticalLines = [];
                    if (text.length === 0) {
                        return verticalLines;
                    }
                    if (!wordWrap) {
                        var lines = text.split(/\r\n|\r|\n/);
                        for (var i = 0; i < lines.length; i++) {
                            var verticalLine = [];
                            for (var j = 0; j < lines[i].length; j++) {
                                verticalLine.push(lines[i][j]);
                            }
                            verticalLines.push(verticalLine);
                        }
                    } else {
                        verticalLines = _WordWrapHelper._getWrapInfo(text, wordWrapHeight, font, true);
                    }
                    return verticalLines;
                };
                // 获取自动换行信息
                _WordWrapHelper._getWordWrapInfo = function (text, size, font, richText, isVerticalText, context2D) {
                    var wrapLines = [];
                    if (text.length === 0) {
                        return wrapLines;
                    }
                    var ctx = context2D ? context2D : _WordWrapHelper_getCtx();
                    if (!ctx) {
                        return wrapLines;
                    }
                    var i;
                    if (size <= 0) {
                        size = resetSize(ctx, richText, font, isVerticalText);
                        if (size <= 0) {
                            var data = [];
                            for (i = 0; i < richText.length; i++) {
                                if (!isNullOrUndefined(richText[i].text)) {
                                    data.push({
                                        textLength: _WordWrapHelper._getTextLengthInLine([richText[i]], font, 1, isVerticalText, false, ctx),
                                        text: richText[i].text,
                                        textInfos: [richText[i]]
                                    });
                                }
                            }
                            return data;
                        }
                    }
                    var separatedLines = _WordWrapHelper._splitTextByLineBreakAndWords(text);
                    var lines = _WordWrapHelper._composeTextInfos(separatedLines, _WordWrapHelper._trimLineBreaksInRichText(richText));
                    for (i = 0; i < lines.length; i++) {
                        var wrapLine = _WordWrapHelper_getRichTextWrapInfoByWord(lines[i], size, font, isVerticalText, ctx);
                        if (wrapLine) {
                            if (wrapLine.length === 0) {
                                wrapLines.push('');
                            } else {
                                for (var j = 0; j < wrapLine.length; j++) {
                                    wrapLines.push(wrapLine[j]);
                                }
                            }
                        }
                    }
                    return wrapLines;
                };
                // 按换行符和单词拆分文本
                _WordWrapHelper._splitTextByLineBreakAndWords = function (text) {
                    var lines = [];
                    var linesByLineBreak = text.split(/\r\n|\r|\n/);
                    for (var i = 0; i < linesByLineBreak.length; i++) {
                        lines.push(_WordWrapHelper_getTextWords(linesByLineBreak[i]));
                    }
                    return lines;
                };
                // 编写文本信息
                _WordWrapHelper._composeTextInfos = function (textSplitByLineBreakAndWords, richText) {
                    var lines = [];
                    var richTextItemIndex = 0;
                    var richTextItemStoredLength = 0;
                    for (var i = 0; i < textSplitByLineBreakAndWords.length; i++) {
                        var line = [];
                        for (var j = 0; j < textSplitByLineBreakAndWords[i].length && richTextItemIndex < richText.length; j++) {
                            var word = textSplitByLineBreakAndWords[i][j];
                            if (word.length <= richText[richTextItemIndex].text.length - richTextItemStoredLength) {
                                line.push([{
                                    style: richText[richTextItemIndex].style,
                                    text: word
                                }]);
                                richTextItemStoredLength += word.length;
                            } else {
                                var wordParts = [];
                                wordParts.push({
                                    style: richText[richTextItemIndex].style,
                                    text: richText[richTextItemIndex].text.substring(richTextItemStoredLength)
                                });
                                var wordLastLength = word.length - (richText[richTextItemIndex].text.length - richTextItemStoredLength);
                                richTextItemIndex++;
                                for (; richTextItemIndex < richText.length; richTextItemIndex++) {
                                    if (wordLastLength < richText[richTextItemIndex].text.length) {
                                        wordParts.push({
                                            style: richText[richTextItemIndex].style,
                                            text: word.substring(word.length - wordLastLength)
                                        });
                                        richTextItemStoredLength = wordLastLength;
                                        break;
                                    } else if (wordLastLength === richText[richTextItemIndex].text.length) {
                                        wordParts.push({
                                            style: richText[richTextItemIndex].style,
                                            text: word.substring(word.length - wordLastLength)
                                        });
                                        richTextItemIndex++;
                                        richTextItemStoredLength = 0;
                                        break;
                                    } else {
                                        wordParts.push({
                                            style: richText[richTextItemIndex].style,
                                            text: richText[richTextItemIndex].text
                                        });
                                        wordLastLength -= richText[richTextItemIndex].text.length;
                                    }
                                }
                                line.push(wordParts);
                            }
                        }
                        lines.push(line);
                    }
                    return lines;
                };
                // 测量文本
                _WordWrapHelper._measureText = function (text, font, withoutEndSpaces, context2D) {
                    var ctx = context2D ? context2D : _WordWrapHelper_getCtx();
                    if (!ctx) {
                        return 0;
                    }
                    if (font) {
                        util._setContextFont(ctx, font);
                    }
                    var tempText = withoutEndSpaces ? _WordWrapHelper_removeEndSpace(text) : text;
                    return measureTextWidth(ctx, ctx.font, tempText);
                };
                // 修剪富文本中的换行符
                _WordWrapHelper._trimLineBreaksInRichText = function (richText) {
                    var richTextWithoutLineBreak = [];
                    for (var i = 0; i < richText.length; i++) {
                        richTextWithoutLineBreak.push({
                            style: richText[i].style,
                            text: richText[i].text ? richText[i].text.replace(/\r\n|\r|\n/g, '') : richText[i].text
                        });
                    }
                    return richTextWithoutLineBreak;
                };
                // 获取文本行长度
                _WordWrapHelper._getTextLengthInLine = function (line, defaultFont, zoomFactor, isVerticalText, withoutEndSpaces, context2D) {
                    var ctx = context2D ? context2D : _WordWrapHelper_getCtx();
                    if (!ctx) {
                        return 0;
                    }
                    var textLength = 0;
                    for (var i = 0; i < line.length; i++) {
                        var font = void 0;
                        if (line[i].style && line[i].style.font) {
                            font = line[i].style.font;
                        } else {
                            font = defaultFont;
                        }
                        util._setContextFont(ctx, font);
                        var text = '';
                        if (i === line.length - 1 && withoutEndSpaces) {
                            text = _WordWrapHelper_removeEndSpace(line[i].text);
                        } else {
                            text = line[i].text;
                        }
                        var tempLength = 0;
                        if (isVerticalText) {
                            tempLength = util._getFontHeight(font) * text.length / zoomFactor;
                        } else if (!isNullOrUndefined(line[i].text)) {
                            tempLength = measureTextWidth(ctx, ctx.font, line[i].text) / zoomFactor;
                        }
                        if (line[i].style && line[i].style.vertAlign) {
                            tempLength = tempLength * subscriptAndSuperscriptScale;
                        }
                        textLength += tempLength;
                    }
                    return textLength;
                };
                // 获取旋转文字换行宽度
                _WordWrapHelper._getRotateTextWordWrapWidth = function (row, col, sinTextOrientation, cosTextOrientation, text, font, cellHeight, context2D) {
                    var textWidth = 0;
                    var lineHeight = util._getFontHeight(font);
                    var wordWrapWidth = (cellHeight - 4 - lineHeight * cosTextOrientation) / sinTextOrientation;
                    var lines = _WordWrapHelper._getWrapInfo(text, wordWrapWidth, font);
                    var lineCount = lines.length;
                    var moveLength = lineHeight / sinTextOrientation;
                    var tempLineHeight = lineHeight * sinTextOrientation;
                    textWidth = (lineCount - 1) * moveLength;
                    textWidth += (_WordWrapHelper._measureText(lines[0], font) / 2) * cosTextOrientation + tempLineHeight;
                    textWidth += (_WordWrapHelper._measureText(lines[lineCount - 1], font) / 2) * cosTextOrientation + tempLineHeight;
                    return textWidth;
                };
                // 
                _WordWrapHelper._removeEndSpace = function (text) {
                    return _WordWrapHelper_removeEndSpace(text);
                };
                _WordWrapHelper._getCtx = function () {
                    return _WordWrapHelper_getCtx();
                };
                return _WordWrapHelper;
            }());
            exports._WordWrapHelper = _WordWrapHelper;

            // 定义特征
            exports._defineFeature = function (obj) {
                // 注册功能
                obj._registerFeature = function (name, feature) {
                    if (!obj._features) {
                        obj._features = [];
                    }
                    obj._featuresCache = {};
                    var features = obj._features;
                    feature.name = name;
                    feature.priority = feature.priority || 5000;
                    for (var i = 0; ; i++) {
                        if (i >= features.length || feature.priority > features[i].priority) {
                            features.splice(i, 0, feature);
                            break;
                        }
                    }
                };
                // 调用功能处理程序
                obj._callFeatureHandler = function (target, fn, eventArg, endLoopFn) {
                    var sf = obj._features;
                    if (sf) {
                        var funtions = obj._featuresCache[fn];
                        if (!funtions) {
                            funtions = obj._featuresCache[fn] = [];
                            for (var i = 0; i < sf.length; i++) {
                                var f = sf[i][fn];
                                if (f) {
                                    funtions.push(f);
                                }
                            }
                        }
                        for (var i = 0; i < funtions.length; i++) {
                            funtions[i].call(target, eventArg);
                            if (endLoopFn && endLoopFn()) {
                                break;
                            }
                        }
                    }
                };
            };

            // 稀疏数组
            var _SparseArray = (function () {
                function _SparseArray() {
                    this._store = {};
                }
                _SparseArray.prototype.get = function (row, col) {
                    var rowNode = this._store[row];
                    return rowNode ? rowNode[col] : keyword_undefined;
                };
                _SparseArray.prototype.set = function (row, col, value) {
                    var rowNode = this._store[row];
                    if (!rowNode) {
                        rowNode = this._store[row] = {};
                    }
                    rowNode[col] = value;
                };
                return _SparseArray;
            }());
            exports._SparseArray = _SparseArray;

            // 编辑器Dom助手
            var _EditorDomHelper = (function () {
                function _EditorDomHelper() { }
                // 处理Backspace和左箭头键事件
                _EditorDomHelper.processBackspaceAndLeftArrowKeyEvent = function (event, isBackspaceKey) {
                    var selection = WINDOW.getSelection();
                    if (selection.rangeCount <= 0) {
                        return;
                    }
                    var anchorNode = selection.anchorNode, anchorOffset = selection.anchorOffset, tempTarget = event.target;
                    if (util.browser.msie && !util.browser.edge && isBackspaceKey && isDeleteLastChar(anchorNode, anchorOffset, tempTarget)) {
                        var tempEditorValue = parseFloat(util.browser.version) < 10 ? getElementInnerText(tempTarget) : tempTarget.innerText;
                        var newValue = tempEditorValue.slice(0, -1);
                        tempTarget.innerHTML = newValue.replace(/\r/g, '').replace(/\n/g, '<br>\u200b');
                        selection.selectAllChildren(tempTarget);
                        if (selection.rangeCount > 0) {
                            selection.collapseToEnd();
                        }
                        cancelDefault(event);
                        return;
                    }
                    var previousCaretInfo = getPreviousCaretInfo(anchorNode, anchorOffset);
                    if (previousCaretInfo && previousCaretInfo.zeroWidthCharNode) {
                        var zeroWidthCharNode = previousCaretInfo.zeroWidthCharNode, previousTextNode = previousCaretInfo.previousTextNode;
                        if (isBackspaceKey) {
                            if (isSpanElement(zeroWidthCharNode)) {
                                zeroWidthCharNode.parentNode.removeChild(zeroWidthCharNode);
                            } else {
                                zeroWidthCharNode.parentNode.removeChild(zeroWidthCharNode.previousSibling);
                                if (isBrElement(previousTextNode)) {
                                    cancelDefault(event);
                                    return;
                                }
                                var range = selection.getRangeAt(0);
                                range.setStart(zeroWidthCharNode, 0);
                                range.setEnd(zeroWidthCharNode, 1);
                                range.deleteContents();
                            }
                        }
                        var newRange = DOCUMENT.createRange();
                        newRange.setStartAfter(previousTextNode);
                        newRange.setEndAfter(previousTextNode);
                        newRange.collapse(false);
                        selection.removeAllRanges();
                        selection.addRange(newRange);
                        cancelDefault(event);
                    }
                };
                // 处理删除和右箭头键事件
                _EditorDomHelper.processDeleteAndRightArrowKeyEvent = function (event, isDeleteKey) {
                    var selection = WINDOW.getSelection();
                    if (selection.rangeCount <= 0) {
                        return;
                    }
                    var caretInfo = getNextCaretInfo(selection);
                    if (caretInfo && caretInfo.node) {
                        var zeroWidthCharNode = caretInfo.node, caretOffset = caretInfo.offset;
                        if (isDeleteKey) {
                            var range = selection.getRangeAt(0);
                            range.setStart(zeroWidthCharNode, 0);
                            range.setEnd(zeroWidthCharNode, 1);
                            range.deleteContents();
                            zeroWidthCharNode.parentNode.removeChild(zeroWidthCharNode.previousSibling);
                        } else {
                            var newRange = DOCUMENT.createRange();
                            newRange.setStart(zeroWidthCharNode, caretOffset);
                            newRange.setEnd(zeroWidthCharNode, caretOffset);
                            newRange.collapse(false);
                            selection.removeAllRanges();
                            selection.addRange(newRange);
                        }
                        cancelDefault(event);
                    }
                };
                return _EditorDomHelper;
            }());
            exports._EditorDomHelper = _EditorDomHelper;
            // 是否删除最后一个字符
            function isDeleteLastChar(anchorNode, anchorOffset, target) {
                if (anchorOffset === 1 && isSpanElement(target.firstChild) && isSpanElement(target.firstChild.firstChild)) {
                    var tempLastChild = target.firstChild.firstChild.lastChild, tempValue = void 0;
                    if (anchorNode === target) {
                        tempValue = tempLastChild.textContent;
                        return tempValue.length === 1 && tempValue[0] !== ZERO_WIDTH_CHAR && isBrElement(tempLastChild.previousSibling);
                    } else if (tempLastChild === anchorNode || isBrElement(tempLastChild) && anchorNode === tempLastChild.previousSibling) {
                        tempValue = anchorNode.textContent;
                        return tempValue.length === 1 && tempValue[0] !== ZERO_WIDTH_CHAR && isBrElement(anchorNode.previousSibling);
                    }
                }
                return false;
            }
            function isSpanElement(element) {
                return element && element.tagName === 'SPAN';
            }
            function isBrElement(element) {
                return element && element.tagName === 'BR';
            }
            function isDivElement(element) {
                return element && element.tagName === 'DIV';
            }
            function isTextNode(element) {
                return element instanceof Text;
            }
            // 是否仅具有零宽度span
            function isOnlyWithZeroWidthChartSpan(element) {
                if (element) {
                    var childNodes = element.childNodes;
                    return isSpanElement(element) && childNodes.length === 2 && isBrElement(childNodes[0]) && isZeroWidthCharTextNode(childNodes[1]);
                }
                return false;
            }
            // 是零宽度字符文本节点
            function isZeroWidthCharTextNode(element) {
                if (element && isTextNode(element)) {
                    var textContent = element.textContent;
                    if (textContent.length === 1 && isZeroWidthChar(textContent[0])) {
                        return true;
                    }
                }
                return false;
            }
            // 获取上一个光标信息
            function getPreviousCaretInfo(anchorNode, anchorOffset) {
                var childNodesLength = anchorNode.childNodes.length;
                var nodeWithZeroWidthChar, tempNode;
                if (isZeroWidthChar(anchorNode.textContent[0]) && (anchorOffset === 0 || anchorOffset === 1)) {
                    nodeWithZeroWidthChar = anchorNode;
                } else if (anchorOffset === 0) {
                    tempNode = anchorNode;
                    if (anchorNode === anchorNode.parentNode.firstChild) {
                        tempNode = anchorNode.parentNode;
                    }
                    var spanNode = findPreviousNodeWithCondition(tempNode, isOnlyWithZeroWidthChartSpan);
                    nodeWithZeroWidthChar = spanNode && spanNode.lastChild;
                } else if (isDivElement(anchorNode)) {
                    if (childNodesLength === 1 && anchorOffset === 1) {
                        nodeWithZeroWidthChar = anchorNode.firstChild.firstChild.lastChild;
                    } else if (childNodesLength > 1 && anchorOffset === childNodesLength) {
                        nodeWithZeroWidthChar = anchorNode.lastChild;
                    }
                    if (isZeroWidthCharTextNode(nodeWithZeroWidthChar)) {
                        return {
                            zeroWidthCharNode: nodeWithZeroWidthChar,
                            previousTextNode: nodeWithZeroWidthChar.previousSibling.previousSibling
                        };
                    } else if (isOnlyWithZeroWidthChartSpan(nodeWithZeroWidthChar)) {
                        return {
                            zeroWidthCharNode: nodeWithZeroWidthChar,
                            previousTextNode: findPreviousNodeWithCondition(tempNode, isTextNode)
                        };
                    }
                    return keyword_null;
                } else if (isSpanElement(anchorNode) && (anchorOffset === childNodesLength || anchorOffset === childNodesLength - 1)) {
                    if (isOnlyWithZeroWidthChartSpan(anchorNode)) {
                        nodeWithZeroWidthChar = anchorNode;
                    } else if (isOnlyWithZeroWidthChartSpan(anchorNode.lastChild)) {
                        nodeWithZeroWidthChar = anchorNode.lastChild;
                    }
                }
                if (nodeWithZeroWidthChar) {
                    if (isSpanElement(nodeWithZeroWidthChar)) {
                        tempNode = nodeWithZeroWidthChar;
                    } else if (isTextNode(nodeWithZeroWidthChar)) {
                        var tempPreviousNode = nodeWithZeroWidthChar.previousSibling, parentNode = nodeWithZeroWidthChar.parentNode;
                        if (tempPreviousNode === parentNode.firstChild) {
                            tempNode = parentNode;
                        } else {
                            tempNode = tempPreviousNode;
                        }
                    }
                    return {
                        zeroWidthCharNode: nodeWithZeroWidthChar,
                        previousTextNode: findPreviousNodeWithCondition(tempNode, isTextNode)
                    };
                }
                return keyword_null;
            }
            // 获取下一个光标信息
            function getNextCaretInfo(selection) {
                var anchorNode = selection.anchorNode, anchorOffset = selection.anchorOffset;
                var textContent = anchorNode.textContent, textContentLength = textContent.length;
                if (anchorOffset === textContentLength) {
                    var nextNode = findNextNode(anchorNode), zeroWidthCharNode = void 0;
                    if (!nextNode) {
                        return keyword_null;
                    }
                    if (isSpanElement(nextNode) && isZeroWidthChar(nextNode.textContent[0])) {
                        while (isSpanElement(nextNode.firstChild)) {
                            nextNode = nextNode.firstChild;
                        }
                        zeroWidthCharNode = nextNode.childNodes[1];
                    } else if (isBrElement(nextNode) && isZeroWidthChar(nextNode.nextSibling.textContent[0])) {
                        zeroWidthCharNode = nextNode.nextSibling;
                    }
                    return {
                        node: zeroWidthCharNode,
                        offset: 1
                    };
                }
                return keyword_null;
            }
            // 获取元素内部文本
            function getElementInnerText(element, range, start, end, letter, isNodeInSelection) {
                var content = '';
                var childNodes = element.childNodes, length = childNodes.length;
                for (var i = 0; i < length; i++) {
                    var item = childNodes[i];
                    if (isSpanElement(item)) {
                        content += getElementInnerText(item, range, start, end, letter, isNodeInSelection);
                    } else if (isTextNode(item)) {
                        var startContainer = range && range.startContainer, endContainer = range && range.endContainer;
                        var tempContent = item.textContent;
                        if (item === startContainer || item === endContainer) {
                            if (startContainer !== endContainer) {
                                if (item === startContainer) {
                                    content += getCaretSelectionInputtingValue(tempContent, start, tempContent.length, letter);
                                    isNodeInSelection = true;
                                } else {
                                    content += getCaretSelectionInputtingValue(tempContent, 0, end, '');
                                    isNodeInSelection = false;
                                }
                            } else {
                                content += getCaretSelectionInputtingValue(tempContent, start, end, letter);
                            }
                        } else if (!isNodeInSelection) {
                            content += tempContent;
                        }
                    } else if (isBrElement(item) && !isNodeInSelection) {
                        content += '\n';
                    }
                }
                return content;
            }
            // 获取光标选择输入值
            function getCaretSelectionInputtingValue(value, start, end, letter) {
                var preValue = value.substr(0, start);
                var endValue = value.substr(end, value.length - end);
                return preValue + letter + endValue;
            }
            // 是零宽度字符
            function isZeroWidthChar(letter) {
                return letter === ZERO_WIDTH_CHAR;
            }
            // 查找符合条件的上一个节点
            function findPreviousNodeWithCondition(argNode, callback) {
                var tempNode = argNode && argNode.previousSibling;
                while (tempNode) {
                    if (callback(tempNode)) {
                        return tempNode;
                    }
                    tempNode = tempNode.lastChild;
                }
                return keyword_null;
            }
            // 查找下一个节点
            function findNextNode(argNode) {
                var tempNode = argNode;
                while (tempNode) {
                    var tempParentNode = tempNode.parentNode;
                    if (tempNode !== tempParentNode.lastChild) {
                        return tempNode.nextSibling;
                    }
                    tempNode = tempParentNode;
                }
                return keyword_null;
            }
            // 支持的功能
            exports._supportedFeatures = {
                touch: false
            };
            // 获取活动表
            function _getActiveSheet(spread) {
                var sheet;
                if (spread) {
                    sheet = spread.getActiveSheet();
                    if (!sheet) {
                        var sheetTab = spread.getActiveSheetTab();
                        if (sheetTab) {
                            sheet = sheetTab._sheet;
                        }
                    }
                }
                return sheet;
            }
            exports._getActiveSheet = _getActiveSheet;
            function _setActiveSheet(spread, sheetName) {
                if (spread) {
                    var sheet = spread.getSheetFromName(sheetName);
                    if (sheet) {
                        spread.setActiveSheet(sheetName);
                    } else {
                        var tablesheet = spread.getSheetTab(sheetName);
                        if (tablesheet) {
                            spread.setActiveSheetTab(sheetName);
                        }
                    }
                }
            }
            exports._setActiveSheet = _setActiveSheet;
            // 从名称获取工作表
            function _getSheetFromName(spread, name) {
                var sheet = spread.getSheetFromName(name);
                if (!sheet) {
                    var sheetTab = spread.getSheetTab(name);
                    if (sheetTab) {
                        sheet = sheetTab._sheet;
                    }
                }
                return sheet;
            }
            exports._getSheetFromName = _getSheetFromName;
        }),
        './dist/core/util/domUtil.js': (function (module, exports, __webpack_require__) {
            Object.defineProperty(exports, '__esModule', { value: true });
            var Common_1 = __webpack_require__(/*! Common */ 'Common');
            var Types = Common_1.Common._Types;
            var hasOwnProperty = Common_1.Common._hasOwnProperty;
            var keyword_undefined = void 0;
            var keyword_null = null;
            var convertToFloat = parseFloat;
            var DOCUMENT = document;
            var NO_NAMESPACE = '_nonamespace';
            var EVENTS = 'events';
            var str_get = 'get';
            var str_set = 'set';
            var str_width = 'width';
            var str_height = 'height';
            var str_left = 'left';
            var str_right = 'right';
            var str_top = 'top';
            var str_bottom = 'bottom';
            var css_hidden = 'hidden';
            var css_block = 'block';
            var css_none = 'none';
            var css_position = 'position';
            var css_visibility = 'visibility';
            var css_display = 'display';
            var propFix = {
                tabindex: 'tabIndex',
                readonly: 'readOnly',
                for: 'htmlFor',
                class: 'className',
                maxlength: 'maxLength',
                cellspacing: 'cellSpacing',
                cellpadding: 'cellPadding',
                rowspan: 'rowSpan',
                colspan: 'colSpan',
                usemap: 'useMap',
                frameborder: 'frameBorder',
                contenteditable: 'contentEditable'
            };
            var propHooks = {
                tabIndex: {
                    get: function (elem) {
                        var attributeNode = elem.getAttributeNode('tabindex');
                        var rfocusable = /^(?:input|select|textarea|button|object)$/i, rclickable = /^(?:a|area)$/i;
                        var nodeName = elem.nodeName;
                        if (attributeNode && attributeNode.specified) {
                            return parseInt(attributeNode.value, 10);
                        }
                        return rfocusable.test(nodeName) || rclickable.test(nodeName) && elem.href ? 0 : keyword_undefined;
                    }
                }
            };
            var valHooks = {
                option: {
                    get: function (elem) {
                        var val = elem.attributes.value;
                        return !val || val.specified ? elem.value : elem.text;
                    }
                },
                select: {
                    get: function (elem) {
                        var value, option, options = elem.options, index = elem.selectedIndex, one = elem.type === 'select-one' || index < 0, values = one ? keyword_null : [], max = one ? index + 1 : options.length, i = one ? index : 0;
                        if (index < 0) {
                            i = max;
                        }
                        for (; i < max; i++) {
                            option = options[i];
                            if ((option.selected || i === index) && !option.disabled && (!option.parentNode.disabled || !getNodeName(option.parentNode, 'optgroup'))) {
                                value = $(option).val();
                                if (one) {
                                    return value;
                                }
                                values.push(value);
                            }
                        }
                        return values;
                    },
                    set: function (elem, value) {
                        var values = $.makeArray(value);
                        var elements = $(elem).find('option').getAll();
                        elements.forEach(function (e) {
                            e.selected = $.inArray($(e).val(), values) >= 0;
                        });
                        if (!values.length) {
                            elem.selectedIndex = -1;
                        }
                        return values;
                    }
                }
            };
            var globalCache = {};
            var expando = '$' + ('' + Math.random()).replace(/\D/g, '');
            var guid = 1;
            var cssHooks = {};
            [str_height, str_width].forEach(function (name) {
                cssHooks[name] = {
                    get: function (elem) {
                        var computedStyle = getComputedStyle(elem);
                        var style = elem.style;
                        var originalPosition = style[css_position], originalVisibility = style[css_visibility], originalDisplay = style[css_display];
                        var elemIsInvisible = elem.offsetWidth === 0 && /^(none|table(?!-c[ea]).+)/.test(computedStyle[css_display]);
                        if (elemIsInvisible) {
                            style[css_position] = 'absolute';
                            style[css_visibility] = css_hidden;
                            style[css_display] = css_block;
                        }
                        var ret = computedStyle && computedStyle[name];
                        if (elemIsInvisible) {
                            style[css_position] = originalPosition;
                            style[css_visibility] = originalVisibility;
                            style[css_display] = originalDisplay;
                        }
                        if (ret === '') {
                            var parentElement = elem.parentElement, bodyElement = DOCUMENT.body;
                            while (parentElement && parentElement !== bodyElement) {
                                parentElement = parentElement.parentElement;
                            }
                            if (parentElement !== bodyElement) {
                                ret = style[name];
                            }
                        }
                        return ret;
                    }
                };
            });
            function init(selectors, context) {
                Array.call(this);
                var list;
                if (typeof selectors === 'string') {
                    list = (context || DOCUMENT).querySelectorAll(selectors);
                } else if (selectors) {
                    if (Types._isArray(selectors) || selectors instanceof HTMLCollection) {
                        list = selectors;
                    } else {
                        list = [selectors];
                    }
                }
                for (var i = 0; list && i < list.length; i++) {
                    this.push(list[i]);
                }
            }
            var $ = function (selectors, context) {
                if (selectors instanceof init) {
                    return selectors;
                }
                return new init(selectors, context);
            };
            exports.GC$ = $;

            var prototypeEx = {
                get: function (index) {
                    return this[index];
                },
                getAll: function () {
                    return this;
                },
                bind: function (eventType, data, listener) {
                    var self = this;
                    if (isUndefined(listener)) {
                        listener = data;
                        data = keyword_undefined;
                    }
                    self.forEach(function (elem) {
                        var elemData = internalData(elem, EVENTS, keyword_undefined, true);
                        if (!elemData) {
                            elemData = {};
                            internalData(elem, EVENTS, elemData, true);
                        }
                        var array = eventType.split('.');
                        var actualName = array[0];
                        var namespace = array[1] || NO_NAMESPACE;
                        var nsObj = elemData[namespace];
                        if (!nsObj) {
                            nsObj = elemData[namespace] = {};
                        }
                        var actualListener = function (e) {
                            if (!isUndefined(data)) {
                                e.data = data;
                            }
                            var returnValue = listener.apply(elem, arguments);
                            e.result = returnValue;
                            if (returnValue === false) {
                                if (e.preventDefault) {
                                    e.preventDefault();
                                    e.stopPropagation();
                                } else {
                                    e.cancelBubble = false;
                                    e.returnValue = false;
                                }
                            }
                        };
                        actualListener.original = listener;
                        var listenerArray = nsObj[actualName];
                        if (!listenerArray) {
                            listenerArray = nsObj[actualName] = [];
                        }
                        listenerArray.push(actualListener);
                        elem.addEventListener(actualName, actualListener);
                    });
                    return self;
                },
                unbind: function (eventType, listener) {
                    var self = this;
                    self.forEach(function (elem) {
                        var array = eventType.split('.');
                        var actualName = array[0];
                        var namespace = array[1] || NO_NAMESPACE;
                        var elemData = internalData(elem, EVENTS, keyword_undefined, true);
                        var nsObj = elemData && elemData[namespace], listenerArray, i, length;
                        if (listener) {
                            if (nsObj && actualName) {
                                listenerArray = nsObj[actualName];
                                if (listenerArray) {
                                    length = listenerArray.length;
                                    for (i = 0; i < length; i++) {
                                        if (listenerArray[i].original === listener) {
                                            removeEventListener(elem, actualName, listenerArray[i]);
                                            listenerArray.splice(i, 1);
                                            break;
                                        }
                                    }
                                }
                            }
                        } else if (nsObj) {
                            if (actualName) {
                                listenerArray = nsObj[actualName];
                                if (listenerArray) {
                                    length = listenerArray.length;
                                    for (i = 0; i < length; i++) {
                                        removeEventListener(elem, actualName, listenerArray[i]);
                                    }
                                }
                                nsObj[actualName] = keyword_undefined;
                            } else {
                                for (var ns in nsObj) {
                                    if (hasOwnProperty(nsObj, ns)) {
                                        listenerArray = nsObj[ns];
                                        if (listenerArray) {
                                            length = listenerArray.length;
                                            for (i = 0; i < length; i++) {
                                                removeEventListener(elem, ns, listenerArray[i]);
                                            }
                                        }
                                    }
                                }
                                elemData[namespace] = keyword_undefined;
                            }
                        }
                    });
                    return self;
                },
                trigger: function (eventType, args) {
                    var self = this;
                    for (var index = 0, count = self.length; index < count; index++) {
                        var elem = self[index];
                        var elemData = internalData(elem, EVENTS, keyword_undefined, true);
                        if (elemData) {
                            var array = eventType.split('.');
                            var actualName = array[0];
                            for (var ns in elemData) {
                                if (hasOwnProperty(elemData, ns)) {
                                    var nsObj = elemData[ns];
                                    var listenerArray = nsObj && nsObj[actualName];
                                    if (listenerArray) {
                                        for (var i = 0, length_1 = listenerArray.length; i < length_1; i++) {
                                            listenerArray[i].apply(elem, [
                                                {
                                                    type: actualName
                                                },
                                                args
                                            ]);
                                        }
                                    }
                                }
                            }
                        }
                    }
                    return self;
                },
                css: function (cssName, cssValue) {
                    var self = this;
                    var elements = self;
                    var argumentsLength = arguments.length;
                    function applyStyle(name, value) {
                        elements.forEach(function (elem) {
                            elem.style[name] = fixCssValue(name, value);
                        });
                    }
                    if (argumentsLength === 1) {
                        if (isObject(cssName)) {
                            elements.forEach(function (value) {
                                for (var p in cssName) {
                                    if (hasOwnProperty(cssName, p)) {
                                        value.style[p] = fixCssValue(p, cssName[p]);
                                    }
                                }
                            });
                        } else {
                            var firstElem = self[0];
                            var hooks = cssHooks[cssName];
                            if (hooks && str_get in hooks) {
                                return hooks.get(firstElem);
                            }
                            var style = getComputedStyle(firstElem);
                            return style && style[cssName];
                        }
                    } else if (argumentsLength === 2) {
                        if (Array.isArray(cssName) && Array.isArray(cssValue) && cssName.length === cssValue.length) {
                            cssName.forEach(function (value, index) {
                                applyStyle(value, cssValue[index]);
                            });
                        } else {
                            applyStyle(cssName, cssValue);
                        }
                    }
                    return self;
                },
                width: defineWidthHeight(true),
                height: defineWidthHeight(),
                innerWidth: defineInnerWidthInnerHeight(true),
                innerHeight: defineInnerWidthInnerHeight(),
                outerWidth: defineOuterWidthOuterHeight(true),
                outerHeight: defineOuterWidthOuterHeight(),
                append: function (child) {
                    var children = [child];
                    if (child instanceof $) {
                        children = child.getAll();
                    }
                    var self = this;
                    var parentElement = self[0];
                    children.forEach(function (el) {
                        if (el) {
                            parentElement.appendChild(el);
                        }
                    });
                    return self;
                },
                appendTo: function (parent) {
                    var parentElement = parent;
                    if (parent instanceof $) {
                        parentElement = parent[0];
                    }
                    var self = this;
                    self.forEach(function (value) {
                        parentElement.appendChild(value);
                    });
                    return self;
                },
                prepend: function (element) {
                    var self = this;
                    var parentElement = self[0];
                    parentElement.insertBefore(element, parentElement.firstChild);
                    return self;
                },
                insertBefore: function (element) {
                    var self = this;
                    var parentElement = element.parentElement;
                    self.forEach(function (value) {
                        parentElement.insertBefore(value, element);
                    });
                    return self;
                },
                addClass: function (className) {
                    var classes;
                    var elem;
                    var cur;
                    var clazz;
                    var j;
                    var i = 0;
                    var elements = this;
                    var len = elements.length;
                    var core_rnotwhite = /\S+/g;
                    var rclass = /[\t\r\n]/g;
                    classes = (className || '').match(core_rnotwhite) || [];
                    for (; i < len; i++) {
                        elem = elements[i];
                        cur = elem.nodeType === 1 && (elem.className ? (' ' + elem.className + ' ').replace(rclass, ' ') : ' ');
                        if (cur) {
                            j = 0;
                            clazz = classes[j];
                            while (clazz) {
                                if (cur.indexOf(' ' + clazz + ' ') < 0) {
                                    cur += clazz + ' ';
                                }
                                j++;
                                clazz = classes[j];
                            }
                            elem.className = $.trim(cur);
                        }
                    }
                    return this;
                },
                removeClass: function (className) {
                    var classes;
                    var elem;
                    var cur;
                    var clazz;
                    var j;
                    var i = 0;
                    var elements = this;
                    var len = elements.length;
                    var core_rnotwhite = /\S+/g;
                    var rclass = /[\t\r\n]/g;
                    classes = (className || '').match(core_rnotwhite) || [];
                    for (; i < len; i++) {
                        elem = elements[i];
                        cur = elem.nodeType === 1 && (elem.className ? (' ' + elem.className + ' ').replace(rclass, ' ') : '');
                        if (cur) {
                            j = 0;
                            clazz = classes[j];
                            while (clazz) {
                                while (cur.indexOf(' ' + clazz + ' ') >= 0) {
                                    cur = cur.replace(' ' + clazz + ' ', ' ');
                                }
                                j++;
                                clazz = classes[j];
                            }
                            elem.className = className ? $.trim(cur) : '';
                        }
                    }
                    return this;
                },
                hasClass: function (className) {
                    var i = 0;
                    var elements = this;
                    var l = elements.length;
                    var rclass = /[\t\r\n]/g;
                    className = ' ' + className + ' ';
                    for (; i < l; i++) {
                        var el = elements[i];
                        if (el.nodeType === 1 && (' ' + el.className + ' ').replace(rclass, ' ').indexOf(className) >= 0) {
                            return true;
                        }
                    }
                    return false;
                },
                toggle: function () {
                    var self = this;
                    var firstElement = self[0];
                    if (firstElement.style[css_display] === css_none) {
                        self.show();
                    } else {
                        self.hide();
                    }
                    return self;
                },
                show: defineShowHide(true),
                hide: defineShowHide(),
                attr: function (attrName, attrValue) {
                    var self = this;
                    var elements = self;
                    var argumentsLength = arguments.length;
                    if (argumentsLength === 1) {
                        if (isObject(attrName)) {
                            elements.forEach(function (value) {
                                for (var p in attrName) {
                                    if (hasOwnProperty(attrName, p)) {
                                        value.setAttribute(p, attrName[p]);
                                    }
                                }
                            });
                        } else {
                            return self[0].getAttribute(attrName);
                        }
                    } else if (argumentsLength === 2) {
                        elements.forEach(function (value) {
                            value.setAttribute(attrName, attrValue);
                        });
                    }
                    return self;
                },
                removeAttr: function (name) {
                    this.forEach(function (value) {
                        value.removeAttribute(name);
                    });
                    return this;
                },
                prop: function (propName, propValue) {
                    var self = this;
                    var elements = self;
                    var argumentsLength = arguments.length;
                    if (argumentsLength === 1) {
                        if (isObject(propName)) {
                            elements.forEach(function (value) {
                                for (var p in propName) {
                                    if (hasOwnProperty(propName, p)) {
                                        internalProp(value, p, propName[p]);
                                    }
                                }
                            });
                        } else {
                            return internalProp(self[0], propName);
                        }
                    } else if (argumentsLength === 2) {
                        elements.forEach(function (value) {
                            internalProp(value, propName, propValue);
                        });
                    }
                    return self;
                },
                removeProp: function (propName) {
                    propName = propFix[propName] || propName;
                    var self = this;
                    var elements = self;
                    elements.forEach(function (value) {
                        try {
                            value[propName] = keyword_undefined;
                            delete value[propName];
                        } catch (e) { }
                    });
                    return self;
                },
                text: function (text) {
                    var self = this;
                    var elements = self;
                    if (arguments.length === 0) {
                        return self[0].textContent;
                    }
                    elements.forEach(function (value) {
                        value.textContent = text;
                    });
                    return self;
                },
                val: function (value) {
                    var self = this;
                    var hooks;
                    if (!arguments.length) {
                        var firstElem = self[0], ret = void 0;
                        if (firstElem) {
                            hooks = valHooks[firstElem.type] || valHooks[firstElem.nodeName.toLowerCase()];
                            if (hooks && str_get in hooks) {
                                ret = hooks.get(firstElem, 'value');
                                if (!isUndefined(ret)) {
                                    return ret;
                                }
                            }
                            ret = firstElem.value;
                            if (isString(ret)) {
                                return ret.replace(/\r/g, '');
                            }
                            return ret === keyword_null || ret === keyword_undefined ? '' : ret;
                        }
                        return;
                    }
                    var isFunction = $.isFunction(value);
                    self.forEach(function (elem, i) {
                        var val;
                        if (elem.nodeType !== 1) {
                            return;
                        }
                        if (isFunction) {
                            val = value.call(elem, i, $(elem).val());
                        } else {
                            val = value;
                        }
                        if (val === keyword_null || val === keyword_undefined) {
                            val = '';
                        } else if (typeof val === 'number') {
                            val = val + '';
                        } else if ($.isArray(val)) {
                            val = $.map(val, function (item) {
                                return item === keyword_null || item === keyword_undefined ? '' : item + '';
                            });
                        }
                        hooks = valHooks[elem.type] || valHooks[elem.nodeName.toLowerCase()];
                        if (!hooks || !(str_set in hooks) || isUndefined(hooks.set(elem, val, 'value'))) {
                            elem.value = val;
                        }
                    });
                    return self;
                },
                position: function () {
                    var elem = this[0];
                    if (!elem) {
                        return;
                    }
                    var offset = {
                        top: 0,
                        left: 0
                    };
                    var parentOffset = {
                        top: 0,
                        left: 0
                    };
                    if ($(elem).css(css_position) === 'fixed') {
                        try {
                            offset = elem.getBoundingClientRect();
                        } catch (e) { }
                    } else {
                        var offsetParent = this.offsetParent();
                        offset = this.offset();
                        var firstOffsetParent = offsetParent[0];
                        if (!getNodeName(firstOffsetParent, 'html')) {
                            parentOffset = offsetParent.offset();
                            parentOffset.left -= firstOffsetParent.scrollLeft;
                            parentOffset.top -= firstOffsetParent.scrollTop;
                        }
                        parentOffset.top += convertToFloat($(firstOffsetParent).css('borderTopWidth'));
                        parentOffset.left += convertToFloat($(firstOffsetParent).css('borderLeftWidth'));
                    }
                    return {
                        top: offset.top - parentOffset.top - convertToFloat($(elem).css('marginTop')),
                        left: offset.left - parentOffset.left - convertToFloat($(elem).css('marginLeft'))
                    };
                },
                // 偏移父级
                offsetParent: function () {
                    var array = $.map(this, function (element) {
                        var documentElement = DOCUMENT.documentElement;
                        var offsetParent = element.offsetParent || documentElement;
                        while (offsetParent && (!getNodeName(offsetParent, 'html') && $(offsetParent).css(css_position) === 'static')) {
                            offsetParent = offsetParent.offsetParent;
                        }
                        return offsetParent || documentElement;
                    });
                    return $(array);
                },
                offset: function () {
                    var docElem;
                    var win;
                    var box = {
                        top: 0,
                        left: 0
                    };
                    var elem = this[0];
                    var ownerDocument = elem && elem.ownerDocument;
                    if (!ownerDocument) {
                        return;
                    }
                    docElem = ownerDocument.documentElement;
                    if (!isUndefined(elem.getBoundingClientRect)) {
                        try {
                            box = elem.getBoundingClientRect();
                        } catch (e) { }
                    }
                    win = getWindow(ownerDocument);
                    return {
                        top: box.top + (win.pageYOffset || docElem.scrollTop) - (docElem.clientTop || 0),
                        left: box.left + (win.pageXOffset || docElem.scrollLeft) - (docElem.clientLeft || 0)
                    };
                },
                scrollLeft: defineScrollLeftScrollTop(true),
                scrollTop: defineScrollLeftScrollTop(),
                html: function (html) {
                    var self = this;
                    var elements = self;
                    if (arguments.length === 0) {
                        return self[0].innerHTML;
                    }
                    elements.forEach(function (value) {
                        value.innerHTML = html;
                    });
                    return self;
                },
                remove: function () {
                    var elements = this;
                    elements.forEach(function (value) {
                        var parent = value.parentElement;
                        if (parent) {
                            parent.removeChild(value);
                            cleanData([value]);
                        }
                    });
                },
                empty: function () {
                    this.forEach(function (value) {
                        $(value.children).remove();
                    });
                    return this;
                },
                find: function (selectors) {
                    var allList = [];
                    if (isString(selectors)) {
                        this.forEach(function (value) {
                            var list = value.querySelectorAll(selectors);
                            $.merge(allList, list);
                        });
                    }
                    return $(allList);
                },
                parent: function () {
                    var list = [];
                    this.forEach(function (value) {
                        var parentElement = value.parentElement;
                        if (parentElement) {
                            list.push(parentElement);
                        }
                    });
                    return $(list);
                },
                index: function (elem) {
                    var first = this[0];
                    if (!elem) {
                        return first && first.parentElement ? $.inArray(first, first.parentElement.children) : -1;
                    }
                    if (isString(elem)) {
                        return $.inArray(first, $(elem).getAll());
                    }
                    return $.inArray(elem, this);
                },
                focus: function () {
                    var self = this;
                    var firstElement = self[0];
                    if (firstElement !== DOCUMENT.activeElement && firstElement.focus) {
                        firstElement.focus();
                    }
                    return self;
                },
                isVisible: function () {
                    var visibleElementCount = 0;
                    this.forEach(function (elem) {
                        var style = getComputedStyle(elem);
                        if (style[css_visibility] !== css_hidden && style[css_display] !== css_none) {
                            visibleElementCount++;
                        }
                    });
                    return visibleElementCount > 0;
                },
                data: function (name, data) {
                    var returnValue = this;
                    var isGet = isUndefined(data);
                    if (isGet) {
                        returnValue = void 0;
                    }
                    $.each(this, function (index, elem) {
                        var result = internalData(elem, name, data);
                        if (isGet) {
                            returnValue = result;
                            return false;
                        }
                    });
                    return returnValue;
                },
                removeData: function (name) {
                    $.each(this, function (index, elem) {
                        internalRemoveData(elem, name);
                    });
                    return this;
                }
            };
            var init_prototype = init.prototype = [];
            Types._extend(init_prototype, prototypeEx);
            $.prototype = init_prototype;
            $.each = Types._each;
            $.isEmptyObject = Types._isEmptyObject;
            $.isFunction = Types._isFunction;
            $.isArray = Types._isArray;
            $.isNumeric = Types._isNumeric;
            $.getType = Types._getType;
            $.inArray = Types._inArray;
            $.merge = Types._merge;
            $.map = Types._map;
            $.extend = Types._extend;
            $.inherit = Types._inherit;
            $.isPlainObject = Types._isPlainObject;
            $.isArraylike = Types._isArraylike;
            $.isWindow = Types._isWindow;
            $.makeArray = Types._makeArray;
            $.trim = function (text) {
                if (text.trim) {
                    return text.trim();
                }
                var rtrim = /^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g;
                return text === keyword_null || text === keyword_undefined ? '' : (text + '').replace(rtrim, '');
            };
            $._createElement = function (tag, cssName, cssValue, cssClass, parentElement) {
                var element = $(DOCUMENT.createElement(tag));
                if (cssName && cssValue) {
                    element.css(cssName, cssValue);
                }
                if (cssClass) {
                    element.addClass(cssClass);
                }
                if (parentElement) {
                    if (parentElement instanceof $) {
                        parentElement.append(element);
                    } else {
                        $(parentElement).append(element);
                    }
                }
                return element;
            };
            function getHostMaxZIndex(host) {
                var maxZIndex = getDomZIndex(host);
                while (host.parentElement) {
                    host = host.parentElement;
                    var zIndex = getDomZIndex(host);
                    if (zIndex > maxZIndex) {
                        maxZIndex = zIndex;
                    }
                }
                return maxZIndex;
            }
            exports.getHostMaxZIndex = getHostMaxZIndex;
            function getDomZIndex(dom) {
                var zIndex = getComputedStyle(dom).zIndex;
                if (zIndex === 'auto' || zIndex === '') {
                    return 0;
                } else {
                    return Number(zIndex);
                }
            }
            function getWindow(elem) {
                if ($.isWindow(elem)) {
                    return elem;
                }
                return elem.nodeType === 9 ? elem.defaultView || elem.parentWindow : false;
            }
            function getNodeName(elem, name) {
                var nodeName = elem.nodeName;
                return nodeName && nodeName.toLowerCase() === name.toLowerCase();
            }
            // 修复Css值
            function fixCssValue(cssName, cssValue) {
                if ('top left right bottom width height border-radius border-width border-left-width border-right-width border-top-width border-bottom-width line-height padding padding-left padding-right padding-top padding-bottom margin margin-left margin-right margin-top margin-bottom'.split(' ').indexOf(cssName) >= 0 && isFinite(cssValue)) {
                    if ('width height'.split(' ').indexOf(cssName) >= 0 && cssValue < 0) {
                        cssValue = 0;
                    }
                    return cssValue + 'px';
                }
                return cssValue;
            }
            function internalProp(elem, name, value) {
                var ret, hooks, notxml, nType = elem.nodeType;
                if (!elem || nType === 3 || nType === 8 || nType === 2) {
                    return;
                }
                notxml = nType !== 1;
                if (notxml) {
                    name = propFix[name] || name;
                    hooks = propHooks[name];
                }
                if (!isUndefined(value)) {
                    if (hooks && str_set in hooks) {
                        ret = hooks.set(elem, value, name);
                        if (!isUndefined(ret)) {
                            return ret;
                        }
                    }
                    elem[name] = value;
                    return value;
                }
                if (hooks && str_get in hooks) {
                    ret = hooks.get(elem, name);
                    if (ret !== keyword_null) {
                        return ret;
                    }
                }
                return elem[name];
            }
            // 接受数据
            function acceptData(elem) {
                var nodeType = elem.nodeType;
                if (nodeType && nodeType !== 1 && nodeType !== 9) {
                    return false;
                }
                var noDataDict = {
                    embed: true,
                    object: 'clsid:D27CDB6E-AE6D-11cf-96B8-444553540000',
                    applet: true
                };
                var nodeName = elem.nodeName;
                var noData = nodeName && noDataDict[nodeName.toLowerCase()];
                return !noData || noData !== true && elem.getAttribute('classid') === noData;
            }
            function camelCase(str) {
                return str.replace(/^-ms-/, 'ms-').replace(/-([\da-z])/gi, function (all, letter) {
                    return letter.toUpperCase();
                });
            }
            function internalData(elem, name, data, pvt) {
                if (!acceptData(elem)) {
                    return;
                }
                var thisCache, ret, internalKey = expando, getByName = isString(name),
                    isNode = elem.nodeType,
                    cache = isNode ? globalCache : elem,
                    id = isNode ? elem[internalKey] : elem[internalKey] && internalKey;
                if ((!id || !cache[id] || !pvt && !cache[id].data) && getByName && isUndefined(data)) {
                    return;
                }
                if (!id) {
                    if (isNode) {
                        elem[internalKey] = id = guid;
                        guid++;
                    } else {
                        id = internalKey;
                    }
                }
                if (!cache[id]) {
                    cache[id] = {};
                    if (!isNode) {
                        cache[id].toJSON = function () { };
                    }
                }
                if (isObject(name) || typeof name === 'function') {
                    if (pvt) {
                        cache[id] = $.extend(cache[id], name);
                    } else {
                        cache[id].data = $.extend(cache[id].data, name);
                    }
                }
                thisCache = cache[id];
                if (!pvt) {
                    if (!thisCache.data) {
                        thisCache.data = {};
                    }
                    thisCache = thisCache.data;
                }
                if (!isUndefined(data)) {
                    thisCache[camelCase(name)] = data;
                }
                if (getByName) {
                    ret = thisCache[name];
                    if (ret === keyword_null || ret === keyword_undefined) {
                        ret = thisCache[camelCase(name)];
                    }
                } else {
                    ret = thisCache;
                }
                return ret;
            }
            function isEmptyDataObject(obj) {
                var name;
                for (name in obj) {
                    if (name === 'data' && $.isEmptyObject(obj[name])) {
                        continue;
                    }
                    if (name !== 'toJSON') {
                        return false;
                    }
                }
                return true;
            }
            function internalRemoveData(elem, name, pvt) {
                if (!acceptData(elem)) {
                    return;
                }
                var i, l, thisCache, isNode = elem.nodeType,
                    cache = isNode ? globalCache : elem, id = isNode ? elem[expando] : expando;
                if (!cache[id]) {
                    return;
                }
                if (name) {
                    thisCache = pvt ? cache[id] : cache[id].data;
                    if (thisCache) {
                        if (!$.isArray(name)) {
                            if (name in thisCache) {
                                name = [name];
                            } else {
                                name = camelCase(name);
                                if (name in thisCache) {
                                    name = [name];
                                } else {
                                    name = name.split(' ');
                                }
                            }
                        } else {
                            name = name.concat($.map(name, camelCase));
                        }
                        l = name.length;
                        for (i = 0; i < l; i++) {
                            delete thisCache[name[i]];
                        }
                        if (!(pvt ? isEmptyDataObject : $.isEmptyObject)(thisCache)) {
                            return;
                        }
                    }
                }
                if (!pvt) {
                    delete cache[id].data;
                    if (!isEmptyDataObject(cache[id])) {
                        return;
                    }
                }
                if (isNode) {
                    cleanData([elem], true);
                } else if (cache !== cache.window) {
                    delete cache[id];
                } else {
                    cache[id] = keyword_null;
                }
            }
            function cleanData(elems, canAcceptData) {
                var elem, id, data, i = 0, internalKey = expando, cache = globalCache;
                elem = elems[i];
                while (elem !== keyword_null && elem !== undefined) {
                    if (canAcceptData || acceptData(elem)) {
                        id = elem[internalKey];
                        data = id && cache[id];
                        if (data) {
                            var events = data.events;
                            if (events) {
                                for (var ns in events) {
                                    if (hasOwnProperty(events, ns)) {
                                        var nsObj = events[ns];
                                        if (nsObj) {
                                            for (var eventName in nsObj) {
                                                if (hasOwnProperty(nsObj, eventName)) {
                                                    var listenerArray = nsObj[eventName];
                                                    if (listenerArray) {
                                                        for (var index = 0, length_2 = listenerArray.length; index < length_2; index++) {
                                                            removeEventListener(elem, ns, listenerArray[index]);
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                            if (cache[id]) {
                                delete cache[id];
                                delete elem[internalKey];
                            }
                        }
                    }
                    i++;
                    elem = elems[i];
                }
            }
            function isString(v) {
                return typeof v === 'string';
            }
            function isObject(v) {
                return typeof v === 'object';
            }
            function isUndefined(v) {
                return typeof v === typeof keyword_undefined;
            }
            function defineWidthHeight(needWidth) {
                var isWidth = needWidth;
                return function (value) {
                    var self = this, isBorderBox = self.css('box-sizing') === 'border-box', size;
                    var prop = isWidth ? str_width : str_height;
                    var leftOrTop = isWidth ? str_left : str_top, rightOrBottom = isWidth ? str_right : str_bottom;
                    if (arguments.length === 0) {
                        size = Math.round(convertToFloat(self.css(prop))) || 0;
                        if (isBorderBox) {
                            size -= convertToFloat(self.css('padding-' + leftOrTop)) +
                                convertToFloat(self.css('padding-' + rightOrBottom)) +
                                convertToFloat(self.css('border-' + leftOrTop + '-' + str_width)) +
                                convertToFloat(self.css('border-' + rightOrBottom + '-' + str_width));
                        }
                        return size;
                    }
                    self.css(prop, value);
                    return self;
                };
            }
            // 定义内部宽度内部高度
            function defineInnerWidthInnerHeight(isInnerWidth) {
                var isWidth = isInnerWidth;
                return function () {
                    var self = this;
                    var leftOrTop = isWidth ? str_left : str_top, rightOrBottom = isWidth ? str_right : str_bottom;
                    return isWidth ? self.width() : self.height() + convertToFloat(self.css('padding-' + leftOrTop)) + convertToFloat(self.css('padding-' + rightOrBottom));
                };
            }
            // 定义外部宽度外部高度
            function defineOuterWidthOuterHeight(isOuterWidth) {
                var isWidth = isOuterWidth;
                return function (includeMargin) {
                    var leftOrTop = isWidth ? str_left : str_top, rightOrBottom = isWidth ? str_right : str_bottom;
                    var self = this, size = isWidth ? self.innerWidth() : self.innerHeight();
                    size += convertToFloat(self.css('border-' + leftOrTop + '-' + str_width)) + convertToFloat(self.css('border-' + rightOrBottom + '-' + str_width));
                    if (includeMargin) {
                        size += convertToFloat(self.css('margin-' + leftOrTop)) + convertToFloat(self.css('margin-' + rightOrBottom));
                    }
                    return size;
                };
            }
            // 定义显示隐藏
            function defineShowHide(needShow) {
                var isShow = needShow;
                return function (callback) {
                    this.forEach(function (elem) {
                        elem.style[css_display] = isShow ? css_block : css_none;
                        if (callback) {
                            callback.apply(elem);
                        }
                    });
                    return this;
                };
            }
            function defineScrollLeftScrollTop(needScrollLeft) {
                var isScrollLeft = needScrollLeft;
                return function (value) {
                    var SCROLL_LEFT = 'scrollLeft', SCROLL_TOP = 'scrollTop';
                    var PROP = isScrollLeft ? SCROLL_LEFT : SCROLL_TOP;
                    var PAGE_OFFSET = isScrollLeft ? 'pageXOffset' : 'pageYOffset';
                    var self = this, elem = self[0];
                    var win = getWindow(elem);
                    if (isUndefined(value)) {
                        if (win) {
                            return (PAGE_OFFSET in win) ? win[PAGE_OFFSET] : DOCUMENT.documentElement[PROP];
                        }
                        return elem[PROP];
                    }
                    if (win) {
                        win.scrollTo(isScrollLeft ? value : $(win)[SCROLL_LEFT](), isScrollLeft ? $(win)[SCROLL_TOP]() : value);
                    } else {
                        elem[PROP] = value;
                    }
                    return self;
                };
            }
            function removeEventListener(elem, type, listener) {
                elem.removeEventListener(type, listener);
            }
        }),
        './dist/core/util/imageLoader.js': (function (module, exports, __webpack_require__) {
            Object.defineProperty(exports, '__esModule', { value: true });
            var domUtil_1 = __webpack_require__(/*! ./domUtil */ './dist/core/util/domUtil.js');
            var $$ = domUtil_1.GC$;
            var GCSHEET = '.gcSheet';
            var _ImageLoader = (function () {
                function _ImageLoader(loadedCallBack) {
                    this._imageCount = 0;
                    this._loadedCount = 0;
                    this._imgs = {};
                    var self = this;
                    self._onLoadedComplete = loadedCallBack;
                }
                _ImageLoader.prototype._addImage = function (imgUrl) {
                    var self = this;
                    function onImageLoaded() {
                        self._imageLoaded(imgUrl, true);
                    }
                    function onImageFailed() {
                        self._imageLoaded(imgUrl, false);
                    }
                    var imgs = self._imgs;
                    var imgObj = imgs[imgUrl];
                    if (!imgObj) {
                        var $img = $$(document.createElement('img'));
                        $img.bind('load' + GCSHEET, onImageLoaded);
                        $img.bind('error' + GCSHEET, onImageFailed);
                        $img.bind('abort' + GCSHEET, onImageFailed);
                        self._imageCount++;
                        imgs[imgUrl] = { _state: false, _img: $img[0], _loaded: false };
                        $img[0].src = imgUrl;
                    }
                };
                _ImageLoader.prototype._getState = function (imgUrl) {
                    var img = this._imgs[imgUrl];
                    return img ? img._state : false;
                };
                _ImageLoader.prototype._isLoadedSuccess = function (imgUrl) {
                    var img = this._imgs[imgUrl];
                    return img ? img._loaded : false;
                };
                _ImageLoader.prototype._getImage = function (imgUrl) {
                    var img = this._imgs[imgUrl];
                    return img ? img._img : null;
                };
                _ImageLoader.prototype._imageLoaded = function (imgUrl, success) {
                    var self = this;
                    self._loadedCount++;
                    self._imgs[imgUrl]._state = true;
                    self._imgs[imgUrl]._loaded = success;
                    if (self._isAllImagesLoaded() && self._onLoadedComplete) {
                        self._onLoadedComplete();
                    }
                };
                _ImageLoader.prototype._isAllImagesLoaded = function () {
                    return this._loadedCount >= this._imageCount;
                };
                _ImageLoader.prototype._dispose = function () {
                    var imgs = this._imgs;
                    if (imgs) {
                        for (var imgKey in imgs) {
                            if (imgs[imgKey]) {
                                var $img = $$(imgs[imgKey]._img);
                                $img.unbind(GCSHEET);
                            }
                        }
                    }
                    this._onLoadedComplete = null;
                };
                return _ImageLoader;
            }());
            exports._ImageLoader = _ImageLoader;

        }),
        './dist/core/util/tasks.js': (function (module, exports, __webpack_require__) {
            Object.defineProperty(exports, '__esModule', { value: true });
            var TASK_DELAY_LONG = 100;
            var TASK_DELAY_SHORT = 10;
            var Task = (function () {
                function Task(fn, args) {
                    this.fn = fn;
                    this.args = args;
                }
                Task.prototype.run = function () {
                    this.fn.apply(null, this.args);
                };
                return Task;
            }());
            exports.Task = Task;
            var Tasks = (function () {
                function Tasks(nextTaskFunc, isBusyFunc) {
                    var self = this;
                    self.tasks = [];
                    self.nextTaskFunc = nextTaskFunc.bind(self);
                    self.isBusyFunc = isBusyFunc.bind(self);
                }
                Tasks.prototype.addTask = function (exeFn, args) {
                    this.tasks.splice(0, 0, new Task(exeFn, args));
                };
                Tasks.prototype.pushTask = function (exeFn, args) {
                    this.tasks.push(new Task(exeFn, args));
                };
                Tasks.prototype.runNextTask = function () {
                    var self = this;
                    var tasks = self.tasks;
                    if (self.isTerminated) {
                        return;
                    }
                    if (tasks.length < 1) {
                        self.endingCallback && self.endingCallback();
                        return;
                    }
                    if (self.isBusyFunc()) {
                        setTimeout(function () {
                            self.runNextTask();
                        }, TASK_DELAY_LONG);
                        return;
                    }
                    var t = self.nextTaskFunc();
                    t.run();
                    setTimeout(function () {
                        self.runNextTask();
                    }, TASK_DELAY_SHORT);
                };
                Tasks.prototype.start = function () {
                    var self = this;
                    self.runNextTask();
                };
                // 终止
                Tasks.prototype.terminate = function () {
                    var self = this;
                    self.tasks = [];
                    self.isTerminated = true;
                };
                return Tasks;
            }());
            exports.Tasks = Tasks;

        }),
        './dist/core/util/theme.js': (function (module, exports, __webpack_require__) {
            Object.defineProperty(exports, '__esModule', { value: true });
            var Common_1 = __webpack_require__(/*! Common */ 'Common');
            var common_util = __webpack_require__(/*! ./common */ './dist/core/util/common.js');
            var isNullOrUndefined = Common_1.Common._Types._isNullOrUndefined;
            var _ColorHelper = Common_1.Common._ColorHelper;
            var parseToColor = _ColorHelper._fromString;
            var parseIntFn = parseInt;
            var defProperty = common_util.util._defProperty;
            var GILL_SANS_MT = 'Gill Sans MT', FRANKLIN_GOTHIC_BOOK = 'Franklin Gothic Book', TREBUCHET_MS = 'Trebuchet MS';
            // 定义颜色方案属性
            function defColorSchemeProperty(index) {
                var colorIndex = index;
                return function (value) {
                    if (arguments.length === 0) {
                        return this._colorList[colorIndex];
                    }
                    this._colorList[index] = parseToColor(value);
                    return this;
                };
            }
            var BACKCOLOR1 = 0, BACKCOLOR2 = 1, TEXTCOLOR1 = 2, TEXTCOLOR2 = 3, ACCENT1 = 4, ACCENT2 = 5, ACCENT3 = 6, ACCENT4 = 7, ACCENT5 = 8, ACCENT6 = 9, HYPERLINK = 10, FHYPERLINK = 11;
            var ColorScheme = (function () {
                // 配色方案
                function ColorScheme(name, background1, background2, text1, text2, accent1, accent2, accent3, accent4, accent5, accent6, link, followedLink) {
                    this.background1 = defColorSchemeProperty(BACKCOLOR1);
                    this.background2 = defColorSchemeProperty(BACKCOLOR2);
                    this.textColor1 = defColorSchemeProperty(TEXTCOLOR1);
                    this.textColor2 = defColorSchemeProperty(TEXTCOLOR2);
                    this.accent1 = defColorSchemeProperty(ACCENT1);
                    this.accent2 = defColorSchemeProperty(ACCENT2);
                    this.accent3 = defColorSchemeProperty(ACCENT3);
                    this.accent4 = defColorSchemeProperty(ACCENT4);
                    this.accent5 = defColorSchemeProperty(ACCENT5);
                    this.accent6 = defColorSchemeProperty(ACCENT6);
                    this.hyperlink = defColorSchemeProperty(HYPERLINK);
                    this.followedHyperlink = defColorSchemeProperty(FHYPERLINK);
                    this._name = name;
                    this._colorList = [];
                    for (var i = 1; i < 13; i++) {
                        this._colorList.push(parseToColor(arguments[i]));
                    }
                }
                ColorScheme.prototype.name = function (value) {
                    if (arguments.length === 0) {
                        return this._name;
                    }
                    this._name = value;
                    return this;
                };
                ColorScheme.prototype.getColor = function (name) {
                    if (name && typeof name === 'string') {
                        var t = name.split(' '), cn = void 0;
                        if (t) {
                            var index = -1;
                            var len = t.length;
                            if (len > 1) {
                                if (!t[0]) {
                                    return name;
                                }
                                cn = t[0].toLowerCase();
                                if (cn === 'background') {
                                    index = parseIntFn(t[1], 10) - 1;
                                } else if (cn === 'text') {
                                    index = parseIntFn(t[1], 10) + 1;
                                } else if (cn === 'accent') {
                                    index = parseIntFn(t[1], 10) + 3;
                                }
                            } else if (len === 1) {
                                cn = t[0].toLowerCase();
                                if (cn === 'hyperlink') {
                                    index = HYPERLINK;
                                } else if (cn === 'followedhyperlink') {
                                    index = FHYPERLINK;
                                }
                            }
                            if (index >= 0 && index <= 11) {
                                if (len > 2) {
                                    var tint = parseIntFn(t[2], 10) / 100.0;
                                    return _ColorHelper._toString(_ColorHelper._applyTint(this._colorList[index], tint));
                                }
                                return _ColorHelper._toString(this._colorList[index]);
                            }
                        }
                    }
                    return name;
                };
                ColorScheme.prototype.toJSON = function () {
                    var self = this, colorList = self._colorList;
                    return {
                        name: self._name,
                        background1: colorList[BACKCOLOR1],
                        background2: colorList[BACKCOLOR2],
                        text1: colorList[TEXTCOLOR1],
                        text2: colorList[TEXTCOLOR2],
                        accent1: colorList[ACCENT1],
                        accent2: colorList[ACCENT2],
                        accent3: colorList[ACCENT3],
                        accent4: colorList[ACCENT4],
                        accent5: colorList[ACCENT5],
                        accent6: colorList[ACCENT6],
                        hyperlink: colorList[HYPERLINK],
                        followedHyperlink: colorList[FHYPERLINK]
                    };
                };
                ColorScheme.prototype.fromJSON = function (jsonData, noSchema) {
                    if (!jsonData) {
                        return;
                    }
                    var self = this;
                    var COLOR_LIST = '_colorList', NAME = '_name';
                    function readColor(colorName, color) {
                        if (!isNullOrUndefined(color)) {
                            self._colorList[colorName] = { a: color.a, r: color.r, g: color.g, b: color.b };
                        }
                    }
                    var background1, background2, text1, text2, accent1, accent2, accent3, accent4, accent5, accent6, hyperlink, followedHyperlink;
                    if (noSchema) {
                        var name_1 = jsonData.name ? jsonData.name : jsonData[NAME];
                        if (!isNullOrUndefined(name_1)) {
                            self._name = name_1;
                        }
                        var colorList = jsonData.colorList ? jsonData.colorList : jsonData[COLOR_LIST];
                        background1 = colorList[BACKCOLOR1];
                        background2 = colorList[BACKCOLOR2];
                        text1 = colorList[TEXTCOLOR1];
                        text2 = colorList[TEXTCOLOR2];
                        accent1 = colorList[ACCENT1];
                        accent2 = colorList[ACCENT2];
                        accent3 = colorList[ACCENT3];
                        accent4 = colorList[ACCENT4];
                        accent5 = colorList[ACCENT5];
                        accent6 = colorList[ACCENT6];
                        hyperlink = colorList[HYPERLINK];
                        followedHyperlink = colorList[FHYPERLINK];
                    } else {
                        if (!isNullOrUndefined(jsonData.name)) {
                            self._name = jsonData.name;
                        }
                        background1 = jsonData.background1;
                        background2 = jsonData.background2;
                        text1 = jsonData.text1;
                        text2 = jsonData.text2;
                        accent1 = jsonData.accent1;
                        accent2 = jsonData.accent2;
                        accent3 = jsonData.accent3;
                        accent4 = jsonData.accent4;
                        accent5 = jsonData.accent5;
                        accent6 = jsonData.accent6;
                        hyperlink = jsonData.hyperlink;
                        followedHyperlink = jsonData.followedHyperlink;
                    }
                    readColor(BACKCOLOR1, background1);
                    readColor(BACKCOLOR2, background2);
                    readColor(TEXTCOLOR1, text1);
                    readColor(TEXTCOLOR2, text2);
                    readColor(ACCENT1, accent1);
                    readColor(ACCENT2, accent2);
                    readColor(ACCENT3, accent3);
                    readColor(ACCENT4, accent4);
                    readColor(ACCENT5, accent5);
                    readColor(ACCENT6, accent6);
                    readColor(HYPERLINK, hyperlink);
                    readColor(FHYPERLINK, followedHyperlink);
                };
                // 比较
                ColorScheme.prototype._compare = function (themeColor) {
                    if (this.name() !== themeColor.name()) {
                        return false;
                    }
                    var comProps = ['textColor1', 'textColor2', 'background1', 'background2', 'accent1', 'accent2', 'accent3', 'accent4', 'accent5', 'accent6', 'hyperlink', 'followedHyperlink'];
                    for (var i = 0, length_1 = comProps.length; i < length_1; i++) {
                        var prop = comProps[i];
                        if (!_ColorHelper._equal(this[prop](), themeColor[prop]())) {
                            return false;
                        }
                    }
                    return true;
                };
                return ColorScheme;
            }());
            exports.ColorScheme = ColorScheme;
            var Theme = (function () {
                function Theme(name, colorScheme, headerFont, bodyFont) {
                    this.name = defProperty('name');
                    this.colors = defProperty('colors');
                    this.headerFont = defProperty('headerFont');
                    this.bodyFont = defProperty('bodyFont');
                    var self = this;
                    self.name(name);
                    self.colors(colorScheme ? colorScheme : new ColorScheme(name));
                    self.headerFont(headerFont);
                    self.bodyFont(bodyFont);
                }
                Theme.prototype.getColor = function (colorString) {
                    return this.colors().getColor(colorString);
                };
                Theme.prototype.getFont = function (fontString) {
                    if (fontString === 'Body') {
                        return this.bodyFont();
                    } else if (fontString === 'Headings') {
                        return this.headerFont();
                    }
                    return fontString;
                };
                Theme.prototype.toJSON = function () {
                    var self = this, name = self.name();
                    if (Theme._isBuiltInTheme(self)) {
                        return name;
                    }
                    return {
                        name: name,
                        themeColor: self.colors() ? self.colors().toJSON() : undefined,
                        headingFont: self.headerFont(),
                        bodyFont: self.bodyFont()
                    };
                };
                // 是内置主题
                Theme._isBuiltInTheme = function (theme) {
                    var name = theme.name();
                    if (Themes[name]) {
                        var builtInTheme = Themes[name];
                        return theme.bodyFont() === builtInTheme.bodyFont() &&
                            theme.headerFont() === builtInTheme.headerFont() &&
                            theme.colors()._compare(builtInTheme.colors());
                    }
                    return false;
                };
                return Theme;
            }());
            exports.Theme = Theme;
            var color000000 = '#000000';
            var colorFFFFFF = '#FFFFFF';

            var ThemeColors = (function () {
                function ThemeColors() { }
                ThemeColors.Default = new ColorScheme('Default', colorFFFFFF, '#EEECE1', color000000, '#1F497D', '#4F81BD', '#C0504D', '#9BBB59', '#8064A2', '#4BACC6', '#F79646', '#0000FF', '#800080');
                ThemeColors.Office2007 = new ColorScheme('Office2007', colorFFFFFF, '#EEECE1', color000000, '#1F497D', '#4F81BD', '#C0504D', '#9BBB59', '#8064A2', '#4BACC6', '#F79646', '#0000FF', '#800080');
                ThemeColors.Office = new ColorScheme('Office', colorFFFFFF, '#E7E6E6', color000000, '#44546A', '#5B9BD5', '#ED7D31', '#A5A5A5', '#FFC000', '#4472C4', '#70AD47', '#0563C1', '#954F72');
                ThemeColors.Apex = new ColorScheme('Apex', colorFFFFFF, '#C9C2D1', color000000, '#69676D', '#CEB966', '#9CB084', '#6BB1C9', '#6585CF', '#7E6BC9', '#A379BB', '#410082', '#932968');
                ThemeColors.Aspect = new ColorScheme('Aspect', colorFFFFFF, '#E3DED1', color000000, '#323232', '#F07F09', '#9F2936', '#1B587C', '#4E8542', '#604878', '#C19859', '#6B9F25', '#B26B02');
                ThemeColors.Concourse = new ColorScheme('Concourse', colorFFFFFF, '#DEF5FA', color000000, '#464646', '#2DA2BF', '#DA1F28', '#EB641B', '#39639D', '#474B78', '#7D3C4A', '#FF8119', '#44B9E8');
                ThemeColors.Civic = new ColorScheme('Civic', colorFFFFFF, '#C5D1D7', color000000, '#646B86', '#D16349', '#CCB400', '#8CADAE', '#8C7B70', '#8FB08C', '#D19049', '#00A3D6', '#694F07');
                ThemeColors.Oriel = new ColorScheme('Oriel', colorFFFFFF, '#FFF39D', color000000, '#575F6D', '#FE8637', '#7598D9', '#B32C16', '#F5CD2D', '#AEBAD5', '#777C84', '#D2611C', '#3B435B');
                ThemeColors.Origin = new ColorScheme('Origin', colorFFFFFF, '#DDE9EC', color000000, '#464653', '#727CA3', '#9FB8CD', '#D2DA7A', '#FADA7A', '#B88472', '#8E736A', '#B292CA', '#6B5680');
                ThemeColors.Paper = new ColorScheme('Paper', colorFFFFFF, '#FEFAC9', color000000, '#444D26', '#A5B592', '#F3A447', '#E7BC29', '#D092A7', '#9C85C0', '#809EC2', '#8E58B6', '#7F6F6F');
                ThemeColors.Solstice = new ColorScheme('Solstice', colorFFFFFF, '#E7DEC9', color000000, '#4F271C', '#3891A7', '#FEB80A', '#C32D2E', '#84AA33', '#964305', '#475A8D', '#8DC765', '#AA8A14');
                ThemeColors.Technic = new ColorScheme('Technic', colorFFFFFF, '#D4D2D0', color000000, '#3B3B3B', '#6EA0B0', '#CCAF0A', '#8D89A4', '#748560', '#9E9273', '#7E848D', '#00C8C3', '#A116E0');
                ThemeColors.Trek = new ColorScheme('Trek', colorFFFFFF, '#FBEEC9', color000000, '#4E3B30', '#F0A22E', '#A5644E', '#B58B80', '#C3986D', '#A19574', '#C17529', '#AD1F1F', '#FFC42F');
                ThemeColors.Urban = new ColorScheme('Urban', colorFFFFFF, '#DEDEDE', color000000, '#424456', '#53548A', '#438086', '#A04DA3', '#C4652D', '#8B5D3D', '#5C92B5', '#67AFBD', '#C2A874');
                ThemeColors.Verve = new ColorScheme('Verve', colorFFFFFF, '#D2D2D2', color000000, '#666666', '#FF388C', '#E40059', '#9C007F', '#68007F', '#005BD3', '#00349E', '#17BBFD', '#FF79C2');
                ThemeColors.Equity = new ColorScheme('Equity', colorFFFFFF, '#E9E5DC', color000000, '#696464', '#D34817', '#9B2D1F', '#A28E6A', '#956251', '#918485', '#855D5D', '#CC9900', '#96A9A9');
                ThemeColors.Flow = new ColorScheme('Flow', colorFFFFFF, '#DBF5F9', color000000, '#04617B', '#0F6FC6', '#009DD9', '#0BD0D9', '#10CF9B', '#7CCA62', '#A5C249', '#E2D700', '#85DFD0');
                ThemeColors.Foundry = new ColorScheme('Foundry', colorFFFFFF, '#EAEBDE', color000000, '#676A55', '#72A376', '#B0CCB0', '#A8CDD7', '#C0BEAF', '#CEC597', '#E8B7B7', '#DB5353', '#903638');
                ThemeColors.Median = new ColorScheme('Median', colorFFFFFF, '#EBDDC3', color000000, '#775F55', '#94B6D2', '#DD8047', '#A5AB81', '#D8B25C', '#7BA79D', '#968C8C', '#F7B615', '#704404');
                ThemeColors.Metro = new ColorScheme('Metro', colorFFFFFF, '#D6ECFF', color000000, '#4E5B6F', '#7FD13B', '#EA157A', '#FEB80A', '#00ADDC', '#738AC8', '#1AB39F', '#EB8803', '#5F7791');
                ThemeColors.Module = new ColorScheme('Module', colorFFFFFF, '#D4D4D6', color000000, '#5A6378', '#F0AD00', '#60B5CC', '#E66C7D', '#6BB76D', '#E88651', '#C64847', '#168BBA', '#680000');
                ThemeColors.Opulent = new ColorScheme('Opulent', colorFFFFFF, '#F4E7ED', color000000, '#B13F9A', '#B83D68', '#AC66BB', '#DE6C36', '#F9B639', '#CF6DA4', '#FA8D3D', '#FFDE66', '#D490C5');
                return ThemeColors;
            }());
            exports.ThemeColors = ThemeColors;

            var Themes = (function () {
                function Themes() { }
                Themes.Default = new Theme('Default', ThemeColors.Default, 'Cambria', 'Calibri');
                Themes.Office = new Theme('Office', ThemeColors.Office, 'Calibri Light', 'Calibri');
                Themes.Office2007 = new Theme('Office2007', ThemeColors.Office2007, 'Cambria', 'Calibri');
                Themes.Apex = new Theme('Apex', ThemeColors.Apex, 'Lucida Sans', 'Book Antiqua');
                Themes.Aspect = new Theme('Aspect', ThemeColors.Aspect, 'Verdana', 'Verdana');
                Themes.Concourse = new Theme('Concourse', ThemeColors.Concourse, 'Lucida Sans Unicode', 'Lucida Sans Unicode');
                Themes.Civic = new Theme('Civic', ThemeColors.Civic, 'Georgia', 'Georgia');
                Themes.Oriel = new Theme('Oriel', ThemeColors.Oriel, 'Century Schoolbook', 'Century Schoolbook');
                Themes.Origin = new Theme('Origin', ThemeColors.Origin, 'Bookman Old Style', GILL_SANS_MT);
                Themes.Paper = new Theme('Paper', ThemeColors.Paper, 'Constantia', 'Constantia');
                Themes.Solstice = new Theme('Solstice', ThemeColors.Solstice, GILL_SANS_MT, GILL_SANS_MT);
                Themes.Technic = new Theme('Technic', ThemeColors.Technic, FRANKLIN_GOTHIC_BOOK, 'Arial');
                Themes.Trek = new Theme('Trek', ThemeColors.Trek, 'Franklin Gothic Medium', FRANKLIN_GOTHIC_BOOK);
                Themes.Urban = new Theme('Urban', ThemeColors.Urban, TREBUCHET_MS, 'Georgia');
                Themes.Verve = new Theme('Verve', ThemeColors.Verve, 'Century Gothic', 'Century Gothic');
                Themes.Equity = new Theme('Equity', ThemeColors.Equity, FRANKLIN_GOTHIC_BOOK, 'Perpetua');
                Themes.Flow = new Theme('Flow', ThemeColors.Flow, 'Calibri', 'Constantia');
                Themes.Foundry = new Theme('Foundry', ThemeColors.Foundry, 'Rockwell', 'Rockwell');
                Themes.Median = new Theme('Median', ThemeColors.Median, 'Tw Cen MT', 'Tw Cen MT');
                Themes.Metro = new Theme('Metro', ThemeColors.Metro, 'Consolas', 'Corbel');
                Themes.Module = new Theme('Module', ThemeColors.Module, 'Corbel', 'Corbel');
                Themes.Opulent = new Theme('Opulent', ThemeColors.Opulent, TREBUCHET_MS, TREBUCHET_MS);
                return Themes;
            }());
            exports.Themes = Themes;
        }),
        './dist/core/workbook/sheettab.js': (function (module, exports, __webpack_require__) {
            var __extends = (this && this.__extends) || (function () {
                var extendStatics = function (d, b) {
                    extendStatics = Object.setPrototypeOf ||
                        ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
                        function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };
                    return extendStatics(d, b);
                };
                return function (d, b) {
                    extendStatics(d, b);
                    function __() { this.constructor = d; }
                    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
                };
            })();
            Object.defineProperty(exports, '__esModule', { value: true });
            var Common_1 = __webpack_require__(/*! Common */ 'Common');
            var common_1 = __webpack_require__(/*! ../util/common */ './dist/core/util/common.js');
            var stylehelper_1 = __webpack_require__(/*! ../worksheet/stylehelper */ './dist/core/worksheet/stylehelper.js');
            var sheettabbase_1 = __webpack_require__(/*! ./sheettabbase */ './dist/core/workbook/sheettabbase.js');
            var core_enum_1 = __webpack_require__(/*! ../core.enum */ './dist/core/core.enum.js');
            var _ColorHelper = Common_1.Common._ColorHelper;
            var _Color_invertColor = _ColorHelper._invertColor, _Color_parse = _ColorHelper._fromString;
            var keyword_null = null;
            var hit_element_blankArea = 'blank', hit_element_nextButton = 'nextButton';

            var _SheetTab = (function (_super) {
                __extends(_SheetTab, _super);
                function _SheetTab(name) {
                    var _this = _super.call(this, name) || this;
                    _this._tabMargin = 4;
                    _this._tabBackColor = 'white';
                    var self = _this;
                    self._tabLeftPadding = 19;
                    self._tabRightPadding = 18;
                    self._tabSpace = 0;
                    self._resizeBarWidth = 30;
                    self._itemWidth = 28;
                    self._moreTabWidth = 28;
                    self._newTabSize = 30;
                    self._firstTabSpace = 0;
                    self._font = '10pt Segoe UI';
                    return _this;
                }
                // 获取导航按钮宽度
                _SheetTab.prototype._getNavigationButtonWidth = function () {
                    var workbook = this._workbook, options = workbook && workbook.options;
                    if (!options || !options.tabNavigationVisible) {
                        return 0;
                    }
                    return this._itemWidth * (options.useTouchLayout ? 1.5 : 1);
                };
                // 获取导航按钮高度
                _SheetTab.prototype._getNavigationButtonHeight = function () {
                    var workbook = this._workbook;
                    if (!workbook || !workbook.options.tabNavigationVisible) {
                        return 0;
                    }
                    return workbook._getBottomTableHeight();
                };
                // 获取第一个更多选项卡宽度
                _SheetTab.prototype._getFirstMoreTabWidth = function () {
                    return this._moreTabWidth;
                };
                // 获取第二个更多选项卡宽度
                _SheetTab.prototype._getSecondMoreTabWidth = function () {
                    return this._hideNewTabSecondMoreTab ? 0 : this._moreTabWidth;
                };
                // 获取创建选项卡大小
                _SheetTab.prototype._getNewTabSize = function () {
                    var self = this;
                    var newTabVisible = self._workbook.options.newTabVisible;
                    if (!newTabVisible) {
                        return 0;
                    }
                    return this._hideNewTabSecondMoreTab ? 0 : this._newTabSize;
                };
                // 获取选项卡结束位置
                _SheetTab.prototype._getTabEndPosition = function () {
                    var self = this, sheetTabs = self._workbook._getSheetsAndSheetTabs(), tabEndPosition = self._getTabStartPosition(), tabSizes = self._tabSizes;
                    var isHorizontalTabs = self._isHorizontalTabs();
                    var rect = self._getBounds(), max;
                    if (isHorizontalTabs) {
                        max = rect.x + rect.width - self._getResizeBarWidth() - self._getNewTabSize() - self._getSecondMoreTabWidth();
                    } else {
                        max = rect.y + rect.height - self._getNavigationButtonHeight();
                    }
                    for (var i = self._firstTab, length_1 = sheetTabs.length; i < length_1; i++) {
                        if (sheetTabs[i].visible()) {
                            tabEndPosition += isHorizontalTabs ? tabSizes[i] : self._tabHeight;
                        }
                        if (tabEndPosition > max) {
                            tabEndPosition = max;
                            break;
                        }
                    }
                    return tabEndPosition;
                };
                // 获取选项卡开始位置
                _SheetTab.prototype._getTabStartPosition = function () {
                    var self = this;
                    var isHorizontalTabs = self._isHorizontalTabs();
                    if (isHorizontalTabs) {
                        return self._getNavigationButtonWidth() * 2 + self._getFirstMoreTabWidth() + self._getNavigationMarginLeft();
                    } else {
                        return self._getNewTabSize();
                    }
                };
                // 获取左侧导航边距
                _SheetTab.prototype._getNavigationMarginLeft = function () {
                    var self = this, workbook = self._workbook;
                    if (!workbook || !workbook.options.tabNavigationVisible) {
                        return 0;
                    }
                    return self._getResizeBarWidth() / 2;
                };
                // 获取调整条形边界大小
                _SheetTab.prototype.getResizeBarBounds = function () {
                    var self = this;
                    var rect = self._getBounds();
                    return {
                        x: rect.x + rect.width - self._getResizeBarWidth(),
                        y: keyword_null,
                        width: self._getResizeBarWidth(),
                        height: keyword_null
                    };
                };
                // 获取导航按钮边界
                _SheetTab.prototype.getNavButtonBounds = function () {
                    var self = this;
                    var isHorizontalTabs = self._isHorizontalTabs();
                    var x, y, width, height, startIndex, endIndex;
                    if (isHorizontalTabs) {
                        x = self._getResizeBarWidth() / 2;
                        y = keyword_null;
                        width = self._getNavigationButtonWidth();
                        height = keyword_null;
                    } else {
                        var bounds = self._getBounds();
                        var navigationButtonHeight = self._getNavigationButtonHeight();
                        var navigationButtonWidth = self._getNavigationButtonWidth();
                        x = bounds.width / 2 - navigationButtonWidth;
                        y = bounds.height - navigationButtonHeight;
                        width = navigationButtonWidth;
                        height = navigationButtonHeight;
                    }
                    startIndex = 1;
                    endIndex = 3;
                    return { x: x, y: y, width: width, height: height, startIndex: startIndex, endIndex: endIndex };
                };
                // 获取表格选项卡边界
                _SheetTab.prototype.getSheetTabBounds = function () {
                    var self = this;
                    var rect = self._getBounds();
                    var secondMoreTabWidth = self._getSecondMoreTabWidth();
                    return {
                        x: self._getTabStartPosition(),
                        y: keyword_null,
                        height: keyword_null,
                        secondMoreTabWidth: self._getSecondMoreTabWidth(),
                        moreTabPos: rect.x + rect.width - self._getResizeBarWidth() - self._getNewTabSize() - secondMoreTabWidth
                    };
                };
                // 获取更多前选项卡边界
                _SheetTab.prototype.getPreMoreTabBounds = function () {
                    var self = this;
                    return {
                        x: self._getTabStartPosition() - self._getFirstMoreTabWidth(),
                        width: self._getFirstMoreTabWidth()
                    };
                };
                // 是封面页选项卡
                _SheetTab.prototype._isCoverSheetTab = function () {
                    var self = this;
                    var isHorizontalTabs = self._isHorizontalTabs();
                    if (isHorizontalTabs) {
                        return self._activePos + self._tabSizes[self._activeIndex] > self._getCoverPosition();
                    } else {
                        return self._activePos + self._tabHeight * 2 > self._getCoverPosition();
                    }
                };
                // 获取封面位置
                _SheetTab.prototype._getCoverPosition = function () {
                    var self = this;
                    var isHorizontalTabs = self._isHorizontalTabs();
                    if (isHorizontalTabs) {
                        return self._getBounds().width - self._getResizeBarWidth() - self._getNewTabSize() - self._getSecondMoreTabWidth();
                    } else {
                        return self._getBounds().height - self._getNavigationButtonHeight();
                    }
                };
                // 获取输入框顶部位置
                _SheetTab.prototype._getInputTopPosition = function () {
                    return 8;
                };
                // 获取选项卡指示器边缘元素
                _SheetTab.prototype._getTabIndicatorEdgeElements = function () {
                    return [hit_element_blankArea, hit_element_nextButton, 'newSheet'];
                };
                // 获取基本宽度
                _SheetTab.prototype._getBasicWidth = function () {
                    return this._getTabStartPosition();
                };
                // 绘制矩形背景
                _SheetTab.prototype._paintRectBackground = function (ctx, rect) {
                    var self = this;
                    ctx.save();
                    ctx.beginPath();
                    var backgroundColor = common_1._ThemeStyleHelper._getVisualStateThemeStyle(0, 'gc-tabStripBackground').backgroundColor;
                    self._backgroundColor = _Color_parse(backgroundColor);
                    ctx.fillStyle = backgroundColor;
                    ctx.fillRect(rect.x, rect.y, rect.width, rect.height);
                    ctx.restore();
                };
                // 绘制矩形边框
                _SheetTab.prototype._paintRectBorder = function (ctx, rect) {
                    var self = this, spread = self._workbook;
                    var tabStripPosition = spread && spread.options.tabStripPosition;
                    var borderTopColor = common_1._ThemeStyleHelper._getVisualStateThemeStyle(0, 'gc-tabStripBackground').borderTopColor;
                    ctx.save();
                    ctx.beginPath();
                    ctx.strokeStyle = borderTopColor;
                    var startX, startY, endX, endY;
                    if (tabStripPosition === core_enum_1.TabStripPosition.bottom) {
                        startX = rect.x;
                        startY = rect.y;
                        endX = rect.x + rect.width;
                        endY = rect.y + 0.5;
                    } else if (tabStripPosition === core_enum_1.TabStripPosition.top) {
                        startX = rect.x;
                        startY = rect.height - 0.5;
                        endX = rect.x + rect.width;
                        endY = rect.y + rect.height - 0.5;
                    } else if (tabStripPosition === core_enum_1.TabStripPosition.left) {
                        startX = rect.x + rect.width - 0.5;
                        startY = rect.y;
                        endX = rect.x + rect.width - 0.5;
                        endY = rect.y + rect.height;
                    } else if (tabStripPosition === core_enum_1.TabStripPosition.right) {
                        startX = rect.x + 0.5;
                        startY = rect.y;
                        endX = rect.x + 0.5;
                        endY = rect.y + rect.height;
                    }
                    ctx.moveTo(startX, startY);
                    ctx.lineTo(endX, endY);
                    ctx.stroke();
                    ctx.restore();
                };
                // 绘制背景
                _SheetTab.prototype._paintBackground = function (ctx, rect) {
                    var self = this;
                    self._paintRectBackground(ctx, rect);
                    self._paintRectBorder(ctx, rect);
                };
                // 绘制新图纸选项卡
                _SheetTab.prototype._paintNewSheetTab = function (ctx, rect, newTabStartPosition) {
                    var self = this;
                    var options = self._workbook.options;
                    var newTabVisible = options.newTabVisible;
                    var isHorizontalTabs = self._isHorizontalTabs();
                    var tabStartPosition = self._getTabStartPosition();
                    var itemWidth = self._itemWidth;
                    var x = newTabStartPosition, y = 0;
                    var width, height;
                    if (isHorizontalTabs) {
                        var moreTabWidth = self._getSecondMoreTabWidth();
                        x += moreTabWidth;
                        var maxNewTabPos = rect.x + rect.width - self._getResizeBarWidth() - self._getNewTabSize();
                        if (x > maxNewTabPos) {
                            x = maxNewTabPos;
                            var moreTabPos = maxNewTabPos - moreTabWidth;
                            if (moreTabPos < tabStartPosition) {
                                moreTabPos = tabStartPosition;
                                x = moreTabPos + itemWidth;
                            }
                            self._drawMoreTab(ctx, moreTabPos, 0, moreTabWidth, rect.height);
                        } else {
                            x = x - moreTabWidth;
                        }
                        width = self._getNewTabSize();
                        height = rect.height;
                    } else {
                        x = (rect.width - tabStartPosition) / 2;
                        height = tabStartPosition;
                        width = height;
                    }
                    if (newTabVisible) {
                        self._drawNewSheetTab(ctx, x, y, width, height, self._hoverTab === -2);
                    }
                };
                // 在第一个选项卡之前绘制选项卡
                _SheetTab.prototype._paintTabBeforeFirstTab = function (ctx, rect, firstTab, tabStartPosition) {
                    var moreTabWidth = this._getFirstMoreTabWidth();
                    this._drawMoreTab(ctx, tabStartPosition - moreTabWidth, 0, moreTabWidth, rect.height);
                };
                // 绘制导航按钮
                _SheetTab.prototype._paintNavigationButtons = function (ctx, rect) {
                    var self = this;
                    var isHorizontalTabs = self._isHorizontalTabs();
                    var triangleSize = self._triangleSize;
                    var navigationButtonWidth = self._getNavigationButtonWidth();
                    var navigationButtonHeight = self._getNavigationButtonHeight();
                    var hoverNavButton = self._hoverNavButton;
                    var x, y;
                    if (isHorizontalTabs) {
                        x = self._getResizeBarWidth() / 2 + navigationButtonWidth / 2;
                        y = navigationButtonHeight / 2;
                        self._drawNavButton(ctx, x, y, x + triangleSize, y + triangleSize, x + triangleSize, y - triangleSize, sheettabbase_1.NavButtonDirection.left, keyword_null, (hoverNavButton === 1));
                        x += navigationButtonWidth;
                        self._drawNavButton(ctx, x, y, x - triangleSize, y + triangleSize, x - triangleSize, y - triangleSize, sheettabbase_1.NavButtonDirection.right, keyword_null, (hoverNavButton === 2));
                    } else {
                        x = (rect.width - navigationButtonWidth) / 2;
                        y = rect.height - navigationButtonHeight / 2;
                        self._drawNavButton(ctx, x, y, x + triangleSize, y + triangleSize, x - triangleSize, y + triangleSize, sheettabbase_1.NavButtonDirection.top, keyword_null, (hoverNavButton === 1));
                        x += navigationButtonWidth;
                        self._drawNavButton(ctx, x, y, x - triangleSize, y + triangleSize, x - triangleSize, y - triangleSize, sheettabbase_1.NavButtonDirection.bottom, keyword_null, (hoverNavButton === 2));
                    }
                };
                // 绘制调整栏
                _SheetTab.prototype._paintResizeBar = function (ctx, rect) {
                    var self = this, x, y, resizeBarWidth = self._getResizeBarWidth();
                    var themeStyle = common_1._ThemeStyleHelper._getVisualStateThemeStyle(0, 'gc-tabStripResizeBarInner');
                    if (self._workbook.options.showHorizontalScrollbar) {
                        ctx.beginPath();
                        ctx.rect(rect.x + rect.width - resizeBarWidth, 0, resizeBarWidth, rect.height);
                        ctx.clip();
                        x = rect.x + rect.width - resizeBarWidth / 2;
                        y = rect.y + rect.height / 2;
                        ctx.fillStyle = themeStyle.color;
                        ctx.fillRect(x, y, 2, 2);
                        ctx.fillRect(x, y - 4, 2, 2);
                        ctx.fillRect(x, y + 4, 2, 2);
                    }
                };
                // 绘图选项卡背景
                _SheetTab.prototype._drawTabBackground = function (ctx, x, y, width, height, backColor, isSelected, isActive) {
                    var self = this;
                    var workbook = self._workbook;
                    var tabStripPosition = workbook.options.tabStripPosition;
                    var asideTabMargin = self._asideTabMargin;
                    var backgroundColor = self._tabBackColor;
                    var margin = self._tabMargin;
                    var padding = self._tabPadding;
                    var isHorizontalTabs = self._isHorizontalTabs();
                    ctx.save();
                    if (isSelected) {
                        ctx.fillStyle = backColor;
                        if (tabStripPosition === core_enum_1.TabStripPosition.bottom) {
                            ctx.fillRect(x, y + 1, width, height - margin);
                        } else if (tabStripPosition === core_enum_1.TabStripPosition.top) {
                            ctx.fillRect(x, y + margin - 1, width, height);
                        } else {
                            if (isActive) {
                                if (tabStripPosition === core_enum_1.TabStripPosition.left) {
                                    ctx.fillRect(x + asideTabMargin, y, width - asideTabMargin, height + 1);
                                } else {
                                    ctx.fillRect(x, y, width - asideTabMargin, height + 1);
                                }
                            } else {
                                ctx.fillRect(x + asideTabMargin, y, width - asideTabMargin * 2, height + 1);
                            }
                        }
                    } else if (isActive) {
                        ctx.fillStyle = backgroundColor;
                        if (tabStripPosition === core_enum_1.TabStripPosition.bottom) {
                            ctx.fillRect(x, y, width, 1);
                        } else if (tabStripPosition === core_enum_1.TabStripPosition.top) {
                            ctx.fillRect(x, y + height, width, 1);
                        } else {
                            if (tabStripPosition === core_enum_1.TabStripPosition.left) {
                                ctx.fillRect(x + asideTabMargin, y, width - asideTabMargin, height + 1);
                            } else {
                                ctx.fillRect(x, y, width - asideTabMargin, height + 1);
                            }
                        }
                    }
                    ctx.fillStyle = backColor;
                    if (isHorizontalTabs) {
                        ctx.fillRect(x + padding, y + padding, width - padding * 2 + 1, height - padding * 2);
                    } else {
                        if (isActive) {
                            if (tabStripPosition === core_enum_1.TabStripPosition.left) {
                                ctx.fillRect(x + asideTabMargin, y, width - asideTabMargin, height + 1);
                            } else {
                                ctx.fillRect(x, y, width - asideTabMargin, height + 1);
                            }
                        } else {
                            ctx.fillRect(x + asideTabMargin, y, width - asideTabMargin * 2, height + 1);
                        }
                    }
                    ctx.restore();
                };
                // 绘制非活动选项卡边框
                _SheetTab.prototype._drawInactiveTabBorder = function (ctx, x, y, width, height, styles, isActive) {
                    var self = this;
                    var workbook = self._workbook;
                    var tabStripPosition = workbook.options.tabStripPosition;
                    var margin = self._tabMargin;
                    var asideTabMargin = self._asideTabMargin;
                    var isHorizontalTabs = self._isHorizontalTabs();
                    ctx.save();
                    if (isHorizontalTabs) {
                        ctx.beginPath();
                        ctx.lineWidth = 1;
                        ctx.strokeStyle = styles && styles.borderLeftColor;
                        if (!isActive) {
                            ctx.moveTo(x + 0.5, y + margin + 4);
                            ctx.lineTo(x + 0.5, y + height - margin);
                            ctx.moveTo(x + width + 0.5, y + margin + 4);
                            ctx.lineTo(x + width + 0.5, y + height - margin);
                        } else {
                            if (tabStripPosition === core_enum_1.TabStripPosition.bottom) {
                                ctx.moveTo(x + 0.5, y);
                                ctx.lineTo(x + 0.5, y + height - margin);
                                ctx.moveTo(x + width + 0.5, y);
                                ctx.lineTo(x + width + 0.5, y + height - margin);
                            } else if (tabStripPosition === core_enum_1.TabStripPosition.top) {
                                ctx.moveTo(x + 0.5, y + margin + 4);
                                ctx.lineTo(x + 0.5, y + height);
                                ctx.moveTo(x + width + 0.5, y + margin + 4);
                                ctx.lineTo(x + width + 0.5, y + height);
                            }
                        }
                    } else {
                        ctx.beginPath();
                        ctx.lineWidth = 1;
                        ctx.strokeStyle = styles && styles.borderLeftColor;
                        if (!isActive) {
                            ctx.moveTo(x + asideTabMargin, y + 0.5);
                            ctx.lineTo(x - asideTabMargin + width, y + 0.5);
                            ctx.moveTo(x + asideTabMargin, y + height + 0.5);
                            ctx.lineTo(x - asideTabMargin + width, y + height + 0.5);
                        } else {
                            if (tabStripPosition === core_enum_1.TabStripPosition.left) {
                                ctx.moveTo(x + asideTabMargin, y + 0.5);
                                ctx.lineTo(x + asideTabMargin + width, y + 0.5);
                                ctx.moveTo(x + asideTabMargin, y + height + 0.5);
                                ctx.lineTo(x + asideTabMargin + width, y + height + 0.5);
                            } else {
                                ctx.moveTo(x, y + 0.5);
                                ctx.lineTo(x + width - asideTabMargin, y + 0.5);
                                ctx.moveTo(x, y + height + 0.5);
                                ctx.lineTo(x + width - asideTabMargin, y + height + 0.5);
                            }
                        }
                    }
                    ctx.stroke();
                    ctx.restore();
                };
                // 绘制活动选项卡边框
                _SheetTab.prototype._drawActiveTabBorder = function (ctx, x, y, width, height, styles, isSelected) {
                    var self = this;
                    var workbook = self._workbook;
                    var tabStripPosition = workbook.options.tabStripPosition;
                    var margin = self._tabMargin;
                    var asideTabMargin = self._asideTabMargin;
                    if (isSelected) {
                        ctx.save();
                        ctx.beginPath();
                        ctx.strokeStyle = styles && styles.borderBottomColor;
                        ctx.lineWidth = 1;
                        if (tabStripPosition === core_enum_1.TabStripPosition.bottom) {
                            ctx.moveTo(x, y + height - margin);
                            ctx.lineTo(x + width + 1, y + height - margin);
                        } else if (tabStripPosition === core_enum_1.TabStripPosition.top) {
                            ctx.arc(x + 4.5, y + margin + 4, 4, Math.PI, Math.PI * 1.5);
                            ctx.arc(x + width - 3.5, y + margin + 4, 4, Math.PI * 1.5, 0);
                        } else if (tabStripPosition === core_enum_1.TabStripPosition.left) {
                            ctx.moveTo(x + asideTabMargin, y);
                            ctx.lineTo(x + asideTabMargin, y + height + 1);
                        } else {
                            ctx.moveTo(width - asideTabMargin, y);
                            ctx.lineTo(width - asideTabMargin, y + height + 1);
                        }
                        ctx.stroke();
                        ctx.restore();
                    }
                };
                // 绘制选项卡文本
                _SheetTab.prototype._drawTabText = function (ctx, x, y, width, height, text, styles, backColor, isSelected, isActive, isHover) {
                    var self = this;
                    var tabStripPosition = self._workbook.options.tabStripPosition;
                    var asideTabMargin = self._asideTabMargin;
                    var padding = self._tabPadding;
                    var moreText = self._moreText;
                    var sheet = self._workbook._getSheetOrSheetTabFromName(text);
                    var customBackColor = sheet && sheet.options.sheetTabColor;
                    ctx.save();
                    ctx.textBaseline = 'top';
                    var solidBackColor;
                    if (typeof (backColor) === 'string') {
                        solidBackColor = backColor;
                    }
                    var textColor = self._getTabForeColor(styles, solidBackColor);
                    ctx.fillStyle = textColor;
                    var adjX = self._tabLeftPadding;
                    ctx.textBaseline = 'middle';
                    if (tabStripPosition === core_enum_1.TabStripPosition.bottom) {
                        ctx.fillText(text, x + adjX, y + height / 2 - 1);
                    } else if (tabStripPosition === core_enum_1.TabStripPosition.top) {
                        ctx.fillText(text, x + adjX, y + height / 2 + 2);
                    } else {
                        ctx.beginPath();
                        var clipWidth = x + width - asideTabMargin * 2 - padding * 2 - 2 - 1;
                        ctx.rect(x + asideTabMargin, y + 0.5, clipWidth + padding, height + 0.5);
                        ctx.clip();
                        ctx.fillText(text, x + asideTabMargin + padding, y + height / 2 + 2);
                        var moreTextLen = ctx.measureText(moreText).width;
                        var textWidth = ctx.measureText(text).width;
                        if (textWidth - moreTextLen > clipWidth) {
                            ctx.beginPath();
                            var clipBackColor = void 0;
                            if (customBackColor) {
                                clipBackColor = backColor;
                            } else if (isActive || isSelected) {
                                clipBackColor = self._tabBackColor;
                            } else {
                                clipBackColor = _ColorHelper._toString(self._backgroundColor);
                            }
                            ctx.fillStyle = clipBackColor;
                            ctx.fillRect(x + asideTabMargin + padding + clipWidth - moreTextLen, y + 1.5, clipWidth, height - 1.5);
                            ctx.fillStyle = textColor;
                            ctx.fillText(moreText, x + asideTabMargin + padding + clipWidth - moreTextLen, y + height / 2 + 2);
                        }
                    }
                    ctx.restore();
                };
                // 绘制选项卡
                _SheetTab.prototype._drawTab = function (ctx, x, y, width, height, tabIndex, isActive, isHover, text, isSelected) {
                    var self = this;
                    var visualState = core_enum_1.VisualState.normal;
                    if (isHover) {
                        visualState = core_enum_1.VisualState.hover;
                    }
                    if (isSelected) {
                        visualState = core_enum_1.VisualState.selected;
                    }
                    if (isActive) {
                        visualState = core_enum_1.VisualState.active;
                    }
                    if (isActive && !isSelected) {
                        visualState = core_enum_1.VisualState.activeNotSelected;
                    }
                    var externalThemeStyle = common_1._ThemeStyleHelper._getVisualStateThemeStyle(visualState, 'gc-tab-' + common_1._ThemeStyleHelper._getString(visualState));
                    var themeStyle = common_1._ThemeStyleHelper._getVisualStateThemeStyle(0, 'gc-tab-' + common_1._ThemeStyleHelper._getString(0));
                    var backColor = self._getTabBackColor(ctx, isActive, text, themeStyle, y);
                    if (isSelected) {
                        backColor = externalThemeStyle.backgroundColor;
                    }
                    self._drawTabBackground(ctx, x, y, width, height, backColor, isSelected, isActive);
                    self._drawInactiveTabBorder(ctx, x, y, width, height, themeStyle, isActive);
                    self._drawActiveTabBorder(ctx, x, y, width, height, externalThemeStyle, isSelected);
                    self._drawTabText(ctx, x, y, width, height, text, externalThemeStyle, backColor, isSelected, isActive, isHover);
                };
                // 绘制创建按钮
                _SheetTab.prototype._drawNavButton = function (ctx, x1, y1, x2, y2, x3, y3, direction, linePosition, isHover) {
                    ctx.save();
                    var self = this;
                    var isPrev = direction === sheettabbase_1.NavButtonDirection.left || direction === sheettabbase_1.NavButtonDirection.top;
                    var visualState = core_enum_1.VisualState.highlight;
                    if (isHover) {
                        visualState = core_enum_1.VisualState.hover;
                    }
                    if (isPrev) {
                        if (direction === sheettabbase_1.NavButtonDirection.left) {
                            x1 -= 2;
                            x2 -= 2;
                        } else {
                            y1 -= 2;
                            y2 -= 2;
                        }
                        var preVisibleIndex = self._getPreVisibleIndex(self._firstTab);
                        if (preVisibleIndex === -1) {
                            visualState = core_enum_1.VisualState.normal;
                        }
                    } else {
                        if (direction === sheettabbase_1.NavButtonDirection.right) {
                            x1 += 2;
                            x2 += 2;
                        } else {
                            y1 += 2;
                            y2 += 2;
                        }
                        var currTabIndex = self._reCalculateFirstTabIndex(self._getVisibleTabs());
                        if (currTabIndex === -1) {
                            visualState = core_enum_1.VisualState.normal;
                        }
                    }
                    var themeStyle = common_1._ThemeStyleHelper._getVisualStateThemeStyle(visualState, 'gc-navButton-' + common_1._ThemeStyleHelper._getString(visualState));
                    ctx.strokeStyle = this._getVisibleForeColor(themeStyle.borderTopColor);
                    ctx.beginPath();
                    var step = isPrev ? 1 : -1;
                    if (direction === sheettabbase_1.NavButtonDirection.left || direction === sheettabbase_1.NavButtonDirection.right) {
                        ctx.moveTo(x1 - 0.5, y1);
                        ctx.lineTo(x1 - 0.5, y1 + 1);
                        ctx.moveTo(x1 + step - 0.5, y1 - 1);
                        ctx.lineTo(x1 + step - 0.5, y1 + 2);
                        ctx.moveTo(x1 + step * 2 - 0.5, y1 - 2);
                        ctx.lineTo(x1 + step * 2 - 0.5, y1 + 3);
                        ctx.moveTo(x1 + step * 3 - 0.5, y1 - 3);
                        ctx.lineTo(x1 + step * 3 - 0.5, y1 + 4);
                    } else if (direction === sheettabbase_1.NavButtonDirection.top || direction === sheettabbase_1.NavButtonDirection.bottom) {
                        ctx.moveTo(x1, y1 - 0.5);
                        ctx.lineTo(x1 + 1, y1 - 0.5);
                        ctx.moveTo(x1 - 1, y1 + step - 0.5);
                        ctx.lineTo(x1 + 2, y1 + step - 0.5);
                        ctx.moveTo(x1 - 2, y1 + step * 2 - 0.5);
                        ctx.lineTo(x1 + 3, y1 + step * 2 - 0.5);
                        ctx.moveTo(x1 - 3, y1 + step * 3 - 0.5);
                        ctx.lineTo(x1 + 4, y1 + step * 3 - 0.5);
                    }
                    ctx.stroke();
                    ctx.restore();
                };
                // 绘制新图纸选项卡
                _SheetTab.prototype._drawNewSheetTab = function (ctx, x, y, width, height, isHover) {
                    var self = this;
                    ctx.save();
                    ctx.beginPath();
                    var visualState = core_enum_1.VisualState.highlight;
                    if (isHover) {
                        visualState = core_enum_1.VisualState.hover;
                    }
                    var themeStyle = common_1._ThemeStyleHelper._getVisualStateThemeStyle(visualState, 'gc-tabStripNewTab-' + common_1._ThemeStyleHelper._getString(visualState));
                    ctx.strokeStyle = self._getVisibleForeColor(themeStyle.borderTopColor);
                    ctx.lineWidth = 2;
                    ctx.moveTo(x + width / 2 - 6, y + height / 2);
                    ctx.lineTo(x + width / 2 + 6, y + height / 2);
                    ctx.moveTo(x + width / 2, y + height / 2 - 6);
                    ctx.lineTo(x + width / 2, y + height / 2 + 6);
                    ctx.stroke();
                    ctx.restore();
                };
                // 绘制更多选项卡
                _SheetTab.prototype._drawMoreTab = function (ctx, x, y, width, height) {
                    ctx.save();
                    ctx.beginPath();
                    var visualState = core_enum_1.VisualState.highlight, hoverNavButton = this._hoverNavButton;
                    if (hoverNavButton === 5 || hoverNavButton === 6) {
                        visualState = core_enum_1.VisualState.hover;
                    }
                    var themeStyle = common_1._ThemeStyleHelper._getVisualStateThemeStyle(visualState, 'gc-navMoreButton-' + common_1._ThemeStyleHelper._getString(visualState));
                    ctx.fillStyle = this._getVisibleForeColor(themeStyle.borderTopColor);
                    ctx.fillRect(x + width / 2, y + height / 2, 2, 2);
                    ctx.fillRect(x + width / 2 - 4, y + height / 2, 2, 2);
                    ctx.fillRect(x + width / 2 + 4, y + height / 2, 2, 2);
                    ctx.restore();
                };
                // 获取可见前景色
                _SheetTab.prototype._getVisibleForeColor = function (value) {
                    var color = _Color_parse(value), backgroundColor = this._backgroundColor;
                    if (color.a <= 0.01) {
                        return _Color_invertColor(backgroundColor);
                    } else if (_ColorHelper._isTwoColorSimilar(backgroundColor, color)) {
                        return _Color_invertColor(color);
                    }
                    return value;
                };
                return _SheetTab;
            }(sheettabbase_1._SheetTabBase));
            exports._SheetTab = _SheetTab;
        }),
        './dist/core/workbook/sheettab2007.js': (function (module, exports, __webpack_require__) {
            Object.defineProperty(exports, '__esModule', { value: true });
            exports._SheetTab2007 = {};
        }),
        './dist/core/workbook/sheettabbase.js': (function (module, exports, __webpack_require__) {
            Object.defineProperty(exports, '__esModule', { value: true });
            var core_ns_1 = __webpack_require__(/*! ../core.ns */ './dist/core/core.ns.js');
            var Common_1 = __webpack_require__(/*! Common */ 'Common');
            var domUtil_1 = __webpack_require__(/*! ../util/domUtil */ './dist/core/util/domUtil.js');
            var common_1 = __webpack_require__(/*! ../util/common */ './dist/core/util/common.js');
            var stylehelper_1 = __webpack_require__(/*! ../worksheet/stylehelper */ './dist/core/worksheet/stylehelper.js');
            var core_enum_1 = __webpack_require__(/*! ../core.enum */ './dist/core/core.enum.js');
            var _ColorHelper = Common_1.Common._ColorHelper;
            var getLinearGradientColors = common_1._util._getLinearGradientColors;
            var isValidSheetName = common_1._util._isValidSheetName;
            var isNullOrUndefined = Common_1.Common._Types._isNullOrUndefined;
            var createElement = common_1._util._createElement;
            var getFontHeight = common_1._util._getFontHeight;
            var setContextFont = common_1._util._setContextFont;
            var convertToInt = parseInt;
            var WINDOW = window;
            var DOCUMENT = document;
            var keyword_null = null;
            var Math_max = Math.max;
            var Math_min = Math.min;
            var Math_pow = Math.pow;
            var Math_round = Math.round;
            var pixel = 'px';
            var cssNone = 'none';
            var gcTab_ns = '.gcTab';
            var gcTab_mousedown = 'mousedown' + gcTab_ns;
            var gcTab_mousemove = 'mousemove' + gcTab_ns;
            var gcTab_mouseup = 'mouseup' + gcTab_ns;
            var gcTab_mouseout = 'mouseout' + gcTab_ns;
            var gcTab_dbclick = 'dblclick' + gcTab_ns;
            var gcTab_mousewheel = 'mousewheel' + gcTab_ns;
            var spliter_ns = '.spliter';
            var spliter_mousemove = 'mousemove' + spliter_ns;
            var spliter_mouseup = 'mouseup' + spliter_ns;
            var tabNameEditor_ns = '.tabNameEditor';
            var tabNameEditor_keydown = 'keydown' + tabNameEditor_ns;
            var tabNameEditor_focus = 'focus' + tabNameEditor_ns;
            var tabNameEditor_blur = 'blur' + tabNameEditor_ns;
            var tag_canvas = 'canvas';
            var str_2d = '2d';
            var hit_element_resize = 'resize';
            var hit_element_navButton = 'navButton';
            var hit_element_tab = 'tab';
            var hit_element_newSheet = 'newSheet';
            var hit_element_blank = 'blank';
            var color_black = 'black';
            var color_white = 'white';
            var TAB_INDICATOR_SIZE = 7;
            var REORDER_MAX_DISTANCE = 10;
            var HIT_TYPE_NAVBUTTON = 'navButton';
            var HIT_TYPE_SHEETTAB = 'sheetTab';
            exports.NEW_TAB_SIZE_ASIDE = 28;
            var rm = new Common_1.Common.ResourceManager(core_ns_1.SR);
            var getSR = rm.getResource.bind(rm);
            // 触发器工作表选项卡单击
            function triggerSheetTabClick(spread, sheet, sheetTabIndex) {
                spread._trigger(common_1.Events.SheetTabClick, {
                    sheet: sheet,
                    sheetName: sheet ? sheet.name() : keyword_null,
                    sheetTabIndex: isNullOrUndefined(sheetTabIndex) ? -1 : sheetTabIndex
                });
            }
            // 触发工作表移动
            function triggerSheetMoving(spread, data) {
                spread._trigger(common_1.Events.SheetMoving, data);
            }
            // 触发工作表移动
            function triggerSheetMoved(spread, sheet, oldIndex, newIndex) {
                spread._trigger(common_1.Events.SheetMoved, {
                    sheet: sheet,
                    sheetName: sheet ? sheet.name() : keyword_null,
                    oldIndex: oldIndex,
                    newIndex: newIndex
                });
            }
            // 调整目标选项卡位置
            function adjustTargetTabPosition(position, oldIndex, newIndex, tabSizes) {
                if (oldIndex > newIndex) {
                    for (var i = newIndex; i < oldIndex; i++) {
                        position -= tabSizes[i];
                    }
                } else if (oldIndex < newIndex) {
                    for (var i = oldIndex; i < newIndex; i++) {
                        position += tabSizes[i];
                    }
                }
                return position;
            }
            // 调整目标选项卡索引和位置
            function adjustTargetTabIndexAndPosition(index, position, sourceTabIndex, sheetCount, tabSizes) {
                if ((sourceTabIndex < sheetCount && index > sheetCount) || (sourceTabIndex >= sheetCount && index < sheetCount)) {
                    position = adjustTargetTabPosition(position, index, sheetCount, tabSizes);
                    index = sheetCount;
                }
                return {
                    index: index,
                    position: position
                };
            }

            // 导航按钮方向
            var NavButtonDirection;
            (function (NavButtonDirection) {
                NavButtonDirection[NavButtonDirection['left'] = 0] = 'left';
                NavButtonDirection[NavButtonDirection['right'] = 1] = 'right';
                NavButtonDirection[NavButtonDirection['top'] = 2] = 'top';
                NavButtonDirection[NavButtonDirection['bottom'] = 3] = 'bottom';
            })(NavButtonDirection = exports.NavButtonDirection || (exports.NavButtonDirection = {}));

            var _SheetTabBase = (function () {
                function _SheetTabBase(_name) {
                    this._name = _name;
                    this._hideNewTabSecondMoreTab = false;
                    this._firstTabSpace = 0;
                    this._tabSpace = 0;
                    this._asideTabMargin = 6;
                    this._paddingTopAndBottom = 3;
                    this._cornerRadius = 5;
                    this._triangleSize = 5;
                    this._tabPadding = 3;
                    this._excel2013NewSheetMarginTop = 7;
                    this._moreText = '...';
                    this.buffer = null;
                    var self = this;
                    self._workbook = keyword_null;
                    self._activeIndex = 0;
                    self._firstTab = 0;
                    self._activePos = 70;
                    self._hoverNavButton = -1;
                    self._hoverTab = -1;
                    self._font = '';
                    self._tabSizes = [];
                    self._tabHeight = 0;
                    self._targetTabIndex = -1;
                    self._sourceTabIndex = -1;
                    self._reorderSpeedTimeout = keyword_null;
                    self._paintSuspended = 0;
                    self._setBounds(new common_1.Rect(0, 0, 200, 28));
                }
                _SheetTabBase.prototype.getNewTabBounds = function () {
                    var self = this;
                    var useTouchLayout = self._workbook.options.useTouchLayout;
                    var bounds = self._getBounds();
                    var newTabSize = self._getNewTabSize();
                    var newTabRadius = (newTabSize - self._excel2013NewSheetMarginTop * 2) / 2;
                    var x, y, width, height;
                    if (useTouchLayout) {
                        x = bounds.x;
                        y = bounds.y;
                        width = bounds.width;
                        height = newTabSize;
                    } else {
                        x = (bounds.x + bounds.width - newTabRadius * 2) / 2;
                        y = (bounds.y + newTabSize - newTabRadius * 2) / 2;
                        width = newTabRadius * 2;
                        height = newTabRadius * 2;
                    }
                    return {
                        x: x,
                        y: y,
                        width: width,
                        height: height
                    };
                };
                // 是否水平选项卡
                _SheetTabBase.prototype._isHorizontalTabs = function () {
                    var self = this;
                    var tabStripPosition = self._workbook.options.tabStripPosition;
                    return tabStripPosition === core_enum_1.TabStripPosition.bottom || tabStripPosition === core_enum_1.TabStripPosition.top;
                };
                _SheetTabBase.prototype._setHost = function (host) {
                    if (!host) {
                        return;
                    }
                    var self = this;
                    var oldCanvas = self._canvas;
                    if (oldCanvas) {
                        self._dispose(true);
                    }
                    var canvas = createElement(tag_canvas);
                    common_1._DPIHelper._adjustDevicePixel(canvas, self._workbook);
                    canvas.setAttribute('id', self._name);
                    self._tabIndicator = self._getTabIndicator();
                    self._refreshTabIndicator();
                    host.appendChild(self._tabIndicator[0]);
                    host.appendChild(canvas);
                    self._canvas = canvas;
                    domUtil_1.GC$(canvas)
                        .bind(gcTab_mousedown, function (e) {
                            return self._doMouseDown(e);
                        })
                        .bind(gcTab_mousemove, function (e) {
                            return self._doMouseMove(e);
                        })
                        .bind(gcTab_mouseup, function (e) {
                            return self._doMouseUp(e);
                        })
                        .bind(gcTab_mouseout, function (e) {
                            return self._doMouseOut(e);
                        })
                        .bind(gcTab_dbclick, function (e) {
                            return self._doMouseDbClick(e);
                        })
                        .bind(gcTab_mousewheel, function (e) {
                            return self._doMouseWheel(e);
                        });
                    self._doResize();
                    _SheetTabBase._callFeatureHandler(self, 'setHost');
                };
                _SheetTabBase.prototype._setOwner = function (owner) {
                    var self = this;
                    self._workbook = owner;
                    if (owner) {
                        var font = owner.options.font;
                        if (font && font.length > 0) {
                            self._font = font;
                        }
                        self._refreshTabIndicator();
                    }
                };
                _SheetTabBase.prototype._scrollTabToView = function (index) {
                    var workbook = this._workbook;
                    workbook.suspendPaint();
                    this._scrollTabImp(index);
                    workbook.resumePaint();
                };
                _SheetTabBase.prototype._scrollTabImp = function (index) {
                    var self = this;
                    var workbook = self._workbook;
                    var isHorizontalTabs = self._isHorizontalTabs();
                    var tabHeight = self._tabHeight;
                    var availableSize = self._getCoverPosition();
                    var tabSumSize = 0;
                    var tabsWidth = self._tabSizes, i;
                    var basicSize = self._getBasicWidth();
                    var visibleTabs = self._getVisibleTabs();
                    var scrollTarget;
                    var info = self._generateTabsInfo().tabsInfo;
                    if (info[0].index > index) {
                        workbook.startSheetIndex(index);
                        return;
                    }
                    for (i = index - 1; i >= 0; i--) {
                        index = visibleTabs[i];
                        var itemSize = isHorizontalTabs ? tabsWidth[index] : tabHeight;
                        tabSumSize += itemSize;
                        if (i !== visibleTabs.length - 1) {
                            tabSumSize += isHorizontalTabs ? self._tabSpace : 0;
                        }
                        var totalSize = basicSize + tabSumSize;
                        if (i !== 0) {
                            totalSize += isHorizontalTabs ? self._firstTabSpace : tabHeight;
                        }
                        if (totalSize > availableSize) {
                            i = isHorizontalTabs ? i + 1 : i;
                            scrollTarget = i;
                            break;
                        }
                    }
                    if (scrollTarget) {
                        workbook.startSheetIndex(scrollTarget);
                    }
                };
                // 获取边界
                _SheetTabBase.prototype._getBounds = function () {
                    var bounds = this._bounds;
                    return new common_1.Rect(bounds.x, bounds.y, bounds.width, bounds.height);
                };
                _SheetTabBase.prototype._setBounds = function (rect) {
                    var bounds = this._bounds = new common_1.Rect(0, 0, 0, 0);
                    bounds.x = rect.x;
                    bounds.y = rect.y;
                    bounds.width = rect.width;
                    bounds.height = rect.height;
                };
                _SheetTabBase.prototype._getNewTabSize = function () {
                    var self = this;
                    var newTabVisible = self._workbook.options.newTabVisible;
                    if (!newTabVisible) {
                        return 0;
                    }
                    return this._newTabSize;
                };
                // 获取选项卡结束位置
                _SheetTabBase.prototype._getTabEndPosition = function () {
                    var self = this;
                    var rect = self._getBounds();
                    var isHorizontalTabs = self._isHorizontalTabs();
                    if (isHorizontalTabs) {
                        return rect.x + rect.width - self._getResizeBarWidth();
                    } else {
                        return rect.y + rect.height - self._getNavigationButtonHeight();
                    }
                };
                _SheetTabBase.prototype._getTabStartPosition = function () {
                    return 0;
                };
                _SheetTabBase.prototype._getResizeBarWidth = function () {
                    var self = this;
                    var position = core_enum_1.TabStripPosition.bottom;
                    var workbook = self._workbook;
                    if (workbook) {
                        position = workbook.options.tabStripPosition;
                    }
                    return position === core_enum_1.TabStripPosition.bottom ? self._resizeBarWidth : 0;
                };
                // 调整大小
                _SheetTabBase.prototype._doResize = function () {
                    var self = this;
                    var canvas = self._getCanvas();
                    if (!canvas || !canvas.parentNode) {
                        return;
                    }
                    var $parent = domUtil_1.GC$(canvas.parentNode);
                    if ($parent.width() === 0 || $parent.height() === 0) {
                        return;
                    }
                    var width = Math_max($parent.width(), 0), height = Math_max($parent.height(), 0);
                    canvas.style.display = cssNone;
                    canvas.width = width;
                    canvas.height = height;
                    canvas.style.display = '';
                    canvas.style.width = width + pixel;
                    canvas.style.height = height + pixel;
                    width = canvas.clientWidth || canvas.width;
                    height = canvas.clientHeight || canvas.height;
                    var oldBounds = self._getBounds();
                    self._setBounds(new common_1.Rect(oldBounds.x, oldBounds.y, width, height));
                    common_1._DPIHelper._setSize(canvas, width, height);
                    self.repaint();
                };
                // 是否封面页选项卡
                _SheetTabBase.prototype._isCoverSheetTab = function () {
                    return false;
                };
                // 获取导航按钮高度
                _SheetTabBase.prototype._getNavigationButtonHeight = function () {
                    return 0;
                };
                _SheetTabBase.prototype._getCoverPosition = function () {
                    return 0;
                };
                _SheetTabBase.prototype._getInputTopPosition = function () {
                    return 0;
                };
                _SheetTabBase.prototype._getTabIndicatorEdgeElements = function () {
                    return [];
                };
                _SheetTabBase.prototype._getBasicWidth = function () {
                    return 0;
                };
                _SheetTabBase.prototype._getTabIndicator = function () {
                    if (this._tabIndicator) {
                        return this._tabIndicator;
                    } else {
                        return domUtil_1.GC$(createElement('div'));
                    }
                };
                // 刷新选项卡指示器
                _SheetTabBase.prototype._refreshTabIndicator = function () {
                    var self = this;
                    var indicator = self._tabIndicator;
                    if (indicator) {
                        var workbook = self._workbook;
                        var tabStripPosition = workbook ? workbook.options.tabStripPosition : core_enum_1.TabStripPosition.bottom;
                        var className = void 0;
                        if (tabStripPosition === core_enum_1.TabStripPosition.bottom) {
                            className = 'gc-tab-indicator-bottom';
                        } else if (tabStripPosition === core_enum_1.TabStripPosition.top) {
                            className = 'gc-tab-indicator-top';
                        } else if (tabStripPosition === core_enum_1.TabStripPosition.left) {
                            className = 'gc-tab-indicator-left';
                        } else if (tabStripPosition === core_enum_1.TabStripPosition.right) {
                            className = 'gc-tab-indicator-right';
                        }
                        indicator.removeClass();
                        indicator.addClass(className);
                    }
                };
                _SheetTabBase.prototype._dispose = function (keepWorkbook) {
                    var self = this;
                    var canvas = self._canvas, parentNode;
                    if (canvas) {
                        parentNode = canvas.parentNode;
                        domUtil_1.GC$(canvas).unbind(gcTab_mousedown).unbind(gcTab_mousemove).unbind(gcTab_mouseup).unbind(gcTab_dbclick).unbind(gcTab_mouseout);
                        if (parentNode) {
                            parentNode.removeChild(canvas);
                        }
                    }
                    domUtil_1.GC$(self._tabIndicator).remove();
                    _SheetTabBase._callFeatureHandler(self, 'dispose');
                    if (!keepWorkbook) {
                        self._workbook = keyword_null;
                    }
                };
                // 水平标签命中测试
                _SheetTabBase.prototype._horizontalTabsHitTest = function (left, top) {
                    var self = this;
                    var workbook = self._workbook;
                    var isMobileScrollbar = workbook.options.scrollbarAppearance === core_enum_1.ScrollbarAppearance.mobile;
                    var showHorizontalScrollbar = workbook.options.showHorizontalScrollbar;
                    var rect = self._getBounds();
                    if (showHorizontalScrollbar && !isMobileScrollbar) {
                        var resizeBarRect = self.getResizeBarBounds();
                        if (workbook.options.showHorizontalScrollbar && !isMobileScrollbar && left > resizeBarRect.x && left < rect.x + rect.width) {
                            return {
                                type: 'resize',
                                element: hit_element_resize
                            };
                        }
                    }
                    var navButtonRect = self.getNavButtonBounds();
                    var navButton = -1;
                    var startIndex = navButtonRect.startIndex;
                    var x = navButtonRect.x;
                    var endIndex = navButtonRect.endIndex;
                    var navbuttonStr = [
                        'first', 'prevArrow', 'nextArrow', 'last', '', 'prevButton', 'nextButton'
                    ];
                    var i;
                    for (i = startIndex; i < endIndex; i++) {
                        if (x < left && left < x + navButtonRect.width) {
                            navButton = i;
                            hit_element_navButton = navbuttonStr[i];
                            break;
                        }
                        x += navButtonRect.width;
                    }
                    if (navButton !== -1) {
                        return {
                            type: HIT_TYPE_NAVBUTTON,
                            element: hit_element_navButton,
                            index: i
                        };
                    }
                    var preMoreTabRect = self.getPreMoreTabBounds();
                    x = preMoreTabRect.x;
                    var step = 0;
                    var preTabIndex = self._getPreVisibleIndex(self._firstTab);
                    if (preTabIndex !== -1) {
                        if (x <= left && left < x + preMoreTabRect.width) {
                            hit_element_navButton = navbuttonStr[5];
                            return {
                                type: HIT_TYPE_NAVBUTTON,
                                element: hit_element_navButton,
                                index: 5,
                                position: x
                            };
                        }
                        step = self._firstTabSpace;
                    }
                    var sheetTabRect = self.getSheetTabBounds();
                    var sheetTabs = workbook._getSheetsAndSheetTabs();
                    var tabSizes = self._tabSizes;
                    var tabSpace = self._tabSpace;
                    var tabSize = 0;
                    x = sheetTabRect.x + step;
                    if (self._firstTab > -1) {
                        for (i = self._firstTab; i < sheetTabs.length && i < tabSizes.length; i++) {
                            if (sheetTabs[i].visible()) {
                                tabSize = tabSizes[i];
                                if (x < left && left < x + tabSize + tabSpace) {
                                    if (sheetTabRect.moreTabPos > 0 && left < sheetTabRect.moreTabPos) {
                                        return {
                                            type: HIT_TYPE_SHEETTAB,
                                            element: hit_element_tab,
                                            index: i,
                                            position: x
                                        };
                                    } else if (sheetTabRect.moreTabPos === 0) {
                                        return {
                                            type: HIT_TYPE_SHEETTAB,
                                            element: hit_element_tab,
                                            index: i,
                                            position: x
                                        };
                                    }
                                }
                                x += (tabSize + tabSpace);
                            }
                        }
                    }
                    if (x > sheetTabRect.moreTabPos && sheetTabRect.moreTabPos > 0) {
                        x = sheetTabRect.moreTabPos;
                    }
                    if (self._reCalculateFirstTabIndex(self._getVisibleTabs()) !== -1) {
                        if (x < left && left < x + sheetTabRect.secondMoreTabWidth) {
                            hit_element_navButton = navbuttonStr[6];
                            return {
                                type: HIT_TYPE_NAVBUTTON,
                                element: navbuttonStr[6],
                                index: 6,
                                position: x
                            };
                        }
                        x += sheetTabRect.secondMoreTabWidth;
                    }
                    if (workbook.options.newTabVisible && x < left && left < x + self._getNewTabSize()) {
                        return {
                            type: HIT_TYPE_SHEETTAB,
                            element: hit_element_newSheet,
                            position: x,
                            index: -1
                        };
                    }
                    return {
                        element: hit_element_blank
                    };
                };
                // 垂直标签命中测试
                _SheetTabBase.prototype._verticalTabsHitTest = function (left, top) {
                    var self = this;
                    var workbook = self._workbook;
                    var i;
                    var navButtonRect = self.getNavButtonBounds();
                    var navButton = -1;
                    var x = navButtonRect.x, y = navButtonRect.y;
                    var startIndex = navButtonRect.startIndex;
                    var endIndex = navButtonRect.endIndex;
                    var navbuttonStr = ['first', 'prevArrow', 'nextArrow', 'last', '', 'prevButton', 'nextButton'];
                    for (i = startIndex; i < endIndex; i++) {
                        if (x < left && left < x + navButtonRect.width && y < top && top < y + navButtonRect.height) {
                            navButton = i;
                            hit_element_navButton = navbuttonStr[i];
                            break;
                        }
                        x += navButtonRect.width;
                    }
                    if (navButton !== -1) {
                        return {
                            type: HIT_TYPE_NAVBUTTON,
                            element: hit_element_navButton,
                            index: i
                        };
                    }
                    var newTabSize = self._getNewTabSize();
                    y = newTabSize;
                    var sheetTabs = workbook._getSheetsAndSheetTabs(), tabSizes = self._tabSizes;
                    var tabSize = self._tabHeight;
                    if (self._firstTab > -1) {
                        for (i = self._firstTab; i < sheetTabs.length && i < tabSizes.length; i++) {
                            if (sheetTabs[i].visible()) {
                                if (y < top && top < y + tabSize) {
                                    return {
                                        type: HIT_TYPE_SHEETTAB,
                                        element: hit_element_tab,
                                        index: i,
                                        position: y
                                    };
                                }
                                y += tabSize;
                            }
                        }
                    }
                    var newTabBounds = self.getNewTabBounds();
                    if ((workbook.options.newTabVisible) &&
                        (newTabBounds.x < left && left < newTabBounds.x + newTabBounds.width && newTabBounds.y < top && top < newTabBounds.y + newTabBounds.height)) {
                        return {
                            type: HIT_TYPE_SHEETTAB,
                            element: hit_element_newSheet,
                            position: y,
                            index: -1
                        };
                    }
                    if (y < top && top < y + navButtonRect.y) {
                        if (self._reCalculateFirstTabIndex(self._getVisibleTabs()) !== -1) {
                            hit_element_navButton = navbuttonStr[6];
                            return {
                                type: HIT_TYPE_NAVBUTTON,
                                element: navbuttonStr[6],
                                index: 6,
                                position: y
                            };
                        } else {
                            return {
                                element: hit_element_blank,
                                position: y
                            };
                        }
                    }
                    return {
                        element: hit_element_blank
                    };
                };
                // 命中测试
                _SheetTabBase.prototype.hitTest = function (left, top) {
                    var self = this;
                    var isHorizontalTabs = self._isHorizontalTabs();
                    var hitTestInfo;
                    if (isHorizontalTabs) {
                        hitTestInfo = self._horizontalTabsHitTest(left, top);
                    } else {
                        hitTestInfo = self._verticalTabsHitTest(left, top);
                    }
                    return hitTestInfo;
                };
                _SheetTabBase.prototype._doMouseDown = function (e) {
                    var self = this;
                    var argObj = {
                        e: e,
                        r: keyword_null
                    };
                    var returnValue;
                    this._workbook._trigger('spreadMouseDown', domUtil_1.GC$.extend({
                        source: 'sheettab'
                    }, argObj));
                    _SheetTabBase._callFeatureHandler(self, 'preProcessMouseDown', argObj);
                    returnValue = argObj.r;
                    if (!isNullOrUndefined(returnValue)) {
                        return returnValue;
                    }
                    var t = domUtil_1.GC$(self._getCanvas()).offset();
                    var left = e.pageX - t.left;
                    var top = e.pageY - t.top;
                    var activeSheet = self._workbook._getActiveSheetOrSheetTab();
                    if (self._tabNameEditor) {
                        self._endSheetTabEditing(activeSheet, false);
                    }
                    var hitTestInfo = self.hitTest(left, top);
                    var hitTestInfo_element = hitTestInfo.element;
                    if (e.button === 0) {
                        if (hitTestInfo_element === hit_element_resize) {
                            self._resizeTab = true;
                            self._activeX = e.pageX;
                            self._handleDocumentMouseMove();
                        } else if (hitTestInfo_element === hit_element_navButton) {
                            self._doNavButtonClick(hitTestInfo.index);
                        } else if (hitTestInfo_element === hit_element_tab) {
                            self._doSheetTabClick(hitTestInfo.index, hitTestInfo.position, e);
                            self._initTabReorder(e, hitTestInfo);
                        } else if (hitTestInfo_element === hit_element_newSheet) {
                            self._doNewTabClick(hitTestInfo.position);
                        }
                        activeSheet = self._workbook._getActiveSheetOrSheetTab();
                        if (activeSheet && !activeSheet.isEditing()) {
                            activeSheet._setFocus();
                        }
                    } else if (e.button === 2 && hitTestInfo_element === hit_element_tab) {
                        self._activePos = hitTestInfo.position;
                    }
                    self._isMouseDownInTab = true;
                    return false;
                };
                _SheetTabBase.prototype._doMouseMove = function (e) {
                    var self = this;
                    var workbook = self._workbook;
                    var argObj = { e: e, r: keyword_null }, returnValue;
                    _SheetTabBase._callFeatureHandler(self, 'preProcessMouseMove', argObj);
                    returnValue = argObj.r;
                    if (!isNullOrUndefined(returnValue)) {
                        return returnValue;
                    }
                    var canvasStyle = self._canvas.style;
                    var cursor_default = 'default', cursor_wresize = 'w-resize';
                    if (self._tabStartPos && !self._reorderSheet) {
                        var mousemoveDistance = Math.sqrt(Math_pow(self._tabStartPos.x - e.pageX, 2) + Math_pow(self._tabStartPos.y - e.pageY, 2));
                        if (mousemoveDistance > REORDER_MAX_DISTANCE) {
                            self._reorderSheet = true;
                        }
                    }
                    if (self._resizeTab) {
                        canvasStyle.cursor = cursor_wresize;
                        var d = e.pageX - self._activeX;
                        var totalWidth = self._workbook._vp.clientWidth;
                        workbook.options.tabStripRatio = workbook._getActualTabStripRatio() + d / totalWidth;
                        var minRatio = self._getResizeBarWidth() / totalWidth;
                        var maxRatio = 1;
                        if (workbook._getActualTabStripRatio() < minRatio) {
                            workbook.options.tabStripRatio = minRatio;
                            self._activeX = self._getResizeBarWidth();
                        } else if (workbook._getActualTabStripRatio() >= maxRatio) {
                            workbook.options.tabStripRatio = maxRatio;
                            self._activeX = totalWidth;
                        } else {
                            self._activeX = e.pageX;
                        }
                        workbook._doTabHSResize();
                    } else if (self._reorderSheet) {
                        self._showTabTip(e.pageX, e.pageY);
                        self._setTabIndicator(e);
                    } else {
                        self._hoverNavButton = -1;
                        self._hoverTab = -1;
                        var t = domUtil_1.GC$(self._getCanvas()).offset();
                        var left = e.pageX - t.left;
                        var top_1 = e.pageY - t.top;
                        var hitTestInfo = self.hitTest(left, top_1);
                        var hitTestInfo_element = hitTestInfo.element;
                        if (self._workbook && self._workbook.options.enableAccessibility) {
                            var content = self._getAccessibilityContent(hitTestInfo);
                            self._workbook._updateAccessibilityContent(content);
                        }
                        if (hitTestInfo_element === '') {
                            canvasStyle.cursor = cursor_default;
                            self.repaint();
                            return false;
                        } else if (hitTestInfo_element === hit_element_resize) {
                            canvasStyle.cursor = cursor_wresize;
                        } else {
                            canvasStyle.cursor = cursor_default;
                            if (hitTestInfo_element === hit_element_navButton) {
                                self._hoverNavButton = hitTestInfo.index;
                            } else if (hitTestInfo_element === hit_element_tab) {
                                self._hoverTab = hitTestInfo.index;
                            } else if (hitTestInfo_element === hit_element_newSheet) {
                                self._hoverTab = -2;
                            }
                        }
                        self.repaint();
                    }
                    return false;
                };
                // 获取辅助功能内容
                _SheetTabBase.prototype._getAccessibilityContent = function (hitTestInfo) {
                    var resource = getSR();
                    var content = '';
                    var hitTestInfo_element = hitTestInfo.element;
                    if (hitTestInfo_element === hit_element_resize) {
                        content = resource.ARIA_Resize;
                    } else if (hitTestInfo_element === hit_element_navButton) {
                        var dict = {
                            first: resource.ARIA_First,
                            prevArrow: resource.ARIA_PreviousArrow,
                            nextArrow: resource.ARIA_NextArrow,
                            last: resource.ARIA_Last,
                            prevButton: resource.ARIA_PreviousButton,
                            nextButton: resource.ARIA_NextButton
                        };
                        content = dict[hit_element_navButton] || '';
                    } else if (hitTestInfo_element === hit_element_tab) {
                        var name_1 = this._workbook._getSheetOrSheetTab(hitTestInfo.index).name();
                        content = resource.ARIA_SheetTab + ' ' + name_1.replace(/([0-9]+)/, ' $1 ');
                    } else if (hitTestInfo_element === hit_element_newSheet) {
                        content = resource.ARIA_NewSheet;
                    } else if (hitTestInfo_element === hit_element_blank) {
                        content = resource.ARIA_Blank;
                    }
                    return content;
                };
                _SheetTabBase.prototype._doMouseUp = function (e) {
                    var self = this;
                    var argObj = {
                        e: e, r: keyword_null
                    };
                    var returnValue;
                    _SheetTabBase._callFeatureHandler(self, 'preProcessMouseUp', argObj);
                    returnValue = argObj.r;
                    if (!isNullOrUndefined(returnValue)) {
                        return returnValue;
                    }
                    if (self._resizeTab) {
                        self._resizeTab = false;
                        self._workbook._doTabHSResize();
                    }
                    self._clearSpeedTimeout();
                    if (self._reorderSheet) {
                        self._reorderSheet = false;
                        self._tabTip.remove();
                        self._reorderTab();
                        self._tabIndicator.hide();
                    }
                    self._tabStartPos = keyword_null;
                    self._clearRepeatDown();
                    self._unhandleDocumentMouseMove();
                    if (!self._isMouseDownInTab) {
                        return true;
                    }
                    self._isMouseDownInTab = false;
                    return false;
                };
                _SheetTabBase.prototype._doMouseOut = function (e) {
                    var self = this;
                    var argObj = {
                        e: e,
                        r: keyword_null
                    };
                    var returnValue;
                    _SheetTabBase._callFeatureHandler(self, 'preProcessMouseOut', argObj);
                    returnValue = argObj.r;
                    if (!isNullOrUndefined(returnValue)) {
                        return returnValue;
                    }
                    self._clearRepeatDown();
                    var oldNav = self._hoverNavButton;
                    self._hoverNavButton = -1;
                    var oldTab = self._hoverTab;
                    self._hoverTab = -1;
                    if (self._hoverNavButton !== oldNav || self._hoverTab !== oldTab) {
                        self.repaint();
                    }
                    return false;
                };
                _SheetTabBase.prototype._handleDocumentMouseMove = function () {
                    var self = this;
                    if (!self._isCapture) {
                        domUtil_1.GC$(DOCUMENT).bind(spliter_mousemove, function (e) {
                            self._doMouseMove(e);
                        }).bind(spliter_mouseup, function (e) {
                            self._doMouseUp(e);
                        });
                        var sheet = self._workbook.getActiveSheet();
                        if (sheet) {
                            sheet._continueMouseUpBubble = true;
                        }
                        self._isCapture = true;
                    }
                };
                _SheetTabBase.prototype._unhandleDocumentMouseMove = function () {
                    if (this._isCapture) {
                        this._isCapture = false;
                        domUtil_1.GC$(DOCUMENT).unbind(spliter_mousemove).unbind(spliter_mouseup);
                        var sheet = this._workbook.getActiveSheet();
                        if (sheet) {
                            delete sheet._continueMouseUpBubble;
                        }
                    }
                };
                _SheetTabBase.prototype._doNavButtonClick = function (btnClicked, ignoreRepeat) {
                    var self = this;
                    self._clearRepeatDown();
                    var visibleTabs = self._getVisibleTabs();
                    if (visibleTabs.length <= 0) {
                        return;
                    }
                    var repeatClickIntevel = 200;
                    btnClicked = btnClicked % 4;
                    if (btnClicked === 0) {
                        self._navigateToFirst(visibleTabs);
                    } else if (btnClicked === 1) {
                        if (!ignoreRepeat) {
                            self._repeatDown = WINDOW.setTimeout(function () {
                                self._doNavButtonClick(1);
                            }, repeatClickIntevel);
                        }
                        self._navigateToPrevious(visibleTabs);
                    } else if (btnClicked === 2) {
                        if (!ignoreRepeat) {
                            self._repeatDown = WINDOW.setTimeout(function () {
                                self._doNavButtonClick(2);
                            }, repeatClickIntevel);
                        }
                        self._navigateToNext(visibleTabs);
                    } else if (btnClicked === 3) {
                        self._navigateToLast(visibleTabs);
                    }
                };
                _SheetTabBase.prototype._doSheetTabClick = function (index, position, e) {
                    var self = this, workbook = self._workbook;
                    self._activeIndex = index;
                    self._activePos = position;
                    workbook.suspendPaint();
                    var activeSheet = workbook.getActiveSheet();
                    var sheet = workbook._getSheetOrSheetTab(index);
                    if (sheet && sheet.isEditing() && sheet !== activeSheet) {
                        var ignoreFormulaTextBox = activeSheet && activeSheet._formulaTextBox && activeSheet._formulaTextBox._isSelectMode;
                        if (!sheet._endEditImp(undefined, undefined, ignoreFormulaTextBox)) {
                            return;
                        }
                    }
                    triggerSheetTabClick(workbook, sheet, index);
                    self._doSheetTabClickChange(index, e);
                    workbook.resumePaint();
                    self.repaint();
                };
                _SheetTabBase.prototype._dispatchIsSelectedEvent = function (workbook, sheet, oldValue, newValue, sheetName, index) {
                    var selectArgs = {
                        oldValue: oldValue,
                        newValue: newValue,
                        sheetName: sheetName,
                        propertyName: 'isSelected',
                        cancel: false,
                        sheetIndex: index
                    };
                    workbook._trigger(common_1.Events.SheetChanging, selectArgs);
                    if (!selectArgs.cancel) {
                        sheet._isSelectedImp(newValue);
                        workbook && workbook._tabStrip && workbook._tabStrip.repaint();
                        delete selectArgs.cancel;
                        workbook._trigger(common_1.Events.SheetChanged, selectArgs);
                    }
                };
                _SheetTabBase.prototype._doNewTabClick = function (position) {
                    var self = this;
                    var workbook = self._workbook;
                    var isHorizontalTabs = self._isHorizontalTabs();
                    var activeSheet = workbook.getActiveSheet();
                    if (self._canCreateNewTab && !self._canCreateNewTab(activeSheet)) {
                        return;
                    }
                    triggerSheetTabClick(workbook, keyword_null, keyword_null);
                    var sheetTabs = workbook._getSheetsAndSheetTabs();
                    var index = workbook.getSheetCount();
                    var sheet = workbook._createSheet(workbook._getDefaultSheetName(index));
                    sheetTabs.forEach(function (sheetItem) {
                        sheetItem._isSelectedImp(false, true);
                    });
                    var sheetName = sheet.name();
                    var args = {
                        sheetName: sheetName,
                        propertyName: 'insertSheet',
                        cancel: false,
                        sheetIndex: index
                    };
                    self._dispatchIsSelectedEvent(workbook, sheet, false, true, sheetName, index);
                    workbook._trigger(common_1.Events.SheetChanging, args);
                    if (args.cancel) {
                        return;
                    }
                    workbook._addSheetImp(index, 1, sheet);
                    workbook._trigger(common_1.Events.SheetChanged, {
                        sheetName: sheet.name(),
                        propertyName: 'insertSheet',
                        sheetIndex: index
                    });
                    self._activeIndex = index;
                    self._activePos = position;
                    workbook._setActiveSheetOrSheetTabIndexImp(workbook.sheets.length - 1, 1, false, true);
                    while (self._activeIndex > self._firstTab && (self._isCoverSheetTab() || self._firstTab < self._getNextVisibleIndex(-1))) {
                        if (self._tabVisible(self._firstTab)) {
                            self._activePos -= isHorizontalTabs ? self._tabSizes[self._firstTab] : self._tabHeight;
                        }
                        self._firstTab++;
                    }
                    self.repaint();
                };
                _SheetTabBase.prototype._doSheetTabClickChange = function (index, e) {
                    var self = this, workbook = self._workbook, sheetTabs = workbook._getSheetsAndSheetTabs();
                    var isHorizontalTabs = self._isHorizontalTabs();
                    var activeSheet = workbook.getActiveSheet();
                    var doNotGetCellTypeFocus = false;
                    if (activeSheet && activeSheet._formulaTextBox && activeSheet._formulaTextBox._isSelectMode) {
                        doNotGetCellTypeFocus = true;
                    }
                    var hasMouseEvent = !!e, ctrl, shift;
                    if (hasMouseEvent) {
                        var isMac = common_1._util._isMacOS();
                        ctrl = isMac ? e.metaKey : e.ctrlKey;
                        shift = e.shiftKey;
                    }
                    if (index !== workbook._activeSheetIndex) {
                        if (ctrl) {
                            var acSheet = sheetTabs[index];
                            if (acSheet._isSelectedImp()) {
                                acSheet._isSelectedImp(false, true);
                            } else {
                                acSheet._isSelectedImp(true, true);
                                if (activeSheet && !activeSheet._isSelectedImp()) {
                                    activeSheet._isSelectedImp(true, true);
                                }
                            }
                        } else if (shift) {
                            var selectedSheets_1 = sheetTabs.slice(Math_min(workbook._activeSheetIndex, index), Math_max(workbook._activeSheetIndex, index) + 1);
                            sheetTabs.forEach(function (sheetItem) {
                                if (sheetItem.visible()) {
                                    if (selectedSheets_1.indexOf(sheetItem) !== -1) {
                                        if (!sheetItem._isSelectedImp()) {
                                            sheetItem._isSelectedImp(true, true);
                                        }
                                    } else if (sheetItem._isSelectedImp()) {
                                        sheetItem._isSelectedImp(false, true);
                                    }
                                }
                            });
                        } else {
                            var isAllVisibleSheetsSelected = sheetTabs.every(function (sheet) {
                                return sheet.visible() ? sheet._isSelectedImp() : true;
                            });
                            if (!sheetTabs[index]._isSelectedImp() || isAllVisibleSheetsSelected) {
                                sheetTabs.forEach(function (sheetItem) {
                                    sheetItem._isSelectedImp(false, true);
                                });
                            }
                            var acSheet = sheetTabs[index];
                            if (!acSheet._isSelectedImp()) {
                                acSheet._isSelectedImp(true, true);
                            }
                            workbook._setActiveSheetOrSheetTabIndexImp(index, 1, doNotGetCellTypeFocus, true);
                        }
                        var nextIndex = self._getNextVisibleIndex(self._firstTab);
                        var needPaintNext = false;
                        if (isHorizontalTabs) {
                            needPaintNext = self._activePos + self._tabSizes[self._activeIndex] > self._getCoverPosition();
                        } else {
                            needPaintNext = self._activePos + self._tabHeight >= self._getCoverPosition();
                        }
                        if (self._activeIndex > self._firstTab && needPaintNext && nextIndex !== -1) {
                            self._firstTab = nextIndex;
                        }
                    } else {
                        if (shift) {
                            sheetTabs.forEach(function (sheetItem) {
                                var sheetName = sheetItem.name();
                                var sheetIndex = workbook.getSheetIndex(sheetName);
                                if (sheetIndex !== workbook._activeSheetIndex && sheetItem._isSelectedImp() && sheetItem.visible()) {
                                    sheetItem._isSelectedImp(false, true);
                                }
                            });
                        }
                    }
                    if (self._activeIndex < self._firstTab) {
                        self._firstTab = self._getPreVisibleIndex(self._firstTab);
                    }
                };
                _SheetTabBase.prototype._doMouseDbClickImp = function (left, top) {
                    var self = this, workbook = self._workbook;
                    var isHorizontalTabs = self._isHorizontalTabs();
                    var tabStripPosition = workbook.options.tabStripPosition;
                    var themeVersion = convertToInt(common_1._ThemeStyleHelper._getCssClassThemeStyle('').zIndex);
                    var hitTestInfo = self.hitTest(left, top);
                    if (hitTestInfo.element === hit_element_tab) {
                        var tabIndex = self._activeIndex;
                        var currentSheet_1 = workbook._getSheetOrSheetTab(tabIndex);
                        if (hitTestInfo.index !== tabIndex) {
                            return;
                        }
                        workbook._trigger(common_1.Events.SheetTabDoubleClick, {
                            sheet: currentSheet_1,
                            sheetName: currentSheet_1.name(),
                            sheetTabIndex: tabIndex
                        });
                        if (!workbook.options.tabEditable) {
                            return false;
                        }
                        var element = common_1._FocusHelper._getActiveElement();
                        if (element && element.endEdit && !element.endEdit()) {
                            return;
                        }
                        common_1._FocusHelper._setActiveElement(keyword_null);
                        var canvasOffset = domUtil_1.GC$(self._getCanvas()).offset();
                        var container;
                        if (workbook.options.tabStripHost) {
                            container = workbook._getTabbarContainerDiv('gc-tabStrip-inputContainer');
                        } else {
                            container = workbook._getContainerDiv('gc-tabStrip-inputContainer');
                        }
                        var containerOffset = domUtil_1.GC$(container).offset(), containerWidth = domUtil_1.GC$(container).width();
                        var t_1 = createElement('input'), tStyle = t_1.style;
                        t_1.type = 'text';
                        t_1.value = currentSheet_1.name();
                        t_1.setAttribute('contentEditable', 'true');
                        t_1.setAttribute('autocomplete', 'off');
                        tStyle.position = 'absolute';
                        tStyle.margin = '0px';
                        tStyle.padding = '0px';
                        var editorLeft = void 0;
                        var aditorRight = void 0;
                        var editorTop = void 0;
                        var editorWidth = void 0;
                        var currentTabSize = self._tabSizes[tabIndex];
                        if (isHorizontalTabs) {
                            editorWidth = currentTabSize - self._tabLeftPadding - self._tabRightPadding + 2;
                            editorTop = canvasOffset.top - containerOffset.top + self._getInputTopPosition();
                            editorLeft = canvasOffset.left - containerOffset.left + self._activePos + self._tabLeftPadding;
                        } else {
                            var bounds = self._getBounds();
                            editorWidth = currentTabSize - self._tabLeftPadding - self._tabRightPadding + 2;
                            editorTop = canvasOffset.top - containerOffset.top + self._activePos + self._getInputTopPosition();
                            editorLeft = canvasOffset.left - containerOffset.left + bounds.x + self._asideTabMargin + self._tabPadding;
                            if (tabStripPosition === core_enum_1.TabStripPosition.left && themeVersion === 2007) {
                                editorLeft += self._asideTabMargin;
                            }
                            if (tabStripPosition === core_enum_1.TabStripPosition.right && editorLeft + editorWidth > containerWidth) {
                                aditorRight = canvasOffset.left + bounds.width - containerWidth + self._asideTabMargin + self._tabPadding;
                            }
                        }
                        if (aditorRight) {
                            tStyle.right = aditorRight + pixel;
                        } else if (editorLeft) {
                            tStyle.left = editorLeft + pixel;
                        }
                        tStyle.top = editorTop + pixel;
                        tStyle.width = editorWidth + pixel;
                        var externalThemeStyle = common_1._ThemeStyleHelper._getVisualStateThemeStyle(3, 'gc-tab-' + common_1._ThemeStyleHelper._getString(3));
                        tStyle.backgroundColor = externalThemeStyle.backgroundColor;
                        tStyle.borderWidth = '0px';
                        tStyle.outline = cssNone;
                        tStyle.zIndex = '1';
                        domUtil_1.GC$(t_1).appendTo(container);
                        self._tabNameEditor = t_1;
                        domUtil_1.GC$(t_1)
                            .addClass('gc-sheetTabEditor')
                            .bind(tabNameEditor_keydown, function (e) {
                                if (e.keyCode === 13) {
                                    self._endSheetTabEditing(currentSheet_1, false);
                                    return false;
                                } else if (e.keyCode === 27) {
                                    self._endSheetTabEditing(currentSheet_1, true);
                                    return false;
                                }
                            })
                            .bind(tabNameEditor_focus, function () {
                                t_1.selectionStart = 0;
                                t_1.selectionEnd = t_1.value.length;
                            })
                            .bind(tabNameEditor_blur, function () {
                                self._endSheetTabEditing(currentSheet_1, false);
                            });
                        t_1.focus();
                    }
                    return false;
                };
                _SheetTabBase.prototype._doMouseDbClick = function (e) {
                    var self = this;
                    var argObj = {
                        e: e,
                        r: keyword_null
                    };
                    var returnValue;
                    _SheetTabBase._callFeatureHandler(self, 'preProcessMouseDbClick', argObj);
                    returnValue = argObj.r;
                    if (!isNullOrUndefined(returnValue)) {
                        return returnValue;
                    }
                    var offset = domUtil_1.GC$(self._getCanvas()).offset();
                    var left = e.pageX - offset.left;
                    var top = e.pageY - offset.top;
                    return self._doMouseDbClickImp(left, top);
                };
                _SheetTabBase.prototype._doMouseWheel = function (e) {
                    var self = this;
                    var isHorizontalTabs = self._isHorizontalTabs();
                    var isSheetNameEditing = !isNullOrUndefined(self._tabNameEditor);
                    if (!isHorizontalTabs && !isSheetNameEditing) {
                        if (isNullOrUndefined(e.wheelDelta) && isNullOrUndefined(e.detail)) {
                            e.wheelDelta = e.originalEvent.wheelDelta;
                            e.detail = e.originalEvent.detail;
                        }
                        var wheelData = e.detail ? e.detail : e.wheelDelta;
                        var visibleTabs = self._getVisibleTabs();
                        if (wheelData > 0) {
                            self._navigateToPrevious(visibleTabs);
                        } else {
                            self._navigateToNext(visibleTabs);
                        }
                    }
                    return false;
                };
                // 结束工作表选项卡编辑
                _SheetTabBase.prototype._endSheetTabEditing = function (sheet, cancel) {
                    var self = this, tabNameEditor = self._tabNameEditor;
                    if (tabNameEditor) {
                        domUtil_1.GC$(tabNameEditor).unbind(tabNameEditor_keydown).unbind(tabNameEditor_focus).unbind(tabNameEditor_blur);
                        var newName = tabNameEditor.value;
                        if (cancel === false) {
                            var oldName = sheet.name();
                            if (newName !== oldName) {
                                var illegalMessage = {
                                    message: ''
                                };
                                if (isValidSheetName(newName, self._workbook._getSheetsAndSheetTabs(), sheet, illegalMessage) && !isNullOrUndefined(newName) && newName !== '') {
                                    sheet.getParent().commandManager().execute({
                                        cmd: 'renameSheet',
                                        sheetName: oldName,
                                        name: newName
                                    });
                                } else {
                                    sheet._trigger(common_1.Events.InvalidOperation, {
                                        sheet: sheet,
                                        sheetName: sheet.name(),
                                        invalidType: 5,
                                        message: illegalMessage.message
                                    });
                                }
                            }
                        }
                        tabNameEditor.parentNode.removeChild(tabNameEditor);
                        delete self._tabNameEditor;
                    }
                };
                // 允许工作表重新排序
                _SheetTabBase.prototype._allowSheetReorder = function () {
                    return this._workbook.options.allowSheetReorder;
                };
                // 始化选项卡重新排序
                _SheetTabBase.prototype._initTabReorder = function (e, hitTestInfo) {
                    var self = this;
                    if (self._allowSheetReorder()) {
                        self._sourceTabIndex = hitTestInfo.index;
                        self._tabTip = self._getTabTip(self._sourceTabIndex);
                        self._tabStartPos = new common_1.Point(e.pageX, e.pageY);
                        self._handleDocumentMouseMove();
                    } else {
                        self._reorderSheet = false;
                    }
                };
                // 获取选项卡提示
                _SheetTabBase.prototype._getTabTip = function (index) {
                    var sheetTabs = this._workbook._getSheetsAndSheetTabs();
                    var len = sheetTabs.length;
                    if (index >= len || index < 0) {
                        return;
                    }
                    var name = sheetTabs[index].name();
                    if (!name) {
                        name = 'sheet';
                    }
                    var tip = domUtil_1.GC$(createElement('span')).text(name).css({
                        'position': 'absolute',
                        'cursor': 'default',
                    });
                    tip.addClass('ui-widget-header gc-tab-tip-span btn-primary');
                    return tip;
                };
                // 清除“向下重复”
                _SheetTabBase.prototype._clearRepeatDown = function () {
                    var repeatDown = this._repeatDown;
                    if (repeatDown) {
                        clearTimeout(repeatDown);
                        this._repeatDown = keyword_null;
                    }
                };
                // 显示选项卡提示
                _SheetTabBase.prototype._showTabTip = function (x, y) {
                    var self = this;
                    var tip = self._tabTip;
                    if (tip && domUtil_1.GC$('.gc-tab-tip-span').length === 0) {
                        tip.appendTo(DOCUMENT.body);
                        tip.hide();
                    }
                    var tipWidth = tip.width();
                    var tipHeight = tip.height();
                    tip.css({
                        left: x - tipWidth / 2,
                        top: y - tipHeight / 2
                    });
                    tip.show();
                };
                // 设置选项卡指示器
                _SheetTabBase.prototype._setTabIndicator = function (e) {
                    var self = this;
                    var workbook = self._workbook;
                    var $canvas = domUtil_1.GC$(self._getCanvas());
                    var t = $canvas.position();
                    var offset = $canvas.offset();
                    var left = e.pageX - offset.left, top = e.pageY - offset.top;
                    var hitTestInfo = self.hitTest(left, top);
                    var hitTestInfo_element = hitTestInfo.element;
                    var rect = self._getBounds();
                    var tabStartPosition = self._getTabStartPosition();
                    var sheetLength = self._workbook._getSheetsAndSheetTabs().length;
                    var timeInterval = 100;
                    var tabStripPosition = workbook.options.tabStripPosition;
                    var isHorizontalTabs = self._isHorizontalTabs();
                    var newTabSize = self._getNewTabSize();
                    var indicator = self._tabIndicator;
                    var direction = isHorizontalTabs ? left : top;
                    var tabEndPosition;
                    if (isHorizontalTabs) {
                        tabEndPosition = rect.x + self._getCoverPosition();
                    } else {
                        tabEndPosition = rect.y + self._getCoverPosition() + newTabSize;
                    }
                    var indicatorLeft, indicatorTop;
                    if (direction > tabEndPosition) {
                        if (self._reorderSpeedTimeout === keyword_null && self._targetTabIndex < sheetLength) {
                            self._reorderSpeedTimeout = WINDOW.setInterval(function () {
                                self._navigateToNext(self._getVisibleTabs());
                                if (self._targetTabIndex === sheetLength) {
                                    self._clearSpeedTimeout();
                                    if (tabStripPosition === core_enum_1.TabStripPosition.bottom) {
                                        indicatorLeft = t.left + self._getLastTabPos() - TAB_INDICATOR_SIZE / 2;
                                        indicatorTop = t.top - TAB_INDICATOR_SIZE / 2;
                                    } else if (tabStripPosition === core_enum_1.TabStripPosition.top) {
                                        indicatorLeft = t.left + self._getLastTabPos() - TAB_INDICATOR_SIZE / 2;
                                        indicatorTop = t.top + rect.height;
                                    } else if (tabStripPosition === core_enum_1.TabStripPosition.left) {
                                        indicatorLeft = t.left + rect.width;
                                        indicatorTop = t.top + self._getLastTabPos() - TAB_INDICATOR_SIZE / 2;
                                    } else if (tabStripPosition === core_enum_1.TabStripPosition.right) {
                                        indicatorLeft = t.left - TAB_INDICATOR_SIZE / 2;
                                        indicatorTop = t.top + self._getLastTabPos() - TAB_INDICATOR_SIZE / 2;
                                    }
                                    indicator.show();
                                } else {
                                    self._targetTabIndex++;
                                    indicator.hide();
                                }
                                indicator.css({
                                    left: indicatorLeft,
                                    top: indicatorTop
                                });
                            }, timeInterval);
                        }
                    } else if (direction < tabStartPosition) {
                        if (self._reorderSpeedTimeout === keyword_null && self._targetTabIndex > 0) {
                            self._reorderSpeedTimeout = WINDOW.setInterval(function () {
                                self._navigateToPrevious(self._getVisibleTabs());
                                if (self._targetTabIndex === 0) {
                                    self._clearSpeedTimeout();
                                    if (tabStripPosition === core_enum_1.TabStripPosition.bottom) {
                                        indicatorLeft = t.left + tabStartPosition - TAB_INDICATOR_SIZE / 2;
                                        indicatorTop = t.top - TAB_INDICATOR_SIZE / 2;
                                    } else if (tabStripPosition === core_enum_1.TabStripPosition.top) {
                                        indicatorLeft = t.left + tabStartPosition - TAB_INDICATOR_SIZE / 2;
                                        indicatorTop = t.top + rect.height;
                                    } else if (tabStripPosition === core_enum_1.TabStripPosition.left) {
                                        indicatorLeft = t.left + rect.width;
                                        indicatorTop = t.top + newTabSize - TAB_INDICATOR_SIZE / 2;
                                    } else if (tabStripPosition === core_enum_1.TabStripPosition.right) {
                                        indicatorLeft = t.left - TAB_INDICATOR_SIZE;
                                        indicatorTop = t.top + newTabSize - TAB_INDICATOR_SIZE / 2;
                                    }
                                    indicator.show();
                                } else {
                                    self._targetTabIndex--;
                                    indicator.hide();
                                }
                                indicator.css({
                                    left: indicatorLeft,
                                    top: indicatorTop
                                });
                            }, timeInterval);
                        }
                    } else {
                        self._clearSpeedTimeout();
                        if (hitTestInfo_element === hit_element_tab || self._getTabIndicatorEdgeElements().indexOf(hitTestInfo_element) !== -1) {
                            var hitTestInfo_index = hitTestInfo.index;
                            if (hitTestInfo_element === hit_element_blank) {
                                hitTestInfo_index = self._targetTabIndex;
                            }
                            if (hitTestInfo_element !== hit_element_tab || isNullOrUndefined(hitTestInfo_index)) {
                                hitTestInfo_index = sheetLength;
                            }
                            var _a = adjustTargetTabIndexAndPosition(hitTestInfo_index, hitTestInfo.position, self._sourceTabIndex, self._workbook.getSheetCount(), self._tabSizes), index = _a.index, position = _a.position;
                            self._targetTabIndex = index;
                            if (tabStripPosition === core_enum_1.TabStripPosition.bottom) {
                                indicatorLeft = t.left + position - TAB_INDICATOR_SIZE / 2;
                                indicatorTop = t.top - TAB_INDICATOR_SIZE;
                            } else if (tabStripPosition === core_enum_1.TabStripPosition.top) {
                                indicatorLeft = t.left + position - TAB_INDICATOR_SIZE / 2;
                                indicatorTop = t.top + rect.height;
                            } else if (tabStripPosition === core_enum_1.TabStripPosition.left) {
                                indicatorLeft = t.left + rect.width;
                                indicatorTop = t.top + position - TAB_INDICATOR_SIZE / 2;
                            } else if (tabStripPosition === core_enum_1.TabStripPosition.right) {
                                indicatorLeft = t.left - TAB_INDICATOR_SIZE;
                                indicatorTop = t.top + position - TAB_INDICATOR_SIZE / 2;
                            }
                            indicator.css({
                                left: indicatorLeft,
                                top: indicatorTop
                            });
                            indicator.show();
                        }
                    }
                };
                // 获取最后一个选项卡位置
                _SheetTabBase.prototype._getLastTabPos = function () {
                    var self = this;
                    var isHorizontalTabs = self._isHorizontalTabs();
                    var tabsWidth = self._tabSizes;
                    var visibleTabs = self._getVisibleTabs();
                    var startIndex = self._getVisibleTabIndex(self._firstTab, visibleTabs);
                    var index = 0;
                    var startPosition = self._getTabStartPosition();
                    var tabHeight = self._tabHeight;
                    var tabSumSize = isHorizontalTabs ? startPosition + self._firstTabSpace : startPosition;
                    for (var i = startIndex; i < visibleTabs.length; i++) {
                        index = visibleTabs[i];
                        if (isHorizontalTabs) {
                            tabSumSize += tabsWidth[index];
                            tabSumSize += self._tabSpace;
                        } else {
                            tabSumSize += tabHeight;
                        }
                    }
                    return tabSumSize;
                };
                // 
                _SheetTabBase.prototype._clearSpeedTimeout = function () {
                    var reorderSpeedTimeout = this._reorderSpeedTimeout;
                    if (reorderSpeedTimeout) {
                        clearInterval(reorderSpeedTimeout);
                        this._reorderSpeedTimeout = keyword_null;
                    }
                };
                // 重新排序选项卡
                _SheetTabBase.prototype._reorderTab = function () {
                    var self = this, workbook = self._workbook;
                    var tarIndex = self._targetTabIndex;
                    var sourIndex = self._sourceTabIndex;
                    var sheet = workbook.sheets[sourIndex];
                    if (tarIndex !== -1 && sourIndex !== -1 && sourIndex !== tarIndex
                        && sourIndex !== tarIndex - 1 && self._tabIndicator.isVisible()) {
                        if (sourIndex < tarIndex - 1) {
                            tarIndex = tarIndex - 1;
                        }
                        workbook.commandManager().execute({
                            cmd: 'moveSheet',
                            sheetName: sheet.name(),
                            targetIndex: tarIndex
                        });
                    }
                };
                // 将选项卡滚动到活动状态
                _SheetTabBase.prototype._scrollTabToActive = function (srcIndex, targetIndex) {
                    var self = this;
                    var workbook = self._workbook;
                    var visibleTabs = self._getVisibleTabs();
                    if (targetIndex === workbook.getSheetCount()) {
                        self._navigateToLast(visibleTabs);
                        self._doResize();
                        return;
                    }
                    if (targetIndex === 0) {
                        self._navigateToFirst(visibleTabs);
                        self._doResize();
                        return;
                    }
                    var needScroll = self._needScroll(srcIndex, targetIndex);
                    if (needScroll) {
                        self._scrollTabToView(targetIndex);
                    }
                };
                // 需要滚动
                _SheetTabBase.prototype._needScroll = function (srcIndex, targetIndex) {
                    var self = this;
                    var info = self._generateTabsInfo().tabsInfo;
                    var hasSrc = false;
                    var hasTarget = false;
                    for (var i = 0; i < info.length; i++) {
                        if (srcIndex === info[i].index) {
                            hasSrc = true;
                        }
                        if (targetIndex === info[i].index) {
                            hasTarget = true;
                        }
                        if (hasSrc && hasTarget) {
                            self._doResize();
                            return false;
                        }
                    }
                    return true;
                };
                // 获取可见选项卡
                _SheetTabBase.prototype._getVisibleTabs = function () {
                    var visibleTabs = [], index;
                    var sheetTabs = this._workbook._getSheetsAndSheetTabs();
                    for (index = 0; index < sheetTabs.length; index++) {
                        if (this._tabVisible(index)) {
                            visibleTabs.push(index);
                        }
                    }
                    return visibleTabs;
                };
                // 导航到第一个
                _SheetTabBase.prototype._navigateToFirst = function (visibleTabs) {
                    if (visibleTabs.length > 0 && this._firstTab !== visibleTabs[0]) {
                        this._workbook.startSheetIndex(visibleTabs[0]);
                    }
                };
                // 导航到前一个
                _SheetTabBase.prototype._navigateToPrevious = function (visibleTabs) {
                    if (visibleTabs.length > 0) {
                        var self_1 = this;
                        if (self_1._firstTab > visibleTabs[0]) {
                            var preVisibleIndex = self_1._getPreVisibleIndex(self_1._firstTab);
                            if (preVisibleIndex !== -1) {
                                self_1._workbook.startSheetIndex(preVisibleIndex);
                            }
                        }
                    }
                };
                // 导航到下一个
                _SheetTabBase.prototype._navigateToNext = function (visibleTabs) {
                    if (visibleTabs.length > 0) {
                        var self_2 = this;
                        if (self_2._firstTab < visibleTabs[visibleTabs.length - 1]) {
                            var currTabIndex = self_2._reCalculateFirstTabIndex(visibleTabs);
                            if (currTabIndex !== -1) {
                                self_2._workbook.startSheetIndex(self_2._getNextVisibleIndex(self_2._firstTab));
                            }
                        }
                    }
                };
                // 导航到最后一个
                _SheetTabBase.prototype._navigateToLast = function (visibleTabs) {
                    if (visibleTabs.length > 0 && this._firstTab < visibleTabs[visibleTabs.length - 1]) {
                        var currTabIndex = this._reCalculateFirstTabIndex(visibleTabs);
                        if (currTabIndex !== -1) {
                            this._workbook.startSheetIndex(currTabIndex);
                        }
                    }
                };
                // 重新计算第一个选项卡索引
                _SheetTabBase.prototype._reCalculateFirstTabIndex = function (visibleTabs) {
                    if (visibleTabs.length > 0) {
                        var self_3 = this;
                        var isHorizontalTabs = self_3._isHorizontalTabs();
                        var tabHeight = self_3._tabHeight;
                        var availableSize = self_3._getCoverPosition();
                        var tabSumSize = 0;
                        var tabsWidth = self_3._tabSizes, i = void 0, index = void 0;
                        var basicSize = self_3._getBasicWidth();
                        var startIndex = self_3._getVisibleTabIndex(self_3._firstTab, visibleTabs);
                        if (startIndex === -1) {
                            startIndex = 0;
                        }
                        for (i = visibleTabs.length - 1; i >= startIndex; i--) {
                            index = visibleTabs[i];
                            var itemSize = isHorizontalTabs ? tabsWidth[index] : tabHeight;
                            tabSumSize += itemSize;
                            if (i !== visibleTabs.length - 1) {
                                tabSumSize += isHorizontalTabs ? self_3._tabSpace : 0;
                            }
                            var totalSize = basicSize + tabSumSize;
                            if (i !== 0) {
                                totalSize += isHorizontalTabs ? self_3._firstTabSpace : tabHeight;
                            }
                            if (totalSize > availableSize) {
                                var currIndex = void 0;
                                if (i + 1 < visibleTabs.length) {
                                    currIndex = visibleTabs[i + 1];
                                } else {
                                    currIndex = visibleTabs[visibleTabs.length - 1];
                                }
                                if (self_3._firstTab < currIndex) {
                                    return currIndex;
                                }
                                return -1;
                            }
                        }
                    }
                    return -1;
                };
                // 获取上一个可见索引
                _SheetTabBase.prototype._getPreVisibleIndex = function (tabIndex) {
                    var index;
                    for (index = tabIndex - 1; index >= 0; index--) {
                        if (this._tabVisible(index)) {
                            return index;
                        }
                    }
                    return -1;
                };
                _SheetTabBase.prototype._getNextVisibleIndex = function (tabIndex) {
                    var tabCount = this._workbook._getSheetsAndSheetTabs().length;
                    var index;
                    for (index = tabIndex + 1; index < tabCount; index++) {
                        if (this._tabVisible(index)) {
                            return index;
                        }
                    }
                    return -1;
                };
                _SheetTabBase.prototype._getVisibleTabIndex = function (tabIndex, visibleTabs) {
                    var index;
                    for (index = 0; index <= visibleTabs.length - 1; index++) {
                        if (tabIndex === visibleTabs[index]) {
                            return index;
                        }
                    }
                    return -1;
                };
                _SheetTabBase.prototype._tabVisible = function (tabIndex) {
                    var sheet = this._workbook._getSheetOrSheetTab(tabIndex);
                    return sheet && sheet.visible();
                };
                _SheetTabBase.prototype._suspendPaint = function () {
                    this._paintSuspended++;
                };
                _SheetTabBase.prototype._resumePaint = function () {
                    var self = this;
                    self._paintSuspended--;
                    if (self._paintSuspended <= 0) {
                        self._paintSuspended = 0;
                        self.repaint();
                    }
                };
                _SheetTabBase.prototype.repaint = function (clipRect) {
                    var c = this._getCanvas();
                    if (c && c.getContext) {
                        this._paint(c.getContext(str_2d), clipRect);
                    }
                };
                _SheetTabBase.prototype._paint = function (ctx, clipRect) {
                    var self = this;
                    if (self._paintSuspended > 0) {
                        return;
                    }
                    var rect = self._getBounds();
                    var canvas = self._canvas;
                    if (clipRect) {
                        if (clipRect.x >= rect.x + rect.width) {
                            return;
                        }
                        if (clipRect.y >= rect.y + rect.height) {
                            return;
                        }
                        if (clipRect.x + clipRect.width > rect.width) {
                            clipRect.width = rect.width - clipRect.x;
                            if (clipRect.width <= 0) {
                                return;
                            }
                        }
                        if (clipRect.y + clipRect.height > rect.height) {
                            clipRect.height = rect.height - clipRect.y;
                            if (clipRect.height <= 0) {
                                return;
                            }
                        }
                        if (clipRect.width <= 0 || clipRect.height <= 0) {
                            return;
                        }
                    }
                    var bufferCtx;
                    var buffer = self.buffer;
                    if (!buffer || buffer && (buffer.width !== canvas.width || buffer.height !== canvas.height) || !buffer && (buffer.width !== rect.width || buffer.height !== rect.height)) {
                        if (buffer) {
                            common_1._DPIHelper._disposeCanvasForSpread(self._workbook, buffer);
                            buffer.remove();
                        }
                        self.buffer = buffer = createElement(tag_canvas);
                        document.body.append(buffer);
                        common_1._DPIHelper._adjustDevicePixel(buffer, self._workbook);
                        common_1._DPIHelper._setSize(buffer, rect.width, rect.height);
                    }
                    if (rect.width <= 0 || rect.height <= 0 || clipRect && (clipRect.width <= 0 || clipRect.height <= 0)) {
                        return;
                    }
                    bufferCtx = self.buffer.getContext(str_2d);
                    bufferCtx.clearRect(0, 0, rect.width, rect.height);
                    common_1._CanvasHelper._translate(bufferCtx, -rect.x, -rect.y);
                    self._paintTabs(bufferCtx, clipRect);
                    common_1._CanvasHelper._translate(bufferCtx, rect.x, rect.y);
                    var targX = (rect.x >= 0) ? 0 : -rect.x;
                    var targY = (rect.y >= 0) ? 0 : -rect.y;
                    var srcX = targX, srcY = targY;
                    var width, height;
                    if (clipRect) {
                        srcX = rect.x + clipRect.x;
                        srcY = rect.y + clipRect.y;
                        rect = new common_1.Rect(srcX, srcY, clipRect.width, clipRect.height);
                    }
                    targX = (rect.x >= 0) ? rect.x : 0;
                    targY = (rect.y >= 0) ? rect.y : 0;
                    var imgData = keyword_null;
                    var ratioX = common_1._DPIHelper._getScaleX(canvas), ratioY = common_1._DPIHelper._getScaleY(canvas);
                    if (canvas && ratioX !== 1) {
                        srcX *= ratioX;
                        srcY *= ratioY;
                        rect.x *= ratioX;
                        rect.y *= ratioY;
                        rect.width *= ratioX;
                        rect.height *= ratioY;
                    }
                    try {
                        if (canvas) {
                            if (!clipRect) {
                                width = Math_min(rect.width - srcX, Math_max(canvas.width - rect.x, 3));
                                height = Math_min(rect.height - srcY, Math_max(canvas.height - rect.y, 3));
                            } else {
                                width = Math_max(rect.width - srcX, 0);
                                height = Math_max(rect.height - srcY, 0);
                            }
                        } else {
                            srcX = clipRect.x;
                            srcY = clipRect.y;
                            width = clipRect.width;
                            height = clipRect.height;
                        }
                        if (canvas) {
                            common_1._CanvasHelper._scaleTo(ctx, 1, 1);
                            ctx.clearRect(targX, targY, width, height);
                            ctx.drawImage(self.buffer, srcX, srcY, width, height, targX, targY, width, height);
                            common_1._CanvasHelper._scaleTo(ctx, ratioX, ratioY);
                        } else {
                            bufferCtx = self.buffer.getContext(str_2d);
                            imgData = bufferCtx.getImageData(srcX, srcY, width, height);
                        }
                    } catch (ex) {
                        return;
                    }
                    if (!canvas && imgData && rect.width > 0 && rect.height > 0) {
                        ctx.putImageData(imgData, targX, targY);
                    }
                };
                // 设置选项卡条带剪裁矩形
                _SheetTabBase.prototype._setTabStripClipRect = function (ctx, clipRect) {
                    var self = this;
                    var rect = self._getBounds();
                    if (clipRect) {
                        ctx.rect(clipRect.x, clipRect.y, clipRect.width, clipRect.height);
                    } else {
                        ctx.rect(rect.x, rect.y, rect.width, rect.height);
                    }
                    ctx.clip();
                };
                _SheetTabBase.prototype._calcTabSizeByFontSize = function (ctx) {
                    var self = this;
                    var workbook = self._workbook;
                    var isHorizontalTabs = self._isHorizontalTabs();
                    var tabSize;
                    ctx.save();
                    ctx.font = stylehelper_1._StyleHelper._setStringFont(ctx.font, 'bold');
                    self._tabSizes = [];
                    var i, sheetTabs = workbook._getSheetsAndSheetTabs();
                    for (i = 0; i < sheetTabs.length; i++) {
                        tabSize = Math.round(ctx.measureText(sheetTabs[i].name()).width) + self._tabRightPadding + self._tabLeftPadding;
                        self._tabSizes.push(tabSize);
                    }
                    if (!isHorizontalTabs) {
                        self._tabHeight = getFontHeight(ctx.font) + self._paddingTopAndBottom * 2;
                    }
                    ctx.restore();
                };
                // 生成选项卡信息
                _SheetTabBase.prototype._generateTabsInfo = function () {
                    var self = this;
                    var workbook = self._workbook;
                    var sheetTabs = workbook._getSheetsAndSheetTabs();
                    var isHorizontalTabs = self._isHorizontalTabs();
                    var rect = self._getBounds();
                    var tabsInfo = [];
                    var tabStartPosition = self._getTabStartPosition();
                    var newTabStartPosition = tabStartPosition;
                    var tabSize;
                    var firstTab = self._firstTab;
                    if (isHorizontalTabs && firstTab > 0 && self._getPreVisibleIndex(firstTab) >= 0) {
                        newTabStartPosition += self._firstTabSpace;
                    }
                    if (firstTab < 0) {
                        self._firstTab = 0;
                    }
                    for (var i = self._firstTab; i < sheetTabs.length; i++) {
                        var visible = sheetTabs[i].visible();
                        tabSize = self._tabSizes[i];
                        if (isHorizontalTabs) {
                            if (newTabStartPosition > rect.x + rect.width) {
                                break;
                            }
                        } else {
                            if (newTabStartPosition > rect.y + rect.height) {
                                break;
                            }
                        }
                        tabsInfo.push({
                            index: i,
                            position: newTabStartPosition,
                            width: tabSize,
                            text: sheetTabs[i].name(),
                            visible: visible
                        });
                        if (visible) {
                            if (isHorizontalTabs) {
                                newTabStartPosition += (tabSize + self._tabSpace);
                            } else {
                                newTabStartPosition += self._tabHeight;
                            }
                        }
                    }
                    return { tabsInfo: tabsInfo, newTabStartPosition: newTabStartPosition };
                };
                _SheetTabBase.prototype._paintTabs = function (ctx, clipRect) {
                    var self = this;
                    var sp = self._workbook;
                    var isMobileScrollbar = sp.options.scrollbarAppearance === core_enum_1.ScrollbarAppearance.mobile;
                    var tabStripPosition = sp.options.tabStripPosition;
                    var showHorizontalScrollbar = sp.options.showHorizontalScrollbar;
                    if (!ctx || !sp) {
                        return;
                    }
                    var rect = self._getBounds();
                    ctx.save();
                    setContextFont(ctx, self._font);
                    self._setTabStripClipRect(ctx, clipRect);
                    ctx.beginPath();
                    self._calcTabSizeByFontSize(ctx);
                    var _a = self._generateTabsInfo();
                    var tabsInfo = _a.tabsInfo;
                    var newTabStartPosition = _a.newTabStartPosition;
                    self._paintBackground(ctx, rect);
                    self._paintNewSheetTab(ctx, rect, newTabStartPosition);
                    self._paintTab(ctx, rect, tabsInfo);
                    if (self._workbook && self._workbook.options.tabNavigationVisible) {
                        self._paintNavigationButtons(ctx, rect);
                    }
                    if (showHorizontalScrollbar && !isMobileScrollbar && tabStripPosition === core_enum_1.TabStripPosition.bottom) {
                        self._paintResizeBar(ctx, rect);
                    }
                    ctx.beginPath();
                    ctx.restore();
                };
                _SheetTabBase.prototype._paintBackground = function (ctx, rect) { };
                _SheetTabBase.prototype._paintNewSheetTab = function (ctx, rect, newTabStartPosition) { };
                _SheetTabBase.prototype._setTabsClipRect = function (ctx, rect) {
                    var self = this;
                    var isHorizontalTabs = self._isHorizontalTabs();
                    var tabStartPosition = self._getTabStartPosition();
                    if (isHorizontalTabs) {
                        var maxNewTabPos = rect.x + self._getCoverPosition();
                        ctx.rect(tabStartPosition, 0, maxNewTabPos - tabStartPosition, rect.height);
                    } else {
                        var navigationButtonHeight = self._getNavigationButtonHeight();
                        ctx.rect(0, tabStartPosition, rect.width, rect.height - tabStartPosition - navigationButtonHeight);
                    }
                    ctx.clip();
                };
                _SheetTabBase.prototype._paintInactiveTabs = function (ctx, rect, tabsInfo) {
                    var self = this;
                    var workbook = self._workbook;
                    var isHorizontalTabs = self._isHorizontalTabs();
                    var activeIndex = self._activeIndex;
                    var hoverTab = self._hoverTab;
                    for (var i = tabsInfo.length - 1; i >= 0; i--) {
                        var tabInfo = tabsInfo[i];
                        if (tabInfo.index !== activeIndex && tabInfo.visible) {
                            var sheetSelectedState = workbook._getSheetOrSheetTabFromName(tabInfo.text)._isSelectedImp();
                            if (isHorizontalTabs) {
                                self._drawTab(ctx, tabInfo.position, 0, tabInfo.width, rect.height, tabInfo.index, false, tabInfo.index === hoverTab, tabInfo.text, sheetSelectedState);
                            } else {
                                self._drawTab(ctx, 0, tabInfo.position, rect.width, self._tabHeight, tabInfo.index, false, tabInfo.index === hoverTab, tabInfo.text, sheetSelectedState);
                            }
                        }
                    }
                };
                _SheetTabBase.prototype._paintActiveTab = function (ctx, rect, tabsInfo) {
                    var self = this;
                    var workbook = self._workbook;
                    var sheetTabs = workbook._getSheetsAndSheetTabs();
                    var isHorizontalTabs = self._isHorizontalTabs();
                    var activeIndex = self._activeIndex;
                    var firstTab = self._firstTab;
                    var activeTabInfo = tabsInfo[activeIndex - firstTab];
                    if (activeIndex >= firstTab && activeIndex < sheetTabs.length && activeTabInfo && activeTabInfo.visible) {
                        var sheet = workbook._getActiveSheetOrSheetTab();
                        if (sheet) {
                            var isSelected = sheet._isSelectedImp();
                            if (isHorizontalTabs) {
                                self._drawTab(ctx, activeTabInfo.position, 0, activeTabInfo.width, rect.height, activeIndex, true, false, activeTabInfo.text, isSelected);
                            } else {
                                self._drawTab(ctx, 0, activeTabInfo.position, rect.width, self._tabHeight, activeIndex, true, false, activeTabInfo.text, isSelected);
                            }
                        }
                    }
                };
                _SheetTabBase.prototype._paintHiddenTab = function (ctx, rect) {
                    var self = this;
                    var firstTab = self._firstTab;
                    var isHorizontalTabs = self._isHorizontalTabs();
                    var tabStartPosition = self._getTabStartPosition();
                    if (firstTab > 0 && self._getPreVisibleIndex(firstTab) >= 0 && isHorizontalTabs) {
                        self._paintTabBeforeFirstTab(ctx, rect, firstTab, tabStartPosition);
                    }
                };
                _SheetTabBase.prototype._paintTab = function (ctx, rect, tabsInfo) {
                    var self = this;
                    var workbook = self._workbook;
                    var sheetTabs = workbook._getSheetsAndSheetTabs();
                    self._activeIndex = workbook._getActiveSheetOrSheetTabIndex();
                    if (sheetTabs.length > 0) {
                        ctx.save();
                        ctx.beginPath();
                        self._setTabsClipRect(ctx, rect);
                        self._paintInactiveTabs(ctx, rect, tabsInfo);
                        self._paintActiveTab(ctx, rect, tabsInfo);
                        ctx.restore();
                        ctx.save();
                        ctx.beginPath();
                        self._paintHiddenTab(ctx, rect);
                        ctx.restore();
                    }
                };
                _SheetTabBase.prototype._paintTabBeforeFirstTab = function (ctx, rect, firstTab, tabStartPosition) { };
                _SheetTabBase.prototype._paintNavigationButtons = function (ctx, rect) { };
                _SheetTabBase.prototype._paintResizeBar = function (ctx, rect) { };
                _SheetTabBase.prototype._drawNavButton = function (ctx, x1, y1, x2, y2, x3, y3, direction, linePosition, highlight) { };
                _SheetTabBase.prototype._drawTab = function (ctx, x, y, width, height, tabIndex, isActive, isHover, text, isSelected) { };
                _SheetTabBase.prototype._getCanvas = function () {
                    return this._canvas;
                };
                _SheetTabBase.prototype._getTabStripBackColor = function (ctx, rect) {
                    var gradFill = ctx.createLinearGradient(rect.x, rect.y, rect.width, rect.height);
                    var headerStyle = common_1._ThemeStyleHelper._getVisualStateThemeStyle(core_enum_1.VisualState.normal, 'gc-tabStripBackground'), backgroundImg = headerStyle && headerStyle.backgroundImage, backgroundColor = headerStyle && headerStyle.backgroundColor;
                    if (backgroundImg && backgroundImg.indexOf('linear-gradient') !== -1) {
                        var colors = getLinearGradientColors(backgroundImg);
                        for (var i = 0, len = colors.length; i < len; i++) {
                            var color = colors[i];
                            gradFill.addColorStop(color.point, color.color);
                        }
                    } else if (backgroundColor) {
                        gradFill.addColorStop(0, '#DDDDDD');
                        gradFill.addColorStop(1, backgroundColor);
                    }
                    return gradFill;
                };
                _SheetTabBase.prototype._getTabBackColor = function (ctx, isActiveOrActive, text, externalThemeStyle, startPosition) {
                    var self = this;
                    var isHorizontalTabs = self._isHorizontalTabs();
                    var rect = self._getBounds();
                    var fillStyle;
                    if (isHorizontalTabs) {
                        fillStyle = ctx.createLinearGradient(rect.x + 0.7 * rect.height, rect.y + 0, 0.7 * rect.height, rect.height);
                    } else {
                        var y = rect.y, height = 0;
                        if (startPosition > 0) {
                            y = startPosition;
                            height = self._tabHeight;
                        }
                        fillStyle = ctx.createLinearGradient(rect.x + 0.7 * height, y, 0.7 * height, y + height);
                    }
                    var sheet = self._workbook._getSheetOrSheetTabFromName(text);
                    if (text === '' && self._firstTab > 0) {
                        sheet = self._workbook._getSheetOrSheetTab(self._firstTab - 1);
                    }
                    var options = sheet && sheet.options;
                    var sheetTabColor = options && options.sheetTabColor;
                    if (sheetTabColor) {
                        var transparentColor = 'rgba(0, 0, 0, 0)';
                        ctx.fillStyle = transparentColor;
                        var oldFillStyle = ctx.fillStyle;
                        ctx.fillStyle = common_1._ThemeContext._getColor(sheet, sheetTabColor);
                        var currentFillStyle = ctx.fillStyle;
                        if (currentFillStyle !== oldFillStyle) {
                            if (isActiveOrActive) {
                                fillStyle.addColorStop(0, color_white);
                                fillStyle.addColorStop(0.45, '#F1F6FD');
                                fillStyle.addColorStop(0.9, currentFillStyle);
                                fillStyle.addColorStop(1, color_white);
                            } else {
                                fillStyle = currentFillStyle;
                            }
                        }
                    } else if (externalThemeStyle) {
                        var backgroundImg = externalThemeStyle.backgroundImage, backgroundColor = externalThemeStyle.backgroundColor;
                        if (backgroundImg && backgroundImg.indexOf('linear-gradient') !== -1) {
                            var colors = getLinearGradientColors(backgroundImg);
                            for (var i = 0, len = colors.length; i < len; i++) {
                                var color = colors[i];
                                fillStyle.addColorStop(color.point, color.color);
                            }
                        } else if (backgroundColor) {
                            fillStyle.addColorStop(0, backgroundColor);
                        }
                    }
                    return fillStyle;
                };
                // 获取选项卡前景色
                _SheetTabBase.prototype._getTabForeColor = function (externalThemeStyle, solidBackColor) {
                    var foreColor = color_black;
                    if (externalThemeStyle) {
                        foreColor = externalThemeStyle.color;
                    }
                    if (solidBackColor && (_ColorHelper._getBrightness(_ColorHelper._fromString(solidBackColor)) < 255 / 2)) {
                        foreColor = color_white;
                    }
                    return foreColor;
                };
                return _SheetTabBase;
            }());
            exports._SheetTabBase = _SheetTabBase;
            common_1._defineFeature(_SheetTabBase);
        }),
        './dist/core/workbook/workbook-json.js': (function (module, exports, __webpack_require__) {
            Object.defineProperty(exports, '__esModule', { value: true });
            var workbook_1 = __webpack_require__(/*! ./workbook */ './dist/core/workbook/workbook.js');
            var style_1 = __webpack_require__(/*! ../worksheet/style */ './dist/core/worksheet/style.js');
            var domUtil_1 = __webpack_require__(/*! ../util/domUtil */ './dist/core/util/domUtil.js');
            var tasks_1 = __webpack_require__(/*! ../util/tasks */ './dist/core/util/tasks.js');
            var Common_1 = __webpack_require__(/*! Common */ 'Common');
            var common_1 = __webpack_require__(/*! ../util/common */ './dist/core/util/common.js');
            var CalcEngine = __webpack_require__(/*! CalcEngine */ 'CalcEngine');
            var _supportsCalc = !!CalcEngine;
            var ensureStyleParentName = style_1.Style._ensureParentName;
            var UndoManager = Common_1.Commands.UndoManager;
            var CultureManager = Common_1.Common.CultureManager;
            var cloneObj = Common_1.Common._Types._cloneObject;
            var _isNullOrUndefined = Common_1.Common._Types._isNullOrUndefined;
            var $_each = domUtil_1.GC$.each, isDefined = common_1._util._isDefined;
            var convertToFloat = parseFloat;
            function hasOwnProperty(obj, prop) {
                return obj.hasOwnProperty(prop);
            }
            function _getJsonDataVersion(version) {
                if (!version || typeof version !== 'string') {
                    return 1.0;
                }
                var versionInfo = version.split('.'), length = versionInfo.length;
                if (length > 3) {
                    return 3.0;
                }
                var mjaorVersion = convertToFloat(versionInfo[0]);
                if (length <= 2) {
                    if (isNaN(mjaorVersion)) {
                        return 1.0;
                    }
                    return mjaorVersion;
                }
                var yearVersion = convertToFloat(versionInfo[1]);
                if (mjaorVersion >= 10.0) {
                    return mjaorVersion;
                } else if (mjaorVersion >= 3.0) {
                    if (yearVersion >= 20143) {
                        return 3.0;
                    } else if (yearVersion >= 20142) {
                        return 2.0;
                    }
                }
                return 1.0;
            }
            function _processFrozenLinesAsHeaders(workbookData, deserializationOptions) {
                var self = this;
                var frozenColumnsAsRowHeaders = deserializationOptions && deserializationOptions.frozenColumnsAsRowHeaders;
                var frozenRowsAsColumnHeaders = deserializationOptions && deserializationOptions.frozenRowsAsColumnHeaders;
                var i = 0, sheet, sheets = workbookData.sheets;
                if ((frozenRowsAsColumnHeaders || frozenColumnsAsRowHeaders)) {
                    for (var s in sheets) {
                        if (typeof (s) === 'string') {
                            var sheetData = sheets[s];
                            var index = isDefined(sheetData.index) ? sheetData.index : sheetData._index;
                            sheet = self.sheets[isDefined(index) ? index : i];
                            if (frozenRowsAsColumnHeaders && isDefined(sheetData.frozenRowCount)) {
                                sheet._frozenRowsAsColumnHeadersFlag = true;
                                sheet.deleteRows(0, sheetData.frozenRowCount);
                            }
                            if (frozenColumnsAsRowHeaders && isDefined(sheetData.frozenColCount)) {
                                sheet.deleteColumns(0, sheetData.frozenColCount);
                            }
                            i++;
                        }
                    }
                }
            }
            function sheetTabCountFromJSON(workbook, workbookData) {
                var sheetTabCount = workbookData.sheetTabCount;
                if (isDefined(sheetTabCount)) {
                    workbook._setSheetTabCountImp(sheetTabCount, 0);
                }
            }
            function sheetTabsFromJSON(workbook, workbookData, versionInfo, deserializationOptions) {
                var sheetTabIndex = 0, sheetTabs = workbookData.sheetTabs;
                if (sheetTabs) {
                    for (var tabName in sheetTabs) {
                        if (typeof (tabName) === 'string') {
                            var sheetTabData = sheetTabs[tabName];
                            var sheetTab = workbook._sheetTabs[sheetTabIndex];
                            sheetTab.fromJSON(sheetTabData, false, versionInfo, deserializationOptions, true);
                            sheetTabIndex++;
                        }
                    }
                }
            }
            function sheetTabIndexFromJSON(workbook, workbookData) {
                var activeSheetTabIndex = workbookData.activeSheetTabIndex;
                if (isDefined(activeSheetTabIndex)) {
                    workbook._setActiveSheetTabIndexImp(activeSheetTabIndex, 0);
                    var activeSheetTab = workbook._sheetTabs[activeSheetTabIndex];
                    activeSheetTab && activeSheetTab._isSelectedImp(true, false);
                }
            }
            workbook_1.Workbook.prototype.toJSON = function (serializationOption) {
                var toJsonSpread = this;
                var sdata = {
                    version: common_1.productInfo.productVersion
                };
                var setlanguagepackage, oldLanguage;
                var rowHeadersAsFrozenColumns = serializationOption && serializationOption.rowHeadersAsFrozenColumns;
                var columnHeadersAsFrozenRows = serializationOption && serializationOption.columnHeadersAsFrozenRows;
                var needCloneSpread = rowHeadersAsFrozenColumns || columnHeadersAsFrozenRows;
                if (needCloneSpread) {
                    serializationOption._fromWorkbook = true;
                }
                if (toJsonSpread._docProps) {
                    sdata.docProps = cloneObj(toJsonSpread._docProps);
                }
                if (_supportsCalc) {
                    setlanguagepackage = CalcEngine.Functions.setLanguagepackage;
                    if (setlanguagepackage) {
                        oldLanguage = setlanguagepackage();
                        setlanguagepackage('en');
                    }
                }
                var sheetCount = toJsonSpread.getSheetCount();
                if (sheetCount !== workbook_1.Workbook._defaultSheetCount) {
                    sdata.sheetCount = sheetCount;
                }
                if (needCloneSpread) {
                    var cloneSpread = new workbook_1.Workbook();
                    var includeAutoMergedCells = serializationOption && serializationOption.includeAutoMergedCells;
                    cloneSpread.fromJSON(toJsonSpread.toJSON({ includeBindingSource: true, includeAutoMergedCells: includeAutoMergedCells }));
                    toJsonSpread = cloneSpread;
                    for (var sheetIndex = 0; sheetIndex < sheetCount; sheetIndex++) {
                        var sheet = toJsonSpread.getSheet(sheetIndex);
                        var rowShift = sheet.getRowCount(1);
                        var columnShift = sheet.getColumnCount(2);
                        var colExpand = rowHeadersAsFrozenColumns && columnShift > 0;
                        var rowExpand = columnHeadersAsFrozenRows && rowShift > 0;
                        if (colExpand) {
                            sheet.addColumns(0, columnShift);
                        }
                        if (rowExpand) {
                            sheet.addRows(0, rowShift, rowExpand);
                        }
                        if (colExpand) {
                            sheet._moveRowHeadersAsFrozenColumns(columnShift, rowExpand ? rowShift : 0);
                        }
                        if (rowExpand) {
                            sheet._moveColumnHeadersAsFrozenRows(rowShift, colExpand ? columnShift : 0);
                        }
                    }
                }
                toJsonSpread._suspendSetFocus = true;
                toJsonSpread.suspendPaint();
                toJsonSpread.suspendEvent();
                if (_supportsCalc) {
                    var calcService = toJsonSpread._calcService;
                    if (calcService.calcOnDemand) {
                        calcService.calcOnDemand = false;
                        toJsonSpread._onDisableCalcOnDemand();
                        calcService.suspend(true);
                        calcService.resume(true);
                        calcService.calcOnDemand = true;
                    }
                    calcService.suspend(true);
                }
                var startSheetIndex = toJsonSpread.startSheetIndex();
                if (startSheetIndex) {
                    sdata.startSheetIndex = startSheetIndex;
                }
                $_each(toJsonSpread.options, function (i, p) {
                    if (i !== '_ps' && workbook_1.Workbook._defaultOptions[i] !== p) {
                        sdata[i] = p;
                    }
                });
                var activeSheetIndex = toJsonSpread.getActiveSheetIndex();
                if (activeSheetIndex !== workbook_1.Workbook._defaultActiveSheetIndex) {
                    sdata.activeSheetIndex = activeSheetIndex;
                }
                var sheets = {};
                for (var j = 0; j < sheetCount; j++) {
                    var sheet = toJsonSpread.getSheet(j);
                    sheets[sheet.name()] = sheet.toJSON(serializationOption);
                    sheets[sheet.name()].index = j;
                }
                if (!domUtil_1.GC$.isEmptyObject(sheets)) {
                    sdata.sheets = sheets;
                }
                var sheetTabCount = toJsonSpread.getSheetTabCount();
                if (sheetTabCount !== 0) {
                    sdata.sheetTabCount = sheetTabCount;
                }
                var activeSheetTabIndex = toJsonSpread.getActiveSheetTabIndex();
                if (activeSheetTabIndex !== -1) {
                    sdata.activeSheetTabIndex = activeSheetTabIndex;
                }
                var sheetTabs = {};
                for (var k = 0; k < sheetTabCount; k++) {
                    var sheetTab = toJsonSpread.getSheetTab(k);
                    sheetTabs[sheetTab.name()] = sheetTab.toJSON(serializationOption);
                    sheetTabs[sheetTab.name()].index = sheetCount + k;
                }
                if (!domUtil_1.GC$.isEmptyObject(sheetTabs)) {
                    sdata.sheetTabs = sheetTabs;
                }
                var namedStyles = [], workbookNamedStyles = toJsonSpread._namedStyles;
                if (workbookNamedStyles) {
                    for (var namedStyle in workbookNamedStyles) {
                        if (hasOwnProperty(workbookNamedStyles, namedStyle)) {
                            namedStyles.push(workbookNamedStyles[namedStyle]);
                        }
                    }
                    if (namedStyles.length > 0) {
                        sdata.namedStyles = namedStyles;
                    }
                }
                if (workbook_1.Workbook._features) {
                    $_each(workbook_1.Workbook._features, function (n, f) {
                        if (f.toJson) {
                            f.toJson.call(toJsonSpread, sdata, serializationOption);
                        }
                    });
                }
                if (_supportsCalc && setlanguagepackage) {
                    setlanguagepackage(oldLanguage);
                }
                toJsonSpread._suspendSetFocus = false;
                _supportsCalc && toJsonSpread._calcService.resume(false);
                toJsonSpread.resumeEvent();
                toJsonSpread.resumePaint();
                if (needCloneSpread) {
                    delete serializationOption._fromWorkbook;
                }
                return sdata;
            };
            workbook_1.Workbook.prototype.fromJSON = function (workbookData, deserializationOptions) {
                var self = this;
                self._disposeDialog();
                if (!workbookData) {
                    return;
                }
                if (deserializationOptions && deserializationOptions.incrementalLoading) {
                    if (deserializationOptions.incrementalLoading === true) {
                        deserializationOptions.incrementalLoading = {};
                    }
                    return self._fromJSONAsync(workbookData, deserializationOptions);
                }
                var jsonVersion = _getJsonDataVersion(workbookData.version);
                var noSchema = jsonVersion < 3.0;
                var versionInfo = { noSchema: noSchema, version: jsonVersion };
                var oldActiveElement = common_1._FocusHelper._getActiveElement();
                self._suspendSetFocus = true;
                self.suspendPaint();
                self.suspendEvent();
                var oldCulture = CultureManager.culture();
                CultureManager.culture('');
                try {
                    self._initOptions();
                    self._undoManager = new UndoManager(self, -1, self.options.allowUndo);
                    _supportsCalc && self._initCalcService(true);
                    _supportsCalc && self._calcService.suspendAdjust();
                    self._availableSheetIndex = -1;
                    self.clearSheets();
                    self.clearSheetTabs();
                    var options = self.options;
                    var workbookData_canUserEditFormula = workbookData.canUserEditFormula;
                    if (isDefined(workbookData_canUserEditFormula)) {
                        options.allowUserEditFormula = workbookData_canUserEditFormula;
                    }
                    var workbookData_allowDragDrop = workbookData.allowDragDrop;
                    if (isDefined(workbookData_allowDragDrop)) {
                        options.allowUserDragDrop = workbookData_allowDragDrop;
                    }
                    var workbookData_allowDragFill = workbookData.allowDragFill;
                    if (isDefined(workbookData_allowDragFill)) {
                        options.allowUserDragFill = workbookData_allowDragFill;
                    }
                    for (var op in options) {
                        if (hasOwnProperty(options, op)) {
                            var value = workbookData[op];
                            if (isDefined(value)) {
                                options[op] = value;
                            }
                        }
                    }
                    self._docProps = cloneObj(workbookData.docProps);
                    _callFeatures(self, 'preFromJson', [workbookData, noSchema, deserializationOptions]);
                    var sheetCount = workbookData.sheetCount;
                    if (!isDefined(sheetCount)) {
                        sheetCount = workbook_1.Workbook._defaultSheetCount;
                    }
                    self._setSheetCountImp(sheetCount, 0);
                    self._namedStyles = {};
                    self._pivotTableNameSet = {};
                    var workbookData_namedStyles = workbookData.namedStyles;
                    if (workbookData_namedStyles) {
                        for (var _i = 0, workbookData_namedStyles_1 = workbookData_namedStyles; _i < workbookData_namedStyles_1.length; _i++) {
                            var item = workbookData_namedStyles_1[_i];
                            var style = new style_1.Style();
                            ensureStyleParentName(item, self);
                            style.fromJSON(item, noSchema, self);
                            self._addNamedStyleImp(style);
                        }
                    }
                    var i = 0;
                    var sheet = void 0;
                    var sheets = workbookData.sheets;
                    var allowUndo = void 0;
                    var sheetData_allowUndo = void 0;
                    var allowUndoHasValue = false;
                    var allowUndoAreEqual = true;
                    if (sheets) {
                        for (var s in sheets) {
                            if (typeof (s) === 'string') {
                                var sheetData = sheets[s];
                                var index = isDefined(sheetData.index) ? sheetData.index : sheetData._index;
                                sheet = self.sheets[isDefined(index) ? index : i];
                                sheet.fromJSON(sheetData, false, versionInfo, deserializationOptions, true);
                                i++;
                                sheetData_allowUndo = sheetData.allowUndo;
                                if (!allowUndoHasValue) {
                                    allowUndo = sheetData_allowUndo;
                                    allowUndoHasValue = true;
                                } else {
                                    allowUndoAreEqual = allowUndoAreEqual && (sheetData_allowUndo === allowUndo);
                                }
                            }
                        }
                    }
                    if (isDefined(allowUndo) && allowUndoAreEqual) {
                        options.allowUndo = allowUndo;
                    }
                    var activeSheetIndex = workbookData.activeSheetIndex;
                    if (!isDefined(activeSheetIndex)) {
                        activeSheetIndex = workbook_1.Workbook._defaultActiveSheetIndex;
                    }
                    self._setActiveSheetIndexImp(activeSheetIndex, 0);
                    var activeSheet = self.sheets[activeSheetIndex];
                    activeSheet && activeSheet._isSelectedImp(true, false);
                    sheetTabCountFromJSON(self, workbookData);
                    sheetTabsFromJSON(self, workbookData, versionInfo, deserializationOptions);
                    sheetTabIndexFromJSON(self, workbookData);
                    var workbookData_startSheetIndex = workbookData.startSheetIndex;
                    if (isDefined(workbookData_startSheetIndex)) {
                        self.startSheetIndex(workbookData_startSheetIndex);
                    }
                    if (workbook_1.Workbook._features) {
                        $_each(workbook_1.Workbook._features, function (n, f) {
                            var t = f.fromJson;
                            if (t) {
                                t.call(self, workbookData, noSchema, deserializationOptions);
                            }
                        });
                    }
                    _supportsCalc && self._calcService.resumeAdjust();
                    _processFrozenLinesAsHeaders.call(self, workbookData, deserializationOptions);
                    workbook_1.Workbook._callFeatureHandler(self, 'initCustomName');
                } finally {
                    _supportsCalc && self._calcService.resumeAdjust();
                    CultureManager.culture(oldCulture);
                    self._suspendSetFocus = false;
                    var activeSheet = self.getActiveSheet();
                    if (oldActiveElement && activeSheet) {
                        activeSheet._setFocus();
                    }
                    self.resumeEvent();
                    self._doResize();
                    self.resumePaint();
                    if (activeSheet) {
                        self._trigger(common_1.Events.FormulatextboxActiveSheetChanged, {
                            oldSheet: undefined,
                            newSheet: activeSheet
                        });
                    }
                }
            };
            function _callFeatures(target, fn, eventArgs) {
                if (workbook_1.Workbook._features) {
                    $_each(workbook_1.Workbook._features, function (n, f) {
                        var t = f[fn];
                        if (t) {
                            t.call.apply(t, [target].concat(eventArgs));
                        }
                    });
                }
            }
            workbook_1.Workbook.prototype._fromJSONAsync = function (workbookData, deserializationOptions) {
                var self = this;
                self._tasks && self._tasks.terminate();
                self._tasks = new tasks_1.Tasks(function () {
                    var sheet = self.getActiveSheet();
                    if (!sheet.loaded) {
                        for (var i = this.tasks.length - 1; i >= 0; i--) {
                            var tmpSheet = this.tasks[i].args[0];
                            if (tmpSheet && tmpSheet._modelManager && tmpSheet.name && tmpSheet.name() === sheet.name()) {
                                var t = this.tasks[i];
                                this.tasks.splice(i, 1);
                                return t;
                            }
                        }
                    }
                    return this.tasks.pop();
                }, function () {
                    var sheet = self.getActiveSheet();
                    return sheet && (self._scrollService._scrolling || sheet.isEditing() || sheet._eventHandler._isWorking || sheet._eventHandler._isSelecting || sheet._eventHandler._isMouseDown);
                });
                var jsonVersion = _getJsonDataVersion(workbookData.version);
                var noSchema = jsonVersion < 3.0;
                var versionInfo = { noSchema: noSchema, version: jsonVersion };
                var oldActiveElement = common_1._FocusHelper._getActiveElement();
                self._suspendSetFocus = true;
                self.suspendPaint();
                self.suspendEvent();
                var oldCulture = CultureManager.culture();
                CultureManager.culture('');
                try {
                    self._initOptions();
                    self._undoManager = new UndoManager(self, -1, self.options.allowUndo);
                    _supportsCalc && self._initCalcService(true);
                    _supportsCalc && self._calcService.suspendAdjust();
                    self._availableSheetIndex = -1;
                    self.clearSheets();
                    self.clearSheetTabs();
                    var options = self.options;
                    var workbookData_canUserEditFormula = workbookData.canUserEditFormula;
                    if (isDefined(workbookData_canUserEditFormula)) {
                        options.allowUserEditFormula = workbookData_canUserEditFormula;
                    }
                    var workbookData_allowDragDrop = workbookData.allowDragDrop;
                    if (isDefined(workbookData_allowDragDrop)) {
                        options.allowUserDragDrop = workbookData_allowDragDrop;
                    }
                    var workbookData_allowDragFill = workbookData.allowDragFill;
                    if (isDefined(workbookData_allowDragFill)) {
                        options.allowUserDragFill = workbookData_allowDragFill;
                    }
                    for (var op in options) {
                        if (hasOwnProperty(options, op)) {
                            var value = workbookData[op];
                            if (isDefined(value)) {
                                options[op] = value;
                            }
                        }
                    }
                    self._docProps = cloneObj(workbookData.docProps);
                    _callFeatures(self, 'preFromJson', [workbookData, noSchema, deserializationOptions]);
                    var sheetCount = workbookData.sheetCount;
                    if (!isDefined(sheetCount)) {
                        sheetCount = workbook_1.Workbook._defaultSheetCount;
                    }
                    self._setSheetCountImp(sheetCount, 0);
                    self._namedStyles = {};
                    var workbookData_namedStyles = workbookData.namedStyles;
                    if (workbookData_namedStyles) {
                        for (var ns_index = 0; ns_index < workbookData_namedStyles.length; ns_index++) {
                            var item = workbookData_namedStyles[ns_index];
                            var style = new style_1.Style();
                            ensureStyleParentName(item, self);
                            style.fromJSON(item, noSchema, self);
                            self._addNamedStyleImp(style);
                        }
                    }
                    var i = 0;
                    var sheet_1;
                    var sheets = workbookData.sheets;
                    var allowUndo = void 0;
                    var sheetData_allowUndo = void 0;
                    var allowUndoHasValue = false;
                    var allowUndoAreEqual = true;
                    if (sheets) {
                        var loadStatus = {
                            total: 0,
                            valuesLoad: 0,
                            formulaLoad: 0
                        };
                        i = 0;
                        deserializationOptions.incrementLoadTask = self._tasks;
                        deserializationOptions.incrementalLoading.loadStatus = loadStatus;
                        for (var s in sheets) {
                            if (typeof (s) === 'string') {
                                var sheetData = sheets[s];
                                var index = isDefined(sheetData.index) ? sheetData.index : sheetData._index;
                                sheet_1 = self.sheets[isDefined(index) ? index : i];
                                sheet_1.loading = true;
                                sheet_1._setNameCore(sheetData.name + '', true);
                                sheet_1._isSelectedImp(sheetData.isSelected);
                                sheet_1.setRowCount(sheetData.rowCount);
                                sheet_1.setColumnCount(sheetData.columnCount);
                                if (isDefined(sheetData.visible)) {
                                    sheet_1.visible(sheetData.visible);
                                }
                                loadStatus.total += sheet_1.getRowCount();
                                self._tasks.addTask(function (_sheet, sheetJson) {
                                    _sheet._fromJSONAsync(sheetJson, false, versionInfo, deserializationOptions, true);
                                }, [sheet_1, sheetData]);
                                i++;
                                sheetData_allowUndo = sheetData.allowUndo;
                                if (!allowUndoHasValue) {
                                    allowUndo = sheetData_allowUndo;
                                    allowUndoHasValue = true;
                                } else {
                                    allowUndoAreEqual = allowUndoAreEqual && (sheetData_allowUndo === allowUndo);
                                }
                            }
                        }
                    }
                    if (isDefined(allowUndo) && allowUndoAreEqual) {
                        options.allowUndo = allowUndo;
                    }
                    var activeSheetIndex = workbookData.activeSheetIndex;
                    if (!isDefined(activeSheetIndex)) {
                        activeSheetIndex = workbook_1.Workbook._defaultActiveSheetIndex;
                    }
                    self._setActiveSheetIndexImp(activeSheetIndex, 0);
                    var activeSheet = self.sheets[activeSheetIndex];
                    activeSheet && activeSheet._isSelectedImp(true, false);
                    sheetTabCountFromJSON(self, workbookData);
                    sheetTabsFromJSON(self, workbookData, versionInfo, deserializationOptions);
                    sheetTabIndexFromJSON(self, workbookData);
                    var workbookData_startSheetIndex = workbookData.startSheetIndex;
                    if (isDefined(workbookData_startSheetIndex)) {
                        self.startSheetIndex(workbookData_startSheetIndex);
                    }
                    self._tasks.endingCallback = function () {
                        if (workbook_1.Workbook._features) {
                            $_each(workbook_1.Workbook._features, function (n, f) {
                                if (f._fromJSONAsync) {
                                    self._tasks.addTask(function (workbook, _workbookData, _noSchema, _deserializationOptions) {
                                        f._fromJSONAsync.call(workbook, _workbookData, _noSchema, _deserializationOptions);
                                    }, [
                                        self,
                                        workbookData,
                                        noSchema,
                                        deserializationOptions
                                    ]);
                                } else if (f.fromJson) {
                                    f.fromJson.call(self, workbookData, noSchema, deserializationOptions);
                                }
                            });
                        }
                        self._tasks.endingCallback = function () {
                            _supportsCalc && self._calcService.resumeAdjust();
                            _processFrozenLinesAsHeaders.call(self, workbookData, deserializationOptions);
                            workbook_1.Workbook._callFeatureHandler(self, 'initCustomName');
                            for (var j = 0; j < self.sheets.length; j++) {
                                delete self.sheets[j].loading;
                            }
                            sheet_1 = self.getActiveSheet();
                            if (sheet_1) {
                                self._trigger(common_1.Events.FormulatextboxActiveSheetChanged, {
                                    oldSheet: undefined,
                                    newSheet: sheet_1
                                });
                            }
                            if (deserializationOptions && deserializationOptions.incrementalLoading && deserializationOptions.incrementalLoading.loading) {
                                deserializationOptions.incrementalLoading.loading(1, { sheet: sheet_1 });
                            }
                            var callback = deserializationOptions && deserializationOptions.incrementalLoading && deserializationOptions.incrementalLoading.loaded;
                            callback && callback();
                            if (sheet_1) {
                                sheet_1.repaint();
                            }
                            self._tasks.endingCallback = undefined;
                        };
                        self._tasks.start();
                    };
                    self._tasks.start();
                } finally {
                    CultureManager.culture(oldCulture);
                    self._suspendSetFocus = false;
                    var activeSheet = self.getActiveSheet();
                    if (oldActiveElement && activeSheet) {
                        activeSheet._setFocus();
                    }
                    self.resumeEvent();
                    self._doResize();
                    self.resumePaint();
                }
            };
        }),
        './dist/core/workbook/workbook.js': (function (module, exports, __webpack_require__) {
            Object.defineProperty(exports, '__esModule', { value: true });
            var workbookpanelex_1 = __webpack_require__(/*! ./workbookpanelex */ './dist/core/workbook/workbookpanelex.js');
            var core_ns_1 = __webpack_require__(/*! ../core.ns */ './dist/core/core.ns.js');
            var Common_1 = __webpack_require__(/*! Common */ 'Common');
            var domUtil_1 = __webpack_require__(/*! ../util/domUtil */ './dist/core/util/domUtil.js');
            var common_1 = __webpack_require__(/*! ../util/common */ './dist/core/util/common.js');
            var imageLoader_1 = __webpack_require__(/*! ../util/imageLoader */ './dist/core/util/imageLoader.js');
            var worksheet_actions_1 = __webpack_require__(/*! ../worksheet/worksheet-actions */ './dist/core/worksheet/worksheet-actions.js');
            var sheettab_1 = __webpack_require__(/*! ./sheettab */ './dist/core/workbook/sheettab.js');
            var sheettab2007_1 = __webpack_require__(/*! ./sheettab2007 */ './dist/core/workbook/sheettab2007.js');
            var stylehelper_1 = __webpack_require__(/*! ../worksheet/stylehelper */ './dist/core/worksheet/stylehelper.js');
            var clipboardhelper_1 = __webpack_require__(/*! ../worksheet/clipboardhelper */ './dist/core/worksheet/clipboardhelper.js');
            var worksheet_1 = __webpack_require__(/*! ../worksheet/worksheet */ './dist/core/worksheet/worksheet.js');
            var CalcEngine = __webpack_require__(/*! CalcEngine */ 'CalcEngine');
            var _supportsCalc = !!CalcEngine;
            var core_enum_1 = __webpack_require__(/*! ../core.enum */ './dist/core/core.enum.js');
            var StringHelper = Common_1.Common._StringHelper;
            var UndoManager = Common_1.Commands.UndoManager;
            var CommandManager = Common_1.Commands.CommandManager;
            var $$_each = domUtil_1.GC$.each, $$_extend = domUtil_1.GC$.extend;
            var hasCalc = _supportsCalc;
            var isNullOrUndefined = Common_1.Common._Types._isNullOrUndefined;
            var createElement = common_1._util._createElement;
            var defProperty = common_1._util._defProperty;
            var createOptions = common_1._util._createOptions;
            var adjustFontWithFallback = common_1._util._adjustFontWithFallback;
            var CultureManager = Common_1.Common.CultureManager;
            var convertToInt = parseInt;
            var WINDOW = window;
            var DOCUMENT = document;
            var keyword_null = null;
            var Math_round = Math.round;
            var Math_min = Math.min;
            var Math_floor = Math.floor;
            var Math_abs = Math.abs;
            var CONST_NUMBER = 'number';
            var E_MOUSEDOWN = 'mousedown';
            var E_MOUSEMOVE = 'mousemove';
            var E_MOUSEUP = 'mouseup';
            var E_MOUSEENTER = 'mouseenter';
            var E_MOUSELEAVE = 'mouseleave';
            var E_SCROLL = 'scroll';
            var E_RESIZE = 'resize';
            var E_FOCUS = 'focus';
            var NS_SPREAD = '.gcSpread';
            var NS_SPREADINTERNAL = '.gcSpreadInternal';
            var NS_SCROLLBAR = '.gcScrollbar';
            var TAG_SPAN = 'span';
            var TAG_DIV = 'div';
            var TAG_TABLE = 'table';
            var PIXEL = 'px';
            var CSS_HUNDRED_PERCENT = '100%';
            var CSS_SCROLL_HANDLE = 'gc-scroll-handle';
            var CSS_SCROLLBAR = 'gc-scroll-bar';
            var CSS_NONE = 'none';
            var CSS_DISPLAY = 'display';
            var CSS_BLOCK = 'block';
            var CSS_ABSOLUTE = 'absolute';
            var CSS_CONTENT_BOX = 'content-box';
            var CSS_SOLID = 'solid';
            var SCROLLBAR_PART_CLASS = ' ui-widget-header ui-state-default btn btn-default';
            var CSS_CLASS_SCROLLBAR_MOBILE_CONTAINER = 'gc-scroll-mobile-container';
            var CSS_CLASS_SCROLLBAR_MOBILE_HORIZONTAL = 'gc-scroll-mobile-container-horizontal';
            var CSS_CLASS_SCROLLBAR_MOBILE_VERTICAL = 'gc-scroll-mobile-container-vertical';
            var CSS_CLASS_SCROLLBAR_MOBILE_HOST_HOVERING = 'gc-scroll-mobile-spread-hovering';
            var CSS_CLASS_SCROLLBAR_STATE_HIDE = 'gc-scroll-mobile-state-hide';
            var CSS_CLASS_SCROLLBAR_STATE_HOVER = 'gc-scroll-mobile-state-hover';
            var $ = WINDOW.jQuery;
            var CULTURE_CHANGED_EVENT = 'cultureChanged';
            var STORE_KEY = 'workbook';
            var GC_UIELEMENT = 'gcUIElement';
            var NO_USER_SELECT = 'gc-no-user-select';
            var VISIBLE = 'visible';
            var OVERFLOW = 'overflow';
            var EN_CULTURE = 'en-US';
            var DEFAULT_TAB_STRIP_WIDTH = 80;
            var FROZEN_LINE_WIDTH = 1;
            var rm = new Common_1.Common.ResourceManager(core_ns_1.SR, 'Sheets');
            var getSR = rm.getResource.bind(rm);
            function getActiveSheet(workbook) {
                return workbook.getActiveSheet();
            }
            // 滚动后需要重新绘制
            function needRepaintAfterScroll(sheet, partialRowOrColumnScroll) {
                return (common_1._DPIHelper._getDevicePixel() % 1 !== 0) ||
                    (sheet.zoom() % 1 !== 0) ||
                    (sheet.parent && sheet.parent.options.scrollByPixel && partialRowOrColumnScroll && sheet._autoMergeManager && sheet._autoMergeManager._inAutoMergeArea(common_1._createRange(sheet._scrollTopRow, sheet._scrollLeftCol, 1, 1)));
            }
            function _createTimer(sheet, context) {
                return WINDOW.setTimeout(function () {
                    sheet.invalidateLayout();
                    sheet.repaint();
                    context._timer = keyword_null;
                    var rect = sheet._getBounds();
                    context._cleanFrozenRowSelectionBorder(sheet, rect.x, rect.width);
                    context._cleanFrozenColSelectionBorder(sheet, rect.y, rect.height);
                }, 200);
            }
            function triggerActiveSheetChanged(spread, oldSheet, newSheet) {
                spread._trigger(common_1.Events.ActiveSheetChanged, {
                    oldSheet: oldSheet,
                    newSheet: newSheet
                });
            }
            function triggerActiveSheetChanging(spread, data) {
                spread._trigger(common_1.Events.ActiveSheetChanging, data);
            }
            // 触发公式文本框活动工作表更改
            function triggerFormulatexgboxActiveSheetChanging(spread, data) {
                spread._trigger(common_1.Events.FormulatextboxActiveSheetChanging, data);
            }
            function triggerFormulatextboxActiveSheetChanged(spread, oldSheet, newSheet) {
                spread._trigger(common_1.Events.FormulatextboxActiveSheetChanged, {
                    oldSheet: oldSheet,
                    newSheet: newSheet
                });
            }
            function strip(num, precision) {
                if (precision === void 0) { precision = 12; }
                return +parseFloat(num.toPrecision(precision));
            }
            var VSCROLLTOOLTIP_LEFT = 100;
            var HSCROLLTOOLTIP_LEFT = 30;
            var HSCROLLTOOLTIP_TOP = 40;
            var ScrollService = (function () {
                function ScrollService(workbook) {
                    this._wb = workbook;
                }
                ScrollService._hscrollDelegate = function (e, data) {
                    var hostWorkbook = e.data;
                    var scrollService = hostWorkbook._scrollService;
                    if (scrollService._scrollbarTimer) {
                        WINDOW.clearTimeout(scrollService._scrollbarTimer);
                        scrollService._scrollbarTimer = keyword_null;
                    }
                    var sheet = hostWorkbook._getActiveSheetOrSheetTab();
                    if (sheet && data) {
                        sheet._onHorizontalScroll(hostWorkbook, data);
                    }
                };
                ScrollService._hScrollStop = function (e) {
                    var hostWorkbook = e.data;
                    var sheetTab = hostWorkbook._getActiveSheetOrSheetTab();
                    if (sheetTab) {
                        sheetTab._onHorizontalScrollStop(hostWorkbook);
                    }
                };
                ScrollService._hScrollMouseDown = function (e) {
                    var hostWorkbook = e.data;
                    if (hostWorkbook) {
                        var sheet = getActiveSheet(hostWorkbook);
                        if (sheet) {
                            var touchHelper = hostWorkbook._hScrollbar._simulateMouseEvents;
                            if (touchHelper && touchHelper._touchHandled) {
                                sheet._isTouchMode = true;
                            }
                            sheet._setFocus();
                            var showScrollTip = hostWorkbook.options.showScrollTip;
                            if (showScrollTip === 1 || showScrollTip === 3) {
                                var ele = domUtil_1.GC$(e.srcElement || e.target);
                                var parent_1 = ele.parent();
                                if (ele && (ele.hasClass(CSS_SCROLL_HANDLE) || ele.hasClass(CSS_SCROLLBAR)) || parent_1 && (parent_1.hasClass(CSS_SCROLL_HANDLE) || parent_1.hasClass(CSS_SCROLLBAR))) {
                                    hostWorkbook._scrollService._showScrollTooltip(false, e);
                                }
                            }
                        } else {
                            var sheetTab = hostWorkbook.getActiveSheetTab();
                            sheetTab._setFocus();
                        }
                    }
                };
                ScrollService._vscrollDelegate = function (e, data) {
                    var hostWorkbook = e.data;
                    var scrollService = hostWorkbook._scrollService;
                    if (scrollService._scrollbarTimer) {
                        WINDOW.clearTimeout(scrollService._scrollbarTimer);
                        scrollService._scrollbarTimer = keyword_null;
                    }
                    var sheet = hostWorkbook._getActiveSheetOrSheetTab();
                    if (sheet && data) {
                        sheet._onVerticalScroll(hostWorkbook, data);
                    }
                };
                ScrollService._vScrollStop = function (e) {
                    var hostWorkbook = e.data;
                    var sheetTab = hostWorkbook._getActiveSheetOrSheetTab();
                    if (sheetTab) {
                        sheetTab._onVerticalScrollStop(hostWorkbook);
                    }
                };
                ScrollService._vScrollMouseDown = function (e) {
                    var hostWorkbook = e.data;
                    if (hostWorkbook) {
                        var sheet = getActiveSheet(hostWorkbook);
                        if (sheet) {
                            var touchHelper = hostWorkbook._vScrollbar._simulateMouseEvents;
                            if (touchHelper && touchHelper._touchHandled) {
                                sheet._isTouchMode = true;
                            }
                            sheet._setFocus();
                            var showScrollTip = hostWorkbook.options.showScrollTip;
                            if (showScrollTip === 2 || showScrollTip === 3) {
                                var ele = domUtil_1.GC$(e.srcElement || e.target);
                                if (ele) {
                                    var parent_2 = ele.parent();
                                    if (ele.hasClass(CSS_SCROLL_HANDLE) || parent_2 && parent_2.hasClass(CSS_SCROLL_HANDLE) ||
                                        ele.hasClass(CSS_SCROLLBAR) || parent_2 && parent_2.hasClass(CSS_SCROLLBAR)) {
                                        hostWorkbook._scrollService._showScrollTooltip(true, e);
                                    }
                                }
                            }
                        } else {
                            var sheetTab = hostWorkbook.getActiveSheetTab();
                            if (sheetTab) {
                                sheetTab._setFocus();
                            }
                        }
                    }
                };
                ScrollService._scrollMouseUp = function (e) {
                    var hostWorkbook = e.data;
                    if (hostWorkbook) {
                        hostWorkbook._removeTooltip();
                    }
                };
                ScrollService._scrollMouseMove = function (e) {
                    var resource = getSR();
                    var hostWorkbook = e.data;
                    var scrollbar = e.scrollbar;
                    if (hostWorkbook.options.enableAccessibility) {
                        var scrollbarOffset = domUtil_1.GC$(scrollbar._getScrollbar()).offset();
                        var info = scrollbar.hitTest(e.x - scrollbarOffset.left, e.y - scrollbarOffset.top);
                        var dict = {
                            thumbButton: resource.ARIA_Scrollbar_Thumb_Button,
                            trackButton: resource.ARIA_Scrollbar_TRACK_Button,
                            leftButton: resource.ARIA_Scrollbar_Left_Button,
                            rightButton: resource.ARIA_Scrollbar_Right_Button,
                            upButton: resource.ARIA_Scrollbar_Top_Button,
                            downButton: resource.ARIA_Scrollbar_Bottom_Button
                        };
                        var content = dict[info.element];
                        hostWorkbook._updateAccessibilityContent(content);
                    }
                };
                ScrollService.prototype._dispose = function () {
                    this._wb = keyword_null;
                };
                ScrollService.prototype._doScroll = function (sheet, newIndex, newOffset, isHorizontal) {
                    var self = this;
                    if (sheet) {
                        self._scrolling = true;
                        self._newTop = isHorizontal ? sheet._scrollTopRow : newIndex;
                        self._newTopOffset = isHorizontal ? sheet._scrollTopRowOffset : newOffset;
                        self._newLeft = isHorizontal ? newIndex : sheet._scrollLeftCol;
                        self._newLeftOffset = isHorizontal ? newOffset : sheet._scrollLeftColOffset;
                        WINDOW.setTimeout(function () {
                            self._scrollView(sheet);
                        }, 0);
                    }
                };
                ScrollService.prototype._scrollView = function (sheet) {
                    var self = this;
                    if (sheet && self._scrolling) {
                        self._scrolling = false;
                        self._updateView(sheet);
                    }
                };
                ScrollService.prototype._updateView = function (sheet) {
                    var self = this;
                    if (self._painting) {
                        return;
                    }
                    self._painting = true;
                    var workbook = self._wb;
                    if (sheet) {
                        var showScrollTip = workbook.options.showScrollTip, newTop = self._newTop, newTopOffset = self._newTopOffset, newLeft = self._newLeft, newLeftOffset = self._newLeftOffset;
                        if (newTop !== sheet._scrollTopRow || newTopOffset !== sheet._scrollTopRowOffset) {
                            self._vScrollTo(sheet, newTop, newTopOffset);
                            if (showScrollTip === 2 || showScrollTip === 3) {
                                workbook._refreshTooltip(self._getScrollTooltipContent(true));
                            }
                        } else if (newLeft !== sheet._scrollLeftCol || newLeftOffset !== sheet._scrollLeftColOffset) {
                            self._hScrollTo(sheet, newLeft, newLeftOffset);
                            if (showScrollTip === 1 || showScrollTip === 3) {
                                workbook._refreshTooltip(self._getScrollTooltipContent(false));
                            }
                        }
                    }
                    self._painting = false;
                };
                ScrollService.prototype._vScrollTo = function (sheet, newTopRow, newTopRowOffset, oldTopRowInTouch) {
                    var self = this;
                    if (self._timer) {
                        WINDOW.clearTimeout(self._timer);
                        self._timer = keyword_null;
                    }
                    if (sheet) {
                        var oldTopRow = sheet._scrollTopRow;
                        var oldTopRowOffset = sheet._scrollTopRowOffset;
                        var touchIgnoreJudge = !isNullOrUndefined(oldTopRowInTouch);
                        if (!touchIgnoreJudge && newTopRow === oldTopRow && newTopRowOffset === oldTopRowOffset) {
                            return;
                        }
                        if (touchIgnoreJudge) {
                            oldTopRow = oldTopRowInTouch;
                        }
                        sheet._scrollTopRow = newTopRow;
                        sheet._scrollTopRowOffset = newTopRowOffset;
                        sheet._trigger('vScroll', {
                            sheet: sheet,
                            sheetName: sheet.name()
                        });
                        if (sheet._layoutSuspended > 0) {
                            if (oldTopRow !== newTopRow) {
                                sheet._trigger(common_1.Events.TopRowChanged, {
                                    sheet: sheet,
                                    sheetName: sheet.name(),
                                    oldTopRow: oldTopRow,
                                    newTopRow: newTopRow
                                });
                            }
                            return;
                        }
                        var painted = false;
                        var options = sheet.options;
                        var offsetTop = options.sheetAreaOffset.top;
                        var adj = offsetTop + 2;
                        var bounds = sheet._bounds;
                        var layout = sheet._getSheetLayout();
                        var viewportY = layout._viewportY;
                        var viewportHeight = sheet._getActualViewportHeight(layout);
                        var grayAreaHeight = layout._grayAreaHeight;
                        var frozenTrailingY = layout._frozenTrailingY;
                        var frozenTrailingHeight = layout._frozenTrailingHeight;
                        var width = layout.width + options.sheetAreaOffset.left;
                        var height = void 0;
                        var x = void 0;
                        var y = void 0;
                        var render = sheet._render;
                        var ctx = render._getCtx();
                        var frozenTrailingRowStickToEdge = sheet._frozenTrailingRowStickToEdge;
                        if (sheet.tables && sheet.frozenRowCount() === 0) {
                            var rect = sheet.tables._getActiveTableRect();
                            if (rect) {
                                rect.x = rect.x - 2;
                                rect.width = rect.width + 4;
                                rect.y = offsetTop;
                                rect.height = viewportY;
                                sheet._dirty = true;
                                render._paintBody(ctx, rect);
                            }
                        }
                        if (newTopRow > oldTopRow || (newTopRow === oldTopRow && Math_abs(newTopRowOffset) > Math_abs(oldTopRowOffset))) {
                            var rl1 = void 0, rl2 = void 0;
                            var rowLayouts = sheet._getRowLayout(1);
                            if (rowLayouts && rowLayouts.length > 0) {
                                rl1 = rowLayouts.findRow(newTopRow);
                            }
                            if (rl1) {
                                var i = rowLayouts.length - 1;
                                rl2 = rowLayouts[i];
                                while (rl2 && rl2.y + rl2.height > viewportY + viewportHeight) {
                                    i = i - 1;
                                    rl2 = rowLayouts[i];
                                }
                                if (rl2 && rl2.row > newTopRow) {
                                    painted = true;
                                    x = bounds ? bounds.x : layout.x;
                                    y = rl1.y + Math_abs(newTopRowOffset);
                                    height = rl2.y + rl2.height - y - adj;
                                    render._copyScreen(x, y, width, height, x, viewportY);
                                    if (!options.colHeaderVisible) {
                                        sheet.invalidateLayout();
                                        render._paintBody(ctx, new common_1.Rect(x, 0, width, offsetTop));
                                    }
                                    sheet.invalidateLayout();
                                    var newViewportHeight = frozenTrailingRowStickToEdge ? viewportHeight : viewportHeight + frozenTrailingHeight + grayAreaHeight;
                                    render._paintBody(ctx, new common_1.Rect(x, viewportY + height, width, newViewportHeight - height));
                                    newViewportHeight -= frozenTrailingRowStickToEdge ? 0 : grayAreaHeight;
                                    render._paintAdornment(ctx, new common_1.Rect(x, viewportY - 2, width, newViewportHeight + 2));
                                    this._cleanFrozenRowSelectionBorder(sheet, x, width);
                                }
                            }
                        } else {
                            var h = 0;
                            for (var j = newTopRow; j < oldTopRow && h < viewportHeight; j++) {
                                h += sheet._getZoomRowHeight(j);
                            }
                            h += Math_abs(oldTopRowOffset) - Math_abs(newTopRowOffset);
                            if (h < viewportHeight) {
                                painted = true;
                                x = bounds ? bounds.x : layout.x;
                                y = viewportY;
                                height = viewportHeight - h;
                                if (sheet.frozenTrailingRowCount() > 0) {
                                    height -= FROZEN_LINE_WIDTH;
                                }
                                var deltaHeight = 0;
                                if (!frozenTrailingRowStickToEdge && grayAreaHeight > 0) {
                                    deltaHeight = frozenTrailingHeight;
                                    var maxToY = Math_min(bounds.height - deltaHeight - FROZEN_LINE_WIDTH, frozenTrailingY - FROZEN_LINE_WIDTH + h);
                                    render._copyScreen(x, frozenTrailingY - FROZEN_LINE_WIDTH, width, deltaHeight + FROZEN_LINE_WIDTH, x, maxToY);
                                }
                                var viewportOffsetHeight = frozenTrailingRowStickToEdge ? 0 : Math_min(h, grayAreaHeight) - FROZEN_LINE_WIDTH;
                                render._copyScreen(x, y, width, height + viewportOffsetHeight, x, y + h);
                                sheet.invalidateLayout();
                                var extensionForRowOutlines = sheet.rowOutlines && !sheet.rowOutlines._isEmpty() ? sheet.rowOutlines._getOutlineLineWidth() + offsetTop + 1 : 0;
                                render._paintBody(ctx, new common_1.Rect(x, y - offsetTop, width, h + offsetTop + extensionForRowOutlines + 5));
                                var adornmentNeedPaintHeight = viewportHeight + viewportOffsetHeight + deltaHeight + 2;
                                render._paintAdornment(ctx, new common_1.Rect(x, y - 2, width, adornmentNeedPaintHeight));
                                this._cleanFrozenRowSelectionBorder(sheet, x, width);
                            }
                        }
                        if (!painted) {
                            sheet.invalidateLayout();
                            sheet.repaint();
                        }
                        if (oldTopRow !== newTopRow) {
                            sheet._trigger(common_1.Events.TopRowChanged, {
                                sheet: sheet,
                                sheetName: sheet.name(),
                                oldTopRow: oldTopRow,
                                newTopRow: newTopRow
                            });
                        }
                        var handler = sheet._eventHandler;
                        if (handler) {
                            handler._updateEditingEditor();
                        }
                        var partialRowOrColumnScroll = oldTopRow === sheet._scrollTopRow && oldTopRowOffset !== sheet._scrollTopRowOffset;
                        if (painted && needRepaintAfterScroll(sheet, partialRowOrColumnScroll)) {
                            self._timer = _createTimer(sheet, self);
                        }
                    }
                };
                // 清除冻结行选择边框
                ScrollService.prototype._cleanFrozenRowSelectionBorder = function (sheet, x, width) {
                    var render = sheet._render, ctx = render._getCtx();
                    this._getLastFrozenRowOptions(sheet)
                        .concat(this._getFirstFrozenTrailingRowOptions(sheet))
                        .forEach(function (option) {
                            var frozenRowLayout = option.layout, cleanRect = new common_1.Rect(x, frozenRowLayout.y, width, frozenRowLayout.height);
                            render._copyDoubleBufferRect(cleanRect);
                            render._paintAdornment(ctx, cleanRect);
                        });
                };
                // 获取最后冻结行选项
                ScrollService.prototype._getLastFrozenRowOptions = function (sheet) {
                    var self = this, selections = sheet.getSelections();
                    if (selections.length === 1) {
                        var isScrollByPixel = self._wb.options.scrollByPixel, newTopRow = sheet._scrollTopRow, newTopRowOffset = sheet._scrollTopRowOffset, topSelectRow = selections[0].row, bottomSelectRow = selections[0].row + selections[0].rowCount - 1;
                        if (isScrollByPixel && bottomSelectRow === newTopRow - 1) {
                            return [];
                        }
                        var rowOptions = [];
                        if (topSelectRow === newTopRow + 1
                            || (topSelectRow < newTopRow && newTopRow <= bottomSelectRow)
                            || bottomSelectRow === newTopRow - 1
                            || (isScrollByPixel && topSelectRow === newTopRow && newTopRowOffset !== 0)) {
                            var frozenRowLayouts = sheet._getRowLayout(0);
                            if (frozenRowLayouts && frozenRowLayouts.length > 0) {
                                rowOptions.push({ layout: frozenRowLayouts[frozenRowLayouts.length - 1] });
                            }
                        }
                        return rowOptions;
                    }
                    return [];
                };
                // 获取第一冻结尾随行选项
                ScrollService.prototype._getFirstFrozenTrailingRowOptions = function (sheet) {
                    var self = this, selections = sheet.getSelections();
                    if (selections.length === 1) {
                        var isScrollByPixel = self._wb.options.scrollByPixel;
                        var newBottomRow = sheet.getViewportBottomRow(1);
                        var topSelectRow = selections[0].row;
                        var bottomSelectRow = selections[0].row + selections[0].rowCount - 1;
                        var rowOptions = [];
                        var frozenRowLayouts = sheet._getRowLayout(2);
                        var hasFrozenRowLayouts = frozenRowLayouts && frozenRowLayouts.length > 0;
                        var frozenRow = hasFrozenRowLayouts ? frozenRowLayouts[0] : keyword_null;
                        var rowLayouts = sheet._getRowLayout(1);
                        var hasRowLayouts = rowLayouts && rowLayouts.length > 0;
                        var rowLayout = hasRowLayouts ? rowLayouts.findRow(newBottomRow) : keyword_null;
                        var isCleanFrozenRow = hasFrozenRowLayouts && hasRowLayouts && frozenRow.y !== (rowLayout.y + rowLayout.height);
                        if (
                            (
                                bottomSelectRow === newBottomRow - 1
                                || (topSelectRow <= newBottomRow && newBottomRow < bottomSelectRow)
                                || topSelectRow === newBottomRow + 1
                                || (isScrollByPixel && bottomSelectRow === newBottomRow && isCleanFrozenRow)
                            )
                            && hasFrozenRowLayouts
                        ) {
                            rowOptions.push({
                                layout: frozenRow
                            });
                        }
                        return rowOptions;
                    }
                    return [];
                };
                ScrollService.prototype._hScrollTo = function (sheet, newLeftCol, newLeftColOffset, oldLeftColInTouch) {
                    var self = this;
                    if (self._timer) {
                        WINDOW.clearTimeout(self._timer);
                        self._timer = keyword_null;
                    }
                    if (sheet) {
                        var oldLeftCol = sheet._scrollLeftCol;
                        var oldLeftColOffset = sheet._scrollLeftColOffset;
                        var touchIgnoreJudge = !isNullOrUndefined(oldLeftColInTouch);
                        if (!touchIgnoreJudge && newLeftCol === oldLeftCol && newLeftColOffset === oldLeftColOffset) {
                            return;
                        }
                        if (touchIgnoreJudge) {
                            oldLeftCol = oldLeftColInTouch;
                        }
                        sheet._scrollLeftCol = newLeftCol;
                        sheet._scrollLeftColOffset = newLeftColOffset;
                        sheet._trigger('hScroll', {
                            sheet: sheet,
                            sheetName: sheet.name()
                        });
                        if (sheet._layoutSuspended > 0) {
                            if (oldLeftCol !== newLeftCol) {
                                sheet._trigger(common_1.Events.LeftColumnChanged, {
                                    sheet: sheet,
                                    sheetName: sheet.name(),
                                    oldLeftCol: oldLeftCol,
                                    newLeftCol: newLeftCol
                                });
                            }
                            return;
                        }
                        var painted = false;
                        var options = sheet.options;
                        var offsetLeft = options.sheetAreaOffset.left;
                        var adj = offsetLeft + 2;
                        var bounds = sheet._bounds;
                        var layout = sheet._getSheetLayout();
                        var viewportX = layout._viewportX;
                        var viewportWidth = sheet._getActualViewportWidth(layout);
                        var grayAreaWidth = layout._grayAreaWidth;
                        var frozenTrailingX = layout._frozenTrailingX;
                        var frozenTrailingWidth = layout._frozenTrailingWidth;
                        var height = layout.height + options.sheetAreaOffset.top;
                        var x = void 0;
                        var y = void 0;
                        var width = void 0;
                        var render = sheet._render;
                        var ctx = render._getCtx();
                        var frozenTrailingColumnStickToEdge = sheet._frozenTrailingColumnStickToEdge;
                        if (
                            newLeftCol > oldLeftCol
                            || (
                                newLeftCol === oldLeftCol
                                && Math_abs(newLeftColOffset) > Math_abs(oldLeftColOffset)
                            )
                        ) {
                            var cl1 = void 0;
                            var cl2 = void 0;
                            var colLayouts = sheet._getColumnLayout(1);
                            if (colLayouts && colLayouts.length > 0) {
                                cl1 = colLayouts.findCol(newLeftCol);
                            }
                            if (cl1) {
                                var j = colLayouts.length - 1;
                                cl2 = colLayouts[j];
                                while (cl2 && cl2.x + cl2.width > viewportX + viewportWidth) {
                                    j = j - 1;
                                    cl2 = colLayouts[j];
                                }
                                if (cl2 && cl2.col > newLeftCol) {
                                    painted = true;
                                    x = cl1.x + Math_abs(newLeftColOffset);
                                    y = bounds ? bounds.y : layout.y;
                                    width = cl2.x + cl2.width - x - adj;
                                    render._copyScreen(x, y, width, height, viewportX, y);
                                    if (!options.rowHeaderVisible) {
                                        sheet.invalidateLayout();
                                        render._paintBody(ctx, new common_1.Rect(0, y, offsetLeft, height));
                                    }
                                    sheet.invalidateLayout();
                                    var newViewportWidth = frozenTrailingColumnStickToEdge ? viewportWidth : viewportWidth + frozenTrailingWidth + grayAreaWidth;
                                    render._paintBody(ctx, new common_1.Rect(viewportX + width, y, newViewportWidth - width, height));
                                    newViewportWidth -= frozenTrailingColumnStickToEdge ? 0 : grayAreaWidth;
                                    render._paintAdornment(ctx, new common_1.Rect(viewportX - 2, y, newViewportWidth + 2, height));
                                    this._cleanFrozenColSelectionBorder(sheet, y, height);
                                }
                            }
                        } else {
                            var w = 0;
                            for (var i = newLeftCol; i < oldLeftCol && w < viewportWidth; i++) {
                                w += sheet._getZoomColumnWidth(i);
                            }
                            w += Math_abs(oldLeftColOffset) - Math_abs(newLeftColOffset);
                            if (w < viewportWidth) {
                                painted = true;
                                x = viewportX;
                                y = bounds ? bounds.y : layout.y;
                                width = viewportWidth - w;
                                if (sheet.frozenTrailingColumnCount() > 0) {
                                    width -= FROZEN_LINE_WIDTH;
                                }
                                var deltaWidth = 0;
                                if (!frozenTrailingColumnStickToEdge && grayAreaWidth > 0) {
                                    deltaWidth = frozenTrailingWidth;
                                    var maxToX = Math_min(bounds.width - deltaWidth - FROZEN_LINE_WIDTH, frozenTrailingX - FROZEN_LINE_WIDTH + w);
                                    render._copyScreen(frozenTrailingX - FROZEN_LINE_WIDTH, y, deltaWidth + FROZEN_LINE_WIDTH, height, maxToX, y);
                                }
                                var viewportOffsetWidth = frozenTrailingColumnStickToEdge ? 0 : Math_min(w, grayAreaWidth) - FROZEN_LINE_WIDTH;
                                render._copyScreen(x, y, width + viewportOffsetWidth, height, x + w, y);
                                sheet.invalidateLayout();
                                var extensionForColumnOutlines = sheet.columnOutlines && !sheet.columnOutlines._isEmpty() ? sheet.columnOutlines._getOutlineLineWidth() + offsetLeft + 1 : 0;
                                render._paintBody(ctx, new common_1.Rect(x - offsetLeft, y, w + offsetLeft + extensionForColumnOutlines + 5, height));
                                var adornmentNeedPaintWidth = viewportWidth + viewportOffsetWidth + deltaWidth + 2;
                                render._paintAdornment(ctx, new common_1.Rect(viewportX - 2, y, adornmentNeedPaintWidth, height));
                                this._cleanFrozenColSelectionBorder(sheet, y, height);
                            }
                        }
                        if (!painted) {
                            sheet.invalidateLayout();
                            sheet.repaint();
                        }
                        if (oldLeftCol !== newLeftCol) {
                            sheet._trigger(common_1.Events.LeftColumnChanged, {
                                sheet: sheet,
                                sheetName: sheet.name(),
                                oldLeftCol: oldLeftCol,
                                newLeftCol: newLeftCol
                            });
                        }
                        var handler = sheet._eventHandler;
                        if (handler) {
                            handler._updateEditingEditor();
                        }
                        var partialRowOrColumnScroll = oldLeftCol === sheet._scrollLeftCol && oldLeftColOffset !== sheet._scrollLeftColOffset;
                        if (painted && needRepaintAfterScroll(sheet, partialRowOrColumnScroll)) {
                            self._timer = _createTimer(sheet, self);
                        }
                    }
                };
                // 清除冻结列选择边框
                ScrollService.prototype._cleanFrozenColSelectionBorder = function (sheet, y, height) {
                    var render = sheet._render, ctx = render._getCtx();
                    this._getLastFrozenColOptions(sheet)
                        .concat(this._getFirstFrozenTrailingColOptions(sheet))
                        .forEach(function (option) {
                            var frozenColLayout = option.layout, cleanRect = new common_1.Rect(frozenColLayout.x, y, frozenColLayout.width, height);
                            render._copyDoubleBufferRect(cleanRect);
                            render._paintAdornment(ctx, cleanRect);
                        });
                };
                // 获取上次冻结的列选项
                ScrollService.prototype._getLastFrozenColOptions = function (sheet) {
                    var self = this, selections = sheet.getSelections();
                    if (selections.length === 1) {
                        var isScrollByPixel = self._wb.options.scrollByPixel, newLeftCol = sheet._scrollLeftCol, newLeftColOffset = sheet._scrollLeftColOffset, leftSelectCol = selections[0].col, rightSelectCol = selections[0].col + selections[0].colCount - 1;
                        if (isScrollByPixel && rightSelectCol === newLeftCol - 1) {
                            return [];
                        }
                        var colOptions = [];
                        if (leftSelectCol === newLeftCol + 1
                            || (leftSelectCol < newLeftCol && newLeftCol <= rightSelectCol)
                            || rightSelectCol === newLeftCol - 1
                            || (isScrollByPixel && leftSelectCol === newLeftCol && newLeftColOffset !== 0)) {
                            var frozenColLayouts = sheet._getColumnLayout(0);
                            if (frozenColLayouts && frozenColLayouts.length > 0) {
                                colOptions.push({ layout: frozenColLayouts[frozenColLayouts.length - 1] });
                            }
                        }
                        return colOptions;
                    }
                    return [];
                };
                // 获取第一冻结跟踪列选项
                ScrollService.prototype._getFirstFrozenTrailingColOptions = function (sheet) {
                    var self = this, selections = sheet.getSelections();
                    if (selections.length === 1) {
                        var isScrollByPixel = self._wb.options.scrollByPixel, newRightCol = sheet.getViewportRightColumn(1), leftSelectCol = selections[0].col, rightSelectCol = selections[0].col + selections[0].colCount - 1;
                        var colOptions = [], frozenColLayouts = sheet._getColumnLayout(2), hasFrozenColLayouts = frozenColLayouts && frozenColLayouts.length > 0, frozenCol = hasFrozenColLayouts ? frozenColLayouts[0] : keyword_null, colLayouts = sheet._getColumnLayout(1), hasColLayouts = colLayouts && colLayouts.length > 0, colLayout = hasColLayouts ? colLayouts.findCol(newRightCol) : keyword_null, isCleanFrozenCol = hasFrozenColLayouts && hasColLayouts && frozenCol.x !== (colLayout.x + colLayout.width);
                        if ((rightSelectCol === newRightCol - 1
                            || (leftSelectCol <= newRightCol && newRightCol < rightSelectCol)
                            || leftSelectCol === newRightCol + 1
                            || (isScrollByPixel && rightSelectCol === newRightCol && isCleanFrozenCol))
                            && hasFrozenColLayouts) {
                            colOptions.push({
                                layout: frozenCol
                            });
                        }
                        return colOptions;
                    }
                    return [];
                };
                ScrollService.prototype._doMouseWheel = function (sheet, event, detailY, detailX) {
                    var self = this, wb = self._wb, retY = false, retX = false;
                    var scrollbarV = wb._vScrollbar, scrollbarH = wb._hScrollbar;
                    var scrollbarShowMax = wb.options.scrollbarShowMax, isMobileScrollbar = wb.options.scrollbarAppearance === core_enum_1.ScrollbarAppearance.mobile;
                    if (sheet) {
                        var sheetName = sheet.name();
                        if (event.ctrlKey) {
                            if (wb.options.allowUserZoom) {
                                var oldZoomFactor = sheet.zoom();
                                var newZoomFactor = strip(oldZoomFactor - 0.05 * detailY);
                                if (sheet.isEditing() && !sheet.endEdit()) {
                                    return;
                                }
                                var eventArgs = {
                                    sheet: sheet,
                                    sheetName: sheet.name(),
                                    oldZoomFactor: oldZoomFactor,
                                    newZoomFactor: newZoomFactor,
                                    cancel: false
                                };
                                sheet._trigger(common_1.Events.ViewZooming, eventArgs);
                                if (eventArgs && eventArgs.cancel === true) {
                                    return false;
                                }
                                var commandArgs = {
                                    cmd: 'zoom',
                                    sheetName: sheetName,
                                    oldZoomFactor: oldZoomFactor,
                                    zoomFactor: eventArgs.newZoomFactor
                                };
                                sheet._commandManager().execute(commandArgs);
                                newZoomFactor = sheet.zoom();
                                if (oldZoomFactor !== newZoomFactor) {
                                    delete eventArgs.cancel;
                                    sheet._trigger(common_1.Events.ViewZoomed, eventArgs);
                                    sheet._trigger(common_1.Events.UserZooming, eventArgs);
                                }
                            } else {
                                return true;
                            }
                        } else {
                            detailX = detailX || 0;
                            var oldTopRow = sheet._scrollTopRow, oldTopRowOffset = sheet._scrollTopRowOffset, topRowInfo = self._getNewTopRow(sheet, detailY), newTopRow = topRowInfo._row, newTopRowOffset = topRowInfo._offset;
                            if (oldTopRow !== newTopRow || oldTopRowOffset !== newTopRowOffset) {
                                if (isMobileScrollbar) {
                                    scrollbarV._updateState(core_enum_1.ScrollbarState.show);
                                    self._launchHideScrollbarTimer(true);
                                }
                                self._vScrollTo(sheet, newTopRow, newTopRowOffset);
                                sheet._syncVScrollbarPosition();
                                if (!scrollbarShowMax) {
                                    sheet._syncVScrollbarSize();
                                }
                            } else {
                                retY = true;
                            }
                            var oldLeftCol = sheet._scrollLeftCol, oldLeftColOffset = sheet._scrollLeftColOffset, leftColInfo = self._getNewLeftCol(sheet, detailX), newLeftCol = leftColInfo._col, newLeftColOffset = leftColInfo._offset;
                            if (oldLeftCol !== newLeftCol || oldLeftColOffset !== newLeftColOffset) {
                                if (isMobileScrollbar) {
                                    scrollbarH._updateState(core_enum_1.ScrollbarState.show);
                                    self._launchHideScrollbarTimer(false);
                                }
                                self._hScrollTo(sheet, newLeftCol, newLeftColOffset);
                                sheet._syncHScrollbarPosition();
                                if (!scrollbarShowMax) {
                                    sheet._syncHScrollbarSize();
                                }
                            }
                        }
                        var canvasOffset = sheet._getCanvasOffset();
                        var target = sheet.hitTest(event.pageX - canvasOffset.left, event.pageY - canvasOffset.top);
                        var oldTarget = sheet._currentTarget, cellTypeHitInfo = oldTarget && oldTarget.cellTypeHitInfo;
                        if (cellTypeHitInfo) {
                            cellTypeHitInfo.cellRect = sheet.getCellRect(oldTarget.row, oldTarget.col);
                        }
                        var eventHandler = sheet._eventHandler;
                        eventHandler._updateCanvasCursor(target);
                        eventHandler._setHoverCell(target);
                    }
                    return retY && detailX === 0;
                };
                // 获取像素滚动的新顶行
                ScrollService.prototype._getNewTopRowForPixelScroll = function (sheet, detailY) {
                    var newTopRow = sheet._scrollTopRow, newTopRowOffset = sheet._scrollTopRowOffset;
                    var workbook = sheet.parent;
                    var zoomFactor = sheet.zoom();
                    var translationY = Math_round(detailY * workbook.options.scrollPixel * zoomFactor);
                    var height = 0, minRow, maxRow, viewportY = sheet._getSheetLayout()._viewportY, rowLayout = sheet._getViewportRowLayout(1).findRow(newTopRow);
                    if (rowLayout) {
                        if (translationY < 0) {
                            minRow = sheet._getScrollableRow(-1);
                            height = -(viewportY - rowLayout.y);
                            while (newTopRow > minRow && height >= translationY) {
                                newTopRow--;
                                height -= sheet._getZoomRowHeight(newTopRow);
                            }
                            newTopRowOffset = height - translationY;
                            if (newTopRow === minRow && newTopRowOffset > 0) {
                                newTopRowOffset = 0;
                            }
                        } else if (translationY > 0) {
                            maxRow = sheet._getLastVisualScrollRow();
                            height = rowLayout.y + rowLayout.height - viewportY;
                            while (newTopRow < maxRow && height <= translationY) {
                                newTopRow++;
                                height += sheet._getZoomRowHeight(newTopRow);
                            }
                            var rowHeight = sheet._getZoomRowHeight(newTopRow);
                            newTopRowOffset = (height - translationY) - rowHeight;
                            if (workbook.options.scrollbarMaxAlign) {
                                var layout = sheet._getSheetLayout();
                                var startRow = sheet.frozenRowCount();
                                var endRow = sheet.getRowCount() - sheet.frozenTrailingRowCount() - 1;
                                var result = sheet._getTopRowWhenLastRowShowCompleteForPixelScroll(sheet._getActualViewportHeight(layout), startRow, endRow);
                                maxRow = result._row;
                                var maxRowOffset = result._offset;
                                if (newTopRow > maxRow) {
                                    newTopRow = maxRow;
                                    newTopRowOffset = maxRowOffset;
                                } else if (newTopRow === maxRow && Math_abs(newTopRowOffset) > Math_abs(maxRowOffset)) {
                                    newTopRowOffset = maxRowOffset;
                                }
                            } else {
                                if (newTopRow < maxRow && (height - translationY) === 0) {
                                    newTopRow++;
                                    newTopRowOffset = 0;
                                } else if (newTopRow === maxRow && (height - translationY) < 0) {
                                    newTopRowOffset = -rowHeight;
                                }
                            }
                        }
                    }
                    return {
                        _row: newTopRow,
                        _offset: newTopRowOffset
                    };
                };
                // 获取新的首行
                ScrollService.prototype._getNewTopRow = function (sheet, detailY) {
                    var newTopRow = sheet._scrollTopRow, newTopRowOffset = sheet._scrollTopRowOffset;
                    var workbook = sheet.parent;
                    if (workbook && workbook.options.scrollByPixel) {
                        return workbook._scrollService._getNewTopRowForPixelScroll(sheet, detailY);
                    }
                    var frozenRowCount = sheet.frozenRowCount();
                    if (frozenRowCount > 0) {
                        if (newTopRow === 0 && detailY > 0) {
                            newTopRow = frozenRowCount;
                        } else if (detailY < 0 && newTopRow === frozenRowCount - detailY) {
                            newTopRow = 0;
                        }
                    }
                    var tmpRow = sheet._getScrollableRow(newTopRow + detailY, detailY < 0);
                    if (tmpRow !== -1) {
                        newTopRow = tmpRow;
                    } else {
                        newTopRow = newTopRow + detailY;
                    }
                    var firstPageTopRow = sheet._getFirstPageTopRow(), lastVisualScrollRow = sheet._getLastVisualScrollRow();
                    if ((sheet.getRowCount() - frozenRowCount - sheet.frozenTrailingRowCount() <= 0) || firstPageTopRow === keyword_null) {
                        newTopRow = sheet._scrollTopRow;
                    } else {
                        if (newTopRow < firstPageTopRow) {
                            newTopRow = firstPageTopRow;
                        } else if (newTopRow > lastVisualScrollRow) {
                            newTopRow = lastVisualScrollRow;
                        }
                        if (newTopRow === keyword_null) {
                            newTopRow = -1;
                        }
                    }
                    return {
                        _row: newTopRow,
                        _offset: newTopRowOffset
                    };
                };
                // 获取像素滚动的新左栏
                ScrollService.prototype._getNewLeftColForPixelScroll = function (sheet, detailX) {
                    var newLeftCol = sheet._scrollLeftCol, newLeftColOffset = sheet._scrollLeftColOffset;
                    var workbook = sheet.parent;
                    var zoomFactor = sheet.zoom();
                    var translationX = Math_round(detailX * workbook.options.scrollPixel * zoomFactor);
                    var width = 0, minCol, maxCol, viewportX = sheet._getSheetLayout()._viewportX, colLayout = sheet._getViewportColumnLayout(1).findCol(newLeftCol);
                    if (colLayout) {
                        if (translationX < 0) {
                            minCol = sheet._getScrollableColumn(-1);
                            width = -(viewportX - colLayout.x);
                            while (newLeftCol > minCol && width >= translationX) {
                                newLeftCol--;
                                width -= sheet._getZoomColumnWidth(newLeftCol);
                            }
                            newLeftColOffset = width - translationX;
                            if (newLeftCol === minCol && newLeftColOffset > 0) {
                                newLeftColOffset = 0;
                            }
                        } else if (translationX > 0) {
                            maxCol = sheet._getLastVisualScrollColumn();
                            width = colLayout.x + colLayout.width - viewportX;
                            while (newLeftCol < maxCol && width <= translationX) {
                                newLeftCol++;
                                width += sheet._getZoomColumnWidth(newLeftCol);
                            }
                            var colWidth = sheet._getZoomColumnWidth(newLeftCol);
                            newLeftColOffset = (width - translationX) - colWidth;
                            if (workbook.options.scrollbarMaxAlign) {
                                var layout = sheet._getSheetLayout(), startColumn = sheet.frozenColumnCount(), endColumn = sheet.getColumnCount() - sheet.frozenTrailingColumnCount() - 1;
                                var result = sheet._getLeftColWhenLastColShowCompleteForPixelScroll(sheet._getActualViewportWidth(layout), startColumn, endColumn);
                                maxCol = result._col;
                                var maxColOffset = result._offset;
                                if (newLeftCol > maxCol) {
                                    newLeftCol = maxCol;
                                    newLeftColOffset = maxColOffset;
                                } else if (newLeftCol === maxCol && Math_abs(newLeftColOffset) > Math_abs(maxColOffset)) {
                                    newLeftColOffset = maxColOffset;
                                }
                            } else {
                                if (newLeftCol < maxCol && (width - translationX) === 0) {
                                    newLeftCol++;
                                    newLeftColOffset = 0;
                                } else if (newLeftCol === maxCol && (width - translationX) < 0) {
                                    newLeftColOffset = -colWidth;
                                }
                            }
                        }
                    }
                    return {
                        _col: newLeftCol,
                        _offset: newLeftColOffset
                    };
                };
                // 获取新左栏
                ScrollService.prototype._getNewLeftCol = function (sheet, detailX) {
                    var newLeftCol = sheet._scrollLeftCol, newLeftColOffset = sheet._scrollLeftColOffset;
                    var workbook = sheet.parent;
                    if (workbook && workbook.options.scrollByPixel) {
                        return workbook._scrollService._getNewLeftColForPixelScroll(sheet, detailX);
                    }
                    var frozenColCount = sheet.frozenColumnCount();
                    if (frozenColCount > 0) {
                        if (newLeftCol === 0 && detailX > 0) {
                            newLeftCol = frozenColCount;
                        } else if (detailX < 0 && newLeftCol === frozenColCount - detailX) {
                            newLeftCol = 0;
                        }
                    }

                    var tmpCol = sheet._getScrollableColumn(newLeftCol + detailX, detailX < 0);
                    if (tmpCol !== -1) {
                        newLeftCol = tmpCol;
                    } else {
                        newLeftCol = newLeftCol + detailX;
                    }
                    var firstPageLeftColumn = sheet._getFirstPageLeftColumn(), lastVisualScrollColumn = sheet._getLastVisualScrollColumn();
                    if ((sheet.getColumnCount() - frozenColCount - sheet.frozenTrailingColumnCount() <= 0) || firstPageLeftColumn === keyword_null) {
                        newLeftCol = sheet._scrollLeftCol;
                    } else {
                        if (newLeftCol < firstPageLeftColumn) {
                            newLeftCol = firstPageLeftColumn;
                        } else if (newLeftCol > lastVisualScrollColumn) {
                            newLeftCol = lastVisualScrollColumn;
                        }
                        if (newLeftCol === keyword_null) {
                            newLeftCol = -1;
                        }
                    }
                    return {
                        _col: newLeftCol,
                        _offset: newLeftColOffset
                    };
                };
                // 显示滚动工具提示
                ScrollService.prototype._showScrollTooltip = function (isVScroll, e) {
                    var self = this, wb = self._wb;
                    var top, left;
                    var sheet = getActiveSheet(wb);
                    if (sheet) {
                        if (isVScroll) {
                            top = e.pageY;
                            left = e.pageX - VSCROLLTOOLTIP_LEFT;
                        } else {
                            top = e.pageY - HSCROLLTOOLTIP_TOP;
                            left = e.pageX - HSCROLLTOOLTIP_LEFT;
                        }
                        wb._showTooltip(StringHelper._escapeHtml(self._getScrollTooltipContent(isVScroll)), left, top, true);
                    }
                };
                // 获取滚动工具提示内容
                ScrollService.prototype._getScrollTooltipContent = function (isVScroll) {
                    var sheet = getActiveSheet(this._wb);
                    var info, num = sheet._scrollLeftCol + 1;
                    if (sheet) {
                        if (isVScroll) {
                            info = getSR().Tip_Row + (sheet._scrollTopRow + 1);
                        } else {
                            if (sheet.options.colHeaderAutoText !== 1) {
                                num = common_1._util._indexToLetters(num);
                            }
                            info = getSR().Tip_Column + num;
                        }
                    }
                    return info;
                };
                ScrollService.prototype._hideScrollbarContainer = function (container) {
                    domUtil_1.GC$(container).addClass(CSS_CLASS_SCROLLBAR_STATE_HIDE);
                };
                ScrollService.prototype._showScrollbarContainer = function (container) {
                    domUtil_1.GC$(container).removeClass(CSS_CLASS_SCROLLBAR_STATE_HIDE);
                };
                ScrollService.prototype._activeScrollbarContainer = function (container) {
                    domUtil_1.GC$(container).addClass(CSS_CLASS_SCROLLBAR_STATE_HOVER);
                };
                ScrollService.prototype._inactiveScrollbarContainer = function (container) {
                    domUtil_1.GC$(container).removeClass(CSS_CLASS_SCROLLBAR_STATE_HOVER);
                };
                // 启动隐藏滚动条计时器
                ScrollService.prototype._launchHideScrollbarTimer = function (isVertical, hideTime) {
                    if (hideTime === void 0) { hideTime = 1000; }
                    var self = this, wb = self._wb;
                    var scrollbarContainer = isVertical ? wb._vScrollbarContainer : wb._hScrollbarContainer;
                    var isMobileScrollbar = wb.options.scrollbarAppearance = core_enum_1.ScrollbarAppearance.mobile;
                    var hideFn = function () {
                        self._inactiveScrollbarContainer(scrollbarContainer);
                        self._hideScrollbarContainer(scrollbarContainer);
                    };
                    if (isMobileScrollbar) {
                        self._stopHideScrollBarTimer(isVertical);
                        if (isVertical) {
                            self._scrollbarVHideTimer = setTimeout(hideFn, hideTime);
                        } else {
                            self._scrollbarHHideTimer = setTimeout(hideFn, hideTime);
                        }
                    }
                };
                // 停止隐藏滚动条计时器
                ScrollService.prototype._stopHideScrollBarTimer = function (isVertical) {
                    var self = this;
                    if (isVertical && self._scrollbarVHideTimer) {
                        clearTimeout(self._scrollbarVHideTimer);
                        self._scrollbarVHideTimer = null;
                    } else if (!isVertical && self._scrollbarHHideTimer) {
                        clearTimeout(self._scrollbarHHideTimer);
                        self._scrollbarHHideTimer = null;
                    }
                };
                return ScrollService;
            }());
            var defaultOptions = {
                allowUserDragDrop: true,
                allowUserDragFill: true,
                allowUserZoom: true,
                allowUserResize: true,
                allowUndo: true,
                // 允许工作簿重新排序
                allowSheetReorder: true,
                // 是否在电子表格中启用自动创建超链接
                allowContextMenu: true,
                // 是否允许用户在选择时可以使用取消选择，选择一块区域，按住ctrl可以取消选择一些区域
                allowUserDeselect: true,
                defaultDragFillType: 5,
                showDragFillSmartTag: true,
                showHorizontalScrollbar: true,
                showVerticalScrollbar: true,
                // 显示的滚动条是否基于工作表中的列数和行数
                scrollbarShowMax: true,
                // 滚动条是否与活动工作表的最后一行和最后一列对齐
                scrollbarMaxAlign: false,
                // 是否显示工作表标签条
                tabStripVisible: true,
                tabStripRatio: 0.5,
                tabStripHost: '',
                tabStripPosition: core_enum_1.TabStripPosition.bottom,
                // 标签条位于左侧或右侧时的宽度。 默认值和最小值为 80。
                tabStripWidth: DEFAULT_TAB_STRIP_WIDTH,
                tabEditable: true,
                // 电子表格是否显示特殊选项卡以允许用户插入新工作表。
                newTabVisible: true,
                // 复制或剪切所选项目时是否显示指示器
                cutCopyIndicatorVisible: true,
                // 选择一块区域，用户进行剪切或复制操作后，该区域显示的指示框的颜色
                cutCopyIndicatorBorderColor: '#217346',
                tabNavigationVisible: true,
                backColor: 'white',
                backgroundImage: keyword_null,
                backgroundImageLayout: 0,
                showResizeTip: core_enum_1.ShowResizeTip.none,
                showDragDropTip: true,
                showDragFillTip: true,
                scrollIgnoreHidden: false,
                // 是否高亮无效数据
                highlightInvalidData: false,
                showScrollTip: core_enum_1.ShowScrollTip.none,
                // 用于表示灰色区域（内容区域的空白部分）背景颜色的颜色字符串，如“red”、“#FFFF00”、“rgb(255,0,0)”、“Accent 5”等。
                grayAreaBackColor: keyword_null,
                // 是否使用触摸布局来呈现Spread 组件
                useTouchLayout: false,
                // 当Spread组件没有焦点时是否显示选择高亮
                hideSelection: false,
                // 将行或列的大小调整为零时的绘制策略
                resizeZeroIndicator: core_enum_1.ResizeZeroIndicator.enhanced,
                // 允许用户编辑公式
                allowUserEditFormula: true,
                enableFormulaTextbox: true,
                // 单元格公式中单元格和范围引用的样式。
                referenceStyle: 0,
                allowDynamicArray: false,
                // 是否开启迭代计算
                iterativeCalculation: true,
                iterativeCalculationMaximumIterations: 1000,
                // 迭代计算时的最大变化
                iterativeCalculationMaximumChange: 0.01,
                calcOnDemand: false,
                autoFitType: core_enum_1.AutoFitType.cell,
                allowCopyPasteExcelStyle: true,
                // 如果粘贴范围不足以粘贴，是否扩展粘贴范围。盖值为false且区域不够时不允许黏贴
                allowExtendPasteRange: false,
                copyPasteHeaderOptions: core_enum_1.CopyPasteHeaderOptions.allHeaders,
                // 允许通过鼠标拖拽来合并单元格
                allowUserDragMerge: false,
                rowResizeMode: core_enum_1.ResizeMode.normal,
                columnResizeMode: core_enum_1.ResizeMode.normal,
                // 是否开启像素精度滚动
                scrollByPixel: false,
                // 当 scrollByPixel 为真时，决定一次滚动该像素数。 
                // 最终的滚动像素是滚动增量乘以滚动像素的结果。 
                // 例如，滚动增量为 3，scrollPixel 为 5，最终滚动像素为 15。
                scrollPixel: 5,
                // 是否在电子表格中启用辅助功能支持
                enableAccessibility: false,
                allowAutoCreateHyperlink: true,
                // 滚动条外观
                scrollbarAppearance: core_enum_1.ScrollbarAppearance.skin,
                font: keyword_null,
                customList: [],
                // 当日期/数字数据宽度大于列宽时更改显示模式。
                numbersFitMode: core_enum_1.NumbersFitMode.mask,
                // 是否粘贴跳过不可见范围
                pasteSkipInvisibleRange: false
            };
            // 更改滚动条状态
            function changeScrollbarState(container, show) {
                if (show) {
                    domUtil_1.GC$(container).removeClass(CSS_CLASS_SCROLLBAR_STATE_HIDE);
                } else {
                    domUtil_1.GC$(container).addClass(CSS_CLASS_SCROLLBAR_STATE_HIDE);
                }
            }
            // 刷新VScroll容器
            function refreshVScrollContainer(container, vScrollbarContainerWidth, scrollbarSize) {
                var themeStyle = common_1._ThemeStyleHelper._getCssClassThemeStyle('gc-vertical-scrollbar' + SCROLLBAR_PART_CLASS);
                var paddingRight;
                var paddingLeft;
                var borderWidth = convertToInt(themeStyle.zIndex) > 2007 ? 1 : 0;
                var interspace = vScrollbarContainerWidth - scrollbarSize;
                if (interspace % 2 === 0) {
                    paddingRight = interspace / 2;
                    paddingLeft = paddingRight - borderWidth;
                } else {
                    paddingRight = (interspace - borderWidth) / 2;
                    paddingLeft = paddingRight;
                }
                domUtil_1.GC$(container).css({
                    'box-sizing': CSS_CONTENT_BOX,
                    'border': CSS_NONE,
                    'border-color': CSS_NONE,
                    'border-left-style': CSS_SOLID,
                    'border-left-width': borderWidth + PIXEL,
                    'border-left-color': themeStyle.borderLeftColor,
                    'background-color': themeStyle.backgroundColor,
                    'width': scrollbarSize,
                    'padding': '0px ' + paddingRight + 'px 0px ' + paddingLeft + PIXEL,
                    'margin': 0
                });
            }
            // 刷新HScroll容器
            function refreshHScrollContainer(container, tabStripHeight, scrollbarSize) {
                var themeStyle = common_1._ThemeStyleHelper._getCssClassThemeStyle('gc-horizontal-scrollbar' + SCROLLBAR_PART_CLASS);
                var paddingBottom;
                var paddingTop;
                var borderWidth = convertToInt(themeStyle.zIndex) > 2007 ? 1 : 0;
                var interspace = tabStripHeight - scrollbarSize;
                if (interspace % 2 === 0) {
                    paddingBottom = interspace / 2;
                    paddingTop = paddingBottom - borderWidth;
                } else {
                    paddingBottom = (interspace - borderWidth) / 2;
                    paddingTop = paddingBottom;
                }
                domUtil_1.GC$(container).css({
                    'box-sizing': CSS_CONTENT_BOX,
                    'border': CSS_NONE,
                    'border-color': CSS_NONE,
                    'border-top-style': CSS_SOLID,
                    'border-top-width': borderWidth + PIXEL,
                    'border-top-color': themeStyle.borderTopColor,
                    'background-color': themeStyle.backgroundColor,
                    'height': scrollbarSize,
                    'padding': paddingTop + 'px 0px ' + paddingBottom + 'px 0px',
                    'margin': 0
                });
            }
            // 刷新左上角 
            function refreshCorner(container) {
                var themeStyle = common_1._ThemeStyleHelper._getCssClassThemeStyle('gc-footer-corner' + SCROLLBAR_PART_CLASS);
                domUtil_1.GC$(container).css({
                    'border': CSS_NONE,
                    'padding': 0,
                    'margin': 0,
                    'background-color': themeStyle.backgroundColor
                });
            }
            // 获取水平滚动条命中信息
            function getHorizontalScrollBarHitInfo(scrollbarH, scrollbarHOffset, spreadOffset, x, y) {
                var scrollbarHRect = scrollbarH._getScrollbarRect();
                var horizontalScrollBarX = scrollbarHOffset.left - spreadOffset.left;
                var horizontalScrollBarY = scrollbarHOffset.top - spreadOffset.top;
                if (x > horizontalScrollBarX && x < scrollbarHRect.width + horizontalScrollBarX
                    && y > horizontalScrollBarY && y < scrollbarHRect.height + horizontalScrollBarY) {
                    return {
                        horizontalScrollBarHitInfo: {
                            element: scrollbarH.hitTest(x - horizontalScrollBarX, y - horizontalScrollBarY).element
                        },
                        x: x,
                        y: y
                    };
                }
            }
            function getVerticalScrollBarHitInfo(scrollbarV, scrollbarVOffset, spreadOffset, x, y) {
                var scrollbarVRect = scrollbarV._getScrollbarRect();
                var verticalScrollBarX = scrollbarVOffset.left - spreadOffset.left;
                var verticalScrollBarY = scrollbarVOffset.top - spreadOffset.top;
                if (x > verticalScrollBarX && x < scrollbarVRect.width + verticalScrollBarX
                    && y > verticalScrollBarY && y < scrollbarVRect.height + verticalScrollBarY) {
                    return {
                        verticalScrollBarHitInfo: {
                            element: scrollbarV.hitTest(x - verticalScrollBarX, y - verticalScrollBarY).element
                        },
                        x: x,
                        y: y
                    };
                }
            }
            function getBorderWidth(elem) {
                var $elem = domUtil_1.GC$(elem);
                return {
                    top: _getNormalizedBorderWidth($elem, 'borderTopWidth'),
                    right: _getNormalizedBorderWidth($elem, 'borderRightWidth'),
                    bottom: _getNormalizedBorderWidth($elem, 'borderBottomWidth'),
                    left: _getNormalizedBorderWidth($elem, 'borderLeftWidth')
                };
            }
            function _getNormalizedBorderWidth($elem, type) {
                var borderWidthString = $elem.css(type);
                switch (borderWidthString) {
                    case 'thin':
                        return 1;
                    case 'medium':
                        return 3;
                    case 'thick':
                        return 5;
                    default:
                        return parseFloat(borderWidthString);
                }
            }
            function getPadding(elem) {
                var $elem = domUtil_1.GC$(elem);
                return {
                    top: parseFloat($elem.css('paddingTop')),
                    right: parseFloat($elem.css('paddingRight')),
                    bottom: parseFloat($elem.css('paddingBottom')),
                    left: parseFloat($elem.css('paddingLeft'))
                };
            }
            function getElementActualContentWidth(elem) {
                var width = elem.getBoundingClientRect().width;
                var _a = getBorderWidth(elem), leftBorderWidth = _a.left, rightBorderWidth = _a.right;
                var _b = getPadding(elem), paddingLeft = _b.left, paddingRight = _b.right;
                return width - leftBorderWidth - rightBorderWidth - paddingLeft - paddingRight;
            }
            var Workbook = (function () {
                function Workbook(host, options) {
                    var self = this;
                    self.name = '';
                    self._isResizing = false;
                    self._availableSheetIndex = -1;
                    self._activeSheetIndex = 0;
                    self._activeSheetTabIndex = -1;
                    self._suspendSetFocus = false;
                    // 监听options上的属性变更并绑定回调来处理变更
                    self.options = createOptions(defaultOptions, function (pn, value, old) {
                        self._onOptionChanged(pn, value, old);
                    });
                    self._initOptions(options);
                    if (options && options.backColor === 'white') {
                        self._backColorChanged = true;
                    } else {
                        self._backColorChanged = false;
                    }
                    var sheetCount = 1;
                    if (options) {
                        var options_sheetCount = options.sheetCount;
                        if (typeof options_sheetCount === CONST_NUMBER) {
                            sheetCount = options_sheetCount;
                        }
                    }
                    if (typeof host === 'string') {
                        host = DOCUMENT.getElementById(host);
                    }
                    self._host = host;
                    self._init(sheetCount, host);
                }
                // 命令管理器
                Workbook.prototype.commandManager = function () {
                    return this._commandManager;
                };
                // 撤消管理器
                Workbook.prototype.undoManager = function () {
                    return this._undoManager;
                };
                // 获取自定义填充列表
                Workbook.prototype._getCustomFillingLists = function () {
                    var buildinList = this._getBuildinList(), customList = this._customFillingList;
                    return customList instanceof Array ? customList.concat(buildinList) : buildinList;
                };
                // 获取内置列表
                Workbook.prototype._getBuildinList = function () {
                    var currentCulture = CultureManager.culture(), buildinList = [], buildinListTemp = [], enDateTimeFormat = CultureManager._getCultureInfo(EN_CULTURE).DateTimeFormat, currentDateTimeFormat = CultureManager._getCultureInfo(currentCulture).DateTimeFormat;
                    buildinList = this._getBuildinListByKey(enDateTimeFormat);
                    if (currentCulture !== EN_CULTURE) {
                        buildinListTemp = this._getBuildinListByKey(currentDateTimeFormat);
                    }
                    return buildinList.concat(buildinListTemp);
                };
                // 按key获取内置列表
                Workbook.prototype._getBuildinListByKey = function (dateTimeFormat) {
                    var buildinList = [], names, containMonth;
                    this._buildinListKey = ['abbreviatedDayNames', 'dayNames', 'abbreviatedMonthNames', 'monthNames'];
                    this._buildinListKey.forEach(function (key) {
                        names = dateTimeFormat[key];
                        if (names instanceof Array && names.length > 0) {
                            containMonth = key.indexOf('month') > -1 || key.indexOf('Month') > -1;
                            names = containMonth ? names.slice(0, 12) : names;
                            buildinList.push(names);
                        }
                    });
                    return buildinList;
                };
                // 按需禁用计算
                Workbook.prototype._onDisableCalcOnDemand = function () {
                    var self = this;
                    var calcService = hasCalc && new CalcEngine.CalcSource()._getCalcServiceInternal();
                    if (calcService) {
                        calcService._clearCalcOnDemandDirtyInfo();
                    }
                    this.sheets.forEach(function (sheet) {
                        var sheetSource = sheet._getSheetSource();
                        sheetSource._setCacheItemsToNull();
                    });
                };
                // Workbook的配置变更的处理
                Workbook.prototype._onOptionChanged = function (pn, value, old) {
                    var self = this;
                    var sheet = getActiveSheet(self);
                    var calcService = hasCalc && new CalcEngine.CalcSource()._getCalcServiceInternal();
                    switch (pn) {
                        case 'allowUndo':
                            if (self._undoManager) {
                                self._undoManager._allowUndo = value;
                            }
                            break;
                        case 'backColor':
                            self._backColorChanged = true;
                            if (sheet) {
                                sheet._invalidate();
                            }
                            break;
                        case 'cutCopyIndicatorBorderColor':
                        case 'cutCopyIndicatorVisible':
                        case 'grayAreaBackColor':
                        case 'hideSelection':
                        case 'highlightInvalidData':
                        case 'resizeZeroIndicator':
                        case 'allowUserDragFill':
                        case 'allowUserDragMerge':
                        case 'numbersFitMode':
                        case 'pasteSkipInvisibleRange':
                            if (sheet) {
                                sheet._invalidate();
                            }
                            break;
                        case 'backgroundImage':
                        case 'backgroundImageLayout':
                            self._paintWorkbookBackgroundImage();
                            if (sheet) {
                                sheet._invalidate();
                            }
                            break;
                        case 'newTabVisible':
                        case 'tabNavigationVisible':
                            var tab = self._tabStrip;
                            tab && tab.repaint();
                            break;
                        case 'tabStripPosition':
                            if (value !== old) {
                                self._onTabStripPositionChanged(value);
                            }
                            break;
                        case 'tabStripWidth':
                            if (value !== old) {
                                self._onTabStripAsideWidthChanged(value);
                            }
                            break;
                        case 'showHorizontalScrollbar':
                        case 'showVerticalScrollbar':
                        case 'useTouchLayout':
                        case 'tabStripVisible':
                            self._doResize();
                            break;
                        case 'tabStripRatio':
                            self._doTabHSResize();
                            break;
                        case 'scrollIgnoreHidden':
                        case 'scrollbarMaxAlign':
                        case 'scrollbarShowMax':
                            if (sheet) {
                                sheet._needSyncHScrollbarSize = true;
                                sheet._needSyncVScrollbarSize = true;
                                sheet._invalidate();
                            }
                            break;
                        case 'scrollByPixel':
                            if (sheet) {
                                sheet._needSyncHScrollbarSize = true;
                                sheet._needSyncVScrollbarSize = true;
                                sheet._scrollTopRowOffset = 0;
                                sheet._scrollLeftColOffset = 0;
                                sheet._invalidate();
                            }
                            break;
                        case 'scrollPixel':
                            if (value <= 0) {
                                self.options.scrollPixel = old;
                            }
                            break;
                        case 'scrollbarAppearance':
                            if (self._scrollService) {
                                if (value !== old) {
                                    self._onScrollbarAppearanceChanged(value);
                                }
                            }
                            break;
                        case 'calcOnDemand':
                            if (calcService) {
                                if (!value && calcService.calcOnDemand) {
                                    self._onDisableCalcOnDemand();
                                }
                                calcService.calcOnDemand = value;
                            }
                            break;
                        case 'customList':
                            self._customFillingList = value;
                            break;
                        case 'referenceStyle':
                        case 'allowDynamicArray':
                        case 'iterativeCalculation':
                        case 'iterativeCalculationMaximumIterations':
                        case 'iterativeCalculationMaximumChange':
                            self._sychronizeCalcService(pn, value);
                            if (sheet) {
                                sheet._invalidate();
                            }
                            break;
                    }
                };
                // 滚动条外观已更改
                Workbook.prototype._onScrollbarAppearanceChanged = function (mode) {
                    if (isNullOrUndefined(mode)) {
                        mode = core_enum_1.ScrollbarAppearance.skin;
                    }
                    var self = this;
                    var isMobileScrollbar = mode === core_enum_1.ScrollbarAppearance.mobile;
                    self._vScrollbar._changeMode(mode);
                    self._hScrollbar._changeMode(mode);
                    self._adjustScrollbarDOMStructure();
                    if (isMobileScrollbar) {
                        self._attachMobileScrollbarEvent();
                    } else {
                        self._detachMobileScrollbarEvent();
                    }
                    self.refresh();
                };
                // 选项卡条位置已更改
                Workbook.prototype._onTabStripPositionChanged = function (position) {
                    var self = this;
                    if (isNullOrUndefined(position)) {
                        position = core_enum_1.TabStripPosition.bottom;
                        self.options.tabStripPosition = position;
                    }
                    if (self._table) {
                        self._adjustTabStripDOMStructure();
                        self._refresh();
                        self._doResize();
                    }
                };
                // 选项卡条边宽度已更改
                Workbook.prototype._onTabStripAsideWidthChanged = function (width) {
                    var self = this;
                    if (isNullOrUndefined(width)) {
                        width = DEFAULT_TAB_STRIP_WIDTH;
                        self.options.tabStripWidth = width;
                    } else if (width < DEFAULT_TAB_STRIP_WIDTH) {
                        self.options.tabStripWidth = DEFAULT_TAB_STRIP_WIDTH;
                    }
                    if (self._table) {
                        self._adjustTabStripDOMStructure();
                        self._refresh();
                        self._doResize();
                    }
                };
                // 同步计算服务
                Workbook.prototype._sychronizeCalcService = function (prop, value) {
                    var self = this;
                    var calcService = hasCalc && new CalcEngine.CalcSource()._getCalcServiceInternal();
                    if (calcService) {
                        switch (prop) {
                            case 'referenceStyle':
                                calcService.useR1C1 = (value === 1);
                                break;
                            case 'allowDynamicArray':
                            case 'iterativeCalculation':
                            case 'iterativeCalculationMaximumIterations':
                            case 'iterativeCalculationMaximumChange':
                                calcService[prop] = value;
                                break;
                        }
                    }
                };
                Workbook.prototype._init = function (count, host) {
                    var self = this;
                    hasCalc && self._initCalcService();
                    self._userEvents = [];
                    self._userEventsElem = createElement('input');
                    self._eventSuspended = 0;
                    self._paintSuspended = 0;
                    self._floatingObjectClipboardHelper = {
                        fromSheet: keyword_null,
                        isCutting: false
                    };
                    self._shapeClipboardHelper = {
                        fromSheet: keyword_null,
                        isCutting: false
                    };
                    self._containerDiv = keyword_null;
                    self.sheets = [];
                    self._sheetTabs = [];
                    self._namedStyles = {};
                    self._customFillingList = self.options.customList;
                    self._undoManager = new UndoManager(self, -1, self.options.allowUndo);
                    var commandManager = self._commandManager = new CommandManager(self);
                    commandManager._addInternalListener('beforeWorkbookExecute', function (arg) {
                        self._saveSelectionBeforeCommandExecute(arg);
                    });
                    commandManager.addListener('workbookUndo', function (arg) {
                        var command = arg.command;
                        var inTransaction = worksheet_actions_1.Commands._isInTransaction(command);
                        var undoCmd = self._commandManager[command.cmd];
                        if (undoCmd && undoCmd.canUndo() && !inTransaction && !command._fromUndoManager) {
                            var targetSheet = self.getSheetFromName(command.sheetName);
                            if (targetSheet) {
                                command.sheetId = targetSheet._id;
                            }
                            self.undoManager()._addCommand(command, arg._actionType);
                        }
                        if (arg._actionType === 1 || arg._actionType === 2) {
                            self._restoreSelectionAfterCommandExecuted(arg);
                        }
                    });
                    worksheet_actions_1.Commands._initWorkbookCommands(commandManager);
                    Workbook._callFeatureHandler(self, 'init');
                    for (var i = 0; i < count; i++) {
                        var sheet = self._createSheet(self._getDefaultSheetName(i));
                        self.sheets.push(sheet);
                        sheet._onAttached(self);
                    }
                    var activeSheet = self.sheets[self._activeSheetIndex];
                    if (activeSheet) {
                        activeSheet.isSelected(true);
                    }
                    self.suspendPaint();
                    if (host) {
                        self._setHost(host);
                    }
                    self._clipboardHelper = new clipboardhelper_1._ClipboardHelper(self);
                    self.resumePaint();
                };
                // 命中测试
                Workbook.prototype.hitTest = function (x, y, ignoreProtected) {
                    var self = this;
                    var sheet = self._getActiveSheetOrSheetTab();
                    var tab = self._tabStrip;
                    var scrollbarH = self._hScrollbar;
                    var scrollbarV = self._vScrollbar;
                    var spreadWidth = domUtil_1.GC$(self.getHost()).width();
                    var spreadHeight = domUtil_1.GC$(self.getHost()).height();
                    if (x < 0 || x > spreadWidth || (!this.options.tabStripHost && y < 0) || y > spreadHeight) {
                        return keyword_null;
                    }
                    var spreadOffset = self._getSpreadOffset();
                    var isMobileScrollbar = self.options.scrollbarAppearance === core_enum_1.ScrollbarAppearance.mobile;
                    if (isMobileScrollbar) {
                        var mobileScrollbarHOffset = domUtil_1.GC$(self._hScrollbarContainer).offset();
                        var resultH = getHorizontalScrollBarHitInfo(scrollbarH, mobileScrollbarHOffset, spreadOffset, x, y);
                        if (resultH) {
                            return resultH;
                        }
                        var mobileScrollbarVOffset = domUtil_1.GC$(self._vScrollbarContainer).offset();
                        var resultV = getVerticalScrollBarHitInfo(scrollbarV, mobileScrollbarVOffset, spreadOffset, x, y);
                        if (resultV) {
                            return resultV;
                        }
                    }
                    if (sheet) {
                        var sheetOffset = sheet._getCanvasOffset();
                        var sheetRect = sheet._getBounds();
                        var sheetX = sheetOffset.left - spreadOffset.left;
                        var sheetY = sheetOffset.top - spreadOffset.top;
                        if (
                            x > sheetX
                            && x < sheetRect.width + sheetX
                            && y > sheetY
                            && y < sheetRect.height + sheetY
                        ) {
                            return {
                                worksheetHitInfo: sheet.hitTest(x - sheetX, y - sheetY, false, ignoreProtected),
                                x: x,
                                y: y
                            };
                        }
                    }
                    var tabOffset = domUtil_1.GC$(tab._getCanvas()).offset();
                    var tabRect = tab._getBounds();
                    var tabX = tabOffset.left - spreadOffset.left;
                    var tabY = tabOffset.top - spreadOffset.top;
                    if (
                        x > tabX
                        && x < tabRect.width + tabX
                        && y > tabY
                        && y < tabRect.height + tabY
                    ) {
                        var tabStripInfo = tab.hitTest(x - tabX, y - tabY);
                        var tabStripHitInfo = {};
                        var sheetIndex = tabStripInfo.index;
                        var hittedSheet = self._getSheetOrSheetTab(sheetIndex);
                        var sheetName = hittedSheet && hittedSheet.name();
                        switch (tabStripInfo.type) {
                            case 'navButton':
                                tabStripHitInfo = {
                                    navButton: tabStripInfo.element
                                };
                                break;
                            case 'sheetTab':
                                tabStripHitInfo = {
                                    sheetTab: {
                                        sheetName: sheetName || tabStripInfo.element,
                                        sheetIndex: sheetIndex
                                    }
                                };
                                break;
                            case 'resize':
                                tabStripHitInfo = {
                                    resize: true
                                };
                                break;
                            default:
                                tabStripHitInfo = {
                                    blank: true
                                };
                                break;
                        }
                        let baseHitInfo = {
                            tabStripHitInfo: tabStripHitInfo,
                            x: x,
                            y: y
                        };
                        if (tabStripInfo.type && this.options.tabStripHost) {
                            baseHitInfo.tabBasedX = x - tabX;
                            baseHitInfo.tabBasedY = y - tabY;
                        }
                        return baseHitInfo;
                    }
                    var scrollbarHOffset = domUtil_1.GC$(scrollbarH._getScrollbar()).offset();
                    var scrollbarHRect = scrollbarH._getScrollbarRect();
                    var horizontalScrollBarX = scrollbarHOffset.left - spreadOffset.left;
                    var horizontalScrollBarY = scrollbarHOffset.top - spreadOffset.top;
                    if (
                        x > horizontalScrollBarX
                        && x < scrollbarHRect.width + horizontalScrollBarX
                        && y > horizontalScrollBarY
                        && y < scrollbarHRect.height + horizontalScrollBarY
                    ) {
                        return {
                            horizontalScrollBarHitInfo: {
                                element: scrollbarH.hitTest(x - horizontalScrollBarX, y - horizontalScrollBarY).element
                            },
                            x: x,
                            y: y
                        };
                    }
                    var scrollbarVOffset = domUtil_1.GC$(scrollbarV._getScrollbar()).offset();
                    var scrollbarVRect = scrollbarV._getScrollbarRect();
                    var verticalScrollBarX = scrollbarVOffset.left - spreadOffset.left;
                    var verticalScrollBarY = scrollbarVOffset.top - spreadOffset.top;
                    if (
                        x > verticalScrollBarX
                        && x < scrollbarVRect.width + verticalScrollBarX
                        && y > verticalScrollBarY
                        && y < scrollbarVRect.height + verticalScrollBarY
                    ) {
                        return {
                            verticalScrollBarHitInfo: {
                                element: scrollbarV.hitTest(x - verticalScrollBarX, y - verticalScrollBarY).element
                            },
                            x: x,
                            y: y
                        };
                    }
                    var footerOffset = domUtil_1.GC$(self._footerCorner).offset();
                    var footerWidth = parseInt(self._footerCorner.style.width.substr(0, self._footerCorner.style.width.indexOf('px')), 10);
                    var footerHeight = parseInt(self._footerCorner.style.height.substr(0, self._footerCorner.style.height.indexOf('px')), 10);
                    var footerX = footerOffset.left - spreadOffset.left;
                    var footerY = footerOffset.top - spreadOffset.top;
                    if (
                        x > footerX
                        && x < footerWidth + footerX
                        && y > footerY
                        && y < footerHeight + footerY
                    ) {
                        return {
                            footerCornerHitInfo: {
                                element: 'footerCorner'
                            },
                            x: x,
                            y: y
                        };
                    }
                };
                Workbook.prototype._getSpreadOffset = function () {
                    var spread = this, t;
                    if ($) {
                        t = $(spread._host).offset();
                    } else {
                        t = domUtil_1.GC$(spread._host).offset();
                    }
                    if (t) {
                        t.top += DOCUMENT.body.clientTop || 0;
                        t.left += DOCUMENT.body.clientLeft || 0;
                    } else {
                        t = {
                            top: 0,
                            left: 0
                        };
                    }
                    return t;
                };
                Workbook.prototype._initOptions = function (options) {
                    var ownOptions = this.options;
                    var workbookOptions = options || {};
                    workbookOptions = $$_extend(true, {}, defaultOptions, workbookOptions);
                    $$_each(workbookOptions, function (p, v) {
                        if (ownOptions.hasOwnProperty(p)) {
                            ownOptions[p] = v;
                        }
                    });
                };
                // 获取选项卡容器div
                Workbook.prototype._getTabbarContainerDiv = function (className) {
                    var self = this;
                    if (!self._tabContainerDiv && self.options.tabStripHost) {
                        self._tabContainerDiv = createElement(TAG_DIV);
                        domUtil_1.GC$(self._tabContainerDiv).css({
                            position: 'relative',
                            left: 0,
                            top: 0,
                            height: 0
                        });
                        domUtil_1.GC$(self.options.tabStripHost).prepend(self._tabContainerDiv);
                    }
                    if (className) {
                        self._tabContainerDiv.className = className;
                    } else {
                        self._tabContainerDiv.className = '';
                    }
                    return self._tabContainerDiv;
                };
                // 获取容器div
                Workbook.prototype._getContainerDiv = function (className) {
                    var self = this;
                    if (!self._containerDiv && self._host) {
                        self._containerDiv = createElement(TAG_DIV);
                        domUtil_1.GC$(self._containerDiv).css({
                            position: 'relative',
                            left: 0,
                            top: 0,
                            height: 0
                        });
                        domUtil_1.GC$(self._host).prepend(self._containerDiv);
                    }
                    if (className) {
                        self._containerDiv.className = className;
                    } else {
                        self._containerDiv.className = '';
                    }
                    return self._containerDiv;
                };
                // 获取默认工作表名称
                Workbook.prototype._getDefaultSheetName = function (sheetIndex) {
                    var self = this;
                    var sheetCount = self.getSheetCount();
                    if (self._availableSheetIndex < sheetCount) {
                        self._availableSheetIndex = sheetCount;
                    } else {
                        self._availableSheetIndex++;
                    }
                    if (isNullOrUndefined(sheetIndex) || sheetIndex < self._availableSheetIndex) {
                        sheetIndex = self._availableSheetIndex;
                    }
                    var conflict = false;
                    var name;
                    var sheets = self.sheets;
                    do {
                        name = (getSR().SHEET_NAME || 'Sheet') + (sheetIndex + 1);
                        var len = sheets.length;
                        for (var i = 0; i < len; i++) {
                            var sheet = sheets[i];
                            if (sheet) {
                                if (sheet.name().toUpperCase() === name.toUpperCase()) {
                                    sheetIndex++;
                                    conflict = true;
                                    break;
                                } else if (conflict) {
                                    conflict = false;
                                }
                            }
                        }
                    } while (conflict);
                    return name;
                };
                // 创建工作表
                Workbook.prototype._createSheet = function (sheetName) {
                    return new worksheet_1.Worksheet(sheetName);
                };
                // 
                Workbook.prototype.setHost = function (host) {
                    this._setHost(host);
                };
                Workbook.prototype._setHost = function (host) {
                    var self = this;
                    if (host) {
                        self._host = host;
                        self._setStoreKey();
                        self._createDummyObjects();
                        self._setCulture();
                        self._createContainers();
                        self._createViewport();
                        self._createVerticalScrollbar();
                        self._createBottomTable();
                        self._createTabStrip();
                        self._createHorizontalScrollbar();
                        self._createCorner();
                        self._attachSkinScrollbarEvent();
                        self._attachMobileScrollbarEvent();
                        self._attachScrollService();
                        self._adjustTableStructure();
                        self._initWindowResizeHandler();
                        self._setActiveSheetHost();
                        self._refresh();
                        self._doResize();
                        self._createFocusElementForTab(host);
                        Workbook._callFeatureHandler(self, 'setHost', host);
                    }
                };
                // 设置存储key
                Workbook.prototype._setStoreKey = function () {
                    var self = this;
                    var host = self._host;
                    if ($) {
                        $(host).data(STORE_KEY, self);
                    }
                    domUtil_1.GC$(host)
                        .data(STORE_KEY, self)
                        .attr(GC_UIELEMENT, 'gcSpread')
                        .addClass(NO_USER_SELECT)
                        .css(OVERFLOW, VISIBLE);
                };
                // 
                Workbook.prototype._createDummyObjects = function () {
                    WINDOW._gcGlobal._createDummyObjects();
                };
                // 
                Workbook.prototype._setCulture = function () {
                    var self = this;
                    self.cultureChangedHandler = function () {
                        self._onCultureChanged();
                    };
                    DOCUMENT.addEventListener(CULTURE_CHANGED_EVENT, self.cultureChangedHandler);
                };
                // 创建容器
                Workbook.prototype._createContainers = function () {
                    var self = this;
                    self._createLeftAside();
                    self._createTable();
                    self._createRightAside();
                };
                // 创建表格
                Workbook.prototype._createTable = function () {
                    var self = this;
                    var host = self._host;
                    var table = createElement(TAG_TABLE);
                    var tableStyle = table.style;
                    table.cellSpacing = '0px';
                    table.cellPadding = '0px';
                    table.border = '0';
                    tableStyle.width = CSS_HUNDRED_PERCENT;
                    tableStyle.height = CSS_HUNDRED_PERCENT;
                    tableStyle.border = '0';
                    tableStyle.margin = '0';
                    tableStyle.borderCollapse = 'collapse';
                    tableStyle.tableLayout = 'fixed';
                    tableStyle.float = 'left';
                    for (var i = 0; i < 3; i++) {
                        var tr = createElement('tr');
                        for (var j = 0; j < 2; j++) {
                            var td = createElement('td');
                            var tdStyle = td.style;
                            tdStyle.padding = '0';
                            tdStyle.border = '0';
                            tr.appendChild(td);
                        }
                        table.appendChild(tr);
                    }
                    host.appendChild(table);
                    self._table = table;
                };
                // 创建左侧
                Workbook.prototype._createLeftAside = function () {
                    var self = this;
                    var host = self._host;
                    var leftAside = createElement(TAG_DIV);
                    var leftAsideStyle = leftAside.style;
                    leftAsideStyle.width = '0';
                    leftAsideStyle.height = '0';
                    leftAsideStyle.float = 'left';
                    host.appendChild(leftAside);
                    self._leftAside = leftAside;
                };
                // 
                Workbook.prototype._createRightAside = function () {
                    var self = this;
                    var host = self._host;
                    var rightAside = createElement(TAG_DIV);
                    var rightAsideStyle = rightAside.style;
                    rightAsideStyle.width = '0';
                    rightAsideStyle.height = '0';
                    rightAsideStyle.float = 'left';
                    host.appendChild(rightAside);
                    self._rightAside = rightAside;
                };
                // 创建视口
                Workbook.prototype._createViewport = function () {
                    var self = this;
                    var host = self._host;
                    var table = self._table;
                    var viewportContainer = table.rows[1].cells[0];
                    var viewport = createElement(TAG_DIV);
                    viewport.id = host.id + 'vp';
                    domUtil_1.GC$(viewportContainer).append(viewport);
                    self._vp = viewport;
                };
                // 创建垂直滚动条
                Workbook.prototype._createVerticalScrollbar = function () {
                    var self = this;
                    var table = self._table;
                    var vSkinScrollbarContainer = table.rows[1].cells[1];
                    var options = self.options;
                    var scrollByPixel = options.scrollByPixel;
                    var scrollbarAppearance = options.scrollbarAppearance;
                    var scrollType = scrollByPixel ? core_enum_1.ScrollType.pixels : core_enum_1.ScrollType.continuous;
                    var vScrollbarInstance = new workbookpanelex_1._Scrollbar(false, keyword_null, keyword_null, keyword_null, keyword_null, keyword_null, scrollType, scrollbarAppearance, function () {
                        self._syncScrollbarState(true);
                    });
                    var vScrollbarContainer = createElement(TAG_DIV);
                    var vScrollbarElement = vScrollbarInstance._getScrollbar();
                    domUtil_1.GC$(vScrollbarContainer).append(vScrollbarElement);
                    self._vScrollbar = vScrollbarInstance;
                    self._vScrollbarContainer = vScrollbarContainer;
                    self._vSkinScrollbarContainer = vSkinScrollbarContainer;
                };
                // 附加垂直滚动条事件
                Workbook.prototype._attachVerticalScrollbarEvent = function () {
                    var self = this;
                    var vScrollbarElement = self._vScrollbar._getScrollbar();
                    domUtil_1.GC$(vScrollbarElement).bind(E_SCROLL + NS_SCROLLBAR, function (e, args) {
                        var scrollEventType = args.scrollEventType;
                        e.data = self;
                        if (args.scrollOrientation === workbookpanelex_1.ScrollOrientation.verticalScroll) {
                            if (
                                scrollEventType === core_enum_1._ScrollEventType.smallDecrement
                                || scrollEventType === core_enum_1._ScrollEventType.smallIncrement
                                || scrollEventType === core_enum_1._ScrollEventType.largeDecrement
                                || scrollEventType === core_enum_1._ScrollEventType.largeIncrement
                                || scrollEventType === core_enum_1._ScrollEventType.thumbTrack
                            ) {
                                ScrollService._vscrollDelegate(e, args);
                            } else if (scrollEventType === core_enum_1._ScrollEventType.thumbPosition) {
                                ScrollService._vScrollStop(e);
                            }
                        }
                    }).bind(E_MOUSEDOWN + NS_SCROLLBAR, function (e) {
                        e.data = self;
                        ScrollService._vScrollMouseDown(e);
                    }).bind(E_MOUSEUP + NS_SCROLLBAR, function (e) {
                        e.data = self;
                        ScrollService._scrollMouseUp(e);
                    }).bind(E_MOUSEMOVE + NS_SCROLLBAR, function (e) {
                        e.data = self;
                        e.scrollbar = self._vScrollbar;
                        ScrollService._scrollMouseMove(e);
                    });
                };
                // 创建底部表格
                Workbook.prototype._createBottomTable = function () {
                    var self = this;
                    var table = self._table;
                    var bottomTableContainer = table.rows[2].cells[0];
                    var bottomTable = createElement(TAG_TABLE);
                    var bottomTableStyle = bottomTable.style;
                    bottomTable.cellSpacing = '0';
                    bottomTable.cellPadding = '0';
                    bottomTable.border = '0';
                    bottomTableStyle.border = '0';
                    bottomTableStyle.margin = '0';
                    domUtil_1.GC$(bottomTable).css('user-select', CSS_NONE);
                    var tr = createElement('tr');
                    for (var i = 0; i < 2; i++) {
                        var td = createElement('td');
                        var tdStyle = td.style;
                        tdStyle.padding = '0';
                        tdStyle.border = '0';
                        tr.appendChild(td);
                    }
                    bottomTable.appendChild(tr);
                    domUtil_1.GC$(bottomTableContainer).append(bottomTable);
                    self._bottomTable = bottomTable;
                };
                // 创建标签条
                Workbook.prototype._createTabStrip = function () {
                    var self = this;
                    var host = self._host;
                    var tabs = createElement(TAG_DIV);
                    var tabsStyle = tabs.style;
                    tabsStyle.width = '100%;'; // '' + self._getActualTabStripRatio() * domUtil_1.GC$(host).width() + PIXEL;
                    tabsStyle.height = '' + self._getBottomTableHeight() + PIXEL;
                    tabsStyle.fontSize = '10pt';
                    tabsStyle.fontFamily = 'Arial';
                    self._tabStripContainer = tabs;
                };
                // 创建水平滚动条
                Workbook.prototype._createHorizontalScrollbar = function () {
                    var self = this;
                    var bottomTable = self._bottomTable;
                    var hSkinScrollbarContainer = bottomTable.rows[0].cells[1];
                    var options = self.options;
                    var scrollByPixel = options.scrollByPixel;
                    var scrollbarAppearance = options.scrollbarAppearance;
                    var scrollType = scrollByPixel ? core_enum_1.ScrollType.pixels : core_enum_1.ScrollType.continuous;
                    var hScrollbarInstance = new workbookpanelex_1._Scrollbar(true, keyword_null, keyword_null, keyword_null, keyword_null, keyword_null, scrollType, scrollbarAppearance, function () {
                        self._syncScrollbarState(false);
                    });
                    var hScrollbarElement = hScrollbarInstance._getScrollbar();
                    var hScrollbarContainer = createElement(TAG_DIV);
                    domUtil_1.GC$(hScrollbarContainer).append(hScrollbarElement);
                    self._hScrollbar = hScrollbarInstance;
                    self._hScrollbarContainer = hScrollbarContainer;
                    self._hSkinScrollbarContainer = hSkinScrollbarContainer;
                };
                Workbook.prototype._attachHorizontalScrollbarEvent = function () {
                    var self = this;
                    var hScrollbarElement = self._hScrollbar._getScrollbar();
                    domUtil_1.GC$(hScrollbarElement).bind(E_SCROLL + NS_SCROLLBAR, function (e, args) {
                        var scrollEventType = args.scrollEventType;
                        e.data = self;
                        if (args.scrollOrientation === workbookpanelex_1.ScrollOrientation.horizontalScroll) {
                            if (scrollEventType === core_enum_1._ScrollEventType.smallDecrement
                                || scrollEventType === core_enum_1._ScrollEventType.smallIncrement
                                || scrollEventType === core_enum_1._ScrollEventType.largeDecrement
                                || scrollEventType === core_enum_1._ScrollEventType.largeIncrement
                                || scrollEventType === core_enum_1._ScrollEventType.thumbTrack
                            ) {
                                ScrollService._hscrollDelegate(e, args);
                            } else if (scrollEventType === core_enum_1._ScrollEventType.thumbPosition) {
                                ScrollService._hScrollStop(e);
                            }
                        }
                    }).bind(E_MOUSEDOWN + NS_SCROLLBAR, function (e) {
                        e.data = self;
                        ScrollService._hScrollMouseDown(e);
                    }).bind(E_MOUSEUP + NS_SCROLLBAR, function (e) {
                        e.data = self;
                        ScrollService._scrollMouseUp(e);
                    }).bind(E_MOUSEMOVE + NS_SCROLLBAR, function (e) {
                        e.data = self;
                        e.scrollbar = self._hScrollbar;
                        ScrollService._scrollMouseMove(e);
                    });
                };
                // 创建角落
                Workbook.prototype._createCorner = function () {
                    var self = this;
                    self._createHeaderCorner();
                    self._createFooterCorner();
                };
                //
                Workbook.prototype._createHeaderCorner = function () {
                    var self = this;
                    var table = self._table;
                    var headerCornerContainer = table.rows[0].cells[1];
                    var headerCorner = createElement(TAG_DIV);
                    domUtil_1.GC$(headerCornerContainer).append(headerCorner);
                    self._headerCorner = headerCorner;
                };
                // 
                Workbook.prototype._createFooterCorner = function () {
                    var self = this;
                    var table = self._table;
                    var footerCornerContainer = table.rows[2].cells[1];
                    var footerCorner = createElement(TAG_DIV);
                    domUtil_1.GC$(footerCornerContainer).append(footerCorner);
                    self._footerCorner = footerCorner;
                };
                Workbook.prototype._attachScrollService = function () {
                    var self = this;
                    self._scrollService = new ScrollService(self);
                };
                Workbook.prototype._attachSkinScrollbarEvent = function () {
                    var self = this;
                    self._attachVerticalScrollbarEvent();
                    self._attachHorizontalScrollbarEvent();
                };
                Workbook.prototype._attachMobileScrollbarEvent = function () {
                    var self = this;
                    var options = self.options;
                    var scrollbarAppearance = options.scrollbarAppearance;
                    if (scrollbarAppearance === core_enum_1.ScrollbarAppearance.mobile) {
                        var host = self._host;
                        var scrollbarVContainer = self._vScrollbarContainer;
                        var scrollbarHContainer = self._hScrollbarContainer;
                        domUtil_1.GC$(scrollbarVContainer)
                            .bind(E_MOUSEENTER, function () {
                                self._vScrollbar._updateState(core_enum_1.ScrollbarState.active);
                            })
                            .bind(E_MOUSELEAVE, function () {
                                self._vScrollbar._updateState(core_enum_1.ScrollbarState.inactive);
                            });
                        domUtil_1.GC$(scrollbarHContainer)
                            .bind(E_MOUSEENTER, function () {
                                self._hScrollbar._updateState(core_enum_1.ScrollbarState.active);
                            })
                            .bind(E_MOUSELEAVE, function () {
                                self._hScrollbar._updateState(core_enum_1.ScrollbarState.inactive);
                            });
                        domUtil_1.GC$(host)
                            .bind(E_MOUSEENTER, self._updateMobileScrollbarOnMouseEnterHost)
                            .bind(E_MOUSELEAVE, self._updateMobileScrollbarOnMouseLeaveHost);
                    }
                };
                Workbook.prototype._detachMobileScrollbarEvent = function () {
                    var self = this;
                    var scrollbarVContainer = self._vScrollbarContainer;
                    var scrollbarHContainer = self._hScrollbarContainer;
                    if (scrollbarVContainer) {
                        domUtil_1.GC$(scrollbarVContainer)
                            .unbind(E_MOUSEENTER)
                            .unbind(E_MOUSELEAVE);
                        self._scrollService._stopHideScrollBarTimer(true);
                    }
                    if (scrollbarHContainer) {
                        domUtil_1.GC$(scrollbarHContainer)
                            .unbind(E_MOUSEENTER)
                            .unbind(E_MOUSELEAVE);
                        self._scrollService._stopHideScrollBarTimer(false);
                    }
                    domUtil_1.GC$(self._host)
                        .unbind(E_MOUSEENTER, self._updateMobileScrollbarOnMouseEnterHost)
                        .bind(E_MOUSELEAVE, self._updateMobileScrollbarOnMouseLeaveHost);
                };
                Workbook.prototype._updateMobileScrollbarOnMouseEnterHost = function () {
                    domUtil_1.GC$(this).find('.' + CSS_CLASS_SCROLLBAR_MOBILE_CONTAINER).addClass(CSS_CLASS_SCROLLBAR_MOBILE_HOST_HOVERING);
                };
                Workbook.prototype._updateMobileScrollbarOnMouseLeaveHost = function () {
                    domUtil_1.GC$(this).find('.' + CSS_CLASS_SCROLLBAR_MOBILE_CONTAINER).removeClass(CSS_CLASS_SCROLLBAR_MOBILE_HOST_HOVERING);
                };
                // 调整表结构
                Workbook.prototype._adjustTableStructure = function () {
                    var self = this;
                    self._adjustTabStripDOMStructure();
                    self._adjustScrollbarDOMStructure();
                };
                Workbook.prototype._adjustScrollbarDOMStructure = function () {
                    var self = this;
                    var host = self._host;
                    if (!self._scrollService) {
                        return;
                    }
                    var isMobileScrollbar = self.options.scrollbarAppearance === core_enum_1.ScrollbarAppearance.mobile;
                    var skinScrollbarVHost = self._vSkinScrollbarContainer;
                    var skinScrollbarHHost = self._hSkinScrollbarContainer;
                    var scrollbarVContainer = self._vScrollbarContainer;
                    var scrollbarHContainer = self._hScrollbarContainer;
                    domUtil_1.GC$(scrollbarVContainer).removeAttr('style');
                    domUtil_1.GC$(scrollbarHContainer).removeAttr('style');
                    if (!isMobileScrollbar) {
                        domUtil_1.GC$(skinScrollbarVHost).append(scrollbarVContainer);
                        domUtil_1.GC$(skinScrollbarHHost).append(scrollbarHContainer);
                        domUtil_1.GC$(scrollbarVContainer).removeClass(CSS_CLASS_SCROLLBAR_MOBILE_CONTAINER + ' ' + CSS_CLASS_SCROLLBAR_STATE_HIDE + ' ' + CSS_CLASS_SCROLLBAR_MOBILE_VERTICAL + ' ' + CSS_CLASS_SCROLLBAR_STATE_HOVER);
                        domUtil_1.GC$(scrollbarHContainer).removeClass(CSS_CLASS_SCROLLBAR_MOBILE_CONTAINER + ' ' + CSS_CLASS_SCROLLBAR_STATE_HIDE + ' ' + CSS_CLASS_SCROLLBAR_MOBILE_HORIZONTAL + ' ' + CSS_CLASS_SCROLLBAR_STATE_HOVER);
                        domUtil_1.GC$(host).css('position', 'auto');
                    } else {
                        scrollbarVContainer.style.position = 'absolute';
                        scrollbarVContainer.style.top = '0px';
                        scrollbarVContainer.style.left = '0px';
                        domUtil_1.GC$(scrollbarVContainer).addClass(CSS_CLASS_SCROLLBAR_MOBILE_CONTAINER + ' ' + CSS_CLASS_SCROLLBAR_MOBILE_VERTICAL);
                        domUtil_1.GC$(host).css('position', 'relative').append(scrollbarVContainer);
                        scrollbarHContainer.style.position = 'absolute';
                        scrollbarHContainer.style.top = '0px';
                        scrollbarHContainer.style.left = '0px';
                        domUtil_1.GC$(scrollbarHContainer).addClass(CSS_CLASS_SCROLLBAR_MOBILE_CONTAINER + ' ' + CSS_CLASS_SCROLLBAR_MOBILE_HORIZONTAL);
                        domUtil_1.GC$(host).append(scrollbarHContainer);
                    }
                };
                Workbook.prototype._adjustTabStripDOMStructure = function () {
                    var self = this;
                    var table = self._table;
                    var bottomTable = self._bottomTable;
                    var tabStripContainer = self._tabStripContainer;
                    var tabStripPosition = self.options.tabStripPosition;
                    var tabStripHost = self.options.tabStripHost;
                    if (!tabStripHost) {
                        if (tabStripPosition === core_enum_1.TabStripPosition.bottom) {
                            tabStripHost = bottomTable.rows[0].cells[0];
                        } else if (tabStripPosition === core_enum_1.TabStripPosition.top) {
                            tabStripHost = table.rows[0].cells[0];
                        } else if (tabStripPosition === core_enum_1.TabStripPosition.left) {
                            tabStripHost = self._leftAside;
                        } else if (tabStripPosition === core_enum_1.TabStripPosition.right) {
                            tabStripHost = self._rightAside;
                        }
                    }
                    domUtil_1.GC$(tabStripHost).append(tabStripContainer);
                };
                // 为选项卡创建焦点元素
                Workbook.prototype._createFocusElementForTab = function (host) {
                    var self = this;
                    var TAB_INDEX = 'tabindex';
                    var tabIndex = convertToInt(domUtil_1.GC$(host).attr(TAB_INDEX), 10) || 0;
                    var focusElement = createElement(TAG_DIV);
                    domUtil_1.GC$(focusElement).css({
                        position: CSS_ABSOLUTE,
                        overflow: 'hidden'
                    }).attr(GC_UIELEMENT, 'gcSheetFocusElementForTab')
                        .attr(TAB_INDEX, tabIndex)
                        .bind(E_FOCUS, function () {
                            if (!self._ignoreFocusEvent) {
                                getActiveSheet(self)._setFocus();
                            }
                            self._ignoreFocusEvent = false;
                        });
                    host.insertBefore(focusElement, keyword_null);
                    self._tabFocusElement = focusElement;
                };
                // 初始化窗口调整处理程序
                Workbook.prototype._initWindowResizeHandler = function () {
                    var self = this;
                    var windowResizeHandler = function () {
                        self._doWindowResize();
                    };
                    domUtil_1.GC$(WINDOW).bind(E_RESIZE + NS_SPREAD, windowResizeHandler);
                    self._windowResizeHandler = windowResizeHandler;
                };
                // 
                Workbook.prototype._setActiveSheetHost = function () {
                    var self = this;
                    var sheet = getActiveSheet(self);
                    if (sheet) {
                        sheet._setHost(self._vp);
                    }
                };
                // 焦点选项卡焦点元素
                Workbook.prototype._focusTabFocusElement = function () {
                    var self = this;
                    var focusElement = self._tabFocusElement;
                    if (focusElement) {
                        self._ignoreFocusEvent = true;
                        focusElement.focus();
                    }
                };
                // 获取焦点元素
                Workbook.prototype._getFocusElement = function () {
                    var activeSheet = this.getActiveSheet();
                    var focusElement;
                    if (activeSheet) {
                        if (common_1._FocusHelper._isActiveElement(activeSheet)) {
                            var host = this._host;
                            if (host) {
                                var activeElement = document.activeElement;
                                var body = document.body;
                                var element = activeElement;
                                while (element) {
                                    if (element === host) {
                                        focusElement = activeElement;
                                        break;
                                    } else if (element === body) {
                                        break;
                                    }
                                    element = element.parentElement;
                                }
                            }
                        } else if (activeSheet._canvas) {
                            focusElement = activeSheet._canvas;
                        }
                    }
                    return focusElement;
                };
                // 更新辅助功能内容
                Workbook.prototype._updateAccessibilityContent = function (content) {
                    var self = this;
                    if (self._ariaTimer) {
                        WINDOW.clearTimeout(self._ariaTimer);
                        self._ariaTimer = keyword_null;
                    }
                    self._ariaTimer = WINDOW.setTimeout(function () {
                        var element = self._getFocusElement();
                        if (element) {
                            element.setAttribute('aria-label', content);
                        }
                        WINDOW.clearTimeout(self._ariaTimer);
                        self._ariaTimer = keyword_null;
                    }, 50);
                };
                Workbook.prototype._dispose = function () {
                    var self = this;
                    var scrollbarH = self._hScrollbar;
                    var scrollbarV = self._vScrollbar;
                    var i;
                    var sheets = self.sheets;
                    var isMobileScrollbar = self.options.scrollbarAppearance === core_enum_1.ScrollbarAppearance.mobile;
                    self._disposeDialog();
                    common_1._DPIHelper._disposeSpread(self);
                    common_1._util._dispose();
                    self._windowResizeHandler && domUtil_1.GC$(WINDOW).unbind(E_RESIZE + NS_SPREAD, self._windowResizeHandler);
                    self._windowResizeHandler = keyword_null;
                    if (self._windowResizeTimer) {
                        clearTimeout(self._windowResizeTimer);
                    }
                    if (scrollbarH) {
                        scrollbarH.dispose();
                    }
                    if (scrollbarV) {
                        scrollbarV.dispose();
                    }
                    self._disposeUserEvents();
                    self._removeTooltip();
                    if (common_1._FocusHelper._getActiveElement() === self.getActiveSheet()) {
                        common_1._FocusHelper._setActiveElement(keyword_null);
                    }
                    for (i = 0; i < sheets.length; i++) {
                        sheets[i]._dispose(true);
                    }
                    sheets.splice(0, sheets.length);
                    var sheetTabs = self._sheetTabs;
                    for (i = 0; i < sheetTabs.length; i++) {
                        sheetTabs[i]._dispose(true);
                    }
                    sheetTabs.splice(0, sheetTabs.length);
                    var clipboardHelper = self._clipboardHelper;
                    if (clipboardHelper) {
                        clipboardHelper._dispose();
                        self._clipboardHelper = keyword_null;
                    }
                    var host = self._host;
                    var $host;
                    var ATTR_CLASS = 'class';
                    var ATTR_UNSELECTABLE = 'unselectable';
                    if (host) {
                        $host = domUtil_1.GC$(host);
                        DOCUMENT.removeEventListener(CULTURE_CHANGED_EVENT, self.cultureChangedHandler);
                        $host.html('')
                            .removeAttr(GC_UIELEMENT)
                            .removeClass(NO_USER_SELECT);
                        if (!$host.attr(ATTR_CLASS)) {
                            $host.removeAttr(ATTR_CLASS);
                        }
                        if (!$host.attr(ATTR_UNSELECTABLE)) {
                            $host.removeAttr(ATTR_UNSELECTABLE);
                        }
                        if ($host.data(STORE_KEY)) {
                            $host.data(STORE_KEY, keyword_null);
                        }
                        if ($ && $(host).data(STORE_KEY)) {
                            $(host).data(STORE_KEY, keyword_null);
                        }
                    }
                    if (isMobileScrollbar) {
                        self._detachMobileScrollbarEvent();
                    }
                    self._hScrollbarContainer = keyword_null;
                    self._vScrollbarContainer = keyword_null;
                    if (self._undoManager) {
                        self._undoManager._dispose();
                        self._undoManager = keyword_null;
                    }
                    if (self._tabStrip) {
                        self._tabStrip._dispose();
                        self._tabStrip = keyword_null;
                    }
                    Workbook._callFeatureHandler(self, 'dispose');
                    if (self._tabFocusElement) {
                        domUtil_1.GC$(self._tabFocusElement).unbind(E_FOCUS);
                        self._tabFocusElement = keyword_null;
                    }
                    if (self._calcService) {
                        self._calcService.dispose();
                        self._calcService = keyword_null;
                        self._spreadSource = keyword_null;
                        self._spreadSourceModel = keyword_null;
                    }
                    if (self._imageLoader) {
                        self._imageLoader._dispose();
                        self._imageLoader = keyword_null;
                    }
                    stylehelper_1._StyleHelper._dispose();
                    if (self._commandManager) {
                        self._commandManager._dispose();
                        self._commandManager = keyword_null;
                    }
                    if (self._scrollService) {
                        self._scrollService._dispose();
                        self._scrollService = keyword_null;
                    }
                };
                // 处置用户事件
                Workbook.prototype._disposeUserEvents = function () {
                    var self = this;
                    var sheets = self.sheets;
                    var i;
                    var sheet;
                    domUtil_1.GC$(self._userEventsElem)
                        .unbind(NS_SPREAD);
                    for (i = 0; i < sheets.length; i++) {
                        sheet = sheets[i];
                        sheet._disposeUserEvents();
                    }
                };
                Workbook.prototype._disposeDialog = function () {
                    var self = this;
                    var currentDialog = self._currentDialogs;
                    if (currentDialog) {
                        for (var _i = 0, currentDialog_1 = currentDialog; _i < currentDialog_1.length; _i++) {
                            var dialog = currentDialog_1[_i];
                            dialog.close && dialog.close();
                        }
                    }
                    self._currentDialogs = [];
                };
                // 刷新
                Workbook.prototype._refresh = function () {
                    var self = this;
                    var themeVersion = convertToInt(common_1._ThemeStyleHelper._getCssClassThemeStyle('').zIndex);
                    var isThemeVersionChanged = themeVersion !== self._themeVersion;
                    if (isThemeVersionChanged) {
                        self._updateThemeVersion(themeVersion);
                    }
                    self._refreshTabStrip(isThemeVersionChanged);
                    self._refreshScrollbar();
                    self._refreshCorner();
                };
                // 更新主题版本
                Workbook.prototype._updateThemeVersion = function (themeVersion) {
                    this._themeVersion = themeVersion;
                };
                // 刷新选项卡栏
                Workbook.prototype._refreshTabStrip = function (isThemeVersionChanged) {
                    var self = this;
                    var host = self._host;
                    var tabStripName = host.getAttribute('id') + '_tabStrip';
                    var tabStrip = self._tabStrip;
                    if (tabStrip && !isThemeVersionChanged) {
                        tabStrip._refreshTabIndicator();
                        tabStrip.repaint();
                    } else {
                        if (tabStrip) {
                            tabStrip._dispose();
                        }
                        tabStrip = new sheettab_1._SheetTab(tabStripName);
                        self._tabStrip = tabStrip;
                        tabStrip._setOwner(self);
                        tabStrip._setHost(self._tabStripContainer);
                    }
                };
                // 刷新滚动条
                Workbook.prototype._refreshScrollbar = function () {
                    var self = this;
                    var isMobileScrollbar = self.options.scrollbarAppearance === core_enum_1.ScrollbarAppearance.mobile;
                    if (!isMobileScrollbar) {
                        var bottomTableHeight = self._getBottomTableHeight();
                        var scrollbarSize = self._getScrollbarSize();
                        var vScrollbarContainerWidth = self._getVScrollbarContainerWidth();
                        refreshVScrollContainer(self._vScrollbarContainer, vScrollbarContainerWidth, scrollbarSize);
                        refreshHScrollContainer(self._hScrollbarContainer, bottomTableHeight, scrollbarSize);
                    } else {
                        self._refreshMobileScrollbar();
                    }
                };
                // 刷新角落
                Workbook.prototype._refreshCorner = function () {
                    var self = this;
                    refreshCorner(self._footerCorner);
                    refreshCorner(self._headerCorner);
                };
                Workbook.prototype._doWindowResize = function () {
                    var self = this;
                    var windowResizeTimer = self._windowResizeTimer;
                    if (windowResizeTimer) {
                        clearTimeout(windowResizeTimer);
                    }
                    self._windowResizeTimer = WINDOW.setTimeout(function () {
                        common_1._DPIHelper._updateDPI();
                        self._doResize();
                        self._windowResizeTimer = keyword_null;
                    }, 100);
                };
                Workbook.prototype._doResize = function () {
                    var self = this;
                    if (self._isResizing) {
                        return;
                    }
                    self._isResizing = true;
                    self._doResizeImp();
                    self._isResizing = false;
                };
                Workbook.prototype._doResizeImp = function () {
                    var self = this;
                    var host = self._host;
                    if (!host) {
                        return;
                    }
                    self._adjustLeftAsideSize();
                    self._adjustTableSize();
                    self._adjustViewportSize();
                    self._adjustRightAsideSize();
                    self._adjustScollbarSize();
                    self._adjustTabStripSize();
                    self._adjustCornerSize();
                    self._fixTableLayout();
                    self._resizeActiveSheet();
                    self._resizeScrollbar();
                    self._resizeTabStrip();
                    self._afterResize();
                };
                Workbook.prototype._adjustLeftAsideSize = function () {
                    var self = this;
                    var leftAside = self._leftAside;
                    if (!leftAside) {
                        return;
                    }
                    var leftAsideStyle = leftAside.style;
                    var options = self.options;
                    var tabStripVisible = options.tabStripVisible;
                    var tabStripPosition = options.tabStripPosition;
                    var tabStripAsideWidth = tabStripVisible ? options.tabStripWidth : 0;
                    var host = self._host;
                    var hostHeight = domUtil_1.GC$(host).height();
                    var leftAsideWidth, leftAsideHeight;
                    if (tabStripPosition === core_enum_1.TabStripPosition.left) {
                        leftAsideWidth = tabStripAsideWidth;
                        leftAsideHeight = hostHeight;
                    } else {
                        leftAsideWidth = 0;
                        leftAsideHeight = 0;
                    }
                    leftAsideStyle.width = '' + leftAsideWidth + PIXEL;
                    leftAsideStyle.height = '' + leftAsideHeight + PIXEL;
                };
                // 调整表格大小
                Workbook.prototype._adjustTableSize = function () {
                    var self = this;
                    var table = self._table;
                    if (!table) {
                        return;
                    }
                    // return;
                    var tableStyle = table.style;
                    var options = self.options;
                    var tabStripVisible = options.tabStripVisible;
                    var tabStripPosition = options.tabStripPosition;
                    var tabStripAsideWidth = options.tabStripWidth;
                    var hostWidth = domUtil_1.GC$(self._host).width();
                    var tableWidth;
                    if (tabStripVisible && (tabStripPosition === core_enum_1.TabStripPosition.left || tabStripPosition === core_enum_1.TabStripPosition.right)) {
                        var actualHostWidth = Math_floor(getElementActualContentWidth(self._host));
                        tableWidth = (actualHostWidth - tabStripAsideWidth) + PIXEL;
                    } else {
                        tableWidth = hostWidth + PIXEL;
                    }
                    tableStyle.width = tableWidth;
                };
                Workbook.prototype._adjustRightAsideSize = function () {
                    var self = this;
                    var rightAside = self._rightAside;
                    if (!rightAside) {
                        return;
                    }
                    var rightAsideStyle = rightAside.style;
                    var options = self.options;
                    var tabStripVisible = options.tabStripVisible;
                    var tabStripPosition = options.tabStripPosition;
                    var tabStripAsideWidth = tabStripVisible ? options.tabStripWidth : 0;
                    var host = self._host;
                    var hostHeight = domUtil_1.GC$(host).height();
                    var rightAsideWidth, rightAsideHeight;
                    if (tabStripPosition === core_enum_1.TabStripPosition.right) {
                        rightAsideWidth = tabStripAsideWidth;
                        rightAsideHeight = hostHeight;
                    } else {
                        rightAsideWidth = 0;
                        rightAsideHeight = 0;
                    }
                    rightAsideStyle.width = '' + rightAsideWidth + PIXEL;
                    rightAsideStyle.height = '' + rightAsideHeight + PIXEL;
                };
                // 调整视口大小
                Workbook.prototype._adjustViewportSize = function () {
                    var self = this;
                    var host = self._host;
                    var $host = domUtil_1.GC$(host);
                    var viewport = self._vp;
                    if (!viewport) {
                        return;
                    }
                    var viewportStyle = viewport.style;
                    var hostWidth = $host.width();
                    var hostHeight = $host.height();
                    var bottomTableHeight = self._getBottomTableHeight();
                    var options = self.options;
                    var showVerticalScrollbar = options.showVerticalScrollbar;
                    var showHorizontalScrollbar = options.showHorizontalScrollbar;
                    var scrollbarAppearance = options.scrollbarAppearance;
                    var tabStripVisible = options.tabStripVisible;
                    var tabStripPosition = options.tabStripPosition;
                    var tabStripAsideWidth = tabStripVisible ? options.tabStripWidth : 0;
                    var isMobileScrollbar = scrollbarAppearance === core_enum_1.ScrollbarAppearance.mobile;
                    var isTabStripInLeftOrRightSide = tabStripPosition === core_enum_1.TabStripPosition.left || tabStripPosition === core_enum_1.TabStripPosition.right;
                    var viewportWidth = isTabStripInLeftOrRightSide ? Math_floor(getElementActualContentWidth(host)) : hostWidth;
                    if (showVerticalScrollbar && !isMobileScrollbar) {
                        var vScrollbarContainerWidth = self._getVScrollbarContainerWidth();
                        viewportWidth -= vScrollbarContainerWidth;
                    }
                    if (isTabStripInLeftOrRightSide) {
                        viewportWidth -= tabStripAsideWidth;
                    }
                    var viewportHeight = hostHeight;
                    if (tabStripPosition === core_enum_1.TabStripPosition.top) {
                        if (showHorizontalScrollbar && !isMobileScrollbar) {
                            viewportHeight -= bottomTableHeight;
                        }
                        if (tabStripVisible && !this.options.tabStripHost) {
                            viewportHeight -= bottomTableHeight;
                        }
                    } else {
                        if ((showHorizontalScrollbar && !isMobileScrollbar) || (tabStripVisible && tabStripPosition === core_enum_1.TabStripPosition.bottom)) {
                            viewportHeight -= bottomTableHeight;
                        }
                    }
                    if (viewportHeight < 2) {
                        viewportHeight = 2;
                    }
                    viewportStyle.width = viewportWidth + PIXEL;
                    viewportStyle.height = viewportHeight + PIXEL;
                };
                Workbook.prototype._adjustScollbarSize = function () {
                    var self = this;
                    var host = self._host, $host = domUtil_1.GC$(host);
                    var viewport = self._vp;
                    if (!viewport) {
                        return;
                    }
                    var hostWidth = $host.width();
                    var viewportHeight = domUtil_1.GC$(viewport).height();
                    var hScrollbar = self._hScrollbar;
                    var vScrollbar = self._vScrollbar;
                    var options = self.options;
                    var showVerticalScrollbar = options.showVerticalScrollbar;
                    var showHorizontalScrollbar = options.showHorizontalScrollbar;
                    var scrollbarAppearance = options.scrollbarAppearance;
                    var tabStripVisible = options.tabStripVisible;
                    var tabStripPosition = options.tabStripPosition;
                    var tabStripAsideWidth = tabStripVisible ? options.tabStripWidth : 0;
                    var isMobileScrollbar = scrollbarAppearance === core_enum_1.ScrollbarAppearance.mobile;
                    var scrollbarSize = self._getScrollbarSize();
                    if (showVerticalScrollbar) {
                        domUtil_1.GC$(self._vScrollbarContainer).show();
                        domUtil_1.GC$(vScrollbar._getScrollbar()).show();
                    } else {
                        domUtil_1.GC$(self._vScrollbarContainer).hide();
                        domUtil_1.GC$(vScrollbar._getScrollbar()).hide();
                    }
                    if (showHorizontalScrollbar) {
                        domUtil_1.GC$(self._hScrollbarContainer).show();
                        domUtil_1.GC$(hScrollbar._getScrollbar()).show();
                    } else {
                        domUtil_1.GC$(self._hScrollbarContainer).hide();
                        domUtil_1.GC$(hScrollbar._getScrollbar()).hide();
                    }
                    var vScrollbarWidth = scrollbarSize;
                    var vScrollbarHeight = viewportHeight;
                    vScrollbar._width(vScrollbarWidth);
                    vScrollbar._height(vScrollbarHeight);
                    var hScrollbarWidth = hostWidth;
                    if (
                        tabStripPosition === core_enum_1.TabStripPosition.left
                        || tabStripPosition === core_enum_1.TabStripPosition.right
                    ) {
                        hScrollbarWidth -= tabStripAsideWidth;
                    }
                    if (
                        tabStripVisible
                        && !isMobileScrollbar
                        && tabStripPosition === core_enum_1.TabStripPosition.bottom
                    ) {
                        var tabStripWidth = self._getActualTabStripWidth();
                        hScrollbarWidth -= tabStripWidth;
                    }
                    if (showVerticalScrollbar && !isMobileScrollbar) {
                        var vScrollbarContainerWidth = self._getVScrollbarContainerWidth();
                        hScrollbarWidth -= vScrollbarContainerWidth;
                    }
                    if (hScrollbarWidth <= 0) {
                        hScrollbarWidth = 1;
                    }
                    var hScrollbarHeight = scrollbarSize;
                    if (
                        !showHorizontalScrollbar
                        && !tabStripVisible
                        && tabStripPosition === core_enum_1.TabStripPosition.bottom
                    ) {
                        hScrollbarHeight = 0;
                    }
                    hScrollbar._width(hScrollbarWidth);
                    hScrollbar._height(hScrollbarHeight);
                };
                Workbook.prototype._getActualTabStripWidth = function () {
                    var self = this;
                    var viewport = self._vp;
                    var options = self.options;
                    var tabStripPosition = options.tabStripPosition;
                    var tabStripAsideWidth = options.tabStripWidth;
                    var availableWidth = domUtil_1.GC$(viewport).width();
                    var tabStripWidth;
                    if (
                        tabStripPosition === core_enum_1.TabStripPosition.bottom
                        || tabStripPosition === core_enum_1.TabStripPosition.top
                    ) {
                        tabStripWidth = Math_round(self._getActualTabStripRatio() * availableWidth);
                        if (
                            tabStripPosition === core_enum_1.TabStripPosition.bottom
                            && tabStripWidth === availableWidth
                        ) {
                            tabStripWidth = availableWidth - 1;
                        }
                    } else {
                        tabStripWidth = tabStripAsideWidth;
                    }
                    return tabStripWidth;
                };
                Workbook.prototype._adjustTabStripSize = function () {
                    var self = this;
                    var host = self._host;
                    var hostHeight = domUtil_1.GC$(host).height();
                    var tabStripContainer = self._tabStripContainer;
                    if (!tabStripContainer) {
                        return;
                    }
                    var tabStripContainerStyle = tabStripContainer.style;
                    var options = self.options;
                    var tabStripVisible = options.tabStripVisible;
                    var tabStripPosition = options.tabStripPosition;
                    var tabStripHeight;
                    if (
                        tabStripPosition === core_enum_1.TabStripPosition.bottom
                        || tabStripPosition === core_enum_1.TabStripPosition.top
                    ) {
                        var bottomTableHeight = self._getBottomTableHeight();
                        tabStripHeight = bottomTableHeight;
                    } else {
                        tabStripHeight = hostHeight;
                    }
                    if (!tabStripVisible) {
                        tabStripHeight = 0;
                    }
                    tabStripContainerStyle.width = '100%'; // '' + tabStripWidth + PIXEL;
                    tabStripContainerStyle.height = '' + tabStripHeight + PIXEL;
                };
                Workbook.prototype._adjustCornerSize = function () {
                    var self = this;
                    var headerCorner = self._headerCorner;
                    var footerCorner = self._footerCorner;
                    var options = self.options;
                    var showVerticalScrollbar = options.showVerticalScrollbar;
                    var showHorizontalScrollbar = options.showHorizontalScrollbar;
                    var tabStripVisible = options.tabStripVisible;
                    var tabStripPosition = options.tabStripPosition;
                    var isMobileScrollbar = options.scrollbarAppearance === core_enum_1.ScrollbarAppearance.mobile;
                    var bottomTableHeight = self._getBottomTableHeight();
                    var headerCornerWidth;
                    var headerCornerHeight;
                    if (tabStripPosition === core_enum_1.TabStripPosition.top) {
                        if (showVerticalScrollbar && !isMobileScrollbar) {
                            var vScrollbarContainerWidth = self._getVScrollbarContainerWidth();
                            headerCornerWidth = vScrollbarContainerWidth;
                        } else {
                            headerCornerWidth = 0;
                        }
                        if (tabStripVisible && !options.tabStripHost) {
                            headerCornerHeight = bottomTableHeight;
                        } else {
                            headerCornerHeight = 0;
                        }
                    } else {
                        headerCornerWidth = 0;
                        headerCornerHeight = 0;
                    }
                    domUtil_1.GC$(headerCorner).css('width', headerCornerWidth + PIXEL);
                    domUtil_1.GC$(headerCorner).css('height', headerCornerHeight + PIXEL);
                    var footerCornerWidth, footerCornerHeight;
                    if (showVerticalScrollbar && !isMobileScrollbar) {
                        footerCornerWidth = vScrollbarContainerWidth;
                    } else {
                        footerCornerWidth = 0;
                    }
                    if (
                        showHorizontalScrollbar
                        || (tabStripVisible && tabStripPosition === core_enum_1.TabStripPosition.bottom)
                    ) {
                        footerCornerHeight = bottomTableHeight;
                        if (isMobileScrollbar) {
                            if (!tabStripVisible) {
                                footerCornerHeight = 0;
                            } else if (tabStripVisible && tabStripPosition !== core_enum_1.TabStripPosition.bottom) {
                                footerCornerHeight = 0;
                            }
                        }
                    } else {
                        footerCornerHeight = 0;
                    }
                    domUtil_1.GC$(footerCorner).css('width', footerCornerWidth + PIXEL);
                    domUtil_1.GC$(footerCorner).css('height', footerCornerHeight + PIXEL);
                };
                Workbook.prototype._fixTableLayout = function () {
                    var self = this;
                    if (!self._vp) {
                        return;
                    }
                    var table = self._table;
                    var options = self.options;
                    var isMobileScrollbar = options.scrollbarAppearance === core_enum_1.ScrollbarAppearance.mobile;
                    var showVerticalScrollbar = options.showVerticalScrollbar;
                    var tableColumnLayout = [
                        domUtil_1.GC$(self._vp).width(),
                        self._getVScrollbarContainerWidth()
                    ];
                    if (isMobileScrollbar || !showVerticalScrollbar) {
                        tableColumnLayout[1] = 0;
                    }
                    table.rows[0].cells[0].style.width = tableColumnLayout[0] + PIXEL;
                    table.rows[0].cells[1].style.width = tableColumnLayout[1] + PIXEL;
                };
                Workbook.prototype._resizeScrollbar = function () {
                    var self = this;
                    var options = self.options;
                    var isMobileScrollbar = options.scrollbarAppearance === core_enum_1.ScrollbarAppearance.mobile;
                    if (isMobileScrollbar) {
                        self._refreshMobileScrollbar();
                    }
                    self._resizeHScrollBar();
                    self._resizeVScrollBar();
                    if (isMobileScrollbar) {
                        self._vScrollbar._updateState(core_enum_1.ScrollbarState.hide);
                        self._hScrollbar._updateState(core_enum_1.ScrollbarState.hide);
                    }
                };
                Workbook.prototype._resizeTabStrip = function () {
                    var self = this;
                    var options = self.options;
                    var tabStripVisible = options.tabStripVisible;
                    if (tabStripVisible) {
                        domUtil_1.GC$(self._tabStripContainer).show();
                    } else {
                        domUtil_1.GC$(self._tabStripContainer).hide();
                    }
                    self._tabStrip && self._tabStrip._doResize();
                };
                Workbook.prototype._resizeActiveSheet = function (resizeSheet) {
                    if (resizeSheet === void 0) {
                        resizeSheet = true;
                    }
                    var self = this;
                    var sheet = common_1._getActiveSheet(self);
                    if (sheet) {
                        if (sheet._scrollTopRow === 0) {
                            sheet._scrollTopRow = sheet._getFirstPageTopRow();
                        }
                        if (sheet._scrollLeftCol === 0) {
                            sheet._scrollLeftCol = sheet._getFirstPageLeftColumn();
                        }
                        if (resizeSheet) {
                            sheet._doResize();
                        }
                    }
                };
                Workbook.prototype._afterResize = function () {
                    var self = this;
                    var sheet = common_1._getActiveSheet(self);
                    if (sheet) {
                        sheet.invalidateLayout();
                        sheet.repaint();
                    }
                    var host = self._host;
                    var $host = domUtil_1.GC$(host);
                    var hostWidth = $host.width();
                    var fixWidth = $host.width();
                    var needAdjust = (hostWidth !== fixWidth && Math_abs(hostWidth - fixWidth) > 2);
                    if (needAdjust && !self._haveLayoutFixing) {
                        self._haveLayoutFixing = true;
                        setTimeout(function () {
                            delete self._haveLayoutFixing;
                            self._doResizeImp();
                        }, 1);
                    }
                };
                Workbook.prototype._refreshMobileScrollbar = function () {
                    var self = this;
                    if (isNullOrUndefined(self._host)) {
                        return;
                    }
                    var $host = domUtil_1.GC$(self._host);
                    var sheet = self.getActiveSheet();
                    if (!sheet) {
                        return;
                    }
                    var $scrollbarVContainer = domUtil_1.GC$(self._vScrollbarContainer);
                    var $scrollbarHContainer = domUtil_1.GC$(self._hScrollbarContainer);
                    var sheetLayout = sheet._getSheetLayout();
                    var hostWidth = $host.width();
                    var hostHeight = $host.height();
                    var paddingBetweenVerticalAndHorizontal = 2;
                    var options = self.options;
                    var tabStripVisible = options.tabStripVisible;
                    var showVerticalScrollbar = options.showVerticalScrollbar;
                    var tabStripPosition = options.tabStripPosition;
                    var tabStripAsideWidth = tabStripVisible ? options.tabStripWidth : 0;
                    var tabStripHeight = tabStripVisible ? self._getBottomTableHeight() : 0;
                    var viewportX = sheetLayout.x + sheetLayout._rowHeaderWidth;
                    var viewportY = sheetLayout.y + sheetLayout._colHeaderHeight;
                    var scrollbarVContainerWidth = showVerticalScrollbar ? this._getScrollbarSize() : 0;
                    var scrollbarVcontainerHeight = hostHeight - viewportY;
                    let scrollbarVcontainerHeightAuto = 'calc(100% - ' + viewportY + PIXEL + ')';
                    if (
                        tabStripPosition === core_enum_1.TabStripPosition.bottom
                        || (tabStripPosition === core_enum_1.TabStripPosition.top && !this.options.tabStripHost)
                    ) {
                        scrollbarVcontainerHeight -= tabStripHeight;
                    }
                    var scrollbarVcontainerRight = 0;
                    if (tabStripPosition === core_enum_1.TabStripPosition.right) {
                        scrollbarVcontainerRight += tabStripAsideWidth;
                    }
                    var scrollbarVcontainerTop = viewportY;
                    if (tabStripPosition === core_enum_1.TabStripPosition.top && !this.options.tabStripHost) {
                        scrollbarVcontainerTop += tabStripHeight;
                    }
                    var scrollbarVcontainerPaddingTop = convertToInt($scrollbarVContainer.css('padding-top'));
                    var scrollbarVcontainerPaddingBottom = convertToInt($scrollbarVContainer.css('padding-bottom'));
                    var scrollbarVScrollableDistance = scrollbarVcontainerHeight - scrollbarVcontainerPaddingTop - scrollbarVcontainerPaddingBottom;
                    var scrollbarHContainerWidth = hostWidth - scrollbarVContainerWidth - viewportX;
                    if (tabStripPosition === core_enum_1.TabStripPosition.left || tabStripPosition === core_enum_1.TabStripPosition.right) {
                        scrollbarHContainerWidth -= tabStripAsideWidth;
                    }
                    var scrollbarHContainerWidthAuto = 'calc(100% - ' + (scrollbarVContainerWidth + viewportX) + PIXEL + ')';
                    var scrollbarHContainerHeight = this._getScrollbarSize();
                    var scrollbarHContainerBottom = 0;
                    if (tabStripPosition === core_enum_1.TabStripPosition.bottom) {
                        scrollbarHContainerBottom += tabStripHeight;
                    }
                    var scrollbarHContainerLeft = viewportX;
                    if (tabStripPosition === core_enum_1.TabStripPosition.left) {
                        scrollbarHContainerLeft += tabStripAsideWidth;
                    }
                    var scrollbarHcontainerPaddingLeft = convertToInt($scrollbarHContainer.css('padding-left'));
                    var scrollbarHcontainerPaddingRight = convertToInt($scrollbarHContainer.css('padding-right'));
                    var scrollbarHScrollableDistance = scrollbarHContainerWidth - scrollbarHcontainerPaddingLeft - scrollbarHcontainerPaddingRight - paddingBetweenVerticalAndHorizontal;
                    self._vScrollbar._width(scrollbarVContainerWidth);
                    self._vScrollbar._height(scrollbarVScrollableDistance);
                    self._hScrollbar._width(scrollbarHScrollableDistance);
                    self._hScrollbar._height(scrollbarHContainerHeight);
                    $scrollbarVContainer.css(['height', 'left', 'right', 'top'], [scrollbarVcontainerHeightAuto, 'auto', scrollbarVcontainerRight, scrollbarVcontainerTop]);
                    $scrollbarHContainer.css(['width', 'top', 'bottom', 'left'], [scrollbarHContainerWidthAuto, 'auto', scrollbarHContainerBottom, scrollbarHContainerLeft]);
                };
                Workbook.prototype._resizeHScrollBar = function () {
                    var self = this;
                    var sheet = self._getActiveSheetOrSheetTab();
                    var options = self.options;
                    if (sheet) {
                        sheet._resizeHScrollBar(options.scrollbarMaxAlign, options.scrollbarShowMax, self._hScrollbar);
                    }
                };
                Workbook.prototype._resizeVScrollBar = function () {
                    var self = this;
                    var sheet = self._getActiveSheetOrSheetTab();
                    var options = self.options;
                    if (sheet) {
                        sheet._resizeVScrollBar(options.scrollbarMaxAlign, options.scrollbarShowMax, self._vScrollbar);
                    }
                };
                Workbook.prototype._doTabHSResize = function () {
                    var self = this;
                    var host = self._host;
                    if (!host) {
                        return;
                    }
                    self._adjustTabStripSize();
                    self._adjustScollbarSize();
                    self._resizeActiveSheet(false);
                    self._resizeScrollbar();
                    self._resizeTabStrip();
                };
                Workbook.prototype.suspendPaint = function () {
                    var self = this;
                    var tab = self._tabStrip;
                    var sheets = self.sheets;
                    var sheetTabs = self._sheetTabs;
                    self._paintSuspended++;
                    for (var _i = 0, sheets_1 = sheets; _i < sheets_1.length; _i++) {
                        var sheet = sheets_1[_i];
                        sheet.suspendPaint();
                    }
                    for (var _a = 0, sheetTabs_1 = sheetTabs; _a < sheetTabs_1.length; _a++) {
                        var sheetTab = sheetTabs_1[_a];
                        sheetTab.suspendPaint();
                    }
                    if (tab) {
                        tab._suspendPaint();
                    }
                };
                Workbook.prototype.resumePaint = function () {
                    var self = this;
                    var tab = self._tabStrip;
                    var sheets = self.sheets;
                    var sheetTabs = self._sheetTabs;
                    self._paintSuspended -= (self._paintSuspended > 0 ? 1 : 0);
                    for (var _i = 0, sheets_2 = sheets; _i < sheets_2.length; _i++) {
                        var sheet = sheets_2[_i];
                        sheet.resumePaint();
                    }
                    for (var _a = 0, sheetTabs_2 = sheetTabs; _a < sheetTabs_2.length; _a++) {
                        var sheetTab = sheetTabs_2[_a];
                        sheetTab.resumePaint();
                    }
                    if (tab) {
                        tab._resumePaint();
                    }
                };
                Workbook.prototype.isPaintSuspended = function () {
                    return this._paintSuspended > 0;
                };
                Workbook.prototype._paintWorkbookBackgroundImage = function () {
                    var self = this;
                    var backgroundImage = self.options.backgroundImage;
                    var backgroundImageLayout = self.options.backgroundImageLayout;
                    var sheet = getActiveSheet(self);
                    if (sheet && backgroundImage) {
                        var canvas = domUtil_1.GC$(sheet._getCanvas());
                        var imageLoader = void 0;
                        canvas.css({
                            'background-image': 'url(\'' + backgroundImage + '\')',
                            'background-repeat': 'no-repeat'
                        });
                        if (!isNullOrUndefined(backgroundImageLayout)) {
                            imageLoader = self._imageLoader;
                            if (!imageLoader) {
                                imageLoader = self._imageLoader = new imageLoader_1._ImageLoader(function () {
                                    if (self._imageLoader) {
                                        self._paintWorkbookBackgroundImage();
                                    }
                                });
                            }
                            try {
                                if (imageLoader._getState(backgroundImage)) {
                                    var img = imageLoader._getImage(backgroundImage);
                                    var bounds = sheet._getBounds();
                                    var contentWidth = bounds.width;
                                    var contentHeight = bounds.height;
                                    common_1._util._applyBackgroundImageLayout(
                                        sheet._getCanvas(),
                                        contentWidth, contentHeight, img.width, img.height, backgroundImageLayout
                                    );
                                } else {
                                    imageLoader._addImage(backgroundImage);
                                }
                            } catch (ex) { }
                        }
                    }
                };
                // 更改工作表中公式的工作表
                Workbook.prototype._changeSheetForFormulaAcrossSheet = function (sheet) {
                    var self = this;
                    var name = sheet.name();
                    var index = self.getSheetIndex(name);
                    if (isNullOrUndefined(index)) {
                        index = self.getSheetCount() + self.getSheetTabIndex(name);
                    }
                    self._tabStrip._doSheetTabClickChange(index);
                };
                Workbook.prototype.startSheetIndex = function (value) {
                    var self = this;
                    var tab = self._tabStrip;
                    if (arguments.length === 0) {
                        return (tab) ? tab._firstTab : 0;
                    }
                    if (tab) {
                        if (!tab._tabVisible(value)) {
                            value = tab._getNextVisibleIndex(value);
                            if (value === -1) {
                                value = tab._getPreVisibleIndex(value);
                            }
                        }
                        tab._firstTab = value;
                    }
                    self._doTabHSResize();
                    return self;
                };
                // 获取实际选项卡条带比率
                Workbook.prototype._getActualTabStripRatio = function () {
                    var self = this;
                    var options = self.options;
                    var isMobileScrollbar = self.options.scrollbarAppearance === core_enum_1.ScrollbarAppearance.mobile;
                    var tabStripPosition = options.tabStripPosition;
                    if (
                        options.showHorizontalScrollbar
                        && !isMobileScrollbar
                        && tabStripPosition === core_enum_1.TabStripPosition.bottom
                    ) {
                        var r = options.tabStripRatio;
                        if (isNaN(r)) {
                            return 0.5;
                        }
                        var minRatio = 0, vp = self._vp, tab = self._tabStrip;
                        if (vp && tab) {
                            var totalWidth = domUtil_1.GC$(vp).width();
                            minRatio = tab._getResizeBarWidth() / totalWidth;
                        }
                        if (r < minRatio) {
                            r = minRatio;
                        } else if (r > 1) {
                            r = 1;
                        }
                        return r;
                    }
                    return 1;
                };
                Workbook.prototype.destroy = function () {
                    this._windowResizeHandler && domUtil_1.GC$(WINDOW).unbind(E_RESIZE + NS_SPREAD, this._windowResizeHandler);
                    this._dispose();
                };
                Workbook.prototype.repaint = function () {
                    var self = this;
                    var tab = self._tabStrip;
                    if (tab) {
                        tab.repaint();
                    }
                    var sheet = common_1._getActiveSheet(self);
                    if (sheet) {
                        sheet.repaint();
                    }
                };
                Workbook.prototype.refresh = function () {
                    var self = this;
                    if (self._host) {
                        common_1._ThemeStyleHelper._clearCache();
                        self._refresh();
                        self._doResize();
                        self.repaint();
                    }
                };
                Workbook.prototype.getHost = function () {
                    return this._host;
                };
                Workbook.prototype.invalidateLayout = function () {
                    var sheet = common_1._getActiveSheet(this);
                    if (sheet) {
                        sheet.invalidateLayout();
                    }
                };
                Workbook.prototype.addNamedStyle = function (style) {
                    this._addNamedStyleImp(style);
                    var sheet = common_1._getActiveSheet(this);
                    if (sheet) {
                        sheet._invalidate();
                    }
                };
                Workbook.prototype._addNamedStyleImp = function (style) {
                    if (style) {
                        if (!style.name) {
                            throw new Error(getSR().Exp_EmptyNamedStyle);
                        }
                        var name_1 = style.name.toUpperCase();
                        this._namedStyles[name_1] = style;
                    }
                };
                Workbook.prototype.getNamedStyle = function (name) {
                    return this._getNamedStyleImp(name, true);
                };
                Workbook.prototype._getNamedStyleImp = function (name, clearCache) {
                    var namedStyles = this._namedStyles;
                    if (namedStyles && name) {
                        name = name.toUpperCase();
                        var result = namedStyles[name];
                        if (result && clearCache) {
                            this._clearStyleCache();
                        }
                        return result;
                    }
                    return keyword_null;
                };
                Workbook.prototype._clearStyleCache = function () {
                    var sheets = this.sheets;
                    for (var _i = 0, sheets_3 = sheets; _i < sheets_3.length; _i++) {
                        var sheet = sheets_3[_i];
                        sheet._clearStyleCache();
                    }
                };
                Workbook.prototype.removeNamedStyle = function (name) {
                    var namedStyles = this._namedStyles;
                    if (namedStyles && name) {
                        name = name.toUpperCase();
                        if (namedStyles.hasOwnProperty(name)) {
                            var formatter = namedStyles[name].formatter;
                            if (formatter && typeof (formatter) === 'string' && this._formatStringCustomNameInfos[formatter]) {
                                this._removeFormatStringCustomName(formatter);
                            }
                            delete namedStyles[name];
                            this._clearStyleCache();
                            var sheet = common_1._getActiveSheet(this);
                            if (sheet) {
                                sheet._invalidate();
                            }
                        }
                    }
                };
                Workbook.prototype.getNamedStyles = function () {
                    var namedStylesClone = [];
                    var namedStyles = this._namedStyles;
                    if (namedStyles) {
                        $$_each(namedStyles, function (index, item) {
                            namedStylesClone.push(item);
                        });
                    }
                    this._clearStyleCache();
                    return namedStylesClone;
                };
                Workbook.prototype.getActiveSheet = function () {
                    if (this.sheets && this.sheets.length > 0) {
                        return this.sheets[this._activeSheetIndex];
                    }
                    return keyword_null;
                };
                Workbook.prototype.getActiveSheetTab = function () {
                    if (this._sheetTabs && this._sheetTabs.length > 0) {
                        return this._sheetTabs[this._activeSheetTabIndex];
                    }
                    return keyword_null;
                };
                Workbook.prototype.setActiveSheet = function (name) {
                    var oldActiveSheet = this.getActiveSheet();
                    var oldActiveSheetTab = this.getActiveSheetTab();
                    this._setActiveSheetInternal(name, 2);
                    this._processSelectedState(oldActiveSheet);
                    this._processSheetTabSelectedState(oldActiveSheetTab);
                };
                Workbook.prototype.setActiveSheetTab = function (indexOrName) {
                    var oldActiveSheet = this.getActiveSheet();
                    var oldActiveSheetTab = this.getActiveSheetTab();
                    if (typeof indexOrName === 'number') {
                        this._setActiveSheetTabIndexImp(indexOrName, 2);
                    } else if (typeof indexOrName === 'string') {
                        this._setActiveSheetTabInternal(indexOrName, 2);
                    }
                    this._processSelectedState(oldActiveSheet);
                    this._processSheetTabSelectedState(oldActiveSheetTab);
                };
                Workbook.prototype._setActiveSheetInternal = function (name, focusPolicy) {
                    var sheets = this.sheets;
                    for (var i = 0; i < sheets.length; i++) {
                        if (sheets[i].name() === name) {
                            this._setActiveSheetIndexImp(i, focusPolicy);
                            break;
                        }
                    }
                };
                Workbook.prototype._setActiveSheetTabInternal = function (name, focusPolicy) {
                    var sheetTabs = this._sheetTabs;
                    for (var i = 0; i < sheetTabs.length; i++) {
                        if (sheetTabs[i].name() === name) {
                            this._setActiveSheetTabIndexImp(i, focusPolicy);
                            break;
                        }
                    }
                };
                Workbook.prototype.getActiveSheetIndex = function () {
                    return this._activeSheetIndex;
                };
                Workbook.prototype.getActiveSheetTabIndex = function () {
                    return this._activeSheetTabIndex;
                };
                Workbook.prototype.setActiveSheetIndex = function (value) {
                    var oldActiveSheet = this.getActiveSheet();
                    var oldActiveSheetTab = this.getActiveSheetTab();
                    this._setActiveSheetIndexImp(value, 2);
                    this._processSelectedState(oldActiveSheet);
                    this._processSheetTabSelectedState(oldActiveSheetTab);
                };
                Workbook.prototype._setActiveSheetIndexImp = function (value, focusPolicy, doNotGetCellTypeFocus, triggerEvent) {
                    if (typeof value !== CONST_NUMBER) {
                        return;
                    }
                    var self = this;
                    if (value === self._activeSheetIndex) {
                        return;
                    }
                    var newSheet = self.sheets[value];
                    if (!(newSheet && newSheet.visible())) {
                        return;
                    }
                    var device = common_1._util._device();
                    if (device.ipad || device.iphone) {
                        var lastSetActiveSheetTime = self._lastSetActiveSheetTime;
                        if (lastSetActiveSheetTime && new Date().valueOf() - lastSetActiveSheetTime < 300) {
                            return;
                        }
                    }
                    var sheet = getActiveSheet(self);
                    var activeWorksheet = sheet;
                    if (!activeWorksheet) {
                        var sheetTab = self.getActiveSheetTab();
                        activeWorksheet = sheetTab && sheetTab._sheet;
                    }
                    var argsForFormulaTextbox = {
                        oldSheet: activeWorksheet,
                        newSheet: newSheet,
                        needTriggerSheetChange: true
                    };
                    triggerFormulatexgboxActiveSheetChanging(self, argsForFormulaTextbox);
                    var args = {
                        oldSheet: activeWorksheet,
                        newSheet: newSheet,
                        cancel: false
                    };
                    var whetherTriggerEvent = argsForFormulaTextbox.needTriggerSheetChange && triggerEvent;
                    if (whetherTriggerEvent) {
                        triggerActiveSheetChanging(self, args);
                    }
                    if (args.cancel === false) {
                        self._activeSheetIndex = value;
                        self._clearActiveSheetTab();
                        if (newSheet !== sheet) {
                            if (sheet) {
                                sheet._dispose(false);
                                if (sheet.charts) {
                                    sheet.charts.all().forEach(function (chart) {
                                        chart.clearflexDVs();
                                    });
                                }
                            }
                            self._setActiveSheetImp(newSheet, focusPolicy, false, whetherTriggerEvent, doNotGetCellTypeFocus);
                        }
                        self._doResize();
                        triggerFormulatextboxActiveSheetChanged(self, activeWorksheet, newSheet);
                        if (whetherTriggerEvent) {
                            triggerActiveSheetChanged(self, activeWorksheet, newSheet);
                        }
                    }
                    if (device.ipad || device.iphone) {
                        self._lastSetActiveSheetTime = new Date().valueOf();
                    }
                };
                Workbook.prototype._setActiveSheetTabIndexImp = function (value, focusPolicy, doNotGetCellTypeFocus, triggerEvent) {
                    if (typeof value !== CONST_NUMBER) {
                        return;
                    }
                    var self = this;
                    if (value === self._activeSheetTabIndex) {
                        return;
                    }
                    var newSheetTab = self._sheetTabs[value];
                    if (!(newSheetTab && newSheetTab.visible())) {
                        return;
                    }
                    var newWorksheet = newSheetTab._sheet;
                    var device = common_1._util._device();
                    if (device.ipad || device.iphone) {
                        var lastSetActiveSheetTime = self._lastSetActiveSheetTime;
                        if (lastSetActiveSheetTime && new Date().valueOf() - lastSetActiveSheetTime < 300) {
                            return;
                        }
                    }
                    var sheetTab = self.getActiveSheetTab();
                    var oldWorksheet = sheetTab ? sheetTab._sheet : self.getActiveSheet();
                    var argsForFormulatextbox = {
                        oldSheet: oldWorksheet,
                        newSheet: newWorksheet,
                        needTriggerSheetChange: true
                    };
                    triggerFormulatexgboxActiveSheetChanging(self, argsForFormulatextbox);
                    var args = {
                        oldSheet: oldWorksheet,
                        newSheet: newWorksheet,
                        cancel: false
                    };
                    var whetherTriggerEvent = argsForFormulatextbox.needTriggerSheetChange && triggerEvent;
                    if (whetherTriggerEvent) {
                        triggerActiveSheetChanging(self, args);
                    }
                    if (args.cancel === false) {
                        self._activeSheetTabIndex = value;
                        self._clearActiveSheet();
                        if (newSheetTab !== sheetTab) {
                            if (sheetTab) {
                                sheetTab._dispose(false);
                            }
                            self._setActiveSheetTabImp(newSheetTab, focusPolicy, false, whetherTriggerEvent, doNotGetCellTypeFocus);
                        }
                        self._doResize();
                        triggerFormulatextboxActiveSheetChanged(self, oldWorksheet, newWorksheet);
                        if (whetherTriggerEvent) {
                            triggerActiveSheetChanged(self, oldWorksheet, newWorksheet);
                        }
                    }
                    if (device.ipad || device.iphone) {
                        self._lastSetActiveSheetTime = new Date().valueOf();
                    }
                };
                Workbook.prototype._setActiveSheetImp = function (sheet, focusPolicy, ignoreSetHost, whetherTriggerEvent, doNotGetCellTypeFocus) {
                    if (!ignoreSetHost) {
                        sheet._setHost(this._vp);
                    }
                    var activeElement = common_1._FocusHelper._getActiveElement();
                    var hasFocus = activeElement && activeElement.parent === this;
                    var setFocus = (focusPolicy === 2) ? hasFocus : focusPolicy === 1;
                    common_1._FocusHelper._setActiveElement(keyword_null);
                    if (!this._suspendSetFocus && setFocus) {
                        sheet._setFocus(doNotGetCellTypeFocus);
                    }
                    sheet._syncHScrollbarPosition();
                    sheet._syncVScrollbarPosition();
                };
                Workbook.prototype._setActiveSheetTabImp = function (sheetTab, focusPolicy, ignoreSetHost, whetherTriggerEvent, doNotGetCellTypeFocus) {
                    if (!ignoreSetHost) {
                        sheetTab._setHost(this._vp);
                    }
                    var activeElement = common_1._FocusHelper._getActiveElement();
                    var hasFocus = activeElement && activeElement.parent === this;
                    var setFocus = (focusPolicy === 2) ? hasFocus : focusPolicy === 1;
                    common_1._FocusHelper._setActiveElement(keyword_null);
                    if (!this._suspendSetFocus && setFocus) {
                        sheetTab._setFocus(doNotGetCellTypeFocus);
                    }
                    sheetTab._syncHScrollbarPosition();
                    sheetTab._syncVScrollbarPosition();
                };
                // 处理选中状态
                Workbook.prototype._processSelectedState = function (oldActiveSheet) {
                    var activeSheet = this.getActiveSheet();
                    oldActiveSheet && oldActiveSheet._isSelectedImp(false, false);
                    activeSheet && activeSheet._isSelectedImp(true, false);
                };
                // 处理工作表选中状态
                Workbook.prototype._processSheetTabSelectedState = function (oldActiveSheetTab) {
                    var activeSheetTab = this.getActiveSheetTab();
                    oldActiveSheetTab && oldActiveSheetTab._isSelectedImp(false, false);
                    activeSheetTab && activeSheetTab._isSelectedImp(true, false);
                };
                // 添加工作表
                Workbook.prototype.addSheet = function (index, sheet) {
                    var oldActiveSheet = this.getActiveSheet();
                    var oldActiveSheetTab = this.getActiveSheetTab();
                    this._addSheetImp(index, 2, sheet);
                    this._processSelectedState(oldActiveSheet);
                    this._processSheetTabSelectedState(oldActiveSheetTab);
                };
                // 添加工作表tab
                Workbook.prototype.addSheetTab = function (index, name, type) {
                    var oldActiveSheet = this.getActiveSheet();
                    var oldActiveSheetTab = this.getActiveSheetTab();
                    var sheetTab = this._createSheetTab(name, type);
                    if (sheetTab) {
                        this._addSheetTabImp(index, 2, sheetTab);
                        this._processSelectedState(oldActiveSheet);
                        this._processSheetTabSelectedState(oldActiveSheetTab);
                        return sheetTab;
                    }
                };
                Workbook.prototype._addSheetImp = function (index, focusPolicy, sheet) {
                    var self = this;
                    if (!sheet) {
                        sheet = self._createSheet(self._getDefaultSheetName(index));
                    }
                    var i;
                    var sheets = self.sheets;
                    var sheetCount = sheets.length;
                    if (!sheet.name()) {
                        sheet._setNameCore(self._getDefaultSheetName(index));
                    } else {
                        for (i = 0; i < sheetCount; i++) {
                            if (sheets[i].name() === sheet.name()) {
                                throw getSR().Exp_NotSupported;
                            }
                        }
                    }
                    self._copyUserEvents(sheet);
                    var oldActiveSheet = getActiveSheet(self);
                    var oldActiveSheetIndex = self._activeSheetIndex;
                    var p = sheetCount - index;
                    var tmp = [];
                    for (i = 0; i < p && sheetCount > 0; i++) {
                        tmp.push(sheets.pop());
                    }
                    sheets.push(sheet);
                    sheet._onAttached(self);
                    while (tmp.length > 0) {
                        sheets.push(tmp.pop());
                    }
                    sheetCount = sheets.length;
                    if (sheetCount === 1) {
                        if (self._vp) {
                            sheet._setHost(self._vp);
                        }
                        self._activeSheetIndex = 0;
                    } else {
                        if (oldActiveSheetIndex < 0 && self._tabStrip) {
                            oldActiveSheetIndex = self._tabStrip._getNextVisibleIndex(oldActiveSheetIndex);
                        }
                        self._activeSheetIndex = oldActiveSheetIndex;
                    }
                    self._clearActiveSheetTab();
                    var newActiveSheet = getActiveSheet(self);
                    if (newActiveSheet !== oldActiveSheet) {
                        if (oldActiveSheet) {
                            oldActiveSheet._dispose(false);
                        }
                        if (newActiveSheet) {
                            self._setActiveSheetImp(newActiveSheet, focusPolicy, sheetCount === 1, true);
                        }
                        self._doResize();
                    }
                    if (self._tabStrip) {
                        if (self._tabStrip._firstTab < 0) {
                            self._tabStrip._firstTab = self._activeSheetIndex;
                        }
                        self._tabStrip.repaint();
                    }
                };
                Workbook.prototype._addSheetTabImp = function (index, focusPolicy, sheetTab) {
                    if (!sheetTab) {
                        return;
                    }
                    var self = this;
                    var i;
                    var sheetTabs = self._sheetTabs;
                    var sheetTabCount = sheetTabs.length;
                    for (i = 0; i < sheetTabCount; i++) {
                        if (sheetTabs[i].name() === sheetTab.name()) {
                            throw getSR().Exp_NotSupported;
                        }
                    }
                    self._copyUserEvents(sheetTab);
                    var oldActiveSheetTab = self.getActiveSheetTab();
                    var oldActiveSheetTabIndex = self._activeSheetTabIndex;
                    var p = sheetTabCount - index;
                    var tmp = [];
                    for (i = 0; i < p && sheetTabCount > 0; i++) {
                        tmp.push(sheetTabs.pop());
                    }
                    sheetTabs.push(sheetTab);
                    sheetTab._onAttached(self);
                    while (tmp.length > 0) {
                        sheetTabs.push(tmp.pop());
                    }
                    sheetTabCount = sheetTabs.length;
                    if (sheetTabCount === 1) {
                        if (self._vp) {
                            sheetTab._setHost(self._vp);
                        }
                        self._activeSheetTabIndex = 0;
                    } else {
                        if (oldActiveSheetTabIndex < 0 && self._tabStrip) {
                            oldActiveSheetTabIndex = self._tabStrip._getNextVisibleIndex(oldActiveSheetTabIndex);
                        }
                        self._activeSheetTabIndex = oldActiveSheetTabIndex;
                    }
                    self._clearActiveSheet();
                    var newActiveSheetTab = self.getActiveSheetTab();
                    if (newActiveSheetTab !== oldActiveSheetTab) {
                        if (oldActiveSheetTab) {
                            oldActiveSheetTab._dispose(false);
                        }
                        if (newActiveSheetTab) {
                            self._setActiveSheetTabImp(newActiveSheetTab, focusPolicy, sheetTabCount === 1, true);
                        }
                        self._doResize();
                    }
                    if (self._tabStrip) {
                        if (self._tabStrip._firstTab < 0) {
                            self._tabStrip._firstTab = self._activeSheetTabIndex;
                        }
                        self._tabStrip.repaint();
                    }
                };
                Workbook.prototype.removeSheet = function (index) {
                    this._removeSheetImp(index, 2);
                };
                Workbook.prototype.removeSheetTab = function (indexOrName) {
                    if (typeof indexOrName === 'string') {
                        indexOrName = this.getSheetTabIndex(indexOrName);
                    }
                    this._removeSheetTabImp(indexOrName, 2);
                };
                Workbook.prototype._removeSheetImp = function (index, focusPolicy) {
                    var self = this;
                    var sheets = self.sheets;
                    var calcService = self._calcService;
                    var tab = self._tabStrip;
                    var sheetCount = sheets.length;
                    if (isNaN(index) || index < 0 || index >= sheetCount) {
                        throw new Error(getSR().Exp_IndexOutOfRange);
                    }
                    var activeSheetChanged = index <= self._activeSheetIndex || index === sheetCount - 1;
                    var oldActiveSheet = getActiveSheet(self);
                    if (index < self._activeSheetIndex) {
                        self._activeSheetIndex--;
                    }
                    var removedSheet = sheets[index];
                    removedSheet._disposeUserEvents();
                    sheets.splice(index, 1);
                    sheetCount = sheets.length;
                    if (sheetCount === 0) {
                        self._activeSheetIndex = -1;
                    } else if (self._activeSheetIndex >= sheetCount) {
                        self._activeSheetIndex = tab._getPreVisibleIndex(sheetCount);
                    } else {
                        var i = void 0;
                        for (i = self._activeSheetIndex; i < sheetCount; i++) {
                            if (sheets[i].visible()) {
                                self._activeSheetIndex = i;
                                break;
                            }
                        }
                        if (i >= sheetCount) {
                            self._activeSheetIndex = tab._getPreVisibleIndex(sheetCount);
                        }
                    }
                    self._clearActiveSheetTab();
                    if (activeSheetChanged) {
                        var newSheet = sheets[self._activeSheetIndex];
                        if (oldActiveSheet !== newSheet) {
                            if (oldActiveSheet) {
                                oldActiveSheet._dispose(false);
                            }
                            if (newSheet) {
                                self._setActiveSheetImp(newSheet, focusPolicy, false, true);
                            }
                        }
                    }
                    if (calcService) {
                        var calcSource = removedSheet._getSheetSource();
                        calcSource._indexBeforeRemove = index;
                        calcService.removeSource(calcSource);
                        var chCalcSource = removedSheet._chSheetSource;
                        calcService.removeSource(chCalcSource);
                        var rhCalcSource = removedSheet._rhSheetSource;
                        calcService.removeSource(rhCalcSource);
                        var chartSource = removedSheet._chartSource;
                        if (!isNullOrUndefined(chartSource)) {
                            calcService.removeSource(chartSource);
                        }
                    }
                    removedSheet._dispose(true, self._activeSheetIndex !== -1);
                    if (hasCalc && !calcService._parserContext && self.sheets && self.sheets.length > 0) {
                        var newSheetSource = self.sheets[0];
                        calcService.initParserContext(newSheetSource._getSheetSource());
                    }
                    if (tab) {
                        if (tab._firstTab >= sheetCount) {
                            self.startSheetIndex(tab._getPreVisibleIndex(sheetCount));
                        } else if (tab._firstTab < 0) {
                            self.startSheetIndex(tab._getNextVisibleIndex(-1));
                        } else {
                            self._doResize();
                        }
                    }
                };
                Workbook.prototype._removeSheetTabImp = function (index, focusPolicy) {
                    var self = this;
                    var sheetTabs = self._sheetTabs;
                    var tab = self._tabStrip;
                    var sheetTabCount = sheetTabs.length;
                    if (isNaN(index) || index < 0 || index >= sheetTabCount) {
                        throw new Error(getSR().Exp_IndexOutOfRange);
                    }
                    var activeSheetChanged = index <= self._activeSheetTabIndex || index === sheetTabCount - 1;
                    var oldActiveSheetTab = self.getActiveSheetTab();
                    if (index < self._activeSheetTabIndex) {
                        self._activeSheetTabIndex--;
                    }
                    var removedSheetTab = sheetTabs[index];
                    removedSheetTab._disposeUserEvents();
                    sheetTabs.splice(index, 1);
                    sheetTabCount = sheetTabs.length;
                    if (sheetTabCount === 0) {
                        self._activeSheetTabIndex = -1;
                    } else if (self._activeSheetTabIndex >= sheetTabCount) {
                        self._activeSheetTabIndex = tab._getPreVisibleIndex(sheetTabCount);
                    } else {
                        var i = void 0;
                        for (i = self._activeSheetTabIndex; i < sheetTabCount; i++) {
                            if (sheetTabs[i].visible()) {
                                self._activeSheetTabIndex = i;
                                break;
                            }
                        }
                        if (i >= sheetTabCount) {
                            self._activeSheetTabIndex = tab._getPreVisibleIndex(sheetTabCount);
                        }
                    }
                    self._clearActiveSheet();
                    if (activeSheetChanged) {
                        var newSheetTab = sheetTabs[self._activeSheetTabIndex];
                        if (oldActiveSheetTab !== newSheetTab) {
                            if (oldActiveSheetTab) {
                                oldActiveSheetTab._dispose(false);
                            }
                            if (newSheetTab) {
                                self._setActiveSheetTabImp(newSheetTab, focusPolicy, false, true);
                            }
                        }
                    }
                    removedSheetTab._dispose(true, self._activeSheetTabIndex !== -1);
                    if (tab) {
                        if (tab._firstTab >= sheetTabCount) {
                            self.startSheetIndex(tab._getPreVisibleIndex(sheetTabCount));
                        } else if (tab._firstTab < 0) {
                            self.startSheetIndex(tab._getNextVisibleIndex(-1));
                        } else {
                            self._doResize();
                        }
                    }
                };
                Workbook.prototype.clearSheets = function () {
                    var self = this;
                    var sheets = self.sheets;
                    var calcService = self._calcService;
                    var tab = self._tabStrip;
                    for (var _i = 0, sheets_4 = sheets; _i < sheets_4.length; _i++) {
                        var sheet = sheets_4[_i];
                        sheet._disposeUserEvents();
                        sheet._dispose(true);
                    }
                    sheets.splice(0, sheets.length);
                    if (calcService) {
                        calcService.clearSource();
                    }
                    self._activeSheetIndex = -1;
                    if (tab) {
                        tab._firstTab = -1;
                        tab.repaint();
                    }
                };
                Workbook.prototype.clearSheetTabs = function () {
                    var self = this;
                    var sheetTabs = self._sheetTabs;
                    var tab = self._tabStrip;
                    for (var _i = 0, sheetTabs_3 = sheetTabs; _i < sheetTabs_3.length; _i++) {
                        var sheet = sheetTabs_3[_i];
                        sheet._disposeUserEvents();
                        sheet._dispose(true);
                    }
                    sheetTabs.splice(0, sheetTabs.length);
                    self._activeSheetTabIndex = -1;
                    if (tab) {
                        tab._firstTab = -1;
                        tab.repaint();
                    }
                };
                Workbook.prototype.getSheet = function (index) {
                    var sheets = this.sheets;
                    return index >= 0 && index < sheets.length ? sheets[index] : keyword_null;
                };
                Workbook.prototype.getSheetTab = function (indexOrName) {
                    var sheetTabs = this._sheetTabs;
                    if (typeof indexOrName === 'number') {
                        return indexOrName >= 0 && indexOrName < sheetTabs.length ? sheetTabs[indexOrName] : keyword_null;
                    } else if (typeof indexOrName === 'string') {
                        for (var _i = 0, sheetTabs_4 = sheetTabs; _i < sheetTabs_4.length; _i++) {
                            var sheetTab = sheetTabs_4[_i];
                            if (sheetTab.name() === indexOrName) {
                                return sheetTab;
                            }
                        }
                    }
                    return keyword_null;
                };
                Workbook.prototype.getSheetFromName = function (name) {
                    var sheets = this.sheets;
                    for (var _i = 0, sheets_5 = sheets; _i < sheets_5.length; _i++) {
                        var sheet = sheets_5[_i];
                        if (sheet.name() === name) {
                            return sheet;
                        }
                    }
                    return keyword_null;
                };
                Workbook.prototype.getSheetIndex = function (name) {
                    var sheets = this.sheets;
                    for (var i = 0; i < sheets.length; i++) {
                        if (sheets[i].name() === name) {
                            return i;
                        }
                    }
                    return keyword_null;
                };
                Workbook.prototype.getSheetTabIndex = function (name) {
                    var sheetTabs = this._sheetTabs;
                    for (var i = 0; i < sheetTabs.length; i++) {
                        if (sheetTabs[i].name() === name) {
                            return i;
                        }
                    }
                    return keyword_null;
                };
                Workbook.prototype.getSheetCount = function () {
                    return this.sheets.length;
                };
                Workbook.prototype.getSheetTabCount = function () {
                    return this._sheetTabs.length;
                };
                Workbook.prototype.setSheetCount = function (count) {
                    var self = this;
                    var oldActiveSheet = self.getActiveSheet();
                    var oldActiveSheetTab = self.getActiveSheetTab();
                    self._setSheetCountImp(count, 2);
                    self._processSelectedState(oldActiveSheet);
                    self._processSheetTabSelectedState(oldActiveSheetTab);
                };
                Workbook.prototype._setSheetCountImp = function (count, focusPolicy) {
                    var self = this;
                    if (count < 0) {
                        throw getSR().Exp_ArgumentOutOfRange;
                    } else if (count === 0) {
                        self.clearSheets();
                    }
                    var length = self.sheets.length, i;
                    if (count < length) {
                        for (i = length - 1; i >= count; i--) {
                            self._removeSheetImp(i, focusPolicy);
                        }
                    } else if (count > length) {
                        for (i = length; i < count; i++) {
                            self._addSheetImp(i, focusPolicy);
                        }
                    }
                };
                Workbook.prototype._setSheetTabCountImp = function (count, focusPolicy) {
                    var self = this;
                    if (count < 0) {
                        throw getSR().Exp_ArgumentOutOfRange;
                    } else if (count === 0) {
                        self.clearSheetTabs();
                    }
                    var oldActiveSheet = self.getActiveSheet();
                    var oldActiveSheetTab = self.getActiveSheetTab();
                    var length = self._sheetTabs.length, i;
                    if (count < length) {
                        for (i = length - 1; i >= count; i--) {
                            self._removeSheetTabImp(i, focusPolicy);
                        }
                    } else if (count > length) {
                        for (i = length; i < count; i++) {
                            var sheetTab = self._createSheetTab(keyword_null, core_enum_1.SheetType.tableSheet);
                            self._addSheetTabImp(i, focusPolicy, sheetTab);
                        }
                    }
                    self._processSelectedState(oldActiveSheet);
                    self._processSheetTabSelectedState(oldActiveSheetTab);
                };
                Workbook.prototype._createSheetTab = function (name, type) {
                    return keyword_null;
                };
                // 绑定事件
                Workbook.prototype.bind = function (type, data, fn) {
                    var self = this;
                    var sheets = self.sheets;
                    if (self._userEvents) {
                        self._userEvents.push({
                            type: type,
                            data: data,
                            fn: fn
                        });
                    }
                    domUtil_1.GC$(self._userEventsElem).bind(type + NS_SPREAD, data, fn);
                    for (var _i = 0, sheets_6 = sheets; _i < sheets_6.length; _i++) {
                        var sheet = sheets_6[_i];
                        sheet.bind(type, data, fn);
                    }
                    var sheetTabs = self._sheetTabs;
                    for (var _a = 0, sheetTabs_5 = sheetTabs; _a < sheetTabs_5.length; _a++) {
                        var sheetTab = sheetTabs_5[_a];
                        sheetTab.bind(type, data, fn);
                    }
                };
                // 解绑
                Workbook.prototype.unbind = function (type, fn) {
                    var self = this;
                    var sheets = self.sheets;
                    var userEvents = self._userEvents;
                    if (userEvents) {
                        for (var e = userEvents.length - 1; e >= 0; e--) {
                            var item = userEvents[e];
                            if (item.type === type || self._unbindWithNS(item.type, type)) {
                                userEvents.splice(e, 1);
                            }
                        }
                    }
                    domUtil_1.GC$(self._userEventsElem).unbind(type + NS_SPREAD, fn);
                    for (var _i = 0, sheets_7 = sheets; _i < sheets_7.length; _i++) {
                        var sheet = sheets_7[_i];
                        sheet.unbind(type, fn);
                    }
                    var sheetTabs = self._sheetTabs;
                    for (var _a = 0, sheetTabs_6 = sheetTabs; _a < sheetTabs_6.length; _a++) {
                        var sheetTab = sheetTabs_6[_a];
                        sheetTab.unbind(type, fn);
                    }
                };
                Workbook.prototype._unbindWithNS = function (eventItemType, namespace) {
                    return namespace.indexOf('.') === 0
                        && (eventItemType.substring(eventItemType.length - namespace.length) === namespace);
                };
                Workbook.prototype.unbindAll = function () {
                    var self = this;
                    var sheets = self.sheets;
                    self._userEvents.length = 0;
                    domUtil_1.GC$(self._userEventsElem).unbind(NS_SPREAD);
                    for (var _i = 0, sheets_8 = sheets; _i < sheets_8.length; _i++) {
                        var sheet = sheets_8[_i];
                        sheet.unbindAll();
                    }
                    var sheetTabs = self._sheetTabs;
                    for (var _a = 0, sheetTabs_7 = sheetTabs; _a < sheetTabs_7.length; _a++) {
                        var sheetTab = sheetTabs_7[_a];
                        sheetTab.unbindAll();
                    }
                };
                Workbook.prototype._bind = function (type, data, fn) {
                    var self = this;
                    var sheets = self.sheets;
                    self._userEvents.push({
                        type: type,
                        data: data,
                        fn: fn
                    });
                    domUtil_1.GC$(self._userEventsElem)
                        .bind(type + NS_SPREADINTERNAL, data, fn);
                    for (var _i = 0, sheets_9 = sheets; _i < sheets_9.length; _i++) {
                        var sheet = sheets_9[_i];
                        sheet._bind(type, data, fn);
                    }
                    var sheetTabs = self._sheetTabs;
                    for (var _a = 0, sheetTabs_8 = sheetTabs; _a < sheetTabs_8.length; _a++) {
                        var sheetTab = sheetTabs_8[_a];
                        sheetTab._bind(type, data, fn);
                    }
                };
                Workbook.prototype._unbind = function (type, fn) {
                    var self = this;
                    var sheets = self.sheets;
                    var userEvents = self._userEvents;
                    for (var e = 0; e < userEvents.length; e++) {
                        var item = userEvents[e];
                        if (item.type === type || self._unbindWithNS(item.type, type)) {
                            userEvents.splice(e, 1);
                        }
                    }
                    domUtil_1.GC$(self._userEventsElem).unbind(type + NS_SPREADINTERNAL, fn);
                    for (var _i = 0, sheets_10 = sheets; _i < sheets_10.length; _i++) {
                        var sheet = sheets_10[_i];
                        sheet._unbind(type, fn);
                    }
                    var sheetTabs = self._sheetTabs;
                    for (var _a = 0, sheetTabs_9 = sheetTabs; _a < sheetTabs_9.length; _a++) {
                        var sheetTab = sheetTabs_9[_a];
                        sheetTab._unbind(type, fn);
                    }
                };
                Workbook.prototype._unbindAll = function () {
                    var self = this;
                    var sheets = self.sheets;
                    self._userEvents.length = 0;
                    domUtil_1.GC$(self._userEventsElem).unbind(NS_SPREADINTERNAL);
                    for (var _i = 0, sheets_11 = sheets; _i < sheets_11.length; _i++) {
                        var sheet = sheets_11[_i];
                        sheet._unbindAll();
                    }
                    var sheetTabs = self._sheetTabs;
                    for (var _a = 0, sheetTabs_10 = sheetTabs; _a < sheetTabs_10.length; _a++) {
                        var sheetTab = sheetTabs_10[_a];
                        sheetTab._unbindAll();
                    }
                };
                // 触发
                Workbook.prototype._trigger = function (type, data) {
                    if (this._eventSuspended === 0) {
                        domUtil_1.GC$(this._userEventsElem).trigger(type, data);
                    }
                };
                Workbook.prototype._triggerButtonClicked = function (sheet, row, col, sheetArea) {
                    this._trigger(common_1.Events.ButtonClicked, {
                        sheet: sheet,
                        sheetName: sheet.name(),
                        row: row,
                        col: col,
                        sheetArea: sheetArea
                    });
                };
                // 
                Workbook.prototype._copyUserEvents = function (sheet) {
                    var userEvents = this._userEvents;
                    for (var _i = 0, userEvents_1 = userEvents; _i < userEvents_1.length; _i++) {
                        var item = userEvents_1[_i];
                        sheet.bind(item.type, item.data, item.fn);
                    }
                };
                Workbook.prototype.suspendEvent = function () {
                    var self = this;
                    var sheets = self.sheets;
                    self._eventSuspended++;
                    for (var _i = 0, sheets_12 = sheets; _i < sheets_12.length; _i++) {
                        var sheet = sheets_12[_i];
                        sheet.suspendEvent();
                    }
                    var sheetTabs = self._sheetTabs;
                    for (var _a = 0, sheetTabs_11 = sheetTabs; _a < sheetTabs_11.length; _a++) {
                        var sheetTab = sheetTabs_11[_a];
                        sheetTab.suspendEvent();
                    }
                };
                Workbook.prototype.resumeEvent = function () {
                    var self = this;
                    var sheets = self.sheets;
                    self._eventSuspended--;
                    if (self._eventSuspended < 0) {
                        self._eventSuspended = 0;
                    }
                    for (var _i = 0, sheets_13 = sheets; _i < sheets_13.length; _i++) {
                        var sheet = sheets_13[_i];
                        sheet.resumeEvent();
                    }
                    var sheetTabs = self._sheetTabs;
                    for (var _a = 0, sheetTabs_12 = sheetTabs; _a < sheetTabs_12.length; _a++) {
                        var sheetTab = sheetTabs_12[_a];
                        sheetTab.resumeEvent();
                    }
                };
                Workbook.prototype.focus = function (focusIn) {
                    if (focusIn === false) {
                        common_1._FocusHelper._setActiveElement(keyword_null);
                    } else {
                        var sheet = getActiveSheet(this);
                        if (sheet) {
                            sheet._setFocus();
                        } else {
                            var sheetTab = this.getActiveSheetTab();
                            if (sheetTab) {
                                sheetTab._setFocus();
                            }
                        }
                    }
                };
                Workbook.prototype._getScrollbarSize = function () {
                    return 12;
                };
                Workbook.prototype._getVScrollbarContainerWidth = function () {
                    return this._themeVersion > 2007 ? 22 : this._getScrollbarSize();
                };
                Workbook.prototype._syncScrollbarState = function (isVertical) {
                    var self = this;
                    var scrollbarContainer = isVertical ? self._vScrollbarContainer : self._hScrollbarContainer;
                    var scrollbar = isVertical ? self._vScrollbar : self._hScrollbar;
                    var isMobileScrollbar = self.options.scrollbarAppearance === core_enum_1.ScrollbarAppearance.mobile;
                    if (!scrollbarContainer || !scrollbar || !isMobileScrollbar) {
                        return;
                    }
                    var scrollService = self._scrollService;
                    var _scrollbarState = scrollbar._scrollbarState;
                    switch (_scrollbarState) {
                        case core_enum_1.ScrollbarState.hide:
                            scrollService._launchHideScrollbarTimer(isVertical);
                            break;
                        case core_enum_1.ScrollbarState.show:
                            scrollService._showScrollbarContainer(scrollbarContainer);
                            scrollService._stopHideScrollBarTimer(isVertical);
                            break;
                        case core_enum_1.ScrollbarState.active:
                            scrollService._showScrollbarContainer(scrollbarContainer);
                            scrollService._stopHideScrollBarTimer(isVertical);
                            scrollService._activeScrollbarContainer(scrollbarContainer);
                            break;
                        case core_enum_1.ScrollbarState.inactive:
                            scrollService._inactiveScrollbarContainer(scrollbarContainer);
                            scrollService._launchHideScrollbarTimer(isVertical);
                            break;
                    }
                };
                Workbook.prototype._getBottomTableHeight = function () {
                    return this._themeVersion > 2007 ? 32 : this._getScrollbarSize();
                };
                Workbook.prototype._showTooltip = function (info, left, top, isAbsoluteDistance, className) {
                    var cssAuto = 'auto';
                    var self = this;
                    if (!self._tooltip) {
                        var zIndex = domUtil_1.getHostMaxZIndex(self._host) + 1;
                        var tooltip = createElement(TAG_DIV);
                        if (className) {
                            domUtil_1.GC$(tooltip).addClass('gc-spread-pivot-toolTip');
                        } else {
                            domUtil_1.GC$(tooltip).addClass('gc-spread-toolTip');
                        }
                        domUtil_1.GC$(tooltip).addClass('ui-state-default ui-widget-content btn-default').css({
                            'position': CSS_ABSOLUTE,
                            'white-space': 'pre-wrap',
                            'z-index': zIndex,
                        }).width(cssAuto).height(cssAuto).appendTo(DOCUMENT.body);
                        self._tooltip = tooltip;
                    }
                    self._refreshTooltip(info, left, top, isAbsoluteDistance);
                };
                Workbook.prototype._refreshTooltip = function (info, left, top, isAbsoluteDistance) {
                    var self = this;
                    var sheet = self._getActiveSheetOrSheetTab();
                    if (sheet) {
                        var tooltipElement = self._tooltip;
                        if (tooltipElement) {
                            var tooltip = domUtil_1.GC$(tooltipElement);
                            if (!info) {
                                tooltip.hide();
                            } else {
                                tooltip.html(info);
                                tooltip.show();
                            }
                            var offset = sheet._getCanvasOffset();
                            if (isAbsoluteDistance) {
                                top -= offset.top;
                                left -= offset.left;
                            }
                            var bounds = sheet._getBounds();
                            var newOffsetLeft = bounds.x + bounds.width - tooltip.outerWidth();
                            var newOffsetTop = bounds.y + bounds.height - tooltip.outerHeight();
                            if (newOffsetLeft < 0) {
                                left = 0;
                            } else if (newOffsetTop < 0) {
                                top = 0;
                            } else {
                                top = Math_min(top, newOffsetTop);
                                left = Math_min(left, newOffsetLeft);
                            }
                            if (!isNullOrUndefined(top)) {
                                tooltip.css('top', top + offset.top);
                            }
                            if (!isNullOrUndefined(left)) {
                                tooltip.css('left', left + offset.left);
                            }
                        }
                    }
                };
                Workbook.prototype._removeTooltip = function () {
                    var self = this;
                    var tooltip = self._tooltip;
                    if (tooltip) {
                        domUtil_1.GC$(tooltip).remove();
                        self._tooltip = keyword_null;
                    }
                };
                Workbook.prototype._onCultureChanged = function () {
                    var self = this;
                    var sheetTabs = self._getSheetsAndSheetTabs();
                    common_1._CacheMgr._clearFormatCache();
                    self.invalidateLayout();
                    for (var i = 0, len = sheetTabs.length; i < len; i++) {
                        var sheetTab = sheetTabs[i];
                        sheetTab._onCultureChanged();
                    }
                    getSR();
                    Common_1.Common._getSR();
                    if (_supportsCalc) {
                        CalcEngine.sR();
                    }
                    self.repaint();
                    Workbook._callFeatureHandler(self, 'onCultureChanged');
                };
                Workbook.prototype.getTab = function () {
                    return this._tabStrip;
                };
                Workbook.prototype.changeSheetIndex = function (sheetName, targetIndex) {
                    var self = this;
                    var srcIndex = self.getSheetIndex(sheetName);
                    var sheetTab = self.getTab();
                    if (typeof targetIndex !== 'number' ||
                        srcIndex === -1 ||
                        srcIndex === targetIndex ||
                        targetIndex < 0 ||
                        targetIndex >= self.sheets.length ||
                        targetIndex % 1 !== 0 ||
                        self._hasNoSheet(sheetName)) {
                        return false;
                    }
                    var preActiveSheet = self.getActiveSheet().name();
                    if (preActiveSheet !== sheetName) {
                        self.suspendPaint();
                        self.setActiveSheet(sheetName);
                        self._reorderTab(srcIndex, targetIndex);
                        self.setActiveSheet(preActiveSheet);
                        self.resumePaint();
                    } else {
                        self._reorderTab(srcIndex, targetIndex);
                        sheetTab._scrollTabToActive(srcIndex, targetIndex);
                    }
                    return true;
                };
                Workbook.prototype._hasNoSheet = function (sheetName) {
                    var self = this;
                    var sheets = self.sheets;
                    for (var _i = 0, sheets_14 = sheets; _i < sheets_14.length; _i++) {
                        var sheet = sheets_14[_i];
                        if (sheet.name() === sheetName) {
                            return false;
                        }
                    }
                    return true;
                };
                Workbook.prototype._reorderTab = function (sourIndex, tarIndex) {
                    var self = this;
                    var activeSheetIndex = -1;
                    var sheetTabs = self._getSheetsAndSheetTabs(), i;
                    var sourceSheet = sheetTabs[sourIndex];
                    if (sourIndex > tarIndex) {
                        for (i = sourIndex; i > tarIndex; i--) {
                            sheetTabs[i] = sheetTabs[i - 1];
                        }
                        sheetTabs[tarIndex] = sourceSheet;
                        activeSheetIndex = tarIndex;
                    } else if (sourIndex < tarIndex - 1) {
                        tarIndex = tarIndex + 1;
                        for (i = sourIndex; i < tarIndex - 1; i++) {
                            sheetTabs[i] = sheetTabs[i + 1];
                        }
                        sheetTabs[tarIndex - 1] = sourceSheet;
                        activeSheetIndex = tarIndex - 1;
                    } else if (sourIndex === tarIndex - 1) {
                        sheetTabs[sourIndex] = sheetTabs[tarIndex];
                        sheetTabs[tarIndex] = sourceSheet;
                        activeSheetIndex = tarIndex;
                    }
                    self._setSheetsAndSheetTabs(sheetTabs);
                    var sheetCount = self.sheets.length;
                    if (activeSheetIndex < sheetCount) {
                        self._activeSheetIndex = activeSheetIndex;
                    } else {
                        self._activeSheetTabIndex = activeSheetIndex - sheetCount;
                    }
                };
                Workbook.prototype.clone = function (sheetName, targetIndex, newName, includeBindingSource) {
                    var self = this;
                    var oldSheet = self.getSheetFromName(sheetName);
                    if (isNullOrUndefined(includeBindingSource)) {
                        includeBindingSource = true;
                    }
                    if (isNullOrUndefined(oldSheet) || isNullOrUndefined(newName) || self.getSheetFromName(newName)) {
                        return;
                    }
                    self.suspendPaint();
                    self.suspendCalcService();
                    var jsonStr = JSON.stringify(oldSheet.toJSON({ newWorkSheetName: newName }));
                    if (targetIndex < 0) {
                        targetIndex = 0;
                    }
                    var newSheet = self._createSheet(newName);
                    self.addSheet(targetIndex, newSheet);
                    newSheet._getSheetSource()._isFromJSON = true;
                    newSheet.fromJSON(JSON.parse(jsonStr));
                    self.setActiveSheet(newSheet.name());
                    var tables = oldSheet.tables._tableList;
                    var newTables = newSheet.tables._tableList;
                    var dataSource;
                    var range;
                    for (var i = 0; i < tables.length; i++) {
                        if (tables[i]._bindingManager && includeBindingSource) {
                            dataSource = tables[i]._getDataSource();
                            newTables[i]._copyDataSourceImp(dataSource);
                        }
                        range = newTables[i].range();
                        newSheet._updateTableSlicer
                            && newSheet._updateTableSlicer(
                                range.row, range.col, range.rowCount, range.colCount, core_enum_1.SheetArea.viewport
                            );
                    }
                    dataSource = oldSheet._bindingManager._dataSource;
                    if (dataSource && includeBindingSource) {
                        var destBindingManager = newSheet._bindingManager;
                        destBindingManager.bind(dataSource);
                    }
                    self.resumeCalcService();
                    self.resumePaint();
                    return newSheet;
                };
                // 在命令执行之前保存选择区
                Workbook.prototype._saveSelectionBeforeCommandExecute = function (arg) {
                    var self = this;
                    var command = arg.command;
                    if (arg._actionType === 0 || !command._fromUndoManager) {
                        var currentActiveSheet = command.sheetName ? common_1._getSheetFromName(self, command.sheetName)
                            : common_1._getActiveSheet(self);
                        var activeCellRow = currentActiveSheet.getActiveRowIndex();
                        var activeCellCol = currentActiveSheet.getActiveColumnIndex();
                        var selections = currentActiveSheet.getSelections();
                        command._oldPosition = {
                            _selections: selections,
                            _activeCell: {
                                row: activeCellRow,
                                col: activeCellCol,
                            }
                        };
                    }
                };
                // 执行命令后恢复选择区
                Workbook.prototype._restoreSelectionAfterCommandExecuted = function (arg) {
                    var self = this;
                    var command = arg.command;
                    var oldPosition = command._oldPosition;
                    var currentActiveSheet = common_1._getActiveSheet(self);
                    var currentActiveSheetName = currentActiveSheet && currentActiveSheet.name();
                    if (currentActiveSheetName !== command.sheetName) {
                        common_1._setActiveSheet(self, command.sheetName);
                        currentActiveSheet = common_1._getActiveSheet(self);
                    }
                    if (!isNullOrUndefined(oldPosition)) {
                        currentActiveSheet.suspendPaint();
                        var activeCell = oldPosition._activeCell;
                        var selections = oldPosition._selections;
                        var floatingObjects = oldPosition._floatingObjects;
                        var notNeedClearSelections = oldPosition._notNeedClearSelections;
                        if (!isNullOrUndefined(activeCell)) {
                            currentActiveSheet._setActiveCellAndSelection(activeCell.row, activeCell.col);
                        }
                        if (!isNullOrUndefined(selections)) {
                            var selectionsLength = selections.length;
                            if (selectionsLength === 1) {
                                currentActiveSheet.setSelection(selections[0].row, selections[0].col, selections[0].rowCount, selections[0].colCount);
                            } else {
                                var activeCellRange;
                                if (!isNullOrUndefined(activeCell)) {
                                    activeCellRange = currentActiveSheet.getSelections()[0];
                                    for (var i = 0; i < selectionsLength; i++) {
                                        if (selections[i].containsRange(activeCellRange)) {
                                            currentActiveSheet._clearSelectionImp();
                                            break;
                                        }
                                    }
                                }
                                for (var i = 0; i < selectionsLength; i++) {
                                    var row = selections[i].row;
                                    var col = selections[i].col;
                                    var rowCount = selections[i].rowCount;
                                    var colCount = selections[i].colCount;
                                    currentActiveSheet.addSelection(row, col, rowCount, colCount);
                                }
                            }
                        }
                        Workbook._callFeatureHandler(self, 'onCommandExecuting', currentActiveSheet);
                        if (!isNullOrUndefined(floatingObjects)) {
                            for (var i = 0; i < floatingObjects.length; i++) {
                                floatingObjects[i].isSelected && floatingObjects[i].isSelected(true);
                            }
                            if (!notNeedClearSelections) {
                                currentActiveSheet._saveAndClearSheetSelections();
                            }
                        }
                        currentActiveSheet.showCell(activeCell.row, activeCell.col, 3, 3);
                        currentActiveSheet.resumePaint();
                    }
                };
                // 在命令执行中更改选择区
                Workbook.prototype.changeSelectionInCommandExecuting = function (command, activeCellRow, activeCellCol, newSelections, floatingObjects) {
                    if (command && command._oldPosition) {
                        var oldPosition = command._oldPosition;
                        var activeCell = oldPosition._activeCell;
                        if (!isNullOrUndefined(activeCell)) {
                            if (!isNullOrUndefined(activeCellRow)) {
                                activeCell.row = activeCellRow;
                            }
                            if (!isNullOrUndefined(activeCellCol)) {
                                activeCell.col = activeCellCol;
                            }
                        }
                        if (!isNullOrUndefined(newSelections)) {
                            oldPosition._selections = newSelections;
                        }
                        if (!isNullOrUndefined(floatingObjects)) {
                            oldPosition._floatingObjects = floatingObjects;
                        }
                    }
                };
                Workbook.prototype._clearActiveSheet = function () {
                    var sheet = this.getActiveSheet();
                    if (sheet) {
                        sheet._dispose(false);
                    }
                    this._activeSheetIndex = -1;
                };
                Workbook.prototype._clearActiveSheetTab = function () {
                    var sheetTab = this.getActiveSheetTab();
                    if (sheetTab) {
                        sheetTab._dispose(false);
                    }
                    this._activeSheetTabIndex = -1;
                };
                Workbook.prototype._getSheetsAndSheetTabs = function () {
                    return [].concat(this.sheets).concat(this._sheetTabs);
                };
                Workbook.prototype._setSheetsAndSheetTabs = function (items) {
                    this.sheets.length = 0;
                    this._sheetTabs.length = 0;
                    var sheets = this.sheets;
                    var sheetTabs = this._sheetTabs;
                    for (var _i = 0, items_1 = items; _i < items_1.length; _i++) {
                        var item = items_1[_i];
                        if (item instanceof worksheet_1.Worksheet) {
                            sheets.push(item);
                        } else {
                            sheetTabs.push(item);
                        }
                    }
                };
                Workbook.prototype._getSheetOrSheetTabFromName = function (name) {
                    return this.getSheetFromName(name) || this.getSheetTab(name);
                };
                Workbook.prototype._getSheetOrSheetTab = function (index) {
                    return this._getSheetsAndSheetTabs()[index];
                };
                Workbook.prototype._getActiveSheetOrSheetTab = function () {
                    return this.getActiveSheet() || this.getActiveSheetTab();
                };
                Workbook.prototype._setActiveSheetOrSheetTabIndexImp = function (value, focusPolicy, doNotGetCellTypeFocus, triggerEvent) {
                    var sheetCount = this.sheets.length;
                    if (value < sheetCount) {
                        this._setActiveSheetIndexImp(value, focusPolicy, doNotGetCellTypeFocus, triggerEvent);
                    } else {
                        value -= sheetCount;
                        this._setActiveSheetTabIndexImp(value, focusPolicy, doNotGetCellTypeFocus, triggerEvent);
                    }
                };
                Workbook.prototype._getActiveSheetOrSheetTabIndex = function () {
                    var index = this._activeSheetIndex;
                    if (index < 0) {
                        index = this.sheets.length + this._activeSheetTabIndex;
                    }
                    return index;
                };
                Workbook._defaultOptions = defaultOptions;
                Workbook._defaultSheetCount = 1;
                Workbook._defaultActiveSheetIndex = 0;
                return Workbook;
            }());
            exports.Workbook = Workbook;
            common_1._defineFeature(Workbook);
            Workbook.prototype.nextControl = defProperty('nextControl', keyword_null);
            Workbook.prototype.previousControl = defProperty('previousControl', keyword_null);
        }),
        './dist/core/workbook/workbookpanelex.js': (function (module, exports, __webpack_require__) {
            Object.defineProperty(exports, '__esModule', { value: true });
            var domUtil_1 = __webpack_require__(/*! ../util/domUtil */ './dist/core/util/domUtil.js');
            var common_1 = __webpack_require__(/*! ../util/common */ './dist/core/util/common.js');
            var Common_1 = __webpack_require__(/*! Common */ 'Common');
            var core_enum_1 = __webpack_require__(/*! ../core.enum */ './dist/core/core.enum.js');
            var sheettabbase_1 = __webpack_require__(/*! ./sheettabbase */ './dist/core/workbook/sheettabbase.js');
            var isNullOrUndefined = Common_1.Common._Types._isNullOrUndefined;
            var keyword_null = null;
            var browser = common_1._util._browser;
            var cancelDefault = common_1._util._cancelDefault;
            var createElement = common_1._util._createElement;
            var defProperty = common_1._util._defProperty;
            var DOCUMENT = document;
            var WINDOW = window;
            var Math_Round = Math.round;
            var Math_ceil = Math.ceil;
            var CSS_CLASS_SCROLLCONTAINER = 'gc-scroll-container';
            var CSS_CLASS_SCROLLCONTAINERCORNER = 'gc-scroll-corner-all';
            var CSS_CLASS_SCROLLARROW = 'gc-scroll-arrow';
            var CSS_CLASS_SCROLLBARWRAPPER = 'gc-scrollbar-wrapper';
            var CSS_CLASS_SCROLLBAR = 'gc-scroll-bar';
            var CSS_CLASS_ARROWUP = 'gc-scroll-arrowUp';
            var CSS_CLASS_ARROWDOWN = 'gc-scroll-arrowDown';
            var CSS_CLASS_ARROWLEFT = 'gc-scroll-arrowLeft';
            var CSS_CLASS_ARROWRIGHT = 'gc-scroll-arrowRight';
            var CSS_CLASS_MOBILE_TRACK = 'gc-scroll-mobile-track';
            var CSS_CLASS_MOBILE_THUMB = 'gc-scroll-mobile-thumb';
            var CSS_CLASS_MOBILE_STATE_ACTIVE = 'gc-scroll-mobile-state-active';
            var CSS_CLASS_VERTICALSCROLL = 'gc-scrollbar-vertical';
            var CSS_CLASS_HORIZONTALSCROLL = 'gc-scrollbar-horizontal';
            var CSS_CLASS_NONE_USER_SELECT = 'gc-no-user-select';
            var CSS_WIDTH = 'width';
            var CSS_HEIGHT = 'height';
            var CSS_CLASS_SCROLLBAR_STATEACTIVE_UI_STATE_ACTIVE = 'gc-scrollbar-stateActive ui-state-active';
            var CSS_LEFT = 'left';
            var CSS_RIGHT = 'right';
            var CSS_TOP = 'top';
            var CSS_BOTTOM = 'bottom';
            var CSS_MARGINLEFT = 'margin-left';
            var CSS_POSITION = 'position';
            var CSS_BORDER = 'border';
            var CSS_PADDING = 'padding';
            var CSS_MARGIN = 'margin';
            var CSS_OVERFLOW = 'overflow';
            var CSS_DISPLAY = 'display';
            var CSS_OUTLINE = 'outline';
            var CSS_CONST_ONE_HUNDRED_PERCENT = '100%';
            var CSS_BORDERWIDTH = 'borderWidth';
            var CSS_BOXSIZING = 'boxSizing';
            var CSS_ABSOLUTE = 'absolute';
            var CSS_RELATIVE = 'relative';
            var CSS_MARGINTOP = 'margin-top';
            var NS_SCROLLBAR = '.gcScrollbar';
            var E_MOUSEDOWN = 'mousedown' + NS_SCROLLBAR;
            var E_MOUSEUP = 'mouseup' + NS_SCROLLBAR;
            var E_MOUSEMOVE = 'mousemove' + NS_SCROLLBAR;
            var E_MOUSEOVER = 'mouseover' + NS_SCROLLBAR;
            var E_MOUSEOUT = 'mouseout' + NS_SCROLLBAR;
            var E_MOUSEWHEEL = 'mousewheel';
            var INLINE_BLOCK = 'inline-block';
            var CONTENT_BOX = 'content-box';
            var E_DOMMOUSESCROLL = 'DOMMouseScroll';
            var E_SCROLL = 'scroll' + NS_SCROLLBAR;
            var CONST_SCROLLBAR = 'scrollbar';

            function preventDefault(e) {
                if (e.preventDefault) {
                    e.preventDefault();
                } else {
                    e.returnValue = false;
                }
            }

            var ScrollOrientation;
            (function (ScrollOrientation) {
                ScrollOrientation[ScrollOrientation['horizontalScroll'] = 0] = 'horizontalScroll';
                ScrollOrientation[ScrollOrientation['verticalScroll'] = 1] = 'verticalScroll';
            })(ScrollOrientation = exports.ScrollOrientation || (exports.ScrollOrientation = {}));

            var _Scrollbar = (function () {
                function _Scrollbar(isHorizontalScroll, width, height, pageValue, maximum, minimum, scrollType, scrollbarAppearance, updateStateFn) {
                    this.updateStateFn = updateStateFn;
                    var self = this;
                    self._scrollbarAppearance = scrollbarAppearance;
                    self._isMousedownInScrollbar = false;
                    self._isMousedownInArrowButton = false;
                    self._scrollTimeOutArrow = keyword_null;
                    self._scrollTimeOutContainer = keyword_null;
                    self._initialDelay = 300;
                    self._trackClickPepeatFreq = 70;
                    self._isHorizontalScroll = isHorizontalScroll;
                    self._updateState(core_enum_1.ScrollbarState.show);
                    self._width((typeof width === 'number') ? width : 0);
                    self._height((typeof height === 'number') ? height : 0);
                    self._pageValue((typeof pageValue === 'number') ? pageValue : 0);
                    self._maximum((typeof maximum === 'number') ? maximum : 0);
                    self._minimum((typeof minimum === 'number') ? minimum : 0);
                    self._scrollType = (typeof scrollType === 'number') ? scrollType : 1;
                    self._isMouseCapture = false;
                    self._scrollPosition = 0;
                    self._value = self._minimum();
                    self._refreshLayout();
                }
                _Scrollbar.prototype._getScrollbar = function () {
                    return this._scrollContainerDiv;
                };
                _Scrollbar.prototype._updateState = function (state) {
                    if (state === core_enum_1.ScrollbarState.inactive && this._isMousedownInScrollbar) {
                        return;
                    }
                    this._scrollbarState = state;
                    this.updateStateFn && this.updateStateFn();
                };
                _Scrollbar.prototype.value = function (value) {
                    var self = this;
                    if (arguments.length === 0) {
                        return self._value;
                    }
                    if (typeof value === 'number' && value <= self._maximum() && value >= self._minimum()) {
                        self._value = value;
                        var scrollPosition = (value - self._minimum()) * self._scrollUnit;
                        self.scrollTo(scrollPosition, true);
                    }
                    return self;
                };
                // 刷新布局
                _Scrollbar.prototype._refreshLayout = function () {
                    var self = this;
                    var scrollbarWidth = 0;
                    var scrollbarHeight = 0;
                    var isInitEvent = false;
                    var scrollbarAppearance = self._scrollbarAppearance;
                    var isMobileScrollbar = scrollbarAppearance === core_enum_1.ScrollbarAppearance.mobile;
                    var borderWidth = !isMobileScrollbar ? 2 : 0;
                    var externalCssClass_PanelDiv = 'ui-widget ui-corner-all';
                    var height = self._height();
                    var width = self._width();
                    var arrowWidth = !isMobileScrollbar ? height : 0;
                    var scrollbarContainerWidth = width - 2 * arrowWidth;
                    var scrollbarContainerHeight = arrowWidth;
                    var css_scrollbarContainerPos = CSS_LEFT;
                    var css_scrollbarPos = CSS_RIGHT;
                    var cssClass_startArrow = CSS_CLASS_ARROWLEFT;
                    var cssClass_endArrow = CSS_CLASS_ARROWRIGHT;
                    var cssClass_scrollbar = CSS_CLASS_HORIZONTALSCROLL;
                    var css_scrollSpanMargin = CSS_MARGINLEFT;
                    var externalCssClass_ArrowStartDiv = 'ui-button ui-state-default ui-corner-bl btn btn-default';
                    var externalCssClass_ArrowStartSpan = 'ui-icon ui-icon-triangle-1-w';
                    var externalCssClass_Scroll = 'gc-scroll-handle ui-button ui-state-default ui-corner-all ui-draggable btn btn-default';
                    var externalCssClass_ScrollSpan = 'ui-icon ui-icon-grip-solid-vertical';
                    var externalCssClass_ArrowEndDiv = 'ui-button ui-state-default ui-corner-br btn btn-default';
                    var externalCssClass_ArrowEndSpan = 'ui-icon ui-icon-triangle-1-e';
                    self._scrollSize = scrollbarContainerWidth;
                    if (!self._isHorizontalScroll) {
                        arrowWidth = !isMobileScrollbar ? width : 0;
                        scrollbarContainerWidth = arrowWidth;
                        scrollbarContainerHeight = height - 2 * arrowWidth;
                        css_scrollbarContainerPos = CSS_TOP;
                        css_scrollbarPos = CSS_BOTTOM;
                        cssClass_startArrow = CSS_CLASS_ARROWUP;
                        cssClass_endArrow = CSS_CLASS_ARROWDOWN;
                        cssClass_scrollbar = CSS_CLASS_VERTICALSCROLL;
                        css_scrollSpanMargin = CSS_MARGINTOP;
                        externalCssClass_ArrowStartDiv = 'ui-button ui-state-default ui-corner-tr btn btn-default';
                        externalCssClass_ArrowStartSpan = 'ui-icon ui-icon-triangle-1-n';
                        externalCssClass_Scroll = 'gc-scroll-handle ui-button ui-state-default ui-corner-all ui-draggable btn btn-default';
                        externalCssClass_ScrollSpan = 'ui-icon ui-icon-grip-solid-horizontal';
                        externalCssClass_ArrowEndDiv = 'ui-button ui-state-default ui-corner-br btn btn-default';
                        externalCssClass_ArrowEndSpan = 'ui-icon ui-icon-triangle-1-s';
                        self._scrollSize = scrollbarContainerHeight;
                    }
                    // 创建滚动容器div
                    function createScrollContainerDiv() {
                        self._scrollContainerDiv = createElement('div');
                        self._$scrollContainerDiv = domUtil_1.GC$(self._scrollContainerDiv);
                        self._$scrollContainerDiv.css([CSS_POSITION, CSS_LEFT, CSS_TOP, CSS_OVERFLOW, CSS_OUTLINE, CSS_PADDING, CSS_MARGIN], [CSS_RELATIVE, 0, 0, 'hidden', 'none', 0, 0]).addClass(CSS_CLASS_SCROLLCONTAINER + ' ' + CSS_CLASS_SCROLLCONTAINERCORNER + ' ' + externalCssClass_PanelDiv + ' ');
                    }
                    // 创建箭头起点div
                    function createArrowStartDiv(scrollContainerDiv) {
                        self._$arrowStartDiv = domUtil_1.GC$._createElement('div',
                            [
                                CSS_POSITION, CSS_DISPLAY, CSS_BORDERWIDTH, CSS_PADDING, CSS_MARGIN, CSS_BOXSIZING
                            ],
                            [
                                CSS_ABSOLUTE, INLINE_BLOCK, '1px', 0, 0, CONTENT_BOX
                            ],
                            CSS_CLASS_SCROLLARROW + ' ' + externalCssClass_ArrowStartDiv,
                            scrollContainerDiv
                        );
                        self._$arrowStartSpan = domUtil_1.GC$._createElement('span',
                            [
                                CSS_DISPLAY, CSS_BORDER, CSS_PADDING, CSS_MARGIN
                            ],
                            [
                                'block', 'none', 0, 0
                            ],
                            cssClass_startArrow + ' ' + externalCssClass_ArrowStartSpan,
                            self._$arrowStartDiv
                        );
                    }
                    // 创建滚动条包装div
                    function createScrollBarWrapperDiv(scrollContainerDiv) {
                        self._$scrollbarWrapperDiv = domUtil_1.GC$._createElement('div',
                            [
                                CSS_POSITION, CSS_DISPLAY, CSS_BOXSIZING, CSS_BORDER, CSS_PADDING, CSS_MARGIN
                            ],
                            [
                                CSS_ABSOLUTE, INLINE_BLOCK, CONTENT_BOX, 'none', 0, 0
                            ],
                            CSS_CLASS_SCROLLBARWRAPPER + ' ' + CSS_CLASS_SCROLLBARWRAPPER,
                            scrollContainerDiv
                        );
                    }
                    function createScrollBarDiv(scrollbarWrapperDiv) {
                        self._$scrollbarDiv = domUtil_1.GC$._createElement('div', [], [], CSS_CLASS_NONE_USER_SELECT + ' ' + externalCssClass_Scroll + ' ' + CSS_CLASS_SCROLLBAR, scrollbarWrapperDiv);
                        self._$scrollbarSpan = domUtil_1.GC$._createElement('span',
                            [
                                CSS_DISPLAY, CSS_BORDER, CSS_PADDING, CSS_MARGIN
                            ],
                            [
                                'block', 'none', 0, 0
                            ], cssClass_scrollbar + ' ' + externalCssClass_ScrollSpan,
                            self._$scrollbarDiv
                        );
                    }
                    function createArrowEndDiv(scrollContainerDiv) {
                        self._$arrowEndDiv = domUtil_1.GC$._createElement('div',
                            [
                                CSS_POSITION, CSS_DISPLAY, CSS_BORDERWIDTH, CSS_PADDING, CSS_MARGIN, CSS_BOXSIZING
                            ],
                            [
                                CSS_ABSOLUTE, INLINE_BLOCK, '1px', 0, 0, CONTENT_BOX
                            ], CSS_CLASS_SCROLLARROW + ' ' + externalCssClass_ArrowEndDiv, scrollContainerDiv
                        );
                        self._$arrowEndSpan = domUtil_1.GC$._createElement('span',
                            [
                                CSS_DISPLAY, CSS_BORDER, CSS_PADDING, CSS_MARGIN
                            ],
                            [
                                'block', 'none', 0, 0
                            ], cssClass_endArrow + ' ' + externalCssClass_ArrowEndSpan, self._$arrowEndDiv
                        );
                    }
                    var scrollSize = self._scrollSize;
                    var valueScope = self._maximum() - self._minimum();
                    self._scrollbarSize = self._pageValue() * scrollSize / (valueScope + self._pageValue());
                    if (self._scrollbarSize > scrollSize) {
                        self._scrollbarSize = scrollSize;
                    }
                    if (self._scrollbarSize < 10) {
                        self._scrollbarSize = 10;
                    }
                    var scrollbarSize = self._scrollbarSize;
                    self._scrollUnit = valueScope === 0 ? 1 : (scrollSize - scrollbarSize) / valueScope;
                    if (self._isHorizontalScroll) {
                        scrollbarWidth = scrollbarSize;
                        scrollbarHeight = arrowWidth;
                    } else {
                        scrollbarWidth = arrowWidth;
                        scrollbarHeight = scrollbarSize;
                    }
                    if (!self._$scrollContainerDiv) {
                        isInitEvent = true;
                        createScrollContainerDiv();
                    }
                    if (isMobileScrollbar) {
                        self._$scrollContainerDiv.addClass(CSS_CLASS_MOBILE_TRACK);
                    } else {
                        self._$scrollContainerDiv.removeClass(CSS_CLASS_MOBILE_TRACK);
                    }
                    if (self._scrollUnit === 1) {
                        self._$scrollContainerDiv.parent().addClass('gc-useless-scrollbar');
                    } else {
                        self._$scrollContainerDiv.parent().removeClass('gc-useless-scrollbar');
                    }
                    if (!self._$arrowStartDiv) {
                        createArrowStartDiv(self._$scrollContainerDiv);
                    }
                    if (!self._$scrollbarWrapperDiv) {
                        createScrollBarWrapperDiv(self._$scrollContainerDiv);
                    }
                    if (!self._$scrollbarDiv) {
                        createScrollBarDiv(self._$scrollbarWrapperDiv);
                    } else {
                        self._$scrollbarDiv.removeAttr('style');
                    }
                    if (!isMobileScrollbar) {
                        self._$scrollbarDiv.css(
                            [
                                CSS_POSITION, CSS_BORDERWIDTH, CSS_PADDING, CSS_MARGIN, CSS_BOXSIZING
                            ],
                            [
                                CSS_ABSOLUTE, '1px', 0, 0, CONTENT_BOX
                            ]
                        ).removeClass(CSS_CLASS_MOBILE_THUMB);
                    } else {
                        self._$scrollbarDiv.css(CSS_POSITION, CSS_ABSOLUTE).addClass(CSS_CLASS_MOBILE_THUMB);
                    }
                    if (!self._$arrowEndDiv) {
                        createArrowEndDiv(self._$scrollContainerDiv);
                    }
                    if (!isMobileScrollbar) {
                        self._$scrollContainerDiv.css(
                            [
                                CSS_WIDTH, CSS_HEIGHT, CSS_BORDER
                            ],
                            [
                                width, height, 'none'
                            ]
                        );
                        self._$scrollbarWrapperDiv.css(
                            [
                                css_scrollbarContainerPos, CSS_WIDTH, CSS_HEIGHT
                            ],
                            [
                                arrowWidth, scrollbarContainerWidth, scrollbarContainerHeight
                            ]
                        );
                        self._$scrollbarDiv.css(
                            [
                                css_scrollbarContainerPos, CSS_WIDTH, CSS_HEIGHT
                            ],
                            [
                                self._scrollPosition,
                                Math_Round(scrollbarWidth - borderWidth),
                                Math_Round(scrollbarHeight - borderWidth)
                            ]
                        );
                        self._$arrowStartDiv.css(
                            [
                                css_scrollbarContainerPos, CSS_WIDTH, CSS_HEIGHT
                            ],
                            [
                                0, arrowWidth - borderWidth, arrowWidth - borderWidth
                            ]
                        );
                        self._$arrowStartSpan.css(
                            [
                                CSS_WIDTH, CSS_HEIGHT
                            ],
                            [
                                CSS_CONST_ONE_HUNDRED_PERCENT,
                                CSS_CONST_ONE_HUNDRED_PERCENT
                            ]
                        );
                        self._$arrowEndDiv.css(
                            [
                                css_scrollbarPos, CSS_WIDTH, CSS_HEIGHT
                            ],
                            [
                                0,
                                arrowWidth - borderWidth,
                                arrowWidth - borderWidth
                            ]
                        );
                        self._$arrowEndSpan.css(
                            [
                                CSS_WIDTH, CSS_HEIGHT
                            ],
                            [
                                CSS_CONST_ONE_HUNDRED_PERCENT,
                                CSS_CONST_ONE_HUNDRED_PERCENT
                            ]
                        );
                        self._$scrollbarSpan.css(
                            [
                                CSS_WIDTH, CSS_HEIGHT,
                                css_scrollSpanMargin
                            ],
                            [
                                arrowWidth - borderWidth,
                                arrowWidth - borderWidth,
                                Math.floor((self._scrollbarSize - arrowWidth) / 2)
                            ]
                        );
                        self._$scrollbarDiv.append(self._$scrollbarSpan);
                        self._$scrollContainerDiv.append(self._$arrowStartDiv);
                        self._$scrollContainerDiv.append(self._$arrowEndDiv);
                    } else {
                        removeStyle(self._$scrollContainerDiv, 'border');
                        if (!self._isHorizontalScroll) {
                            self._$scrollContainerDiv.css([CSS_WIDTH, CSS_HEIGHT], [CSS_CONST_ONE_HUNDRED_PERCENT, CSS_CONST_ONE_HUNDRED_PERCENT]);
                            self._$scrollbarWrapperDiv.css([css_scrollbarContainerPos, CSS_WIDTH, CSS_HEIGHT], [arrowWidth, CSS_CONST_ONE_HUNDRED_PERCENT, CSS_CONST_ONE_HUNDRED_PERCENT]);
                            self._$scrollbarDiv.css([css_scrollbarContainerPos, CSS_WIDTH, CSS_HEIGHT], [self._scrollPosition, CSS_CONST_ONE_HUNDRED_PERCENT, Math_Round(scrollbarHeight - borderWidth)]);
                        } else {
                            self._$scrollContainerDiv.css([CSS_WIDTH, CSS_HEIGHT], [CSS_CONST_ONE_HUNDRED_PERCENT, CSS_CONST_ONE_HUNDRED_PERCENT]);
                            self._$scrollbarWrapperDiv.css([css_scrollbarContainerPos, CSS_WIDTH, CSS_HEIGHT], [arrowWidth, CSS_CONST_ONE_HUNDRED_PERCENT, CSS_CONST_ONE_HUNDRED_PERCENT]);
                            self._$scrollbarDiv.css([css_scrollbarContainerPos, CSS_WIDTH, CSS_HEIGHT], [self._scrollPosition, Math_Round(scrollbarWidth - borderWidth), CSS_CONST_ONE_HUNDRED_PERCENT]);
                        }
                        self._$scrollbarSpan.remove();
                        self._$arrowStartDiv.remove();
                        self._$arrowEndDiv.remove();
                    }
                    if (isInitEvent) {
                        self._initEvents();
                    }
                };
                _Scrollbar.prototype._initEvents = function () {
                    var self = this;
                    function bindToArrowDiv($div, isStart) {
                        $div.bind(E_MOUSEDOWN, function (e) {
                            self._arrowMousedown(e, isStart);
                        }).bind(E_MOUSEUP, function (e) {
                            self._arrowMouseup(e, isStart);
                        }).bind(E_MOUSEOVER, function (e) {
                            self._arrowMouseover(e, isStart);
                        }).bind(E_MOUSEOUT, function (e) {
                            self._arrowMouseout(e, isStart);
                        });
                    }
                    bindToArrowDiv(self._$arrowStartDiv, true);
                    bindToArrowDiv(self._$arrowEndDiv, false);
                    self._$scrollbarDiv.bind(E_MOUSEDOWN, function (e) {
                        self._scrollbarMousedown(e);
                    }).bind(E_MOUSEMOVE, function (e) {
                        self._scrollbarMousemove(e);
                    }).bind(E_MOUSEUP, function (e) {
                        self._scrollbarMouseup(e);
                    }).bind(E_MOUSEOVER, function (e) {
                        self._scrollbarMouseover(e);
                    }).bind(E_MOUSEOUT, function (e) {
                        self._scrollbarMouseout(e);
                    });
                    self._$scrollbarWrapperDiv.bind(E_MOUSEDOWN, function (e) {
                        var isFirefox = browser && browser.mozilla;
                        if (isFirefox) {
                            var thisMouseDownTime = new Date().valueOf();
                            var lastMouseDownTime = self._lastMouseDownTime;
                            self._lastMouseDownTime = thisMouseDownTime;
                            if (lastMouseDownTime && (thisMouseDownTime - lastMouseDownTime < 100)) {
                                return;
                            }
                        }
                        self._scrollbarContainerMousedown(e);
                    }).bind(E_MOUSEUP, function (e) {
                        self._scrollbarContainerMouseup(e);
                    });
                    self._mousewheelHandler = function (event) {
                        self._scrollContainerMousewheel(event);
                    };
                    self._$scrollContainerDiv.bind(E_MOUSEWHEEL, self._mousewheelHandler);
                    self._$scrollContainerDiv.bind(E_DOMMOUSESCROLL, self._mousewheelHandler);
                    _Scrollbar._callFeatureHandler(self, 'initEvents', self._scrollContainerDiv);
                };
                _Scrollbar.prototype._changeMode = function (mode) {
                    this._scrollbarAppearance = mode;
                };
                _Scrollbar.prototype.dispose = function () {
                    var self = this;
                    function unbindScrollbar($div) {
                        if ($div) {
                            $div.unbind(NS_SCROLLBAR);
                        }
                    }
                    unbindScrollbar(self._$arrowEndDiv);
                    unbindScrollbar(self._$scrollbarDiv);
                    unbindScrollbar(self._$arrowStartDiv);
                    unbindScrollbar(self._$scrollbarWrapperDiv);
                    if (self._$scrollContainerDiv) {
                        if (self._mousewheelHandler) {
                            self._$scrollContainerDiv.unbind(E_MOUSEWHEEL, self._mousewheelHandler);
                            self._$scrollContainerDiv.unbind(E_DOMMOUSESCROLL, self._mousewheelHandler);
                        }
                        _Scrollbar._callFeatureHandler(self, 'dispose', self._scrollContainerDiv);
                        self._$scrollContainerDiv.unbind(NS_SCROLLBAR).remove();
                    }
                };
                _Scrollbar.prototype._handleDocumentMouseMove = function () {
                    var self = this;
                    if (!self._isMouseCapture) {
                        domUtil_1.GC$(DOCUMENT).bind(E_MOUSEMOVE, function (e) {
                            self._scrollbarMousemove(e);
                        }).bind(E_MOUSEUP, function (e) {
                            self._scrollbarMouseup(e);
                        });
                        self._isMouseCapture = true;
                    }
                };
                _Scrollbar.prototype._unhandleDocumentMouseMove = function () {
                    if (this._isMouseCapture) {
                        this._isMouseCapture = false;
                        domUtil_1.GC$(DOCUMENT).unbind(E_MOUSEMOVE).unbind(E_MOUSEUP);
                    }
                };
                _Scrollbar.prototype._arrowMousedown = function (e, isStart) {
                    var scrollValue = 0, self = this, isFirst = true;
                    self._isMousedownInArrowButton = true;
                    if (self._scrollTimeOutArrow !== null) {
                        return;
                    }
                    if (isStart) {
                        self._$arrowStartDiv.addClass(CSS_CLASS_SCROLLBAR_STATEACTIVE_UI_STATE_ACTIVE);
                        scrollValue = 0 - self._smallChange();
                        self._scrollEventType = core_enum_1._ScrollEventType.smallDecrement;
                    } else {
                        self._$arrowEndDiv.addClass(CSS_CLASS_SCROLLBAR_STATEACTIVE_UI_STATE_ACTIVE);
                        scrollValue = self._smallChange();
                        self._scrollEventType = 1;
                    }
                    var doScroll = function () {
                        self.scrollTo(self._scrollPosition + scrollValue * self._scrollUnit, false);
                        self._scrollTimeOutArrow = WINDOW.setTimeout(doScroll, isFirst ? self._initialDelay : self._trackClickPepeatFreq);
                        isFirst = false;
                    };
                    doScroll();
                    preventDefault(e);
                };
                _Scrollbar.prototype._arrowMouseup = function (e, isStart) {
                    var self = this;
                    var $arrowDiv = isStart ? self._$arrowStartDiv : self._$arrowEndDiv;
                    $arrowDiv.removeClass(CSS_CLASS_SCROLLBAR_STATEACTIVE_UI_STATE_ACTIVE);
                    self._endArrowScroll();
                    preventDefault(e);
                };
                _Scrollbar.prototype._arrowMouseover = function (e, isStart) {
                    var self = this;
                    var $arrowDiv = isStart ? self._$arrowStartDiv : self._$arrowEndDiv;
                    $arrowDiv.addClass('gc-scroll-arrow-hover ui-state-hover');
                    preventDefault(e);
                };
                _Scrollbar.prototype._arrowMouseout = function (e, isStart) {
                    var self = this;
                    var $arrowDiv = isStart ? self._$arrowStartDiv : self._$arrowEndDiv;
                    $arrowDiv.removeClass('gc-scroll-arrow-hover ui-state-hover' + ' ' + CSS_CLASS_SCROLLBAR_STATEACTIVE_UI_STATE_ACTIVE);
                    self._endArrowScroll();
                    preventDefault(e);
                };
                _Scrollbar.prototype._scrollbarMousedown = function (e) {
                    var self = this;
                    if (e.button === 0) {
                        self._isMousedownInScrollbar = true;
                        self._oldPosition = { x: e.pageX, y: e.pageY };
                        self._updateState(core_enum_1.ScrollbarState.show);
                        self._handleDocumentMouseMove();
                        self._$scrollContainerDiv.addClass(CSS_CLASS_MOBILE_STATE_ACTIVE);
                        self._$scrollbarDiv.addClass(CSS_CLASS_SCROLLBAR_STATEACTIVE_UI_STATE_ACTIVE);
                        var scrollbarOffset = self._$scrollbarDiv.offset(), scrollbarWidth = self._$scrollbarDiv.outerWidth(true), scrollbarHeight = self._$scrollbarDiv.outerHeight(true), scrollbarWrapperOffset = self._$scrollbarWrapperDiv.offset(), scrollbarWrapperWidth = self._$scrollbarWrapperDiv.outerWidth(true), scrollbarWrapperHeight = self._$scrollbarWrapperDiv.outerHeight(true);
                        self._edgePosition = {
                            isBeyondEdge: false,
                            startEdgePosition: {
                                x: scrollbarWrapperOffset.left + e.pageX - scrollbarOffset.left,
                                y: scrollbarWrapperOffset.top + e.pageY - scrollbarOffset.top
                            },
                            endEdgePosition: {
                                x: scrollbarWrapperOffset.left + scrollbarWrapperWidth - (scrollbarWidth - e.pageX + scrollbarOffset.left),
                                y: scrollbarWrapperOffset.top + scrollbarWrapperHeight - (scrollbarHeight - e.pageY + scrollbarOffset.top)
                            }
                        };
                    }
                    preventDefault(e);
                };
                _Scrollbar.prototype._scrollbarMousemove = function (e) {
                    var self = this;
                    if (self._isMousedownInScrollbar) {
                        self._updateState(core_enum_1.ScrollbarState.active);
                        self._currentPosition = { x: e.pageX, y: e.pageY };
                        self._scrollbarDrag();
                        self._oldPosition = self._currentPosition;
                        domUtil_1.GC$(DOCUMENT.body).attr('unselectable', 'on').addClass(CSS_CLASS_NONE_USER_SELECT);
                    }
                    preventDefault(e);
                };
                _Scrollbar.prototype._scrollbarMouseup = function (e) {
                    var self = this;
                    self._isMousedownInScrollbar = false;
                    self._scrollEventType = core_enum_1._ScrollEventType.thumbPosition;
                    self._edgePosition = null;
                    self._$scrollContainerDiv.trigger(E_SCROLL, {
                        newValue: self._value,
                        oldValue: self._value,
                        scrollOrientation: self._isHorizontalScroll ? ScrollOrientation.horizontalScroll : ScrollOrientation.verticalScroll,
                        scrollEventType: self._scrollEventType
                    });
                    var value = self._value, fixScrollPosition = (value - self._minimum()) * self._scrollUnit, css_direction = 'left';
                    var targetClassList = e.target.classList;
                    var isOnScrollbarThumb = targetClassList && targetClassList.contains(CSS_CLASS_MOBILE_THUMB);
                    if (!self._isHorizontalScroll) {
                        css_direction = 'top';
                    }
                    if (!isOnScrollbarThumb) {
                        self._updateState(core_enum_1.ScrollbarState.inactive);
                    } else {
                        self._updateState(core_enum_1.ScrollbarState.hide);
                    }
                    self._scrollPosition = fixScrollPosition;
                    self._$scrollbarDiv.css(css_direction, Math_Round(fixScrollPosition));
                    self._unhandleDocumentMouseMove();
                    domUtil_1.GC$(DOCUMENT.body).removeClass(CSS_CLASS_NONE_USER_SELECT);
                    if (domUtil_1.GC$(DOCUMENT.body).attr('unselectable')) {
                        domUtil_1.GC$(DOCUMENT.body).removeAttr('unselectable');
                    }
                    self._$scrollbarDiv.removeClass(CSS_CLASS_SCROLLBAR_STATEACTIVE_UI_STATE_ACTIVE);
                    self._$scrollContainerDiv.removeClass(CSS_CLASS_MOBILE_STATE_ACTIVE);
                    self._scrollEventType = 6;
                    self._$scrollContainerDiv.trigger(E_SCROLL, {
                        newValue: self._value,
                        oldValue: self._value,
                        scrollOrientation: self._isHorizontalScroll ? ScrollOrientation.horizontalScroll : ScrollOrientation.verticalScroll,
                        scrollEventType: self._scrollEventType
                    });
                    preventDefault(e);
                };
                _Scrollbar.prototype._scrollbarMouseover = function (e) {
                    this._$scrollbarDiv.addClass('gc-scrollbar-stateHover ui-state-hover');
                    preventDefault(e);
                };
                _Scrollbar.prototype._scrollbarMouseout = function (e) {
                    this._$scrollbarDiv.removeClass('gc-scrollbar-stateHover ui-state-hover');
                    preventDefault(e);
                };
                _Scrollbar.prototype._scrollContainerMousewheel = function (e) {
                    var self = this;
                    if (isNullOrUndefined(e.wheelDelta) && isNullOrUndefined(e.detail)) {
                        e.wheelDelta = e.originalEvent.wheelDelta;
                        e.detail = e.originalEvent.detail;
                    }
                    var wheelData = e.detail ? e.detail : e.wheelDelta / -40, dragOffset = wheelData / 3 * self._smallChange() * self._scrollUnit;
                    self._scrollEventType = dragOffset >= 0 ? 1 : 0;
                    self.scrollTo(self._scrollPosition + dragOffset, false);
                    self._scrollEventType = 6;
                    var args = {
                        newValue: self._value,
                        oldValue: self._value,
                        scrollOrientation: self._isHorizontalScroll ? ScrollOrientation.horizontalScroll : ScrollOrientation.verticalScroll,
                        scrollEventType: self._scrollEventType
                    };
                    self._$scrollContainerDiv.trigger(E_SCROLL, args);
                    preventDefault(e);
                };
                _Scrollbar.prototype._scrollbarContainerMousedown = function (e) {
                    var self = this, isFirst = true, pageX = e.pageX, pageY = e.pageY, direction = 0, offset = self._$scrollbarWrapperDiv.offset(), largetStepValue = self._largeChange();
                    if (self._scrollTimeOutContainer !== null) {
                        return;
                    }
                    if (self._isHorizontalScroll) {
                        direction = pageX - offset.left - self._scrollPosition;
                    } else {
                        direction = pageY - offset.top - self._scrollPosition;
                    }
                    var doScroll = function () {
                        var pos = 0, scrollPosition = self._scrollPosition;
                        if (self._isHorizontalScroll) {
                            pos = pageX - offset.left - scrollPosition;
                        } else {
                            pos = pageY - offset.top - scrollPosition;
                        }
                        if (pos * direction < 0 || pos >= 0 && pos < self._scrollbarSize) {
                            self._endContainerScroll();
                            return;
                        }
                        if (direction < 0) {
                            self._scrollEventType = core_enum_1._ScrollEventType.largeDecrement;
                            self.scrollTo(scrollPosition - largetStepValue * self._scrollUnit, false);
                        } else if (direction > 0) {
                            self._scrollEventType = core_enum_1._ScrollEventType.largeIncrement;
                            self.scrollTo(scrollPosition + largetStepValue * self._scrollUnit, false);
                        } else {
                            self._endContainerScroll();
                            return;
                        }
                        self._scrollTimeOutContainer = WINDOW.setTimeout(doScroll, isFirst ? self._initialDelay : self._trackClickPepeatFreq);
                        isFirst = false;
                    };
                    doScroll();
                    preventDefault(e);
                };
                _Scrollbar.prototype._scrollbarContainerMouseup = function (e) {
                    this._endContainerScroll();
                    preventDefault(e);
                };
                _Scrollbar.prototype._endContainerScroll = function () {
                    var self = this;
                    self._scrollTimeOutContainer && clearTimeout(self._scrollTimeOutContainer);
                    self._scrollTimeOutContainer = keyword_null;
                    self._scrollEventType = core_enum_1._ScrollEventType.endScroll;
                    var args = {
                        newValue: self._value,
                        oldValue: self._value,
                        scrollOrientation: self._isHorizontalScroll ? ScrollOrientation.horizontalScroll : ScrollOrientation.verticalScroll,
                        scrollEventType: self._scrollEventType
                    };
                    self._$scrollContainerDiv.trigger(E_SCROLL, args);
                };
                _Scrollbar.prototype._endArrowScroll = function () {
                    var self = this;
                    if (self._isMousedownInArrowButton) {
                        self._isMousedownInArrowButton = false;
                        self._scrollTimeOutArrow && clearTimeout(self._scrollTimeOutArrow);
                        self._scrollTimeOutArrow = keyword_null;
                        self._scrollEventType = 6;
                        var args = {
                            newValue: self._value,
                            oldValue: self._value,
                            scrollOrientation: self._isHorizontalScroll ? ScrollOrientation.horizontalScroll : ScrollOrientation.verticalScroll,
                            scrollEventType: self._scrollEventType
                        };
                        self._$scrollContainerDiv.trigger(E_SCROLL, args);
                    }
                };
                _Scrollbar.prototype._scrollbarDrag = function () {
                    var self = this;
                    var scrollPosition = self._scrollPosition, currentPosition = self._currentPosition, edgePosition = self._edgePosition;
                    var isBeyondStart, isBeyondEnd;
                    function getXY(position) {
                        return self._isHorizontalScroll ? position.x : position.y;
                    }
                    function setXY(position, value) {
                        if (self._isHorizontalScroll) {
                            position.x = value;
                        } else {
                            position.y = value;
                        }
                    }
                    var currentPositionXY = getXY(currentPosition);
                    var oldPositionXY = getXY(self._oldPosition);
                    if (edgePosition && edgePosition.isBeyondEdge) {
                        var startEdgePositionXY = getXY(edgePosition.startEdgePosition);
                        var endEdgePositionXY = getXY(edgePosition.endEdgePosition);
                        isBeyondStart = currentPositionXY < startEdgePositionXY;
                        isBeyondEnd = currentPositionXY > endEdgePositionXY;
                        if (isBeyondStart || isBeyondEnd) {
                            return;
                        }
                        if (oldPositionXY < startEdgePositionXY) {
                            setXY(self._oldPosition, startEdgePositionXY);
                        }
                        if (oldPositionXY > endEdgePositionXY) {
                            setXY(self._oldPosition, endEdgePositionXY);
                        }
                    }
                    var dragOffsetHV = currentPositionXY - oldPositionXY;
                    var destPosition = scrollPosition + dragOffsetHV;
                    if (destPosition !== scrollPosition) {
                        self._scrollEventType = 5;
                        self.scrollTo(destPosition, false);
                    }
                };
                _Scrollbar.prototype.scrollTo = function (destPosition, notTriggerEvent) {
                    var self = this;
                    var css_direction = CSS_TOP, scrollScope = self._scrollSize - self._scrollbarSize;
                    if (self._isHorizontalScroll) {
                        css_direction = CSS_LEFT;
                    }
                    var isBeyondMinEdge = false, isBeyondMaxEdge = false;
                    var isBeyondEdge = false;
                    if (destPosition > scrollScope) {
                        destPosition = scrollScope;
                        isBeyondEdge = true;
                        isBeyondMaxEdge = true;
                    }
                    if (destPosition < 0) {
                        destPosition = 0;
                        isBeyondEdge = true;
                        isBeyondMinEdge = true;
                    }
                    if (self._edgePosition) {
                        self._edgePosition.isBeyondEdge = isBeyondEdge;
                    }
                    var newValue = self._scrollType === core_enum_1.ScrollType.continuous ? Math_Round(destPosition / self._scrollUnit) + self._minimum() : destPosition / self._scrollUnit + self._minimum(), oldValue = self._value, ignoreUpdatePosition = false, newValueWithOffset;
                    if (!notTriggerEvent) {
                        var args = {
                            newValue: newValue,
                            oldValue: oldValue,
                            scrollOrientation: self._isHorizontalScroll ? ScrollOrientation.horizontalScroll : ScrollOrientation.verticalScroll,
                            scrollEventType: self._scrollEventType,
                            isBeyondMaxEdge: isBeyondMaxEdge,
                            isBeyondMinEdge: isBeyondMinEdge
                        };
                        self._$scrollContainerDiv.trigger(E_SCROLL, args);
                        ignoreUpdatePosition = args.ignoreUpdatePosition;
                        if (args.newValue > self._maximum()) {
                            args.newValue = self._maximum();
                        }
                        newValue = args.newValue;
                        newValueWithOffset = args.newValueWithOffset;
                    }
                    if (isNullOrUndefined(newValueWithOffset)) {
                        newValueWithOffset = newValue;
                    }
                    self._value = newValue;
                    if (self._scrollEventType !== 5) {
                        destPosition = (newValueWithOffset - self._minimum()) * self._scrollUnit;
                    }
                    self._scrollPosition = destPosition;
                    if (!ignoreUpdatePosition) {
                        self._$scrollbarDiv.css(css_direction, Math_Round(destPosition));
                    }
                };
                _Scrollbar.prototype.hitTest = function (x, y) {
                    var self = this, scrollbarX = 0, scrollbarY = 0;
                    var scrollbarWidth = self._$scrollbarDiv.outerWidth();
                    var scrollbarStartWidth = self._$arrowStartDiv.outerWidth();
                    var scrollbarWrapperWidth = self._$scrollbarWrapperDiv.outerWidth();
                    var scrollbarDivOffset = self._$scrollbarDiv.offset();
                    var scrollbarOffset = domUtil_1.GC$(self._getScrollbar()).offset();
                    var scrollbarTrackX = scrollbarDivOffset.left - scrollbarOffset.left - 18;
                    if (self._isHorizontalScroll) {
                        if (x < scrollbarX + scrollbarWrapperWidth + scrollbarStartWidth && x > scrollbarX + scrollbarStartWidth) {
                            if (x < scrollbarX + scrollbarTrackX + scrollbarWidth + scrollbarStartWidth && x > scrollbarTrackX) {
                                return {
                                    element: core_enum_1._ThumbButtonElement.ThumbButton,
                                    x: x,
                                    y: y
                                };
                            }
                            return { element: core_enum_1._ThumbButtonElement.TrackButton };
                        } else if (x <= scrollbarX + scrollbarStartWidth && x > scrollbarX) {
                            return {
                                element: core_enum_1._ThumbButtonElement.LeftButton,
                                x: x,
                                y: y
                            };
                        }
                        return {
                            element: core_enum_1._ThumbButtonElement.RightButton,
                            x: x,
                            y: y
                        };
                    }
                    var scrollbarHeight = self._$scrollbarDiv.outerHeight();
                    var scrollbarStartHeight = self._$arrowStartDiv.outerHeight();
                    var scrollbarWrapperHeight = self._$scrollbarWrapperDiv.outerHeight();
                    var scrollbarTrackY = scrollbarDivOffset.top - scrollbarOffset.top - 18;
                    if (y < scrollbarY + scrollbarWrapperHeight + scrollbarStartHeight && y > scrollbarY + scrollbarStartHeight) {
                        if (y < scrollbarY + scrollbarTrackY + scrollbarHeight + scrollbarStartHeight && y > scrollbarTrackY) {
                            return {
                                element: core_enum_1._ThumbButtonElement.ThumbButton,
                                x: x,
                                y: y
                            };
                        }
                        return {
                            element: core_enum_1._ThumbButtonElement.TrackButton
                        };
                    } else if (y <= scrollbarY + scrollbarStartHeight && y > scrollbarY) {
                        return {
                            element: core_enum_1._ThumbButtonElement.UpButton,
                            x: x,
                            y: y
                        };
                    }
                    return {
                        element: core_enum_1._ThumbButtonElement.DownButton,
                        x: x,
                        y: y
                    };
                };
                _Scrollbar.prototype._getScrollbarRect = function () {
                    var self = this;
                    return {
                        x: 0,
                        y: 0,
                        width: self._width(),
                        height: self._height()
                    };
                };
                _Scrollbar.prototype.show = function () {
                    this._$scrollbarWrapperDiv.show();
                };
                _Scrollbar.prototype.hide = function () {
                    this._$scrollbarWrapperDiv.hide();
                };
                _Scrollbar.prototype._getActualScrollbarSize = function (isHorizontalScroll) {
                    var scrollbar = this;
                    var scrollBarContainer = scrollbar._$scrollContainerDiv.parent() && scrollbar._$scrollContainerDiv.parent().parent();
                    if (scrollBarContainer) {
                        return isHorizontalScroll ? scrollBarContainer.height() : scrollBarContainer.width();
                    }
                    return keyword_null;
                };
                return _Scrollbar;
            }());
            exports._Scrollbar = _Scrollbar;
            function removeStyle($dom, styleName) {
                var dom = $dom.get(0);
                if (dom) {
                    dom.style[styleName] = '';
                }
            }
            common_1._defineFeature(_Scrollbar);
            var Scrollbar_prototype = _Scrollbar.prototype;
            Scrollbar_prototype._smallChange = defProperty('smallChange', 1);
            Scrollbar_prototype._largeChange = defProperty('largeChange', 10);
            Scrollbar_prototype._pageValue = defProperty('pageValue', 10, function (value) {
                if (value <= 0) {
                    this._pageValue(1);
                }
            });
            Scrollbar_prototype._maximum = defProperty('maximum', 100, function (value) {
                if (value <= 0) {
                    this._maximum(0);
                }
            });
            Scrollbar_prototype._minimum = defProperty('minimum', 0, function (value) {
                if (value <= 0) {
                    this._minimum(0);
                }
            });
            Scrollbar_prototype._width = defProperty('width', 0);
            Scrollbar_prototype._height = defProperty('height', 0);
            var _ScrollablePanel = (function () {
                function _ScrollablePanel(superPanel, content) {
                    var self = this;
                    self._showHorizontalScrollbar = true;
                    self._showVerticalScrollbar = true;
                    self._defaultScrollbarSize = 18;
                    self._$superPanel = superPanel && domUtil_1.GC$(superPanel);
                    self._$content = content && domUtil_1.GC$(content);
                    self._refreshLayout(true);
                }
                _ScrollablePanel.prototype._refreshLayout = function (isNewContent) {
                    var self = this;
                    function createDiv(position) {
                        if (position === CSS_ABSOLUTE) {
                            return domUtil_1.GC$._createElement('div', [
                                CSS_POSITION, CSS_LEFT, CSS_TOP, CSS_BORDER, CSS_PADDING, CSS_MARGIN
                            ],
                                [
                                    CSS_ABSOLUTE, 0, 0, 'none', 0, 0
                                ]);
                        } else if (position === CSS_RELATIVE) {
                            return domUtil_1.GC$._createElement('div', [
                                CSS_POSITION, CSS_LEFT, CSS_TOP, CSS_BORDER, CSS_PADDING, CSS_MARGIN
                            ],
                                [
                                    CSS_RELATIVE, 0, 0, 'none', 0, 0
                                ]);
                        } else {
                            return keyword_null;
                        }
                    }
                    function createScrollBar($container, isHorizontalScroll) {
                        var oriScrollBar = isHorizontalScroll ? self._horizontalScrollbar : self._verticalScrollbar;
                        if (!oriScrollBar) {
                            var scrollBar = new _Scrollbar(isHorizontalScroll);
                            var $barContainer = domUtil_1.GC$._createElement('div');
                            if (isHorizontalScroll) {
                                self._$horizontalBarContainer = $barContainer;
                                self._horizontalScrollbar = scrollBar;
                                $barContainer.css(
                                    [
                                        CSS_POSITION, CSS_LEFT, CSS_BOTTOM, CSS_BORDER, CSS_PADDING, CSS_MARGIN
                                    ],
                                    [
                                        CSS_ABSOLUTE, 0, 0, 'none', 0, 0
                                    ]
                                );
                            } else {
                                self._$verticalBarContainer = $barContainer;
                                self._verticalScrollbar = scrollBar;
                                $barContainer.css(
                                    [
                                        CSS_POSITION, CSS_RIGHT, CSS_TOP, CSS_BORDER, CSS_PADDING, CSS_MARGIN
                                    ],
                                    [
                                        CSS_ABSOLUTE, 0, 0, 'none', 0, 0
                                    ]
                                );
                            }
                            var scrollBarElement = (isHorizontalScroll ? self._horizontalScrollbar : self._verticalScrollbar)._getScrollbar();
                            $barContainer.append(scrollBarElement);
                            $container.append($barContainer);
                            return scrollBar;
                        }
                        return oriScrollBar;
                    }
                    function updateScrollBar(scrollBar, pageValue, $tempContentWrapper, size, contentValue, isHorizontalScroll) {
                        if (isHorizontalScroll) {
                            self._$horizontalBarContainer.css([CSS_WIDTH, CSS_HEIGHT], [pageValue, size]);
                            scrollBar._width(pageValue);
                            scrollBar._height(size);
                        } else {
                            self._$verticalBarContainer.css(
                                [
                                    CSS_WIDTH, CSS_HEIGHT
                                ],
                                [
                                    size, pageValue
                                ]
                            );
                            scrollBar._width(size);
                            scrollBar._height(pageValue);
                        }
                        scrollBar._minimum(0);
                        scrollBar._maximum(contentValue - pageValue);
                        scrollBar._pageValue(pageValue);
                        scrollBar._smallChange(isHorizontalScroll ? self._horizontalSmallChange() : self._verticalSmallChange());
                        scrollBar._largeChange(pageValue);
                        scrollBar._refreshLayout();
                        domUtil_1.GC$(scrollBar._getScrollbar()).bind(E_SCROLL, function (e, args) {
                            $tempContentWrapper.css(isHorizontalScroll ? CSS_LEFT : CSS_TOP, 0 - args.newValue);
                        });
                        if (isHorizontalScroll) {
                            self._$horizontalBarContainer.show();
                        } else {
                            self._$verticalBarContainer.show();
                        }
                    }
                    function createContentWrapper($container) {
                        if (!self._$contentWrapper) {
                            self._$contentWrapper = createDiv(CSS_RELATIVE);
                            self._$contentWrapper.css(
                                [
                                    CSS_OVERFLOW,
                                    CSS_DISPLAY,
                                    CSS_WIDTH
                                ],
                                [
                                    'hidden',
                                    INLINE_BLOCK,
                                    CSS_CONST_ONE_HUNDRED_PERCENT
                                ]
                            );
                            $container.append(self._$contentWrapper);
                        }
                    }
                    function createTempContentWrapper(contentWrapper) {
                        if (!self._$tempContentWrapper) {
                            self._$tempContentWrapper = domUtil_1.GC$._createElement('div', CSS_POSITION, CSS_RELATIVE, keyword_null, contentWrapper);
                        }
                    }
                    if (!self._$superPanel || !self._$content) {
                        return;
                    }
                    var scrollbarSize = self._defaultScrollbarSize, contentWidth = self._$content.width(), contentHeight = self._$content.height(), superPanelWidth = self._$superPanel.width(), superPanelHeight = self._$superPanel.height(), pageWidth = superPanelWidth - scrollbarSize, pageHeight = superPanelHeight - scrollbarSize, isNeedInitEvent = false;
                    if (!self._$container) {
                        self._$container = createDiv(CSS_RELATIVE);
                        self._$container.css(
                            [CSS_POSITION, CSS_OVERFLOW],
                            [CSS_RELATIVE, 'hidden']
                        );
                        isNeedInitEvent = true;
                    }
                    self._$container.css(CSS_HEIGHT, superPanelHeight);
                    createContentWrapper(self._$container);
                    createTempContentWrapper(self._$contentWrapper);
                    if (isNewContent) {
                        self._$tempContentWrapper.append(self._$content).css([CSS_TOP, CSS_LEFT], [0, 0]);
                    }
                    if (browser.chrome) {
                        contentWidth = Math_Round(contentWidth);
                        contentHeight = Math_Round(contentHeight);
                        superPanelWidth = Math_ceil(superPanelWidth);
                        superPanelHeight = Math_ceil(superPanelHeight);
                    }
                    var result = self._isNeedScrollbars(contentWidth, contentHeight, superPanelWidth, superPanelHeight);
                    var isNeedVScroll = result._isNeedVScroll, isNeedHScroll = result._isNeedHScroll;
                    if (isNeedHScroll) {
                        if (!isNeedVScroll) {
                            pageWidth += scrollbarSize;
                        }
                        var scrollH = createScrollBar(self._$container, true);
                        updateScrollBar(scrollH, pageWidth, self._$tempContentWrapper, scrollbarSize, contentWidth, true);
                    } else {
                        self._$horizontalBarContainer && self._$horizontalBarContainer.hide();
                    }
                    if (isNeedVScroll) {
                        if (!isNeedHScroll) {
                            pageHeight += scrollbarSize;
                        }
                        var scrollV = createScrollBar(self._$container, false);
                        updateScrollBar(scrollV, pageHeight, self._$tempContentWrapper, scrollbarSize, contentHeight, false);
                    } else {
                        self._$verticalBarContainer && self._$verticalBarContainer.hide();
                    }
                    if (!isNeedHScroll && !isNeedVScroll) {
                        pageWidth += scrollbarSize;
                        pageHeight += scrollbarSize;
                    }
                    self._showHorizontalScrollbar = isNeedHScroll;
                    self._showVerticalScrollbar = isNeedVScroll;
                    self._pageWidth = pageWidth;
                    self._pageHeight = pageHeight;
                    self._$contentWrapper.css(CSS_HEIGHT, pageHeight);
                    if (isNeedInitEvent) {
                        self._$superPanel.append(self._$container);
                        self._initEvent();
                    }
                };
                _ScrollablePanel.prototype._scrollChildIntoView = function (item) {
                    var self = this;
                    var offset = self._getScrollOffset(item), left = offset._left, top = offset._top;
                    if (!isNullOrUndefined(left) && self._horizontalScrollbar) {
                        self._hScrollTo(left);
                    }
                    if (!isNullOrUndefined(top) && self._verticalScrollbar) {
                        self._vScrollTo(top);
                    }
                };
                _ScrollablePanel.prototype._hScrollTo = function (left) {
                    var self = this;
                    self._horizontalScrollbar.value(left);
                    var pageWidth = self._pageWidth, contentHeight = self._$content.width();
                    if (left >= 0 && left <= contentHeight - pageWidth) {
                        self._$tempContentWrapper.css(CSS_LEFT, 0 - left);
                    }
                };
                _ScrollablePanel.prototype._vScrollTo = function (top) {
                    var self = this;
                    self._verticalScrollbar.value(top);
                    var pageHeight = self._pageHeight, contentHeight = self._$content.height();
                    if (top >= 0 && top <= contentHeight - pageHeight) {
                        self._$tempContentWrapper.css(CSS_TOP, 0 - top);
                    }
                };
                _ScrollablePanel.prototype._isNeedScrollbars = function (contentWidth, contentHeight, superPanelWidth, superPanelHeight) {
                    var scrollbarSize = this._defaultScrollbarSize;
                    var pageWidth = superPanelWidth;
                    var pageHeight = superPanelHeight - scrollbarSize;
                    var result = {
                        _isNeedHScroll: false,
                        _isNeedVScroll: false
                    };
                    if (contentWidth > superPanelWidth) {
                        result._isNeedHScroll = true;
                        result._isNeedVScroll = contentHeight > pageHeight;
                    }
                    if (contentHeight > superPanelHeight) {
                        result._isNeedVScroll = true;
                        result._isNeedHScroll = contentWidth > pageWidth;
                    }
                    return result;
                };
                _ScrollablePanel.prototype._getScrollOffset = function (item) {
                    var $child = domUtil_1.GC$(item);
                    var $contentWrapper = this._$contentWrapper;
                    var $tempContentWrapper = this._$tempContentWrapper;
                    var childOffset, tempContentWrapperOffset;
                    var contentWrapperOffset, leftDistance;
                    var rightDistance;
                    var topDistance;
                    var bottomDistance;
                    var result = {
                        _left: keyword_null,
                        _top: keyword_null
                    };
                    if (!item) {
                        return result;
                    }
                    childOffset = $child.offset();
                    tempContentWrapperOffset = $tempContentWrapper.offset();
                    contentWrapperOffset = $contentWrapper.offset();
                    childOffset.leftWidth = childOffset.left + $child.outerWidth();
                    childOffset.topHeight = childOffset.top + $child.outerHeight();
                    contentWrapperOffset.leftWidth = contentWrapperOffset.left + $contentWrapper.outerWidth();
                    contentWrapperOffset.topHeight = contentWrapperOffset.top + $contentWrapper.outerHeight();
                    leftDistance = childOffset.left - tempContentWrapperOffset.left;
                    if (childOffset.left < contentWrapperOffset.left) {
                        result._left = leftDistance;
                    } else if (childOffset.leftWidth > contentWrapperOffset.leftWidth) {
                        rightDistance = childOffset.leftWidth - tempContentWrapperOffset.left - $contentWrapper.innerWidth();
                        if (leftDistance < rightDistance) {
                            result._left = leftDistance;
                        } else {
                            result._left = rightDistance;
                        }
                    }
                    topDistance = childOffset.top - tempContentWrapperOffset.top;
                    if (childOffset.top < contentWrapperOffset.top) {
                        result._top = topDistance;
                    } else if (childOffset.topHeight > contentWrapperOffset.topHeight) {
                        bottomDistance = childOffset.topHeight - tempContentWrapperOffset.top - $contentWrapper.innerHeight();
                        if (topDistance < bottomDistance) {
                            result._top = topDistance;
                        } else {
                            result._top = bottomDistance;
                        }
                    }
                    return result;
                };
                _ScrollablePanel.prototype._initEvent = function () {
                    var self = this;
                    if (this._$tempContentWrapper) {
                        self._mousewheelHandler = function (event) {
                            self._contentContainerMousewheel(event);
                        };
                        self._$tempContentWrapper.bind(E_MOUSEWHEEL, self._mousewheelHandler);
                        self._$tempContentWrapper.bind(E_DOMMOUSESCROLL, self._mousewheelHandler);
                    }
                };
                _ScrollablePanel.prototype._contentContainerMousewheel = function (e) {
                    var self = this;
                    if (isNullOrUndefined(e.wheelDelta) && isNullOrUndefined(e.detail)) {
                        e.wheelDelta = e.originalEvent.wheelDelta;
                        e.detail = e.originalEvent.detail;
                    }
                    var wheelData = e.detail ? e.detail : e.wheelDelta / -40, dragOffset = wheelData;
                    var vScrollbar = self._verticalScrollbar, topOffset = parseInt(self._$tempContentWrapper.css(CSS_TOP), 10), pageHeight = self._pageHeight, contentHeight = self._$content.height();
                    if (contentHeight < pageHeight) {
                        contentHeight = pageHeight;
                    }
                    if (isNaN(topOffset)) {
                        topOffset = 0;
                    }
                    var posOffset = topOffset - dragOffset * self._verticalSmallChange();
                    if (posOffset >= 0) {
                        posOffset = 0;
                    }
                    if (posOffset < 0 && 0 - posOffset > contentHeight - pageHeight) {
                        posOffset = 0 - (contentHeight - pageHeight);
                    }
                    if (posOffset !== topOffset) {
                        self._$tempContentWrapper.css(CSS_TOP, posOffset);
                        if (self._showVerticalScrollbar) {
                            vScrollbar.value(0 - posOffset);
                        }
                    }
                    cancelDefault(e);
                };
                _ScrollablePanel.prototype.dispose = function () {
                    var self = this;
                    if (self._$container) {
                        if (self._horizontalScrollbar) {
                            self._horizontalScrollbar.dispose();
                        }
                        if (self._verticalScrollbar) {
                            self._verticalScrollbar.dispose();
                        }
                        if (self._$tempContentWrapper && self._mousewheelHandler) {
                            self._$tempContentWrapper.unbind(E_MOUSEWHEEL, self._mousewheelHandler);
                            self._$tempContentWrapper.unbind(E_DOMMOUSESCROLL, self._mousewheelHandler);
                        }
                        domUtil_1.GC$(self._$container).remove();
                    }
                };
                return _ScrollablePanel;
            }());
            exports._ScrollablePanel = _ScrollablePanel;
            var ScrollablePanel_Prototype = _ScrollablePanel.prototype;
            ScrollablePanel_Prototype._horizontalSmallChange = defProperty('horizontalSmallChange', 10);
            ScrollablePanel_Prototype._verticalSmallChange = defProperty('verticalSmallChange', 10);
            sheettabbase_1._SheetTabBase._registerFeature(CONST_SCROLLBAR, {
                preProcessMouseMove: function (argObj) {
                    var workbook = this._workbook, isDragScrollbar = workbook._vScrollbar._isMousedownInScrollbar || workbook._hScrollbar._isMousedownInScrollbar;
                    if (isDragScrollbar) {
                        argObj.r = true;
                    }
                }
            });

        }),
        './dist/core/worksheet/clipboardhelper.js': (function (module, exports, __webpack_require__) {
            Object.defineProperty(exports, '__esModule', { value: true });
            var common_1 = __webpack_require__(/*! ../util/common */ './dist/core/util/common.js');
            var Common_1 = __webpack_require__(/*! Common */ 'Common');
            var stylehelper_1 = __webpack_require__(/*! ./stylehelper */ './dist/core/worksheet/stylehelper.js');
            var style_1 = __webpack_require__(/*! ./style */ './dist/core/worksheet/style.js');
            var core_enum_1 = __webpack_require__(/*! ../core.enum */ './dist/core/core.enum.js');
            var StringHelper = Common_1.Common._StringHelper;
            var REG_IMAGE_ELEMENT = /<img[^>]+>/g;
            var IGNORE_STYLE = /font-variant-ligatures:.+?;|font-variant-numeric:.+?;/g;
            var browser = common_1._util._browser, isNullOrUndefined = Common_1.Common._Types._isNullOrUndefined, ArrayHelper_contains = Common_1.Common._ArrayHelper._contains;
            var keyword_null = null;
            function allowCopyPasteExcelStyle(workbook) {
                return workbook && workbook.options.allowCopyPasteExcelStyle;
            }
            function array_join(arr, ignoreSpace) {
                if (browser.msie) {
                    var stringBuilder = [];
                    for (var i = 0; i < arr.length; i++) {
                        if (ignoreSpace && arr[i].trim() === '') {
                            continue;
                        }
                        stringBuilder.push(arr[i]);
                    }
                    return stringBuilder.join('');
                }
                return arr.join('');
            }
            function generatePictureName(pictures) {
                var prefix = 'picture';
                var len = 1;
                var newName = prefix + len.toString();
                while (pictures.get(newName)) {
                    len++;
                    newName = prefix + len.toString();
                }
                return newName;
            }
            function getRowHeightArray(sheet, row, rowCount, sheetArea) {
                var result = [];
                for (var i = 0, length_1 = rowCount; i < length_1; i++) {
                    result[i] = sheet.getRowHeight(row + i, sheetArea);
                }
                return result;
            }
            function getColumnWidthArray(sheet, column, columnCount, sheetArea) {
                var result = [];
                for (var i = 0, length_2 = columnCount; i < length_2; i++) {
                    result[i] = sheet.getColumnWidth(column + i, sheetArea);
                }
                return result;
            }
            function removeHtmlComments(text) {
                if (!text) {
                    return text;
                }
                var index = 0;
                while (index < text.length) {
                    var index1 = text.indexOf('<!--', index);
                    if (index1 < 0) {
                        break;
                    }
                    index = index1;
                    var index2 = text.indexOf('-->', index);
                    if (index2 < 0) {
                        break;
                    }
                    index = index2;
                    text = text.substring(0, index1) + text.substring(index2 + '-->'.length);
                }
                return text;
            }
            function getSpanTotalHeight(row, spanRowCount, rowHeightArray) {
                var rowHeight = -1;
                if (rowHeightArray) {
                    rowHeight = 0;
                    for (var i = 0; i < spanRowCount; i++) {
                        rowHeight += rowHeightArray[row + i] || 0;
                    }
                }
                return rowHeight;
            }
            function getSpanTotalWidth(column, spanColCount, columnWidthArray) {
                var columnWidth = -1;
                if (columnWidthArray) {
                    columnWidth = 0;
                    for (var i = 0; i < spanColCount; i++) {
                        columnWidth += columnWidthArray[column + i] || 0;
                    }
                }
                return columnWidth;
            }
            var _ClipboardHelper = (function () {
                function _ClipboardHelper(workbook) {
                    var self = this;
                    self._fromSheet = keyword_null;
                    self._ranges = keyword_null;
                    self._isCutting = false;
                    self._owner = workbook;
                    self._createElement();
                }
                _ClipboardHelper.prototype._createElement = function () {
                    var self = this;
                    var container = document.createElement('div');
                    container.style.position = 'fixed';
                    container.style.top = '0px';
                    container.style.left = '0px';
                    container.style.width = '0px';
                    container.style.height = '0px';
                    container.style.overflow = 'hidden';
                    var element = document.createElement('div');
                    element.setAttribute('contenteditable', 'true');
                    element.setAttribute('gcUIElement', 'gcSheetClipboard');
                    element.setAttribute('tabindex', '-1');
                    element.style.position = 'absolute';
                    element.style.overflow = 'hidden';
                    element.style.background = 'white';
                    element.style.webkitUserSelect = 'text';
                    container.appendChild(element);
                    self._element = element;
                    var textAreaElement = document.createElement('textarea');
                    textAreaElement.setAttribute('gcUIElement', 'gcSheetClipboard');
                    if (self._owner && self._owner.options.enableAccessibility) {
                        textAreaElement.setAttribute('aria-hidden', 'true');
                    }
                    textAreaElement.setAttribute('tabindex', '-1');
                    textAreaElement.style.position = 'absolute';
                    textAreaElement.style.overflow = 'hidden';
                    textAreaElement.style.background = 'white';
                    textAreaElement.style.webkitUserSelect = 'text';
                    container.appendChild(textAreaElement);
                    self._textAreaElement = textAreaElement;
                    var host = self._owner.getHost();
                    if (host) {
                        host.appendChild(container);
                    }
                    if (!(browser.msie || browser.edge)) {
                        self._pasteHandler = function (e) {
                            var sheet = common_1._getActiveSheet(self._owner);
                            var clipboardData = e.clipboardData;
                            if (clipboardData) {
                                var clipboardHtml_1 = clipboardData.getData('text/html');
                                clipboardHtml_1 = clipboardHtml_1.replace(REG_IMAGE_ELEMENT, '');
                                clipboardHtml_1 = clipboardHtml_1.replace(IGNORE_STYLE, '');
                                var measureContainer = self._getMeasureContainer();
                                measureContainer.innerHTML = clipboardHtml_1;
                                var clipboardText_1;
                                if (clipboardHtml_1) {
                                    clipboardText_1 = self._getInnerText(measureContainer, true);
                                } else {
                                    clipboardText_1 = _ClipboardHelper.formatClipboardData(clipboardData.getData('text/plain'));
                                }
                                measureContainer.innerHTML = '';
                                if (clipboardText_1 || (clipboardHtml_1 && clipboardHtml_1.indexOf('<table') >= 0)) {
                                    sheet._doClipboardPaste(clipboardText_1, clipboardHtml_1);
                                } else {
                                    var blob = void 0;
                                    var items = clipboardData.items;
                                    for (var i = 0; i < items.length; i++) {
                                        if (items[i].type.indexOf('image') === 0) {
                                            blob = items[i].getAsFile();
                                            if (blob) {
                                                break;
                                            }
                                        }
                                    }
                                    if (blob) {
                                        var reader = new FileReader();
                                        reader.onload = function (event) {
                                            var img = new Image();
                                            img.src = event.target.result;
                                            img.onload = function () {
                                                sheet._doClipboardPaste(clipboardText_1, clipboardHtml_1, img.src);
                                            };
                                        };
                                        reader.readAsDataURL(blob);
                                    }
                                }
                            }
                            e.preventDefault();
                        };
                        element.addEventListener('paste', self._pasteHandler);
                        self._textAreaPasteHandler = function (e) {
                            var sheet = common_1._getActiveSheet(self._owner);
                            var clipboardData = e.clipboardData;
                            if (clipboardData) {
                                var clipboardText = _ClipboardHelper.formatClipboardData(clipboardData.getData('text/plain'));
                                if (!clipboardText) {
                                    var clipboardHtml = clipboardData.getData('text/html');
                                    if (clipboardHtml) {
                                        var measureContainer = self._getMeasureContainer();
                                        measureContainer.innerHTML = clipboardHtml;
                                        clipboardText = self._getInnerText(measureContainer, false);
                                        measureContainer.innerHTML = '';
                                    }
                                }
                                sheet._doClipboardPaste(clipboardText, '');
                            }
                            e.preventDefault();
                        };
                        textAreaElement.addEventListener('paste', self._textAreaPasteHandler);
                    }
                };
                _ClipboardHelper.prototype._dispose = function () {
                    var self = this;
                    var element = self._element;
                    if (element) {
                        if (!(browser.msie || browser.edge)) {
                            element.removeEventListener('paste', self._pasteHandler);
                            self._textAreaElement.removeEventListener('paste', self._textAreaPasteHandler);
                        }
                        var container = element.parentElement;
                        if (container) {
                            var containerParent = container.parentElement;
                            if (containerParent) {
                                containerParent.removeChild(container);
                            }
                        }
                        self._element = keyword_null;
                        self._textAreaElement = keyword_null;
                    }
                    var measureContainer = self._measureContainer;
                    if (measureContainer) {
                        var measureContainerParent = measureContainer.parentElement;
                        if (measureContainerParent) {
                            measureContainerParent.removeChild(measureContainer);
                        }
                        self._measureContainer = keyword_null;
                    }
                    var tempContainer = self._tempContainer;
                    if (tempContainer) {
                        var tempContainerParent = tempContainer.parentElement;
                        if (tempContainerParent) {
                            tempContainerParent.removeChild(tempContainer);
                        }
                        self._tempContainer = keyword_null;
                    }
                    self._owner = keyword_null;
                };
                _ClipboardHelper.prototype._setClipboardData = function (data) {
                    if (allowCopyPasteExcelStyle(this._owner)) {
                        this._element.innerHTML = data;
                    } else {
                        this._textAreaElement.value = data;
                    }
                };
                _ClipboardHelper.prototype._focus = function () {
                    if (allowCopyPasteExcelStyle(this._owner)) {
                        this._element.focus();
                    } else {
                        this._textAreaElement.focus();
                    }
                };
                _ClipboardHelper.prototype._select = function () {
                    if (allowCopyPasteExcelStyle(this._owner)) {
                        document.execCommand('selectAll');
                    } else {
                        this._textAreaElement.select();
                    }
                };
                _ClipboardHelper.prototype._getClipboardData = function () {
                    var html = '', text = '', image = '';
                    if (allowCopyPasteExcelStyle(this._owner)) {
                        var element = this._element;
                        if (element) {
                            var tables = element.getElementsByTagName('table');
                            if (tables.length > 0) {
                                html = tables[0].outerHTML;
                            } else {
                                var images = element.getElementsByTagName('img');
                                if (images.length > 0) {
                                    image = images[0].src;
                                }
                            }
                        }
                        text = this._getInnerText(this._element, true);
                    } else {
                        text = _ClipboardHelper.formatClipboardData(this._textAreaElement.value);
                    }
                    return {
                        html: html,
                        text: text,
                        image: image
                    };
                };
                _ClipboardHelper._getRangeHtml = function (sheet, copyPasteHeaderOptions, row, rowCount, column, columnCount, sheetArea, includeStyle, ignoredRows, ignoredCols, needGridline, useFallbackFont, needWidthHeight, forRangeToHtml) {
                    var actualRange = sheet._getActualRange(common_1._createRange(row, column, rowCount, columnCount), sheetArea), normalSpReg = new RegExp(String.fromCharCode(32), 'g'), htmlSp = '&nbsp;';
                    var includeColumnHeader = false;
                    var includeRowHeader = false;
                    if (sheetArea === core_enum_1.SheetArea.viewport) {
                        if (row < 0 && (copyPasteHeaderOptions & 2) === 2) {
                            includeColumnHeader = true;
                        }
                        if (column < 0 && (copyPasteHeaderOptions & 1) === 1) {
                            includeRowHeader = true;
                        }
                    }
                    row = actualRange.row;
                    column = actualRange.col;
                    rowCount = actualRange.rowCount;
                    columnCount = actualRange.colCount;
                    var viewportGrildine = needGridline ? sheet.options.gridline : keyword_null;
                    var headerGridline = needGridline ? {
                        color: '#d4d4d4',
                        showHorizontalGridline: true,
                        showVerticalGridline: true
                    } : keyword_null;
                    var rowHeightArray = needWidthHeight ? getRowHeightArray(sheet, row, rowCount, sheetArea) : keyword_null, columnWidthArray = needWidthHeight ? getColumnWidthArray(sheet, column, columnCount, sheetArea) : keyword_null;
                    if (sheetArea === core_enum_1.SheetArea.viewport) {
                        var rowHeaderColumnWidthArray = void 0, colHeaderRowHeightArray = void 0;
                        var rowHeaderHtml = keyword_null, colHeaderHtml = keyword_null, viewportHtml = _ClipboardHelper._getRangeHtmlImp(sheet, row, rowCount, column, columnCount, 3, ignoredRows, ignoredCols, includeStyle, actualRange, normalSpReg, htmlSp, viewportGrildine, useFallbackFont, rowHeightArray, columnWidthArray, forRangeToHtml);
                        if (includeRowHeader) {
                            rowHeaderColumnWidthArray = needWidthHeight ? getColumnWidthArray(sheet, column, columnCount, 2) : keyword_null;
                            var rowHeaderCount = sheet.getColumnCount(2);
                            rowHeaderHtml = _ClipboardHelper._getRangeHtmlImp(sheet, row, rowCount, 0, rowHeaderCount, 2, ignoredRows, [], includeStyle, actualRange, normalSpReg, htmlSp, headerGridline, useFallbackFont, rowHeightArray, rowHeaderColumnWidthArray, forRangeToHtml);
                        }
                        if (includeColumnHeader) {
                            colHeaderRowHeightArray = needWidthHeight ? getRowHeightArray(sheet, row, rowCount, 1) : keyword_null;
                            var colHeaderRowCount = sheet.getRowCount(1);
                            colHeaderHtml = _ClipboardHelper._getRangeHtmlImp(sheet, 0, colHeaderRowCount, column, columnCount, 1, [], ignoredCols, includeStyle, actualRange, normalSpReg, htmlSp, headerGridline, useFallbackFont, colHeaderRowHeightArray, columnWidthArray, forRangeToHtml);
                        }
                        return _ClipboardHelper._join(viewportHtml, rowHeaderHtml, colHeaderHtml, forRangeToHtml);
                    } else if (sheetArea === core_enum_1.SheetArea.rowHeader) {
                        var rowHeaderHtml = _ClipboardHelper._getRangeHtmlImp(sheet, row, rowCount, column, columnCount, 2, ignoredRows, ignoredCols, includeStyle, actualRange, normalSpReg, htmlSp, headerGridline, useFallbackFont, rowHeightArray, columnWidthArray, forRangeToHtml);
                        return _ClipboardHelper._join(rowHeaderHtml, keyword_null, keyword_null, forRangeToHtml);
                    } else if (sheetArea === core_enum_1.SheetArea.colHeader) {
                        var colHeaderHtml = _ClipboardHelper._getRangeHtmlImp(sheet, row, rowCount, column, columnCount, 1, ignoredRows, ignoredCols, includeStyle, actualRange, normalSpReg, htmlSp, headerGridline, useFallbackFont, rowHeightArray, columnWidthArray, forRangeToHtml);
                        return _ClipboardHelper._join(colHeaderHtml, keyword_null, keyword_null, forRangeToHtml);
                    }
                };
                _ClipboardHelper._join = function (viewportHtml, rowHeaderHtml, colHeaderHtml, forRangeToHtml) {
                    var arrayBuilder = viewportHtml, rowHeaderColumnCount = 0;
                    var concatOnRow = function (sourceRange, targetRange) {
                        var rangeBuilder = [], rowCount = sourceRange.length;
                        for (var row = 0; row < rowCount; row++) {
                            rangeBuilder.push(sourceRange[row].concat(targetRange[row]));
                        }
                        return rangeBuilder;
                    };
                    if (rowHeaderHtml) {
                        rowHeaderColumnCount = rowHeaderHtml[0].length;
                        arrayBuilder = concatOnRow(rowHeaderHtml, viewportHtml);
                    }
                    if (colHeaderHtml) {
                        var colHeaderRowCount = colHeaderHtml.length;
                        if (rowHeaderColumnCount) {
                            var cornerHtml = _ClipboardHelper._getRangeHtmlImp(keyword_null, 0, colHeaderRowCount, 0, rowHeaderColumnCount, keyword_null, [], [], false, keyword_null, keyword_null, keyword_null, keyword_null, false, [], [], forRangeToHtml);
                            colHeaderHtml = concatOnRow(cornerHtml, colHeaderHtml);
                        }
                        arrayBuilder = colHeaderHtml.concat(arrayBuilder);
                    }
                    return _ClipboardHelper._buildStr(arrayBuilder, forRangeToHtml);
                };
                _ClipboardHelper._buildStr = function (arrayBuilder, forRangeToHtml) {
                    var strBuilder = '';
                    var rowCount = arrayBuilder.length;
                    var row, col;
                    if (forRangeToHtml) {
                        strBuilder += '<table style="border-collapse: collapse">';
                    } else {
                        strBuilder += '<table gc-sjs-clipboard="true">';
                    }
                    for (row = 0; row < rowCount; row++) {
                        strBuilder += '<tr>';
                        for (col = 0; col < arrayBuilder[row].length; col++) {
                            strBuilder += arrayBuilder[row][col];
                        }
                        strBuilder += '</tr>';
                    }
                    strBuilder += '</table>';
                    return strBuilder;
                };
                _ClipboardHelper._isFromAnotherSpread = function (clipboardHtml) {
                    return clipboardHtml && clipboardHtml.indexOf('gc-sjs-clipboard="true"') >= 0;
                };
                _ClipboardHelper._getRangeHtmlImp = function (sheet, row, rowCount, column, columnCount, sheetArea, ignoredRows, ignoredCols, includeStyle, actualRange, normalSpReg, htmlSp, gridline, useFallbackFont, rowHeightArray, columnWidthArray, forRangeToHtml) {
                    var gridlineColor, showHorizontalGridline, showVerticalGridline;
                    if (gridline) {
                        gridlineColor = gridline.color;
                        showHorizontalGridline = gridline.showHorizontalGridline;
                        showVerticalGridline = gridline.showVerticalGridline;
                    }
                    var strBuilder = [];
                    for (var r = 0; r < rowCount; r++) {
                        var rowIndex = row + r;
                        if (ArrayHelper_contains(ignoredRows, rowIndex)) {
                            continue;
                        }
                        if (forRangeToHtml && rowHeightArray && rowHeightArray[rowIndex] <= 0) {
                            continue;
                        }
                        var rowStrBuilder = [];
                        for (var c = 0; c < columnCount; c++) {
                            var columnIndex = column + c;
                            if (ArrayHelper_contains(ignoredCols, columnIndex)) {
                                continue;
                            }
                            if (forRangeToHtml && columnWidthArray && columnWidthArray[columnIndex] <= 0) {
                                continue;
                            }
                            var colStrBuilder = '', span = void 0, style = void 0, spanRowCount = 1, spanColCount = 1;
                            if (includeStyle && sheet) {
                                span = sheet.getSpan(rowIndex, columnIndex, sheetArea);
                                if (span && _ClipboardHelper.isPartSpan(span, actualRange, ignoredRows, ignoredCols)) {
                                    span = keyword_null;
                                }
                                if (span) {
                                    if (span.row !== rowIndex || span.col !== columnIndex) {
                                        continue;
                                    } else {
                                        style = sheet.getActualStyle(rowIndex, columnIndex, sheetArea);
                                        var endStyle = sheet.getActualStyle(span.row + span.rowCount - 1, span.col + span.colCount - 1, sheetArea);
                                        if (!style.borderRight && endStyle.borderRight) {
                                            style.borderRight = endStyle.borderRight;
                                        }
                                        if (!style.borderBottom && endStyle.borderBottom) {
                                            style.borderBottom = endStyle.borderBottom;
                                        }
                                    }
                                }
                            }
                            colStrBuilder += '<td';
                            var cellValue = sheet && sheet.getValue(rowIndex, columnIndex, sheetArea);
                            if (includeStyle && sheet) {
                                if (span) {
                                    spanRowCount = span.rowCount;
                                    if (spanRowCount > 1) {
                                        colStrBuilder += (' rowSpan=' + spanRowCount);
                                    }
                                    spanColCount = span.colCount;
                                    if (spanColCount > 1) {
                                        colStrBuilder += (' colSpan=' + spanColCount);
                                    }
                                }
                                if (!style) {
                                    style = sheet.getActualStyle(rowIndex, columnIndex, sheetArea);
                                }
                                var convertVAlign = _ClipboardHelper.convertVAlign, convertHAlign = _ClipboardHelper.convertHAlign, convertLineBorder = _ClipboardHelper.convertLineBorder;
                                if (forRangeToHtml) {
                                    colStrBuilder += ' style="padding: 0; ';
                                } else {
                                    colStrBuilder += ' style="';
                                }
                                var needHorizontalGridline = showHorizontalGridline;
                                var needVerticalGridline = showVerticalGridline;
                                var backColor = style.backColor;
                                if (backColor) {
                                    colStrBuilder += ('background-color: ' + backColor + ';');
                                    needHorizontalGridline = false;
                                    needVerticalGridline = false;
                                }
                                var foreColor = style.foreColor;
                                if (foreColor) {
                                    colStrBuilder += ('color: ' + foreColor + ';');
                                }
                                var font = style.font;
                                if (font) {
                                    if (useFallbackFont) {
                                        font = font + ', ' + common_1.FallbackFontFamily;
                                    }
                                    colStrBuilder += ('font: ' + font.replace(/"/g, '\'') + ';');
                                }
                                var vAlign = style.vAlign;
                                if (!isNullOrUndefined(vAlign)) {
                                    colStrBuilder += ('vertical-align: ' + convertVAlign(vAlign) + ';');
                                }
                                var hAlign = style.hAlign;
                                if (!isNullOrUndefined(hAlign)) {
                                    if (forRangeToHtml) {
                                        hAlign = common_1._util._getHAlignByValueType(hAlign, cellValue);
                                    }
                                    var textAlign = convertHAlign(hAlign);
                                    if (textAlign) {
                                        colStrBuilder += ('text-align: ' + textAlign + ';');
                                    }
                                }
                                var borderLeft = style.borderLeft;
                                if (borderLeft) {
                                    colStrBuilder += ('border-left: ' + convertLineBorder(borderLeft) + ';');
                                    needVerticalGridline = false;
                                }
                                var borderRight = style.borderRight;
                                if (borderRight) {
                                    colStrBuilder += ('border-right: ' + convertLineBorder(borderRight) + ';');
                                    needVerticalGridline = false;
                                }
                                var borderTop = style.borderTop;
                                if (borderTop) {
                                    colStrBuilder += ('border-top: ' + convertLineBorder(borderTop) + ';');
                                    needHorizontalGridline = false;
                                }
                                var borderBottom = style.borderBottom;
                                if (borderBottom) {
                                    colStrBuilder += ('border-bottom: ' + convertLineBorder(borderBottom) + ';');
                                    needHorizontalGridline = false;
                                }
                                if (needHorizontalGridline && needVerticalGridline) {
                                    colStrBuilder += ('border: 1px solid ' + gridlineColor + ';');
                                } else if (needHorizontalGridline) {
                                    colStrBuilder += ('border-top: 1px solid ' + gridlineColor + ';');
                                    colStrBuilder += ('border-bottom: 1px solid ' + gridlineColor + ';');
                                } else if (needVerticalGridline) {
                                    colStrBuilder += ('border-left: 1px solid ' + gridlineColor + ';');
                                    colStrBuilder += ('border-right: 1px solid ' + gridlineColor + ';');
                                }
                                var fontHeight = font ? common_1._util._getFontHeight(font) : 0;
                                colStrBuilder += _ClipboardHelper._getWidthHeight(r, c, spanRowCount, spanColCount, rowHeightArray, columnWidthArray, fontHeight);
                                colStrBuilder += '"';
                            }
                            colStrBuilder += '>';
                            var hasLineThrough = void 0, hasUnderline = void 0;
                            if (includeStyle && sheet) {
                                var textDecoration = style.textDecoration;
                                hasLineThrough = (textDecoration & 2) === 2;
                                hasUnderline = (textDecoration & 1) === 1;
                                if (!hasUnderline) {
                                    hasUnderline = (textDecoration & 8) === 8;
                                }
                                if (hasLineThrough) {
                                    colStrBuilder += ('<s>');
                                }
                                if (hasUnderline) {
                                    colStrBuilder += ('<u>');
                                }
                            }
                            var cellText = sheet ? sheet.getText(rowIndex, columnIndex, sheetArea) : '';
                            if (!cellText) {
                                if (browser.chrome) {
                                    cellText = ' ';
                                } else if (browser.safari) {
                                    cellText = '&nbsp;';
                                }
                            } else {
                                if ((cellText[0] === ' ' || cellText[cellText.length - 1] === ' ')
                                    && typeof cellValue === 'number') {
                                    cellText = cellText.trim();
                                }
                                cellText = StringHelper._escapeHtml(cellText).replace(normalSpReg, htmlSp);
                            }
                            colStrBuilder += cellText;
                            if (includeStyle) {
                                if (hasUnderline) {
                                    colStrBuilder += ('</u>');
                                }
                                if (hasLineThrough) {
                                    colStrBuilder += ('</s>');
                                }
                            }
                            colStrBuilder += '</td>';
                            rowStrBuilder.push(colStrBuilder);
                        }
                        strBuilder.push(rowStrBuilder);
                    }
                    return strBuilder;
                };
                _ClipboardHelper._getWidthHeight = function (r, c, spanRowCount, spanColCount, rowHeightArray, columnWidthArray, fontHeight) {
                    var result = '';
                    var rowHeight = getSpanTotalHeight(r, spanRowCount, rowHeightArray);
                    if (rowHeight > 0) {
                        rowHeight = rowHeight - 1;
                    }
                    var columnWidth = getSpanTotalWidth(c, spanColCount, columnWidthArray);
                    if (columnWidth > 0) {
                        columnWidth = columnWidth - 1;
                    }
                    if (rowHeight >= 0 && columnWidth >= 0) {
                        var lineHeight = Math.min(fontHeight, rowHeight);
                        result = 'overflow: hidden;white-space: nowrap;height: ' + rowHeight + 'px;line-height: ' + lineHeight + 'px; width: ' + columnWidth + 'px;max-width: ' + columnWidth + 'px;min-width: ' + columnWidth + 'px;';
                    }
                    return result;
                };
                _ClipboardHelper.prototype._getMeasureContainer = function () {
                    var self = this;
                    if (!self._measureContainer) {
                        var container = document.createElement('div');
                        container.style.display = 'none';
                        var host = self._owner.getHost();
                        if (host) {
                            host.appendChild(container);
                        }
                        self._measureContainer = container;
                    }
                    return self._measureContainer;
                };
                _ClipboardHelper.prototype._getTempContainner = function () {
                    var self = this;
                    if (!self._tempContainer) {
                        var container = document.createElement('div');
                        container.style.display = 'none';
                        var host = self._owner.getHost();
                        if (host) {
                            host.appendChild(container);
                        }
                        self._tempContainer = container;
                    }
                    return self._tempContainer;
                };
                _ClipboardHelper.prototype._setRangeHtml = function (html, sheet, row, column) {
                    var container = this._getMeasureContainer();
                    container.innerHTML = html;
                    var tables = container.getElementsByTagName('table');
                    var pasteSkipInvisibleRange = sheet._getPasteSkipInvisibleRange();
                    if (tables.length > 0) {
                        var tableData = this._getTableData(tables[0], true);
                        for (var r = 0, rowIndex = row + r; r < tableData.length; r++, rowIndex++) {
                            var tableRowData = tableData[r];
                            if (pasteSkipInvisibleRange) {
                                while (sheet.getRowHeight(rowIndex) === 0) {
                                    rowIndex++;
                                }
                            }
                            for (var c = 0, colIndex = column + c; c < tableRowData.length; c++, colIndex++) {
                                var tableCellData = tableRowData[c];
                                if (tableCellData) {
                                    if (pasteSkipInvisibleRange) {
                                        while (sheet.getColumnWidth(colIndex) === 0) {
                                            colIndex++;
                                        }
                                    }
                                    sheet._setStyleWithoutLocked(rowIndex, colIndex, tableCellData.style);
                                    var spanRowCount = tableCellData.rowSpan, spanColCount = tableCellData.colSpan;
                                    if (spanRowCount > 1 || spanColCount > 1) {
                                        var span = sheet.getSpan(rowIndex, colIndex);
                                        if (span) {
                                            span.row = rowIndex;
                                            span.col = colIndex;
                                            span.rowCount = spanRowCount;
                                            span.colCount = spanColCount;
                                        } else {
                                            sheet.addSpan(rowIndex, colIndex, spanRowCount, spanColCount);
                                        }
                                    }
                                }
                            }
                        }
                    }
                    container.innerHTML = '';
                };
                _ClipboardHelper.prototype._setRangeImage = function (imageSrc, sheet, startRow, startColumn) {
                    var pictures = sheet.pictures;
                    if (pictures) {
                        var pictureName = generatePictureName(pictures);
                        var picture = pictures.add(pictureName, imageSrc, 0, 0);
                        picture.startRow(startRow);
                        picture.startColumn(startColumn);
                    }
                };
                _ClipboardHelper.prototype._getTableData = function (table, withStyle) {
                    var tempContainer = this._getTempContainner();
                    var tableData = [], spaceReg = / +/g;
                    for (var r = 0; r < table.rows.length; r++) {
                        var tableRow = table.rows[r];
                        if (!tableData[r]) {
                            tableData[r] = [];
                        }
                        var tableRowData = tableData[r];
                        for (var c = 0, columnIndex = 0; c < tableRow.cells.length; c++) {
                            var tableCell = tableRow.cells[c];
                            while (tableRowData[columnIndex]) {
                                columnIndex++;
                            }
                            var tableCellData = tableRowData[columnIndex] = {}, style = void 0;
                            if (withStyle) {
                                style = _ClipboardHelper.getStyleFromDOM(tableCell);
                                tableCellData.style = style;
                            }
                            tempContainer.innerHTML = tableCell.innerHTML.replace(spaceReg, ' ');
                            tableCellData.text = tempContainer.innerText;

                            tableCellData.rowSpan = tableCell.rowSpan;
                            var styleText = tableCell.getAttribute('style');
                            if (styleText && styleText.indexOf('mso-ignore:colspan;') >= 0) {
                                tableCellData.colSpan = 1;
                            } else {
                                tableCellData.colSpan = tableCell.colSpan;
                            }
                            for (var j = 0; j < tableCell.rowSpan; j++) {
                                for (var k = 0; k < tableCell.colSpan; k++) {
                                    if (j !== 0 || k !== 0) {
                                        if (!tableData[r + j]) {
                                            tableData[r + j] = [];
                                        }
                                        var tempTableRowData = tableData[r + j];
                                        tempTableRowData[columnIndex + k] = { style: style, text: '', rowSpan: 1, colSpan: 1 };
                                    }
                                }
                            }
                            columnIndex += tableCell.colSpan;
                        }
                    }
                    tempContainer.innerHTML = '';
                    return tableData;
                };
                _ClipboardHelper.prototype._getInnerText = function (element, removeEnter) {
                    var strBuilder = [];
                    if (element) {
                        var tables = element.getElementsByTagName('table');
                        if (tables.length > 0) {
                            var tableData = this._getTableData(tables[0], false);
                            var htmlSpReg = new RegExp(String.fromCharCode(160), 'g'), normalSp = String.fromCharCode(32);
                            for (var r = 0, rc = tableData.length; r < rc; r++) {
                                var tableRowData = tableData[r];
                                for (var c = 0, cc = tableRowData.length; c < cc; c++) {
                                    var text = tableRowData[c] ? tableRowData[c].text : '';
                                    if (text.indexOf('\n') >= 0) {
                                        if (removeEnter) {
                                            if (text.indexOf('\r\n') >= 0) {
                                                text = array_join(text.split('\r\n'), true);
                                            }
                                            text = array_join(text.split('\n'), true);
                                        } else {
                                            text = '"' + text + '"';
                                        }
                                    }
                                    strBuilder.push(text.replace(htmlSpReg, normalSp));
                                    if (c < cc - 1) {
                                        strBuilder.push('\t');
                                    }
                                }
                                if (r < rc - 1) {
                                    strBuilder.push('\r\n');
                                }
                            }
                        } else {
                            strBuilder.push(removeHtmlComments(element.innerText).trim());
                        }
                    }
                    return strBuilder.join('');
                };
                _ClipboardHelper.prototype._reset = function (isSystemPaste) {
                    var self = this;
                    self._fromSheet = keyword_null;
                    self._ranges = keyword_null;
                    self._isCutting = false;
                    self._owner._trigger('ClipboardStatusChanged', { isReset: true, isSystemPasted: !!isSystemPaste });
                };
                _ClipboardHelper.isPartSpan = function (span, range, ignoredRows, ignoredCols) {
                    if (!range.containsRange(span)) {
                        return true;
                    }
                    for (var _i = 0, ignoredRows_1 = ignoredRows; _i < ignoredRows_1.length; _i++) {
                        var ignoredRow = ignoredRows_1[_i];
                        if (span.row <= ignoredRow && ignoredRow < span.row + span.rowCount) {
                            return true;
                        }
                    }
                    for (var _a = 0, ignoredCols_1 = ignoredCols; _a < ignoredCols_1.length; _a++) {
                        var ignoredCol = ignoredCols_1[_a];
                        if (span.col <= ignoredCol && ignoredCol < span.col + span.colCount) {
                            return true;
                        }
                    }
                    return false;
                };
                _ClipboardHelper.formatClipboardData = function (data) {
                    var sbr = [];
                    if (data) {
                        var cellDelimiter = '"';
                        var inCell = false;
                        for (var i = 0; i < data.length; i++) {
                            var previousChar = i > 0 ? data[i - 1] : '';
                            var tempChar = data[i];
                            if (tempChar === cellDelimiter) {
                                inCell = !inCell;
                                sbr.push(cellDelimiter);
                            } else if (!inCell && tempChar === '\n' && previousChar !== '\r') {
                                sbr.push('\r\n');
                            } else {
                                sbr.push(tempChar);
                            }
                        }
                        return sbr.join('');
                    }
                    return '';
                };
                _ClipboardHelper.convertHAlign = function (hAlign) {
                    var dict = {
                        0: 'left',
                        1: 'center',
                        2: 'right'
                    };
                    return dict[hAlign];
                };
                _ClipboardHelper.convertVAlign = function (vAlign) {
                    var dict = {
                        0: 'top',
                        1: 'middle',
                        2: 'bottom'
                    };
                    return dict[vAlign];
                };
                _ClipboardHelper.convertLineBorder = function (border) {
                    var dict = {
                        0: 'none',
                        1: 'solid',
                        2: 'solid',
                        3: 'dashed',
                        4: 'dotted',
                        5: 'solid',
                        6: 'double',
                        7: 'dotted',
                        8: 'dashed',
                        9: 'dashed',
                        10: 'dashed',
                        11: 'dashed',
                        12: 'dashed',
                        13: 'dashed'
                    };
                    var lineWidthDict = {
                        9: 0.5,
                        1: 0.5,
                        3: 0.5,
                        4: 0.5,
                        7: 0.5,
                        11: 0.5,
                        2: 1,
                        10: 1,
                        12: 1,
                        8: 1,
                        13: 1,
                        5: 1.5,
                        6: 1.5
                    };
                    return lineWidthDict[border.style] + 'pt ' + dict[border.style] + ' ' + border.color;
                };
                _ClipboardHelper.convertToHAlign = function (cssHAlign) {
                    var dict = {
                        left: 0,
                        center: 1,
                        right: 2
                    };
                    return dict[cssHAlign];
                };
                _ClipboardHelper.convertToVAlign = function (cssVAlign) {
                    var dict = {
                        top: 0,
                        middle: 1,
                        bottom: 2
                    };
                    return dict[cssVAlign];
                };
                _ClipboardHelper.convertToLineBorder = function (cssBorderColor, cssBorderStyle, cssBorderWidth) {
                    var dict = {
                        none: 0,
                        solid: 1,
                        dashed: 3,
                        dotted: 4,
                        double: 6
                    };
                    if ((browser.msie || browser.edge) && cssBorderWidth === '2px') {
                        dict.solid = 5;
                    } else {
                        cssBorderWidth = Math.round(parseFloat(cssBorderWidth) * 10 * 3 / 4) / 10;
                        if (cssBorderWidth <= 0.8) {
                            dict.solid = 1;
                        } else if (cssBorderWidth <= 1) {
                            dict.solid = 2;
                            dict.dashed = 8;
                        } else if (cssBorderWidth <= 1.5) {
                            dict.solid = 5;
                        }
                    }
                    return new style_1.LineBorder(cssBorderColor, dict[cssBorderStyle]);
                };
                _ClipboardHelper.convertToTextDecoration = function (cssTextDecoration) {
                    var dict = {
                        'underline': 1,
                        'line-through': 2,
                        'none': 0
                    };
                    return dict[cssTextDecoration];
                };
                _ClipboardHelper.isTransparent = function (color) {
                    return Common_1.Common._ColorHelper._fromString(color).a === 0;
                };
                _ClipboardHelper.isBlack = function (color) {
                    var colorObj = Common_1.Common._ColorHelper._fromString(color);
                    return colorObj.a !== 0 && colorObj.r === 0 && colorObj.g === 0 && colorObj.b === 0;
                };
                _ClipboardHelper.getStyleFromDOM = function (element) {
                    var fontElement = element.getElementsByTagName('font')[0];
                    var cssStyle = getComputedStyle(element);
                    var inlineStyle = element.style;
                    var style = new style_1.Style();
                    var backgroundColor = cssStyle.backgroundColor;
                    if (backgroundColor && !_ClipboardHelper.isTransparent(backgroundColor)) {
                        style.backColor = backgroundColor;
                    }
                    var color = cssStyle.color;
                    if (fontElement) {
                        color = fontElement.color;
                    }
                    if (color && !_ClipboardHelper.isBlack(color)) {
                        style.foreColor = color;
                    }
                    if (fontElement) {
                        style.font = stylehelper_1._StyleHelper._buildFontString(getComputedStyle(fontElement));
                    } else {
                        var font = stylehelper_1._StyleHelper._buildFontString(cssStyle);
                        if (font) {
                            style.font = font;
                        }
                    }
                    var verticalAlign = cssStyle.verticalAlign, convertToVAlign = _ClipboardHelper.convertToVAlign, convertToHAlign = _ClipboardHelper.convertToHAlign, convertToLineBorder = _ClipboardHelper.convertToLineBorder, convertToTextDecoration = _ClipboardHelper.convertToTextDecoration;
                    if (verticalAlign) {
                        style.vAlign = convertToVAlign(verticalAlign);
                    }
                    var textAlignInline = inlineStyle.textAlign;
                    var textAlignCss = cssStyle.textAlign;
                    if (browser.msie || browser.edge) {
                        if (textAlignInline !== '') {
                            style.hAlign = convertToHAlign(textAlignInline);
                        } else {
                            style.hAlign = convertToHAlign('general');
                        }
                    } else if (textAlignCss) {
                        style.hAlign = convertToHAlign(textAlignCss);
                    }
                    var borderLeftStyle = cssStyle.borderLeftStyle;
                    if (borderLeftStyle !== 'none') {
                        style.borderLeft = convertToLineBorder(cssStyle.borderLeftColor, borderLeftStyle, cssStyle.borderLeftWidth);
                    }
                    var borderRightStyle = cssStyle.borderRightStyle;
                    if (borderRightStyle !== 'none') {
                        style.borderRight = convertToLineBorder(cssStyle.borderRightColor, borderRightStyle, cssStyle.borderRightWidth);
                    }
                    var borderTopStyle = cssStyle.borderTopStyle;
                    if (borderTopStyle !== 'none') {
                        style.borderTop = convertToLineBorder(cssStyle.borderTopColor, borderTopStyle, cssStyle.borderTopWidth);
                    }
                    var borderBottomStyle = cssStyle.borderBottomStyle;
                    if (borderBottomStyle !== 'none') {
                        style.borderBottom = convertToLineBorder(cssStyle.borderBottomColor, borderBottomStyle, cssStyle.borderBottomWidth);
                    }
                    var textDecoration = convertToTextDecoration(cssStyle.textDecorationLine || cssStyle.textDecoration);
                    if (element.getElementsByTagName('u').length > 0) {
                        textDecoration |= convertToTextDecoration('underline');
                    }
                    if (element.getElementsByTagName('s').length > 0) {
                        textDecoration |= convertToTextDecoration('line-through');
                    }
                    if (textDecoration !== 0) {
                        style.textDecoration = textDecoration;
                    }
                    return style;
                };
                return _ClipboardHelper;
            }());
            exports._ClipboardHelper = _ClipboardHelper;
        }),
        './dist/core/worksheet/style.js': (function (module, exports, __webpack_require__) {
            Object.defineProperty(exports, '__esModule', { value: true });
            var Common_1 = __webpack_require__(/*! Common */ 'Common');
            var domUtil_1 = __webpack_require__(/*! ../util/domUtil */ './dist/core/util/domUtil.js');
            var util_common = __webpack_require__(/*! ../util/common */ './dist/core/util/common.js');
            var stylehelper_1 = __webpack_require__(/*! ./stylehelper */ './dist/core/worksheet/stylehelper.js');
            var celltype_ns_1 = __webpack_require__(/*! ../celltype/celltype.ns */ './dist/core/celltype/celltype.ns.js');
            var core_enum_1 = __webpack_require__(/*! ../core.enum */ './dist/core/core.enum.js');
            var $_each = domUtil_1.GC$.each;
            var util_common_util = util_common._util;
            var isDefined = util_common_util._isDefined;
            var cloneObj = Common_1.Common._Types._cloneObject;
            var keyword_undefined = void 0, keyword_null = null, Math_sin = Math.sin, Math_cos = Math.cos, Math_abs = Math.abs, Math_max = Math.max, AUTO_FORMATTER = 'autoFormatter', FORMATTER = 'formatter', CELLTYPE = 'cellType', HALIGN = 'hAlign', VALIGN = 'vAlign', IME_MODE = 'imeMode', LABEL_OPTIONS = 'labelOptions', CELLBUTTONS = 'cellButtons', DROPDOWNS = 'dropDowns', SUPPORT_BORDER_DICT = {
                borderLeft: true,
                borderRight: true,
                borderTop: true,
                borderBottom: true,
                diagonalDown: true,
                diagonalUp: true
            };
            function _cloneDropdownSkipSource(dropdown) {
                function fetchData(source) {
                    source.fetchRows().then(function (data) {
                        source._dataRowsForMultiColumnPicker = data;
                    });
                }
                var result = {};
                if (dropdown && dropdown.option && dropdown.option.dataSource) {
                    var source = dropdown.option.dataSource;
                    dropdown.option.dataSource = keyword_undefined;
                    result = cloneObj(dropdown);
                    if (source.fetchRows && !source._dataRowsForMultiColumnPicker) {
                        fetchData(source);
                    }
                    result.option.dataSource = source;
                    dropdown.option.dataSource = source;
                } else {
                    result = cloneObj(dropdown);
                }
                return result;
            }
            var LineStyle;
            (function (LineStyle) {
                LineStyle[LineStyle['empty'] = 0] = 'empty';
                LineStyle[LineStyle['thin'] = 1] = 'thin';
                LineStyle[LineStyle['medium'] = 2] = 'medium';
                LineStyle[LineStyle['dashed'] = 3] = 'dashed';
                LineStyle[LineStyle['dotted'] = 4] = 'dotted';
                LineStyle[LineStyle['thick'] = 5] = 'thick';
                LineStyle[LineStyle['double'] = 6] = 'double';
                LineStyle[LineStyle['hair'] = 7] = 'hair';
                LineStyle[LineStyle['mediumDashed'] = 8] = 'mediumDashed';
                LineStyle[LineStyle['dashDot'] = 9] = 'dashDot';
                LineStyle[LineStyle['mediumDashDot'] = 10] = 'mediumDashDot';
                LineStyle[LineStyle['dashDotDot'] = 11] = 'dashDotDot';
                LineStyle[LineStyle['mediumDashDotDot'] = 12] = 'mediumDashDotDot';
                LineStyle[LineStyle['slantedDashDot'] = 13] = 'slantedDashDot';
            })(LineStyle = exports.LineStyle || (exports.LineStyle = {}));

            var LineBorderComposeLevel;
            (function (LineBorderComposeLevel) {
                LineBorderComposeLevel[LineBorderComposeLevel['conditionalFormat'] = 1] = 'conditionalFormat';
                LineBorderComposeLevel[LineBorderComposeLevel['cell'] = 10] = 'cell';
                LineBorderComposeLevel[LineBorderComposeLevel['table'] = 20] = 'table';
                LineBorderComposeLevel[LineBorderComposeLevel['row'] = 30] = 'row';
                LineBorderComposeLevel[LineBorderComposeLevel['column'] = 40] = 'column';
                LineBorderComposeLevel[LineBorderComposeLevel['sheet'] = 50] = 'sheet';
            })(LineBorderComposeLevel = exports.LineBorderComposeLevel || (exports.LineBorderComposeLevel = {}));

            var LineBorder = (function () {
                function LineBorder(color, style, level) {
                    this.color = color || 'black';
                    this.style = style || 0;
                    this.level = level;
                }
                LineBorder.prototype._clone = function () {
                    return new LineBorder(this.color, this.style, this.level);
                };
                LineBorder.prototype.toJSON = function () {
                    var jsData = {};
                    var self = this, color = self.color, style = self.style;
                    if (color !== 'black') {
                        jsData.color = color;
                    }
                    if (style !== 0) {
                        jsData.style = style;
                    }
                    return jsData;
                };
                LineBorder.prototype.fromJSON = function (jsData, noSchema) {
                    if (jsData) {
                        var self_1 = this, color = jsData.color, style = jsData.style;
                        if (isDefined(color)) {
                            self_1.color = color;
                        }
                        if (isDefined(style)) {
                            self_1.style = style;
                        }
                    }
                };
                LineBorder._width = function (border) {
                    var style = border && border.style;
                    var dict = {
                        9: 1,
                        1: 1,
                        3: 1,
                        4: 1,
                        7: 1,
                        11: 1,
                        2: 2,
                        10: 2,
                        12: 2,
                        8: 2,
                        13: 2,
                        5: 3,
                        6: 3
                    };
                    return dict[style] || 0;
                };
                return LineBorder;
            }());
            exports.LineBorder = LineBorder;

            function isStyleOptions(value) {
                if (value && typeof value === 'object') {
                    return !value.patternColor && !value.stops;
                }
                return false;
            }
            function createBackColor(value) {
                if (value && value.type) {
                    return {
                        type: value.type && core_enum_1.PatternType[value.type] || keyword_undefined,
                        patternColor: value.patternColor,
                        backgroundColor: value.backgroundColor
                    };
                }
                return value;
            }
            function createLineBorder(value) {
                if (value) {
                    return new LineBorder(value.color, value.style && LineStyle[value.style] || keyword_undefined);
                }
                return keyword_undefined;
            }
            function createCellType(value) {
                if (value) {
                    var typeNameMap = {
                        checkbox: '5',
                        combobox: '7',
                        hyperlink: '8',
                        radioButtonList: '11',
                        checkboxList: '12'
                    };
                    var typeName = typeNameMap[value.type];
                    if (typeName) {
                        var cellTypeClass = celltype_ns_1._typeDict[typeName];
                        if (cellTypeClass) {
                            var cellType = new cellTypeClass();
                            cellType._fromOptions(value);
                            return cellType;
                        }
                    }
                }
                return keyword_undefined;
            }
            function createLabelOptions(value) {
                if (value) {
                    return {
                        alignment: value.alignment && core_enum_1.LabelAlignment[value.alignment] || keyword_undefined,
                        visibility: value.visibility && core_enum_1.LabelVisibility[value.visibility] || keyword_undefined,
                        font: value.font,
                        foreColor: value.foreColor,
                        margin: value.margin
                    };
                }
                return keyword_undefined;
            }
            function createCellButtons(cellButtons) {
                if (cellButtons) {
                    return cellButtons.map(function (value) {
                        return {
                            position: value.position && core_enum_1.ButtonPosition[value.position] || keyword_undefined,
                            useButtonStyle: value.useButtonStyle,
                            enabled: value.enabled,
                            width: value.width,
                            caption: value.caption,
                            imageSrc: value.imageSrc,
                            imageSize: value.imageSize,
                            captionAlign: value.captionAlign && core_enum_1.CaptionAlignment[value.captionAlign] || keyword_undefined,
                            command: value.command,
                            imageType: value.imageType && core_enum_1.ButtonImageType[value.imageType] || keyword_undefined,
                            visibility: value.visibility && core_enum_1.ButtonVisibility[value.visibility] || keyword_undefined,
                            hoverBackColor: value.hoverBackColor,
                            buttonBackColor: value.buttonBackColor
                        };
                    });
                }
                return keyword_undefined;
            }
            function convertDropDownOption(option) {
                var newOption = domUtil_1.GC$.extend(true, {}, option);
                var calendarPage = option.calendarPage;
                if (calendarPage) {
                    newOption.calendarPage = core_enum_1.CalendarPage[calendarPage];
                }
                var startDay = option.startDay;
                if (startDay) {
                    newOption.startDay = core_enum_1.CalendarStartDay[startDay];
                }
                var layout = option.layout;
                if (layout) {
                    var direction2 = layout.direction;
                    if (direction2) {
                        newOption.layout.direction = core_enum_1.LayoutDirection[direction2];
                    }
                    var displayAs = layout.displayAs;
                    if (displayAs) {
                        newOption.layout.displayAs = core_enum_1.LayoutDisplayAs[displayAs];
                    }
                }
                var valueType = option.valueType;
                if (valueType) {
                    newOption.valueType = core_enum_1.DropdownListValue[valueType];
                }
                var direction = option.direction;
                if (direction) {
                    newOption.direction = core_enum_1.LayoutDirection[direction];
                }
                return newOption;
            }
            function createDropDowns(dropDowns) {
                if (dropDowns) {
                    return dropDowns.map(function (value) {
                        return {
                            type: value.type && core_enum_1.DropDownType[value.type] || keyword_undefined,
                            option: convertDropDownOption(value.option),
                            submitCommand: value.submitCommand
                        };
                    });
                }
                return keyword_undefined;
            }
            var stylePropertyDict = [
                'backColor', 'foreColor', HALIGN, VALIGN, 'font',
                'themeFont', FORMATTER, 'borderLeft',
                'borderTop', 'borderRight', 'borderBottom',
                'locked', 'textIndent', 'wordWrap', 'showEllipsis', '_showTip',
                'shrinkToFit', 'backgroundImage',
                CELLTYPE, 'backgroundImageLayout', 'tabStop',
                'textDecoration', IME_MODE, 'name', 'parentName', 'watermark',
                'cellPadding', LABEL_OPTIONS, 'quotePrefix',
                'diagonalDown', 'diagonalUp', 'isVerticalText',
                CELLBUTTONS, DROPDOWNS, 'textOrientation'
            ];
            var Style = (function () {
                function Style() {
                    var args = [];
                    for (var _i = 0; _i < arguments.length; _i++) {
                        args[_i] = arguments[_i];
                    }
                    var self = this;
                    self._id = Style._styleId;
                    Style._styleId++;
                    if (args.length === 0) {
                        return;
                    }
                    var firstArg = args[0];
                    if (args.length === 1 && isStyleOptions(firstArg)) {
                        self._fromOptions(firstArg);
                    } else {
                        for (var i = 0; i < stylePropertyDict.length; i++) {
                            self[stylePropertyDict[i]] = args[i];
                        }
                    }
                }
                Style._ensureParentName = function (jsonStyle, context) {
                    var parentName = jsonStyle.parentName;
                    if (parentName && !context.getNamedStyle(parentName)) {
                        delete jsonStyle.parentName;
                    }
                };
                Style.prototype._compose = function (style, force, composeLevel, ignoreQuotePrefix) {
                    var self = this, borderLeft, borderTop, borderRight, borderBottom, diagonalDown, diagonalUp, labelOptions = style.labelOptions;
                    var cellButtons = style.cellButtons;
                    if (style.cellButtons && style.cellButtons.length > 0) {
                        cellButtons = [];
                        for (var i = 0; i < style.cellButtons.length; i++) {
                            cellButtons.push(cloneObj(style.cellButtons[i]));
                        }
                    }
                    var dropDowns = style.dropDowns;
                    if (style.dropDowns && style.dropDowns.length > 0) {
                        dropDowns = [];
                        for (var i = 0; i < style.dropDowns.length; i++) {
                            dropDowns.push(_cloneDropdownSkipSource(style.dropDowns[i]));
                        }
                    }
                    if (force) {
                        self._autoFormatter = style._autoFormatter;
                        self.backgroundImage = style.backgroundImage;
                        self.backgroundImageLayout = style.backgroundImageLayout;
                        self.backColor = style.backColor;
                        self.foreColor = style.foreColor;
                        self.hAlign = style.hAlign;
                        self.vAlign = style.vAlign;
                        self.font = style.font;
                        self.themeFont = style.themeFont;
                        self.formatter = style.formatter;
                        self.showEllipsis = style.showEllipsis;
                        self._showTip = style._showTip;
                        borderLeft = style.borderLeft;
                        self.borderLeft = ((borderLeft && borderLeft._clone()) || borderLeft);
                        if (self.borderLeft && composeLevel) {
                            self.borderLeft.level = composeLevel;
                        }
                        borderTop = style.borderTop;
                        self.borderTop = ((borderTop && borderTop._clone()) || borderTop);
                        if (self.borderTop && composeLevel) {
                            self.borderTop.level = composeLevel;
                        }
                        borderRight = style.borderRight;
                        self.borderRight = ((borderRight && borderRight._clone()) || borderRight);
                        if (self.borderRight && composeLevel) {
                            self.borderRight.level = composeLevel;
                        }
                        borderBottom = style.borderBottom;
                        self.borderBottom = ((borderBottom && borderBottom._clone()) || borderBottom);
                        if (self.borderBottom && composeLevel) {
                            self.borderBottom.level = composeLevel;
                        }
                        diagonalDown = style.diagonalDown;
                        self.diagonalDown = ((diagonalDown && diagonalDown._clone()) || diagonalDown);
                        if (self.diagonalDown && composeLevel) {
                            self.diagonalDown.level = composeLevel;
                        }
                        diagonalUp = style.diagonalUp;
                        self.diagonalUp = ((diagonalUp && diagonalUp._clone()) || diagonalUp);
                        if (self.diagonalUp && composeLevel) {
                            self.diagonalUp.level = composeLevel;
                        }
                        self.locked = style.locked;
                        self.textIndent = style.textIndent;
                        self.wordWrap = style.wordWrap;
                        self.shrinkToFit = style.shrinkToFit;
                        self.cellType = style.cellType;
                        self.name = style.name;
                        self.parentName = style.parentName;
                        self.tabStop = style.tabStop;
                        self.textDecoration = style.textDecoration;
                        self.imeMode = style.imeMode;
                        self.watermark = style.watermark;
                        self.cellPadding = style.cellPadding;
                        self.isVerticalText = style.isVerticalText;
                        self.textOrientation = style.textOrientation;
                        if (labelOptions) {
                            self.labelOptions = {
                                alignment: labelOptions.alignment,
                                font: labelOptions.font,
                                foreColor: labelOptions.foreColor,
                                visibility: labelOptions.visibility,
                                margin: labelOptions.margin
                            };
                        }
                        self.quotePrefix = style.quotePrefix;
                        self.cellButtons = cellButtons;
                        self.dropDowns = dropDowns;
                    } else {
                        if (self.backgroundImage === keyword_undefined) {
                            self.backgroundImage = style.backgroundImage;
                        }
                        if (self.backgroundImageLayout === keyword_undefined) {
                            self.backgroundImageLayout = style.backgroundImageLayout;
                        }
                        if (self.backColor === keyword_undefined) {
                            self.backColor = style.backColor;
                        }
                        if (self.foreColor === keyword_undefined) {
                            self.foreColor = style.foreColor;
                        }
                        if (self.hAlign === keyword_undefined) {
                            self.hAlign = style.hAlign;
                        }
                        if (self.vAlign === keyword_undefined) {
                            self.vAlign = style.vAlign;
                        }
                        if (self.themeFont === keyword_undefined && self.font === keyword_undefined) {
                            self.themeFont = style.themeFont;
                            self.font = style.font;
                        } else if (self.themeFont !== keyword_undefined && self.font === keyword_undefined) {
                            self.font = style.font;
                        }
                        if (self.formatter === keyword_undefined) {
                            self.formatter = style.formatter;
                        }
                        if (self.showEllipsis === keyword_undefined) {
                            self.showEllipsis = style.showEllipsis;
                        }
                        if (self._showTip === keyword_undefined) {
                            self._showTip = style._showTip;
                        }
                        if (self._autoFormatter === keyword_undefined) {
                            self._autoFormatter = style._autoFormatter;
                        }
                        if (self.borderLeft === keyword_undefined) {
                            borderLeft = style.borderLeft;
                            self.borderLeft = ((borderLeft && borderLeft._clone()) || borderLeft);
                            if (self.borderLeft && composeLevel) {
                                self.borderLeft.level = composeLevel;
                            }
                        }
                        if (self.borderTop === keyword_undefined) {
                            borderTop = style.borderTop;
                            self.borderTop = ((borderTop && borderTop._clone()) || borderTop);
                            if (self.borderTop && composeLevel) {
                                self.borderTop.level = composeLevel;
                            }
                        }
                        if (self.borderRight === keyword_undefined) {
                            borderRight = style.borderRight;
                            self.borderRight = ((borderRight && borderRight._clone()) || borderRight);
                            if (self.borderRight && composeLevel) {
                                self.borderRight.level = composeLevel;
                            }
                        }
                        if (self.borderBottom === keyword_undefined) {
                            borderBottom = style.borderBottom;
                            self.borderBottom = ((borderBottom && borderBottom._clone()) || borderBottom);
                            if (self.borderBottom && composeLevel) {
                                self.borderBottom.level = composeLevel;
                            }
                        }
                        if (self.diagonalDown === keyword_undefined) {
                            diagonalDown = style.diagonalDown;
                            self.diagonalDown = ((diagonalDown && diagonalDown._clone()) || diagonalDown);
                            if (self.diagonalDown && composeLevel) {
                                self.diagonalDown.level = composeLevel;
                            }
                        }
                        if (self.diagonalUp === keyword_undefined) {
                            diagonalUp = style.diagonalUp;
                            self.diagonalUp = ((diagonalUp && diagonalUp._clone()) || diagonalUp);
                            if (self.diagonalUp && composeLevel) {
                                self.diagonalUp.level = composeLevel;
                            }
                        }
                        if (self.locked === keyword_undefined) {
                            self.locked = style.locked;
                        }
                        if (self.textIndent === keyword_undefined) {
                            self.textIndent = style.textIndent;
                        }
                        if (self.wordWrap === keyword_undefined) {
                            self.wordWrap = style.wordWrap;
                        }
                        if (self.shrinkToFit === keyword_undefined) {
                            self.shrinkToFit = style.shrinkToFit;
                        }
                        if (self.cellType === keyword_undefined) {
                            self.cellType = style.cellType;
                        }
                        if (self.tabStop === keyword_undefined) {
                            self.tabStop = style.tabStop;
                        }
                        if (self.textDecoration === keyword_undefined) {
                            self.textDecoration = style.textDecoration;
                        }
                        if (self.imeMode === keyword_undefined) {
                            self.imeMode = style.imeMode;
                        }
                        if (self.name === keyword_undefined) {
                            self.name = style.name;
                        }
                        if (self.parentName === keyword_undefined) {
                            self.parentName = style.parentName;
                        }
                        if (self.watermark === keyword_undefined) {
                            self.watermark = style.watermark;
                        }
                        if (self.cellPadding === keyword_undefined) {
                            self.cellPadding = style.cellPadding;
                        }
                        if (!self.labelOptions && labelOptions) {
                            self.labelOptions = {};
                        }
                        var selfLabelOptions = self.labelOptions;
                        if (selfLabelOptions && labelOptions) {
                            if (selfLabelOptions.alignment === keyword_undefined) {
                                selfLabelOptions.alignment = labelOptions.alignment;
                            }
                            if (selfLabelOptions.font === keyword_undefined) {
                                selfLabelOptions.font = labelOptions.font;
                            }
                            if (selfLabelOptions.foreColor === keyword_undefined) {
                                selfLabelOptions.foreColor = labelOptions.foreColor;
                            }
                            if (selfLabelOptions.visibility === keyword_undefined) {
                                selfLabelOptions.visibility = labelOptions.visibility;
                            }
                            if (selfLabelOptions.margin === keyword_undefined) {
                                selfLabelOptions.margin = labelOptions.margin;
                            }
                        }
                        if (!ignoreQuotePrefix && self.quotePrefix === keyword_undefined) {
                            self.quotePrefix = style.quotePrefix;
                        }
                        if (self.isVerticalText === keyword_undefined) {
                            self.isVerticalText = style.isVerticalText;
                        }
                        if (self.textOrientation === keyword_undefined) {
                            self.textOrientation = style.textOrientation;
                        }
                        if (self.cellButtons === keyword_undefined) {
                            self.cellButtons = cellButtons;
                        }
                        if (self.dropDowns === keyword_undefined) {
                            self.dropDowns = dropDowns;
                        }
                    }
                };
                Style.prototype._clear = function (propertyName) {
                    var self = this;
                    if (arguments.length === 0) {
                        $_each(stylePropertyDict, function (i, p) {
                            self[p] = keyword_undefined;
                        });
                    } else {
                        self[propertyName] = keyword_undefined;
                    }
                };
                Style.prototype.clone = function (noDeepClone) {
                    var self = this;
                    var borderLeft = self.borderLeft;
                    var borderTop = self.borderTop;
                    var borderRight = self.borderRight;
                    var borderBottom = self.borderBottom;
                    var diagonalDown = self.diagonalDown;
                    var diagonalUp = self.diagonalUp;
                    var style = new Style();
                    style.backColor = self.backColor;
                    style.foreColor = self.foreColor;
                    style.hAlign = self.hAlign;
                    style.vAlign = self.vAlign;
                    style.font = self.font;
                    style.themeFont = self.themeFont;
                    style.formatter = keyword_undefined;
                    style.borderLeft = ((borderLeft && !noDeepClone && borderLeft._clone()) || borderLeft);
                    style.borderTop = ((borderTop && !noDeepClone && borderTop._clone()) || borderTop);
                    style.borderRight = ((borderRight && !noDeepClone && borderRight._clone()) || borderRight);
                    style.borderBottom = ((borderBottom && !noDeepClone && borderBottom._clone()) || borderBottom);
                    style.locked = self.locked;
                    style.textIndent = self.textIndent;
                    style.wordWrap = self.wordWrap;
                    style.shrinkToFit = self.shrinkToFit;
                    style.backgroundImage = self.backgroundImage;
                    style.cellType = keyword_undefined;
                    style.backgroundImageLayout = self.backgroundImageLayout;
                    style.tabStop = self.tabStop;
                    style.textDecoration = self.textDecoration;
                    style.imeMode = self.imeMode;
                    style.name = self.name;
                    style.parentName = self.parentName;
                    style.watermark = self.watermark;
                    style.cellPadding = self.cellPadding;
                    style.labelOptions = self.labelOptions;
                    style.quotePrefix = self.quotePrefix;
                    style.diagonalDown = ((diagonalDown && !noDeepClone && diagonalDown._clone()) || diagonalDown);
                    style.diagonalUp = ((diagonalUp && !noDeepClone && diagonalUp._clone()) || diagonalUp);
                    style.isVerticalText = self.isVerticalText;
                    style.showEllipsis = self.showEllipsis;
                    style._showTip = self._showTip;
                    style.textOrientation = self.textOrientation;
                    _cloneFormatter(style, self.formatter, !noDeepClone);
                    _cloneAutoFormatter(style, self._autoFormatter, !noDeepClone);
                    _cloneCellType(style, self.cellType, !noDeepClone, true);
                    _cloneCellButtons(style, self.cellButtons, !noDeepClone, true);
                    _cloneDropdown(style, self.dropDowns, !noDeepClone, true);
                    return style;
                };
                Style.prototype._normalize = function (theme) {
                    var self = this;
                    if (theme && theme.getColor) {
                        normalizeColor(theme, self.foreColor, function (color) {
                            self.foreColor = color;
                        });
                        var backColor_1 = self.backColor;
                        if (typeof backColor_1 === 'string') {
                            normalizeColor(theme, backColor_1, function (color) {
                                self.backColor = color;
                            });
                        } else if (backColor_1) {
                            if (backColor_1.backgroundColor) {
                                normalizeColor(theme, backColor_1.backgroundColor, function (color) {
                                    backColor_1.backgroundColor = color;
                                });
                            }
                            if (backColor_1.patternColor) {
                                normalizeColor(theme, backColor_1.patternColor, function (color) {
                                    backColor_1.patternColor = color;
                                });
                            }
                            if (backColor_1.stops) {
                                var _loop_1 = function (i) {
                                    normalizeColor(theme, backColor_1.stops[i].color, function (color) {
                                        backColor_1.stops[i].color = color;
                                    });
                                };
                                for (var i = 0; i < backColor_1.stops.length; i++) {
                                    _loop_1(i);
                                }
                            }
                        }
                        var borderLines = [self.borderLeft, self.borderTop, self.borderRight, self.borderBottom, self.diagonalDown, self.diagonalUp];
                        var _loop_2 = function (i, count) {
                            var borderLine = borderLines[i];
                            if (borderLine && borderLine.color) {
                                normalizeColor(theme, borderLine.color, function (color) {
                                    borderLine.color = color;
                                });
                            }
                        };
                        for (var i = 0, count = borderLines.length; i < count; i++) {
                            _loop_2(i, count);
                        }
                    }
                    var themeFont = self.themeFont, font = self.font;
                    if (theme && theme.getFont) {
                        if (themeFont) {
                            self.font = stylehelper_1._StyleHelper._composeFont(font, theme.getFont(themeFont));
                        } else if (!font) {
                            self.font = stylehelper_1._StyleHelper._composeFont(font, theme.bodyFont());
                        }
                    }
                    return self;
                };
                Style.prototype._setActualAutoFormatter = function (value) {
                    var self = this;
                    var formatter = self._autoFormatter;
                    if (!formatter || value === keyword_null) {
                        return;
                    }
                    var newFormatObj = formatter.getPreferredEditingFormatter(value);
                    newFormatObj.isAuto = true;
                    self._autoFormatter = newFormatObj;
                };
                Style.prototype.toJSON = function (sheetArea, checkDefaultValue) {
                    var self = this;
                    var jsonData = {};
                    var value = self._autoFormatter, i, item;
                    if (isDefined(value) && (!checkDefaultValue || !_isDefaultValue(AUTO_FORMATTER, value, sheetArea))) {
                        if (value.toJSON) {
                            value = value.toJSON();
                        }
                        if (!domUtil_1.GC$.isEmptyObject(value)) {
                            jsonData[AUTO_FORMATTER] = value;
                        }
                    }
                    for (i = 0; i < stylePropertyDict.length; i++) {
                        item = stylePropertyDict[i];
                        value = self[item];
                        if (item === LABEL_OPTIONS && !domUtil_1.GC$.isEmptyObject(value)) {
                            jsonData[LABEL_OPTIONS] = value;
                        } else if ((item === DROPDOWNS || item === CELLBUTTONS) && !domUtil_1.GC$.isEmptyObject(value)) {
                            jsonData[item] = value;
                        } else if (isDefined(value) && (!checkDefaultValue || !_isDefaultValue(item, value, sheetArea))) {
                            jsonData[item] = value && value.toJSON ? value.toJSON() : value;
                        }
                    }
                    return domUtil_1.GC$.isEmptyObject(jsonData) ? keyword_undefined : jsonData;
                };
                Style.prototype.fromJSON = function (jsonData, noSchema, context) {
                    if (!jsonData) {
                        return;
                    }
                    var self = this, p, value;
                    for (p in jsonData) {
                        if (jsonData.hasOwnProperty(p)) {
                            value = jsonData[p];
                            if (!isDefined(value)) {
                                continue;
                            }
                            var arg = {
                                p: p,
                                v: value,
                                r: false
                            };
                            arg.noSchema = noSchema;
                            arg.context = context;
                            Style._callFeatureHandler(self, 'fromJson', arg);
                            if (!arg.r) {
                                if (p === 'formatter') {
                                    _cloneFormatter(self, value, true);
                                } else if (p === 'autoFormatter') {
                                    _cloneAutoFormatter(self, value, true);
                                } else if (p === CELLTYPE) {
                                    _cloneCellType(self, value, true, noSchema);
                                } else if (SUPPORT_BORDER_DICT[p]) {
                                    if (value === keyword_null) {
                                        self[p] = null;
                                    } else {
                                        var border = new LineBorder();
                                        border.fromJSON(value, noSchema);
                                        self[p] = border;
                                    }
                                } else {
                                    self[p] = value;
                                }
                            }
                        }
                    }
                };
                Style.prototype._fromOptions = function (options) {
                    var _this = this;
                    _this.backColor = createBackColor(options.backColor);
                    _this.foreColor = options.foreColor;
                    _this.hAlign = options.hAlign && core_enum_1.HorizontalAlign[options.hAlign] || keyword_undefined;
                    _this.vAlign = options.vAlign && core_enum_1.VerticalAlign[options.vAlign] || keyword_undefined;
                    _this.font = options.font;
                    _this.themeFont = options.themeFont;
                    _this.formatter = options.formatter;
                    _this.borderLeft = createLineBorder(options.borderLeft);
                    _this.borderTop = createLineBorder(options.borderTop);
                    _this.borderRight = createLineBorder(options.borderRight);
                    _this.borderBottom = createLineBorder(options.borderBottom);
                    _this.diagonalDown = createLineBorder(options.diagonalDown);
                    _this.diagonalUp = createLineBorder(options.diagonalUp);
                    _this.locked = options.locked;
                    _this.textIndent = options.textIndent;
                    _this.wordWrap = options.wordWrap;
                    _this.shrinkToFit = options.shrinkToFit;
                    _this.backgroundImage = options.backgroundImage;
                    _this.cellType = createCellType(options.cellType);
                    _this.backgroundImageLayout = options.backgroundImageLayout && core_enum_1.ImageLayout[options.backgroundImageLayout] || keyword_undefined;
                    _this.tabStop = options.tabStop;
                    _this.textDecoration = options.textDecoration && core_enum_1.TextDecorationType[options.textDecoration] || keyword_undefined;
                    _this.imeMode = options.imeMode && core_enum_1.ImeMode[options.imeMode] || keyword_undefined;
                    _this.name = options.name;
                    _this.parentName = options.parentName;
                    _this.watermark = options.watermark;
                    _this.cellPadding = options.cellPadding;
                    _this.labelOptions = createLabelOptions(options.labelOptions);
                    _this.isVerticalText = options.isVerticalText;
                    _this.textOrientation = options.textOrientation;
                    _this.showEllipsis = options.showEllipsis;
                    _this.cellButtons = createCellButtons(options.cellButtons);
                    _this.dropDowns = createDropDowns(options.dropDowns);
                };
                return Style;
            }());
            exports.Style = Style;
            function _cloneCellType(style, cellType, deepClone, noSchema) {
                var resultCellType = cellType;
                if (deepClone && cellType) {
                    var cellTypeInstance = cellType._cloneCellType && cellType._cloneCellType();
                    if (cellTypeInstance) {
                        style.cellType = resultCellType;
                        return;
                    }
                    if (cellType.toJSON) {
                        cellType = cellType.toJSON();
                    }
                    var dict = celltype_ns_1._typeDict;
                    var typeName = cellType.typeName;
                    var celltypeClass = dict[cellType.type] || dict[typeName] || util_common.getTypeFromString(typeName);
                    if (celltypeClass) {
                        resultCellType = new celltypeClass();
                        resultCellType.fromJSON(cellType, noSchema);
                    } else {
                        resultCellType = keyword_undefined;
                    }
                }
                style.cellType = resultCellType;
            }
            function _cloneCellButtons(style, cellButtons, deepClone, noSchema) {
                if (cellButtons === keyword_null) {
                    style.cellButtons = cellButtons;
                }
                if (cellButtons) {
                    var resultCellButtons = cellButtons;
                    if (deepClone) {
                        resultCellButtons = [];
                        for (var i = 0; i < cellButtons.length; i++) {
                            resultCellButtons.push(cloneObj(cellButtons[i]));
                        }
                    }
                    style.cellButtons = resultCellButtons;
                }
            }
            function _cloneDropdown(style, dropDowns, deepClone, noSchema) {
                if (dropDowns === keyword_null) {
                    style.dropDowns = dropDowns;
                }
                if (dropDowns) {
                    var resultDropdowns = dropDowns.slice();
                    if (deepClone) {
                        resultDropdowns = [];
                        for (var i = 0; i < dropDowns.length; i++) {
                            resultDropdowns.push(cloneObj(dropDowns[i]));
                        }
                    }
                    style.dropDowns = resultDropdowns;
                }
            }
            function _cloneFormatter(style, formatter, deepClone) {
                var resultFormatter = formatter;
                if (deepClone && formatter && typeof formatter === 'object') {
                    if (formatter.toJSON) {
                        formatter = formatter.toJSON();
                    }
                    var Formatter_module = Common_1.Formatter;
                    var GeneralFormatter = Formatter_module && Formatter_module.GeneralFormatter;
                    if (GeneralFormatter) {
                        var typeName = formatter.typeName;
                        if (!typeName) {
                            resultFormatter = new GeneralFormatter(formatter.formatCached, formatter.customerCultureName);
                        } else {
                            var customFormatterClass = util_common.getTypeFromString(typeName);
                            if (customFormatterClass) {
                                resultFormatter = new customFormatterClass();
                                resultFormatter.fromJSON(formatter);
                            }
                        }
                    }
                }
                style.formatter = resultFormatter;
            }
            function _cloneAutoFormatter(style, autoFormatter, deepClone) {
                var resultAutoFormatter = autoFormatter;
                if (deepClone && autoFormatter) {
                    if (autoFormatter.toJSON) {
                        autoFormatter = autoFormatter.toJSON();
                    }
                    var Formatter_module = Common_1.Formatter;
                    var GeneralFormatter = Formatter_module && Formatter_module.GeneralFormatter;
                    if (GeneralFormatter) {
                        resultAutoFormatter = new GeneralFormatter(autoFormatter.formatCached, autoFormatter.customerCultureName);
                        resultAutoFormatter.isAuto = true;
                    }
                }
                style._autoFormatter = resultAutoFormatter;
            }
            function normalizeColor(theme, color, callback) {
                if (color) {
                    color = theme.getColor(color);
                    if (color) {
                        callback(color);
                    }
                }
            }
            function _isDefaultValue(propertyName, value, sheetArea) {
                if (propertyName === HALIGN) {
                    if (sheetArea === 2) {
                        return value === 1;
                    }
                    if (sheetArea === 1) {
                        return value === 1;
                    }
                    return value === 3;
                }
                if (propertyName === VALIGN) {
                    if (sheetArea === 2) {
                        return value === 1;
                    }
                    if (sheetArea === 1) {
                        return value === 1;
                    }
                    return value === 0;
                }
                if (propertyName === IME_MODE) {
                    return value === 1;
                }
                if (propertyName === AUTO_FORMATTER) {
                    return value === keyword_undefined;
                }
            }
            util_common._defineFeature(Style);
            Style._styleId = 0;
        }),
        './dist/core/worksheet/stylehelper.js': (function (module, exports, __webpack_require__) {
            Object.defineProperty(exports, '__esModule', { value: true });
            var domUtil_1 = __webpack_require__(/*! ../util/domUtil */ './dist/core/util/domUtil.js');
            var common_1 = __webpack_require__(/*! ../util/common */ './dist/core/util/common.js');
            var DOCUMENT = document, Math_max = Math.max, Math_min = Math.min, keyword_undefined = void 0, COLOR_WHITE = '#FFFFFF', COLOR_BLACK = '#000000', Math_abs = Math.abs, Math_PI = Math.PI, Math_cos = Math.cos, Math_sin = Math.sin, Math_atan = Math.atan, Math_tan = Math.tan;
            exports._DefaultFontSize = '11pt';
            var _PatternMap = {
                1: [
                    [1]
                ],
                2: [
                    [1, 0, 1, 1],
                    [1, 1, 1, 0]
                ],
                3: [
                    [0, 1],
                    [1, 0]
                ],
                4: [
                    [0, 0, 1, 0],
                    [1, 0, 0, 0]
                ],
                5: [
                    [0, 0, 0, 0],
                    [0, 0, 1, 0],
                    [0, 0, 0, 0],
                    [1, 0, 0, 0]
                ],
                6: [
                    [0, 0, 0, 0, 0, 0, 0, 0],
                    [1, 0, 0, 0, 0, 0, 0, 0],
                    [0, 0, 0, 0, 0, 0, 0, 0],
                    [0, 0, 0, 0, 1, 0, 0, 0]
                ],
                7: [
                    [0],
                    [1],
                    [1],
                    [0]
                ],
                8: [
                    [1, 1, 0, 0]
                ],
                9: [
                    [0, 1, 1, 0],
                    [0, 0, 1, 1],
                    [1, 0, 0, 1],
                    [1, 1, 0, 0]
                ],
                10: [
                    [0, 1, 1, 0],
                    [1, 1, 0, 0],
                    [1, 0, 0, 1],
                    [0, 0, 1, 1]
                ],
                11: [
                    [0, 0, 1, 1],
                    [0, 0, 1, 1],
                    [1, 1, 0, 0],
                    [1, 1, 0, 0]
                ],
                12: [
                    [0, 1, 1, 0],
                    [1, 1, 1, 1],
                    [1, 0, 0, 1],
                    [1, 1, 1, 1]
                ],
                13: [
                    [0],
                    [1],
                    [0],
                    [0]
                ],
                14: [
                    [1, 0, 0, 0]
                ],
                15: [
                    [0, 1, 0, 0],
                    [0, 0, 1, 0],
                    [0, 0, 0, 1],
                    [1, 0, 0, 0]
                ],
                16: [
                    [0, 0, 0, 0, 0, 1, 0, 0],
                    [0, 0, 0, 0, 1, 0, 0, 0],
                    [0, 0, 0, 1, 0, 0, 0, 0],
                    [0, 0, 1, 0, 0, 0, 0, 0],
                    [0, 1, 0, 0, 0, 0, 0, 0],
                    [1, 0, 0, 0, 0, 0, 0, 0],
                    [0, 0, 0, 0, 0, 0, 0, 1],
                    [0, 0, 0, 0, 0, 0, 1, 0]
                ],
                17: [
                    [0, 0, 1, 0],
                    [1, 1, 1, 1],
                    [0, 0, 1, 0],
                    [0, 0, 1, 0]
                ],
                18: [
                    [1, 0, 1, 0],
                    [0, 0, 0, 1],
                    [1, 0, 1, 0],
                    [0, 1, 0, 0]
                ]
            };
            function _setValueRegion(value) {
                value = value || 0;
                value = Math_max(value, 0);
                value = Math_min(value, 1);
                return value;
            }
            var _StyleHelper = (function () {
                function _StyleHelper() { }
                _StyleHelper._composeFont = function (font, fontFamily) {
                    return !fontFamily ? font : _StyleHelper._normalizeFont(font, fontFamily);
                };
                _StyleHelper._splitFont = function (font) {
                    if (!font) {
                        return {};
                    }
                    var span = _StyleHelper._getMeasureSpan();
                    span.style.font = font;
                    var cssStyle = span.style;
                    return {
                        fontFamily: cssStyle.fontFamily,
                        fontSize: cssStyle.fontSize,
                        fontStyle: cssStyle.fontStyle,
                        fontWeight: cssStyle.fontWeight
                    };
                };
                _StyleHelper._buildFontString = function (cssStyle) {
                    if (common_1._util._browser.safari) {
                        return cssStyle.font;
                    }
                    var f = '';
                    var normal = 'normal';
                    var defaultFontWeight = '400';
                    var defaultFontSize = '11pt';
                    var defaultFontFamily = 'Calibri';
                    var fontStyle = cssStyle.fontStyle, fontVariant = cssStyle.fontVariant, fontWeight = cssStyle.fontWeight, lineHeight = cssStyle.lineHeight, fontSize = cssStyle.fontSize, fontFamily = cssStyle.fontFamily;
                    if (fontStyle && fontStyle !== normal) {
                        f = fontStyle;
                    }
                    //这个逻辑会影响粘贴后style.font上面多了fontVariant属性 导致设计器的fontSize无法识别
                    // if (fontVariant && fontVariant !== normal) {
                    //     f += (f ? ' ' : '') + fontVariant;
                    // }
                    if (fontWeight && fontWeight !== normal && fontWeight !== defaultFontWeight) {
                        f += (f ? ' ' : '') + fontWeight;
                    }
                    fontSize = fontSize ? fontSize : defaultFontSize;
                    f += (f ? ' ' : '') + fontSize;
                    if (lineHeight && lineHeight !== normal) {
                        f += '/' + lineHeight;
                    }
                    fontFamily = fontFamily ? fontFamily : defaultFontFamily;
                    f += ' ' + fontFamily;
                    return f;
                };
                _StyleHelper._normalizeFont = function (font, fontFamily) {
                    if (!font && !fontFamily) {
                        return font;
                    }
                    var span;
                    var key;
                    var stringCache;
                    if (font) {
                        key = fontFamily ? font + '+' + fontFamily : font;
                        stringCache = _StyleHelper._fontStringCache[key];
                        if (stringCache) {
                            return stringCache;
                        }
                        span = _StyleHelper._getMeasureSpan();
                        domUtil_1.GC$(span).css('font', font);
                    } else {
                        key = fontFamily;
                        stringCache = _StyleHelper._fontStringCache[key];
                        if (stringCache) {
                            return stringCache;
                        }
                        span = _StyleHelper._getMeasureSpan();
                        domUtil_1.GC$(span).css('fontSize', exports._DefaultFontSize);
                    }
                    if (fontFamily) {
                        domUtil_1.GC$(span).css('fontFamily', fontFamily);
                    }
                    var fs = span.currentStyle;
                    var defaultView = DOCUMENT.defaultView;
                    if (defaultView && defaultView.getComputedStyle) {
                        fs = defaultView.getComputedStyle(span, '');
                    }
                    stringCache = _StyleHelper._buildFontString(fs);
                    _StyleHelper._fontStringCache[key] = stringCache;
                    _StyleHelper._fontStringCache[stringCache] = stringCache;
                    return stringCache;
                };
                _StyleHelper._scaleFont = function (font, factor, minFont, ignoreCache) {
                    var cache = _StyleHelper._scaleFontInfoCache[factor], fontInfo;
                    if (!ignoreCache) {
                        if (cache) {
                            fontInfo = cache[font];
                            if (fontInfo) {
                                return fontInfo;
                            }
                        } else {
                            cache = _StyleHelper._scaleFontInfoCache[factor] = {};
                        }
                    }
                    var span = _StyleHelper._getMeasureSpan();
                    span.style.font = font;
                    var style = span.currentStyle, docView = DOCUMENT.defaultView;
                    if (docView && docView.getComputedStyle) {
                        style = docView.getComputedStyle(span, '');
                    }
                    var fontSize = style.fontSize;
                    var unit = 'px';
                    var size;
                    if (fontSize.indexOf(unit) !== -1) {
                        size = Math_max(1, parseFloat(fontSize.replace(unit, '')) * factor);
                        if (minFont && size === 1) {
                            minFont.value = true;
                        }
                        fontSize = size + unit;
                    }
                    var lineHeight = style.lineHeight;
                    if (lineHeight.indexOf(unit) !== -1) {
                        var height = Math_max(1, parseFloat(lineHeight.replace(unit, '')) * factor);
                        lineHeight = height + unit;
                    }
                    if (factor === 1) {
                        fontInfo = {
                            font: font,
                            fontFamily: span.style.fontFamily,
                            fontSize: size
                        };
                    } else {
                        span.style.fontSize = fontSize;
                        span.style.lineHeight = lineHeight;
                        fontInfo = {
                            font: span.style.font,
                            fontFamily: span.style.fontFamily,
                            fontSize: size
                        };
                    }
                    if (!ignoreCache) {
                        cache[font] = fontInfo;
                    }
                    return fontInfo;
                };
                _StyleHelper._getMeasureSpan = function () {
                    if (!_StyleHelper._measureSpan) {
                        var NEGTIVE_10000_PX = '-10000px';
                        var span = common_1._util._createElement('span');
                        var spanStyle = span.style;
                        spanStyle.visibility = 'hidden';
                        spanStyle.top = NEGTIVE_10000_PX;
                        spanStyle.left = NEGTIVE_10000_PX;
                        spanStyle.lineHeight = 'normal';
                        spanStyle.position = 'absolute';
                        spanStyle.fontWeight = 'normal';
                        spanStyle.fontStretch = 'normal';
                        spanStyle.fontVariant = 'normal';
                        spanStyle.fontStyle = 'normal';
                        DOCUMENT.body.insertBefore(span, null);
                        _StyleHelper._measureSpan = span;
                        _StyleHelper._measureSpanOriginalStyleText = spanStyle.cssText;
                    } else {
                        _StyleHelper._measureSpan.style.cssText = _StyleHelper._measureSpanOriginalStyleText;
                    }
                    return _StyleHelper._measureSpan;
                };
                _StyleHelper._dispose = function () {
                    var span = _StyleHelper._measureSpan;
                    if (span) {
                        domUtil_1.GC$(span).remove();
                        _StyleHelper._measureSpan = keyword_undefined;
                        _StyleHelper._measureSpanOriginalStyleText = keyword_undefined;
                    }
                };
                _StyleHelper.stringFontCatch = {};
                _StyleHelper._setStringFont = function (font, fontWeight) {
                    var key = font + ',' + fontWeight;
                    var cache = _StyleHelper.stringFontCatch;
                    var result = cache[key];
                    if (!result) {
                        var span = _StyleHelper._getMeasureSpan();
                        span.style.font = font;
                        if (fontWeight) {
                            span.style.fontWeight = fontWeight;
                        }
                        result = cache[key] = span.style.font;
                    }
                    return result;
                };
                _StyleHelper._fontStringCache = {};
                _StyleHelper._scaleFontInfoCache = {};
                _StyleHelper._composeTextDecoration = function (value) {
                    if (value <= 0) {
                        return 'none';
                    }
                    var result = '';
                    if ((value | 1) === value) {
                        result += 'underline ';
                    }
                    if ((value | 2) === value) {
                        result += 'line-through ';
                    }
                    if ((value | 4) === value) {
                        result += 'overline ';
                    }
                    return result.trim();
                };
                _StyleHelper.setFillStyle = function (ctx, backColor, left, top, width, height, fillFunc) {
                    if (typeof backColor === 'string') {
                        if (ctx.fillStyle !== backColor) {
                            ctx.fillStyle = backColor;
                        }
                        fillFunc();
                    } else if (backColor.type === 'path') {
                        _StyleHelper.setFillStyle_Path(ctx, backColor, left, top, width, height, fillFunc);
                    } else if (backColor.stops) {
                        _StyleHelper.setFillStyle_Gradient(ctx, backColor, left, top, width, height, fillFunc);
                    } else if (backColor.type) {
                        _StyleHelper.setFillStyle_patternFill(ctx, backColor, left, top, width, height, fillFunc);
                    }
                };
                _StyleHelper.setFillStyle_patternFill = function (ctx, fill, left, top, width, height, fillFunc) {
                    var pattern = _PatternMap[fill.type];
                    var h = pattern.length;
                    var w = pattern[0].length;
                    var buff = document.createElement('canvas');
                    document.body.append(buff);
                    buff.width = w;
                    buff.height = h;
                    var buffCtx = buff.getContext('2d');
                    buffCtx.fillStyle = fill.backgroundColor || COLOR_WHITE;
                    buffCtx.fillRect(0, 0, w, h);
                    buffCtx.fillStyle = fill.patternColor || COLOR_BLACK;
                    for (var i = 0; i < h; i++) {
                        for (var j = 0; j < w; j++) {
                            var c = pattern[i][j];
                            if (c) {
                                buffCtx.fillRect(j, i, 1, 1);
                            }
                        }
                    }
                    ctx.createPattern(buff, 'repeat');
                    var pat = ctx.createPattern(buff, 'repeat');
                    ctx.fillStyle = pat;
                    fillFunc();
                };
                _StyleHelper.processStops = function (backColor) {
                    if (backColor.stops || backColor.type === 'path') {
                        var stops = backColor.stops;
                        if (!stops) {
                            stops = [
                                {
                                    position: 0,
                                    color: COLOR_WHITE
                                },
                                {
                                    position: 1,
                                    color: COLOR_WHITE
                                }
                            ];
                        } else if (stops.length === 0) {
                            stops = [
                                {
                                    position: 0,
                                    color: COLOR_BLACK
                                },
                                {
                                    position: 1,
                                    color: COLOR_BLACK
                                }
                            ];
                        } else {
                            stops = stops.filter(function (item, index, array) {
                                return item.position <= 1 && item.position >= 0;
                            });
                            stops.sort(function (a, b) {
                                return a.position - b.position;
                            });
                            for (var i = 0; i < stops.length; i++) {
                                stops[i].color = stops[i].color || COLOR_BLACK;
                            }
                            if (stops[0].position !== 0) {
                                stops.splice(0, 0, {
                                    position: 0,
                                    color: COLOR_BLACK
                                });
                            }
                            if (stops[stops.length - 1].position !== 1) {
                                stops.push({
                                    position: 1,
                                    color: COLOR_BLACK
                                });
                            }
                        }
                        backColor.stops = stops;
                    }
                    if (backColor.type === 'path') {
                        backColor.left = _setValueRegion(backColor.left);
                        backColor.right = _setValueRegion(backColor.right);
                        backColor.top = _setValueRegion(backColor.top);
                        backColor.bottom = _setValueRegion(backColor.bottom);
                    } else if (backColor.stops) {
                        delete backColor.type;
                        backColor.degree = backColor.degree || 0;
                    }
                };
                _StyleHelper.setFillStyle_Gradient = function (ctx, fill, left, top, width, height, fillFunc) {
                    var degree = fill.degree || 0;
                    var grd, degree1, degree2, d;
                    if (degree % 90 === 0) {
                        degree1 = degree / 180 * Math_PI;
                        degree2 = Math_abs(degree % 180 / 180 * Math_PI) - Math_atan(height / width);
                    } else {
                        degree1 = Math_atan(width / height * Math_tan(degree / 180 * Math_PI));
                        degree2 = Math_abs(degree1) - Math_atan(height / width);
                        degree1 = Math.round(degree / 180) * Math_PI + degree1;
                    }
                    d = Math.sqrt(width * width + height * height) / 2;
                    grd = ctx.createLinearGradient(left + width / 2 - d * Math_cos(degree2) * Math_cos(degree1), top + height / 2 - d * Math_cos(degree2) * Math_sin(degree1), left + width / 2 + d * Math_cos(degree2) * Math_cos(degree1), top + height / 2 + d * Math_cos(degree2) * Math_sin(degree1));
                    var stops = fill.stops;
                    for (var i = 0, len = stops.length; i < len; i++) {
                        grd.addColorStop(stops[i].position, stops[i].color || COLOR_WHITE);
                    }
                    ctx.fillStyle = grd;
                    fillFunc();
                };
                _StyleHelper.setFillStyle_Path = function (ctx, fill, left, top, width, height, fillFunc) {
                    var _left = fill.left || 0;
                    var _right = fill.right || 0;
                    var _top = fill.top || 0;
                    var _bottom = fill.bottom || 0;
                    var stops = fill.stops;
                    var grd;
                    if (_left > _right) {
                        _right = _left;
                    }
                    if (_top > _bottom) {
                        _bottom = _top;
                    }
                    if (_left > 0) {
                        ctx.save();
                        ctx.beginPath();
                        grd = ctx.createLinearGradient(left + width * _left, 0, left, 0);
                        for (var i = 0, len = stops.length; i < len; i++) {
                            grd.addColorStop(stops[i].position, stops[i].color || COLOR_WHITE);
                        }
                        ctx.fillStyle = grd;
                        ctx.moveTo(left, top - 1);
                        ctx.lineTo(left + width * _left + 1, top + height * _top);
                        ctx.lineTo(left + width * _left + 1, top + height * _bottom);
                        ctx.lineTo(left, top + height + 1);
                        ctx.clip();
                        fillFunc();
                        ctx.restore();
                    }
                    if (_right < 1) {
                        ctx.save();
                        ctx.beginPath();
                        grd = ctx.createLinearGradient(left + width * _right, 0, left + width, 0);
                        for (var i = 0, len = stops.length; i < len; i++) {
                            grd.addColorStop(stops[i].position, stops[i].color || COLOR_WHITE);
                        }
                        ctx.fillStyle = grd;
                        ctx.moveTo(left + width, top - 1);
                        ctx.lineTo(left + width, top + height + 1);
                        ctx.lineTo(left + width * _right - 1, top + height * _bottom);
                        ctx.lineTo(left + width * _right - 1, top + height * _top);
                        ctx.clip();
                        fillFunc();
                        ctx.restore();
                    }
                    if (_top > 0) {
                        ctx.save();
                        ctx.beginPath();
                        grd = ctx.createLinearGradient(0, top + height * _top, 0, top);
                        for (var i = 0, len = stops.length; i < len; i++) {
                            grd.addColorStop(stops[i].position, stops[i].color || COLOR_WHITE);
                        }
                        ctx.fillStyle = grd;
                        ctx.moveTo(left, top);
                        ctx.lineTo(left + width, top);
                        ctx.lineTo(left + width * _right, top + height * _top + 1);
                        ctx.lineTo(left + width * _left, top + height * _top + 1);
                        ctx.clip();
                        fillFunc();
                        ctx.restore();
                    }
                    if (_bottom < 1) {
                        ctx.save();
                        ctx.beginPath();
                        grd = ctx.createLinearGradient(0, top + height * _bottom, 0, top + height);
                        for (var i = 0, len = stops.length; i < len; i++) {
                            grd.addColorStop(stops[i].position, stops[i].color || COLOR_WHITE);
                        }
                        ctx.fillStyle = grd;
                        ctx.moveTo(left + width, top + height);
                        ctx.lineTo(left, top + height);
                        ctx.lineTo(left + width * _left, top + height * _bottom - 1);
                        ctx.lineTo(left + width * _right, top + height * _bottom - 1);
                        ctx.clip();
                        fillFunc();
                        ctx.restore();
                    }
                    if (_left < _right && _top < _bottom) {
                        ctx.save();
                        ctx.beginPath();
                        ctx.fillStyle = stops[0].color;
                        ctx.rect(left + width * _left, top + height * _top, width * (_right - _left), height * (_bottom - _top));
                        ctx.clip();
                        fillFunc();
                        ctx.restore();
                    }
                };
                return _StyleHelper;
            }());
            exports._StyleHelper = _StyleHelper;
        }),
        './dist/core/worksheet/worksheet-actions.js': (function (module, exports, __webpack_require__) {
            var __extends = (this && this.__extends) || (function () {
                var extendStatics = function (d, b) {
                    extendStatics = Object.setPrototypeOf ||
                        ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
                        function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };
                    return extendStatics(d, b);
                };
                return function (d, b) {
                    extendStatics(d, b);
                    function __() { this.constructor = d; }
                    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
                };
            })();
            Object.defineProperty(exports, '__esModule', { value: true });
            var core_ns_1 = __webpack_require__(/*! ../core.ns */ './dist/core/core.ns.js');
            var Common_1 = __webpack_require__(/*! Common */ 'Common');
            var Common_2 = __webpack_require__(/*! Common */ 'Common');
            var style_1 = __webpack_require__(/*! ./style */ './dist/core/worksheet/style.js');
            var worksheet_1 = __webpack_require__(/*! ./worksheet */ './dist/core/worksheet/worksheet.js');
            var common_1 = __webpack_require__(/*! ../util/common */ './dist/core/util/common.js');
            var clipboardhelper_1 = __webpack_require__(/*! ./clipboardhelper */ './dist/core/worksheet/clipboardhelper.js');
            var DomUtilModule = __webpack_require__(/*! ../util/domUtil */ './dist/core/util/domUtil.js');
            var core_enum_1 = __webpack_require__(/*! ../core.enum */ './dist/core/core.enum.js');
            var $ = DomUtilModule.GC$;
            var worksheet_static_1 = __webpack_require__(/*! ./worksheet-static */ './dist/core/worksheet/worksheet-static.js');
            var CalcEngine = __webpack_require__(/*! CalcEngine */ 'CalcEngine');
            var _supportsCalc = !!CalcEngine;
            var isNullOrUndefined = Common_1.Common._Types._isNullOrUndefined, ArrayHelper_contains = Common_1.Common._ArrayHelper._contains, StringHelper = Common_1.Common._StringHelper, StringHelper_endsWith = StringHelper._endsWith, Events_CellChanged = common_1.Events.CellChanged, Events_ColumnWidthChanging = common_1.Events.ColumnWidthChanging, Events_ColumnWidthChanged = common_1.Events.ColumnWidthChanged, Events_RowHeightChanging = common_1.Events.RowHeightChanging, Events_RowHeightChanged = common_1.Events.RowHeightChanged, browser = common_1._util._browser, isDefined = common_1._util._isDefined, $_extend = $.extend, $_inherit = $.inherit;
            var keyword_null = null, keyword_undefined = void 0, Math_max = Math.max, Math_min = Math.min, Math_floor = Math.floor, Math_ceil = Math.ceil, Number_MAX_VALUE = Number.MAX_VALUE, isNaNFunc = isNaN;
            var hyperlinkReg = '^(((ht|f)tp(s?)):\\/\\/(?:www\.|(?!www))[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\\.[^\\s]{2,}|www\\.[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\\.[^\\s]{2,}|((ht|f)tp(s?)):\\/\\/(?:www\\.|(?!www))[a-zA-Z0-9]+\\.[^\\s]{2,}|www\\.[a-zA-Z0-9]+\\.[^\\s]{2,})$';
            var emailReg = '^(mailto:\\/\\/)?([A-Za-z0-9_\\-\\.\\!\\#$%&\'*\\+/=?^`{|}~])+\\@([A-Za-z0-9\\-])+\\.([A-Za-z0-9\\-]){2,63}(\\?subject=.+)?$';

            var CopyToOptions;
            (function (CopyToOptions) {
                CopyToOptions[CopyToOptions['value'] = 1] = 'value';
                CopyToOptions[CopyToOptions['formula'] = 2] = 'formula';
                CopyToOptions[CopyToOptions['comment'] = 4] = 'comment';
                CopyToOptions[CopyToOptions['outline'] = 8] = 'outline';
                CopyToOptions[CopyToOptions['sparkline'] = 16] = 'sparkline';
                CopyToOptions[CopyToOptions['span'] = 32] = 'span';
                CopyToOptions[CopyToOptions['style'] = 64] = 'style';
                CopyToOptions[CopyToOptions['tag'] = 128] = 'tag';
                CopyToOptions[CopyToOptions['bindingPath'] = 256] = 'bindingPath';
                CopyToOptions[CopyToOptions['conditionalFormat'] = 512] = 'conditionalFormat';
                CopyToOptions[CopyToOptions['hyperlink'] = 1024] = 'hyperlink';
                CopyToOptions[CopyToOptions['all'] = 2047] = 'all';
            })(CopyToOptions = exports.CopyToOptions || (exports.CopyToOptions = {}));

            function getSheetRowCount(sheet, sheetArea) {
                return sheet.getRowCount(sheetArea);
            }
            function getSheetColumnCount(sheet, sheetArea) {
                return sheet.getColumnCount(sheetArea);
            }
            function getRowCount(obj) {
                return obj.rowCount;
            }
            function getColCount(obj) {
                return obj.colCount;
            }
            function allowExtendPasteRange(sheet) {
                var workbook = sheet.parent;
                return workbook && workbook.options.allowExtendPasteRange;
            }
            function allowCopyPasteExcelStyle(sheet) {
                var workbook = sheet.parent;
                return workbook && workbook.options.allowCopyPasteExcelStyle;
            }
            function copyPasteHeaderOptions(sheet) {
                var workbook = sheet.parent;
                return workbook && workbook.options.copyPasteHeaderOptions;
            }
            var rm = new Common_1.Common.ResourceManager(core_ns_1.SR);
            var getSR = rm.getResource.bind(rm);
            function raiseInvalidRangeException(item, value, start, end) {
                throw new Error(StringHelper._format(getSR().Exp_InvalidAndSpace, [item, value, start, end]));
            }
            function suspendPaint(sheet) {
                sheet.suspendPaint();
            }
            function resumePaint(sheet) {
                sheet.resumePaint();
            }
            function suspendEvent(sheet) {
                sheet.suspendEvent();
            }
            function resumeEvent(sheet) {
                sheet.resumeEvent();
            }
            function suspendCalcService(sheet, ignoreDirty) {
                if (sheet && _supportsCalc) {
                    sheet.suspendCalcService(ignoreDirty);
                }
            }
            function resumeCalcService(sheet, recalcAll) {
                if (sheet && _supportsCalc) {
                    sheet.resumeCalcService(recalcAll);
                }
            }
            function isHiddenInSpan(sheet, row, col, sheetArea, forClipboard) {
                var span = sheet.getSpan(row, col, sheetArea);
                if (span && forClipboard && (span.row !== row || span.col !== col)) {
                    return true;
                }
            }
            function ImportExportOptions(flags) {
                var self = this;
                self._rowHeader = ((flags & 1) === 1);
                self._columnHeader = ((flags & 2) === 2);
                self._unFormatted = ((flags & 8) === 8);
                self._formula = _supportsCalc && ((flags & 16) === 16);
                self._expandRows = true;
                self._expandColumns = true;
            }
            function parseText(data, rowDelimiter, columnDelimiter, cellDelimiter, withoutCellDelimiter, fromAnotherSpread) {
                if (isNullOrUndefined(data) || data === '') {
                    return keyword_null;
                }
                if (isNullOrUndefined(rowDelimiter) || rowDelimiter === '') {
                    rowDelimiter = '\r\n';
                }
                var rowDelimiter2 = '\n';
                if (isNullOrUndefined(columnDelimiter) || columnDelimiter === '') {
                    columnDelimiter = '\t';
                }
                if (isNullOrUndefined(cellDelimiter) || cellDelimiter === '') {
                    cellDelimiter = '"';
                }
                if (!StringHelper_endsWith(data, rowDelimiter)) {
                    data += rowDelimiter;
                }
                var withCellDelimiter = !withoutCellDelimiter;
                var sheetData = [], rowData = [];
                var sbr = '', sbrLength;
                var inCell = false;
                var dl = cellDelimiter.length;
                var rdl = rowDelimiter.length;
                var rdl2 = rowDelimiter2.length;
                var cdl = columnDelimiter.length;
                var dataLength = data.length;
                for (var index = 0; index < dataLength; index++) {
                    sbr += data[index];
                    sbrLength = sbr.length;
                    if (withCellDelimiter && sbrLength >= dl && cellDelimiter === sbr.substr(sbrLength - dl, dl)) {
                        if (inCell && dataLength >= index + 1 + dl && cellDelimiter === data.substr(index + 1, dl)) {
                            index += dl;
                        } else if (!inCell) {
                            var temp = sbr;
                            if (temp.indexOf(cellDelimiter) === 0) {
                                sbr = sbr.substr(0, sbrLength - dl);
                                inCell = true;
                            }
                        } else {
                            sbr = sbr.substr(0, sbrLength - dl);
                            inCell = false;
                        }
                    } else if (!inCell && sbrLength >= cdl && columnDelimiter === sbr.substr(sbrLength - cdl, cdl)) {
                        sbr = sbr.substr(0, sbrLength - cdl);
                        rowData.push(sbr.toString());
                        sbr = '';
                    } else if (!inCell && sbrLength >= rdl && rowDelimiter === sbr.substr(sbrLength - rdl, rdl)) {
                        sbr = sbr.substr(0, sbrLength - rdl);
                        rowData.push(sbr.toString());
                        sheetData.push(rowData);
                        rowData = [];
                        sbr = '';
                    } else if (!inCell && sbrLength >= rdl2 && rowDelimiter2 === sbr.substr(sbrLength - rdl2, rdl2)) {
                        sbr = sbr.substr(0, sbrLength - rdl2);
                        rowData.push(sbr.toString());
                        sheetData.push(rowData);
                        rowData = [];
                        sbr = '';
                    } else if (inCell && dataLength >= index + 1 + cdl && columnDelimiter === data.substr(index + 1, cdl) && columnDelimiter !== ',') {
                        index += dl;
                    }
                }
                if (inCell) {
                    if (rowData.length > 0) {
                        var i = void 0;
                        for (i = 0; i < sheetData.length; i++) {
                            if (sheetData[i] === rowData) {
                                break;
                            }
                        }
                        if (i >= sheetData.length) {
                            sheetData.push(rowData);
                        }
                    }
                    var inCellStr = sbr.toString();
                    if (inCellStr) {
                        inCellStr = inCellStr.replace(new RegExp(columnDelimiter, 'g'), '');
                        if (StringHelper_endsWith(inCellStr, rowDelimiter)) {
                            inCellStr = inCellStr.substr(0, inCellStr.length - rdl);
                        }
                        if (sheetData.length === 0) {
                            sheetData.push([inCellStr]);
                        }
                    }
                }
                if (sheetData.length === 0) {
                    var text = data;
                    if (StringHelper_endsWith(data, rowDelimiter)) {
                        text = text.substr(0, text.length - rdl);
                    }
                    sheetData.push([text]);
                }
                if (fromAnotherSpread && isSingleColumnData(sheetData) && /^(\s)*$/.test(data) && data.substr(data.length - rdl2, rdl2) === rowDelimiter2) {
                    sheetData.push(['']);
                }
                return sheetData;
            }
            function isSingleColumnData(sheetData) {
                if (sheetData) {
                    var i = 0;
                    for (; i < sheetData.length; i++) {
                        var rowData = sheetData[i];
                        if (!rowData || rowData.length !== 1) {
                            break;
                        }
                    }
                    if (i === sheetData.length) {
                        return true;
                    }
                }
                return false;
            }
            function setSheetData(sheet, rowIndex, columnIndex, data, flags) {
                var dataRowCount = data.length;
                var dataColumnCount = getMaxLength(data);
                if (dataRowCount === 0 || dataColumnCount === 0) {
                    return;
                }
                var opt = new ImportExportOptions(flags);
                if (sheet) {
                    if (getSheetColumnCount(sheet, 2) <= 0) {
                        opt._rowHeader = false;
                    }
                    if (getSheetRowCount(sheet, 1) <= 0) {
                        opt._columnHeader = false;
                    }
                }
                var rowHeaderColumnCount = opt._rowHeader ? getSheetColumnCount(sheet, 2) : 0;
                var columnHeaderRowCount = opt._columnHeader ? getSheetRowCount(sheet, 1) : 0;
                var columnFooterRowCount = 0;
                dataColumnCount -= rowHeaderColumnCount;
                if (dataColumnCount <= 0) {
                    dataColumnCount = 0;
                }
                dataRowCount -= columnHeaderRowCount;
                if (dataRowCount <= 0) {
                    columnFooterRowCount = 0;
                }
                dataRowCount -= columnFooterRowCount;
                if (dataRowCount <= 0) {
                    dataRowCount = 0;
                }
                if (opt._expandRows && rowIndex + dataRowCount > getSheetRowCount(sheet)) {
                    sheet.setRowCount(rowIndex + dataRowCount);
                }
                if (opt._expandColumns && columnIndex + dataColumnCount > getSheetColumnCount(sheet)) {
                    sheet.setColumnCount(columnIndex + dataColumnCount);
                }
                for (var r = 0, sheetRowIndex = 0; r < data.length; r++, sheetRowIndex++) {
                    var rowData = data[r];
                    var pasteSkipInvisibleRange = sheet._getPasteSkipInvisibleRange();
                    if (rowData.length <= 0) {
                        continue;
                    }
                    if (columnHeaderRowCount > 0 && r < columnHeaderRowCount) {
                        setRowData(sheet, rowData, sheetRowIndex, columnIndex, dataColumnCount, 1, opt);
                    } else if (dataRowCount > 0 && sheetRowIndex < getSheetRowCount(sheet)) {
                        if (r === columnHeaderRowCount) {
                            sheetRowIndex = rowIndex;
                        }
                        setRowData(sheet, rowData, sheetRowIndex, 0, rowHeaderColumnCount, 2, opt);
                        rowData.splice(0, rowHeaderColumnCount);
                        if (pasteSkipInvisibleRange) {
                            sheetRowIndex = sheet._getNextVisualRow(sheetRowIndex - 1, 3);
                        }
                        setRowData(sheet, rowData, sheetRowIndex, columnIndex, dataColumnCount, 3, opt, pasteSkipInvisibleRange);
                    }
                }
            }
            function setRowData(sheet, rowData, sheetRowIndex, columnIndex, columnCount, area, opt, pasteSkipInvisibleRange) {
                var sheetColumnCount = getSheetColumnCount(sheet, area);
                for (var c = 0, sheetColumnIndex = columnIndex; c < rowData.length; c++, sheetColumnIndex++) {
                    if (columnCount > 0 && sheetColumnIndex < sheetColumnCount) {
                        if (pasteSkipInvisibleRange) {
                            sheetColumnIndex = sheet._getNextVisualColumn(sheetColumnIndex - 1, 3);
                        }
                        setCellData(sheet, area, sheetRowIndex, sheetColumnIndex, rowData[c], opt);
                    }
                }
            }
            function setCellData(sheet, area, rowIndex, columnIndex, value, opt) {
                var setvalue = value;
                var autodisplayformatter = keyword_null;
                if (opt._unFormatted === false) {
                    var formaterRef = { value: keyword_null };
                    setvalue = common_1._util._parseText2Value(keyword_null, value, !opt._unFormatted, formaterRef);
                    autodisplayformatter = formaterRef.value;
                }
                if (isNullOrUndefined(setvalue)) {
                    sheet.setValue(rowIndex, columnIndex, setvalue, area);
                } else if (value !== '') {
                    if (opt._formula && value[0] === '=' && value.length > 1) {
                        try {
                            sheet.setFormula(rowIndex, columnIndex, value.substr(1));
                        } catch (ex) {
                            sheet.setText(rowIndex, columnIndex, value, area);
                        }
                    } else {
                        var formatter = sheet._getStyleProperty(rowIndex, columnIndex, 'formatter', area);
                        if (opt._unFormatted === false && autodisplayformatter) {
                            if (!formatter) {
                                autodisplayformatter.isAuto = true;
                                sheet.getCell(rowIndex, columnIndex, area)._setStyleProperty('_autoFormatter', autodisplayformatter);
                                var t = value;
                                var ct = sheet.getCellType(rowIndex, columnIndex, area);
                                var formatStr = autodisplayformatter.formatString();
                                if (ct && ct.typeName === '7') {
                                    var context = { sheet: sheet, row: rowIndex, col: columnIndex, sheetArea: area };
                                    t = ct.parse(value, formatStr, context);
                                    setvalue = isNullOrUndefined(t) ? value : t;
                                }
                            } else if (formatter) {
                                if (typeof formatter === 'string' && Common_2.Formatter) {
                                    formatter = new Common_2.Formatter.GeneralFormatter(formatter);
                                }
                                var parseValue = formatter.parse && formatter.parse(value);
                                setvalue = isNullOrUndefined(parseValue) ? setvalue : parseValue;
                            }
                        } else if (formatter) {
                            sheet.getCell(rowIndex, columnIndex, area).formatter(keyword_null);
                        }
                        sheet.setValue(rowIndex, columnIndex, setvalue, area);
                    }
                } else {
                    sheet.setValue(rowIndex, columnIndex, keyword_null, area);
                }
            }
            function getMaxLength(data) {
                var len = 0;
                for (var i = 0; i < (data && data.length); i++) {
                    var list = data[i];
                    len = Math_max(list.length, len);
                }
                return len;
            }
            function setRangeText(sheet, row, column, data, rowDelimiter, columnDelimiter, cellDelimiter, flags, withoutCellDelimiter, fromAnotherSpread) {
                if (!sheet) {
                    throw new Error(getSR().Exp_SheetIsNull);
                }
                if (row < -1 || row >= getSheetRowCount(sheet)) {
                    raiseInvalidRangeException('row', row, '-1', getSheetRowCount(sheet) - 1);
                }
                if (column < -1 || column >= getSheetColumnCount(sheet)) {
                    raiseInvalidRangeException('column', column, '-1', getSheetColumnCount(sheet) - 1);
                }
                if (isNullOrUndefined(data) || data === '') {
                    return;
                }
                if (row === -1) {
                    row = 0;
                }
                if (column === -1) {
                    column = 0;
                }
                var sheetData = parseText(data, rowDelimiter, columnDelimiter, cellDelimiter, withoutCellDelimiter, fromAnotherSpread);
                if (sheetData && sheetData.length > 0) {
                    setSheetData(sheet, row, column, sheetData, flags);
                }
            }
            function getRangeText(sheet, row, rowCount, column, columnCount, rowDelimiter, columnDelimiter, cellDelimiter, forceCellDelimiter, ignoredRows, ignoredCols, forClipboard, replaceEmpty, forCompare) {
                if (!sheet) {
                    throw new Error(getSR().Exp_SheetIsNull);
                }
                var sheetRowCount = getSheetRowCount(sheet), sheetColumnCount = getSheetColumnCount(sheet);
                if (row < -1 || row >= sheetRowCount) {
                    raiseInvalidRangeException('row', row, '-1', sheetRowCount - 1);
                }
                if (rowCount < -1 || row + rowCount > sheetRowCount) {
                    raiseInvalidRangeException('rowCount', rowCount, '-1', sheetRowCount - row);
                }
                if (column < -1 || column >= sheetColumnCount) {
                    raiseInvalidRangeException('column', column, '-1', sheetColumnCount - 1);
                }
                if (columnCount < -1 || column + columnCount > sheetColumnCount) {
                    raiseInvalidRangeException('columnCount', columnCount, '-1', sheetColumnCount - column);
                }
                var endRow = -1;
                var endColumn = -1;
                var includeColumnHeader = false;
                var includeRowHeader = false;
                if (row === -1 && column === -1 && rowCount === -1 && columnCount === -1) {
                    row = 0;
                    column = 0;
                    endRow = getSheetRowCount(sheet) - 1;
                    endColumn = getSheetColumnCount(sheet) - 1;
                } else {
                    if (row === -1) {
                        row = 0;
                        if ((copyPasteHeaderOptions(sheet) & 2) === 2) {
                            includeColumnHeader = true;
                        }
                    }
                    if (column === -1) {
                        column = 0;
                        if ((copyPasteHeaderOptions(sheet) & 1) === 1) {
                            includeRowHeader = true;
                        }
                    }
                    if (rowCount === -1) {
                        rowCount = getSheetRowCount(sheet) - row;
                    }
                    if (columnCount === -1) {
                        columnCount = getSheetColumnCount(sheet) - column;
                    }
                    endRow = row + rowCount - 1;
                    endColumn = column + columnCount - 1;
                }
                if (isNullOrUndefined(rowDelimiter) || rowDelimiter === '') {
                    rowDelimiter = '\r\n';
                }
                if (isNullOrUndefined(columnDelimiter) || columnDelimiter === '') {
                    columnDelimiter = '\t';
                }
                if (isNullOrUndefined(cellDelimiter) || cellDelimiter === '') {
                    cellDelimiter = '"';
                }
                var cellDelimiterReg = new RegExp(cellDelimiter, 'g');
                var rowHeaderText = null;
                var columnHeaderText = null;
                var viewportText = getRangeTextImp(sheet, row, endRow, column, endColumn, 3, ignoredRows, ignoredCols, rowDelimiter, columnDelimiter, cellDelimiter, cellDelimiterReg, forceCellDelimiter, forClipboard, replaceEmpty, forCompare);
                if (includeRowHeader) {
                    var rowHeaderCount = sheet.getColumnCount(2);
                    rowHeaderText = getRangeTextImp(sheet, row, endRow, 0, rowHeaderCount - 1, 2, ignoredRows, ignoredCols, rowDelimiter, columnDelimiter, cellDelimiter, cellDelimiterReg, forceCellDelimiter, forClipboard, replaceEmpty, forCompare);
                }
                if (includeColumnHeader) {
                    var colHeaderRowCount = sheet.getRowCount(1);
                    columnHeaderText = getRangeTextImp(sheet, 0, colHeaderRowCount - 1, column, endColumn, 1, ignoredRows, ignoredCols, rowDelimiter, columnDelimiter, cellDelimiter, cellDelimiterReg, forceCellDelimiter, forClipboard, replaceEmpty, forCompare);
                }
                return join(viewportText, rowHeaderText, columnHeaderText, rowDelimiter, columnDelimiter);
            }
            function join(viewportTextRage, rowHeaderTextRange, colHeaderTextRage, rowDelimiter, columnDelimiter) {
                var arrayBuilder = viewportTextRage, rowHeaderColumnCount = 0;
                var concatOnRow = function (sourceRange, targetRange) {
                    var rangeBuilder = [], rowCount = sourceRange.length;
                    for (var row = 0; row < rowCount; row++) {
                        rangeBuilder.push(sourceRange[row].concat(targetRange[row]));
                    }
                    return rangeBuilder;
                };
                if (rowHeaderTextRange) {
                    rowHeaderColumnCount = rowHeaderTextRange[0].length;
                    arrayBuilder = concatOnRow(rowHeaderTextRange, viewportTextRage);
                }
                if (colHeaderTextRage) {
                    var colHeaderRowCount = colHeaderTextRage.length;
                    var cornerTextRange = null;
                    if (rowHeaderColumnCount) {
                        cornerTextRange = getRangeTextImp(null, 0, colHeaderRowCount - 1, 0, rowHeaderColumnCount - 1, null, [], [], rowDelimiter, columnDelimiter, null, null, null, false, false);
                        colHeaderTextRage = concatOnRow(cornerTextRange, colHeaderTextRage);
                    }
                    arrayBuilder = colHeaderTextRage.concat(arrayBuilder);
                }
                return buildStr(arrayBuilder, rowDelimiter, columnDelimiter);
            }
            function buildStr(arrayBuilder, rowDelimiter, columnDelimiter) {
                var row, col, strBuilder = '';
                var rowCount = arrayBuilder.length;
                for (row = 0; row < rowCount; row++) {
                    for (col = 0; col < arrayBuilder[row].length; col++) {
                        if (col !== 0) {
                            strBuilder += columnDelimiter;
                        }
                        strBuilder += arrayBuilder[row][col];
                    }
                    strBuilder += rowDelimiter;
                }
                return strBuilder;
            }
            function getRangeTextImp(sheet, row, endRow, column, endColumn, sheetArea, ignoredRows, ignoredCols, rowDelimiter, columnDelimiter, cellDelimiter, cellDelimiterReg, forceCellDelimiter, forClipboard, replaceEmpty, forCompare) {
                var rangeText = [];
                var r, c, allowExcelStyle = sheet && allowCopyPasteExcelStyle(sheet);
                for (r = row; r <= endRow; r++) {
                    if (ignoredRows && ArrayHelper_contains(ignoredRows, r)) {
                        continue;
                    }
                    var rowText = [];
                    for (c = column; c <= endColumn; c++) {
                        if (ignoredCols && ArrayHelper_contains(ignoredCols, c)) {
                            continue;
                        }
                        var cellText = '';
                        if (sheet && !isHiddenInSpan(sheet, r, c, sheetArea, forClipboard)) {
                            cellText = sheet.getText(r, c, sheetArea);
                            if (forCompare && allowExcelStyle && cellText) {
                                if ((cellText[0] === ' ' || cellText[cellText.length - 1] === ' ')
                                    && typeof sheet.getValue(r, c, sheetArea) === 'number') {
                                    cellText = cellText.trim();
                                } else {
                                    cellText = cellText.replace(/[\r\n]+/g, '\n');
                                }
                            }
                        }
                        cellText = getCellStr(cellText, forClipboard, allowExcelStyle, cellDelimiterReg, cellDelimiter, replaceEmpty, forceCellDelimiter, columnDelimiter, rowDelimiter);
                        rowText.push(cellText);
                    }
                    rangeText.push(rowText);
                }
                return rangeText;
            }
            function getCellStr(cellData, forClipboard, copyPasteExcelStyle, cellDelimiterReg, cellDelimiter, replaceEmpty, forceCellDelimiter, columnDelimiter, rowDelimiter) {
                var cellStr = '';
                if (!isNullOrUndefined(cellData)) {
                    cellStr = cellData;
                    if (!forClipboard) {
                        cellStr = cellStr.replace(cellDelimiterReg, cellDelimiter + cellDelimiter);
                    }
                }
                if (replaceEmpty && !cellStr) {
                    cellStr = ' ';
                }
                if (forClipboard && copyPasteExcelStyle) {
                    cellStr = cellStr.replace(/\n/g, ' ');
                } else if (forceCellDelimiter || cellStr.indexOf(cellDelimiter) !== -1 || cellStr.indexOf(columnDelimiter) !== -1 ||
                    cellStr.indexOf(rowDelimiter) !== -1 || cellStr.indexOf('\n') !== -1) {
                    cellStr = cellDelimiter + cellStr + cellDelimiter;
                }
                return cellStr;
            }
            function parseCsv(text, rowDelimiter, columnDelimiter, cellDelimiter, fromAnotherSpread) {
                var ret = keyword_null;
                var parsedText = parseText(text, rowDelimiter, columnDelimiter, cellDelimiter, true, fromAnotherSpread);
                if (parsedText) {
                    var rowCount = parsedText.length;
                    var columnCount = getMaxLength(parsedText);
                    var textArray = [];
                    for (var r = 0; r < rowCount; r++) {
                        textArray[r] = [];
                        for (var c = 0; c < columnCount; c++) {
                            if (c < parsedText[r].length) {
                                textArray[r][c] = parsedText[r][c];
                            } else {
                                textArray[r][c] = keyword_null;
                            }
                        }
                    }
                    ret = textArray;
                }
                return ret;
            }
            $_extend(worksheet_1.Worksheet.prototype, {
                autoFitColumn: function (column) {
                    if (0 <= column && column < getSheetColumnCount(this)) {
                        this._commandManager().execute({
                            cmd: 'autoFitColumn',
                            sheetName: this.name(),
                            columns: [
                                {
                                    col: column
                                }
                            ],
                            rowHeader: false
                        });
                    }
                },
                autoFitRow: function (row) {
                    if (0 <= row && row < getSheetRowCount(this)) {
                        this._commandManager().execute({
                            cmd: 'autoFitRow',
                            sheetName: this.name(),
                            rows: [
                                {
                                    row: row
                                }
                            ],
                            columnHeader: false
                        });
                    }
                },
                setCsv: function (row, column, text, rowDelimiter, columnDelimiter, flags, withoutCellDelimiter, fromAnotherSpread) {
                    var self = this;
                    suspendPaint(self);
                    suspendEvent(self);
                    setRangeText(self, row, column, text, rowDelimiter, columnDelimiter, '"', flags, withoutCellDelimiter, fromAnotherSpread);
                    resumeEvent(self);
                    resumePaint(self);
                },
                getCsv: function (row, column, rowCount, columnCount, rowDelimiter, columnDelimiter) {
                    return getRangeText(this, row, rowCount, column, columnCount, rowDelimiter, columnDelimiter, '"', true);
                },
                copyTo: function (fromRow, fromColumn, toRow, toColumn, rowCount, columnCount, option) {
                    this._copyToCore(fromRow, fromColumn, toRow, toColumn, rowCount, columnCount, option);
                },
                _copyToCore: function (fromRow, fromColumn, toRow, toColumn, rowCount, columnCount, option, ignoreFilteredOutRow, ignorePasteSkipInvisibleRange) {
                    var self = this;
                    suspendPaint(self);
                    suspendEvent(self);
                    worksheet_static_1.staticMembers.copyTo(self, fromRow, fromColumn, self, toRow, toColumn, rowCount, columnCount, option, ignoreFilteredOutRow, 0, ignorePasteSkipInvisibleRange);
                    resumeEvent(self);
                    resumePaint(self);
                },
                moveTo: function (fromRow, fromColumn, toRow, toColumn, rowCount, columnCount, option, ignoreSheet) {
                    var self = this;
                    if (_supportsCalc && (option & CopyToOptions.formula)
                        && (!self._checkArrayFormula(fromRow, fromColumn, rowCount, columnCount, true)
                            || !self._checkArrayFormula(toRow, toColumn, rowCount, columnCount, true))) {
                        return;
                    }
                    try {
                        suspendPaint(self);
                        suspendEvent(self);
                        worksheet_static_1.staticMembers.moveTo(self, fromRow, fromColumn, self, toRow, toColumn, rowCount, columnCount, option, ignoreSheet);
                    } finally {
                        resumeEvent(self);
                        resumePaint(self);
                    }
                },
                _clipboardCopy: function (ranges, isCutting, ignoreClipboard) {
                    var self = this;
                    var range = self._getCopyRange(ranges);
                    if (!range) {
                        return;
                    }
                    var ignoredRowsCols = self._getIgnoredRowsCols(ranges);
                    var columnDelimiter = '\t';
                    var rowDelimiter = '\r\n';
                    var cellDelimiter = '"';
                    var eventHandler = self._eventHandler;
                    var copyText = getRangeText(self, range.row, getRowCount(range), range.col, getColCount(range), rowDelimiter, columnDelimiter, cellDelimiter, false, ignoredRowsCols.rows, ignoredRowsCols.cols, true);
                    var ch = self._getClipboardHelper();
                    ch._fromSheet = self;
                    ch._ranges = ranges;
                    ch._isCutting = isCutting;
                    var clipboardHelper = self._getClipboardHelper();
                    clipboardHelper._showInsertCopyPasteCells = true;
                    var options = copyPasteHeaderOptions(self);
                    var copyHtml = clipboardhelper_1._ClipboardHelper._getRangeHtml(self, options, range.row, getRowCount(range), range.col, getColCount(range), core_enum_1.SheetArea.viewport, allowCopyPasteExcelStyle(self), ignoredRowsCols.rows, ignoredRowsCols.cols, false, false, false, false);
                    self._clearFloatingObjectClipboardHelper && self._clearFloatingObjectClipboardHelper();
                    self._clearShapeClipboardHelper && self._clearShapeClipboardHelper();
                    try {
                        var args = {
                            sheet: self,
                            sheetName: self.name(),
                            copyData: { text: copyText, html: copyHtml },
                            cancel: false
                        };
                        self._trigger(common_1.Events.ClipboardChanging, args);
                        if (args && args.cancel === false) {
                            if (eventHandler && !ignoreClipboard) {
                                eventHandler._switchFocusForClipboard(allowCopyPasteExcelStyle(self) ? copyHtml : copyText);
                            }
                            self._trigger(common_1.Events.ClipboardChanged, {
                                sheet: self,
                                sheetName: self.name(),
                                copyData: { text: copyText, html: copyHtml }
                            });
                            setTimeout(function () {
                                if (eventHandler && !ignoreClipboard && !self._disposed) {
                                    eventHandler._switchBackFocusAfterClipboard();
                                }
                            }, 100);
                            return { copyText: copyText, copyHtml: copyHtml };
                        } else {
                            ch._reset();
                        }
                    } catch (e) { }
                },
                _checkPastedRange: function (fromSheet, fromRanges, toRange, pasteOption, isCutting, clipboardText, outPara, shiftCells, clipboardHtml, isFromDesigner) {
                    var msg_sheetViewPasteSouceSheetCellsAreLocked = getSR().Exp_PasteSourceCellsLocked;
                    outPara.pastedInternal = false;
                    outPara.pastedRange = keyword_null;
                    var noClipboardData = !clipboardText && !clipboardHtml;
                    if (!fromSheet && noClipboardData) {
                        return false;
                    }
                    var self = this;
                    var toSheet = self;
                    var ignoredRowsCols = self._getIgnoredRowsCols(fromRanges);
                    if (self._isPastedInternal(fromSheet, self._getCopyRange(fromRanges), toSheet, clipboardText, ignoredRowsCols.rows, ignoredRowsCols.cols, isFromDesigner) || noClipboardData) {
                        outPara.pastedInternal = true;
                        if (
                            isCutting
                            && fromSheet.options.isProtected
                            && fromSheet._isAnyCellInRangesLocked(fromRanges)
                        ) {
                            self._raiseInvalidOperation(1, msg_sheetViewPasteSouceSheetCellsAreLocked);
                            return false;
                        }
                        outPara.pastedRange = self._getPastedRange(fromSheet, fromRanges, toSheet, toRange, pasteOption, isCutting);
                    } else {
                        outPara.pastedRange = self._getPastedRangefromText(toSheet, toRange, clipboardText, clipboardhelper_1._ClipboardHelper._isFromAnotherSpread(clipboardHtml));
                    }
                    return self._checkPasteRangeImp(fromSheet, fromRanges, toRange, pasteOption, isCutting, outPara, shiftCells);
                },
                _checkPasteRangeImp: function (fromSheet, fromRanges, toRange, pasteOption, isCutting, outPara, shiftCells) {
                    var msg_sheetViewTheCopyAreaAndPasteAreaAreNotTheSameSize = getSR().Exp_InvalidCopyPasteSize;
                    var msg_sheetViewPasteDestinationSheetCellsAreLocked = getSR().Exp_PasteDestinationCellsLocked;
                    var msg_sheetViewPasteChangeMergeCell = getSR().Exp_PasteChangeMergeCell;
                    var msg_sheetViewPasteChangePartOfArrayFormula = getSR().Exp_ChangePartOfArray;
                    var self = this;
                    var toSheet = self;
                    var pastedRange = outPara.pastedRange;
                    var pasteSkipInvisibleRange = toSheet._getPasteSkipInvisibleRange();
                    if (!pastedRange) {
                        self._raiseInvalidOperation(1, msg_sheetViewTheCopyAreaAndPasteAreaAreNotTheSameSize);
                        return false;
                    }
                    if (!toSheet._canChange(
                        pastedRange.row, pastedRange.col,
                        getRowCount(pastedRange),
                        getColCount(pastedRange),
                        msg_sheetViewPasteDestinationSheetCellsAreLocked,
                        msg_sheetViewPasteChangePartOfArrayFormula,
                        keyword_undefined,
                        shiftCells
                    )) {
                        return false;
                    }
                    if (outPara.pastedInternal) {
                        var fromRangesLength = fromRanges.length;
                        if (fromRangesLength === 1) {
                            var fromRange = fromRanges[0];
                            if (isCutting
                                && !fromSheet._canChange(
                                    fromRange.row,
                                    fromRange.col,
                                    getRowCount(fromRange),
                                    getColCount(fromRange),
                                    msg_sheetViewPasteDestinationSheetCellsAreLocked,
                                    msg_sheetViewPasteChangePartOfArrayFormula
                                )
                            ) {
                                return false;
                            }
                            if (fromSheet._hasPartSpans(fromRange.row, fromRange.col, getRowCount(fromRange), getColCount(fromRange))) {
                                self._raiseInvalidOperation(1, msg_sheetViewPasteChangeMergeCell);
                                return false;
                            }
                            var toRowCount = pastedRange.row < 0 ? getSheetRowCount(toSheet) : getRowCount(pastedRange);
                            var toColumnCount = pastedRange.col < 0 ? getSheetColumnCount(toSheet) : getColCount(pastedRange);
                            var rowCount = fromRange.row < 0 ? getSheetRowCount(fromSheet) : getRowCount(fromRange);
                            var columnCount = fromRange.col < 0 ? getSheetColumnCount(fromSheet) : getColCount(fromRange);
                            if (pasteSkipInvisibleRange) {
                                toRowCount -= toSheet._getNextInvisibleCount(toRange.row, Math_max(toRowCount, rowCount), true);
                                toColumnCount -= toSheet._getNextInvisibleCount(toRange.col, Math_max(toColumnCount, columnCount));
                                toRowCount = toRowCount < 1 ? 1 : toRowCount;
                                toColumnCount = toColumnCount < 1 ? 1 : toColumnCount;
                            }
                            var isPasteExpand = pasteOption === 2;
                            if ((toRowCount > rowCount || toColumnCount > columnCount) && !isPasteExpand) {
                                var toRow = toRange.row;
                                var toColumn = toRange.col;
                                if (toRange.row < 0 && rowCount < getSheetRowCount(toSheet)) {
                                    toRow = 0;
                                }
                                if (toRange.col < 0 && columnCount < getSheetColumnCount(toSheet)) {
                                    toColumn = 0;
                                }
                                if (toRowCount % rowCount === 0 && toColumnCount === 1) {
                                    toColumnCount = columnCount;
                                    pastedRange = outPara.pastedRange = new common_1.Range(toRow, toColumn, toRowCount, toColumnCount);
                                } else if (toRowCount === 1 && toColumnCount % columnCount === 0) {
                                    toRowCount = rowCount;
                                    pastedRange = outPara.pastedRange = new common_1.Range(toRow, toColumn, toRowCount, toColumnCount);
                                } else if (toRowCount % rowCount !== 0 || toColumnCount % columnCount !== 0) {
                                    toRowCount = rowCount;
                                    toColumnCount = columnCount;
                                    pastedRange = outPara.pastedRange = new common_1.Range(toRow, toColumn, toRowCount, toColumnCount);
                                }
                                var rn = Math_floor(toRowCount / rowCount);
                                var cn = Math_floor(toColumnCount / columnCount);
                                for (var r = 0; r < rn; r++) {
                                    for (var c = 0; c < cn; c++) {
                                        if (!self._isSingleCellToSpanCell(fromRange, pastedRange) &&
                                            toSheet._hasPartSpans((toRow < 0 ? -1 : toRow + r * rowCount), (toColumn < 0 ? -1 : toColumn + c * columnCount), (toRow < 0 ? -1 : rowCount), (toColumn < 0 ? -1 : columnCount))) {
                                            self._raiseInvalidOperation(1, msg_sheetViewPasteChangeMergeCell);
                                            return false;
                                        }
                                    }
                                }
                            } else if (shiftCells === keyword_undefined && !self._isSingleCellToSpanCell(fromRange, pastedRange) &&
                                toSheet._hasPartSpans(pastedRange.row, pastedRange.col, getRowCount(pastedRange), getColCount(pastedRange))) {
                                self._raiseInvalidOperation(1, msg_sheetViewPasteChangeMergeCell);
                                return false;
                            }
                        } else if (fromRangesLength > 1) {
                            for (var i = 0; i < fromRangesLength; i++) {
                                var currentFromRange = fromRanges[i];
                                if (fromSheet._hasPartSpans(currentFromRange.row, currentFromRange.col, getRowCount(currentFromRange), getColCount(currentFromRange))) {
                                    self._raiseInvalidOperation(1, msg_sheetViewPasteChangeMergeCell);
                                    return false;
                                }
                            }
                            if (toSheet._hasPartSpans(pastedRange.row, pastedRange.col, getRowCount(pastedRange), getColCount(pastedRange))) {
                                self._raiseInvalidOperation(1, msg_sheetViewPasteChangeMergeCell);
                                return false;
                            }
                        }
                    } else {
                        if (toSheet._hasPartSpans(pastedRange.row, pastedRange.col, getRowCount(pastedRange), getColCount(pastedRange))) {
                            self._raiseInvalidOperation(1, msg_sheetViewPasteChangeMergeCell);
                            return false;
                        }
                        if (!toSheet._isValidPasteRange(pastedRange.row, pastedRange.col, getRowCount(pastedRange), getColCount(pastedRange))) {
                            self._raiseInvalidOperation(1, msg_sheetViewTheCopyAreaAndPasteAreaAreNotTheSameSize);
                            return false;
                        }
                    }
                    return true;
                },
                _isSingleCellToSpanCell: function (fromRange, pastedRange) {
                    if (fromRange && getRowCount(fromRange) === 1 && getColCount(fromRange) === 1) {
                        var span = this.getSpan(pastedRange.row, pastedRange.col);
                        if (span && span.equals(pastedRange)) {
                            return true;
                        }
                    }
                    return false;
                },
                _isPastedInternal: function (srcSheet, srcRange, destSheet, clipboadText, ignoredRows, ignoredCols, isFromDesigner) {
                    if (srcSheet && srcRange && destSheet) {
                        try {
                            var csvText = getRangeText(srcSheet, srcRange.row, getRowCount(srcRange), srcRange.col, getColCount(srcRange), '\r\n', '\t', '"', false, ignoredRows, ignoredCols, true, browser.safari, true);
                            var isTextEqual = csvText === clipboadText;
                            if (!isTextEqual) {
                                isTextEqual = csvText === clipboadText + '\r\n';
                                if (!isTextEqual && browser.chrome) {
                                    isTextEqual = csvText === clipboadText + '\t\r\n';
                                }
                                if (!isTextEqual && (browser.safari || browser.mozilla || isFromDesigner || !allowCopyPasteExcelStyle(destSheet))) {
                                    isTextEqual = csvText.replace(/\s/g, '') === clipboadText.replace(/\s/g, '');
                                }
                                if (!isTextEqual) {
                                    isTextEqual = csvText.replace(/\s+$/, '') === clipboadText.replace(/\s+$/, '');
                                }
                            }
                            return isTextEqual;
                        } catch (ex) {
                            return false;
                        }
                    }
                    return false;
                },
                _getPastedRange: function (fromSheet, fromRanges, toSheet, toRange, pasteOption, isCutting) {
                    var self = this;
                    var fromRangesLength = fromRanges.length;
                    var pasteSkipInvisibleRange = toSheet._getPasteSkipInvisibleRange();
                    if (fromRangesLength === 1) {
                        var fromRange = fromRanges[0];
                        var fromRow = fromRange.row < 0 ? 0 : fromRange.row;
                        var fromColumn = fromRange.col < 0 ? 0 : fromRange.col;
                        var fromRowCount = fromRange.row < 0 ? getSheetRowCount(fromSheet) : getRowCount(fromRange);
                        var fromColumnCount = fromRange.col < 0 ? getSheetColumnCount(fromSheet) : getColCount(fromRange);
                        var toRow = toRange.row < 0 ? 0 : toRange.row;
                        var toColumn = toRange.col < 0 ? 0 : toRange.col;
                        var toRowCount = toRange.row < 0 ? getSheetRowCount(toSheet) : getRowCount(toRange);
                        var toColumnCount = toRange.col < 0 ? getSheetColumnCount(toSheet) : getColCount(toRange);
                        var invisibleRowCount = void 0, invisibleColumnCount = void 0;
                        if (pasteSkipInvisibleRange) {
                            invisibleRowCount = toSheet._getNextInvisibleCount(toRow, Math_max(toRowCount, fromRowCount), true);
                            invisibleColumnCount = toSheet._getNextInvisibleCount(toColumn, Math_max(toColumnCount, fromColumnCount));
                            toRowCount -= invisibleRowCount;
                            toColumnCount -= invisibleColumnCount;
                            toRowCount = toRowCount < 1 ? 1 : toRowCount;
                            toColumnCount = toColumnCount < 1 ? 1 : toColumnCount;
                        }
                        var isPasteExpand = pasteOption === 2;
                        if (isCutting || (toRowCount === 1 && toColumnCount === 1)) {
                            toRowCount = fromRowCount;
                            toColumnCount = fromColumnCount;
                        } else if (!isPasteExpand) {
                            if (toRowCount % fromRowCount === 0 && toColumnCount === 1) {
                                toColumnCount = fromColumnCount;
                            } else if (toRowCount === 1 && toColumnCount % fromColumnCount === 0) {
                                toRowCount = fromRowCount;
                            } else if (toRowCount % fromRowCount !== 0 || toColumnCount % fromColumnCount !== 0) {
                                toRowCount = fromRowCount;
                                toColumnCount = fromColumnCount;
                            }
                            if (!self._isValidRange(fromRow, fromColumn, fromRowCount, fromColumnCount, getSheetRowCount(fromSheet), getSheetColumnCount(fromSheet))) {
                                return keyword_null;
                            }
                        }
                        var fixedToRange = new common_1.Range(toRow, toColumn, toRowCount, toColumnCount);
                        if (!isCutting && fromSheet.name() === toSheet.name()) {
                            if (fixedToRange.contains(fromRow, fromColumn, fromRowCount, fromColumnCount)) {
                                if ((fromRow - toRow) % fromRowCount !== 0 || (fromColumn - toColumn) % fromColumnCount !== 0) {
                                    return keyword_null;
                                }
                            } else if (fixedToRange.intersect(fromRow, fromColumn, fromRowCount, fromColumnCount) && (toRowCount > fromRowCount || toColumnCount > fromColumnCount)) {
                                return keyword_null;
                            }
                        }
                        if (pasteSkipInvisibleRange) {
                            toRowCount += invisibleRowCount;
                            toColumnCount += invisibleColumnCount;
                        }
                        if (!toSheet._isValidPasteRange(toRow, toColumn, toRowCount, toColumnCount)) {
                            return keyword_null;
                        }
                        if (toRange.row === -1) {
                            toRow = -1;
                            toRowCount = -1;
                        }
                        if (toRange.col === -1) {
                            toColumn = -1;
                            toColumnCount = -1;
                        }
                        return new common_1.Range(toRow, toColumn, toRowCount, toColumnCount);
                    } else if (fromRangesLength > 1) {
                        return self._getPastedRangeForMultiCopy(fromRanges, toRange);
                    }
                    return keyword_null;
                },
                _getPastedRangeForMultiCopy: function (fromRanges, toRange) {
                    var _this = this;
                    var pasteSkipInvisibleRange = _this._getPasteSkipInvisibleRange();
                    if (fromRanges.length > 1) {
                        var firstRange = fromRanges[0];
                        var secondRange = fromRanges[1];
                        var firstRangeRowCount = firstRange.rowCount;
                        var firstRangeColCount = firstRange.colCount;
                        if (firstRange.row === secondRange.row && firstRangeRowCount === secondRange.rowCount) {
                            var colCount_1 = 0;
                            var rowCount = firstRangeRowCount;
                            fromRanges.forEach(function (range) {
                                colCount_1 += range.colCount;
                            });
                            if (pasteSkipInvisibleRange) {
                                rowCount += _this._getNextInvisibleCount(toRange.row, rowCount, true);
                                colCount_1 += _this._getNextInvisibleCount(toRange.col, colCount_1);
                            }
                            return common_1._createRange(toRange.row, toRange.col, rowCount, colCount_1);
                        } else if (firstRange.col === secondRange.col && firstRangeColCount === secondRange.colCount) {
                            var rowCount_1 = 0;
                            var colCount = firstRangeColCount;
                            fromRanges.forEach(function (range) {
                                rowCount_1 += range.rowCount;
                            });
                            if (pasteSkipInvisibleRange) {
                                rowCount_1 += _this._getNextInvisibleCount(toRange.row, rowCount_1, true);
                                colCount += _this._getNextInvisibleCount(toRange.col, colCount);
                            }
                            return common_1._createRange(toRange.row, toRange.col, rowCount_1, colCount);
                        }
                    }
                    return keyword_null;
                },
                _getPastedRangefromText: function (toSheet, toRange, clipboadText, fromAnotherSpread) {
                    var row = toRange.row < 0 ? 0 : toRange.row;
                    var column = toRange.col < 0 ? 0 : toRange.col;
                    var ret = new common_1.Range(row, column, 1, 1);
                    var textArray = parseCsv(clipboadText, '\r\n', '\t', '"', fromAnotherSpread);
                    if (textArray) {
                        var rowCount = textArray.length;
                        var columnCount = getMaxLength(textArray);
                        if (rowCount > 0 && columnCount > 0) {
                            if (toSheet._getPasteSkipInvisibleRange()) {
                                rowCount += toSheet._getNextInvisibleCount(row, rowCount, true);
                                columnCount += toSheet._getNextInvisibleCount(column, columnCount);
                            }
                            ret = new common_1.Range(row, column, rowCount, columnCount);
                        }
                    }
                    return ret;
                },
                _clearClipboard: function () {
                    var ch = this._getClipboardHelper();
                    if (ch) {
                        ch._reset();
                    }
                },
                _clipboardPasteExpand: function (fromSheet, fromRange, toSheet, toRange, isCutting, clipboardText, clipboardHtml, clipboardImage, option, ignoreFilteredOutRow) {
                    var pasteOption = ClipboardPasteRangeUndoAction._convertPasteOption(option);
                    var toRow;
                    var toColumn;
                    var rowCount;
                    var columnCount;
                    var toRowCount = toRange.row < 0 ? getSheetRowCount(toSheet) : getRowCount(toRange);
                    var toColumnCount = toRange.col < 0 ? getSheetColumnCount(toSheet) : getColCount(toRange);
                    rowCount = fromRange.row < 0 ? getSheetRowCount(fromSheet) : getRowCount(fromRange);
                    columnCount = fromRange.col < 0 ? getSheetColumnCount(fromSheet) : getColCount(fromRange);
                    toRow = toRange.row;
                    toColumn = toRange.col;
                    if (toRange.row < 0 && rowCount < getSheetRowCount(toSheet)) {
                        toRow = 0;
                    }
                    if (toRange.col < 0 && columnCount < getSheetColumnCount(toSheet)) {
                        toColumn = 0;
                    }
                    var rowNumber = Math_floor(toRowCount / rowCount);
                    var colNumber = Math_floor(toColumnCount / columnCount);
                    for (var row = 0; row < rowNumber && !!rowNumber && !!colNumber; row++) {
                        for (var col = 0; col < colNumber; col++) {
                            worksheet_static_1.staticMembers.copyTo(fromSheet, fromRange.row, fromRange.col, toSheet, toRow + rowCount * row, toColumn + columnCount * col, rowCount, columnCount, pasteOption, ignoreFilteredOutRow, copyPasteHeaderOptions(fromSheet));
                        }
                    }
                    var newSrcRow;
                    var newSrcColumn;
                    var newDistRow;
                    var newDistColumn;
                    var newRowCount;
                    var newColumnCount;
                    var spanRanges;
                    var newPasteOption = pasteOption & (~(1 << 5));
                    newDistRow = toRow + rowCount * rowNumber;
                    newDistColumn = toColumn;
                    newRowCount = toRowCount - rowCount * rowNumber;
                    newColumnCount = columnCount;
                    spanRanges = _mergeRanges(new common_1.Range(fromRange.row, fromRange.col, newRowCount, newColumnCount), fromSheet.getSpans(fromRange));
                    var _loop_1 = function (col) {
                        spanRanges.forEach(function (range) {
                            toSheet.addSpan(newDistRow + range.row - fromRange.row, newDistColumn + columnCount * col + range.col - fromRange.col, range.rowCount, range.colCount);
                        });
                        worksheet_static_1.staticMembers.copyTo(fromSheet, fromRange.row < 0 ? 0 : fromRange.row, fromRange.col < 0 ? 0 : fromRange.col, toSheet, newDistRow, newDistColumn + columnCount * col, newRowCount, newColumnCount, newPasteOption, ignoreFilteredOutRow, copyPasteHeaderOptions(fromSheet));
                    };
                    for (var col = 0; col < colNumber && !!newRowCount && !!newColumnCount; col++) {
                        _loop_1(col);
                    }
                    newDistRow = toRow;
                    newDistColumn = toColumn + columnCount * colNumber;
                    newRowCount = rowCount;
                    newColumnCount = toColumnCount - columnCount * colNumber;
                    spanRanges = _mergeRanges(new common_1.Range(fromRange.row, fromRange.col, newRowCount, newColumnCount), fromSheet.getSpans(fromRange));
                    var _loop_2 = function (row) {
                        spanRanges.forEach(function (range) {
                            toSheet.addSpan(newDistRow + rowCount * row + range.row - fromRange.row, newDistColumn + range.col - fromRange.col, range.rowCount, range.colCount);
                        });
                        worksheet_static_1.staticMembers.copyTo(fromSheet, fromRange.row < 0 ? 0 : fromRange.row, fromRange.col < 0 ? 0 : fromRange.col, toSheet, newDistRow + rowCount * row, newDistColumn, newRowCount, newColumnCount, newPasteOption, ignoreFilteredOutRow, copyPasteHeaderOptions(fromSheet));
                    };
                    for (var row = 0; row < rowNumber && !!newRowCount && !!newColumnCount; row++) {
                        _loop_2(row);
                    }
                    newDistRow = toRow + rowCount * rowNumber;
                    newDistColumn = toColumn + columnCount * colNumber;
                    newRowCount = toRowCount - rowCount * rowNumber;
                    newColumnCount = toColumnCount - columnCount * colNumber;
                    spanRanges = _mergeRanges(new common_1.Range(fromRange.row, fromRange.col, newRowCount, newColumnCount), fromSheet.getSpans(fromRange));
                    if (!!newRowCount && !!newColumnCount) {
                        spanRanges.forEach(function (range) {
                            toSheet.addSpan(newDistRow + range.row - fromRange.row, newDistColumn + range.col - fromRange.col, range.rowCount, range.colCount);
                        });
                        worksheet_static_1.staticMembers.copyTo(fromSheet, fromRange.row < 0 ? 0 : fromRange.row, fromRange.col < 0 ? 0 : fromRange.col, toSheet, newDistRow, newDistColumn, newRowCount, newColumnCount, newPasteOption, ignoreFilteredOutRow, copyPasteHeaderOptions(fromSheet));
                    }
                },
                _clipboardPaste: function (fromSheet, fromRange, toSheet, toRange, isCutting, clipboardText, clipboardHtml, clipboardImage, option, ignoreFilteredOutRow) {
                    if (fromSheet && toSheet.name() === fromSheet.name() && (toSheet.parent && !fromSheet._parentSheet && !ArrayHelper_contains(toSheet.parent.sheets, fromSheet))) {
                        fromSheet._clearClipboard();
                        return;
                    }
                    var pasteSkipInvisibleRange = toSheet._getPasteSkipInvisibleRange();
                    var toRow;
                    var toColumn;
                    var rowCount;
                    var columnCount;
                    var r;
                    var c;
                    var pasteOption = ClipboardPasteRangeUndoAction._convertPasteOption(option);
                    suspendCalcService(fromSheet);
                    suspendCalcService(toSheet);
                    try {
                        if (fromSheet && fromRange) {
                            if ((pasteOption & 2) !== 0 && (isCutting &&
                                _supportsCalc && (fromSheet._hasPartArrayFormulas(fromRange.row, fromRange.col, getRowCount(fromRange), getColCount(fromRange)) ||
                                    toSheet._hasPartArrayFormulas(toRange.row, toRange.col, getRowCount(toRange), getColCount(toRange))))) {
                                throw getSR().Exp_ChangePartOfArray;
                            }
                            var isPasteExpand = option === 2;
                            if (isCutting) {
                                worksheet_static_1.staticMembers.moveTo(fromSheet, fromRange.row, fromRange.col, toSheet, toRange.row, toRange.col, getRowCount(fromRange), getColCount(fromRange), pasteOption, true);
                                fromSheet._clearClipboard();
                            } else if (isPasteExpand) {
                                this._clipboardPasteExpand(fromSheet, fromRange, toSheet, toRange, isCutting, clipboardText, clipboardHtml, clipboardImage, option, ignoreFilteredOutRow);
                            } else {
                                var toRowCount = toRange.row < 0 ? getSheetRowCount(toSheet) : getRowCount(toRange);
                                var toColumnCount = toRange.col < 0 ? getSheetColumnCount(toSheet) : getColCount(toRange);
                                rowCount = fromRange.row < 0 ? getSheetRowCount(fromSheet) : getRowCount(fromRange);
                                columnCount = fromRange.col < 0 ? getSheetColumnCount(fromSheet) : getColCount(fromRange);
                                if (pasteSkipInvisibleRange) {
                                    toRowCount -= toSheet._getNextInvisibleCount(toRange.row, Math_max(toRowCount, rowCount), true);
                                    toColumnCount -= toSheet._getNextInvisibleCount(toRange.col, Math_max(toColumnCount, columnCount));
                                    toRowCount = toRowCount < 1 ? 1 : toRowCount;
                                    toColumnCount = toColumnCount < 1 ? 1 : toColumnCount;
                                }
                                if (toRowCount > rowCount || toColumnCount > columnCount) {
                                    toRow = toRange.row;
                                    toColumn = toRange.col;
                                    if (toRange.row < 0 && rowCount < getSheetRowCount(toSheet)) {
                                        toRow = 0;
                                    }
                                    if (toRange.col < 0 && columnCount < getSheetColumnCount(toSheet)) {
                                        toColumn = 0;
                                    }
                                    if (toRowCount % rowCount === 0 && toColumnCount === 1) {
                                        toColumnCount = columnCount;
                                    } else if (toRowCount === 1 && toColumnCount % columnCount === 0) {
                                        toRowCount = rowCount;
                                    } else if (toRowCount % rowCount !== 0 || toColumnCount % columnCount !== 0) {
                                        toRowCount = rowCount;
                                        toColumnCount = columnCount;
                                    }
                                    var rn = Math_floor(toRowCount / rowCount);
                                    var cn = Math_floor(toColumnCount / columnCount);
                                    var oldRowCount = rowCount;
                                    var oldColumnCount = columnCount;
                                    var startRowIndex = void 0;
                                    var startColumnIndex = void 0;
                                    var endRowIndex = void 0;
                                    var endColumnIndex = void 0;
                                    for (r = 0; r < rn; r++) {
                                        startRowIndex = isNullOrUndefined(endRowIndex) ? (toRow < 0 ? -1 : toRow + r * rowCount) : endRowIndex;
                                        for (c = 0; c < cn; c++) {
                                            startColumnIndex = isNullOrUndefined(endColumnIndex) ? (toColumn < 0 ? -1 : toColumn + c * columnCount) : endColumnIndex;
                                            rowCount = toRow < 0 ? -1 : oldRowCount;
                                            columnCount = toColumn < 0 ? -1 : oldColumnCount;
                                            if (pasteSkipInvisibleRange) {
                                                rowCount = toRow < 0 ? -1 : (rowCount + toSheet._getNextInvisibleCount(startRowIndex, oldRowCount, true));
                                                columnCount = toColumn < 0 ? -1 : (columnCount + toSheet._getNextInvisibleCount(startColumnIndex, oldColumnCount));
                                            }
                                            worksheet_static_1.staticMembers.copyTo(fromSheet, fromRange.row, fromRange.col, toSheet, startRowIndex, startColumnIndex,
                                                oldRowCount, oldColumnCount, pasteOption, ignoreFilteredOutRow, copyPasteHeaderOptions(fromSheet));
                                            endColumnIndex = startColumnIndex + (columnCount < 0 ? 0 : columnCount);
                                        }
                                        endRowIndex = startRowIndex + (rowCount < 0 ? 0 : rowCount);
                                        endColumnIndex = null;
                                    }
                                } else {
                                    worksheet_static_1.staticMembers.copyTo(fromSheet, fromRange.row, fromRange.col, toSheet, toRange.row, toRange.col, getRowCount(fromRange), getColCount(fromRange), pasteOption, ignoreFilteredOutRow, copyPasteHeaderOptions(fromSheet));
                                }
                            }
                        } else {
                            toRow = toRange.row;
                            toColumn = toRange.col;
                            rowCount = getRowCount(toRange);
                            columnCount = getColCount(toRange);
                            if (clipboardText) {
                                var modelManager = toSheet._modelManager;
                                var removedSpans = modelManager.getSpans(common_1._createRange(toRow, toColumn, rowCount, columnCount));
                                for (var i = removedSpans.length - 1; i >= 0; i--) {
                                    modelManager.do('removeSpan', removedSpans[i]);
                                }
                            }
                            if (_supportsCalc && (pasteOption & 1) > 0) {
                                toSheet.clearFormula(toRow, toColumn, rowCount, columnCount, function (sheet, row) {
                                    return !sheet._isRowFilterOut || !sheet._isRowFilterOut(row);
                                });
                            }
                            var ch = toSheet._getClipboardHelper();
                            var pasteFormatting = option === 0 || option === 2;
                            if ((!clipboardText) || (clipboardText === '')) {
                                if (ch && pasteFormatting && clipboardImage) {
                                    ch._setRangeImage(clipboardImage, toSheet, toRow, toColumn);
                                } else {
                                    for (r = 0; r < rowCount; r++) {
                                        for (c = 0; c < columnCount; c++) {
                                            toSheet.setValue(toRow + r, toColumn + c, keyword_null);
                                        }
                                    }
                                }
                            } else {
                                if (toSheet.parent && toSheet.parent.options.allowAutoCreateHyperlink && rowCount === 1 && columnCount === 1 && (Common_1.Common._RegexHelper._getReg(hyperlinkReg).test(clipboardText) || Common_1.Common._RegexHelper._getReg(emailReg).test(clipboardText)) && toSheet.setHyperlink) {
                                    toSheet.setHyperlink(toRow, toColumn, { url: clipboardText, tooltip: clipboardText });
                                }
                                toSheet.setCsv(toRow, toColumn, clipboardText, '\r\n', '\t', 16, true, clipboardhelper_1._ClipboardHelper._isFromAnotherSpread(clipboardHtml));
                            }
                            if (ch && pasteFormatting && clipboardHtml) {
                                ch._setRangeHtml(clipboardHtml, toSheet, toRow, toColumn);
                            }
                        }
                    } finally {
                        resumeCalcService(fromSheet, false);
                        resumeCalcService(toSheet, false);
                    }
                },
                _doCut: function (ignoreClipboard) {
                    if (!this.isEditing()) {
                        var sels = this.getSelections();
                        if (sels && sels.length === 1) {
                            return this._clipboardCopy(sels, true, ignoreClipboard);
                        }
                    }
                    return keyword_null;
                },
                _isValidMultiCopyRanges: function (ranges, outParam) {
                    if (ranges) {
                        var length_1 = ranges.length;
                        if (length_1 > 1) {
                            var i = void 0;
                            for (i = 0; i < length_1; i++) {
                                var range1 = ranges[i];
                                for (var j = i + 1; j < length_1; j++) {
                                    var range2 = ranges[j];
                                    if (range1.intersect(range2.row, range2.col, range2.rowCount, range2.colCount)) {
                                        return false;
                                    }
                                }
                            }
                            var firstRange = ranges[0];
                            var currentRange = void 0;
                            for (i = 1; i < length_1; i++) {
                                currentRange = ranges[i];
                                if (firstRange.row !== currentRange.row || firstRange.rowCount !== currentRange.rowCount) {
                                    break;
                                }
                            }
                            if (i >= length_1) {
                                if (outParam) {
                                    outParam.inSameRow = true;
                                }
                                return true;
                            }
                            for (i = 1; i < length_1; i++) {
                                currentRange = ranges[i];
                                if (firstRange.col !== currentRange.col || firstRange.colCount !== currentRange.colCount) {
                                    break;
                                }
                            }
                            if (i >= length_1) {
                                if (outParam) {
                                    outParam.inSameCol = true;
                                }
                                return true;
                            }
                        }
                    }
                    return false;
                },
                _getCopyRange: function (ranges) {
                    if (ranges) {
                        var length_2 = ranges.length;
                        if (length_2 === 1) {
                            return ranges[0];
                        } else if (length_2 > 1) {
                            var firstRange = ranges[0];
                            var lastRange = ranges[length_2 - 1];
                            var i = void 0;
                            var currentRange = void 0;
                            if (firstRange.row === lastRange.row && firstRange.rowCount === lastRange.rowCount) {
                                for (i = 0; i < length_2; i++) {
                                    currentRange = ranges[i];
                                    if (currentRange.col < firstRange.col) {
                                        firstRange = currentRange;
                                    }
                                    if (currentRange.col > lastRange.col) {
                                        lastRange = currentRange;
                                    }
                                }
                                return common_1._createRange(firstRange.row, firstRange.col, firstRange.rowCount, lastRange.col + lastRange.colCount - firstRange.col);
                            } else if (firstRange.col === lastRange.col && firstRange.colCount === lastRange.colCount) {
                                for (i = 0; i < length_2; i++) {
                                    currentRange = ranges[i];
                                    if (currentRange.row < firstRange.row) {
                                        firstRange = currentRange;
                                    }
                                    if (currentRange.row > lastRange.row) {
                                        lastRange = currentRange;
                                    }
                                }
                                return common_1._createRange(firstRange.row, firstRange.col, lastRange.row + lastRange.rowCount - firstRange.row, firstRange.colCount);
                            }
                        }
                    }
                    return keyword_null;
                },
                _getIgnoredRowsCols: function (ranges) {
                    var ignoredRows = [];
                    var ignoredColumns = [];
                    if (ranges) {
                        var length_3 = ranges.length;
                        if (length_3 > 1) {
                            var firstRange = ranges[0];
                            var lastRange = ranges[length_3 - 1];
                            var isSameRow = firstRange.row === lastRange.row && firstRange.rowCount === lastRange.rowCount;
                            var isSameCol = firstRange.col === lastRange.col && firstRange.colCount === lastRange.colCount;
                            if (isSameRow || isSameCol) {
                                ranges.sort(isSameRow ? function (r1, r2) {
                                    return r1.col - r2.col;
                                } : function (r1, r2) {
                                    return r1.row - r2.row;
                                });
                                for (var i = 1; i < length_3; i++) {
                                    var range1 = ranges[i - 1];
                                    var range2 = ranges[i];
                                    var startIndex = isSameRow ? range1.col + range1.colCount : range1.row + range1.rowCount;
                                    var endIndex = isSameRow ? range2.col : range2.row;
                                    var ignoredList = isSameRow ? ignoredColumns : ignoredRows;
                                    for (var index = startIndex; index < endIndex; index++) {
                                        ignoredList.push(index);
                                    }
                                }
                            }
                        }
                    }
                    return {
                        rows: ignoredRows,
                        cols: ignoredColumns
                    };
                },
                _doCopy: function (ignoreClipboard) {
                    var self = this;
                    if (!self.isEditing()) {
                        var sels = self.getSelections();
                        if (sels && sels.length === 1) {
                            var clipboardHelper = self._getClipboardHelper();
                            clipboardHelper._showInsertCopyPasteCells = true;
                            var originalRange = sels[0];
                            if (originalRange.row !== -1 && self._hasRowFilterOut && self._hasRowFilterOut()) {
                                var newRanges = [];
                                var lastVisibleRow = -1;
                                for (var r = 0; r < originalRange.rowCount; r++) {
                                    var row = originalRange.row + r;
                                    if (self._isRowFilterOut(row)) {
                                        if (lastVisibleRow !== -1) {
                                            newRanges.push(common_1._createRange(lastVisibleRow, originalRange.col, row - lastVisibleRow, originalRange.colCount));
                                            lastVisibleRow = -1;
                                        }
                                    } else if (lastVisibleRow === -1) {
                                        lastVisibleRow = row;
                                    }
                                }
                                if (lastVisibleRow !== -1) {
                                    newRanges.push(common_1._createRange(lastVisibleRow, originalRange.col, originalRange.row + originalRange.rowCount - lastVisibleRow, originalRange.colCount));
                                }
                                sels = newRanges;
                            }
                            return self._clipboardCopy(sels, false, ignoreClipboard);
                        } else if (self._isValidMultiCopyRanges(sels)) {
                            return self._clipboardCopy(sels, false, ignoreClipboard);
                        } else {
                            self._raiseInvalidOperation(1, getSR().Exp_MultipleSelections);
                        }
                    }
                    return keyword_null;
                },
                _doPaste: function (options) {
                    var sheet = this;
                    var eventHandler = sheet._eventHandler;
                    var pasteText;
                    var pasteHtml;
                    var pasteOption;
                    var shiftCells;
                    var acCell;
                    var isFromDesigner;
                    if (sheet.isEditing()) {
                        return;
                    }
                    if (options) {
                        pasteText = options.pasteText;
                        pasteHtml = options.pasteHtml;
                        pasteOption = options.pasteOption === undefined ? sheet.options.clipBoardOptions : options.pasteOption;
                        shiftCells = options.shiftCells;
                        acCell = sheet.getSelections()[0];
                        isFromDesigner = options.isFromDesigner;
                    }
                    if (eventHandler && !pasteText) {
                        eventHandler._switchFocusForClipboard('');
                    }
                    var clipboardHelper = sheet._getClipboardHelper();
                    if (clipboardHelper) {
                        clipboardHelper._isPasted = false;
                    }
                    setTimeout(function () {
                        if (sheet._disposed) {
                            return;
                        }
                        var clipboardText = pasteText || '';
                        var clipboardHtml = pasteHtml || '';
                        var dataRange;
                        var clipboardImage;
                        if (eventHandler && !pasteText) {
                            if (clipboardHelper) {
                                var clipboardData = clipboardHelper._getClipboardData();
                                var fromSheet = clipboardHelper._fromSheet;
                                clipboardText = clipboardData.text;
                                clipboardHtml = clipboardData.html;
                                clipboardImage = clipboardData.image;
                                dataRange = clipboardHelper._ranges && clipboardHelper._ranges[0];
                                if (fromSheet) {
                                    common_1._util._adjustSheetSelectionRowColumnCount(dataRange, fromSheet.getRowCount(), fromSheet.getColumnCount());
                                }
                            }
                            eventHandler._switchBackFocusAfterClipboard();
                        }
                        if (browser.msie || browser.edge || pasteText || (!clipboardText && !clipboardHtml && !clipboardHelper._isPasted)) {
                            sheet._doClipboardPaste(clipboardText, clipboardHtml, clipboardImage, pasteOption, shiftCells, acCell, dataRange, isFromDesigner);
                        }
                        sheet._eventHandler._changeFocusHolder();
                        sheet._trigger(common_1.Events.PasteEnd);
                    }, 100);
                },
                _doClipboardPaste: function (clipboardText, clipboardHtml, clipboardImage, pasteOption, shiftCells, acCell, dataRange, isFromDesigner) {
                    var sheet = this;
                    var clipboardHelper = sheet._getClipboardHelper();
                    if (clipboardHelper) {
                        clipboardHelper._isPasted = true;
                    }
                    var pasteInfo = sheet._getPasteInfo(clipboardText, pasteOption, shiftCells, clipboardHtml, isFromDesigner);
                    if (!pasteInfo) {
                        if (!clipboardImage) {
                            return;
                        }
                        pasteInfo = {
                            pasteOption: pasteOption === undefined ? sheet.options.clipBoardOptions : pasteOption,
                            pastedRanges: [common_1._createRange(sheet.getActiveRowIndex(), sheet.getActiveColumnIndex(), 1, 1)],
                            clipboardText: ''
                        };
                    }
                    if (sheet.options.clipBoardOptions) {
                        pasteInfo.pasteOption = sheet.options.clipBoardOptions;
                    };
                    if (shiftCells !== keyword_undefined) {
                        pasteInfo._shiftCells = shiftCells;
                    }
                    if (acCell) {
                        pasteInfo._acCell = acCell;
                    }
                    if (dataRange) {
                        pasteInfo._dataRange = dataRange;
                    }
                    pasteInfo.cmd = 'clipboardPaste';
                    pasteInfo.sheetName = sheet.name();
                    if (allowCopyPasteExcelStyle(sheet)) {
                        pasteInfo.clipboardHtml = clipboardHtml;
                        pasteInfo.clipboardImage = clipboardImage;
                    }
                    sheet._commandManager().execute(pasteInfo);
                },
                _getPasteInfo: function (clipboardText, pasteOption, shiftCells, clipboardHtml, isFromDesigner) {
                    var sheet = this;
                    var msg_spreadActionPasteSizeDifferent = getSR().Exp_InvalidPastedArea;
                    var ch = sheet._getClipboardHelper();
                    var fromSheet = ch._fromSheet;
                    var fromRanges = ch._ranges;
                    var isCutting = ch._isCutting;
                    if (
                        isCutting
                        && fromSheet
                        && fromRanges
                        && fromSheet.options.isProtected
                        && fromSheet._isAnyCellInRangesLocked(fromRanges)
                    ) {
                        isCutting = false;
                    }
                    var outPara = {
                        pastedRange: keyword_null,
                        pastedInternal: false
                    };
                    var pastedRanges = [];
                    var selections = sheet.getSelections();
                    var toRange;
                    if (selections.length > 1) {
                        var isPasteExpand = pasteOption === 2;
                        for (var i = 0; i < selections.length; i++) {
                            toRange = selections[i];
                            if (!sheet._checkPastedRange(fromSheet, fromRanges, toRange, pasteOption, isCutting, clipboardText, outPara, keyword_undefined, clipboardHtml, isFromDesigner)) {
                                return;
                            }
                            if (toRange.containsRange(outPara.pastedRange) && !toRange.equals(outPara.pastedRange) && !isPasteExpand) {
                                sheet._raiseInvalidOperation(1, msg_spreadActionPasteSizeDifferent);
                                return;
                            }
                            pastedRanges.push(outPara.pastedRange);
                        }
                    } else {
                        if (selections.length > 0) {
                            toRange = selections[0];
                        } else {
                            toRange = sheet._modelManager.getSpan(sheet._activeRowIndex, sheet._activeColIndex);
                        }
                        if (!sheet._checkPastedRange(fromSheet, fromRanges, toRange, pasteOption, isCutting, clipboardText, outPara, shiftCells, clipboardHtml, isFromDesigner)) {
                            return;
                        }
                        pastedRanges.push(outPara.pastedRange);
                    }
                    var cutCopyIndicator = sheet._cutCopyIndicatorManager;
                    if (cutCopyIndicator) {
                        cutCopyIndicator._isPastedInternal(outPara.pastedInternal);
                    }
                    if (!outPara.pastedInternal) {
                        fromSheet = keyword_null;
                        fromRanges = keyword_null;
                        isCutting = false;
                    }
                    var _pasteOption = pasteOption === undefined ? sheet.options.clipBoardOptions : pasteOption;
                    if (isCutting) {
                        _pasteOption = 0;
                    }
                    if (fromRanges && fromRanges.length === 1) {
                        for (var index = 0; index < pastedRanges.length; index++) {
                            var range = pastedRanges[index];
                            if (sheet._isSingleCellToSpanCell(fromRanges[0], range)) {
                                range.rowCount = 1;
                                range.colCount = 1;
                            }
                        }
                    }
                    if ((!fromRanges || fromRanges.length > 1) && pastedRanges.length > 1) {
                        sheet._raiseInvalidOperation(1, getSR().Exp_MultipleSelections);
                        return;
                    }
                    return {
                        fromSheet: fromSheet,
                        fromRanges: fromRanges,
                        isCutting: isCutting,
                        pasteOption: _pasteOption,
                        pastedRanges: pastedRanges,
                        clipboardText: clipboardText
                    };
                },
                _isValidPasteRange: function (row, column, rowCount, colCount, ignoreMax) {
                    var self = this;
                    var maxRowCount = getSheetRowCount(self);
                    var maxColumnCount = getSheetColumnCount(self);
                    if (allowExtendPasteRange(self)) {
                        return -1 <= row && (ignoreMax || row < maxRowCount) && -1 <= column && (ignoreMax || column < maxColumnCount);
                    }
                    return self._isValidRange(row, column, rowCount, colCount, maxRowCount, maxColumnCount);
                },
                _isAnyCellInRangesLocked: function (ranges) {
                    for (var i = 0; i < ranges.length; i++) {
                        if (this._isAnyCellInRangeLocked(ranges[i])) {
                            return true;
                        }
                    }
                    return false;
                },
                _moveActiveCell: function (dir, wrap, beginRow, beginCol) {
                    var self = this;
                    if (self.endEdit && !self.endEdit()) {
                        return;
                    }
                    var args = {
                        sheet: self,
                        sheetName: self.name(),
                        row: self._activeRowIndex,
                        col: self._activeColIndex,
                        cancel: false
                    };
                    self._trigger(common_1.Events.LeaveCell, args);
                    if (args.cancel === true) {
                        return;
                    }
                    var prevRowIndex = self._activeRowIndex;
                    var prevcolIndex = self._activeColIndex;
                    if (isNullOrUndefined(beginRow)) {
                        beginRow = self._activeRowIndex;
                    }
                    if (isNullOrUndefined(beginCol)) {
                        beginCol = self._activeColIndex;
                    }
                    if (dir === 3) {
                        self._moveActiveCellLeft(beginRow, beginCol, wrap);
                    } else if (dir === 4) {
                        self._moveActiveCellRight(beginRow, beginCol, wrap);
                    } else if (dir === 1) {
                        self._moveActiveCellUp(beginRow, beginCol, wrap);
                    } else if (dir === 2) {
                        self._moveActiveCellDown(beginRow, beginCol, wrap);
                    } else if (dir === 5) {
                        self._moveActiveCellFirst();
                    } else if (dir === 6) {
                        self._moveActiveCellLast();
                    }
                    self._moveActiveCellEnd(dir, prevRowIndex, prevcolIndex);
                },
                _moveActiveCellInSelection: function (dir) {
                    var self = this;
                    if (!self.endEdit()) {
                        return;
                    }
                    var args = {
                        sheet: self,
                        sheetName: self.name(),
                        row: self._activeRowIndex,
                        col: self._activeColIndex,
                        cancel: false
                    };
                    self._trigger(common_1.Events.LeaveCell, args);
                    if (args.cancel === true) {
                        return;
                    }
                    var prevRowIndex = self._activeRowIndex;
                    var prevcolIndex = self._activeColIndex;
                    if (dir === 3) {
                        self._moveActiveCellLeftInSelection(self._activeRowIndex, self._activeColIndex);
                    } else if (dir === 4) {
                        self._moveActiveCellRightInSelection(self._activeRowIndex, self._activeColIndex);
                    }
                    self._moveActiveCellEnd(dir, prevRowIndex, prevcolIndex);
                },
                _moveActiveCellEnd: function (dir, prevRowIndex, prevcolIndex) {
                    var self = this;
                    var handler = self._eventHandler;
                    var oldSelections = self._modelManager.getSelections();
                    var needRepaint = false;
                    if (!self._isNavigateInSelection) {
                        var activeSelectedRange = self._getActualRange(self._getActiveSelectedRange());
                        if (oldSelections.length > 1 || getRowCount(activeSelectedRange) > 1 || getColCount(activeSelectedRange) > 1) {
                            needRepaint = true;
                        }
                        if (!needRepaint && self._autoMergeManager && self._autoMergeManager._inAutoMergeArea(activeSelectedRange)) {
                            needRepaint = true;
                        }
                        self._clearSelectionImp();
                    }
                    var activeRowIndex = self._activeRowIndex;
                    var activeColIndex = self._activeColIndex;
                    var span = self._modelManager.getSpan(activeRowIndex, activeColIndex);
                    self._activeRowCount = getRowCount(span);
                    self._activeColCount = getColCount(span);
                    if (!self._isNavigateInSelection) {
                        var activeRange = self._getExtendedRange(activeRowIndex, activeColIndex);
                        var selectionPolicy = self.selectionPolicy();
                        var selectionUnit = self.selectionUnit();
                        if (selectionPolicy === 0) {
                            self._modelManager.do('clearSelection');
                        } else if (selectionPolicy === 1) {
                            self._modelManager.do('clearSelection');
                        }
                        if (selectionUnit === 1) {
                            activeRange.col = -1;
                            activeRange.colCount = -1;
                        } else if (selectionUnit === 2) {
                            activeRange.row = -1;
                            activeRange.rowCount = -1;
                        }
                        self._replaceActiveSelectedRange(activeRange.row, activeRange.col, getRowCount(activeRange), getColCount(activeRange), false);
                        var newSelections = self._modelManager.getSelections();
                        if (handler._notEqualSelecions(oldSelections, newSelections)) {
                            self._raiseSelectionChanging(oldSelections, newSelections);
                            self._raiseSelectionChanged(oldSelections);
                        }
                    }
                    self._scrollByMoveCell(activeRowIndex, activeColIndex);
                    if (prevRowIndex !== activeRowIndex) {
                        var bm = self._bindingManager;
                        if (bm) {
                            bm._doDataItemChanged();
                        }
                    }
                    var render = self._render;
                    if (needRepaint) {
                        var layout = self._getSheetLayout();
                        var x = layout._headerX;
                        var y = layout._headerY;
                        var width = layout.width - x;
                        var height = layout.height - y;
                        render._copyDoubleBuffer(x, y, width, height);
                        render.repaint(new common_1.Rect(x, y, width, layout._colHeaderHeight));
                        render.repaint(new common_1.Rect(x, y, layout._rowHeaderWidth, height));

                        render._paintAdornment(render._getCtx());
                    } else {
                        var prevSpan = self._modelManager.getSpan(prevRowIndex, prevcolIndex);
                        var rs = getRowCount(prevSpan);
                        var cs = getColCount(prevSpan);
                        render._repaintSelection(new common_1.Range(activeRowIndex, activeColIndex, self._activeRowCount, self._activeColCount).union(new common_1.Range(prevRowIndex, prevcolIndex, rs, cs)));
                    }
                    var enterCellArgs = {
                        sheet: self,
                        sheetName: self.name(),
                        row: activeRowIndex,
                        col: activeColIndex
                    };
                    self._trigger(common_1.Events.EnterCell, enterCellArgs);
                    self._trigger(common_1.Events.FormulatextboxEnterCell, enterCellArgs);
                    handler._updateValidationUI && handler._updateValidationUI(activeRowIndex, activeColIndex);
                },
                _validationError: function (row, column) {
                    var self = this;
                    var dv = self.getDataValidator && self.getDataValidator(row, column);
                    var args = {
                        sheet: self,
                        sheetName: self.name(),
                        row: row,
                        col: column,
                        validator: dv,
                        validationResult: 0
                    };
                    self._trigger(common_1.Events.ValidationError, args);
                    return args.validationResult;
                }
            });
            function _mergeRanges(targetRange, sourceRange) {
                var result = [];
                sourceRange.forEach(function (range) {
                    var mergedRange = _mergeRange(targetRange, range);
                    if (mergedRange) {
                        result.push(mergedRange);
                    }
                });
                return result;
            }
            function _mergeRange(targetRange, sourceRange) {
                var rangeATopLeftCornerX = targetRange.row;
                var rangeATopLeftCornerY = targetRange.col;
                var rangeAButtomRightCornerX = targetRange.row + targetRange.rowCount;
                var rangeAButtomRightCornerY = targetRange.col + targetRange.colCount;
                var rangeBTopLeftCornerX = sourceRange.row;
                var rangeBTopLeftCornerY = sourceRange.col;
                var rangeBButtomRightCornerX = sourceRange.row + sourceRange.rowCount;
                var rangeBButtomRightCornerY = sourceRange.col + sourceRange.colCount;
                var flag = Math_max(rangeATopLeftCornerX, rangeBTopLeftCornerX) <= Math_min(rangeAButtomRightCornerX, rangeBButtomRightCornerX) &&
                    Math_max(rangeATopLeftCornerY, rangeBTopLeftCornerY) <= Math_min(rangeAButtomRightCornerY, rangeBButtomRightCornerY);
                if (!flag) {
                    return false;
                }
                var row = Math_max(rangeATopLeftCornerX, rangeBTopLeftCornerX);
                var col = Math_max(rangeATopLeftCornerY, rangeBTopLeftCornerY);
                var rowCount = Math_min(rangeAButtomRightCornerX, rangeBButtomRightCornerX) - row;
                var colCount = Math_min(rangeAButtomRightCornerY, rangeBButtomRightCornerY) - col;
                return new common_1.Range(row, col, rowCount, colCount);
            }
            function getWorksheet(context, options) {
                if (context.sheets) {
                    var sheet = common_1._getSheetFromName(context, options.sheetName);
                    if (sheet) {
                        return sheet;
                    }
                }
                return context;
            }
            function executeCommand(context, commandAction, options, isUndo) {
                var sheet = getWorksheet(context, options);
                var cmd = new commandAction(sheet, options, isUndo);
                return isUndo ? cmd.undo(sheet) : cmd.execute(sheet);
            }
            var Commands = {};
            exports.Commands = Commands;
            Commands._navigateNoWrap = function (sheet, direction) {
                if (sheet) {
                    if (sheet._editorStatus === 2) {
                        return false;
                    }
                    sheet._moveActiveCell(direction, false);
                    return true;
                }
                return false;
            };
            Commands._navigateNoWrapFrom = function (sheet, direction, row, col) {
                if (sheet) {
                    if (sheet._editorStatus === 2) {
                        return false;
                    }
                    sheet._moveActiveCell(direction, false, row, col);
                    return true;
                }
                return false;
            };
            Commands._alterSelection = function (sheet, key, isCtrl) {
                if (sheet) {
                    if (sheet._editorStatus === 2) {
                        return false;
                    }
                    if (sheet.endEdit && !sheet.endEdit()) {
                        return false;
                    }
                    sheet._changeActiveSelectedRange(key, isCtrl);
                    return true;
                }
                return false;
            };
            function defNavigation(direction) {
                var dir = direction;
                return function (context, options) {
                    var sheet = getWorksheet(context, options);
                    return Commands._navigateNoWrap(sheet, dir);
                };
            }
            function defSelectionAction(direction, isCtrl) {
                var dir = direction;
                var ctrl = isCtrl;
                return function (context, options) {
                    var sheet = getWorksheet(context, options);
                    return Commands._alterSelection(sheet, dir, ctrl);
                };
            }
            function moveToNextSheet(sheet, next) {
                var workbook = sheet.parent;
                if (workbook) {
                    var count = workbook.getSheetCount();
                    var old = void 0;
                    var index = void 0;
                    old = index = workbook.getActiveSheetIndex();
                    if (next) {
                        if (index < count - 1) {
                            index++;
                        }
                    } else if (index > 0) {
                        index--;
                    }
                    if (old !== index) {
                        var oldActiveSheet = workbook.getActiveSheet();
                        workbook._setActiveSheetIndexImp(index, 1);
                        workbook._processSelectedState(oldActiveSheet);
                        workbook.repaint();
                    }
                }
            }
            function tabNavigation(sheet, direction) {
                sheet._isTabNavigation = true;
                if (sheet._isNavigateInSelection) {
                    sheet._moveActiveCellInSelection(direction);
                } else {
                    sheet._moveActiveCell(direction, true);
                }
                sheet._isTabNavigation = false;
            }
            function nextControl(sheet, callback) {
                if (!sheet.endEdit()) {
                    return false;
                }
                var eventHandler = sheet._eventHandler;
                eventHandler._clearRepeatKeyDownTimeout();
                eventHandler._resetMetaKeyState();
                common_1._FocusHelper._setActiveElement(keyword_null);
                var needCancelDefault = false;
                var sheetParent = sheet.parent;
                if (sheetParent) {
                    var t = callback.call(sheetParent);
                    if (t && t.focus) {
                        t.focus();
                        needCancelDefault = true;
                    } else {
                        sheetParent._focusTabFocusElement();
                    }
                }
                return {
                    ignoreCancelDefault: !needCancelDefault
                };
            }
            var NAVIGATION_LEFT = 'navigationLeft';
            var NAVIGATION_RIGHT = 'navigationRight';
            var NAVIGATION_UP = 'navigationUp';
            var NAVIGATION_DOWN = 'navigationDown';
            var NAVIGATION_HOME_2 = 'navigationHome2';
            var NAVIGATION_END_2 = 'navigationEnd2';
            var NAVIGATION_TOP = 'navigationTop';
            var NAVIGATION_BOTTOM = 'navigationBottom';
            var NAVIGATION_HOME = 'navigationHome';
            var NAVIGATION_FIRST = 'navigationFirst';
            var NAVIGATION_END = 'navigationEnd';
            var NAVIGATION_LAST = 'navigationLast';
            var MOVE_TO_NEXT_CELL = 'moveToNextCell';
            var MOVE_TO_PREVIOUS_CELL = 'moveToPreviousCell';
            var NAVIGATION_PAGE_UP = 'navigationPageUp';
            var NAVIGATION_PAGE_DOWN = 'navigationPageDown';
            var NAVIGATION_PREVIOUS_SHEET = 'navigationPreviousSheet';
            var NAVIGATION_NEXT_SHEET = 'navigationNextSheet';
            var CLEAR = 'clear';
            var CLEAR_AND_EDITING = 'clearAndEditing';
            var COMMIT_INPUT_NAVIGATION_DOWN = 'commitInputNavigationDown';
            var COMMIT_INPUT_NAVIGATION_UP = 'commitInputNavigationUp';
            var CANCEL_INPUT = 'cancelInput';
            var COMMIT_ARRAY_FORMULA = 'commitArrayFormula';
            var SELECTION_LEFT = 'selectionLeft';
            var SELECTION_RIGHT = 'selectionRight';
            var SELECTION_UP = 'selectionUp';
            var SELECTION_DOWN = 'selectionDown';
            var SELECTION_HOME = 'selectionHome';
            var SELECTION_END = 'selectionEnd';
            var SELECTION_PAGEUP = 'selectionPageUp';
            var SELECTION_PAGEDOWN = 'selectionPageDown';
            var SELECTION_TOP = 'selectionTop';
            var SELECTION_BOTTOM = 'selectionBottom';
            var SELECTION_FIRST = 'selectionFirst';
            var SELECTION_LAST = 'selectionLast';
            var COPY = 'copy';
            var CUT = 'cut';
            var PASTE = 'paste';
            var UNDO = 'undo';
            var REDO = 'redo';
            var RESIZE_COLUMN = 'resizeColumn';
            var RESIZE_ROW = 'resizeRow';
            var SPLIT_RESIZE_ROW = 'splitResizeRow';
            var SPLIT_RESIZE_COLUMN = 'splitResizeColumn';
            var AUTO_FIT_COLUMN = 'autoFitColumn';
            var AUTO_FIT_ROW = 'autoFitRow';
            var EDIT_CELL = 'editCell';
            var RENAME_SHEET = 'renameSheet';
            var ZOOM = 'zoom';
            var CLEAR_VALUES = 'clearValues';
            var CLIPBOARD_PASTE = 'clipboardPaste';
            var SELECT_NEXT_CONTROL = 'selectNextControl';
            var SELECT_PREVIOUS_CONTROL = 'selectPreviousControl';
            var MOVE_TO_NEXT_CELL_THEN_CONTROL = 'moveToNextCellThenControl';
            var MOVE_TO_PREVIOUS_CELL_THEN_CONTROL = 'moveToPreviousCellThenControl';
            var CHANGE_FORMULA_REFERENCE = 'changeFormulaReference';
            var MOVE_SHEET = 'moveSheet';
            var COPY_SHEET = 'copySheet';
            Commands._getWorksheet = getWorksheet;
            Commands._executeCommand = executeCommand;
            // 初始化工作簿命令
            Commands._initWorkbookCommands = function (commandManager) {
                var isMac = common_1._util._isMacOS();
                var ctrl = !isMac;
                var meta = isMac;
                commandManager.register(NAVIGATION_LEFT, Commands[NAVIGATION_LEFT], 37, false, false, false, false);
                commandManager.register(NAVIGATION_RIGHT, Commands[NAVIGATION_RIGHT], 39, false, false, false, false);
                commandManager.register(NAVIGATION_UP, Commands[NAVIGATION_UP], 38, false, false, false, false);
                commandManager.register(NAVIGATION_DOWN, Commands[NAVIGATION_DOWN], 40, false, false, false, false);
                commandManager.register(NAVIGATION_HOME_2, Commands[NAVIGATION_HOME_2], 37, ctrl, false, false, meta);
                commandManager.register(NAVIGATION_END_2, Commands[NAVIGATION_END_2], 39, ctrl, false, false, meta);
                commandManager.register(NAVIGATION_TOP, Commands[NAVIGATION_TOP], 38, ctrl, false, false, meta);
                commandManager.register(NAVIGATION_BOTTOM, Commands[NAVIGATION_BOTTOM], 40, ctrl, false, false, meta);
                commandManager.register(NAVIGATION_HOME, Commands[NAVIGATION_HOME], 36, false, false, false, false);
                commandManager.register(NAVIGATION_FIRST, Commands[NAVIGATION_FIRST], 36, true, false, false, false);
                commandManager.register(NAVIGATION_END, Commands[NAVIGATION_END], 35, false, false, false, false);
                commandManager.register(NAVIGATION_LAST, Commands[NAVIGATION_LAST], 35, true, false, false, false);
                commandManager.register(MOVE_TO_NEXT_CELL, Commands[MOVE_TO_NEXT_CELL], 9, false, false, false, false);
                commandManager.register(MOVE_TO_PREVIOUS_CELL, Commands[MOVE_TO_PREVIOUS_CELL], 9, false, true, false, false);
                commandManager.register(NAVIGATION_PAGE_UP, Commands[NAVIGATION_PAGE_UP], 33, false, false, false, false);
                commandManager.register(NAVIGATION_PAGE_DOWN, Commands[NAVIGATION_PAGE_DOWN], 34, false, false, false, false);
                commandManager.register(NAVIGATION_PREVIOUS_SHEET, Commands[NAVIGATION_PREVIOUS_SHEET], 33, ctrl, false, false, meta);
                commandManager.register(NAVIGATION_NEXT_SHEET, Commands[NAVIGATION_NEXT_SHEET], 34, ctrl, false, false, meta);
                commandManager.register(CLEAR, Commands[CLEAR], 46, false, false, false, false);
                commandManager.register(CLEAR_AND_EDITING, Commands[CLEAR_AND_EDITING], 8, false, false, false, false);
                commandManager.register(COMMIT_INPUT_NAVIGATION_DOWN, Commands[COMMIT_INPUT_NAVIGATION_DOWN], 13, false, false, false, false);
                commandManager.register(COMMIT_INPUT_NAVIGATION_UP, Commands[COMMIT_INPUT_NAVIGATION_UP], 13, false, true, false, false);
                commandManager.register(CANCEL_INPUT, Commands[CANCEL_INPUT], 27, false, false, false, false);
                commandManager.register(COMMIT_ARRAY_FORMULA, Commands[COMMIT_ARRAY_FORMULA], 13, true, true, false, false);
                commandManager.register(SELECTION_LEFT, Commands[SELECTION_LEFT], 37, false, true, false, false);
                commandManager.register(SELECTION_RIGHT, Commands[SELECTION_RIGHT], 39, false, true, false, false);
                commandManager.register(SELECTION_UP, Commands[SELECTION_UP], 38, false, true, false, false);
                commandManager.register(SELECTION_DOWN, Commands[SELECTION_DOWN], 40, false, true, false, false);
                commandManager.register(SELECTION_HOME, Commands[SELECTION_HOME], 36, false, true, false, false);
                commandManager.register(SELECTION_END, Commands[SELECTION_END], 35, false, true, false, false);
                commandManager.register(SELECTION_PAGEUP, Commands[SELECTION_PAGEUP], 33, false, true, false, false);
                commandManager.register(SELECTION_PAGEDOWN, Commands[SELECTION_PAGEDOWN], 34, false, true, false, false);
                commandManager.register(SELECTION_HOME, Commands[SELECTION_HOME], 37, ctrl, true, false, meta);
                commandManager.register(SELECTION_END, Commands[SELECTION_END], 39, ctrl, true, false, meta);
                commandManager.register(SELECTION_TOP, Commands[SELECTION_TOP], 38, ctrl, true, false, meta);
                commandManager.register(SELECTION_BOTTOM, Commands[SELECTION_BOTTOM], 40, ctrl, true, false, meta);
                commandManager.register(SELECTION_FIRST, Commands[SELECTION_FIRST], 36, true, true, false, false);
                commandManager.register(SELECTION_LAST, Commands[SELECTION_LAST], 35, true, true, false, false);
                commandManager.register(COPY, Commands[COPY], 67, ctrl, false, false, meta);
                commandManager.register(CUT, Commands[CUT], 88, ctrl, false, false, meta);
                commandManager.register(PASTE, Commands[PASTE], 86, ctrl, false, false, meta);
                commandManager.register(UNDO, Commands[UNDO], 90, ctrl, false, false, meta);
                commandManager.register(REDO, Commands[REDO], 89, ctrl, false, false, meta);
                if (isMac) {
                    commandManager.register(REDO, Commands[REDO], 90, ctrl, true, false, meta);
                }
                commandManager.register(SELECT_NEXT_CONTROL, Commands[SELECT_NEXT_CONTROL]);
                commandManager.register(SELECT_PREVIOUS_CONTROL, Commands[SELECT_PREVIOUS_CONTROL]);
                commandManager.register(MOVE_TO_NEXT_CELL_THEN_CONTROL, Commands[MOVE_TO_NEXT_CELL_THEN_CONTROL]);
                commandManager.register(MOVE_TO_PREVIOUS_CELL_THEN_CONTROL, Commands[MOVE_TO_PREVIOUS_CELL_THEN_CONTROL]);
                commandManager.register(CHANGE_FORMULA_REFERENCE, Commands[CHANGE_FORMULA_REFERENCE]);
                commandManager.register(RESIZE_COLUMN, Commands[RESIZE_COLUMN]);
                commandManager.register(RESIZE_ROW, Commands[RESIZE_ROW]);
                commandManager.register(SPLIT_RESIZE_COLUMN, Commands[SPLIT_RESIZE_COLUMN]);
                commandManager.register(SPLIT_RESIZE_ROW, Commands[SPLIT_RESIZE_ROW]);
                commandManager.register(AUTO_FIT_COLUMN, Commands[AUTO_FIT_COLUMN]);
                commandManager.register(AUTO_FIT_ROW, Commands[AUTO_FIT_ROW]);
                commandManager.register(EDIT_CELL, Commands[EDIT_CELL]);
                commandManager.register(RENAME_SHEET, Commands[RENAME_SHEET]);
                commandManager.register(ZOOM, Commands[ZOOM]);
                commandManager.register(CLEAR_VALUES, Commands[CLEAR_VALUES]);
                commandManager.register(CLIPBOARD_PASTE, Commands[CLIPBOARD_PASTE]);
                commandManager.register(MOVE_SHEET, Commands[MOVE_SHEET]);
                commandManager.register(COPY_SHEET, Commands[COPY_SHEET]);
            };
            var copyToOptionDict = {
                256: 'bindingPath',
                4: 'comment',
                2: 'formula',
                16: 'sparkline',
                64: 'style',
                128: 'tag',
                1024: 'hyperlink',
                1: 'value'
            };
            var CELL_EDIT_ACTION_EVENT_NS = '.cellEditAction';
            Commands[NAVIGATION_LEFT] = {
                canUndo: false,
                execute: defNavigation(3)
            };
            Commands[NAVIGATION_RIGHT] = {
                canUndo: false,
                execute: defNavigation(4)
            };
            Commands[NAVIGATION_UP] = {
                canUndo: false,
                execute: defNavigation(1)
            };
            Commands[NAVIGATION_DOWN] = {
                canUndo: false,
                execute: defNavigation(2)
            };
            Commands[COMMIT_ARRAY_FORMULA] = {
                canUndo: false,
                execute: function (context, options) {
                    var sheet = getWorksheet(context, options);
                    var formulatextboxCommands = Commands._FormulatextboxCommands;
                    if (formulatextboxCommands) {
                        sheet = formulatextboxCommands._commitArrayFormula(sheet);
                    }
                    sheet._commitArrayFormula && sheet._commitArrayFormula();
                    return true;
                }
            };
            Commands[COMMIT_INPUT_NAVIGATION_DOWN] = {
                canUndo: false,
                execute: function (context, options) {
                    var sheet = getWorksheet(context, options);
                    var formulatextboxCommands = Commands._FormulatextboxCommands;
                    if (formulatextboxCommands) {
                        sheet = formulatextboxCommands._commitInputNavigationDown(sheet);
                    }
                    sheet._moveActiveCell(2, false);
                    return true;
                }
            };
            Commands[COMMIT_INPUT_NAVIGATION_UP] = {
                canUndo: false,
                execute: function (context, options) {
                    var sheet = getWorksheet(context, options);
                    var formulatextboxCommands = Commands._FormulatextboxCommands;
                    if (formulatextboxCommands) {
                        sheet = formulatextboxCommands._commitInputNavigationUp(sheet);
                    }
                    sheet._moveActiveCell(1, false);
                    return true;
                }
            };
            Commands[NAVIGATION_HOME] = {
                canUndo: false,
                execute: function (context, options) {
                    var sheet = getWorksheet(context, options);
                    return Commands._navigateNoWrapFrom(sheet, 4, keyword_null, sheet.frozenColumnCount() - 1);
                }
            };
            Commands[NAVIGATION_HOME_2] = {
                canUndo: false,
                execute: function (context, options) {
                    var sheet = getWorksheet(context, options);
                    return Commands._navigateNoWrapFrom(sheet, 4, keyword_null, -1);
                }
            };
            Commands[NAVIGATION_END] = {
                canUndo: false,
                execute: function (context, options) {
                    var sheet = getWorksheet(context, options);
                    return Commands._navigateNoWrapFrom(sheet, 3, keyword_null, getSheetColumnCount(sheet) - sheet.frozenTrailingColumnCount());
                }
            };
            Commands[NAVIGATION_END_2] = {
                canUndo: false,
                execute: function (context, options) {
                    var sheet = getWorksheet(context, options);
                    return Commands._navigateNoWrapFrom(sheet, 3, keyword_null, getSheetColumnCount(sheet));
                }
            };
            Commands[NAVIGATION_TOP] = {
                canUndo: false,
                execute: function (context, options) {
                    var sheet = getWorksheet(context, options);
                    return Commands._navigateNoWrapFrom(sheet, 2, -1, keyword_null);
                }
            };
            Commands[NAVIGATION_BOTTOM] = {
                canUndo: false,
                execute: function (context, options) {
                    var sheet = getWorksheet(context, options);
                    return Commands._navigateNoWrapFrom(sheet, 1, getSheetRowCount(sheet), keyword_null);
                }
            };
            Commands[NAVIGATION_PAGE_UP] = {
                canUndo: false,
                execute: function (context, options) {
                    var sheet = getWorksheet(context, options);
                    if (!sheet || sheet._editorStatus === 2) {
                        return false;
                    }
                    var prevPageTopRow = sheet._getPrevPageTopRow();
                    if (prevPageTopRow === keyword_null || prevPageTopRow === sheet._scrollTopRow) {
                        return true;
                    }
                    var rls = sheet._getRowLayout(1, 3);
                    var newActiveRow = sheet._getNextVisualRow(sheet._activeRowIndex - rls.length);
                    if (newActiveRow < prevPageTopRow) {
                        newActiveRow = prevPageTopRow;
                    }
                    var formulatextboxCommands = Commands._FormulatextboxCommands;
                    if (formulatextboxCommands) {
                        var returnObj = formulatextboxCommands._navigationPageUp(sheet, newActiveRow, prevPageTopRow);
                        if (returnObj.r) {
                            return true;
                        }
                        sheet = returnObj.sheet;
                    }
                    if (!sheet.endEdit()) {
                        return false;
                    }
                    if (sheet._canSelect(newActiveRow, sheet.getActiveColumnIndex())) {
                        sheet._setActiveCellCore(newActiveRow, keyword_null);
                        sheet._leadingCellRow = newActiveRow;
                        sheet._moveActiveCell();
                    }
                    sheet._setTopRow(prevPageTopRow, 0);
                    return true;
                }
            };
            Commands[NAVIGATION_PAGE_DOWN] = {
                canUndo: false,
                execute: function (context, options) {
                    var sheet = getWorksheet(context, options);
                    if (!sheet || sheet._editorStatus === 2) {
                        return false;
                    }
                    var nextPageTopRow = sheet._getNextPageTopRow();
                    if (nextPageTopRow === keyword_null || nextPageTopRow === sheet._scrollTopRow) {
                        return true;
                    }
                    var rls = sheet._getRowLayout(1, 3);
                    var newActiveRow = sheet._getPrevVisualRow(sheet._activeRowIndex + rls.length);
                    if (newActiveRow < nextPageTopRow) {
                        newActiveRow = nextPageTopRow;
                    }
                    var formulatextboxCommands = Commands._FormulatextboxCommands;
                    if (formulatextboxCommands) {
                        var returnObj = formulatextboxCommands._navigationPageDown(sheet, newActiveRow, nextPageTopRow);
                        if (returnObj.r) {
                            return true;
                        }
                        sheet = returnObj.sheet;
                    }
                    if (!sheet.endEdit()) {
                        return false;
                    }
                    if (sheet._canSelect(newActiveRow, sheet.getActiveColumnIndex())) {
                        sheet._setActiveCellCore(newActiveRow, keyword_null);
                        sheet._leadingCellRow = newActiveRow;
                        sheet._moveActiveCell();
                    }
                    sheet._setTopRow(nextPageTopRow, 0);
                    return true;
                }
            };
            Commands[NAVIGATION_NEXT_SHEET] = {
                canUndo: false,
                execute: function (context, options) {
                    var sheet = getWorksheet(context, options);
                    moveToNextSheet(sheet, true);
                }
            };
            Commands[NAVIGATION_PREVIOUS_SHEET] = {
                canUndo: false,
                execute: function (context, options) {
                    var sheet = getWorksheet(context, options);
                    moveToNextSheet(sheet, false);
                }
            };
            Commands[NAVIGATION_FIRST] = {
                canUndo: false,
                execute: function (context, options) {
                    var sheet = getWorksheet(context, options);
                    if (!sheet || sheet._editorStatus === 2) {
                        return false;
                    }
                    var formulatextboxCommands = Commands._FormulatextboxCommands;
                    if (formulatextboxCommands) {
                        var returnObj = formulatextboxCommands._navigationFirst(sheet);
                        if (returnObj.r) {
                            return true;
                        }
                        sheet = returnObj.sheet;
                    }
                    sheet._moveActiveCell(5, false, sheet._activeRowIndex, sheet._activeColIndex);
                    return true;
                }
            };
            Commands[NAVIGATION_LAST] = {
                canUndo: false,
                execute: function (context, options) {
                    var sheet = getWorksheet(context, options);
                    if (!sheet || sheet._editorStatus === 2) {
                        return false;
                    }
                    var formulatextboxCommands = Commands._FormulatextboxCommands;
                    if (formulatextboxCommands) {
                        var returnObj = formulatextboxCommands._navigationLast(sheet);
                        if (returnObj.r) {
                            return true;
                        }
                        sheet = returnObj.sheet;
                    }
                    sheet._moveActiveCell(6, false, sheet._activeRowIndex, sheet._activeColIndex);
                    return true;
                }
            };
            Commands[SELECT_NEXT_CONTROL] = {
                canUndo: false,
                execute: function (context, options) {
                    var sheet = getWorksheet(context, options);
                    if (sheet.parent) {
                        return nextControl(sheet, sheet.parent.nextControl);
                    }
                    return false;
                }
            };
            Commands[SELECT_PREVIOUS_CONTROL] = {
                canUndo: false,
                execute: function (context, options) {
                    var sheet = getWorksheet(context, options);
                    if (sheet.parent) {
                        return nextControl(sheet, sheet.parent.previousControl);
                    }
                    return false;
                }
            };
            Commands[MOVE_TO_NEXT_CELL] = {
                canUndo: false,
                execute: function (context, options) {
                    var sheet = getWorksheet(context, options);
                    var formulatextboxCommands = Commands._FormulatextboxCommands;
                    if (formulatextboxCommands) {
                        sheet = formulatextboxCommands._moveToNextCell(sheet);
                    }
                    tabNavigation(sheet, 4);
                    return true;
                }
            };
            Commands[MOVE_TO_PREVIOUS_CELL] = {
                canUndo: false,
                execute: function (context, options) {
                    var sheet = getWorksheet(context, options);
                    var formulatextboxCommands = Commands._FormulatextboxCommands;
                    if (formulatextboxCommands) {
                        sheet = formulatextboxCommands._moveToPreviousCell(sheet);
                    }
                    tabNavigation(sheet, 3);
                    return true;
                }
            };
            Commands[MOVE_TO_NEXT_CELL_THEN_CONTROL] = {
                canUndo: false,
                execute: function (context, options) {
                    var sheet = getWorksheet(context, options);
                    var leadingCellRow = sheet._leadingCellRow;
                    var activeColumnIndex = sheet.getActiveColumnIndex();
                    sheet._isTabNavigation = true;
                    var rightCell = sheet._getMoveRightCell(sheet.getActiveRowIndex(), activeColumnIndex, true, leadingCellRow);
                    sheet._isTabNavigation = false;
                    var isLastVisibleCell = rightCell ? ((rightCell.leadingCellRow < leadingCellRow) || (rightCell.leadingCellRow === leadingCellRow && activeColumnIndex > rightCell.col)) : true;
                    if (isLastVisibleCell) {
                        return Commands[SELECT_NEXT_CONTROL].execute(context, options);
                    }
                    return Commands[MOVE_TO_NEXT_CELL].execute(context, options);
                }
            };
            Commands[MOVE_TO_PREVIOUS_CELL_THEN_CONTROL] = {
                canUndo: false,
                execute: function (context, options) {
                    var sheet = getWorksheet(context, options);
                    var leadingCellRow = sheet._leadingCellRow;
                    var activeColumnIndex = sheet.getActiveColumnIndex();
                    sheet._isTabNavigation = true;
                    var leftCell = sheet._getMoveLeftCell(sheet.getActiveRowIndex(), activeColumnIndex, true, leadingCellRow);
                    sheet._isTabNavigation = false;
                    var isFirstVisibleCell = leftCell ? ((leftCell.leadingCellRow > leadingCellRow) || (leftCell.leadingCellRow === leadingCellRow && activeColumnIndex < leftCell.col)) : true;
                    if (isFirstVisibleCell) {
                        return Commands[SELECT_PREVIOUS_CONTROL].execute(context, options);
                    }
                    return Commands[MOVE_TO_PREVIOUS_CELL].execute(context, options);
                }
            };
            Commands[CANCEL_INPUT] = {
                canUndo: false,
                execute: function (context, options) {
                    var sheet = getWorksheet(context, options);
                    var formulatextboxCommands = Commands._FormulatextboxCommands;
                    var cancelFormulatextbox;
                    if (formulatextboxCommands) {
                        cancelFormulatextbox = formulatextboxCommands._cancelInput(sheet);
                    }
                    if (sheet.isEditing()) {
                        var row = sheet._activeRowIndex;
                        var col = sheet._activeColIndex;
                        var cacheValue = sheet.getValue(row, col, 3, 1);
                        var ct = sheet.getCellType(row, col);
                        var editorValue = ct.getEditorValue(sheet._editor, context);
                        if (!sheet.endEdit(true)) {
                            return false;
                        }
                        var modelManager = sheet._modelManager;
                        var dynamicArrayManager = modelManager && modelManager._dynamicArrayManager;
                        if (!(dynamicArrayManager && dynamicArrayManager.getAnchorCell(row, col))) {
                            var isEditingValueChanged = ct.isEditingValueChanged(cacheValue, editorValue, context);
                            if (isEditingValueChanged) {
                                sheet.setValue(row, col, cacheValue, 3, true);
                            }
                        }
                        return true;
                    }
                    if (!isNullOrUndefined(cancelFormulatextbox)) {
                        return cancelFormulatextbox;
                    }
                    Commands._cancelCutCopyIndicator(sheet.parent);
                    sheet._clipboardHelper = keyword_null;
                    sheet.parent._clipboardHelper._reset();
                    var sheetEx = sheet;
                    sheetEx._clearFloatingObjectClipboardHelper && sheetEx._clearFloatingObjectClipboardHelper();
                    sheetEx._clearShapeClipboardHelper && sheetEx._clearShapeClipboardHelper();
                }
            };
            Commands._cancelCutCopyIndicator = function (workbook) {
                var sheets = workbook && workbook.sheets;
                if (sheets) {
                    for (var index = 0, len = sheets.length; index < len; index++) {
                        var item = sheets[index];
                        if (item && item._cutCopyIndicatorManager) {
                            item._cutCopyIndicatorManager._cancelIndicator();
                        }
                    }
                }
            };
            Commands[CLEAR] = {
                canUndo: false,
                execute: function (context, options) {
                    var sheet = getWorksheet(context, options);
                    if (!sheet.isEditing()) {
                        var ranges = sheet.getSelections();
                        sheet._commandManager().execute({
                            cmd: CLEAR_VALUES,
                            sheetName: sheet.name(),
                            ranges: ranges
                        });
                        return true;
                    }
                    return false;
                }
            };
            Commands[CLEAR_AND_EDITING] = {
                canUndo: false,
                execute: function (context, options) {
                    var sheet = getWorksheet(context, options);
                    if (!sheet.isEditing()) {
                        if (common_1._util._isMacOS()) {
                            Commands[CLEAR].execute(context, options);
                            return true;
                        }
                        sheet._startEditByKeydown = true;
                        sheet.startEdit(true, '');
                        sheet._startEditByKeydown = false;
                        return true;
                    }
                    return false;
                }
            };
            Commands[COPY] = {
                canUndo: false,
                execute: function (context, options) {
                    var sheet = getWorksheet(context, options);
                    var copyData = options.copyData = sheet._doCopy(options.ignoreClipboard);
                    if (options.callback) {
                        options.callback();
                    }
                    return copyData ? keyword_undefined : true;
                }
            };
            Commands[CUT] = {
                canUndo: false,
                execute: function (context, options) {
                    var sheet = getWorksheet(context, options);
                    var cutData = options.cutData = sheet._doCut(options.ignoreClipboard);
                    if (options.callback) {
                        options.callback();
                    }
                    return cutData ? keyword_undefined : true;
                }
            };
            Commands[PASTE] = {
                canUndo: false,
                execute: function (context, options) {
                    var sheet = getWorksheet(context, options);
                    sheet._doPaste(options);
                }
            };
            Commands[SELECTION_LEFT] = {
                canUndo: false,
                execute: defSelectionAction(37)
            };
            Commands[SELECTION_RIGHT] = {
                canUndo: false,
                execute: defSelectionAction(39)
            };
            Commands[SELECTION_UP] = {
                canUndo: false,
                execute: defSelectionAction(38)
            };
            Commands[SELECTION_DOWN] = {
                canUndo: false,
                execute: defSelectionAction(40)
            };
            Commands[SELECTION_HOME] = {
                canUndo: false,
                execute: defSelectionAction(37, true)
            };
            Commands[SELECTION_END] = {
                canUndo: false,
                execute: defSelectionAction(39, true)
            };
            Commands[SELECTION_PAGEUP] = {
                canUndo: false,
                execute: defSelectionAction(33)
            };
            Commands[SELECTION_PAGEDOWN] = {
                canUndo: false,
                execute: defSelectionAction(34)
            };
            Commands[SELECTION_TOP] = {
                canUndo: false,
                execute: defSelectionAction(38, true)
            };
            Commands[SELECTION_BOTTOM] = {
                canUndo: false,
                execute: defSelectionAction(40, true)
            };
            Commands[SELECTION_FIRST] = {
                canUndo: false,
                execute: defSelectionAction(36, true)
            };
            Commands[SELECTION_LAST] = {
                canUndo: false,
                execute: defSelectionAction(35, true)
            };
            Commands[CHANGE_FORMULA_REFERENCE] = {
                canUndo: false,
                execute: function (context, options) {
                    var sheet = getWorksheet(context, options);
                    var eventHandler = sheet && sheet._eventHandler;
                    if (eventHandler) {
                        suspendPaint(sheet);
                        try {
                            eventHandler._changeFormulaReference && eventHandler._changeFormulaReference();
                        } finally {
                            resumePaint(sheet);
                        }
                    }
                }
            };
            Commands[UNDO] = {
                canUndo: false,
                execute: function (context) {
                    var parent = context;
                    if (parent) {
                        var undoManager = parent.undoManager();
                        if (undoManager && undoManager.canUndo()) {
                            undoManager.undo();
                        }
                    }
                }
            };
            Commands[REDO] = {
                canUndo: false,
                execute: function (context) {
                    var parent = context;
                    if (parent) {
                        var undoManager = parent.undoManager();
                        if (undoManager && undoManager.canRedo()) {
                            undoManager.redo();
                        }
                    }
                }
            };
            Commands[RESIZE_COLUMN] = {
                canUndo: true,
                execute: function (context, options, isUndo) {
                    return executeCommand(context, ColumnResizeUndoAction, options, isUndo);
                }
            };
            Commands[RESIZE_ROW] = {
                canUndo: true,
                execute: function (context, options, isUndo) {
                    return executeCommand(context, RowResizeUndoAction, options, isUndo);
                }
            };
            Commands[SPLIT_RESIZE_COLUMN] = {
                canUndo: true,
                execute: function (context, options, isUndo) {
                    return executeCommand(context, ColumnSplitResizeUndoAction, options, isUndo);
                }
            };
            Commands[SPLIT_RESIZE_ROW] = {
                canUndo: true,
                execute: function (context, options, isUndo) {
                    return executeCommand(context, RowSplitResizeUndoAction, options, isUndo);
                }
            };
            Commands[AUTO_FIT_COLUMN] = {
                canUndo: true,
                execute: function (context, options, isUndo) {
                    return executeCommand(context, ColumnAutoFitUndoAction, options, isUndo);
                }
            };
            Commands[AUTO_FIT_ROW] = {
                canUndo: true,
                execute: function (context, options, isUndo) {
                    return executeCommand(context, RowAutoFitUndoAction, options, isUndo);
                }
            };
            Commands[EDIT_CELL] = {
                canUndo: true,
                execute: function (context, options, isUndo) {
                    return executeCommand(context, CellEditUndoAction, options, isUndo);
                }
            };
            Commands[RENAME_SHEET] = {
                canUndo: true,
                execute: function (context, options, isUndo) {
                    return executeCommand(context, SheetRenameUndoAction, options, isUndo);
                }
            };
            Commands[ZOOM] = {
                canUndo: true,
                execute: function (context, command, undo) {
                    return executeCommand(context, ZoomUndoAction, command, undo);
                }
            };
            Commands[CLEAR_VALUES] = {
                canUndo: true,
                execute: function (context, options, isUndo) {
                    return executeCommand(context, ClearValueUndoAction, options, isUndo);
                }
            };
            Commands[CLIPBOARD_PASTE] = {
                canUndo: true,
                execute: function (context, options, isUndo) {
                    return executeCommand(context, ClipboardPasteUndoAction, options, isUndo);
                }
            };
            Commands[MOVE_SHEET] = {
                canUndo: false,
                execute: function (context, options) {
                    var sheetName = options.sheetName;
                    var targetIndex = options.targetIndex;
                    var srcIndex = context.getSheetIndex(sheetName);
                    var sheet = context._getActiveSheetOrSheetTab();
                    var oldIndex = srcIndex;
                    var newIndex = targetIndex;
                    var sheetMovingData = {
                        sheet: sheet,
                        sheetName: sheet.name(),
                        oldIndex: oldIndex,
                        newIndex: newIndex,
                        cancel: false
                    };
                    context._trigger(common_1.Events.SheetMoving, sheetMovingData);
                    if (sheetMovingData.cancel) {
                        return false;
                    }
                    var ret = context.changeSheetIndex(sheetName, targetIndex);
                    context._trigger(common_1.Events.SheetMoved, {
                        sheet: sheet,
                        sheetName: sheet ? sheet.name() : keyword_null,
                        oldIndex: oldIndex,
                        newIndex: newIndex
                    });
                    return ret;
                }
            };
            Commands[COPY_SHEET] = {
                canUndo: false,
                execute: function (context, options) {
                    var sheetName = options.sheetName;
                    var targetIndex = options.targetIndex;
                    var newName = options.newName;
                    var includeBindingSource = options.includeBindingSource;
                    var oldSheet = context.getSheetFromName(sheetName), newSheet;
                    context._trigger(common_1.Events.SheetChanging, {
                        sheetName: newName,
                        propertyName: 'insertSheet',
                        cancel: false,
                        sheetIndex: targetIndex
                    });
                    context._trigger(common_1.Events.ActiveSheetChanging, {
                        oldSheet: oldSheet,
                        newSheet: newSheet,
                        cancel: false
                    });
                    newSheet = context.clone(sheetName, targetIndex, newName, includeBindingSource);
                    if (isNullOrUndefined(newSheet)) {
                        return false;
                    }
                    context._trigger(common_1.Events.SheetChanged, {
                        sheetName: newSheet.name(),
                        propertyName: 'insertSheet',
                        sheetIndex: targetIndex
                    });
                    context._trigger(common_1.Events.ActiveSheetChanged, {
                        oldSheet: oldSheet,
                        newSheet: newSheet
                    });
                    return true;
                }
            };
            var ChangedCells = (function () {
                function ChangedCells(sheet, range, dataType) {
                    var self = this;
                    self._sheet = sheet;
                    self._range = range;
                    self._dataType = dataType;
                    self._cellsData = [];
                    self._changedCells = [];
                    self._initCellsData();
                }
                // 初始化单元格数据
                ChangedCells.prototype._initCellsData = function () {
                    var self = this;
                    var range = self._range;
                    var sheet = self._sheet;
                    if (!sheet || !range) {
                        return;
                    }
                    var dataType = self._dataType;
                    var baseRow = range.row;
                    var baseColumn = range.col;
                    var rowCount = getRowCount(range);
                    var columnCount = getColCount(range);
                    var cellsData = self._cellsData;
                    var isWholeRowOrColumn = false;
                    if (baseRow === -1) {
                        isWholeRowOrColumn = true;
                        baseRow = 0;
                        rowCount = getSheetRowCount(sheet);
                    }
                    if (baseColumn === -1) {
                        isWholeRowOrColumn = true;
                        baseColumn = 0;
                        columnCount = getSheetColumnCount(sheet);
                    }
                    var defaultRowStyle;
                    var defaultColStyles = [];
                    var cellStyle;
                    if ((dataType & 64) > 0) {
                        for (var j = 0; j < columnCount; j++) {
                            defaultColStyles[j] = sheet._getStyleObject(-1, j) || keyword_null;
                        }
                    }
                    for (var r = 0; r < rowCount; r++) {
                        var sheetRow = baseRow + r;
                        if ((dataType & 64) > 0) {
                            defaultRowStyle = sheet._getStyleObject(sheetRow, -1) || keyword_null;
                        }
                        for (var c = 0; c < columnCount; c++) {
                            var formulaInfo = void 0;
                            var sheetCol = baseColumn + c;
                            if (_supportsCalc && (dataType & 2) > 0 && sheet.getFormulaInformation) {
                                formulaInfo = sheet.getFormulaInformation(sheetRow, sheetCol);
                                if (formulaInfo.hasFormula) {
                                    if (formulaInfo.isArrayFormula) {
                                        var baseRange = formulaInfo.baseRange;
                                        if (baseRange.row === sheetRow && baseRange.col === sheetCol) {
                                            for (var rowIndex = baseRange.row, len = baseRange.row + getRowCount(baseRange); rowIndex < len; rowIndex++) {
                                                for (var colIndex = baseRange.col, len1 = baseRange.col + getColCount(baseRange); colIndex < len1; colIndex++) {
                                                    self._setCellData(cellsData, rowIndex - baseRow, colIndex - baseColumn, formulaInfo, 2);
                                                }
                                            }
                                        }
                                    } else {
                                        self._setCellData(cellsData, r, c, formulaInfo.formula, 2);
                                    }
                                }
                            }
                            if ((dataType & 1) > 0 && (!formulaInfo || !formulaInfo.hasFormula)) {
                                self._setCellData(cellsData, r, c, sheet.getValue(sheetRow, sheetCol, 3), 1);
                            }
                            if ((dataType & 16) > 0 && sheet.getSparkline) {
                                var sparkline = sheet.getSparkline(sheetRow, sheetCol);
                                var dataRange = keyword_null;
                                if (sparkline) {
                                    dataRange = sparkline.data();
                                }
                                if (sparkline && dataRange) {
                                    self._setCellData(cellsData, r, c, sparkline, 16);
                                }
                            }
                            if ((dataType & 64) > 0) {
                                var styleObject = void 0;
                                if (isWholeRowOrColumn) {
                                    styleObject = sheet.getActualStyle(sheetRow, sheetCol, 3);
                                } else {
                                    cellStyle = sheet._getStyleObject(sheetRow, sheetCol) || keyword_null;
                                    styleObject = sheet.getCompositeStyle(sheetRow, sheetCol, 3, cellStyle, defaultRowStyle, defaultColStyles[c]);
                                }
                                var styleString = keyword_undefined;
                                if (styleObject && styleObject.toJSON) {
                                    styleString = JSON.stringify(styleObject.toJSON(3, true));
                                }
                                self._setCellData(cellsData, r, c, styleString, 64);
                            }
                            var commentManager = sheet._modelManager._comments;
                            if ((dataType & 4) > 0 && commentManager) {
                                self._setCellData(cellsData, r, c, commentManager.get(sheetRow, sheetCol), 4);
                            }
                            if ((dataType & 128) > 0) {
                                self._setCellData(cellsData, r, c, sheet.getTag(sheetRow, sheetCol, 3), 128);
                            }
                            if ((dataType & 256) > 0) {
                                self._setCellData(cellsData, r, c, sheet.getBindingPath && sheet.getBindingPath(sheetRow, sheetCol, 3), 256);
                            }
                            if ((dataType & 1024) > 0) {
                                self._setCellData(cellsData, r, c, sheet.getHyperlink && sheet.getHyperlink(r, c, 3), 1024);
                            }
                        }
                    }
                };
                ChangedCells.prototype._getCellsData = function () {
                    return this._cellsData;
                };
                ChangedCells.prototype._setCellData = function (cellsData, r, c, data, dataType) {
                    if (isNullOrUndefined(data) || !cellsData) {
                        return;
                    }
                    if (cellsData[r] === keyword_undefined) {
                        cellsData[r] = [];
                    }
                    if (cellsData[r][c] === keyword_undefined) {
                        cellsData[r][c] = {};
                    }
                    cellsData[r][c][copyToOptionDict[dataType]] = data;
                };
                // 合并单元格有差异数据
                ChangedCells.prototype._mergeCellsHasDiffData = function (outerData) {
                    if (!outerData) {
                        return;
                    }
                    var self = this;
                    var cellsData = self._cellsData;
                    for (var r = 0, len = outerData.length; r < len; r++) {
                        var outerRowData = outerData[r];
                        if (outerRowData) {
                            for (var c = 0, len1 = outerRowData.length; c < len1; c++) {
                                var outerCellData = outerRowData[c];
                                if (outerCellData) {
                                    if (!cellsData[r]) {
                                        cellsData[r] = [];
                                    }
                                    var cellData = cellsData[r][c];
                                    if (!cellData) {
                                        cellsData[r][c] = outerCellData;
                                    } else if (self._isDataEqual(outerCellData, cellData)) {
                                        cellsData[r][c] = keyword_undefined;
                                    }
                                }
                            }
                        }
                    }
                };
                ChangedCells.prototype._isDataEqual = function (obj1, obj2) {
                    var dataType = this._dataType;
                    var dataPropStrs = [];
                    if (dataType & 256) {
                        dataPropStrs.push(copyToOptionDict[256]);
                    }
                    if (dataType & 4) {
                        dataPropStrs.push(copyToOptionDict[4]);
                    }
                    if (dataType & 2) {
                        dataPropStrs.push(copyToOptionDict[2]);
                    }
                    if (dataType & 16) {
                        dataPropStrs.push(copyToOptionDict[16]);
                    }
                    if (dataType & 64) {
                        dataPropStrs.push(copyToOptionDict[64]);
                    }
                    if (dataType & 128) {
                        dataPropStrs.push(copyToOptionDict[128]);
                    }
                    if (dataType & 1024) {
                        dataPropStrs.push(copyToOptionDict[1024]);
                    }
                    if (dataType & 1) {
                        dataPropStrs.push(copyToOptionDict[1]);
                    }
                    for (var i = 0, len = dataPropStrs.length; i < len; i++) {
                        var dataPropStr = dataPropStrs[i];
                        if (obj1[dataPropStr] !== obj2[dataPropStr]) {
                            return false;
                        }
                    }
                    return true;
                };
                ChangedCells.prototype._getChangedCells = function () {
                    var self = this;
                    var baseRow = self._range.row;
                    var baseColumn = self._range.col;
                    var cellsData = self._cellsData;
                    var changedCells = self._changedCells;
                    if (changedCells && changedCells.length > 0) {
                        return changedCells;
                    }
                    changedCells = [];
                    baseRow = baseRow === -1 ? 0 : baseRow;
                    baseColumn = baseColumn === -1 ? 0 : baseColumn;
                    for (var r = 0, len = cellsData.length; r < len; r++) {
                        var rowData = cellsData[r];
                        if (rowData) {
                            for (var c = 0, len1 = rowData.length; c < len1; c++) {
                                if (rowData[c]) {
                                    changedCells.push({ row: r + baseRow, col: c + baseColumn });
                                }
                            }
                        }
                    }
                    self._changedCells = changedCells;
                    return changedCells;
                };
                return ChangedCells;
            }());
            Commands._ChangedCells = ChangedCells;

            Commands._raiseRangeDataChanged = function (sheet, row, column, rowCount, columnCount, changedCells, action, tableNames, isUndo) {
                if (sheet) {
                    if (row < 0) {
                        row = 0;
                        rowCount = getSheetRowCount(sheet);
                    }
                    if (column < 0) {
                        column = 0;
                        columnCount = getSheetColumnCount(sheet);
                    }
                    sheet._raiseRangeDataChanged(row, column, rowCount, columnCount, changedCells, action, keyword_undefined, keyword_undefined, tableNames, isUndo);
                }
            };
            function getSheets(context, sheetName) {
                var sheets = [];
                if (typeof sheetName === 'string') {
                    sheets.push(context.getSheetFromName(sheetName));
                } else if (Array.isArray(sheetName)) {
                    sheetName.forEach(function (name) {
                        sheets.push(context.getSheetFromName(name));
                    });
                }
                return sheets;
            }
            Commands._getChangesKey = function (sheetName) {
                return 'changes' + sheetName;
            };
            Commands._isNotEmptyChanges = function (changes) {
                return changes && (changes.length !== 0 || !$.isEmptyObject(changes));
            };
            Commands._isInTransaction = function (options) {
                var names;
                var sheetName = options.sheetName;
                if (typeof sheetName === 'string') {
                    names = [sheetName];
                } else if (Array.isArray(sheetName)) {
                    names = sheetName;
                }
                if (names) {
                    return names.every(function (name) {
                        var changesKey = Commands._getChangesKey(name);
                        var changes = options[changesKey];
                        return changes && changes.length === 0 && $.isEmptyObject(changes);
                    });
                }
                return false;
            };
            Commands.startTransaction = function (context, options) {
                getSheets(context, options.sheetName).forEach(function (sheet) {
                    sheet._modelManager.startTransaction();
                });
            };
            Commands.endTransaction = function (context, options) {
                getSheets(context, options.sheetName).forEach(function (sheet) {
                    var changesKey = Commands._getChangesKey(sheet.name());
                    options[changesKey] = sheet._modelManager.endTransaction();
                });
            };
            Commands.undoTransaction = function (context, options) {
                getSheets(context, options.sheetName).forEach(function (sheet) {
                    var changesKey = Commands._getChangesKey(sheet.name());
                    sheet._modelManager.undo(options[changesKey]);
                    sheet._invalidate();
                });
            };
            Commands._startTransactionAll = function (sheets) {
                sheets.forEach(function (sheet) {
                    sheet._modelManager.startTransaction();
                });
            };
            Commands._endTransactionAll = function (sheets, commandOptions) {
                sheets.forEach(function (sheet) {
                    var changesKey = Commands._getChangesKey(sheet.name());
                    commandOptions[changesKey] = sheet._modelManager.endTransaction();
                });
            };
            Commands._undoTransactionAll = function (sheets, commandOptions) {
                sheets.forEach(function (sheet) {
                    var changesKey = Commands._getChangesKey(sheet.name());
                    sheet._modelManager.undo(commandOptions[changesKey]);
                });
            };
            function beforeAction(sheet, ignoreEvent) {
                suspendPaint(sheet);
                if (!ignoreEvent) {
                    suspendEvent(sheet);
                }
            }
            function afterAction(sheet, ignoreEvent) {
                if (!ignoreEvent) {
                    resumeEvent(sheet);
                }
                resumePaint(sheet);
            }
            var ActionBase = (function () {
                function ActionBase(sheet, command) {
                    this._beforeAction = beforeAction;
                    this._afterAction = afterAction;
                    var self = this;
                    self._sheet = sheet;
                    self._command = command;
                }
                ActionBase.prototype.execute = function () { };
                ActionBase.prototype.canExecute = function () {
                    return true;
                };
                ActionBase.prototype.canUndo = function () {
                    return true;
                };
                ActionBase.prototype.undo = function () {
                    return true;
                };
                return ActionBase;
            }());
            Commands.ActionBase = ActionBase;
            function setScrollTopOrLeftInfo(command, sheet) {
                if (isNullOrUndefined(command._scrollTopRow)) {
                    command._scrollTopRow = sheet._scrollTopRow;
                    command._scrollLeftCol = sheet._scrollLeftCol;
                }
            }

            var ColumnResizeUndoAction = (function (_super) {
                __extends(ColumnResizeUndoAction, _super);
                function ColumnResizeUndoAction(sheet, command) {
                    var _this_1 = _super.call(this, sheet, command) || this;
                    setScrollTopOrLeftInfo(command, sheet);
                    return _this_1;
                }
                ColumnResizeUndoAction.prototype.execute = function () {
                    var self = this;
                    var ret = false;
                    if (self.canExecute()) {
                        var command = self._command;
                        var sheet = self._sheet;
                        var columns = command.columns;
                        var isRowHeader = command.rowHeader;
                        var columnsLength = (columns && columns.length);
                        if (sheet && columnsLength > 0) {
                            var colList = self._getColList(columns);
                            var args = {
                                sheet: sheet,
                                sheetName: sheet.name(),
                                colList: colList,
                                header: isRowHeader,
                                cancel: false
                            };
                            sheet._trigger(Events_ColumnWidthChanging, args);
                            if (args && args.cancel === true) {
                                return ret;
                            }
                            command._canUndo = true;
                            sheet._modelManager.startTransaction();
                            beforeAction(sheet);
                            try {
                                var rowHeaderArea = 2;
                                var viewportArea = 3;
                                var columnCount = (isRowHeader ? getSheetColumnCount(sheet, rowHeaderArea) : getSheetColumnCount(sheet, viewportArea));
                                sheet._scrollLeftCol = command._scrollLeftCol;
                                var newSize = command.size;
                                for (var c = 0; c < columnsLength; c++) {
                                    var cw = columns[c], firstCol = cw.firstCol, lastCol = cw.lastCol;
                                    for (var c2 = firstCol; c2 <= lastCol; c2++) {
                                        if (0 <= c2 && c2 < columnCount) {
                                            if (isRowHeader && sheet.getColumnResizable(c2, rowHeaderArea) &&
                                                newSize !== sheet._getActualColumnWidth(c2, rowHeaderArea)) {
                                                sheet.setColumnWidth(c2, newSize, rowHeaderArea);
                                                ret = true;
                                            } else if (!isRowHeader && sheet.getColumnResizable(c2, viewportArea) &&
                                                newSize !== sheet._getActualColumnWidth(c2, viewportArea)) {
                                                sheet.setColumnWidth(c2, newSize, viewportArea);
                                                ret = true;
                                            }
                                        }
                                    }
                                }
                            } finally {
                                resumeEvent(sheet);
                                sheet._trigger(Events_ColumnWidthChanged, {
                                    sheet: sheet,
                                    sheetName: sheet.name(),
                                    colList: colList,
                                    header: command.rowHeader
                                });
                                resumePaint(sheet);
                                var changesKey = Commands._getChangesKey(sheet.name());
                                command[changesKey] = sheet._modelManager.endTransaction();
                            }
                            sheet._syncHScrollbarPosition();
                        }
                    }
                    return ret;
                };
                ColumnResizeUndoAction.prototype.undo = function () {
                    var self = this;
                    var ret = false;
                    if (self.canUndo()) {
                        var command = self._command;
                        var sheet = self._sheet;
                        var columns = command.columns;
                        var isRowHeader = command.rowHeader;
                        var columnsLength = (columns && columns.length);
                        if (sheet && columnsLength > 0) {
                            var colList = self._getColList(columns);
                            var args = {
                                sheet: sheet,
                                sheetName: sheet.name(),
                                colList: colList,
                                header: isRowHeader,
                                cancel: false
                            };
                            sheet._trigger(Events_ColumnWidthChanging, args);
                            if (args && args.cancel === true) {
                                return ret;
                            }
                            beforeAction(sheet);
                            try {
                                var changesKey = Commands._getChangesKey(sheet.name());
                                sheet._modelManager.undo(command[changesKey]);
                                sheet._needSyncHScrollbarSize = true;
                                sheet.showCell(sheet.getActiveRowIndex(), sheet.getActiveColumnIndex(), 1, 1);
                                ret = true;
                            } finally {
                                resumeEvent(sheet);
                                sheet._trigger(Events_ColumnWidthChanged, {
                                    sheet: sheet,
                                    sheetName: sheet.name(),
                                    colList: colList,
                                    header: command.rowHeader
                                });
                                resumePaint(sheet);
                            }
                        }
                    }
                    return ret;
                };
                ColumnResizeUndoAction.prototype._getColList = function (columnWidthChangeExtents) {
                    var columns = [];
                    for (var i = 0, len = columnWidthChangeExtents.length; i < len; i++) {
                        var item = columnWidthChangeExtents[i];
                        var firstCol = item.firstCol;
                        var lastCol = item.lastCol;
                        for (var col = firstCol; col <= lastCol; col++) {
                            columns.push(col);
                        }
                    }
                    return columns;
                };
                ColumnResizeUndoAction.prototype.canUndo = function () {
                    return this._command._canUndo;
                };
                return ColumnResizeUndoAction;
            }(ActionBase));

            var RowResizeUndoAction = (function (_super) {
                __extends(RowResizeUndoAction, _super);
                function RowResizeUndoAction(sheet, command) {
                    var _this_1 = _super.call(this, sheet, command) || this;
                    setScrollTopOrLeftInfo(command, sheet);
                    return _this_1;
                }
                RowResizeUndoAction.prototype.execute = function () {
                    var self = this;
                    var ret = false;
                    if (self.canExecute()) {
                        var sheet = self._sheet;
                        var command = self._command;
                        var rows = command.rows;
                        var rowsLength = (rows && rows.length);
                        if (sheet && rowsLength > 0) {
                            var rowList = self._getRowList(rows);
                            var args = {
                                sheet: sheet,
                                sheetName: sheet.name(),
                                rowList: rowList,
                                header: command.columnHeader,
                                cancel: false
                            };
                            sheet._trigger(Events_RowHeightChanging, args);
                            if (args && args.cancel === true) {
                                return ret;
                            }
                            command._canUndo = true;
                            sheet._modelManager.startTransaction();
                            beforeAction(sheet);
                            try {
                                var viewportArea = 3;
                                var colHeaderArea = 1;
                                var isColumnHeader = command.columnHeader;
                                var rowCount = (isColumnHeader ? getSheetRowCount(sheet, colHeaderArea) : getSheetRowCount(sheet, viewportArea));
                                sheet._scrollTopRow = command._scrollTopRow;
                                var newSize = command.size;
                                for (var r = 0; r < rowsLength; r++) {
                                    var rh = rows[r];
                                    var firstRow = rh.firstRow;
                                    var lastRow = rh.lastRow;
                                    for (var r2 = firstRow; r2 <= lastRow; r2++) {
                                        if (0 <= r2 && r2 < rowCount) {
                                            if (isColumnHeader && sheet.getRowResizable(r2, colHeaderArea) &&
                                                newSize !== sheet._getActualRowHeight(r2, colHeaderArea)) {
                                                sheet.setRowHeight(r2, newSize, colHeaderArea);
                                                ret = true;
                                            } else if (!isColumnHeader && sheet.getRowResizable(r2, viewportArea) &&
                                                newSize !== sheet._getActualRowHeight(r2, viewportArea)) {
                                                sheet.setRowHeight(r2, newSize, viewportArea);
                                                ret = true;
                                            }
                                        }
                                    }
                                }
                            } finally {
                                resumeEvent(sheet);
                                sheet._trigger(Events_RowHeightChanged, {
                                    sheet: sheet,
                                    sheetName: sheet.name(),
                                    rowList: rowList,
                                    header: command.columnHeader
                                });
                                resumePaint(sheet);
                                var changesKey = Commands._getChangesKey(sheet.name());
                                command[changesKey] = sheet._modelManager.endTransaction();
                            }
                            sheet._syncVScrollbarPosition();
                        }
                    }
                    return ret;
                };
                RowResizeUndoAction.prototype.undo = function () {
                    var self = this;
                    var ret = false;
                    if (self.canUndo()) {
                        var sheet = self._sheet;
                        var command = self._command;
                        var rows = command.rows;
                        var rowsLength = (rows && rows.length);
                        if (sheet && rowsLength > 0) {
                            var rowList = self._getRowList(rows);
                            var args = {
                                sheet: sheet,
                                sheetName: sheet.name(),
                                rowList: rowList,
                                header: command.columnHeader,
                                cancel: false
                            };
                            sheet._trigger(Events_RowHeightChanging, args);
                            if (args && args.cancel === true) {
                                return ret;
                            }
                            beforeAction(sheet);
                            try {
                                var changesKey = Commands._getChangesKey(sheet.name());
                                sheet._modelManager.undo(command[changesKey]);
                                sheet._needSyncVScrollbarSize = true;
                                sheet.showCell(sheet.getActiveRowIndex(), sheet.getActiveColumnIndex(), 1, 1);
                                ret = true;
                            } finally {
                                resumeEvent(sheet);
                                sheet._trigger(Events_RowHeightChanged, {
                                    sheet: sheet,
                                    sheetName: sheet.name(),
                                    rowList: rowList,
                                    header: command.columnHeader
                                });
                                resumePaint(sheet);
                            }
                        }
                    }
                    return ret;
                };
                RowResizeUndoAction.prototype._getRowList = function (rowHeightChangeExtents) {
                    var rows = [];
                    for (var i = 0, len = rowHeightChangeExtents.length; i < len; i++) {
                        var item = rowHeightChangeExtents[i];
                        var firstRow = item.firstRow;
                        var lastRow = item.lastRow;
                        for (var row = firstRow; row <= lastRow; row++) {
                            rows.push(row);
                        }
                    }
                    return rows;
                };
                RowResizeUndoAction.prototype.canUndo = function () {
                    return this._command._canUndo;
                };
                return RowResizeUndoAction;
            }(ActionBase));

            var ColumnSplitResizeUndoAction = (function (_super) {
                __extends(ColumnSplitResizeUndoAction, _super);
                function ColumnSplitResizeUndoAction(sheet, command) {
                    var _this_1 = _super.call(this) || this;
                    var self = _this_1;
                    self._sheet = sheet;
                    self._command = command;
                    return _this_1;
                }
                ColumnSplitResizeUndoAction.prototype.execute = function () {
                    var self = this, ret = false;
                    var command = self._command;
                    var sheet = self._sheet;
                    var columns = command.columns;
                    var isRowHeader = command.rowHeader;
                    var colList = self._getColList(columns);
                    if (sheet && columns && columns.length > 0) {
                        var args = {
                            sheet: sheet,
                            sheetName: sheet._name,
                            colList: colList,
                            header: isRowHeader,
                            cancel: false
                        };
                        sheet._trigger(Events_ColumnWidthChanging, args);
                        if (args && args.cancel === true) {
                            return ret;
                        }
                        sheet._modelManager.startTransaction();
                        self._beforeAction(sheet);
                        try {
                            var newSize = Math_ceil(command.size);
                            var sheetArea = isRowHeader ? 2 : 3;
                            var resizeColIndex = columns[0].firstCol;
                            var oldColumnWidth = void 0;
                            var widthChanged = void 0;
                            var nextVisibleColumn = void 0;
                            oldColumnWidth = sheet._getActualColumnWidth(resizeColIndex, sheetArea);
                            if (newSize !== oldColumnWidth) {
                                widthChanged = newSize - oldColumnWidth;
                                nextVisibleColumn = sheet._getNextVisualColumn(resizeColIndex, sheetArea);
                                sheet.setColumnWidth(resizeColIndex, newSize, sheetArea);
                                sheet.setColumnWidth(nextVisibleColumn, sheet._getActualColumnWidth(nextVisibleColumn, sheetArea) - widthChanged, sheetArea);
                            }
                            ret = true;
                        } finally {
                            resumeEvent(sheet);
                            sheet._trigger(Events_ColumnWidthChanged, {
                                sheet: sheet,
                                sheetName: sheet._name,
                                colList: colList,
                                header: command.rowHeader
                            });
                            resumePaint(sheet);
                            var changesKey = Commands._getChangesKey(sheet.name());
                            command[changesKey] = sheet._modelManager.endTransaction();
                        }
                    }
                    return ret;
                };
                ColumnSplitResizeUndoAction.prototype.undo = function () {
                    var sheet = this._sheet;
                    var columns = this._command.columns;
                    var ret = false;
                    var command = this._command;
                    var isRowHeader = this._command.rowHeader;
                    var colList = this._getColList(columns);
                    var args = {
                        sheet: sheet,
                        sheetName: sheet._name,
                        colList: colList,
                        header: isRowHeader,
                        cancel: false
                    };
                    sheet._trigger(Events_ColumnWidthChanging, args);
                    if (args && args.cancel === true) {
                        return ret;
                    }
                    beforeAction(sheet);
                    try {
                        var changesKey = Commands._getChangesKey(sheet.name());
                        sheet._modelManager.undo(command[changesKey]);
                        ret = true;
                    } finally {
                        resumeEvent(sheet);
                        sheet._trigger(Events_ColumnWidthChanged, {
                            sheet: sheet,
                            sheetName: sheet._name,
                            colList: colList,
                            header: command.rowHeader
                        });
                        resumePaint(sheet);
                    }
                    return ret;
                };
                ColumnSplitResizeUndoAction.prototype._getColList = function (columnWidthChangeExtents) {
                    var columns = [];
                    for (var i = 0, len = columnWidthChangeExtents.length; i < len; i++) {
                        var item = columnWidthChangeExtents[i];
                        var firstCol = item.firstCol;
                        var lastCol = item.lastCol;
                        for (var col = firstCol; col <= lastCol; col++) {
                            columns.push(col);
                        }
                    }
                    return columns;
                };
                return ColumnSplitResizeUndoAction;
            }(ActionBase));

            var RowSplitResizeUndoAction = (function (_super) {
                __extends(RowSplitResizeUndoAction, _super);
                function RowSplitResizeUndoAction(sheet, command) {
                    var _this_1 = _super.call(this) || this;
                    var self = _this_1;
                    self._sheet = sheet;
                    self._command = command;
                    return _this_1;
                }
                RowSplitResizeUndoAction.prototype.execute = function () {
                    var self = this, ret = false;
                    var command = self._command;
                    var sheet = self._sheet;
                    var rows = command.rows;
                    var isColumnHeader = command.columnHeader;
                    var rowList = self._getRowList(rows);
                    if (sheet && rows && rows.length > 0) {
                        var args = {
                            sheet: sheet,
                            sheetName: sheet._name,
                            rowList: rowList,
                            header: isColumnHeader,
                            cancel: false
                        };
                        sheet._trigger(Events_RowHeightChanging, args);
                        if (args && args.cancel === true) {
                            return ret;
                        }
                        sheet._modelManager.startTransaction();
                        self._beforeAction(sheet);
                        try {
                            var newSize = Math_ceil(command.size);
                            var sheetArea = isColumnHeader ? 1 : 3;
                            var resizeRowIndex = rows[0].firstRow;
                            var oldRowHeight = void 0;
                            var heightChanged = void 0;
                            var nextVisibleRow = void 0;
                            oldRowHeight = sheet._getActualRowHeight(resizeRowIndex, sheetArea);
                            if (newSize !== oldRowHeight) {
                                heightChanged = newSize - oldRowHeight;
                                nextVisibleRow = sheet._getNextVisualRow(resizeRowIndex, sheetArea);
                                sheet.setRowHeight(resizeRowIndex, newSize, sheetArea);
                                sheet.setRowHeight(nextVisibleRow, sheet._getActualRowHeight(nextVisibleRow, sheetArea) - heightChanged, sheetArea);
                            }
                            ret = true;
                        } finally {
                            resumeEvent(sheet);
                            sheet._trigger(Events_RowHeightChanged, {
                                sheet: sheet,
                                sheetName: sheet._name,
                                rowList: rowList,
                                header: command.columnHeader
                            });
                            resumePaint(sheet);
                            var changesKey = Commands._getChangesKey(sheet.name());
                            command[changesKey] = sheet._modelManager.endTransaction();
                        }
                    }
                    return ret;
                };
                RowSplitResizeUndoAction.prototype.undo = function () {
                    var sheet = this._sheet;
                    var rows = this._command.rows;
                    var ret = false;
                    var command = this._command;
                    var isColHeader = this._command.columnHeader;
                    var rowList = this._getRowList(rows);
                    var args = {
                        sheet: sheet,
                        sheetName: sheet._name,
                        rowList: rowList,
                        header: isColHeader,
                        cancel: false
                    };
                    sheet._trigger(Events_RowHeightChanging, args);
                    if (args && args.cancel === true) {
                        return ret;
                    }
                    beforeAction(sheet);
                    try {
                        var changesKey = Commands._getChangesKey(sheet.name());
                        sheet._modelManager.undo(command[changesKey]);
                        ret = true;
                    } finally {
                        resumeEvent(sheet);
                        sheet._trigger(Events_RowHeightChanged, {
                            sheet: sheet,
                            sheetName: sheet._name,
                            rowList: rowList,
                            header: command.columnHeader
                        });
                        resumePaint(sheet);
                    }
                    return ret;
                };
                RowSplitResizeUndoAction.prototype._getRowList = function (rowHeightChangeExtents) {
                    var rows = [];
                    for (var i = 0, len = rowHeightChangeExtents.length; i < len; i++) {
                        var item = rowHeightChangeExtents[i];
                        var firstRow = item.firstRow;
                        var lastRow = item.lastRow;
                        for (var row = firstRow; row <= lastRow; row++) {
                            rows.push(row);
                        }
                    }
                    return rows;
                };
                return RowSplitResizeUndoAction;
            }(ActionBase));

            var ColumnAutoFitUndoAction = (function (_super) {
                __extends(ColumnAutoFitUndoAction, _super);
                function ColumnAutoFitUndoAction(sheet, command) {
                    var _this_1 = _super.call(this, sheet, command) || this;
                    var self = _this_1;
                    var parent = sheet.parent;
                    self._sheetArea = command.rowHeader ? 2 : 3;
                    if (!isDefined(command.autoFitType)) {
                        command.autoFitType = parent ? parent.options.autoFitType : 0;
                    }
                    return _this_1;
                }
                ColumnAutoFitUndoAction.prototype.canExecute = function () {
                    var command = this._command;
                    return this._sheet && command.columns && command.columns.length > 0;
                };
                ColumnAutoFitUndoAction.prototype.execute = function () {
                    var self = this;
                    var ret = false;
                    if (self.canExecute()) {
                        var command = self._command;
                        var sheet = self._sheet;
                        var sheetArea = self._sheetArea;
                        var colList = self._getColList(command.columns);
                        var isHeader = sheetArea === 2;
                        var args = {
                            sheet: sheet,
                            sheetName: sheet.name(),
                            colList: colList,
                            header: isHeader,
                            cancel: false
                        };
                        sheet._trigger(Events_ColumnWidthChanging, args);
                        if (args && args.cancel === true) {
                            return ret;
                        }
                        command._canUndo = true;
                        var columnCount = getSheetColumnCount(sheet, sheetArea);
                        var startCol = columnCount - 1;
                        var endCol = 0;
                        var cTemp = void 0;
                        for (var c = 0, len = command.columns.length; c < len; c++) {
                            cTemp = command.columns[c].col;
                            startCol = startCol > cTemp ? cTemp : startCol;
                            endCol = endCol < cTemp ? cTemp : endCol;
                        }
                        common_1._CacheMgr._startCache(sheet, 0, startCol, getSheetRowCount(sheet) - 1, endCol);
                        sheet._modelManager.startTransaction();
                        beforeAction(sheet);
                        try {
                            var fitValue = void 0;
                            for (var c = 0, len = command.columns.length; c < len; c++) {
                                var col = command.columns[c].col;
                                if (0 <= col && col < columnCount && sheet.getColumnResizable(col, sheetArea)) {
                                    fitValue = self._getColumnAutoFitValue(col);
                                    if (fitValue !== sheet.getColumnWidth(col, sheetArea) || !isNullOrUndefined(sheet.getColumnWidth(col, sheetArea, true))) {
                                        sheet.setColumnWidth(col, fitValue, sheetArea);
                                        ret = true;
                                    }
                                }
                            }
                        } finally {
                            common_1._CacheMgr._clearCache();
                            resumeEvent(sheet);
                            sheet._trigger(Events_ColumnWidthChanged, {
                                sheet: sheet,
                                sheetName: sheet.name(),
                                colList: colList,
                                header: isHeader
                            });
                            resumePaint(sheet);
                            var changesKey = Commands._getChangesKey(sheet.name());
                            command[changesKey] = sheet._modelManager.endTransaction();
                        }
                    }
                    return ret;
                };
                ColumnAutoFitUndoAction.prototype.undo = function () {
                    var self = this;
                    var ret = false;
                    if (self.canUndo()) {
                        var command = self._command;
                        var sheet = self._sheet;
                        var sheetArea = self._sheetArea;
                        var colList = self._getColList(command.columns);
                        var isHeader = sheetArea === 2;
                        var args = {
                            sheet: sheet,
                            sheetName: sheet.name(),
                            colList: colList,
                            header: isHeader,
                            cancel: false
                        };
                        sheet._trigger(Events_ColumnWidthChanging, args);
                        if (args && args.cancel === true) {
                            return ret;
                        }
                        beforeAction(sheet);
                        try {
                            var changesKey = Commands._getChangesKey(sheet.name());
                            sheet._modelManager.undo(command[changesKey]);
                            ret = true;
                        } finally {
                            resumeEvent(sheet);
                            sheet._trigger(Events_ColumnWidthChanged, {
                                sheet: sheet,
                                sheetName: sheet.name(),
                                colList: colList,
                                header: isHeader
                            });
                            resumePaint(sheet);
                        }
                    }
                    return ret;
                };
                ColumnAutoFitUndoAction.prototype._getColList = function (columnWidthChangeExtents) {
                    var columns = [];
                    for (var i = 0; i < columnWidthChangeExtents.length; i++) {
                        var item = columnWidthChangeExtents[i];
                        columns.push(item.col);
                    }
                    return columns;
                };
                ColumnAutoFitUndoAction.prototype._getColumnAutoFitValue = function (col) {
                    return common_1._util._getColumnAutoFitValue(col, this._sheet, this._sheetArea, this._command.autoFitType);
                };
                ColumnAutoFitUndoAction.prototype.canUndo = function () {
                    return this._command._canUndo;
                };
                return ColumnAutoFitUndoAction;
            }(ActionBase));

            var RowAutoFitUndoAction = (function (_super) {
                __extends(RowAutoFitUndoAction, _super);
                function RowAutoFitUndoAction(sheet, command) {
                    var _this_1 = _super.call(this, sheet, command) || this;
                    var self = _this_1, parent = sheet.parent;
                    self._sheetArea = command.columnHeader ? 1 : 3;
                    if (!isDefined(command.autoFitType)) {
                        command.autoFitType = parent ? parent.options.autoFitType : 0;
                    }
                    return _this_1;
                }
                RowAutoFitUndoAction.prototype.canExecute = function () {
                    var command = this._command;
                    return this._sheet && command.rows && command.rows.length > 0;
                };
                RowAutoFitUndoAction.prototype.execute = function () {
                    var self = this;
                    var ret = false;
                    if (self.canExecute()) {
                        var command = self._command;
                        var sheet = self._sheet;
                        var rowList = self._getRowList(command.rows);
                        var sheetArea = self._sheetArea;
                        var inHeader = self._sheetArea === 1;
                        var args = {
                            sheet: sheet,
                            sheetName: sheet.name(),
                            rowList: rowList,
                            header: inHeader,
                            cancel: false
                        };
                        sheet._trigger(Events_RowHeightChanging, args);
                        if (args && args.cancel === true) {
                            return ret;
                        }
                        command._canUndo = true;
                        sheet._modelManager.startTransaction();
                        beforeAction(sheet);
                        try {
                            var rowCount = getSheetRowCount(sheet, sheetArea);
                            var fitValue = void 0;
                            for (var r = 0, len = command.rows.length; r < len; r++) {
                                var row = command.rows[r].row;
                                if (0 <= row && row < rowCount && sheet.getRowResizable(row, sheetArea)) {
                                    fitValue = self._getRowAutoFitValue(row);
                                    if (fitValue !== sheet.getRowHeight(row, sheetArea) || !isNullOrUndefined(sheet.getRowHeight(row, sheetArea, true))) {
                                        sheet.setRowHeight(row, fitValue, sheetArea);
                                        ret = true;
                                    }
                                }
                            }
                        } finally {
                            resumeEvent(sheet);
                            sheet._trigger(Events_RowHeightChanged, {
                                sheet: sheet,
                                sheetName: sheet.name(),
                                rowList: rowList,
                                header: inHeader
                            });
                            resumePaint(sheet);
                            var changesKey = Commands._getChangesKey(sheet.name());
                            command[changesKey] = sheet._modelManager.endTransaction();
                        }
                    }
                    return ret;
                };
                RowAutoFitUndoAction.prototype.undo = function () {
                    var self = this;
                    var ret = false;
                    if (self.canUndo()) {
                        var command = self._command;
                        var sheet = self._sheet;
                        var rowList = self._getRowList(command.rows);
                        var inHeader = self._sheetArea === 1;
                        var args = {
                            sheet: sheet,
                            sheetName: sheet.name(),
                            rowList: rowList,
                            header: inHeader,
                            cancel: false
                        };
                        sheet._trigger(Events_RowHeightChanging, args);
                        if (args && args.cancel === true) {
                            return ret;
                        }
                        beforeAction(sheet);
                        try {
                            var changesKey = Commands._getChangesKey(sheet.name());
                            sheet._modelManager.undo(command[changesKey]);
                            ret = true;
                        } finally {
                            resumeEvent(sheet);
                            sheet._trigger(Events_RowHeightChanged, {
                                sheet: sheet,
                                sheetName: sheet.name(),
                                rowList: rowList,
                                header: inHeader
                            });
                            resumePaint(sheet);
                        }
                    }
                    return ret;
                };
                RowAutoFitUndoAction.prototype._getRowList = function (rowHeightChangeExtents) {
                    var rows = [];
                    for (var i = 0, len = rowHeightChangeExtents.length; i < len; i++) {
                        var item = rowHeightChangeExtents[i];
                        rows.push(item.row);
                    }
                    return rows;
                };
                RowAutoFitUndoAction.prototype._getRowAutoFitValue = function (row) {
                    return common_1._util._getRowAutoFitValue(row, this._sheet, this._sheetArea, this._command.autoFitType);
                };
                RowAutoFitUndoAction.prototype.canUndo = function () {
                    return this._command._canUndo;
                };
                return RowAutoFitUndoAction;
            }(ActionBase));


            function cellValueChangeCallBack(sheet, data) {
                if (data.propertyName === 'value') {
                    sheet._raiseValueChanged(data.row, data.col, data.oldValue, data.newValue);
                }
            }
            var CellEditUndoAction = (function (_super) {
                __extends(CellEditUndoAction, _super);
                function CellEditUndoAction(sheet, command) {
                    var _this_1 = _super.call(this, sheet, command) || this;
                    if (_supportsCalc && command.ranges && command.endEditType === 1) {
                        var range = sheet._getActualRange(command.ranges[0]);
                        command.ranges[0] = range;
                        if (getRowCount(range) === 1 && getColCount(range) === 1) {
                            var exFormulas = sheet._getsArrayFormulas(range.row, range.col, 1, 1);
                            if (exFormulas && exFormulas.ranges && exFormulas.ranges.length > 0) {
                                command.ranges = [exFormulas.ranges[0]];
                            }
                        }
                    }
                    return _this_1;
                }
                CellEditUndoAction.prototype.canExecute = function () {
                    var self = this;
                    var sheet = self._sheet;
                    var command = self._command;
                    var ranges = command.ranges;
                    var row = command.row;
                    var col = command.col;
                    if (ranges) {
                        for (var i = 0; i < ranges.length; i++) {
                            var range = ranges[i];
                            if (!sheet._canChange(range.row, range.col, getRowCount(range), getColCount(range))) {
                                return false;
                            }
                        }
                    } else if (!sheet._canChange(row, col, 1, 1)) {
                        return false;
                    }
                    return true;
                };
                CellEditUndoAction.prototype._iteration = function (func) {
                    var self = this;
                    var command = self._command;
                    var ranges = command.ranges;
                    if (ranges) {
                        for (var rangeIndex = 0; rangeIndex < ranges.length; rangeIndex++) {
                            var range = ranges[rangeIndex];
                            for (var row = range.row; row < range.row + getRowCount(range); row++) {
                                for (var col = range.col; col < range.col + getColCount(range); col++) {
                                    func(row, col);
                                }
                            }
                        }
                    } else {
                        func(command.row, command.col);
                    }
                };
                CellEditUndoAction.prototype.undo = function () {
                    var self = this;
                    if (self.canUndo()) {
                        var sheet_1 = self._sheet, command = self._command;
                        beforeAction(sheet_1, true);
                        try {
                            sheet_1._bind(Events_CellChanged + CELL_EDIT_ACTION_EVENT_NS, function (event, data) {
                                cellValueChangeCallBack(sheet_1, data);
                            });
                            var changesKey = Commands._getChangesKey(sheet_1.name());
                            sheet_1._modelManager.undo(command[changesKey]);
                        } catch (ex) {
                            return false;
                        } finally {
                            sheet_1._unbind(Events_CellChanged + CELL_EDIT_ACTION_EVENT_NS);
                            afterAction(sheet_1, true);
                        }
                        return true;
                    }
                    return false;
                };
                CellEditUndoAction.prototype.execute = function () {
                    var self = this;
                    var succeed = false;
                    if (self.canExecute()) {
                        var sheet_2 = self._sheet;
                        sheet_2._modelManager.startTransaction();
                        beforeAction(sheet_2, true);
                        try {
                            sheet_2._bind(Events_CellChanged + CELL_EDIT_ACTION_EVENT_NS, function (event, data) {
                                cellValueChangeCallBack(sheet_2, data);
                            });
                            self._command.applyResult = self._applyEditing();
                            succeed = true;
                        } catch (e) {
                            succeed = false;
                        } finally {
                            sheet_2._unbind(Events_CellChanged + CELL_EDIT_ACTION_EVENT_NS);
                            var changesKey = Commands._getChangesKey(sheet_2.name());
                            self._command[changesKey] = sheet_2._modelManager.endTransaction();
                            afterAction(sheet_2, true);
                        }
                    }
                    return succeed;
                };
                CellEditUndoAction.prototype._positionToString = function (row, col) {
                    return row + '_' + col;
                };
                CellEditUndoAction.prototype._validateEditingValue = function (styleChangedInfo) {
                    var self = this;
                    var action = 0;
                    var sheet = self._sheet;
                    var command = self._command;
                    var row = command.row;
                    var col = command.col;
                    var text = command.newValue;
                    var autoFormat = command.hasOwnProperty('autoFormat') ? command.autoFormat : true;
                    if (_supportsCalc && text && text.length > 0 && text[0] === '=') {
                        if (sheet.getDataValidator && sheet.getDataValidator(row, col)) {
                            var newFormula = text.substring(1);
                            if (newFormula !== '' && newFormula !== sheet.getFormula(row, col)) {
                                var svc = sheet._getCalcServiceInternal();
                                if (svc) {
                                    var expr = svc.parse(sheet._getSheetSource(), newFormula, row >= 0 ? row : 0, col >= 0 ? col : 0, true);
                                    if (expr) {
                                        var calc = svc._evaluateParsedFormula(sheet._getSheetSource(), expr, {
                                            row: row,
                                            col: col
                                        });
                                        if (!(sheet.isValid ? sheet.isValid(row, col, calc) : true)) {
                                            action = sheet._validationError(row, col);
                                        }
                                    }
                                }
                            }
                        }
                    } else {
                        var value = self._getValueFromEditing(row, col, text, autoFormat, styleChangedInfo);
                        var valid = sheet.isValid ? sheet.isValid(row, col, value) : true;
                        if (!valid) {
                            action = sheet._validationError(row, col);
                            sheet._eventHandler._forceCancelSelectiong = true;
                        }
                    }
                    return action;
                };
                CellEditUndoAction.prototype._applyEditing = function () {
                    var self = this;
                    var sheet = self._sheet;
                    var command = self._command;
                    var text = command.newValue;
                    var ignoreValidate = command.ignoreValidate;
                    var styleChangedInfo = {
                        _isAutoFormatChanged: false,
                        _isQuotePrefixChanged: false,
                        _autoFormatter: keyword_undefined,
                        quotePrefix: keyword_undefined
                    };
                    var action = 0;
                    if (ignoreValidate !== true) {
                        action = self._validateEditingValue(styleChangedInfo);
                        if (action === 1 || action === 2) {
                            return action;
                        }
                    }
                    var value;
                    var autoFormat = command.hasOwnProperty('autoFormat') ? command.autoFormat : true;
                    var baseRow = command.row;
                    baseRow = baseRow >= 0 ? baseRow : 0;
                    var baseCol = command.col;
                    baseCol = baseCol >= 0 ? baseCol : 0;
                    var calcParser = _supportsCalc && CalcEngine && CalcEngine.Parser;
                    var expr;
                    var range;
                    var svc;
                    if (calcParser) {
                        svc = sheet._getCalcServiceInternal();
                        var parent_1 = sheet.parent;
                        var allowUserEditFormula = parent_1 && parent_1.options.allowUserEditFormula;
                        var formatter = sheet.getFormatter(baseRow, baseCol);
                        if (!(formatter === '@') && allowUserEditFormula && svc && text && text.length > 0 && text[0] === '=') {
                            try {
                                if (command.ranges && command.endEditType === 1) {
                                    range = command.ranges[0];
                                    sheet.setArrayFormula(range.row, range.col, getRowCount(range), getColCount(range), text.substring(1));
                                    return action;
                                }
                                expr = svc.parse(sheet._getSheetSource(), text.substring(1), baseRow, baseCol, true);
                            } catch (e) {
                                sheet._raiseInvalidOperation(0, typeof (e) === 'string' ? e : e.message);
                                throw e;
                            }
                        } else if (command.ranges && command.endEditType === 1) {
                            range = command.ranges[0];
                            sheet.getRange(range.row, range.col, getRowCount(range), getColCount(range), 3).clear(1);
                        }
                    }
                    if (!expr) {
                        if (text && text[0] === '\'') {
                            self._setQuotePrefix(baseRow, baseCol, true, styleChangedInfo);
                        } else {
                            self._setQuotePrefix(baseRow, baseCol, keyword_undefined, styleChangedInfo);
                        }
                        value = self._getValueFromEditing(baseRow, baseCol, text, autoFormat, styleChangedInfo);
                    }
                    self._iteration(function (row, col) {
                        if (expr) {
                            try {
                                sheet._setFormulaCore(row, col, svc.unparse(sheet._getSheetSource(), expr, row, col), expr);
                                sheet._trigger(common_1.Events.UserFormulaEntered, {
                                    sheet: sheet,
                                    sheetName: sheet.name(),
                                    row: row,
                                    col: col,
                                    isCircularReference: sheet._isCircularReference(row, col),
                                    formula: text.substring(1).toUpperCase()
                                });
                            } catch (e) {
                                sheet._raiseInvalidOperation(0, typeof (e) === 'string' ? e : e.message);
                                throw e;
                            }
                        } else {
                            try {
                                if (sheet.hasFormula && sheet.hasFormula(row, col)) {
                                    sheet.setFormula(row, col, keyword_null);
                                }
                            } catch (e) {
                                sheet._raiseInvalidOperation(0, typeof (e) === 'string' ? e : e.message);
                                throw e;
                            }
                            try {
                                sheet._setValueInternal(row, col, value, command.sheetArea);
                                if (typeof value === 'string' || value === null) {
                                    worksheet_1.Worksheet._callFeatureHandler(sheet, 'setHyperlinkWhenEditing', { url: value, row: row, col: col, sheetArea: command.sheetArea });
                                }
                            } catch (ex) {
                                sheet.setValue(row, col, text);
                            }
                        }
                    });
                    var isAutoFormatChanged = styleChangedInfo._isAutoFormatChanged;
                    var isQuotePrefixChanged = styleChangedInfo._isQuotePrefixChanged;
                    if (isAutoFormatChanged || isQuotePrefixChanged) {
                        var storedStyle = sheet._getStyleObject(baseRow, baseCol);
                        var isNamedStyle = (typeof (storedStyle) === 'string');
                        if (!storedStyle || isNamedStyle) {
                            var newStyle = new style_1.Style();
                            if (isNamedStyle) {
                                newStyle.parentName = storedStyle;
                            }
                            storedStyle = newStyle;
                        }
                        if (isAutoFormatChanged) {
                            storedStyle._autoFormatter = styleChangedInfo._autoFormatter;
                        }
                        if (isQuotePrefixChanged) {
                            storedStyle.quotePrefix = styleChangedInfo.quotePrefix;
                        }
                        sheet.setStyle(baseRow, baseCol, storedStyle);
                    }
                    return action;
                };
                CellEditUndoAction.prototype.canUndo = function () {
                    return this._command.applyResult === 0;
                };
                CellEditUndoAction.prototype._getValueFromEditing = function (row, col, text, autoFormat, styleChangedInfo) {
                    var self = this;
                    var sheet = self._sheet;
                    var command = self._command;
                    var ignoreFormatting = command.ignoreFormatting;
                    var style = sheet.getActualStyle(row, col);
                    var styleRef = {};
                    var value;
                    if (typeof text === 'string' && !ignoreFormatting) {
                        if (text && text[0] === '\'') {
                            value = text.substring(1);
                        } else {
                            value = common_1._util._parseText2Value(style, text, autoFormat, styleRef, command.editingFormatter);
                        }
                    } else {
                        value = text;
                    }
                    if (styleChangedInfo.quotePrefix) {
                        styleChangedInfo._autoFormatter = keyword_undefined;
                        styleChangedInfo._isAutoFormatChanged = true;
                    } else {
                        var autoDisplayFormatter = styleRef.value;
                        if (autoFormat && autoDisplayFormatter) {
                            var af = keyword_null;
                            if (value !== keyword_null && autoDisplayFormatter.formatString() !== 'General' || !style._autoFormatter) {
                                autoDisplayFormatter.isAuto = true;
                                af = autoDisplayFormatter;
                            }
                            if (af) {
                                styleChangedInfo._isAutoFormatChanged = true;
                                styleChangedInfo._autoFormatter = af;
                            }
                        }
                    }
                    return value;
                };
                CellEditUndoAction.prototype._setQuotePrefix = function (row, col, quotePrefix, styleChangedInfo) {
                    var self = this;
                    var sheet = self._sheet;
                    var storedStyle = sheet._getStyleObject(row, col);
                    var isNamedStyle = (typeof (storedStyle) === 'string');
                    if (!storedStyle || isNamedStyle) {
                        var newStyle = new style_1.Style();
                        if (isNamedStyle) {
                            newStyle.parentName = storedStyle;
                        }
                        storedStyle = newStyle;
                    }
                    if (storedStyle.quotePrefix !== quotePrefix) {
                        styleChangedInfo._isQuotePrefixChanged = true;
                        styleChangedInfo.quotePrefix = quotePrefix;
                    }
                };
                return CellEditUndoAction;
            }(ActionBase));

            function sheetRenameUndoAction_repaint(sheet) {
                var parent = sheet.parent;
                var tab = parent && parent._tabStrip;
                if (tab) {
                    tab.repaint();
                }
            }
            var SheetRenameUndoAction = (function (_super) {
                __extends(SheetRenameUndoAction, _super);
                function SheetRenameUndoAction(sheet, command) {
                    return _super.call(this, sheet, command) || this;
                }
                SheetRenameUndoAction.prototype.canUndo = function () {
                    return !!this._command._oldName;
                };
                SheetRenameUndoAction.prototype.canExecute = function () {
                    var self = this;
                    var command = self._command;
                    return self._sheet && command.name && command.name !== command._oldName;
                };
                SheetRenameUndoAction.prototype.execute = function () {
                    var self = this;
                    var sheet = self._sheet;
                    var command = self._command;
                    var name = command.name;
                    var succeed = false;
                    if (self.canExecute()) {
                        var oldName = sheet.name();
                        var newName = name;
                        var args = {
                            sheet: sheet,
                            oldValue: oldName,
                            newValue: newName,
                            cancel: false
                        };
                        sheet._trigger(common_1.Events.SheetNameChanging, args);
                        if (args.cancel === false) {
                            command._oldName = oldName;
                            sheet._modelManager.startTransaction();
                            beforeAction(sheet, true);
                            suspendCalcService(sheet);
                            sheet._setNameCore(name);
                            sheetRenameUndoAction_repaint(sheet);
                            var changesKey = Commands._getChangesKey(sheet.name());
                            command[changesKey] = sheet._modelManager.endTransaction();
                            succeed = true;
                            command.sheetName = name;
                            resumeCalcService(sheet, false);
                            afterAction(sheet, true);
                            var argsEdited = {
                                sheet: sheet,
                                oldValue: oldName,
                                newValue: newName
                            };
                            sheet._trigger(common_1.Events.SheetNameChanged, argsEdited);
                        }
                    }
                    return succeed;
                };
                SheetRenameUndoAction.prototype.undo = function () {
                    var self = this;
                    if (self.canUndo()) {
                        var sheet = self._sheet;
                        var command = self._command;
                        var oldName = command.name;
                        var newName = command._oldName;
                        var args = {
                            sheet: sheet,
                            oldValue: oldName,
                            newValue: newName,
                            cancel: false
                        };
                        sheet._trigger(common_1.Events.SheetNameChanging, args);
                        if (args.cancel === false) {
                            beforeAction(sheet, true);
                            suspendCalcService(sheet);
                            var changesKey = Commands._getChangesKey(sheet.name());
                            sheet._modelManager.undo(command[changesKey]);
                            sheetRenameUndoAction_repaint(sheet);
                            command.sheetName = command._oldName;
                            resumeCalcService(sheet, false);
                            afterAction(sheet, true);
                            var argsEdited = {
                                sheet: sheet,
                                oldValue: oldName,
                                newValue: newName
                            };
                            sheet._trigger(common_1.Events.SheetNameChanged, argsEdited);
                            return true;
                        }
                    }
                    return false;
                };
                return SheetRenameUndoAction;
            }(ActionBase));

            var ZoomUndoAction = (function (_super) {
                __extends(ZoomUndoAction, _super);
                function ZoomUndoAction(sheet, command) {
                    return _super.call(this, sheet, command) || this;
                }
                ZoomUndoAction.prototype.canExecute = function () {
                    var self = this;
                    return self._sheet && self._sheet.parent.options.allowUserZoom && self._sheet.zoom() !== self._command.zoomFactor;
                };
                ZoomUndoAction.prototype.execute = function () {
                    var self = this;
                    var command = self._command;
                    var succeed = false;
                    if (self.canExecute()) {
                        var sheet = self._sheet;
                        var modelManager = sheet._modelManager;
                        var newZoomFactor = command.zoomFactor;
                        modelManager.startTransaction();
                        succeed = zoomSheet(sheet, newZoomFactor);
                        modelManager._addEventItem(['zoomChanged', newZoomFactor, command.oldZoomFactor]);
                        var changesKey = Commands._getChangesKey(sheet.name());
                        command[changesKey] = sheet._modelManager.endTransaction();
                    }
                    return succeed;
                };
                ZoomUndoAction.prototype.undo = function () {
                    var sheet = this._sheet;
                    if (this.canUndo()) {
                        if (sheet.isEditing() === true && !sheet.endEdit()) {
                            return false;
                        }
                        sheet.suspendPaint();
                        var changesKey = Commands._getChangesKey(sheet.name());
                        sheet._modelManager.undo(this._command[changesKey]);
                        sheet.resumePaint();
                        return true;
                    }
                };
                return ZoomUndoAction;
            }(ActionBase));
            function zoomSheet(sheet, zoomFactor) {
                if (sheet.isEditing() === true && !sheet.endEdit()) {
                    return false;
                }
                sheet.suspendPaint();
                sheet.zoom(zoomFactor);
                sheet.resumePaint();
                return true;
            }

            var ClearRangeValueUndoAction = (function (_super) {
                __extends(ClearRangeValueUndoAction, _super);
                function ClearRangeValueUndoAction(sheet, command) {
                    return _super.call(this, sheet, command) || this;
                }
                ClearRangeValueUndoAction.prototype.execute = function () {
                    var self = this;
                    if (self.canExecute()) {
                        var sheet = self._sheet;
                        var clearRange = self._command.clearRange;
                        var tableNames = sheet.tables && sheet.tables._completelyContainstables && sheet.tables._completelyContainstables(clearRange.row, clearRange.col, clearRange.rowCount, clearRange.colCount);
                        if (!sheet.isDirtySuspended()) {
                            self._command._changedCells = new ChangedCells(sheet, sheet._getActualRange(clearRange), 1 | 2);
                        }
                        if (tableNames && tableNames.length > 0) {
                            self._command.tableNames = tableNames;
                        }
                        var range = sheet._getActualRange(clearRange);
                        var row = range.row;
                        var col = range.col;
                        var rowCount = getRowCount(range);
                        var colCount = getColCount(range);
                        if (colCount > 0 && rowCount > 0) {
                            sheet._modelManager.startTransaction();
                            beforeAction(sheet);
                            sheet._needCalcEvent = true;
                            sheet._clearCore(row, col, rowCount, colCount, 3, 1, true);
                            afterAction(sheet);
                            sheet._needCalcEvent = false;
                            var changesKey = Commands._getChangesKey(sheet.name());
                            self._command[changesKey] = sheet._modelManager.endTransaction();
                            var changedCells = self._command._changedCells;
                            Commands._raiseRangeDataChanged(sheet, row, col, rowCount, colCount, changedCells ? changedCells._getChangedCells() : [], 2, tableNames);
                        }
                    }
                };
                ClearRangeValueUndoAction.prototype.canExecute = function () {
                    var range = this._command.clearRange;
                    return this._sheet._canChange(range.row, range.col, getRowCount(range), getColCount(range));
                };
                ClearRangeValueUndoAction.prototype.canUndo = function () {
                    var changesKey = Commands._getChangesKey(this._sheet.name());
                    var changes = this._command[changesKey];
                    return Commands._isNotEmptyChanges(changes);
                };
                ClearRangeValueUndoAction.prototype.undo = function () {
                    var self = this;
                    var sheet = self._sheet;
                    if (self.canUndo() && sheet) {
                        var range = sheet._getActualRange(self._command.clearRange);
                        if (getColCount(range) > 0 && getRowCount(range) > 0) {
                            beforeAction(sheet);
                            try {
                                var changesKey = Commands._getChangesKey(sheet.name());
                                sheet._modelManager.undo(self._command[changesKey]);
                            } finally {
                                afterAction(sheet);
                            }
                            var changedCells = self._command._changedCells;
                            Commands._raiseRangeDataChanged(sheet, range.row, range.col, getRowCount(range), getColCount(range), changedCells ? changedCells._getChangedCells() : [], 2, self._command.tableNames, true);
                            return true;
                        }
                    }
                    return false;
                };
                return ClearRangeValueUndoAction;
            }(ActionBase));
            var ClearValueUndoAction = (function (_super) {
                __extends(ClearValueUndoAction, _super);
                function ClearValueUndoAction(sheet, command, undo) {
                    var _this_1 = _super.call(this, sheet, command) || this;
                    if (!undo) {
                        command._cachedActions = [];
                        var ranges = command.ranges;
                        if (ranges && ranges.length > 0) {
                            for (var i = 0; i < ranges.length; i++) {
                                command._cachedActions[i] = new ClearRangeValueUndoAction(sheet, { clearRange: ranges[i] });
                            }
                        }
                    }
                    return _this_1;
                }
                ClearValueUndoAction.prototype.canExecute = function () {
                    var cachedActions = this._command._cachedActions;
                    if (cachedActions) {
                        for (var i = 0; i < cachedActions.length; i++) {
                            var item = cachedActions[i];
                            if (!item.canExecute()) {
                                return false;
                            }
                        }
                        return true;
                    }
                    return false;
                };
                ClearValueUndoAction.prototype.execute = function () {
                    var self = this;
                    if (self.canExecute()) {
                        var cachedActions = self._command._cachedActions;
                        var sheet = self._sheet;
                        if (cachedActions) {
                            beforeAction(sheet, true);
                            for (var i = 0; i < cachedActions.length; i++) {
                                var item = cachedActions[i];
                                item.execute();
                            }
                            afterAction(sheet, true);
                            return true;
                        }
                    }
                    return false;
                };
                ClearValueUndoAction.prototype.canUndo = function () {
                    var cachedActions = this._command._cachedActions;
                    if (cachedActions) {
                        for (var i = 0; i < cachedActions.length; i++) {
                            var item = cachedActions[i];
                            if (!item.canUndo()) {
                                return false;
                            }
                        }
                        return true;
                    }
                    return false;
                };
                ClearValueUndoAction.prototype.undo = function () {
                    var self = this;
                    var cachedActions = self._command._cachedActions;
                    if (self.canUndo()) {
                        var sheet = self._sheet;
                        for (var i = cachedActions.length - 1; i >= 0; i--) {
                            var action = cachedActions[i];
                            beforeAction(sheet, true);
                            var ret = action.undo();
                            afterAction(sheet, true);
                            if (!ret) {
                                return false;
                            }
                        }
                        return true;
                    }
                    return false;
                };
                return ClearValueUndoAction;
            }(ActionBase));
            Commands._ClearValueUndoAction = ClearValueUndoAction;

            var ClipboardPasteRangeUndoAction = (function (_super) {
                __extends(ClipboardPasteRangeUndoAction, _super);
                function ClipboardPasteRangeUndoAction(sheet, command) {
                    return _super.call(this, sheet, command) || this;
                }
                ClipboardPasteRangeUndoAction._convertPasteOption = function (pasteOption) {
                    var copyOption = 0;
                    if (pasteOption === 0 || pasteOption === 1) {
                        copyOption |= 1;
                    }
                    if (pasteOption === 0 || pasteOption === 2) {
                        copyOption |= 64;
                        copyOption |= 32;
                        copyOption |= 512;
                    }
                    if (pasteOption === 0 || pasteOption === 3) {
                        copyOption |= 2;
                    }
                    if (pasteOption === 0 || pasteOption === 4) {
                        copyOption |= 1;
                        copyOption |= 64;
                        copyOption |= 32;
                    }
                    if (pasteOption === 0 || pasteOption === 5) {
                        copyOption |= 64;
                        copyOption |= 32;
                        copyOption |= 2;
                    }
                    if (pasteOption === 0) {
                        copyOption |= 32;
                        copyOption |= 16;
                        copyOption |= 256;
                        copyOption |= 4;
                        copyOption |= 512;
                        copyOption |= 128;
                        copyOption |= 1024;
                    }
                    return copyOption;
                };
                ClipboardPasteRangeUndoAction.prototype.canExecute = function () {
                    var self = this;
                    var command = self._command;
                    var pasteExtent = command.pasteExtent;
                    var target = pasteExtent.targetRange;
                    var source = pasteExtent.sourceRange;
                    return command.toSheet._canChange(target.row, target.col, getRowCount(target), getColCount(target))
                        && (!pasteExtent.isCutting || command.fromSheet._canChange(source.row, source.col, getRowCount(source), getColCount(source)));
                };
                ClipboardPasteRangeUndoAction.prototype._beforeDataChange = function () {
                    var self = this;
                    var pasteExtent = self._command.pasteExtent;
                    var state = self._command._state = {};
                    var isCutting = pasteExtent.isCutting;
                    var option = ClipboardPasteRangeUndoAction._convertPasteOption(self._command.pasteOption);
                    var fromRange = pasteExtent.sourceRange;
                    var toRange = pasteExtent.targetRange;
                    var fromSheet = self._command.fromSheet;
                    var toSheet = self._command.toSheet;
                    if (fromSheet && fromRange && isCutting && !fromSheet.isDirtySuspended()) {
                        state._savedFromBeforePastedChangedCells = new ChangedCells(fromSheet, fromRange, option);
                    }
                    if (!toSheet.isDirtySuspended()) {
                        state._savedToBeforePastedChangedCells = new ChangedCells(toSheet, toRange, option);
                    }
                };
                ClipboardPasteRangeUndoAction.prototype._pasteRange = function () {
                    return this._command.pasteExtent.targetRange;
                };
                ClipboardPasteRangeUndoAction.prototype._checkInsertErrorRange = function (isCutting, acCell, pasteDataRange, shiftCells, toSheet) {
                    var selectRange = false;
                    var acRow = acCell.row;
                    var acCol = acCell.col;
                    var acRowCount = acCell.rowCount;
                    var acColCount = acCell.colCount;
                    var changePasteDataRangeCol = false;
                    var changePasteDataRangeRow = false;
                    var changePasteDataRangeCols = false;
                    var changePasteDataRangeRows = false;
                    var expantPasteRange = allowExtendPasteRange(toSheet);
                    var moveRangeHaveValue = false;
                    var returnFunc = false;
                    var pasteSkipInvisibleRange = toSheet._getPasteSkipInvisibleRange();
                    var needCheckValueRangeRow;
                    var needCheckValueRangeCol;
                    var needCheckValueRangeRowCount;
                    var needCheckValueRangeColCount;
                    var destRowCount = toSheet.getRowCount();
                    var destColCount = toSheet.getColumnCount();
                    var tempAcRowCount = acRowCount;
                    var tempAcColCount = acColCount;
                    var changePasteDataRangeRowInvisibleCount = 0;
                    var changePasteDataRangeColInvisibleCount = 0;
                    var invisibleRowCountInAcRange = 0;
                    var invisibleColCountInAcRange = 0;
                    if (pasteSkipInvisibleRange) {
                        tempAcRowCount -= toSheet._getActualInvisibleCount(acRow, tempAcRowCount, true);
                        tempAcColCount -= toSheet._getActualInvisibleCount(acCol, tempAcColCount);
                    }
                    if (!isCutting && ((tempAcRowCount % pasteDataRange.rowCount === 0) || (tempAcColCount % pasteDataRange.colCount === 0))) {
                        var tempInvisibleAcColCount = 0;
                        var tempInvisibleAcRowCount = 0;
                        if ((tempAcRowCount % pasteDataRange.rowCount === 0) && (tempAcColCount % pasteDataRange.colCount !== 0)) {
                            acColCount = acCell.colCount = pasteDataRange.colCount;
                            if (pasteSkipInvisibleRange) {
                                tempInvisibleAcColCount = toSheet._getNextInvisibleCount(acCol, acColCount);
                                acColCount += tempInvisibleAcColCount;
                                acCell.colCount = acColCount;
                            }
                        } else if ((tempAcRowCount % pasteDataRange.rowCount !== 0) && (tempAcColCount % pasteDataRange.colCount === 0)) {
                            acRowCount = acCell.rowCount = pasteDataRange.rowCount;
                            if (pasteSkipInvisibleRange) {
                                tempInvisibleAcRowCount = toSheet._getNextInvisibleCount(acRow, acRowCount, true);
                                acRowCount += tempInvisibleAcRowCount;
                                acCell.rowCount = acRowCount;
                            }
                        }
                        selectRange = true;
                        if (shiftCells === core_enum_1.InsertShiftCell.right) {
                            var pasteRangeInstanceCopyDataRange = false;
                            if (acRow <= pasteDataRange.row && acRow + acRowCount >= pasteDataRange.row + pasteDataRange.rowCount) {
                                pasteRangeInstanceCopyDataRange = true;
                            }
                            if (acCol > pasteDataRange.col && acCol <= (pasteDataRange.col + pasteDataRange.colCount - 1) && acRow > pasteDataRange.row && acRow <= (pasteDataRange.row + pasteDataRange.rowCount - 1)) {
                                toSheet._raiseInvalidOperation(1, getSR().Exp_InsertCopiedCutCells);
                                returnFunc = true;
                                return {
                                    returnFunc: returnFunc
                                };
                            }
                            if (!pasteRangeInstanceCopyDataRange && pasteDataRange.intersect(acRow, acCol, acRowCount, toSheet.getColumnCount() - acCol)) {
                                toSheet._raiseInvalidOperation(1, getSR().Exp_InsertCopiedCutCells);
                                returnFunc = true;
                                return {
                                    returnFunc: returnFunc
                                };
                            }
                            if (this._isRightIntersectTableSpan(toSheet, acRow, acCol, acRowCount, toSheet.getColumnCount() - acCol)) {
                                toSheet._raiseInvalidOperation(1, getSR().Exp_InsertCopiedCutCellsOnSpanTable);
                                returnFunc = true;
                                return {
                                    returnFunc: returnFunc
                                };
                            }
                            if (pasteRangeInstanceCopyDataRange && acCol <= pasteDataRange.col) {
                                if (pasteSkipInvisibleRange) {
                                    pasteDataRange.col += acColCount;
                                    pasteDataRange.col = toSheet._getNextVisualColumn(pasteDataRange.col - 1);
                                    changePasteDataRangeColInvisibleCount = toSheet._getNextInvisibleCount(pasteDataRange.col, acColCount);
                                    pasteDataRange.colCount += changePasteDataRangeColInvisibleCount;
                                } else {
                                    pasteDataRange.col += acColCount;
                                }
                                changePasteDataRangeCols = true;
                            }
                            needCheckValueRangeRow = acRow;
                            needCheckValueRangeRowCount = acRowCount;
                            needCheckValueRangeCol = toSheet.getColumnCount() - acColCount;
                            needCheckValueRangeColCount = acColCount;
                            if (pasteSkipInvisibleRange) {
                                invisibleColCountInAcRange = toSheet._getPrevInvisibleCount(destColCount - 1, acColCount);
                                needCheckValueRangeColCount = acColCount + invisibleColCountInAcRange + tempInvisibleAcColCount;
                                needCheckValueRangeCol = destColCount - needCheckValueRangeColCount;
                            }
                            moveRangeHaveValue = this._rangeHaveValue(toSheet, needCheckValueRangeRow, needCheckValueRangeCol, needCheckValueRangeRowCount, needCheckValueRangeColCount);
                            if (moveRangeHaveValue && !expantPasteRange) {
                                toSheet._raiseInvalidOperation(1, getSR().Exp_InsertCopiedCutCellsNoRange);
                                returnFunc = true;
                                return {
                                    returnFunc: returnFunc
                                };
                            }
                        } else if (shiftCells === core_enum_1.InsertShiftCell.down) {
                            var pasteRangeInstanceCopyDataRange = false;
                            if (acCol <= pasteDataRange.col && acCol + acColCount >= pasteDataRange.col + pasteDataRange.colCount) {
                                pasteRangeInstanceCopyDataRange = true;
                            }
                            if (acRow > pasteDataRange.row && acRow <= (pasteDataRange.row + pasteDataRange.rowCount - 1) && acCol > pasteDataRange.col && acCol <= (pasteDataRange.col + pasteDataRange.colCount - 1)) {
                                toSheet._raiseInvalidOperation(1, getSR().Exp_InsertCopiedCutCells);
                                returnFunc = true;
                                return {
                                    returnFunc: returnFunc
                                };
                            }
                            if (!pasteRangeInstanceCopyDataRange && pasteDataRange.intersect(acRow, acCol, toSheet.getRowCount() - acRow, acColCount)) {
                                toSheet._raiseInvalidOperation(1, getSR().Exp_InsertCopiedCutCells);
                                returnFunc = true;
                                return {
                                    returnFunc: returnFunc
                                };
                            }
                            if (this._isDownIntersectTableSpan(toSheet, acRow, acCol, toSheet.getRowCount() - acRow, acColCount)) {
                                toSheet._raiseInvalidOperation(1, getSR().Exp_InsertCopiedCutCellsOnSpanTable);
                                returnFunc = true;
                                return {
                                    returnFunc: returnFunc
                                };
                            }
                            if (pasteRangeInstanceCopyDataRange && acRow <= pasteDataRange.row) {
                                if (pasteSkipInvisibleRange) {
                                    pasteDataRange.row += acRowCount;
                                    pasteDataRange.row = toSheet._getNextVisualRow(pasteDataRange.row - 1);
                                    changePasteDataRangeRowInvisibleCount = toSheet._getNextInvisibleCount(pasteDataRange.row, acRowCount, true);
                                    pasteDataRange.rowCount += changePasteDataRangeRowInvisibleCount;
                                } else {
                                    pasteDataRange.row += acRowCount;
                                }
                                changePasteDataRangeRows = true;
                            }
                            needCheckValueRangeRow = toSheet.getRowCount() - acRowCount;
                            needCheckValueRangeRowCount = acRowCount;
                            needCheckValueRangeCol = acCol;
                            needCheckValueRangeColCount = acColCount;
                            if (pasteSkipInvisibleRange) {
                                invisibleRowCountInAcRange = toSheet._getPrevInvisibleCount(destRowCount - 1, acRowCount, true);
                                needCheckValueRangeRowCount = acRowCount + invisibleRowCountInAcRange + tempInvisibleAcRowCount;
                                needCheckValueRangeRow = destRowCount - needCheckValueRangeRowCount;
                            }
                            moveRangeHaveValue = this._rangeHaveValue(toSheet, needCheckValueRangeRow, needCheckValueRangeCol, needCheckValueRangeRowCount, needCheckValueRangeColCount);
                            if (moveRangeHaveValue && !expantPasteRange) {
                                toSheet._raiseInvalidOperation(1, getSR().Exp_InsertCopiedCutCellsNoRange);
                                returnFunc = true;
                                return {
                                    returnFunc: returnFunc
                                };
                            }
                        }
                    } else {
                        if (shiftCells === core_enum_1.InsertShiftCell.right) {
                            var tempRowCount = pasteDataRange.rowCount;
                            var invisibleRowCount = void 0;
                            needCheckValueRangeRow = acRow;
                            needCheckValueRangeRowCount = pasteDataRange.rowCount;
                            if (pasteSkipInvisibleRange) {
                                invisibleRowCount = toSheet._getNextInvisibleCount(acRow, tempRowCount);
                                tempRowCount += invisibleRowCount;
                                needCheckValueRangeRowCount += invisibleRowCount;
                            }
                            if (acRow !== pasteDataRange.row && pasteDataRange.intersect(acRow, acCol, tempRowCount, toSheet.getColumnCount() - acCol)) {
                                toSheet._raiseInvalidOperation(1, getSR().Exp_InsertCopiedCutCells);
                                returnFunc = true;
                                return {
                                    returnFunc: returnFunc
                                };
                            }
                            if (acCol > pasteDataRange.col && acCol <= (pasteDataRange.col + pasteDataRange.colCount - 1) && acRow > pasteDataRange.row && acRow <= (pasteDataRange.row + pasteDataRange.rowCount - 1)) {
                                toSheet._raiseInvalidOperation(1, getSR().Exp_InsertCopiedCutCells);
                                returnFunc = true;
                                return {
                                    returnFunc: returnFunc
                                };
                            }
                            if (this._isRightIntersectTableSpan(toSheet, acRow, acCol, tempRowCount, toSheet.getColumnCount() - acCol)) {
                                toSheet._raiseInvalidOperation(1, getSR().Exp_InsertCopiedCutCellsOnSpanTable);
                                returnFunc = true;
                                return {
                                    returnFunc: returnFunc
                                };
                            }
                            if (acRow === pasteDataRange.row && acCol <= pasteDataRange.col) {
                                if (pasteSkipInvisibleRange) {
                                    pasteDataRange.col += pasteDataRange.colCount;
                                    pasteDataRange.col = toSheet._getNextVisualColumn(pasteDataRange.col - 1);
                                    changePasteDataRangeColInvisibleCount = toSheet._getNextInvisibleCount(pasteDataRange.col, pasteDataRange.colCount);
                                    pasteDataRange.colCount += changePasteDataRangeColInvisibleCount;
                                } else {
                                    pasteDataRange.col = pasteDataRange.col + pasteDataRange.colCount;
                                }
                                changePasteDataRangeCol = true;
                            }
                            needCheckValueRangeCol = toSheet.getColumnCount() - pasteDataRange.colCount;
                            needCheckValueRangeColCount = pasteDataRange.colCount;
                            if (pasteSkipInvisibleRange) {
                                invisibleColCountInAcRange = toSheet._getNextInvisibleCount(acCol, pasteDataRange.colCount);
                                var tempInvisibleColCount = pasteDataRange.colCount + invisibleColCountInAcRange;
                                needCheckValueRangeColCount = tempInvisibleColCount + toSheet._getPrevInvisibleCount(destColCount - 1, tempInvisibleColCount);
                                needCheckValueRangeCol = destColCount - needCheckValueRangeColCount;
                                if (changePasteDataRangeCol) {
                                    pasteDataRange.col += invisibleColCountInAcRange;
                                }
                            }
                            moveRangeHaveValue = this._rangeHaveValue(toSheet, needCheckValueRangeRow, needCheckValueRangeCol, needCheckValueRangeRowCount, needCheckValueRangeColCount);
                            if (moveRangeHaveValue && !expantPasteRange) {
                                toSheet._raiseInvalidOperation(1, getSR().Exp_InsertCopiedCutCellsNoRange);
                                returnFunc = true;
                                return { returnFunc: returnFunc };
                            }
                        } else if (shiftCells === core_enum_1.InsertShiftCell.down) {
                            var tempColumnCount = pasteDataRange.colCount;
                            var invisibleColCount = void 0;
                            needCheckValueRangeCol = acCol;
                            needCheckValueRangeColCount = pasteDataRange.colCount;
                            if (pasteSkipInvisibleRange) {
                                invisibleColCount = toSheet._getNextInvisibleCount(acCol, tempColumnCount);
                                tempColumnCount += invisibleColCount;
                                needCheckValueRangeColCount += invisibleColCount;
                            }
                            if (acCol !== pasteDataRange.col && pasteDataRange.intersect(acRow, acCol, toSheet.getRowCount() - acRow, tempColumnCount)) {
                                toSheet._raiseInvalidOperation(1, getSR().Exp_InsertCopiedCutCells);
                                returnFunc = true;
                                return {
                                    returnFunc: returnFunc
                                };
                            }
                            if (acRow > pasteDataRange.row && acRow <= (pasteDataRange.row + pasteDataRange.rowCount - 1) && acCol > pasteDataRange.col && acCol <= (pasteDataRange.col + pasteDataRange.colCount - 1)) {
                                toSheet._raiseInvalidOperation(1, getSR().Exp_InsertCopiedCutCells);
                                returnFunc = true;
                                return {
                                    returnFunc: returnFunc
                                };
                            }
                            if (this._isDownIntersectTableSpan(toSheet, acRow, acCol, toSheet.getRowCount() - acRow, tempColumnCount)) {
                                toSheet._raiseInvalidOperation(1, getSR().Exp_InsertCopiedCutCellsOnSpanTable);
                                returnFunc = true;
                                return {
                                    returnFunc: returnFunc
                                };
                            }
                            if (acCol === pasteDataRange.col && acRow <= pasteDataRange.row) {
                                if (pasteSkipInvisibleRange) {
                                    pasteDataRange.row = pasteDataRange.row + pasteDataRange.rowCount;
                                    pasteDataRange.row = toSheet._getNextVisualRow(pasteDataRange.row - 1);
                                    changePasteDataRangeRowInvisibleCount = toSheet._getNextInvisibleCount(pasteDataRange.row, pasteDataRange.rowCount, true);
                                    pasteDataRange.rowCount += changePasteDataRangeRowInvisibleCount;
                                } else {
                                    pasteDataRange.row = pasteDataRange.row + pasteDataRange.rowCount;
                                }
                                changePasteDataRangeRow = true;
                            }
                            needCheckValueRangeRow = destRowCount - pasteDataRange.rowCount;
                            needCheckValueRangeRowCount = pasteDataRange.rowCount;
                            if (pasteSkipInvisibleRange) {
                                invisibleRowCountInAcRange = toSheet._getNextInvisibleCount(acRow, pasteDataRange.rowCount, true);
                                var tempInvisibleRowCount = pasteDataRange.rowCount + invisibleRowCountInAcRange;
                                needCheckValueRangeRowCount = tempInvisibleRowCount + toSheet._getPrevInvisibleCount(destRowCount - 1, tempInvisibleRowCount, true);
                                needCheckValueRangeRow = destRowCount - needCheckValueRangeRowCount;
                                if (changePasteDataRangeRow) {
                                    pasteDataRange.row += invisibleRowCountInAcRange;
                                }
                            }
                            moveRangeHaveValue = this._rangeHaveValue(toSheet, needCheckValueRangeRow, needCheckValueRangeCol, needCheckValueRangeRowCount, needCheckValueRangeColCount);
                            if (moveRangeHaveValue && !expantPasteRange) {
                                toSheet._raiseInvalidOperation(1, getSR().Exp_InsertCopiedCutCellsNoRange);
                                returnFunc = true;
                                return {
                                    returnFunc: returnFunc
                                };
                            }
                        }
                    }
                    return {
                        changePasteDataRangeCol: changePasteDataRangeCol,
                        changePasteDataRangeRow: changePasteDataRangeRow,
                        changePasteDataRangeCols: changePasteDataRangeCols,
                        changePasteDataRangeRows: changePasteDataRangeRows,
                        moveRangeHaveValue: moveRangeHaveValue,
                        returnFunc: returnFunc,
                        selectRange: selectRange,
                        changePasteDataRangeRowInvisibleCount: changePasteDataRangeRowInvisibleCount,
                        changePasteDataRangeColInvisibleCount: changePasteDataRangeColInvisibleCount,
                        invisibleRowCountInAcRange: invisibleRowCountInAcRange,
                        invisibleColCountInAcRange: invisibleColCountInAcRange
                    };
                };
                ClipboardPasteRangeUndoAction.prototype._insertCellsMoveRange = function (selectRange, shiftCells, toSheet, acCell, pasteDataRange, acRow, acCol, acRowCount, acColCount) {
                    var raiseInvalidOperation = false;
                    var returnFunc = false;
                    var pasteSkipInvisibleRange = toSheet._getPasteSkipInvisibleRange();
                    if (selectRange) {
                        if (shiftCells === core_enum_1.InsertShiftCell.right) {
                            if (toSheet._checkArrayFormula(acRow, acCol + acColCount, acRowCount, toSheet.getColumnCount() - acCol - acColCount, true)) {
                                if (acCol + acColCount < toSheet.getColumnCount()) {
                                    if (pasteSkipInvisibleRange) {
                                        var tempAcRowCount = acRowCount;
                                        var tempNeedMoveRangeColCount = acColCount + toSheet._getPrevInvisibleCount(toSheet.getColumnCount() - 1, acColCount);
                                        if (acRow < 0) {
                                            toSheet.moveTo(acRow, acCol, acRow, acCol + acColCount, acRowCount, toSheet.getColumnCount() - acCol - acColCount, 1023, true);
                                        } else {
                                            for (var r = acRow; r < acRow + tempAcRowCount && r < toSheet.getRowCount(); r++) {
                                                if (toSheet.getRowHeight(r) === 0) {
                                                    continue;
                                                }
                                                toSheet.moveTo(r, acCol, r, acCol + acColCount, 1, toSheet.getColumnCount() - acCol - tempNeedMoveRangeColCount, 1023, true);
                                            }
                                        }
                                    } else {
                                        toSheet.moveTo(acRow, acCol, acRow, acCol + acColCount, acRowCount, toSheet.getColumnCount() - acCol - acColCount, 1023, true);
                                    }
                                    var rowfilter = toSheet.rowFilter();
                                    var filterRange = rowfilter && rowfilter.range;
                                    if (filterRange && acRow === -1 && filterRange.colCount > 1 && acCol > filterRange.col && acCol <= (filterRange.col + filterRange.colCount - 1)) {
                                        filterRange.colCount = filterRange.colCount + pasteDataRange.colCount;
                                    }
                                } else if (acCol + acColCount > toSheet.getColumnCount()) {
                                    raiseInvalidOperation = true;
                                    returnFunc = true;
                                }
                            } else {
                                raiseInvalidOperation = true;
                                returnFunc = true;
                            }
                        } else if (shiftCells === core_enum_1.InsertShiftCell.down) {
                            if (toSheet._checkArrayFormula(acRow + acRowCount, acCol, toSheet.getRowCount() - acRow - acRowCount, acColCount, true)) {
                                if (acRow + acRowCount < toSheet.getRowCount()) {
                                    if (pasteSkipInvisibleRange) {
                                        var tempAcColCount = acColCount;
                                        var tempNeedMoveRangeRowCount = acRowCount + toSheet._getPrevInvisibleCount(toSheet.getRowCount() - 1, acRowCount, true);
                                        if (acCol < 0) {
                                            toSheet.moveTo(acRow, acCol, acRow + acRowCount, acCol, toSheet.getRowCount() - acRow - tempNeedMoveRangeRowCount, pasteDataRange.colCount, 1023, true);
                                        } else {
                                            for (var c = acCol; c < acCol + tempAcColCount && c < toSheet.getColumnCount(); c++) {
                                                if (toSheet.getColumnWidth(c) === 0) {
                                                    continue;
                                                }
                                                toSheet.moveTo(acRow, c, acRow + acRowCount, c, toSheet.getRowCount() - acRow - tempNeedMoveRangeRowCount, 1, 1023, true);
                                            }
                                        }
                                    } else {
                                        toSheet.moveTo(acRow, acCol, acRow + acRowCount, acCol, toSheet.getRowCount() - acRow - acRowCount, acColCount, 1023, true);
                                    }
                                } else if (acRow + acRowCount > toSheet.getRowCount()) {
                                    raiseInvalidOperation = true;
                                    returnFunc = true;
                                }
                            } else {
                                raiseInvalidOperation = true;
                                returnFunc = true;
                            }
                        }
                    } else {
                        if (shiftCells === core_enum_1.InsertShiftCell.right) {
                            if (toSheet._checkArrayFormula(acRow, acCol + pasteDataRange.colCount, pasteDataRange.rowCount, toSheet.getColumnCount() - acCol - pasteDataRange.colCount, true)) {
                                if (acCol + pasteDataRange.colCount < toSheet.getColumnCount()) {
                                    if (pasteSkipInvisibleRange) {
                                        var pasteRowCount = pasteDataRange.rowCount;
                                        var tempPasteColCount = pasteDataRange.colCount + toSheet._getNextInvisibleCount(acCol, pasteDataRange.colCount);
                                        var tempNeedMoveRangeColCount = tempPasteColCount + toSheet._getPrevInvisibleCount(toSheet.getColumnCount() - 1, tempPasteColCount);
                                        if (acRow < 0) {
                                            toSheet.moveTo(acRow, acCol, acRow, acCol + tempPasteColCount, pasteDataRange.rowCount, toSheet.getColumnCount() - acCol - tempNeedMoveRangeColCount, 1023, true);
                                        } else {
                                            for (var r = acRow; r < acRow + pasteRowCount && r < toSheet.getRowCount(); r++) {
                                                if (toSheet.getRowHeight(r) === 0) {
                                                    pasteRowCount++;
                                                    continue;
                                                }
                                                toSheet.moveTo(r, acCol, r, acCol + tempPasteColCount, 1, toSheet.getColumnCount() - acCol - tempNeedMoveRangeColCount, 1023, true);
                                            }
                                        }
                                    } else {
                                        toSheet.moveTo(acRow, acCol, acRow, acCol + pasteDataRange.colCount, pasteDataRange.rowCount, toSheet.getColumnCount() - acCol - pasteDataRange.colCount, 1023, true);
                                    }
                                    var rowfilter = toSheet.rowFilter();
                                    var filterRange = rowfilter && rowfilter.range;
                                    if (filterRange && acRow === -1 && filterRange.colCount > 1 && acCol > filterRange.col && acCol <= (filterRange.col + filterRange.colCount - 1)) {
                                        filterRange.colCount = filterRange.colCount + pasteDataRange.colCount;
                                    }
                                } else if (acCol + pasteDataRange.colCount > toSheet.getColumnCount()) {
                                    raiseInvalidOperation = true;
                                    returnFunc = true;
                                }
                            } else {
                                raiseInvalidOperation = true;
                                returnFunc = true;
                            }
                        } else if (shiftCells === core_enum_1.InsertShiftCell.down) {
                            if (toSheet._checkArrayFormula(acRow + pasteDataRange.rowCount, acCol, toSheet.getRowCount() - acRow - pasteDataRange.rowCount, pasteDataRange.colCount, true)) {
                                if (acRow + pasteDataRange.rowCount < toSheet.getRowCount()) {
                                    if (pasteSkipInvisibleRange) {
                                        var pasteColCount = pasteDataRange.colCount;
                                        var tempPasteRowCount = pasteDataRange.rowCount + toSheet._getNextInvisibleCount(acRow, pasteDataRange.rowCount, true);
                                        var tempNeedMoveRangeRowCount = tempPasteRowCount + toSheet._getPrevInvisibleCount(toSheet.getRowCount() - 1, tempPasteRowCount, true);
                                        if (acCol < 0) {
                                            toSheet.moveTo(acRow, acCol, acRow + tempPasteRowCount, acCol, toSheet.getRowCount() - acRow - tempNeedMoveRangeRowCount, pasteDataRange.colCount, 1023, true);
                                        } else {
                                            for (var c = acCol; c < acCol + pasteColCount && c < toSheet.getColumnCount(); c++) {
                                                if (toSheet.getColumnWidth(c) === 0) {
                                                    pasteColCount++;
                                                    continue;
                                                }
                                                toSheet.moveTo(acRow, c, acRow + tempPasteRowCount, c, toSheet.getRowCount() - acRow - tempNeedMoveRangeRowCount, 1, 1023, true);
                                            }
                                        }
                                    } else {
                                        toSheet.moveTo(acRow, acCol, acRow + pasteDataRange.rowCount, acCol, toSheet.getRowCount() - acRow - pasteDataRange.rowCount, pasteDataRange.colCount, 1023, true);
                                    }
                                } else if (acRow + pasteDataRange.rowCount > toSheet.getRowCount()) {
                                    raiseInvalidOperation = true;
                                    returnFunc = true;
                                }
                            } else {
                                raiseInvalidOperation = true;
                                returnFunc = true;
                            }
                        }
                    }
                    return {
                        raiseInvalidOperation: raiseInvalidOperation,
                        returnFunc: returnFunc
                    };
                };
                ClipboardPasteRangeUndoAction.prototype._adjustFromRange = function (changePasteDataRangeCol, pasteDataRange, changePasteDataRangeRow, changePasteDataRangeCols, changePasteDataRangeRows, acColCount, acRowCount, adjustRange) {
                    var changePasteDataRangeRowInvisibleCount = adjustRange.changePasteDataRangeRowInvisibleCount;
                    var changePasteDataRangeColInvisibleCount = adjustRange.changePasteDataRangeColInvisibleCount;
                    var invisibleRowCountInAcRange = adjustRange.invisibleRowCountInAcRange;
                    var invisibleColCountInAcRange = adjustRange.invisibleColCountInAcRange;
                    var targetRange = this._command.pasteExtent.targetRange;
                    if (changePasteDataRangeCol) {
                        pasteDataRange.colCount -= changePasteDataRangeColInvisibleCount;
                        pasteDataRange.col -= pasteDataRange.colCount;
                        pasteDataRange.col -= invisibleColCountInAcRange;
                        targetRange.colCount -= changePasteDataRangeColInvisibleCount;
                    }
                    if (changePasteDataRangeRow) {
                        pasteDataRange.rowCount -= changePasteDataRangeRowInvisibleCount;
                        pasteDataRange.row -= pasteDataRange.rowCount;
                        pasteDataRange.row -= invisibleRowCountInAcRange;
                        targetRange.rowCount -= changePasteDataRangeRowInvisibleCount;
                    }
                    if (changePasteDataRangeCols) {
                        pasteDataRange.colCount -= changePasteDataRangeColInvisibleCount;
                        pasteDataRange.col -= acColCount;
                        pasteDataRange.col -= invisibleColCountInAcRange;
                        targetRange.colCount -= changePasteDataRangeColInvisibleCount;
                    }
                    if (changePasteDataRangeRows) {
                        pasteDataRange.rowCount -= changePasteDataRangeRowInvisibleCount;
                        pasteDataRange.row -= acRowCount;
                        pasteDataRange.row -= invisibleRowCountInAcRange;
                        targetRange.rowCount -= changePasteDataRangeRowInvisibleCount;
                    }
                    adjustRange.changePasteDataRangeRowInvisibleCount = 0;
                    adjustRange.changePasteDataRangeColInvisibleCount = 0;
                    adjustRange.invisibleRowCountInAcRange = 0;
                    adjustRange.invisibleColCountInAcRange = 0;
                };
                ClipboardPasteRangeUndoAction.prototype._getSheets = function (fromSheet, toSheet) {
                    var sheets = [].concat(toSheet.parent.sheets);
                    if (fromSheet && fromSheet._parentSheet) {
                        sheets.push(fromSheet);
                    }
                    if (toSheet && toSheet !== fromSheet && toSheet._parentSheet) {
                        sheets.push(toSheet);
                    }
                    return sheets;
                };
                ClipboardPasteRangeUndoAction.prototype.execute = function () {
                    var self = this;
                    if (self.canExecute()) {
                        var fromSheet = self._command.fromSheet;
                        var toSheet = self._command.toSheet;
                        var pasteExtent = self._command.pasteExtent;
                        var pasteOption = self._command.pasteOption;
                        var fromRange = pasteExtent.sourceRange;
                        var toRange = pasteExtent.targetRange;
                        var isCutting = pasteExtent.isCutting;
                        if (fromSheet && fromRange && !fromSheet._isValidRange(fromRange.row, fromRange.col, getRowCount(fromRange), getColCount(fromRange), getSheetRowCount(fromSheet), getSheetColumnCount(fromSheet))) {
                            return;
                        }
                        if (!(toSheet && toRange && toSheet._isValidPasteRange(toRange.row, toRange.col, getRowCount(toRange), getColCount(toRange), true))) {
                            return;
                        }
                        if (toSheet.tables && toSheet.tables._isTableIntersect(fromSheet, fromRange, toSheet, toRange, isCutting)) {
                            return;
                        }
                        if (toSheet.pivotTables && toSheet.pivotTables._isRangeOverlapPTOrValue(fromRange, toRange, toSheet)) {
                            return;
                        }
                        var shiftCells = void 0;
                        var pasteDataRange = void 0;
                        var clipboardHelper = void 0;
                        var oldPasteDataRange = void 0;
                        if (fromSheet) {
                            clipboardHelper = fromSheet._getClipboardHelper();
                            shiftCells = self._shiftCells;
                            pasteDataRange = self._dataRange;
                            oldPasteDataRange = pasteDataRange && new common_1.Range(pasteDataRange.row, pasteDataRange.col, pasteDataRange.rowCount, pasteDataRange.colCount);
                        }
                        var acRow = void 0;
                        var acCol = void 0;
                        var acRowCount = void 0;
                        var acColCount = void 0;
                        var selectRange = void 0;
                        if (self._acCell) {
                            acRow = self._acCell.row;
                            acCol = self._acCell.col;
                            acRowCount = self._acCell.rowCount;
                            acColCount = self._acCell.colCount;
                        }
                        var changePasteDataRangeCol = false;
                        var changePasteDataRangeRow = false;
                        var changePasteDataRangeCols = false;
                        var changePasteDataRangeRows = false;
                        var expantPasteRange = allowExtendPasteRange(toSheet);
                        var moveRangeHaveValue = false;
                        var changePasteDataRangeRowInvisibleCount = 0;
                        var changePasteDataRangeColInvisibleCount = 0;
                        var invisibleRowCountInAcRange = 0;
                        var invisibleColCountInAcRange = 0;
                        if (shiftCells !== keyword_undefined && pasteDataRange) {
                            var checkObj = this._checkInsertErrorRange(isCutting, self._acCell, pasteDataRange, shiftCells, toSheet);
                            if (checkObj.returnFunc) {
                                return;
                            }
                            changePasteDataRangeCol = checkObj.changePasteDataRangeCol;
                            changePasteDataRangeRow = checkObj.changePasteDataRangeRow;
                            changePasteDataRangeRowInvisibleCount = checkObj.changePasteDataRangeRowInvisibleCount;
                            changePasteDataRangeColInvisibleCount = checkObj.changePasteDataRangeColInvisibleCount;
                            invisibleRowCountInAcRange = checkObj.invisibleRowCountInAcRange;
                            invisibleColCountInAcRange = checkObj.invisibleColCountInAcRange;
                            changePasteDataRangeCols = checkObj.changePasteDataRangeCols;
                            changePasteDataRangeRows = checkObj.changePasteDataRangeRows;
                            moveRangeHaveValue = checkObj.moveRangeHaveValue;
                            selectRange = checkObj.selectRange;
                            acRowCount = self._acCell.rowCount;
                            acColCount = self._acCell.colCount;
                            toRange.rowCount += changePasteDataRangeRowInvisibleCount;
                            toRange.colCount += changePasteDataRangeColInvisibleCount;
                        }
                        self._beforeDataChange();
                        var sheets = self._getSheets(fromSheet, toSheet);
                        Commands._startTransactionAll(sheets);
                        suspendPaint(toSheet);
                        suspendEvent(toSheet);
                        toSheet._needCalcEvent = true;
                        var raiseInvalidOperation = false;
                        if (fromSheet) {
                            suspendEvent(fromSheet);
                            fromSheet._needCalcEvent = true;
                        }
                        try {
                            if (expantPasteRange) {
                                var expectedRowCount = -1;
                                var expectedColCount = -1;
                                if (toRange.row !== -1) {
                                    expectedRowCount = toRange.row + getRowCount(toRange);
                                } else if (fromRange.row === -1) {
                                    expectedRowCount = getSheetRowCount(fromSheet);
                                }
                                var toSheetRowCount = getSheetRowCount(toSheet);
                                var pasteExpandRow = expectedRowCount - toSheetRowCount;
                                if (expectedRowCount > toSheetRowCount && self._canExtendRange(fromRange, toRange)) {
                                    if (shiftCells === core_enum_1.InsertShiftCell.down && moveRangeHaveValue) {
                                        toSheet.addRows(toSheetRowCount, pasteExpandRow + (toSheetRowCount - acRow));
                                    } else {
                                        toSheet.addRows(toSheetRowCount, pasteExpandRow);
                                    }
                                } else if ((!moveRangeHaveValue && (acRow + toRange.rowCount === getSheetRowCount(toSheet))) && shiftCells === core_enum_1.InsertShiftCell.down) {
                                    toSheet.addRows(toSheetRowCount, pasteExpandRow + (toSheetRowCount - acRow) - oldPasteDataRange.rowCount);
                                } else if (moveRangeHaveValue && shiftCells === core_enum_1.InsertShiftCell.down) {
                                    toSheet.addRows(toSheetRowCount, pasteExpandRow + (toSheetRowCount - acRow));
                                }
                                if (toRange.col !== -1) {
                                    expectedColCount = toRange.col + getColCount(toRange);
                                } else if (fromRange.col === -1) {
                                    expectedColCount = getSheetColumnCount(fromSheet);
                                }
                                if (expectedColCount > getSheetColumnCount(toSheet) && self._canExtendRange(fromRange, toRange)) {
                                    if (shiftCells === core_enum_1.InsertShiftCell.right && moveRangeHaveValue) {
                                        toSheet.setColumnCount(expectedColCount + toSheet.getColumnCount() - acCol);
                                    } else {
                                        toSheet.setColumnCount(expectedColCount);
                                    }
                                } else if ((!moveRangeHaveValue && (acCol + toRange.colCount === getSheetColumnCount(toSheet))) && shiftCells === core_enum_1.InsertShiftCell.right) {
                                    toSheet.setColumnCount(expectedColCount + toSheet.getColumnCount() - acCol - oldPasteDataRange.colCount);
                                } else if (moveRangeHaveValue && shiftCells === core_enum_1.InsertShiftCell.right) {
                                    toSheet.setColumnCount(expectedColCount + toSheet.getColumnCount() - acCol);
                                }
                            }
                            var checkMoveRangeObj = (shiftCells !== keyword_undefined) && this._insertCellsMoveRange(selectRange, shiftCells, toSheet, self._acCell, oldPasteDataRange, acRow, acCol, acRowCount, acColCount);
                            raiseInvalidOperation = checkMoveRangeObj.raiseInvalidOperation;
                            if (checkMoveRangeObj.returnFunc) {
                                return;
                            }
                            if (fromRange) {
                                common_1._CacheMgr._startCache(fromSheet, fromRange.row, fromRange.col, fromRange.row + getRowCount(fromRange) - 1, fromRange.col + getColCount(fromRange) - 1);
                            }
                            try {
                                var moveRangehavevalueflag = false;
                                if (fromSheet) {
                                    for (var i = fromRange.row; i < fromRange.row + fromRange.rowCount; i++) {
                                        if (moveRangehavevalueflag) {
                                            break;
                                        }
                                        for (var j = fromRange.col; j < fromRange.col + fromRange.colCount; j++) {
                                            if (fromSheet.getValue(i, j)) {
                                                moveRangehavevalueflag = true;
                                                break;
                                            }
                                        }
                                    }
                                }
                                if (toSheet.tables && (moveRangehavevalueflag || pasteExtent.clipboardText.replace(/[\r\n\t]/gi, ''))) {
                                    toSheet.tables._changeValueBesideTable(toRange, fromRange);
                                }
                            } catch (e) {
                                toSheet._raiseInvalidOperation(6, e.message);
                                toSheet.resumePaint();
                                return;
                            }
                            toSheet._clipboardPaste(fromSheet, fromRange, toSheet, toRange, isCutting, pasteExtent.clipboardText, pasteExtent.clipboardHtml, pasteExtent.clipboardImage, pasteOption, !pasteExtent.includeFilteredOutRow);
                            if (isCutting && shiftCells !== keyword_undefined) {
                                var fromRow = fromRange.row;
                                var fromCol = fromRange.col;
                                var fromRowCount = fromRange.rowCount;
                                var fromColCount = fromRange.colCount;
                                var toRow = toRange.row;
                                var toCol = toRange.col;
                                var toRowCount = toRange.rowCount;
                                var toColCount = toRange.colCount;
                                if (shiftCells === core_enum_1.InsertShiftCell.right && fromRange.row === toRange.row) {
                                    fromSheet.moveTo(fromRow, fromCol + fromColCount, toRow, fromCol, fromRowCount, toSheet.getColumnCount() - fromCol - fromColCount, 1023, true);
                                }
                                if (shiftCells === core_enum_1.InsertShiftCell.down && fromRange.col === toRange.col) {
                                    fromSheet.moveTo(fromRow + fromRowCount, fromCol, fromRow, toCol, toSheet.getRowCount() - fromRow - fromRowCount, fromColCount, 1023, true);
                                }
                            }
                        } finally {
                            if (fromRange) {
                                common_1._CacheMgr._clearCache();
                            }
                            resumeEvent(toSheet);
                            toSheet._needCalcEvent = false;
                            if (fromSheet) {
                                resumeEvent(fromSheet);
                                fromSheet._needCalcEvent = false;
                            }
                            resumePaint(toSheet);
                            Commands._endTransactionAll(sheets, self._command);
                            var state = self._command._state;
                            var option = ClipboardPasteRangeUndoAction._convertPasteOption(pasteOption);
                            if (pasteExtent.isCutting && fromSheet) {
                                var fromSheetChangeCells = [];
                                if (!fromSheet.isDirtySuspended()) {
                                    var savedFromAfterPastedChangedCells = new ChangedCells(fromSheet, fromRange, option);
                                    savedFromAfterPastedChangedCells._mergeCellsHasDiffData(state._savedFromBeforePastedChangedCells._getCellsData());
                                    state._savedFromAfterPastedChangedCells = savedFromAfterPastedChangedCells;
                                    fromSheetChangeCells = savedFromAfterPastedChangedCells._getChangedCells();
                                }
                                Commands._raiseRangeDataChanged(fromSheet, fromRange.row, fromRange.col, getRowCount(fromRange), getColCount(fromRange), fromSheetChangeCells, 3);
                            }
                            if (toSheet) {
                                var toSheetChangedCells = [];
                                if (!toSheet.isDirtySuspended()) {
                                    var savedToAfterPastedChangedCells = new ChangedCells(toSheet, toRange, option);
                                    savedToAfterPastedChangedCells._mergeCellsHasDiffData(state._savedToBeforePastedChangedCells._getCellsData());
                                    state._savedToAfterPastedChangedCells = savedToAfterPastedChangedCells;
                                    toSheetChangedCells = savedToAfterPastedChangedCells._getChangedCells();
                                }
                                var tableNames = toSheet.tables && toSheet.tables._completelyContainstables && toSheet.tables._completelyContainstables(toRange.row, toRange.col, toRange.rowCount, toRange.colCount);
                                var rc = getRowCount(toRange);
                                var cc = getColCount(toRange);
                                Commands._raiseRangeDataChanged(toSheet, toRange.row, toRange.col, rc, cc, toSheetChangedCells, 3, tableNames);
                                self.tableNamesObj = {
                                    r: toRange.row,
                                    c: toRange.col,
                                    rc: rc,
                                    cc: cc,
                                    tableNames: tableNames
                                };
                            }
                            self._adjustClipboardRange = {
                                changePasteDataRangeCol: changePasteDataRangeCol, changePasteDataRangeRow: changePasteDataRangeRow, changePasteDataRangeCols: changePasteDataRangeCols, changePasteDataRangeRows: changePasteDataRangeRows, acColCount: acColCount, acRowCount: acRowCount, changePasteDataRangeRowInvisibleCount: changePasteDataRangeRowInvisibleCount, changePasteDataRangeColInvisibleCount: changePasteDataRangeColInvisibleCount, invisibleRowCountInAcRange: invisibleRowCountInAcRange, invisibleColCountInAcRange: invisibleColCountInAcRange
                            };
                            if (clipboardHelper) {
                                delete clipboardHelper._showInsertCopyPasteCells;
                            }
                            if (raiseInvalidOperation) {
                                toSheet._raiseInvalidOperation(1, getSR().Exp_InsertCopiedCutCellsNoRange);
                            }
                        }
                    }
                };
                ClipboardPasteRangeUndoAction.prototype._isRightIntersectTableSpan = function (sheet, row, col, rowCount, colCount) {
                    var span = sheet._modelManager.getSpans();
                    var tables = sheet.tables._tableList;
                    for (var i = 0; i < span.length; i++) {
                        var sp = span[i];
                        if (!((row <= sp.row && col <= sp.col && (row + rowCount >= sp.row + sp.rowCount) && (col + colCount >= sp.col + sp.colCount))
                            || sp.row > (row + rowCount) || (sp.row + sp.rowCount - 1) < row)) {
                            if (!(sp.row > (row + rowCount - 1) || (sp.row + sp.rowCount - 1) < row || (sp.col + sp.colCount - 1) < col)) {
                                return true;
                            }
                        }
                    }
                    for (var i = 0; i < tables.length; i++) {
                        var tb = tables[i];
                        if (!((row <= tb._row && col <= tb._col && (row + rowCount >= tb._row + tb._rowCount) && (col + colCount >= tb._col + tb._colCount))
                            || tb._row > (row + rowCount) || (tb._row + tb._rowCount - 1) < row)) {
                            if (!(tb._row > (row + rowCount - 1) || (tb._row + tb._rowCount - 1) < row || (tb._col + tb._colCount - 1) < col)) {
                                return true;
                            }
                        }
                    }
                    return false;
                };
                ClipboardPasteRangeUndoAction.prototype._isDownIntersectTableSpan = function (sheet, row, col, rowCount, colCount) {
                    var span = sheet._modelManager.getSpans();
                    var tables = sheet.tables._tableList;
                    for (var i = 0; i < span.length; i++) {
                        var sp = span[i];
                        if (!((row <= sp.row && col <= sp.col && (row + rowCount >= sp.row + sp.rowCount) && (col + colCount >= sp.col + sp.colCount))
                            || sp.col > (col + colCount) || (sp.col + sp.colCount - 1) < col)) {
                            if (!(sp.col > (col + colCount - 1) || (sp.col + sp.colCount - 1) < col || (sp.row + sp.rowCount - 1) < row)) {
                                return true;
                            }
                        }
                    }
                    for (var i = 0; i < tables.length; i++) {
                        var tb = tables[i];
                        if (!((row <= tb._row && col <= tb._col && (row + rowCount >= tb._row + tb._rowCount) && (col + colCount >= tb._col + tb._colCount))
                            || tb._col > (col + colCount) || (tb._col + tb._colCount - 1) < col)) {
                            if (!(tb._col > (col + colCount - 1) || (tb._col + tb._colCount - 1) < col || (tb._row + tb._rowCount - 1) < row)) {
                                return true;
                            }
                        }
                    }
                    return false;
                };
                ClipboardPasteRangeUndoAction.prototype._rangeHaveValue = function (sheet, row, col, rowCount, colCount) {
                    var span = sheet._modelManager.getSpans();
                    var tables = sheet.tables._tableList;
                    for (var i = row; i < row + rowCount; i++) {
                        for (var j = col; j < col + colCount; j++) {
                            var cell = sheet.getCell(i, j);
                            if (!isNullOrUndefined(cell.value()) || cell.backColor() || cell.comment() || cell.tag()) {
                                return true;
                            }
                            for (var k = 0; k < span.length; k++) {
                                var sp = span[k];
                                if (i >= sp.row && i <= (sp.row + sp.rowCount - 1) && j >= sp.col && (j <= (sp.col + sp.colCount - 1))) {
                                    return true;
                                }
                            }
                            for (var l = 0; l < tables.length; l++) {
                                var tb = tables[l];
                                if (i >= tb._row && i <= (tb._row + tb._rowCount - 1) && j >= tb._col && (j <= (tb._col + tb._colCount - 1))) {
                                    return true;
                                }
                            }
                        }
                    }
                    return false;
                };
                ClipboardPasteRangeUndoAction.prototype._canExtendRange = function (fromRange, toRange) {
                    if (!fromRange) {
                        return true;
                    }
                    var fromRow = fromRange.row;
                    var fromCol = fromRange.col;
                    var toRow = toRange.row;
                    var toCol = toRange.col;
                    var wholeCol = fromRow === -1 && fromCol !== -1;
                    var wholeRow = fromCol === -1 && fromRow !== -1;
                    var wholeSheet = fromRow === -1 && fromCol === -1;
                    return (fromRow !== -1 && fromCol !== -1)
                        || (wholeCol && toRow <= 0)
                        || (wholeRow && toCol <= 0)
                        || (wholeSheet && toRow <= 0 && toCol <= 0);
                };
                ClipboardPasteRangeUndoAction.prototype.undo = function () {
                    var self = this;
                    if (self.canUndo()) {
                        var fromSheet = self._command.fromSheet;
                        var toSheet = self._command.toSheet;
                        var pasteExtent = self._command.pasteExtent;
                        var fromRange = pasteExtent.sourceRange;
                        var toRange = pasteExtent.targetRange;
                        if (!toSheet || !toRange) {
                            return false;
                        }
                        if (self._adjustClipboardRange) {
                            var adjustRange = self._adjustClipboardRange;
                            this._adjustFromRange(adjustRange.changePasteDataRangeCol, fromRange, adjustRange.changePasteDataRangeRow, adjustRange.changePasteDataRangeCols, adjustRange.changePasteDataRangeRows, adjustRange.acColCount, adjustRange.acRowCount, adjustRange);
                        }
                        if (!toSheet._isValidRange(toRange.row, toRange.col, getRowCount(toRange), getColCount(toRange), getSheetRowCount(toSheet), getSheetColumnCount(toSheet))) {
                            return false;
                        }
                        if (fromSheet && fromRange) {
                            if (!fromSheet._isValidRange(fromRange.row, fromRange.col, getRowCount(fromRange), getColCount(fromRange), getSheetRowCount(fromSheet), getSheetColumnCount(fromSheet))) {
                                return false;
                            }
                            if (fromSheet && fromSheet.name() === toSheet.name() &&
                                (toSheet.parent && !fromSheet._parentSheet && !ArrayHelper_contains(toSheet.parent.sheets, fromSheet))) {
                                return false;
                            }
                        }
                        var state = self._command._state;
                        suspendPaint(toSheet);
                        try {
                            var toRow = toRange.row < 0 ? 0 : toRange.row;
                            var toColumn = toRange.col < 0 ? 0 : toRange.col;
                            var toRowCount = toRange.row < 0 ? getSheetRowCount(toSheet) : getRowCount(toRange);
                            var toColumnCount = toRange.col < 0 ? getSheetColumnCount(toSheet) : getColCount(toRange);
                            var sheets = self._getSheets(fromSheet, toSheet);
                            Commands._undoTransactionAll(sheets, self._command);
                            var rowfilter = toSheet.rowFilter();
                            var filterRange = rowfilter && rowfilter.range;
                            if (filterRange && toRange.row === -1 && filterRange.col < toRange.col && (filterRange.col + filterRange.colCount >= toRange.col + toRange.colCount)) {
                                filterRange.colCount = filterRange.colCount - toRange.colCount;
                            }
                            var fromRow = 0;
                            var fromColumn = 0;
                            var fromRowCount = 0;
                            var fromColumnCount = 0;
                            if (fromSheet && fromRange) {
                                fromRow = fromRange.row < 0 ? 0 : fromRange.row;
                                fromColumn = fromRange.col < 0 ? 0 : fromRange.col;
                                fromRowCount = fromRange.row < 0 ? getSheetRowCount(fromSheet) : getRowCount(fromRange);
                                fromColumnCount = fromRange.col < 0 ? getSheetColumnCount(fromSheet) : getColCount(fromRange);
                            }
                            var afterPastedChangedTableNames = [];
                            var fromPastedChangedTableNames = [];
                            var tableNamesObj = self.tableNamesObj;
                            if (tableNamesObj) {
                                if (toSheet && tableNamesObj.r === toRow && tableNamesObj.c === toColumn && tableNamesObj.rc === toRowCount && tableNamesObj.cc === toColumnCount) {
                                    fromPastedChangedTableNames = tableNamesObj.tableNames;
                                }
                                if (fromSheet && tableNamesObj.r === fromRow && tableNamesObj.c === fromColumn && tableNamesObj.rc === fromRowCount && tableNamesObj.cc === fromColumnCount) {
                                    afterPastedChangedTableNames = tableNamesObj.tableNames;
                                }
                            }
                            if (toSheet) {
                                var toChangedCells = state._savedToAfterPastedChangedCells;
                                Commands._raiseRangeDataChanged(toSheet, toRow, toColumn, toRowCount, toColumnCount, toChangedCells ? toChangedCells._getChangedCells() : [], 3, afterPastedChangedTableNames, true);
                            }
                            if (fromSheet) {
                                var fromChangedCells = state._savedFromAfterPastedChangedCells;
                                Commands._raiseRangeDataChanged(fromSheet, fromRow, fromColumn, fromRowCount, fromColumnCount, fromChangedCells ? fromChangedCells._getChangedCells() : [], 3, fromPastedChangedTableNames, true);
                            }
                        } finally {
                            resumePaint(toSheet);
                        }
                    }
                    return true;
                };
                return ClipboardPasteRangeUndoAction;
            }(ActionBase));
            var ClipboardPasteUndoAction = (function (_super) {
                __extends(ClipboardPasteUndoAction, _super);
                function ClipboardPasteUndoAction(sheet, command, undo) {
                    var _this_1 = _super.call(this, sheet, command) || this;
                    if (!undo) {
                        var destSheet = sheet;
                        var srcSheet = command.fromSheet;
                        if (!destSheet) {
                            throw new Error(getSR().Exp_DestSheetIsNull);
                        }
                        var pasteExtent = command;
                        var pastedRanges = pasteExtent.pastedRanges;
                        var pasteSkipInvisibleRange = destSheet._getPasteSkipInvisibleRange();
                        if (pastedRanges && pastedRanges.length > 0) {
                            command._cachedActions = [];
                            var fromRanges = pasteExtent.fromRanges || [pasteExtent.fromRange];
                            var fromRangesLength = fromRanges.length;
                            var isCutting = pasteExtent.isCutting;
                            var clipboardText = pasteExtent.clipboardText;
                            var clipboardHtml = pasteExtent.clipboardHtml;
                            var clipboardImage = pasteExtent.clipboardImage;
                            var pasteOption = pasteExtent.pasteOption;
                            var outParam = {};
                            var firstPastedRange = pastedRanges[0];
                            if (!isCutting && srcSheet && srcSheet._isValidMultiCopyRanges(fromRanges, outParam) &&
                                firstPastedRange.equals(srcSheet._getPastedRangeForMultiCopy(fromRanges, firstPastedRange))) {
                                var inSameRow = outParam.inSameRow;
                                var inSameCol = outParam.inSameCol;
                                if (inSameRow) {
                                    fromRanges.sort(function (range1, range2) {
                                        return range1.col - range2.col;
                                    });
                                } else if (inSameCol) {
                                    fromRanges.sort(function (range1, range2) {
                                        return range1.row - range2.row;
                                    });
                                }
                                var pastedRangeRow = firstPastedRange.row;
                                var pastedRangeCol = firstPastedRange.col;
                                for (var j = 0; j < fromRangesLength; j++) {
                                    var currentFromRange = fromRanges[j];
                                    var currentFromRangeRowCount = currentFromRange.rowCount;
                                    var currentFromRangeColCount = currentFromRange.colCount;
                                    if (pasteSkipInvisibleRange) {
                                        currentFromRangeRowCount += sheet._getNextInvisibleCount(pastedRangeRow, currentFromRangeRowCount, true);
                                        currentFromRangeColCount += sheet._getNextInvisibleCount(pastedRangeCol, currentFromRangeColCount);
                                    }
                                    var ext = {
                                        sourceRange: currentFromRange,
                                        targetRange: common_1._createRange(pastedRangeRow, pastedRangeCol, currentFromRangeRowCount, currentFromRangeColCount),
                                        isCutting: isCutting,
                                        clipboardText: clipboardText,
                                        clipboardHtml: clipboardHtml,
                                        clipboardImage: clipboardImage,
                                        includeFilteredOutRow: true
                                    };
                                    command._cachedActions[j] = new ClipboardPasteRangeUndoAction(sheet, {
                                        fromSheet: srcSheet,
                                        toSheet: destSheet,
                                        pasteExtent: ext,
                                        pasteOption: pasteOption
                                    });
                                    if (inSameRow) {
                                        pastedRangeCol += currentFromRangeColCount;
                                    } else if (inSameCol) {
                                        pastedRangeRow += currentFromRangeRowCount;
                                    }
                                }
                                command._isMultiToSingle = true;
                            } else {
                                for (var i = 0; i < pastedRanges.length; i++) {
                                    var extent = {
                                        sourceRange: fromRanges[0],
                                        targetRange: pastedRanges[i],
                                        isCutting: isCutting,
                                        clipboardText: clipboardText,
                                        clipboardHtml: clipboardHtml,
                                        clipboardImage: clipboardImage
                                    };
                                    command._cachedActions[i] = new ClipboardPasteRangeUndoAction(sheet, {
                                        fromSheet: srcSheet,
                                        toSheet: destSheet,
                                        pasteExtent: extent,
                                        pasteOption: pasteOption
                                    });
                                }
                            }
                        }
                    }
                    return _this_1;
                }
                ClipboardPasteUndoAction.prototype.execute = function () {
                    var self = this;
                    var command = self._command;
                    var cachedActions = command._cachedActions;
                    var succeed = false;
                    if (self.canExecute() && cachedActions) {
                        var sheetView = self._sheet;
                        var activeSheet = sheetView.parent._getActiveSheetOrSheetTab();
                        beforeAction(activeSheet, true);
                        try {
                            var needRefreshSelection = false;
                            for (var i = 0; i < cachedActions.length; i++) {
                                var action = cachedActions[i];
                                action._shiftCells = command._shiftCells;
                                action._acCell = command._acCell;
                                action._dataRange = command._dataRange;
                                if (!sheetView) {
                                    succeed = action.execute();
                                } else {
                                    var pasteExtent = action._command.pasteExtent;
                                    var args = {
                                        sheet: sheetView,
                                        sheetName: sheetView.name(),
                                        cellRange: action._pasteRange(),
                                        pasteOption: action._command.pasteOption,
                                        pasteData: {
                                            text: pasteExtent.clipboardText,
                                            html: pasteExtent.clipboardHtml
                                        },
                                        shiftCells: command._shiftCells,
                                        cancel: false
                                    };
                                    var clipboardImage = pasteExtent.clipboardImage;
                                    if (clipboardImage) {
                                        args.pasteData.image = clipboardImage;
                                    }
                                    sheetView._trigger(common_1.Events.ClipboardPasting, args);
                                    if (!args.cancel) {
                                        succeed = action.execute();
                                        delete args.cancel;
                                        needRefreshSelection = true;
                                        sheetView._trigger(common_1.Events.ClipboardPasted, args);
                                    }
                                }
                            }
                            if (needRefreshSelection) {
                                self._refreshSelection();
                            }
                        } finally {
                            afterAction(activeSheet, true);
                        }
                    }
                    return succeed;
                };
                ClipboardPasteUndoAction.prototype._refreshSelection = function () {
                    var self = this, command = self._command;
                    var cachedActions = command._cachedActions;
                    var sheetView = self._sheet;
                    if (sheetView && cachedActions) {
                        var oldSelection = sheetView.getSelections();
                        var newSelections = [];
                        var spread = sheetView.parent;
                        sheetView._clearSelectionImp();
                        if (command._isMultiToSingle) {
                            var pasteRange = command.pastedRanges[0];
                            sheetView.addSelection(pasteRange.row, pasteRange.col, getRowCount(pasteRange), getColCount(pasteRange));
                        } else if (cachedActions.length > 1) {
                            for (var i = 0; i < cachedActions.length; i++) {
                                var action = cachedActions[i];
                                var range = action._pasteRange();
                                sheetView.addSelection(range.row, range.col, getRowCount(range), getColCount(range));
                            }
                        } else if (cachedActions.length > 0) {
                            var toRange = cachedActions[0]._pasteRange();
                            sheetView.addSelection(toRange.row, toRange.col, getRowCount(toRange), getColCount(toRange));
                            if (!toRange.contains(sheetView._activeRowIndex, sheetView._activeColIndex)) {
                                sheetView._setActiveCellCore(toRange.row, toRange.col);
                            }
                        }
                        newSelections = sheetView.getSelections();
                        if (sheetView._raiseSelectionChanging(oldSelection, newSelections)) {
                            sheetView._raiseSelectionChanged(oldSelection);
                        }
                        if (spread && command._oldPosition) {
                            spread.changeSelectionInCommandExecuting(command, null, null, newSelections);
                        }
                    }
                };
                ClipboardPasteUndoAction.prototype.canExecute = function () {
                    var cachedActions = this._command._cachedActions;
                    if (cachedActions) {
                        for (var i = 0; i < cachedActions.length; i++) {
                            var action = cachedActions[i];
                            if (!action.canExecute()) {
                                return false;
                            }
                        }
                        return true;
                    }
                    return false;
                };
                ClipboardPasteUndoAction.prototype.canUndo = function () {
                    var cachedActions = this._command._cachedActions;
                    if (cachedActions) {
                        for (var i = 0; i < cachedActions.length; i++) {
                            var action = cachedActions[i];
                            if (!action.canUndo()) {
                                return false;
                            }
                        }
                        return true;
                    }
                    return false;
                };
                ClipboardPasteUndoAction.prototype.undo = function () {
                    var self = this;
                    var cachedActions = self._command._cachedActions;
                    if (self.canUndo() && cachedActions) {
                        var ret = true;
                        var activeSheet = self._sheet.parent._getActiveSheetOrSheetTab();
                        beforeAction(activeSheet, true);
                        try {
                            for (var i = cachedActions.length - 1; i >= 0; i--) {
                                var action = cachedActions[i];
                                ret = (ret && action.undo());
                            }
                        } finally {
                            afterAction(activeSheet, true);
                        }
                        return ret;
                    }
                    return false;
                };
                return ClipboardPasteUndoAction;
            }(ActionBase));
        }),
        './dist/core/worksheet/worksheet-border.js': (function (module, exports, __webpack_require__) {
            var __extends = (this && this.__extends) || (function () {
                var extendStatics = function (d, b) {
                    extendStatics = Object.setPrototypeOf ||
                        ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
                        function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };
                    return extendStatics(d, b);
                };
                return function (d, b) {
                    extendStatics(d, b);
                    function __() { this.constructor = d; }
                    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
                };
            })();
            Object.defineProperty(exports, '__esModule', { value: true });
            var style_1 = __webpack_require__(/*! ./style */ './dist/core/worksheet/style.js');
            var domUtil_1 = __webpack_require__(/*! ../util/domUtil */ './dist/core/util/domUtil.js');
            var keyword_undefined = void 0;
            var keyword_null = null, Math_sqrt = Math.sqrt, Math_pow = Math.pow, Math_min = Math.min, Math_abs = Math.abs, Math_tan = Math.tan, Math_floor = Math.floor, Math_PI = Math.PI;
            var $_inherit = domUtil_1.GC$.inherit, $_isEmptyObject = domUtil_1.GC$.isEmptyObject;
            var SPAN_POINT_POSITION = {
                LEFT_TOP: 0,
                RIGHT_TOP: 1,
                RIGHT_BOTTOM: 2,
                LEFT_BOTTOM: 3
            };
            var SPAN_BORDER_POSITION = {
                H_TOP_LEFT: 0,
                H_TOP_Right: 1,
                V_RIGHT_TOP: 2,
                V_RIGHT_BOTTOM: 3,
                H_BOTTOM_RIGHT: 4,
                H_BOTTOM_LEFT: 5,
                V_LEFT_BOTTOM: 6,
                V_LEFT_TOP: 7
            };
            var Line = (function () {
                function Line() { }
                Line.prototype._adjust = function (opt) {
                    var self = this;
                    if (opt._orientation === 0) {
                        if (opt._offsetEnd) {
                            self._x2 += opt._offsetEnd;
                        }
                        if (opt._offsetStart) {
                            self._x1 += opt._offsetStart;
                        }
                    } else {
                        if (opt._offsetEnd) {
                            self._y2 += opt._offsetEnd;
                        }
                        if (opt._offsetStart) {
                            self._y1 += opt._offsetStart;
                        }
                    }
                };
                Line.prototype._paint = function (ctx) {
                    var color = (this._color || '#9eb6ce');
                    var lineWidth = this._lineWidth;
                    var ctxLineWidth = ctx.lineWidth;
                    var ctxStrokeStyle = ctx.strokeStyle;
                    if (ctxLineWidth !== lineWidth || ctxStrokeStyle !== color) {
                        if (ctxLineWidth !== lineWidth) {
                            ctx.lineWidth = lineWidth;
                        }
                        if (ctxStrokeStyle !== color) {
                            ctx.strokeStyle = color;
                        }
                    }
                    this._paintImp(ctx);
                };
                Line.prototype._paintImp = function (ctx) {
                    var self = this;
                    var xEqual = self._x1 === self._x2;
                    var yEqual = self._y1 === self._y2;
                    if (xEqual && yEqual) {
                        return;
                    } else if (xEqual || yEqual) {
                        ctx.beginPath();
                        self._paintLine(ctx);
                        ctx.stroke();
                    } else {
                        ctx.save();
                        var x = Math.min(self._x1, self._x2);
                        var y = Math.min(self._y1, self._y2);
                        ctx.rect(x, y, Math.abs(self._x2 - self._x1), Math.abs(self._y2 - self._y1));
                        ctx.clip();
                        ctx.beginPath();
                        self._paintLine(ctx);
                        ctx.stroke();
                        ctx.beginPath();
                        ctx.restore();
                    }
                };
                Line.prototype._paintLine = function (ctx) {
                    var self = this;
                    ctx.moveTo(self._x1, self._y1);
                    ctx.lineTo(self._x2, self._y2);
                };
                return Line;
            }());
            var SolidLine = (function (_super) {
                __extends(SolidLine, _super);
                function SolidLine(x1, y1, x2, y2, color, width, hasRotate) {
                    var _this = _super.call(this) || this;
                    var isSnapToPixel = width % 2;
                    if (!isSnapToPixel) {
                        if (x1 !== x2) {
                            y1 -= 0.5;
                            y2 -= 0.5;
                        } else {
                            x1 -= 0.5;
                            x2 -= 0.5;
                        }
                    }
                    var self = _this;
                    self._x1 = x1;
                    self._y1 = y1;
                    self._x2 = x2;
                    self._y2 = y2;
                    self._color = color;
                    self._lineWidth = width;
                    self._isRotate = hasRotate;
                    return _this;
                }
                return SolidLine;
            }(Line));
            var DashedLine = (function (_super) {
                __extends(DashedLine, _super);
                function DashedLine(x1, y1, x2, y2, color, width, pattern, hasRotate) {
                    var _this = _super.call(this) || this;
                    var isSnapToPixel = width % 2;
                    if (!isSnapToPixel) {
                        if (x1 !== x2) {
                            y1 -= 0.5;
                            y2 -= 0.5;
                        } else {
                            x1 -= 0.5;
                            x2 -= 0.5;
                        }
                    }
                    var self = _this;
                    self._x1 = x1;
                    self._y1 = y1;
                    self._x2 = x2;
                    self._y2 = y2;
                    self._color = color;
                    self._lineWidth = width;
                    self._pattern = pattern;
                    self._isRotate = hasRotate;
                    return _this;
                }
                DashedLine.prototype._paintLine = function (ctx) {
                    var self = this;
                    DashedLine._render(ctx, self._x1, self._y1, self._x2, self._y2, self._pattern);
                };
                DashedLine._render = function (ctx, x0, y0, x1, y1, pattern) {
                    var length = Math_sqrt(Math_pow(x1 - x0, 2) + Math_pow(y1 - y0, 2));
                    var vector = {
                        x: (x1 - x0) / length,
                        y: (y1 - y0) / length
                    };
                    var dist = 0, i = 0;
                    pattern = pattern && pattern.length ? pattern : [4, 4];
                    while (dist < length) {
                        var dashLength = Math_min(pattern[i % pattern.length], length - dist);
                        i++;
                        var draw = (i % 2);
                        dist += dashLength;
                        if (draw) {
                            ctx.moveTo(x0, y0);
                        }
                        x0 += dashLength * vector.x;
                        y0 += dashLength * vector.y;
                        if (draw) {
                            ctx.lineTo(x0, y0);
                        }
                    }
                };
                return DashedLine;
            }(Line));
            var SlantedLine = (function (_super) {
                __extends(SlantedLine, _super);
                function SlantedLine(x1, y1, x2, y2, color, horizontal, pattern1, pattern2, hasRotate) {
                    var _this = _super.call(this) || this;
                    if (horizontal) {
                        x1 -= 1;
                        x2 -= 1;
                    } else {
                        y1 -= 1;
                        y2 -= 1;
                    }
                    var self = _this;
                    self._x1 = x1;
                    self._y1 = y1;
                    self._x2 = x2;
                    self._y2 = y2;
                    self._color = color;
                    self._horizontal = horizontal;
                    self._lineWidth = 1;
                    self._pattern1 = pattern1;
                    self._pattern2 = pattern2;
                    self._isRotate = hasRotate;
                    return _this;
                }
                SlantedLine.prototype._paintLine = function (ctx) {
                    var self = this;
                    var xOff = self._horizontal ? 0 : 1;
                    var yOff = self._horizontal ? 1 : 0;
                    DashedLine._render(ctx, self._x1 - xOff, self._y1 - yOff, self._x2 - xOff, self._y2 - yOff, self._pattern1);
                    DashedLine._render(ctx, self._x1, self._y1, self._x2, self._y2, self._pattern2);
                };
                return SlantedLine;
            }(Line));
            var DiagonalDoubleLine = (function (_super) {
                __extends(DiagonalDoubleLine, _super);
                function DiagonalDoubleLine(x1, y1, x2, y2, color, isDown, hasRotate) {
                    var _this = _super.call(this) || this;
                    var self = _this;
                    self._x1 = x1;
                    self._y1 = y1;
                    self._x2 = x2;
                    self._y2 = y2;
                    self._color = color;
                    self._isDown = isDown;
                    self._isRotate = hasRotate;
                    self._line1 = new SolidLine(self._x1, self._y1, self._x2, self._y2, color, 1, hasRotate);
                    self._line2 = null;
                    return _this;
                }
                DiagonalDoubleLine.prototype._paintImp = function (ctx) {
                    if (this._line1) {
                        this._line1._paintImp(ctx);
                    }

                    if (this._line2) {
                        this._line2._paintImp(ctx);
                    }
                };
                DiagonalDoubleLine.prototype._adjust = function (opt) {
                    var self = this;
                    if (self._line2) {
                        if (opt._offsetStart && self._line1) {
                            self._line1._adjust(opt);
                        }
                        if (opt._offsetEnd) {
                            self._line2._adjust(opt);
                        }
                    } else if (self._line1) {
                        self._line1._adjust(opt);
                    }
                };
                DiagonalDoubleLine.prototype._adjustSever = function (sever) {
                    var self = this;
                    if (sever && sever.severX && sever.severY) {
                        var severX = sever.severX || 0;
                        var severY = sever.severY || 0;
                        severX = self._isDown ? severX : -severX;
                        var middleX = parseInt((self._x1 + ((self._x2 - self._x1) / 2)), 10);
                        var middleY = parseInt((self._y1 + ((self._y2 - self._y1) / 2)), 10);
                        var firstPartEndX = middleX - severX;
                        var firstPartEndY = middleY - severY;
                        var lastPartBeginX = middleX + severX;
                        var lastPartBeginY = middleY + severY;
                        self._line1 = new SolidLine(self._x1, self._y1, firstPartEndX, firstPartEndY, self._color, 1, self._isRotate);
                        self._line2 = new SolidLine(lastPartBeginX, lastPartBeginY, self._x2, self._y2, self._color, 1, self._isRotate);
                    } else {
                        self._line1 = new SolidLine(self._x1, self._y1, self._x2, self._y2, self._color, 1, self._isRotate);
                        self._line2 = null;
                    }
                };
                return DiagonalDoubleLine;
            }(Line));
            var DoubleLine = (function (_super) {
                __extends(DoubleLine, _super);
                function DoubleLine(x1, y1, x2, y2, color, hasRotate) {
                    var _this = _super.call(this) || this;
                    var self = _this;
                    var xOff = 0, yOff = 0;
                    if (x1 === x2) {
                        xOff = 1;
                    }
                    if (y1 === y2) {
                        yOff = 1;
                    }
                    if (x1 !== x2 && y1 !== y2) {
                        if (!hasRotate) {
                            xOff = 2;
                            yOff = 2;
                            if (x1 > x2) {
                                self._line1 = new DiagonalDoubleLine(x1 - xOff, y1, x2, y2 - yOff, color, false, hasRotate);
                                self._line2 = new DiagonalDoubleLine(x1, y1 + yOff, x2 + xOff, y2, color, false, hasRotate);
                            } else {
                                self._line1 = new DiagonalDoubleLine(x1, y1 + yOff, x2 - xOff, y2, color, true, hasRotate);
                                self._line2 = new DiagonalDoubleLine(x1 + xOff, y1, x2, y2 - yOff, color, true, hasRotate);
                            }
                        } else {
                            xOff = 2;
                            self._line1 = new SolidLine(x1 - xOff, y1, x2 - xOff, y2, color, 1, hasRotate);
                            self._line2 = new SolidLine(x1 + xOff, y1, x2 + xOff, y2, color, 1, hasRotate);
                        }
                    } else {
                        self._line1 = new SolidLine(x1 - xOff, y1 - yOff, x2 - xOff, y2 - yOff, color, 1, hasRotate);
                        self._line2 = new SolidLine(x1 + xOff, y1 + yOff, x2 + xOff, y2 + yOff, color, 1, hasRotate);
                    }
                    self._isRotate = hasRotate;
                    self._color = color;
                    self._lineWidth = 1;
                    return _this;
                }
                DoubleLine.prototype._paintImp = function (ctx) {
                    this._line1._paintImp(ctx);

                    this._line2._paintImp(ctx);
                };
                DoubleLine.prototype._adjust = function (opt) {
                    var self = this;
                    if (!opt._lineSide) {
                        self._line1._adjust(opt);
                        self._line2._adjust(opt);
                    } else if (opt._lineSide === 1) {
                        self._line1._adjust(opt);
                    } else if (opt._lineSide === 2) {
                        self._line2._adjust(opt);
                    }
                };
                DoubleLine.prototype._adjustSever = function () {
                    var self = this;
                    var serve = { severX: 1, severY: 1 };
                    var _line1 = self._line1;
                    var _line2 = self._line2;
                    _line1._adjustSever(serve);
                    _line2._adjustSever(serve);
                };
                return DoubleLine;
            }(Line));
            function _createLine(x1, y1, x2, y2, color, lineStyle, hasRotate) {
                if (lineStyle === keyword_undefined || lineStyle === keyword_null) {
                    lineStyle = 1;
                }
                switch (lineStyle) {
                    case 1:
                        return new SolidLine(x1, y1, x2, y2, color, 1, hasRotate);
                    case 2:
                        return new SolidLine(x1, y1, x2, y2, color, 2, hasRotate);
                    case 5:
                        return new SolidLine(x1, y1, x2, y2, color, 3, hasRotate);
                    case 3:
                        return new DashedLine(x1, y1, x2, y2, color, 1, [3, 1], hasRotate);
                    case 9:
                        return new DashedLine(x1, y1, x2, y2, color, 1, [8, 2, 2, 2], hasRotate);
                    case 4:
                        return new DashedLine(x1, y1, x2, y2, color, 1, [2, 2], hasRotate);
                    case 11:
                        return new DashedLine(x1, y1, x2, y2, color, 1, [9, 3, 3, 3, 3, 3], hasRotate);
                    case 13:
                        return new SlantedLine(x1, y1, x2, y2, color, x1 !== x2, [11, 1, 5, 1], [10, 2, 4, 2], hasRotate);
                    case 10:
                        return new DashedLine(x1, y1, x2, y2, color, 2, [9, 3, 3, 3], hasRotate);
                    case 12:
                        return new DashedLine(x1, y1, x2, y2, color, 2, [9, 3, 3, 3, 3, 3], hasRotate);
                    case 8:
                        return new DashedLine(x1, y1, x2, y2, color, 2, [9, 3], hasRotate);
                    case 51:
                        return new DashedLine(x1, y1, x2, y2, color, 2, [4, 2], hasRotate);
                    case 7:
                        return new DashedLine(x1, y1, x2, y2, color, 1, [1], hasRotate);
                    case 6:
                        return new DoubleLine(x1, y1, x2, y2, color, hasRotate);
                }
                return keyword_null;
            }
            exports._createLine = _createLine;

            var BorderLayoutEngine = (function () {
                function BorderLayoutEngine() {
                }
                BorderLayoutEngine._compareLineStyle = function (line1, line2, ignoreLevel) {
                    if (!line1) {
                        if (!line2) {
                            return 0;
                        }
                        return -1;
                    } else if (!line2) {
                        return 1;
                    }
                    var weightCache = BorderLayoutEngine._styleWeightCache;
                    var result = weightCache[line1.style] - weightCache[line2.style];
                    if (result === 0 && !ignoreLevel) {
                        return line2.level - line1.level;
                    }
                    return result;
                };
                BorderLayoutEngine._getDrawingThickness = function (lineItem) {
                    if (lineItem) {
                        if (lineItem.isGridLine) {
                            return 1;
                        }
                        if (lineItem.style) {
                            return style_1.LineBorder._width(lineItem.style);
                        }
                    }
                    return 0;
                };
                BorderLayoutEngine._isDoubleLine = function (line) {
                    return (line && line.style === 6);
                };
                BorderLayoutEngine._isSlantedLine = function (line) {
                    return (line && line.style === 13);
                };
                BorderLayoutEngine._getMaxLine = function (line1, line2) {
                    if (!line1) {
                        return line2;
                    } else if (!line2) {
                        return line1;
                    }
                    return BorderLayoutEngine._compareLineStyle(line1.style, line2.style) >= 0 ? line1 : line2;
                };
                BorderLayoutEngine._adjustLine = function (lineItem, opt) {
                    if (lineItem && lineItem.line) {
                        lineItem.line._adjust(opt);
                    }
                };
                BorderLayoutEngine._compareLine = function (lineItem1, lineItem2, ignoreLevel) {
                    if (lineItem1 === lineItem2) {
                        return 0;
                    }
                    if (!lineItem1) {
                        return -1;
                    }
                    if (!lineItem2) {
                        return 1;
                    }
                    if (lineItem1.isGridLine) {
                        return lineItem2.isGridLine ? 0 : -1;
                    } else if (lineItem2.isGridLine) {
                        return 1;
                    }
                    return BorderLayoutEngine._compareLineStyle(lineItem1.style, lineItem2.style, ignoreLevel);
                };
                BorderLayoutEngine._isDoubleLineItem = function (lineItem) {
                    return lineItem && lineItem.style && lineItem.style.style === 6;
                };
                BorderLayoutEngine._isAllowExtend = function (current, line, break1, break2) {
                    if (current.style && current.style.style === 6) {
                        return true;
                    }
                    var doubleCnt = 0;
                    doubleCnt += (line && line.style && line.style.style === 6) ? 1 : 0;
                    doubleCnt += (break1 && break1.style && break1.style.style === 6) ? 1 : 0;
                    doubleCnt += (break2 && break2.style && break2.style.style === 6) ? 1 : 0;
                    return doubleCnt < 2;
                };
                BorderLayoutEngine._layout4CrossRoad = function (current, line, break1, break2, lineType, vertical) {
                    var opt = {
                        _orientation: (vertical ? 1 : 0),
                        _offsetStart: 0,
                        _offsetEnd: 0
                    };
                    var diff1 = this._compareLine(current, break1), diff2 = this._compareLine(current, break2);
                    if (diff1 >= 0 && diff2 >= 0) {
                        if (diff1 === 0 && diff2 === 0) {
                            if (lineType !== -1 && lineType === 1) {
                                opt._offsetEnd -= lineType;
                            }
                        } else if (lineType === -1) {
                            opt._offsetStart -= lineType;
                        } else if (lineType === 1) {
                            opt._offsetEnd -= 2 * lineType;
                        }
                    } else if (diff2 >= 0) {
                        opt._lineSide = 2;
                        opt._offsetStart += lineType;
                    } else if (diff1 >= 0) {
                        opt._lineSide = 1;
                        opt._offsetStart += lineType;
                    }
                    this._adjustLine(current, opt);
                };
                BorderLayoutEngine._layout4TurnRoad = function (current, prevLine, nextLine, break1, break2, type, lineType, vertical, swap) {
                    var optFirst = {
                        _orientation: (vertical ? 1 : 0),
                        _lineSide: (swap ? 2 : 1),
                        _offsetStart: 0,
                        _offsetEnd: 0
                    };
                    var optSecond = {
                        _orientation: (vertical ? 1 : 0),
                        _lineSide: (swap ? 1 : 2),
                        _offsetStart: 0,
                        _offsetEnd: 0
                    };
                    var breakLine = (type === 1 ? break1 : break2);
                    var neighborLine = (lineType === 1 ? nextLine : prevLine);
                    var hasNeighborDoubleLine = this._isDoubleLineItem(neighborLine);
                    if (!hasNeighborDoubleLine) {
                        if (this._compareLine(current, breakLine) >= 0) {
                            if (lineType === -1) {
                                optSecond._offsetStart -= 2 * lineType;
                            } else if (lineType === 1) {
                                optSecond._offsetEnd -= 2 * lineType;
                            }
                        } else if (lineType === -1) {
                            optFirst._offsetStart += 2 * lineType;
                        } else if (lineType === 1) {
                            optFirst._offsetEnd += 2 * lineType;
                        }
                    } else {
                        var diff = this._compareLine(current, breakLine);
                        if (diff === 0) {
                            var diff1 = this._compareLine(current, neighborLine);
                            if (diff1 === 0) {
                                if (lineType === 1) {
                                    optSecond._offsetEnd -= lineType;
                                }
                            } else if (diff1 > 0) {
                                if (lineType === -1) {
                                    optSecond._offsetStart -= 2 * lineType;
                                } else if (lineType === 1) {
                                    optSecond._offsetEnd -= 2 * lineType;
                                }
                            }
                        } else if (diff > 0) {
                            var diff2 = this._compareLine(current, neighborLine);
                            if (diff2 === 0) {
                                if (lineType === 1) {
                                    optSecond._offsetEnd -= lineType;
                                }
                            } else if (diff2 > 0) {
                                if (lineType === -1) {
                                    optSecond._offsetStart -= 2 * lineType;
                                } else if (lineType === 1) {
                                    optSecond._offsetEnd -= 2 * lineType;
                                }
                            }
                        } else {
                            var diff3 = this._compareLine(current, neighborLine);
                            if (diff3 === 0) {
                                if (lineType === -1) {
                                    optFirst._offsetStart += 2 * lineType;
                                } else if (lineType === 1) {
                                    optFirst._offsetEnd += 2 * lineType;
                                }
                            } else if (diff3 > 0) {
                                if (lineType === -1) {
                                    optFirst._offsetStart -= 3 * lineType;
                                } else if (lineType === 1) {
                                    optFirst._offsetEnd -= 3 * lineType;
                                }
                            }
                        }
                    }
                    var otherType = (type === 1 ? 2 : 1);
                    var otherBreakLine = (otherType === 1 ? break1 : break2);
                    var needMakeupCorner = false;
                    var thickness = 0;
                    if (this._isDoubleLineItem(otherBreakLine) && this._compareLine(otherBreakLine, current) > 0) {
                        needMakeupCorner = true;
                        var drawThickness = BorderLayoutEngine._getDrawingThickness(otherBreakLine);
                        if (this._compareLine(otherBreakLine, breakLine) > 0) {
                            if (drawThickness > 0) {
                                if (lineType === 1 && this._isDoubleLineItem(nextLine)) {
                                    thickness = drawThickness >= 2 ? 2 : 1;
                                } else if (lineType === -1 && this._isDoubleLineItem(prevLine)) {
                                    thickness = drawThickness >= 3 ? 2 : 1;
                                } else {
                                    thickness = drawThickness === 3 ? 3 : 2;
                                }
                            }
                        } else {
                            thickness = drawThickness === 3 ? 3 : 2;
                        }
                    }
                    if (!needMakeupCorner && (!this._isDoubleLineItem(neighborLine)) && ((neighborLine && !neighborLine.isGridLine) || (otherBreakLine && !otherBreakLine.isGridLine))) {
                        needMakeupCorner = true;
                        if (lineType === -1) {
                            thickness = 2;
                        } else {
                            thickness = 1;
                        }
                    }
                    if (needMakeupCorner) {
                        if (lineType === -1) {
                            optFirst._offsetStart += lineType * thickness;
                            optSecond._offsetStart += lineType * thickness;
                        } else if (lineType === 1) {
                            optFirst._offsetEnd += lineType * thickness;
                            optSecond._offsetEnd += lineType * thickness;
                        }
                    }
                    if (optFirst._offsetStart || optFirst._offsetEnd) {
                        this._adjustLine(current, optFirst);
                    }
                    if (optSecond._offsetStart || optSecond._offsetEnd) {
                        this._adjustLine(current, optSecond);
                    }
                };
                BorderLayoutEngine._layout4TRoad = function (current, line, break1, break2, lineType, vertical) {
                    if (this._compareLine(current, break1) >= 0 && this._compareLine(current, break2) >= 0) {
                        var opt = { _orientation: (vertical ? 1 : 0), _offsetStart: 0, _offsetEnd: 0 };
                        if (lineType === -1) {
                            opt._offsetStart -= 2 * lineType;
                            if (this._isDoubleLineItem(current) && this._compareLine(line, current) > 0) {
                                opt._offsetStart -= 1;
                            }
                        } else if (lineType === 1) {
                            opt._offsetEnd -= 2 * lineType;
                            if (this._isDoubleLineItem(current) && this._compareLine(line, current) > 0) {
                                opt._offsetEnd += 1;
                            }
                        }
                        this._adjustLine(current, opt);
                    }
                };
                BorderLayoutEngine._layout4Connected = function (current, line, break1, break2, lineType, vertical) {
                    if (this._isDoubleLineItem(current)) {
                        var breakLine = this._getMaxLine(break1, break2);
                        if (breakLine && !breakLine.isGridLine) {
                            var drawThickness = BorderLayoutEngine._getDrawingThickness(breakLine);
                            if (drawThickness > 0) {
                                var opt = {
                                    _orientation: (vertical ? 1 : 0),
                                    _offsetStart: 0,
                                    _offsetEnd: 0
                                };
                                if (lineType === -1) {
                                    opt._offsetStart += drawThickness * lineType;
                                } else {
                                    opt._offsetEnd += drawThickness * lineType;
                                }
                                if (opt._offsetStart || opt._offsetEnd) {
                                    this._adjustLine(current, opt);
                                }
                            }
                        }
                    }
                };
                BorderLayoutEngine._calcLayoutHorizontal = function (current, prevLine, prevBreak1, prevBreak2, nextLine, nextBreak1, nextBreak2) {
                    var drawThickness;
                    var diff;
                    var self = BorderLayoutEngine;

                    if (prevLine || prevBreak1 || prevBreak2) {
                        var prevBreak = self._getMaxLine(prevBreak1, prevBreak2);
                        if (!self._isAllowExtend(current, prevLine, prevBreak1, prevBreak2)) {
                            self._adjustLine(current, { _orientation: 0, _offsetStart: 1 });
                        } else if ((diff = self._compareLine(prevBreak, current, true)) > 0) {
                            drawThickness = self._getDrawingThickness(prevBreak);
                            if (!(self._isDoubleLineItem(current) && (self._isDoubleLineItem(prevBreak1) || self._isDoubleLineItem(prevBreak2) || self._isDoubleLineItem(prevLine)))) {
                                if (drawThickness === 3) {
                                    self._adjustLine(current, { _orientation: 0, _offsetStart: 1 });
                                }
                            }
                        } else if (prevBreak && diff < 0) {
                            if ((diff = self._compareLine(current, prevLine, true)) > 0) {
                                drawThickness = self._getDrawingThickness(prevBreak);
                                if (drawThickness === 3 || drawThickness === 2) {
                                    self._adjustLine(current, { _orientation: 0, _offsetStart: -2 });
                                } else if (drawThickness === 1) {
                                    self._adjustLine(current, { _orientation: 0, _offsetStart: -1 });
                                }
                            } else if (diff !== 0 && self._compareLine(prevLine, prevBreak, true) > 0) {
                                drawThickness = self._getDrawingThickness(prevBreak);
                                if (drawThickness === 3) {
                                    self._adjustLine(current, { _orientation: 0, _offsetStart: 1 });
                                }
                            }
                        } else if (diff === 0 && (!prevLine || self._compareLine(current, prevLine, true) > 0)) {
                            drawThickness = self._getDrawingThickness(prevBreak);
                            if (drawThickness === 3 || drawThickness === 2) {
                                self._adjustLine(current, { _orientation: 0, _offsetStart: -2 });
                            } else if (drawThickness === 1) {
                                self._adjustLine(current, { _orientation: 0, _offsetStart: -1 });
                            }
                        }
                    }
                    if (nextLine || nextBreak1 || nextBreak2) {
                        var nextBreak = self._getMaxLine(nextBreak1, nextBreak2);
                        if (!self._isAllowExtend(current, nextLine, nextBreak1, nextBreak2)) {
                            self._adjustLine(current, { _orientation: 0, _offsetEnd: -2 });
                        } else if ((diff = self._compareLine(nextBreak, current, true)) > 0) {
                            drawThickness = self._getDrawingThickness(nextBreak);
                            if (!(self._isDoubleLineItem(current) && (self._isDoubleLineItem(nextBreak1) || self._isDoubleLineItem(nextBreak2) || self._isDoubleLineItem(nextLine)))) {
                                if (drawThickness === 3) {
                                    self._adjustLine(current, { _orientation: 0, _offsetEnd: -2 });
                                } else if (drawThickness === 2 || drawThickness === 1) {
                                    self._adjustLine(current, { _orientation: 0, _offsetEnd: -1 });
                                }
                            }
                        } else if (diff <= 0) {
                            if ((diff = self._compareLine(current, nextLine, true)) > 0) {
                                drawThickness = self._getDrawingThickness(nextBreak);
                                if (drawThickness === 3) {
                                    self._adjustLine(current, { _orientation: 0, _offsetEnd: 1 });
                                }
                            } else if (diff !== 0) {
                                self._adjustLine(current, { _orientation: 0, _offsetEnd: -1 });
                            }
                        }
                    }
                };
                BorderLayoutEngine._calcLayoutVertical = function (current, prevLine, prevBreak1, prevBreak2, nextLine, nextBreak1, nextBreak2) {
                    var drawThickness;
                    var diff;
                    var self = BorderLayoutEngine;
                    if (prevLine || prevBreak1 || prevBreak2) {
                        var prevBreak = self._getMaxLine(prevBreak1, prevBreak2);
                        diff = self._compareLine(prevBreak, current, true);
                        if (!self._isAllowExtend(current, prevLine, prevBreak1, prevBreak2)) {
                            self._adjustLine(current, { _orientation: 1, _offsetStart: 1 });
                        } else if (diff > 0) {
                            drawThickness = self._getDrawingThickness(prevBreak);
                            if (!(self._isDoubleLineItem(current) && (self._isDoubleLineItem(prevBreak1) || self._isDoubleLineItem(prevBreak2) || self._isDoubleLineItem(prevLine)))) {
                                if (drawThickness === 3) {
                                    self._adjustLine(current, { _orientation: 1, _offsetStart: 1 });
                                }
                            }
                        } else if (diff < 0) {
                            diff = self._compareLine(current, prevLine, true);
                            if (diff > 0) {
                                drawThickness = self._getDrawingThickness(prevBreak);
                                if (drawThickness === 3 || drawThickness === 2) {
                                    self._adjustLine(current, { _orientation: 1, _offsetStart: -2 });
                                } else if (drawThickness === 1) {
                                    self._adjustLine(current, { _orientation: 1, _offsetStart: -1 });
                                }
                            } else if (diff !== 0 && self._compareLine(prevLine, prevBreak, true) > 0) {
                                drawThickness = self._getDrawingThickness(prevBreak);
                                if (drawThickness === 3) {
                                    self._adjustLine(current, { _orientation: 1, _offsetStart: 1 });
                                }
                            }
                        } else if (diff === 0 && self._compareLine(current, prevLine, true) > 0) {
                            drawThickness = self._getDrawingThickness(prevBreak);
                            if (drawThickness === 3 || drawThickness === 2) {
                                self._adjustLine(current, { _orientation: 1, _offsetStart: -2 });
                            } else if (drawThickness === 1) {
                                self._adjustLine(current, { _orientation: 1, _offsetStart: -1 });
                            }
                        }
                    }
                    if (nextLine || nextBreak1 || nextBreak2) {
                        var nextBreak = self._getMaxLine(nextBreak1, nextBreak2);
                        diff = self._compareLine(current, nextBreak, true);
                        if (!self._isAllowExtend(current, nextLine, nextBreak1, nextBreak2)) {
                            self._adjustLine(current, { _orientation: 1, _offsetEnd: -2 });
                        } else if (diff < 0) {
                            drawThickness = self._getDrawingThickness(nextBreak);
                            if (!(self._isDoubleLineItem(current) && (self._isDoubleLineItem(nextBreak1) || self._isDoubleLineItem(nextBreak2) || self._isDoubleLineItem(nextLine)))) {
                                if (drawThickness === 3 || drawThickness === 2) {
                                    self._adjustLine(current, { _orientation: 1, _offsetEnd: -2 });
                                } else if (drawThickness === 1) {
                                    self._adjustLine(current, { _orientation: 1, _offsetEnd: -1 });
                                }
                            }
                        } else if (nextBreak !== keyword_null && diff >= 0) {
                            diff = self._compareLine(current, nextLine, true);
                            if (diff > 0) {
                                drawThickness = self._getDrawingThickness(nextBreak);
                                if (drawThickness === 3) {
                                    self._adjustLine(current, { _orientation: 1, _offsetEnd: 1 });
                                }
                            } else if (diff !== 0) {
                                self._adjustLine(current, { _orientation: 1, _offsetEnd: -1 });
                            }
                        }
                    }
                };
                BorderLayoutEngine._calcDoubleLayout = function (current, prevLine, prevBreak1, prevBreak2, nextLine, nextBreak1, nextBreak2, vertical) {
                    var self = BorderLayoutEngine;
                    if (vertical) {
                        this._calcLayoutVertical(current, prevLine, prevBreak1, prevBreak2, nextLine, nextBreak1, nextBreak2);
                    } else {
                        this._calcLayoutHorizontal(current, prevLine, prevBreak1, prevBreak2, nextLine, nextBreak1, nextBreak2);
                    }
                    var break1DoubleLine = self._isDoubleLineItem(prevBreak1), break2DoubleLine = self._isDoubleLineItem(prevBreak2), prevDoubleLine = self._isDoubleLineItem(prevLine);
                    if (break1DoubleLine && break2DoubleLine && prevDoubleLine) {
                        self._layout4CrossRoad(current, prevLine, prevBreak1, prevBreak2, -1, vertical);
                    } else if (break1DoubleLine && !break2DoubleLine) {
                        self._layout4TurnRoad(current, prevLine, nextLine, prevBreak1, prevBreak2, 1, -1, vertical, true);
                    } else if (!break1DoubleLine && break2DoubleLine) {
                        self._layout4TurnRoad(current, prevLine, nextLine, prevBreak1, prevBreak2, 2, -1, vertical, false);
                    } else if (break1DoubleLine && break2DoubleLine && !prevDoubleLine) {
                        self._layout4TRoad(current, prevLine, prevBreak1, prevBreak2, -1, vertical);
                    } else if (prevDoubleLine) {
                        self._layout4Connected(current, prevLine, prevBreak1, prevBreak2, -1, vertical);
                    }
                    break1DoubleLine = self._isDoubleLineItem(nextBreak1);
                    break2DoubleLine = self._isDoubleLineItem(nextBreak2);
                    var nextDoubleLine = self._isDoubleLineItem(nextLine);
                    if (break1DoubleLine && break2DoubleLine && nextDoubleLine) {
                        self._layout4CrossRoad(current, nextLine, nextBreak1, nextBreak2, 1, vertical);
                    } else if (break1DoubleLine && !break2DoubleLine) {
                        self._layout4TurnRoad(current, prevLine, nextLine, nextBreak1, nextBreak2, 1, 1, vertical, true);
                    } else if (!break1DoubleLine && break2DoubleLine) {
                        self._layout4TurnRoad(current, prevLine, nextLine, nextBreak1, nextBreak2, 2, 1, vertical, false);
                    } else if (break1DoubleLine && break2DoubleLine && !nextDoubleLine) {
                        self._layout4TRoad(current, nextLine, nextBreak1, nextBreak2, 1, vertical);
                    } else if (nextDoubleLine) {
                        self._layout4Connected(current, nextLine, nextBreak1, nextBreak2, 1, vertical);
                    }
                };
                BorderLayoutEngine._styleWeightCache = [
                    0,
                    101,
                    199,
                    100,
                    100,
                    300,
                    90,
                    100,
                    198,
                    100,
                    198,
                    100,
                    198,
                    198
                ];
                BorderLayoutEngine._compareTwoLineStyleIsSame = function (lineItem0, lineItem1) {
                    if (lineItem0 && lineItem1 && lineItem0.color === lineItem1.color && lineItem0.level === lineItem1.level && lineItem0.style === lineItem1.style) {
                        return true;
                    }
                    return false;
                };
                return BorderLayoutEngine;
            }());

            var _Borders = (function () {
                function _Borders(sheet, rowLayoutModel, colLayoutModel, sheetArea) {
                    var self = this;
                    self._isInitialized = false;
                    self._isMerged = false;
                    self._sheet = sheet;
                    self._sheetArea = sheetArea;
                    self._rowLayoutModel = rowLayoutModel;
                    self._colLayoutModel = colLayoutModel;
                }
                _Borders.prototype._initialize = function () {
                    var self = this;
                    self._spanCells = [];
                    self._rowIndecies = [];
                    self._colIndecies = [];
                    self._overflowedCells = [];
                    self._adjustingRanges = [];
                    self._hGridLine = {};
                    self._vGridLine = {};
                    self._hBorders = {};
                    self._vBorders = {};
                    self._downDiagonals = {};
                    self._upDiagonals = {};
                    self._spanCash = {};
                    var rowLayoutModel = self._rowLayoutModel, colLayoutModel = self._colLayoutModel;
                    if (rowLayoutModel && rowLayoutModel.length > 0 && colLayoutModel && colLayoutModel.length > 0) {
                        var rowIndecies = self._rowIndecies, rowLayoutCount = rowLayoutModel.length, rowLyout = void 0;
                        for (var i = 0; i < rowLayoutCount; i++) {
                            rowLyout = rowLayoutModel[i];
                            if (rowLyout.height > 0) {
                                rowIndecies.push(rowLyout.row);
                            }
                        }
                        rowIndecies.push(rowIndecies[rowIndecies.length - 1] + 1);
                        var colIndecies = self._colIndecies, colLayoutCount = colLayoutModel.length, colLayout = void 0;
                        for (var j = 0; j < colLayoutCount; j++) {
                            colLayout = colLayoutModel[j];
                            if (colLayout.width > 0) {
                                colIndecies.push(colLayout.col);
                            }
                        }
                        colIndecies.push(colIndecies[colIndecies.length - 1] + 1);
                    }
                    self._isInitialized = true;
                };
                _Borders.prototype._addCellOverlfowLayout = function (row, col, cellOverflowLayout, style, x, y, width, height) {
                    if (cellOverflowLayout) {
                        var overflowedCell = {
                            _row: row,
                            _col: col,
                            _startCol: cellOverflowLayout.startColumn,
                            _endCol: cellOverflowLayout.endColumn,
                            _style: style,
                            _x: x,
                            _y: y,
                            _width: width,
                            _height: height
                        };
                        this._overflowedCells.push(overflowedCell);
                    }
                };
                _Borders.prototype._addCellLines = function (row, col, x, y, width, height, style, spanCellLayout, needTopGridline, needLeftGridline, data) {
                    var self = this;
                    if (!self._isInitialized) {
                        self._initialize();
                    }
                    if (spanCellLayout) {
                        self._spanCells.push(spanCellLayout);
                    } else {
                        var borderLeft = void 0, borderTop = void 0, borderRight = void 0, borderBottom = void 0, diagonalDown = void 0, diagonalUp = void 0, textOrientation = void 0, isVerticalText = void 0, textIndent = void 0;
                        var backColor = void 0;
                        if (style) {
                            borderLeft = style.borderLeft;
                            borderTop = style.borderTop;
                            borderRight = style.borderRight;
                            borderBottom = style.borderBottom;
                            backColor = style.backColor;
                            diagonalDown = style.diagonalDown;
                            diagonalUp = style.diagonalUp;
                            textOrientation = style.textOrientation;
                            isVerticalText = style.isVerticalText;
                            textIndent = style.textIndent;
                        }
                        if (backColor && (!borderLeft && !borderRight && !borderTop && !borderBottom)) {
                            self._adjustingRanges.push({ r: row, c: col, rc: 1, cc: 1 });
                        }
                        self._addCellLineImp(row, col, x, y, width, height, borderLeft, borderTop, borderRight, borderBottom, diagonalDown, diagonalUp, backColor, false, false, needTopGridline, needLeftGridline, textOrientation, isVerticalText, textIndent && textIndent !== 0, data);
                    }
                };
                _Borders.prototype._addCellLineImp = function (row, col, x, y, width, height, borderLeft, borderTop, borderRight, borderBottom, diagonalDown, diagonalUp, backColor, noHGridLine, noVGridLine, needTopGridline, needLeftGridline, textOrientation, isVerticalText, textIndent, data) {
                    var self = this;
                    var addTopLineSucceeded = false, addLeftLineSucceeded = false, addBottomLineSucceeded = false, addRightLineSucceeded = false;
                    var hasRotateText = textOrientation !== keyword_undefined && textOrientation && -90 <= textOrientation && textOrientation <= 90;
                    var textOrientationRadian, tantextOrientation, moveLength, newBeginX = x;
                    var hasBorder = borderLeft || borderTop || borderRight || borderBottom;
                    if (hasRotateText && hasBorder && !isVerticalText && !textIndent && data) {
                        textOrientationRadian = Math_abs(textOrientation * Math_PI / 180);
                        tantextOrientation = Math_tan(textOrientationRadian);
                        moveLength = Math.floor(height / tantextOrientation);
                        if (textOrientation > -90 && textOrientation < 0) {
                            newBeginX = x - moveLength;
                        }
                        if (textOrientation > 0 && textOrientation < 90) {
                            newBeginX = x + moveLength;
                        }
                    }
                    if (diagonalDown && !hasRotateText) {
                        self._addCellLineSide(row, col, x - 1, y - 1, x + width, y + height, diagonalDown, self._downDiagonals);
                    }
                    if (diagonalUp && !hasRotateText) {
                        self._addCellLineSide(row, col, x + width, y - 1, x - 1, y + height, diagonalUp, self._upDiagonals);
                    }
                    if (borderTop && height > 0) {
                        addTopLineSucceeded = self._addCellLineSide(row, col, newBeginX, y - 0.5, newBeginX + width, y - 0.5, borderTop, self._hBorders, hasRotateText);
                    }
                    if (borderLeft && width > 0) {
                        addLeftLineSucceeded = self._addCellLineSide(row, col, newBeginX - 0.5, y, x - 0.5, y + height, borderLeft, self._vBorders, hasRotateText);
                    }
                    if (borderRight && width > 0) {
                        addRightLineSucceeded = self._addCellLineSide(row, col + 1, newBeginX + width - 0.5, y, x + width - 0.5, y + height, borderRight, self._vBorders, hasRotateText);
                    }
                    if (borderBottom && height > 0) {
                        addBottomLineSucceeded = self._addCellLineSide(row + 1, col, x, y + height - 0.5, x + width, y + height - 0.5, borderBottom, self._hBorders, hasRotateText);
                    }
                    var sheet = self._sheet;
                    if (!backColor || sheet._cachePool._getZoomRowHeight(row) === 0 || sheet._cachePool._getZoomColWidth(col) === 0) {
                        var needRenderBottomGridLine = !addBottomLineSucceeded && !noHGridLine, needRenderRightGridLine = !addRightLineSucceeded && !noVGridLine, needRenderTopGridLine = !addTopLineSucceeded && !noHGridLine, needRenderLeftGridLine = !addLeftLineSucceeded && !noVGridLine;
                        if (needRenderBottomGridLine || needRenderRightGridLine || needRenderTopGridLine || needRenderLeftGridLine) {
                            self._addGridLine(row, col, x, y, width, height, needRenderBottomGridLine, needRenderRightGridLine, needTopGridline, needLeftGridline);
                        }
                    }
                    if ((addTopLineSucceeded || backColor) && !hasRotateText) {
                        self._removeLineItem(row - 1, col, self._hGridLine);
                    }
                    if (addLeftLineSucceeded || backColor) {
                        self._removeLineItem(row, col - 1, self._vGridLine);
                    }
                    if (backColor && (!borderLeft && !borderRight && !borderTop && !borderBottom)) {
                        self._adjustLineItem(row - 1, col - 1, self._vGridLine, false);
                        self._adjustLineItem(row - 1, col - 1, self._hGridLine, true);
                    }
                };
                _Borders.prototype._addCellLineSide = function (row, col, x, y, width, height, lineStyle, store, hasRotate) {
                    if (lineStyle) {
                        var borderLine = this._queryLineItem(row, col, store, true);
                        if (borderLine) {
                            if (hasRotate || borderLine.style.style !== 6 && (lineStyle.style === 6 || BorderLayoutEngine._compareLineStyle(lineStyle, borderLine.style) >= 0)) {
                                borderLine.line = _createLine(x, y, width, height, lineStyle.color, lineStyle.style, hasRotate);
                                borderLine.style = lineStyle;
                            }
                        } else {
                            var newLine = _createLine(x, y, width, height, lineStyle.color, lineStyle.style, hasRotate);
                            if (newLine) {
                                borderLine = this._queryLineItem(row, col, store);
                                borderLine.line = newLine;
                                borderLine.style = lineStyle;
                            }
                        }
                        return borderLine && (borderLine.line !== keyword_null);
                    }
                    return false;
                };
                _Borders.prototype._addGridLine = function (row, col, x, y, width, height, needBottomLine, needRightLine, needTopLine, needLeftLine) {
                    var self = this;
                    var atViewport = (self._sheetArea === 3);
                    var gridLine = self._sheet.options.gridline;
                    if (atViewport && gridLine) {
                        var gridLineColor = gridLine.color;
                        if (gridLine.showHorizontalGridline) {
                            if (needBottomLine) {
                                var hGridLineItem = self._queryLineItem(row, col, self._hGridLine);
                                hGridLineItem.isGridLine = true;
                                hGridLineItem.line = _createLine(x, y + height - 0.5, x + width, y + height - 0.5, gridLineColor);
                            }
                            if (needTopLine) {
                                var hGridLineItemForFirstCol = self._queryLineItem(-1, col, self._hGridLine, false, true);
                                hGridLineItemForFirstCol.isGridLine = true;
                                hGridLineItemForFirstCol.line = _createLine(x, y - 0.5, x + width, y - 0.5, gridLineColor);
                            }
                        }
                        if (gridLine.showVerticalGridline) {
                            if (needRightLine) {
                                var vGridLineItem = self._queryLineItem(row, col, self._vGridLine);
                                vGridLineItem.isGridLine = true;
                                vGridLineItem.line = _createLine(x + width - 0.5, y, x + width - 0.5, y + height, gridLineColor);
                            }
                            if (needLeftLine) {
                                var vGridLineItemForFirstRow = self._queryLineItem(row, -1, self._vGridLine, false, true);
                                vGridLineItemForFirstRow.isGridLine = true;
                                vGridLineItemForFirstRow.line = _createLine(x - 0.5, y, x - 0.5, y + height, gridLineColor);
                            }
                        }
                    }
                };
                _Borders.prototype._adjustLineItem = function (r, c, store, h) {
                    var query = this._queryLineItem(r, c, store, true);
                    if (query) {
                        var lineItem = query;
                        if (lineItem.line) {
                            lineItem.line._adjust({ _orientation: (h ? 0 : 1), _offsetEnd: -1 });
                        }
                    }
                };
                _Borders.prototype._removeLineItem = function (r, c, store) {
                    if ((r >= 0 && c >= 0) ||
                        (r === 0 && c === -1) ||
                        (r === -1 && c === 0)) {
                        var firstDim = store[r];
                        if (firstDim) {
                            var secondDim = firstDim[c];
                            if (secondDim) {
                                delete firstDim[c];
                            }
                        }
                    }
                };
                _Borders.prototype._queryLineItem = function (r, c, store, noCreate, isTopLeftGridline) {
                    if (!isTopLeftGridline && (r === -1 || c === -1)) {
                        return keyword_null;
                    }
                    var firstDim = store[r];
                    if (!firstDim) {
                        if (noCreate) {
                            return keyword_null;
                        }
                        store[r] = firstDim = {};
                    }
                    var secondDim = firstDim[c];
                    if (!secondDim) {
                        if (noCreate) {
                            return keyword_null;
                        }
                        firstDim[c] = secondDim = {};
                    }
                    return secondDim;
                };
                _Borders.prototype._processOverflowCells = function () {
                    var self = this;
                    var overflowedCells = self._overflowedCells;
                    var overflowedCellsCount = overflowedCells.length;
                    var vBorders = self._vBorders;
                    var hBorders = self._hBorders;
                    var vGridLine = self._vGridLine;
                    var hGridLine = self._hGridLine;
                    for (var i = 0; i < overflowedCellsCount; i++) {
                        var overflowCell = overflowedCells[i];
                        var r = overflowCell._row;
                        var c = overflowCell._col;
                        var sc = overflowCell._startCol;
                        var style = overflowCell._style;
                        var ec = overflowCell._endCol;
                        var query = void 0;
                        var x = overflowCell._x;
                        var width = overflowCell._width;
                        var height = overflowCell._height;
                        var newBeginX = x;
                        var newEndX = void 0;
                        var textOrientation = style.textOrientation;
                        var borderTop = style.borderTop;
                        var beforeOverflowCell = overflowedCells[i - 1];
                        if (beforeOverflowCell && beforeOverflowCell._row === r && beforeOverflowCell._startCol === sc && beforeOverflowCell._endCol === ec) {
                            continue;
                        }
                        for (var c1 = sc; c1 < ec; c1++) {
                            query = self._queryLineItem(r, c1 + 1, vBorders, true);
                            if (query && !textOrientation) {
                                self._removeLineItem(r, c1 + 1, vBorders);
                            } else {
                                query = self._queryLineItem(r, c1, vGridLine, true);
                                if (query) {
                                    self._removeLineItem(r, c1, vGridLine);
                                }
                            }
                        }
                        var hBorder = self._queryLineItem(r, c, hBorders, true);
                        if (textOrientation && borderTop && !hBorder) {
                            var moveLength = void 0;
                            moveLength = height / Math.tan(Math.abs(textOrientation * Math.PI / 180));
                            if (textOrientation > -90 && textOrientation < 0) {
                                newBeginX = x - moveLength;
                            }
                            if (textOrientation > 0 && textOrientation < 90) {
                                newBeginX = x + moveLength;
                            }
                            newEndX = newBeginX + width;
                            for (var c2 = sc; c2 < ec + 1; c2++) {
                                var horGridLine = self._queryLineItem(r - 1, c2, hGridLine, true);
                                var line = horGridLine && horGridLine.line;
                                if (line) {
                                    if (!horGridLine.splitLines) {
                                        horGridLine.splitLines = [];
                                        horGridLine.splitLines.push(line);
                                    }
                                    for (var j = 0; j < horGridLine.splitLines.length; j++) {
                                        var lineInfo = horGridLine.splitLines[j];
                                        var x1 = lineInfo._x1;
                                        var x2 = lineInfo._x2;
                                        var y1 = lineInfo._y1;
                                        var y2 = lineInfo._y2;
                                        if (newBeginX > x1 && newEndX > x2 && x2 > newBeginX) {
                                            lineInfo._x2 = newBeginX;
                                            continue;
                                        }
                                        if (newBeginX < x1 && newEndX > x2) {
                                            self._removeLineItem(r - 1, c2, self._hGridLine);
                                            continue;
                                        }
                                        if (newBeginX < x1 && newEndX < x2 && x1 < newEndX) {
                                            lineInfo._x1 = newEndX;
                                            continue;
                                        }
                                        if (newBeginX > x1 && newEndX < x2) {
                                            horGridLine.splitLines.splice(j, 1, _createLine(x1, y1, newBeginX, y1, lineInfo.color), _createLine(newEndX, y2, x2, y2, lineInfo.color));
                                            break;
                                        }
                                        if ((newEndX < x1 && newEndX < x2) || (newBeginX > x1 && newBeginX > x2)) {
                                            continue;
                                        }
                                    }
                                }
                            }
                        }
                    }
                };
                _Borders.prototype._processSpans = function () {
                    var spanCells = this._spanCells;
                    var spanCellsCount = spanCells.length;
                    var spanLayout;
                    if (spanCellsCount > 0) {
                        for (var i = 0; i < spanCellsCount; i++) {
                            spanLayout = spanCells[i];
                            this._processSpanCell(spanLayout);
                        }
                    }
                };
                _Borders.prototype._createSpanCash = function () {
                    this._spanCash = {};
                    var spanCells = this._spanCells;
                    var spanCellsCount = spanCells.length;
                    var spanLayout;
                    if (spanCellsCount > 0) {
                        for (var i = 0; i < spanCellsCount; i++) {
                            spanLayout = spanCells[i];
                            for (var row = 0; row < spanLayout.rowCount; row++) {
                                var rowIndex = row + spanLayout.row;
                                this._spanCash[rowIndex] = this._spanCash[rowIndex] || {};
                                for (var col = 0; col < spanLayout.colCount; col++) {
                                    var colIndex = col + spanLayout.col;
                                    this._spanCash[rowIndex][colIndex] = spanLayout;
                                }
                            }
                        }
                    }
                };
                _Borders.prototype._processSpanCell = function (spanCellLayout) {
                    var self = this;
                    var row = spanCellLayout.row;
                    var col = spanCellLayout.col;
                    var x = spanCellLayout.x;
                    var y = spanCellLayout.y;
                    var spanSizeInfo = spanCellLayout.spanSizeInfo;
                    var borderLeft;
                    var borderTop;
                    var borderRight;
                    var borderBottom;
                    var spanCellStyle = spanSizeInfo.styleList[0][0];
                    var backColor = spanCellStyle ? spanCellStyle.backColor : keyword_null;
                    var i;
                    var r;
                    var c;
                    var rowHeight;
                    var colWidth;
                    var firstCol;
                    var firstRow;
                    var lastCol;
                    var lastRow;
                    var cellStyle;
                    var ix = x;
                    var iy = y;
                    var diagonalDownStyle = null;
                    var isNeedCompareDiagonalDownStyle = true;
                    var diagonalUpStyle = null;
                    var isNeedCompareDiagonalUpStyle = true;
                    var beginCellStyle;
                    if (spanCellLayout.rowCount === 1) {
                        r = row;
                        rowHeight = spanSizeInfo.rowSizes[0];
                        for (i = 0; i < spanCellLayout.colCount; i++) {
                            firstCol = (i === 0);
                            lastCol = (i === spanCellLayout.colCount - 1);
                            c = col + i;
                            colWidth = spanSizeInfo.colSizes[i];
                            cellStyle = spanSizeInfo.styleList[0][i];
                            if (r === spanCellLayout.row && c === spanCellLayout.col) {
                                beginCellStyle = cellStyle;
                                diagonalDownStyle = beginCellStyle && beginCellStyle.diagonalDown;
                                diagonalUpStyle = beginCellStyle && beginCellStyle.diagonalUp;
                            }
                            if (cellStyle) {
                                borderLeft = cellStyle.borderLeft;
                                borderTop = cellStyle.borderTop;
                                borderRight = cellStyle.borderRight;
                                borderBottom = cellStyle.borderBottom;
                                if (isNeedCompareDiagonalDownStyle) {
                                    isNeedCompareDiagonalDownStyle = BorderLayoutEngine._compareTwoLineStyleIsSame(diagonalDownStyle, cellStyle.diagonalDown);
                                }
                                if (isNeedCompareDiagonalUpStyle) {
                                    isNeedCompareDiagonalUpStyle = BorderLayoutEngine._compareTwoLineStyleIsSame(diagonalUpStyle, cellStyle.diagonalUp);
                                }
                            } else {
                                borderLeft = borderTop = borderRight = borderBottom = keyword_null;
                            }
                            if (firstCol) {
                                self._addCellLineImp(r, c, ix, iy, colWidth, rowHeight, borderLeft, borderTop, keyword_null, borderBottom, keyword_null, keyword_null, backColor, false, true);
                            } else if (lastCol) {
                                self._addCellLineImp(r, c, ix, iy, colWidth, rowHeight, keyword_null, borderTop, borderRight, borderBottom, keyword_null, keyword_null, backColor, false, false);
                            } else {
                                self._addCellLineImp(r, c, ix, iy, colWidth, rowHeight, keyword_null, borderTop, keyword_null, borderBottom, keyword_null, keyword_null, backColor, false, true);
                            }
                            ix += colWidth;
                        }
                        diagonalDownStyle = isNeedCompareDiagonalDownStyle ? diagonalDownStyle : null;
                        diagonalUpStyle = isNeedCompareDiagonalUpStyle ? diagonalUpStyle : null;
                        self._addCellLineImp(spanCellLayout.row, spanCellLayout.col, spanCellLayout.x, spanCellLayout.y, spanCellLayout.width, spanCellLayout.height, keyword_null, keyword_null, keyword_null, keyword_null, diagonalDownStyle, diagonalUpStyle, keyword_null, true, true);
                    } else if (spanCellLayout.colCount === 1) {
                        c = col;
                        colWidth = spanSizeInfo.colSizes[0];
                        for (i = 0; i < spanCellLayout.rowCount; i++) {
                            firstRow = (i === 0);
                            lastRow = (i === spanCellLayout.rowCount - 1);
                            r = row + i;
                            rowHeight = spanSizeInfo.rowSizes[i];
                            cellStyle = spanSizeInfo.styleList[i][0];

                            if (r === spanCellLayout.row && c === spanCellLayout.col) {
                                beginCellStyle = cellStyle;
                                diagonalDownStyle = beginCellStyle && beginCellStyle.diagonalDown;
                                diagonalUpStyle = beginCellStyle && beginCellStyle.diagonalUp;
                            }
                            if (cellStyle) {
                                borderLeft = cellStyle.borderLeft;
                                borderTop = cellStyle.borderTop;
                                borderRight = cellStyle.borderRight;
                                borderBottom = cellStyle.borderBottom;
                                if (isNeedCompareDiagonalDownStyle) {
                                    isNeedCompareDiagonalDownStyle = BorderLayoutEngine._compareTwoLineStyleIsSame(diagonalDownStyle, cellStyle.diagonalDown);
                                }
                                if (isNeedCompareDiagonalUpStyle) {
                                    isNeedCompareDiagonalUpStyle = BorderLayoutEngine._compareTwoLineStyleIsSame(diagonalUpStyle, cellStyle.diagonalUp);
                                }
                            } else {
                                borderLeft = borderTop = borderRight = borderBottom = keyword_null;
                            }
                            if (firstRow) {
                                self._addCellLineImp(r, c, ix, iy, colWidth, rowHeight, borderLeft, borderTop, borderRight, keyword_null, keyword_null, keyword_null, backColor, true, false);
                            } else if (lastRow) {
                                self._addCellLineImp(r, c, ix, iy, colWidth, rowHeight, borderLeft, keyword_null, borderRight, borderBottom, keyword_null, keyword_null, backColor, false, false);
                            } else {
                                self._addCellLineImp(r, c, ix, iy, colWidth, rowHeight, borderLeft, keyword_null, borderRight, keyword_null, keyword_null, keyword_null, backColor, true, false);
                            }
                            iy += rowHeight;
                        }
                        diagonalDownStyle = isNeedCompareDiagonalDownStyle ? diagonalDownStyle : null;
                        diagonalUpStyle = isNeedCompareDiagonalUpStyle ? diagonalUpStyle : null;
                        self._addCellLineImp(spanCellLayout.row, spanCellLayout.col, spanCellLayout.x, spanCellLayout.y, spanCellLayout.width, spanCellLayout.height, keyword_null, keyword_null, keyword_null, keyword_null, diagonalDownStyle, diagonalUpStyle, keyword_null, true, true);
                    } else {
                        for (i = 0; i < spanCellLayout.rowCount; i++) {
                            r = row + i;
                            firstRow = (i === 0);
                            lastRow = (i === spanCellLayout.rowCount - 1);
                            rowHeight = spanSizeInfo.rowSizes[i];
                            for (var j = 0; j < spanCellLayout.colCount; j++) {
                                c = col + j;
                                firstCol = (j === 0);
                                lastCol = (j === spanCellLayout.colCount - 1);
                                colWidth = spanSizeInfo.colSizes[j];
                                cellStyle = spanSizeInfo.styleList[i][j];
                                if (r === spanCellLayout.row && c === spanCellLayout.col) {
                                    beginCellStyle = cellStyle;
                                    diagonalDownStyle = beginCellStyle && beginCellStyle.diagonalDown;
                                    diagonalUpStyle = beginCellStyle && beginCellStyle.diagonalUp;
                                }
                                if (cellStyle) {
                                    borderLeft = cellStyle.borderLeft;
                                    borderTop = cellStyle.borderTop;
                                    borderRight = cellStyle.borderRight;
                                    borderBottom = cellStyle.borderBottom;
                                    if (isNeedCompareDiagonalDownStyle) {
                                        isNeedCompareDiagonalDownStyle = BorderLayoutEngine._compareTwoLineStyleIsSame(diagonalDownStyle, cellStyle.diagonalDown);
                                    }
                                    if (isNeedCompareDiagonalUpStyle) {
                                        isNeedCompareDiagonalUpStyle = BorderLayoutEngine._compareTwoLineStyleIsSame(diagonalUpStyle, cellStyle.diagonalUp);
                                    }
                                } else {
                                    borderLeft = borderTop = borderRight = borderBottom = keyword_null;
                                }
                                if (firstRow) {
                                    if (firstCol) {
                                        self._addCellLineImp(r, c, ix, iy, colWidth, rowHeight, borderLeft, borderTop, keyword_null, keyword_null, keyword_null, keyword_null, backColor, true, true);
                                    } else if (lastCol) {
                                        self._addCellLineImp(r, c, ix, iy, colWidth, rowHeight, keyword_null, borderTop, borderRight, keyword_null, keyword_null, keyword_null, backColor, true, false);
                                    } else {
                                        self._addCellLineImp(r, c, ix, iy, colWidth, rowHeight, keyword_null, borderTop, keyword_null, keyword_null, keyword_null, keyword_null, backColor, true, true);
                                    }
                                } else if (lastRow) {
                                    if (firstCol) {
                                        self._addCellLineImp(r, c, ix, iy, colWidth, rowHeight, borderLeft, keyword_null, keyword_null, borderBottom, keyword_null, keyword_null, backColor, false, true);
                                    } else if (lastCol) {
                                        self._addCellLineImp(r, c, ix, iy, colWidth, rowHeight, keyword_null, keyword_null, borderRight, borderBottom, keyword_null, keyword_null, backColor, false, false);
                                    } else {
                                        self._addCellLineImp(r, c, ix, iy, colWidth, rowHeight, keyword_null, keyword_null, keyword_null, borderBottom, keyword_null, keyword_null, backColor, false, true);
                                    }
                                } else if (firstCol) {
                                    self._addCellLineImp(r, c, ix, iy, colWidth, rowHeight, borderLeft, keyword_null, keyword_null, keyword_null, keyword_null, keyword_null, backColor, true, true);
                                } else if (lastCol) {
                                    self._addCellLineImp(r, c, ix, iy, colWidth, rowHeight, keyword_null, keyword_null, borderRight, keyword_null, keyword_null, keyword_null, backColor, true, false);
                                }
                                ix += colWidth;
                            }
                            ix = x;
                            iy += rowHeight;
                        }
                        diagonalDownStyle = isNeedCompareDiagonalDownStyle ? diagonalDownStyle : null;
                        diagonalUpStyle = isNeedCompareDiagonalUpStyle ? diagonalUpStyle : null;
                        self._addCellLineImp(spanCellLayout.row, spanCellLayout.col, spanCellLayout.x, spanCellLayout.y, spanCellLayout.width, spanCellLayout.height, keyword_null, keyword_null, keyword_null, keyword_null, diagonalDownStyle, diagonalUpStyle, keyword_null, true, true);
                    }
                    if (backColor && (!borderLeft && !borderRight && !borderTop && !borderBottom)) {
                        self._adjustingRanges.push({
                            r: row,
                            c: col,
                            rc: spanCellLayout.rowCount,
                            cc: spanCellLayout.colCount
                        });
                    }
                };
                _Borders.prototype._adjust = function () {
                    var self = this;
                    var hasVBorders = false;
                    var hasHBorders = false;
                    var hasDownDiagonals = false;
                    var hasUpDiagonals = false;
                    if (!$_isEmptyObject(self._vBorders)) {
                        hasVBorders = true;
                    }
                    if (!$_isEmptyObject(self._hBorders)) {
                        hasHBorders = true;
                    }
                    if (hasVBorders || hasHBorders) {
                        self._adjustBorders();

                        self._adjustDoubleLineBordersWithDiagonalDoubleLine();
                    }
                    if (!$_isEmptyObject(self._downDiagonals)) {
                        hasDownDiagonals = true;
                    }
                    if (!$_isEmptyObject(self._upDiagonals)) {
                        hasUpDiagonals = true;
                    }
                    if (hasDownDiagonals || hasUpDiagonals) {
                        self._adjustDiagonal();
                    }
                    if (self._adjustingRanges.length > 0) {
                        self._adjustGridlines();
                    }
                };

                _Borders.prototype._getSpanBorderLineWith = function (row, col, vertical, cache, borderPosition) {
                    var self = this;
                    var span = this._spanCash[row] ? this._spanCash[row][col] : null;
                    if (span) {
                        switch (borderPosition) {
                            case SPAN_BORDER_POSITION.H_TOP_LEFT:
                                return self._getLineItem(row, col, vertical, cache);
                            case SPAN_BORDER_POSITION.H_TOP_Right:
                                return self._getLineItem(row, col + span.colCount - 1, vertical, cache);
                            case SPAN_BORDER_POSITION.V_RIGHT_TOP:
                                return self._getLineItem(row, col + span.colCount - 1, vertical, cache);
                            case SPAN_BORDER_POSITION.V_RIGHT_BOTTOM:
                                return self._getLineItem(row + span.rowCount - 1, col + span.colCount - 1, vertical, cache);
                            case SPAN_BORDER_POSITION.H_BOTTOM_RIGHT:
                                return self._getLineItem(row + span.rowCount - 1, col + span.colCount - 1, vertical, cache);
                            case SPAN_BORDER_POSITION.H_BOTTOM_LEFT:
                                return self._getLineItem(row + span.rowCount - 1, col, vertical, cache);
                            case SPAN_BORDER_POSITION.V_LEFT_BOTTOM:
                                return self._getLineItem(row + span.rowCount - 1, col, vertical, cache);
                            case SPAN_BORDER_POSITION.V_LEFT_TOP:
                                return self._getLineItem(row, col, vertical, cache);
                        }
                    }
                    return self._getLineItem(row, col, vertical, cache);
                };
                _Borders.prototype._adjustDiagonal = function () {
                    var self = this;
                    var rowIndecies = self._rowIndecies;
                    var colIndecies = self._colIndecies;
                    var rowIndexCount = rowIndecies.length;
                    var colIndexCount = colIndecies.length;
                    var r;
                    var c;
                    var row;
                    var col;
                    var topLine;
                    var leftLine;
                    var bottomLine;
                    var rightLine;
                    var cacheTop = {};
                    var cacheLeft = {};
                    var topLine1;
                    var leftLine1;
                    var bottomLine1;
                    var rightLine1;
                    for (r = 0; r < rowIndexCount; r++) {
                        row = rowIndecies[r];
                        for (c = 0; c < colIndexCount; c++) {
                            col = colIndecies[c];
                            var diagonalDown = self._queryLineItem(row, col, self._downDiagonals, false);
                            var diagonalUp = self._queryLineItem(row, col, self._upDiagonals, false);
                            if (!diagonalDown && !diagonalUp) {
                                continue;
                            }
                            if (BorderLayoutEngine._isDoubleLineItem(diagonalDown) && BorderLayoutEngine._isDoubleLineItem(diagonalUp)) {
                                diagonalDown.line._adjustSever();
                                diagonalUp.line._adjustSever();
                            }

                            var adjustLength = [];
                            topLine = self._getSpanBorderLineWith(row, col, false, cacheTop, SPAN_BORDER_POSITION.H_TOP_LEFT);
                            if (topLine && topLine.line && !topLine.isGridLine) {
                                adjustLength = [1, 1, 2];
                                self._adjustDiagonalImp(adjustLength, topLine, diagonalDown, true, 1);
                            }
                            topLine1 = self._getSpanBorderLineWith(row, col, false, cacheTop, SPAN_BORDER_POSITION.H_TOP_Right);
                            if (topLine1 && topLine1.line && !topLine1.isGridLine) {
                                adjustLength = [1, 1, 2];
                                self._adjustDiagonalImp(adjustLength, topLine1, diagonalUp, true, 1);
                            }
                            leftLine = self._getSpanBorderLineWith(row, col, true, cacheLeft, SPAN_BORDER_POSITION.V_LEFT_TOP);
                            if (leftLine && leftLine.line && !leftLine.isGridLine) {
                                adjustLength = [1, 1, 2];
                                self._adjustDiagonalImp(adjustLength, leftLine, diagonalDown, true, 0);
                            }
                            leftLine1 = self._getSpanBorderLineWith(row, col, true, cacheLeft, SPAN_BORDER_POSITION.V_LEFT_BOTTOM);
                            if (leftLine1 && leftLine1.line && !leftLine1.isGridLine) {
                                adjustLength = [1, 1, 2];
                                self._adjustDiagonalImp(adjustLength, leftLine1, diagonalUp, false, 0);
                            }
                            bottomLine = self._getSpanBorderLineWith(row + 1, col, false, cacheTop, SPAN_BORDER_POSITION.H_BOTTOM_LEFT);
                            if (bottomLine && bottomLine.line && !bottomLine.isGridLine) {
                                adjustLength = [-1, -2, -2];
                                self._adjustDiagonalImp(adjustLength, bottomLine, diagonalUp, false, 1);
                            }
                            bottomLine1 = self._getSpanBorderLineWith(row + 1, col, false, cacheTop, SPAN_BORDER_POSITION.H_BOTTOM_RIGHT);
                            if (bottomLine1 && bottomLine1.line && !bottomLine1.isGridLine) {
                                adjustLength = [-1, -2, -2];
                                self._adjustDiagonalImp(adjustLength, bottomLine1, diagonalDown, false, 1);
                            }
                            rightLine = self._getSpanBorderLineWith(row, col + 1, true, cacheLeft, SPAN_BORDER_POSITION.V_RIGHT_TOP);
                            if (rightLine && rightLine.line && !rightLine.isGridLine) {
                                adjustLength = [-1, -2, -2];
                                self._adjustDiagonalImp(adjustLength, rightLine, diagonalUp, true, 0);
                            }
                            rightLine1 = self._getSpanBorderLineWith(row, col + 1, true, cacheLeft, SPAN_BORDER_POSITION.V_RIGHT_BOTTOM);
                            if (rightLine1 && rightLine1.line && !rightLine1.isGridLine) {
                                adjustLength = [-1, -2, -2];
                                self._adjustDiagonalImp(adjustLength, rightLine1, diagonalDown, false, 0);
                            }
                        }
                    }
                };
                _Borders.prototype._adjustDiagonalImp = function (lengthArray, compareLine, diagonalLine, diagonalLineIsStart, orientation) {
                    var borderIsDoubleLine = BorderLayoutEngine._isDoubleLineItem(compareLine);
                    var isSlantedLine = BorderLayoutEngine._isSlantedLine(compareLine);
                    var lineWidth = compareLine.line._lineWidth;
                    if (borderIsDoubleLine) {
                        lineWidth = 3;
                    }
                    if (isSlantedLine) {
                        lineWidth = 2;
                    }
                    var length = lengthArray[lineWidth - 1];
                    var option;
                    if (diagonalLine && diagonalLine.line) {
                        option = { _orientation: orientation };
                        if (diagonalLineIsStart) {
                            option._offsetStart = length;
                        } else {
                            option._offsetEnd = length;
                        }
                        diagonalLine.line._adjust(option);
                    }
                };
                _Borders.prototype._adjustGridlines = function () {
                    var self = this;
                    var adjustingRanges = self._adjustingRanges;
                    var adjustingRangesCount = adjustingRanges.length;
                    for (var i = 0; i < adjustingRangesCount; i++) {
                        var range = adjustingRanges[i];
                        var r = range.r;
                        var c = range.c;
                        var ar1 = r;
                        var ar2 = r - 1;
                        var ac1 = c - 1;
                        var ac2 = c;
                        if (range.rc > 1) {
                            ar1 += range.rc - 1;
                        }
                        if (range.cc > 1) {
                            ac2 += range.cc - 1;
                        }
                        var skipLeftBottom = false;
                        var skipRightTop = false;
                        for (var j = i + 1; j < adjustingRangesCount; j++) {
                            var next = adjustingRanges[j];
                            if (next.c === ac2 + 1 && next.r === r) {
                                skipRightTop = true;
                            }
                            if (next.r === ar1 + 1 && next.c === c) {
                                skipLeftBottom = true;
                            }
                            if (skipLeftBottom && skipRightTop) {
                                break;
                            }
                            if (next.r > r + 1 && next.c > c + 1) {
                                break;
                            }
                        }
                        if (!skipLeftBottom) {
                            self._adjustLineItem(ar1, ac1, self._hGridLine, true);
                        }
                        if (!skipRightTop) {
                            self._adjustLineItem(ar2, ac2, self._vGridLine, false);
                        }
                    }
                };
                _Borders.prototype._adjustBorders = function () {
                    var self = this;
                    var rowIndecies = self._rowIndecies;
                    var colIndecies = self._colIndecies;
                    var rowIndexCount = rowIndecies.length;
                    var colIndexCount = colIndecies.length;
                    var r;
                    var c;
                    var row;
                    var col;
                    var cacheH = {};
                    var cacheV = {};
                    var upV;
                    var leftH;
                    var currentH;
                    var currentV;
                    var downV;
                    var downLeftH;
                    var downH;
                    var rightH;
                    var upRightV;
                    var rightV;
                    var borderLineCountV;
                    var borderLineCountH;
                    for (r = 0; r < rowIndexCount; r++) {
                        row = rowIndecies[r];
                        for (c = 0; c < colIndexCount; c++) {
                            col = colIndecies[c];
                            borderLineCountV = 0;
                            borderLineCountH = 0;
                            var lineV = self._queryLineItem(row, col, self._vBorders, true);
                            if (!lineV) {
                                lineV = self._queryLineItem(row, col - 1, self._vGridLine, true);
                            } else if (lineV.line && lineV.line._isRotate) {
                                continue;
                            } else {
                                borderLineCountV++;
                            }
                            var lineH = self._queryLineItem(row, col, self._hBorders, true);
                            if (!lineH) {
                                lineH = self._queryLineItem(row - 1, col, self._hGridLine, true);
                            } else {
                                borderLineCountH++;
                            }
                            if (!lineV && !lineH) {
                                continue;
                            }
                            upV = r === 0 ? keyword_null : self._getLineItem(rowIndecies[r - 1], col, true, cacheV);
                            if (upV && upV.line && !upV.isGridLine) {
                                borderLineCountV++;
                                borderLineCountH++;
                            }
                            leftH = c === 0 ? keyword_null : self._getLineItem(row, colIndecies[c - 1], false, cacheH);
                            if (leftH && leftH.line && !leftH.isGridLine) {
                                borderLineCountV++;
                                borderLineCountH++;
                            }
                            if (lineV) {
                                currentH = self._getLineItem(row, col, false, cacheH);
                                if (currentH && currentH.line && !currentH.isGridLine) {
                                    borderLineCountV++;
                                }
                                if (r !== rowIndexCount - 1) {
                                    downV = self._getLineItem(rowIndecies[r + 1], col, true, cacheV);
                                    if (downV && downV.line && !downV.isGridLine) {
                                        borderLineCountV++;
                                    }
                                }
                                if (c !== 0 && r !== rowIndexCount - 1) {
                                    downLeftH = self._getLineItem(rowIndecies[r + 1], colIndecies[c - 1], false, cacheH);
                                    if (downLeftH && downLeftH.line && !downLeftH.isGridLine) {
                                        borderLineCountV++;
                                    }
                                }
                                if (r !== rowIndexCount - 1) {
                                    downH = self._getLineItem(rowIndecies[r + 1], col, false, cacheH);
                                    if (downH && downH.line && !downH.isGridLine) {
                                        borderLineCountV++;
                                    }
                                }
                                if (borderLineCountV > 0) {
                                    if (BorderLayoutEngine._isDoubleLine(lineV.style)) {
                                        BorderLayoutEngine._calcDoubleLayout(lineV, upV, leftH, currentH, downV, downLeftH, downH, true);
                                    } else if (BorderLayoutEngine._isSlantedLine(lineV.style)) {

                                    } else {
                                        BorderLayoutEngine._calcLayoutVertical(lineV, upV, leftH, currentH, downV, downLeftH, downH);
                                    }
                                }
                            }
                            if (lineH) {
                                currentV = self._getLineItem(row, col, true, cacheV);
                                if (currentV && currentV.line && !currentV.isGridLine) {
                                    borderLineCountH++;
                                }
                                if (c !== colIndexCount - 1) {
                                    rightH = self._getLineItem(row, colIndecies[c + 1], false, cacheH);
                                    if (rightH && rightH.line && !rightH.isGridLine) {
                                        borderLineCountH++;
                                    }
                                }
                                if (r !== 0 && c !== colIndexCount - 1) {
                                    upRightV = self._getLineItem(rowIndecies[r - 1], colIndecies[c + 1], true, cacheV);
                                    if (upRightV && upRightV.line && !upRightV.isGridLine) {
                                        borderLineCountH++;
                                    }
                                }
                                if (c !== colIndexCount - 1) {
                                    rightV = self._getLineItem(row, colIndecies[c + 1], true, cacheV);
                                    if (rightV && rightV.line && !rightV.isGridLine) {
                                        borderLineCountH++;
                                    }
                                }
                                if (borderLineCountH > 0) {
                                    if (BorderLayoutEngine._isDoubleLine(lineH.style)) {
                                        BorderLayoutEngine._calcDoubleLayout(lineH, leftH, upV, currentV, rightH, upRightV, rightV, false);
                                    } else if (BorderLayoutEngine._isSlantedLine(lineH.style)) {

                                    } else {
                                        BorderLayoutEngine._calcLayoutHorizontal(lineH, leftH, upV, currentV, rightH, upRightV, rightV);
                                    }
                                }
                            }
                        }
                    }
                };
                _Borders.prototype._getSpanDiagonals = function (row, col, isDiagonalUp, pointPosition) {
                    var self = this;
                    var span = this._spanCash[row] ? this._spanCash[row][col] : null;
                    var store = isDiagonalUp ? self._upDiagonals : self._downDiagonals;
                    if (span) {
                        if (row === span.row && col === span.col && pointPosition === SPAN_POINT_POSITION.LEFT_TOP) {
                            return self._queryLineItem(span.row, span.col, store, false);
                        } else if (row === span.row && col === span.col + span.colCount - 1 && pointPosition === SPAN_POINT_POSITION.RIGHT_TOP) {
                            return self._queryLineItem(span.row, span.col, store, false);
                        } else if (row === span.row + span.rowCount - 1 && col === span.col + span.colCount - 1 && pointPosition === SPAN_POINT_POSITION.RIGHT_BOTTOM) {
                            return self._queryLineItem(span.row, span.col, store, false);
                        } else if (row === span.row + span.rowCount - 1 && col === span.col && pointPosition === SPAN_POINT_POSITION.LEFT_BOTTOM) {
                            return self._queryLineItem(span.row, span.col, store, false);
                        }
                    } else {
                        return self._queryLineItem(row, col, store, false);
                    }
                };
                _Borders.prototype._adjustDoubleLineBordersWithDiagonalDoubleLine = function () {
                    var self = this;
                    var rowIndecies = self._rowIndecies;
                    var colIndecies = self._colIndecies;
                    var rowIndexCount = rowIndecies.length;
                    var colIndexCount = colIndecies.length;
                    var r;
                    var c;
                    var row;
                    var col;
                    var diagonalDown;
                    var diagonalUp;
                    var downDiagonalIsDoubleLine;
                    var upDiagonalIsDoubleLine;
                    var beforeDownDiagonal;
                    var beforeUpDiagonal;
                    var beforeDownDiagonalIsDoubleLine;
                    var beforeUpDiagonalIsDoubleLine;
                    var option;
                    for (r = 0; r < rowIndexCount; r++) {
                        row = rowIndecies[r];
                        for (c = 0; c < colIndexCount; c++) {
                            col = colIndecies[c];
                            var lineV = self._queryLineItem(row, col, self._vBorders, true);
                            if (lineV && lineV.line && lineV.line._noNeedAdjust) {
                                continue;
                            }
                            if (lineV && lineV.line && BorderLayoutEngine._isDoubleLineItem(lineV)) {
                                diagonalDown = self._getSpanDiagonals(row, col, false, SPAN_POINT_POSITION.LEFT_TOP);
                                diagonalUp = self._getSpanDiagonals(row, col, true, SPAN_POINT_POSITION.LEFT_BOTTOM);
                                downDiagonalIsDoubleLine = BorderLayoutEngine._isDoubleLineItem(diagonalDown);
                                upDiagonalIsDoubleLine = BorderLayoutEngine._isDoubleLineItem(diagonalUp);
                                beforeDownDiagonal = self._getSpanDiagonals(row, (col - 1), false, SPAN_POINT_POSITION.RIGHT_BOTTOM);
                                beforeUpDiagonal = self._getSpanDiagonals(row, (col - 1), true, SPAN_POINT_POSITION.RIGHT_TOP);
                                beforeDownDiagonalIsDoubleLine = BorderLayoutEngine._isDoubleLineItem(beforeDownDiagonal);
                                beforeUpDiagonalIsDoubleLine = BorderLayoutEngine._isDoubleLineItem(beforeUpDiagonal);
                                if (diagonalDown && downDiagonalIsDoubleLine) {
                                    option = {
                                        _lineSide: 2,
                                        _orientation: 1,
                                        _offsetStart: 2
                                    };
                                    lineV.line._adjust(option);
                                }
                                if (diagonalUp && upDiagonalIsDoubleLine) {
                                    option = {
                                        _lineSide: 2,
                                        _orientation: 1,
                                        _offsetEnd: -2
                                    };
                                    lineV.line._adjust(option);
                                }
                                if (beforeDownDiagonal && beforeDownDiagonalIsDoubleLine) {
                                    option = {
                                        _lineSide: 1,
                                        _orientation: 1,
                                        _offsetEnd: -2
                                    };
                                    lineV.line._adjust(option);
                                }
                                if (beforeUpDiagonal && beforeUpDiagonalIsDoubleLine) {
                                    option = {
                                        _lineSide: 1,
                                        _orientation: 1,
                                        _offsetStart: 2
                                    };
                                    lineV.line._adjust(option);
                                }
                            }
                            var lineH = self._queryLineItem(row, col, self._hBorders, true);
                            if (lineH && lineH.line && BorderLayoutEngine._isDoubleLineItem(lineH)) {
                                diagonalDown = self._getSpanDiagonals(row, col, false, SPAN_POINT_POSITION.LEFT_TOP);
                                diagonalUp = self._getSpanDiagonals(row, col, true, SPAN_POINT_POSITION.RIGHT_TOP);
                                downDiagonalIsDoubleLine = BorderLayoutEngine._isDoubleLineItem(diagonalDown);
                                upDiagonalIsDoubleLine = BorderLayoutEngine._isDoubleLineItem(diagonalUp);
                                beforeDownDiagonal = self._getSpanDiagonals((row - 1), col, false, SPAN_POINT_POSITION.RIGHT_BOTTOM);
                                beforeUpDiagonal = self._getSpanDiagonals((row - 1), col, true, SPAN_POINT_POSITION.LEFT_BOTTOM);
                                beforeDownDiagonalIsDoubleLine = BorderLayoutEngine._isDoubleLineItem(beforeDownDiagonal);
                                beforeUpDiagonalIsDoubleLine = BorderLayoutEngine._isDoubleLineItem(beforeUpDiagonal);
                                if (diagonalDown && downDiagonalIsDoubleLine) {
                                    option = {
                                        _lineSide: 2,
                                        _orientation: 0,
                                        _offsetStart: 2
                                    };
                                    lineH.line._adjust(option);
                                }
                                if (diagonalUp && upDiagonalIsDoubleLine) {
                                    option = {
                                        _lineSide: 2,
                                        _orientation: 0,
                                        _offsetEnd: -2
                                    };
                                    lineH.line._adjust(option);
                                }
                                if (beforeDownDiagonal && beforeDownDiagonalIsDoubleLine) {
                                    option = {
                                        _lineSide: 1,
                                        _orientation: 0,
                                        _offsetEnd: -2
                                    };
                                    lineH.line._adjust(option);
                                }
                                if (beforeUpDiagonal && beforeUpDiagonalIsDoubleLine) {
                                    option = {
                                        _lineSide: 1,
                                        _orientation: 0,
                                        _offsetStart: 2
                                    };
                                    lineH.line._adjust(option);
                                }
                            }
                        }
                    }
                };
                _Borders.prototype._getLineItem = function (r, c, vertical, cache) {
                    var rowCache = cache[r];
                    if (!rowCache) {
                        rowCache = cache[r] = {};
                    }
                    var line = rowCache[c];
                    if (line === keyword_undefined) {
                        line = rowCache[c] = this._getLineItemImp(r, c, vertical);
                    }
                    return line;
                };
                _Borders.prototype._getLineItemImp = function (r, c, vertical) {
                    if (r === keyword_undefined || r < 0 || c === keyword_undefined || c < 0) {
                        return keyword_null;
                    }
                    var self = this;
                    var store = vertical ? self._vBorders : self._hBorders;
                    var query = self._queryLineItem(r, c, store, true);
                    if (query) {
                        return query;
                    }
                    store = vertical ? self._vGridLine : self._hGridLine;
                    if (vertical) {
                        --c;
                        if (c < 0) {
                            return keyword_null;
                        }
                    } else {
                        --r;
                        if (r < 0) {
                            return keyword_null;
                        }
                    }
                    query = self._queryLineItem(r, c, store, true);
                    if (query) {
                        return query;
                    }
                    return keyword_null;
                };
                _Borders.prototype.paint = function (context) {
                    var self = this;
                    if (!self._isInitialized) {
                        return;
                    }
                    if (!self._isMerged) {
                        self._createSpanCash();
                        self._processSpans();
                        self._processOverflowCells();
                        self._adjust();
                        self._isMerged = true;
                    }
                    context.save();
                    self._paint(context);
                    context.restore();
                };
                _Borders.prototype._paint = function (context) {
                    this._paintGridLine(context);
                    this._paintBorderLines(context);
                };
                _Borders.prototype._paintGridLine = function (context) {
                    var self = this;
                    self._paintLines(context, self._hGridLine);
                    self._paintLines(context, self._vGridLine);
                };
                _Borders.prototype._paintBorderLines = function (context) {
                    var self = this;
                    self._paintLines(context, self._hBorders);
                    self._paintLines(context, self._vBorders);
                    self._paintLines(context, self._downDiagonals);
                    self._paintLines(context, self._upDiagonals);
                };
                _Borders.prototype._paintLines = function (context, store) {
                    var i;
                    var j;
                    var firstDim;
                    var line;
                    var splitLines;
                    for (i in store) {
                        if (store[i]) {
                            firstDim = store[i];
                            for (j in firstDim) {
                                if (firstDim[j]) {
                                    line = firstDim[j].line;
                                    splitLines = firstDim[j].splitLines;
                                    if (splitLines && splitLines.length > 0) {
                                        for (var k = 0; k < splitLines.length; k++) {
                                            if (splitLines[k]) {
                                                splitLines[k]._paint(context);
                                            }
                                        }
                                    } else if (line) {
                                        line._paint(context);
                                    }
                                }
                            }
                        }
                    }
                };
                return _Borders;
            }());
            exports._Borders = _Borders;
        }),
        './dist/core/worksheet/worksheet-edit.js': (function (module, exports, __webpack_require__) {
            Object.defineProperty(exports, '__esModule', { value: true });
            var core_ns_1 = __webpack_require__(/*! ../core.ns */ './dist/core/core.ns.js');
            var worksheet_1 = __webpack_require__(/*! ./worksheet */ './dist/core/worksheet/worksheet.js');
            var common_1 = __webpack_require__(/*! ../util/common */ './dist/core/util/common.js');
            var DomUtilModule = __webpack_require__(/*! ../util/domUtil */ './dist/core/util/domUtil.js');
            var $ = DomUtilModule.GC$;
            var Common_1 = __webpack_require__(/*! Common */ 'Common');
            var core_enum_1 = __webpack_require__(/*! ../core.enum */ './dist/core/core.enum.js');
            var CalcEngine = __webpack_require__(/*! CalcEngine */ 'CalcEngine');
            var _supportsCalc = !!CalcEngine;
            var browser = common_1._util._browser;
            var device = common_1._util._device();
            var isNullOrUndefined = Common_1.Common._Types._isNullOrUndefined;
            var _StringHelper = Common_1.Common._StringHelper;
            var CultureManager = Common_1.Common.CultureManager;
            var keyword_null = null;
            var keyword_undefined = void 0;
            var const_string = 'string';
            var convertRichTextValue = common_1._util._convertRichTextValue;
            var rm = new Common_1.Common.ResourceManager(core_ns_1.SR);
            var getSR = rm.getResource.bind(rm);
            var sheetEx = {
                startEdit: function (selectAll, defaultText) {
                    var self = this;
                    self._startEditImp(self._getCanvas(), self._activeRowIndex, self._activeColIndex, keyword_null, keyword_null, selectAll, defaultText);
                },
                editorStatus: function () {
                    return this._editorStatus || 0;
                },
                isEditing: function () {
                    var editorStatus = this._editorStatus;
                    return editorStatus === 1 || editorStatus === 2;
                },
                endEdit: function (ignoreValueChange) {
                    return this._endEditImp(ignoreValueChange);
                },
                _endEditImp: function (ignoreValueChange, endEditType, ignoreFormulaTextbox, ignoreCorssSheetFormulaTextbox) {
                    var self = this;
                    if (!self.isEditing()) {
                        return true;
                    }
                    self.suspendPaint();
                    try {
                        return self._endEditCore(ignoreValueChange, endEditType, ignoreFormulaTextbox, ignoreCorssSheetFormulaTextbox);
                    } finally {
                        self.resumePaint();
                    }
                },
                _endEditCore: function (ignoreValueChange, endEditType, ignoreFormulaTextbox, ignoreCorssSheetFormulaTextbox) {
                    var self = this;
                    var eventHandler = self._eventHandler;
                    var editor = self._editor;
                    var name = self.name();
                    var activeRowIndex = self._activeRowIndex;
                    var activeColIndex = self._activeColIndex;
                    var applyResult;
                    var value;
                    var ct = self.getCellType(activeRowIndex, activeColIndex);
                    var context = {
                        sheet: self,
                        row: activeRowIndex,
                        col: activeColIndex,
                        sheetArea: 3
                    };
                    if (!ct.isImeAware(context)) {
                        eventHandler._changeFocusHolder();
                    }
                    if (editor && editor.parentNode) {
                        value = ct.getEditorValue(editor, context);
                        var args = {
                            sheet: self,
                            sheetName: name,
                            row: activeRowIndex,
                            col: activeColIndex,
                            editor: editor,
                            editingText: value,
                            cancel: false
                        };
                        self._trigger(common_1.Events.EditEnd, args);
                        if (args.cancel && !ignoreCorssSheetFormulaTextbox) {
                            return;
                        }
                        self._trigger(common_1.Events.EditEnding, args);
                        if (args.cancel && !ignoreCorssSheetFormulaTextbox) {
                            return;
                        }
                        var parent_1 = self.parent;
                        var attachedFbx = parent_1 && parent_1._attachedFormulaTextBox;
                        if (document.activeElement === (attachedFbx && attachedFbx._host)) {
                            eventHandler._changeFocusHolder();
                        }
                        if (activeRowIndex >= 0 && activeColIndex >= 0) {
                            var oldValue = editor._oldValue;
                            var formulaInfo = self.getFormulaInformation && self.getFormulaInformation(activeRowIndex, activeColIndex);
                            if (
                                ct.isEditingValueChanged(oldValue, value, context)
                                || endEditType === 1
                                || (formulaInfo && formulaInfo.isArrayFormula && endEditType !== 1)
                            ) {
                                if (ignoreValueChange) {
                                    ct.setEditorValue(editor, oldValue, context);
                                    ct.selectAll(editor, context);
                                } else {
                                    var autoFormat = ct._autoFormatValue;
                                    if (isNullOrUndefined(autoFormat)) {
                                        autoFormat = true;
                                    }
                                    var cellEditInfo = {
                                        cmd: 'editCell',
                                        sheetName: name,
                                        row: activeRowIndex,
                                        col: activeColIndex,
                                        newValue: value,
                                        autoFormat: autoFormat,
                                        editingFormatter: editor._editingFormatter
                                    };
                                    if (endEditType === 1) {
                                        cellEditInfo.ranges = [self._getActiveSelectedRange()];
                                        cellEditInfo.endEditType = endEditType;
                                    }
                                    if (value !== null && !ignoreValueChange) {
                                        var besideTable = self.tables && self.tables.find && (self.tables.find(activeRowIndex - 1, activeColIndex) || self.tables.find(activeRowIndex, activeColIndex - 1));
                                        if (besideTable) {
                                            self.tables._changeValueBesideTable(new common_1.Range(activeRowIndex, activeColIndex, 1, 1), null, value, true);
                                        }
                                    }
                                    self._commandManager().execute(cellEditInfo);
                                    applyResult = cellEditInfo.applyResult;
                                    if (applyResult === 2) {
                                        ct.focus(editor, context);
                                        if (!ignoreCorssSheetFormulaTextbox) {
                                            return false;
                                        }
                                    }
                                }
                            }
                        }
                        self._dirty = true;
                        ct._deactivateEditorWrapper(editor, context, self.getCellRect(activeRowIndex, activeColIndex));
                        if (!ct.isImeAware(context)) {
                            var host = self._getHost();
                            var element = editor;
                            while (element) {
                                if (element.parentNode === host) {
                                    host.removeChild(element);
                                } else {
                                    element = element.parentNode;
                                }
                            }
                        } else if (browser.msie && parseFloat(browser.version) === 9) {
                            eventHandler._changeFocusHolder();
                        } else {
                            $(editor.parentNode.parentNode).css({
                                width: 0,
                                height: 0,
                                overflow: 'hidden',
                                border: 'none'
                            });
                        }
                    }
                    self._editingTimeValue = false;
                    var editEndedArgs = {
                        sheet: self,
                        sheetName: name,
                        row: activeRowIndex,
                        col: activeColIndex,
                        editingText: value
                    };
                    var formulaTextboxEditEndedArgs = $.extend({}, editEndedArgs);
                    self._trigger(common_1.Events.EditEnded, editEndedArgs);
                    self._trigger(common_1.Events.FormulatextboxEditEnded, formulaTextboxEditEndedArgs);
                    if (ignoreFormulaTextbox !== true && formulaTextboxEditEndedArgs.ignore && !ignoreCorssSheetFormulaTextbox) {
                        return false;
                    }
                    if (self._editorStatus !== 0) {
                        var oldStatus = self._editorStatus;
                        self._editorStatus = 0;
                        self._raiseEditorStatusChanged(oldStatus, 0);
                    }
                    self._modelManager.setCellState(activeRowIndex, activeColIndex, core_enum_1.CellStatesType.edit, false, core_enum_1.SheetArea.viewport);
                    worksheet_1.Worksheet._callFeatureHandler(self, 'endEdit');
                    self._editor = keyword_null;
                    if (applyResult === 1) {
                        return false;
                    }
                    return true;
                },
                _doStartEdit: function (canvas, x, y) {
                    var self = this;
                    var target = self.hitTest(x, y);
                    if (
                        !target
                        || (
                            target.cellTypeHitInfo
                            && (
                                target.cellTypeHitInfo.outlineColumnHitInfo
                                || target.cellTypeHitInfo.disableEdit
                                || target.cellTypeHitInfo.cellButtonHitInfo
                            )
                        )
                    ) {
                        return;
                    }
                    var row = target.rowl
                    var col = target.col;
                    if (
                        row >= 0
                        && col >= 0
                        && target.rowViewportIndex >= 0
                        && target.colViewportIndex >= 0
                        && !target.resizeInfo
                        && !target.dragInfo
                        && row === self._activeRowIndex
                        && col === self._activeColIndex
                    ) {
                        var isEditing = self.isEditing();
                        self._startEditImp(canvas, row, col);
                        if (!isEditing && self.isEditing()) {
                            var sheetArea = target.hitTestType;
                            var ct = self.getCellType(row, col);
                            if (ct._triggerButtonClicked) {
                                var cellRect = self.getCellRect(row, col, sheetArea === 1 ? -1 : keyword_undefined, sheetArea === 2 ? -1 : keyword_undefined);
                                var cellStyle = self.getActualStyle(row, col, sheetArea);
                                var info = ct._getHitInfoWrapper(x, y, cellStyle, cellRect, {
                                    sheet: self,
                                    row: row,
                                    col: col,
                                    sheetArea: sheetArea
                                });
                                if (info && info.isReservedLocation) {
                                    ct._triggerButtonClicked(self, row, col, 3);
                                }
                            }
                        }
                    }
                },
                // 输入公式并选择公式范围
                inputFormulaAndSelectFormulaRange: function (row, col, selectRnage, formulaText) {
                    var self = this;
                    var options = self.options;
                    var cellRect = self.getCellRect(row, col);
                    var cellStyle = self.getActualStyle(row, col);
                    var ct = self.getCellType(row, col);
                    var eventHandler = self._eventHandler;
                    eventHandler._setFocus();
                    var context = {
                        sheet: self,
                        row: row,
                        col: col,
                        sheetArea: 3
                    };
                    var cellWrapperElement = eventHandler._cellTypeFocusHolder;
                    var editor;
                    if (cellWrapperElement && cellWrapperElement.firstChild) {
                        editor = cellWrapperElement.firstChild.firstChild;
                    }
                    if (!editor) {
                        return;
                    }
                    self._editor = editor;
                    var sheetLayout = self._getSheetLayout();
                    if (ct.isImeAware(context)) {
                        eventHandler._resetFocusHolder();
                    }
                    ct._activateEditorWrapper(cellWrapperElement, cellStyle, cellRect, context);
                    self._setEditorValue(ct, editor, row, col, cellStyle, undefined, undefined);
                    ct._updateEditorWrapper(cellWrapperElement, cellStyle, cellRect, context);
                    if (options.allowCellOverflow) {
                        var crect = cellRect.clone();
                        crect.y -= 2;
                        crect.height += 4;
                        crect.x = sheetLayout._frozenX;
                        crect.width = self._getActualViewportWidth(sheetLayout);
                        self.repaint(crect);
                    }
                    worksheet_1.Worksheet._callFeatureHandler(self, 'startEdit', {
                        element: ct.getEditingElement()
                    });
                    self._editorStatus = 2;
                    self._formulaTextBox.text(formulaText);
                    self._formulaTextBox.caret(formulaText.length - 1);
                    selectRnage && self._formulaTextBox._selectAutoFunctionRange(3, 4);
                    self._formulaTextBox._openFuncHelp();
                    common_1._FocusHelper._setActiveElement(self);
                },
                _startEditImp: function (canvas, row, col, rowViewportIndex, colViewportIndex, selectAll, defaultText, isImeInput, event) {
                    if (row < 0 || col < 0) {
                        return;
                    }
                    var self = this;
                    var name = self.name();
                    var options = self.options;
                    if (self.isEditing()) {
                        return;
                    }
                    var modelManager = self._modelManager;
                    modelManager.setCellState(row, col, core_enum_1.CellStatesType.edit, true, core_enum_1.SheetArea.viewport);
                    var cellStyle = self.getActualStyle(row, col);
                    if (
                        options.isProtected
                        && cellStyle.locked !== false
                    ) {
                        modelManager.setCellState(row, col, core_enum_1.CellStatesType.edit, false, core_enum_1.SheetArea.viewport);
                        return;
                    }
                    var ct = self.getCellType(row, col);
                    if (!ct) {
                        modelManager.setCellState(row, col, core_enum_1.CellStatesType.edit, false, core_enum_1.SheetArea.viewport);
                        return;
                    }
                    if (self.pivotTables) {
                        var pts = self.pivotTables.all();
                        for (var i = 0; i < pts.length; i++) {
                            var pt = pts[i];
                            var _a = pt.getRange();
                            var page = _a.page;
                            var content = _a.content;
                            if (page && page.contains(row, col) || content && content.contains(row, col)) {
                                modelManager.setCellState(row, col, core_enum_1.CellStatesType.edit, false, core_enum_1.SheetArea.viewport);
                                return;
                            }
                        }
                    }
                    var eventHandler = self._eventHandler;
                    eventHandler._setFocus();
                    var context = {
                        sheet: self,
                        row: row,
                        col: col,
                        sheetArea: 3
                    };
                    var cellWrapperElement;
                    if (ct.isImeAware(context)) {
                        cellWrapperElement = eventHandler._cellTypeFocusHolder;
                    } else {
                        cellWrapperElement = ct._createCellTypeElement(context);
                    }
                    var editor;
                    if (cellWrapperElement && cellWrapperElement.firstChild) {
                        editor = cellWrapperElement.firstChild.firstChild;
                    }
                    if (!editor) {
                        modelManager.setCellState(row, col, core_enum_1.CellStatesType.edit, false, core_enum_1.SheetArea.viewport);
                        return;
                    }
                    var style = self.getActualStyle(row, col);
                    var addPercent = false;
                    var needChangePercentText;
                    var culture = CultureManager.culture();
                    if ((style.formatter && common_1.util._isPercentFormatter(style.formatter, culture)) ||
                        style._autoFormatter && style._autoFormatter.formatCached && common_1.util._isPercentFormatter(style._autoFormatter, culture)) {
                        var keyCode = event && event.keyCode, code = event && event.code;
                        if (event && keyCode && (!event.shiftKey && ((keyCode >= 96 && keyCode <= 105) || (keyCode >= 48 && keyCode <= 57)))) {
                            addPercent = true;
                        }
                        if (keyCode === 109 || keyCode === 107 || (event && ((!event.shiftKey && keyCode === 189) || (event.shiftKey && keyCode === 187)))) {
                            ct.probabilityAddPercent = true;
                        }
                        if (keyCode === 229 && !event.shiftKey && (code.length - code.replace(/[0-9]/, '').length > 0)) {
                            addPercent = true;
                        }
                        if (keyCode === 229 && !event.shiftKey && (code.length - code.replace('Minus', '').length > 0 || code.length - code.replace('Subtract', '').length > 0 || code.length - code.replace('Add', '').length > 0)) {
                            ct.probabilityAddPercentSpec = true;
                        }
                        if (keyCode === 229 && event.shiftKey && (code.length - code.replace('Equal', '').length > 0)) {
                            ct.probabilityAddPercentSpec = true;
                        }
                        var cellText = cellWrapperElement.innerText;
                        if (browser.msie) {
                            cellText = cellText.replace('\r\n', '');
                        }
                        var numberDecimalSeparator = CultureManager._getCultureInfo(CultureManager.culture()).NumberFormat.numberDecimalSeparator;
                        var decimalReg = new RegExp('^[-]?[0-9]+(\\' + numberDecimalSeparator + '[0-9]+)?$');
                        if (!event && cellText && decimalReg.test(cellText)) {
                            needChangePercentText = true;
                        }
                    }
                    self._editor = editor;
                    var args = {
                        sheet: self,
                        sheetName: name,
                        row: row,
                        col: col,
                        cancel: false
                    };
                    self._trigger(common_1.Events.EditStarting, args);
                    if (args.cancel) {
                        if (device.ipad) {
                            eventHandler._changeFocusHolder();
                        }
                        modelManager.setCellState(row, col, core_enum_1.CellStatesType.edit, false, core_enum_1.SheetArea.viewport);
                        return;
                    }
                    self.showCell(self._activeRowIndex, self._activeColIndex, 3, 3);
                    self._considerDynamicArray = true;
                    var value = self.getValue(row, col);
                    var formula = _supportsCalc && self.getFormula(row, col);
                    var oldStatus = self._editorStatus;
                    if (self._startEditByKeydown) {
                        self._editorStatus = 1;
                    } else if (isNullOrUndefined(value) && isNullOrUndefined(formula)) {
                        self._editorStatus = 1;
                    } else {
                        self._editorStatus = 2;
                    }
                    self._raiseEditorStatusChanged(oldStatus, self._editorStatus);
                    var sheetLayout = self._getSheetLayout();
                    var cellRect = self.getCellRect(row, col, rowViewportIndex, colViewportIndex);
                    if (!cellRect || isNullOrUndefined(cellRect.width) || isNullOrUndefined(cellRect.height) ||
                        isNullOrUndefined(cellRect.x) || isNullOrUndefined(cellRect.y) || cellRect.width <= 0 || cellRect.height <= 0) {
                        return;
                    }
                    if (ct.isImeAware(context)) {
                        eventHandler._resetFocusHolder();
                    }
                    ct._activateEditorWrapper(cellWrapperElement, cellStyle, cellRect, context);
                    self._setEditorValue(ct, editor, row, col, cellStyle, defaultText, isImeInput, addPercent, needChangePercentText);
                    var host = self._getHost();
                    if (!ct.isImeAware(context)) {
                        host.insertBefore(cellWrapperElement, keyword_null);
                    }
                    delete self._considerDynamicArray;
                    ct._updateEditorWrapper(cellWrapperElement, cellStyle, cellRect, context);
                    if (!ct.isImeAware(context) || !selectAll) {
                        ct.focus(editor, context);
                    }
                    if (options.allowCellOverflow) {
                        var crect = cellRect.clone();
                        crect.y -= 2;
                        crect.height += 4;
                        if (self._statesManager && self._statesManager.isEnable(core_enum_1.StatesType.edit, false)) {
                            crect.y = sheetLayout._frozenY;
                            crect.height = sheetLayout._viewportHeight;
                        }
                        crect.x = sheetLayout._frozenX;
                        crect.width = self._getActualViewportWidth(sheetLayout);
                        self.repaint(crect);
                    }
                    worksheet_1.Worksheet._callFeatureHandler(self, 'startEdit', { element: ct.getEditingElement() });
                    if (!addPercent && selectAll) {
                        ct.selectAll(editor, context);
                    }
                    if (addPercent) {
                        var selection = window.getSelection();
                        var range = document.createRange();
                        range.setStart(editor, 0);
                        selection.removeAllRanges();
                        selection.addRange(range);
                    }
                    if (needChangePercentText) {
                        var selection = window.getSelection();
                        var p = document.createElement('span');
                        p.innerText = '%';
                        var range = document.createRange();
                        if (self.parent.options.enableFormulaTextbox && self.parent.options.allowUserEditFormula) {
                            editor.firstChild.appendChild(p);
                            range.setStart(editor.firstChild, 1);
                            self._formulaTextBox && self._formulaTextBox._updateBeforeText();
                        } else {
                            editor.appendChild(p);
                            range.setStart(editor, 1);
                        }
                        selection.removeAllRanges();
                        selection.addRange(range);
                    }
                    common_1._FocusHelper._setActiveElement(self);
                    var editStartArgs = {
                        sheet: self,
                        sheetName: name,
                        row: row,
                        col: col
                    };
                    self._trigger(common_1.Events.EditStarted, editStartArgs);
                    self._trigger(common_1.Events.FormulatextboxEditStarted, editStartArgs);
                },
                _setEditorValue: function (ct, editor, row, col, cellStyle, defaultText, isImeInput, addPercent, needChangePercentText) {
                    var self = this;
                    var t = _supportsCalc && self.getFormula(row, col, 3, true);
                    if (t) {
                        t = '=' + t;
                    }
                    var actualValue = t;
                    var context = {
                        sheet: self,
                        row: row,
                        col: col,
                        sheetArea: 3,
                        isImeInput: isImeInput
                    };
                    if (!t || t.length === 0) {
                        t = self.getValue(row, col, 3, 1);
                        if (t && t.richText) {
                            t = convertRichTextValue(t);
                        }
                        var parent_2 = self.parent;
                        var allowUserEditFormula = _supportsCalc && parent_2 && parent_2.options.allowUserEditFormula;
                        if ((typeof t === const_string && cellStyle.quotePrefix) || (t && t.length > 0 && t[0] === '=' && allowUserEditFormula)) {
                            t = '\'' + t;
                            actualValue = t;
                        } else {
                            actualValue = t;
                            t = ct._formatEditorValue(editor, cellStyle, t, context);
                        }
                    }
                    editor._oldValue = t;
                    if (!isNullOrUndefined(defaultText)) {
                        t = defaultText;
                    }
                    if (needChangePercentText && t) {
                        t = this._calcAppendString(t, cellStyle);
                    }
                    ct.setEditorValue(editor, t, context, addPercent);
                    if (self.parent && self.parent.options.enableAccessibility) {
                        var isFormula = t && t[0] === '=';
                        var text = !isFormula ? t : self.getText(row, col);
                        var formula = isFormula ? t : self.getFormula(row, col);
                        var comment = self.comments && self.comments.get(row, col);
                        var accessibilityContent = self._getAccessibilityContentOfCell(row, col, text, formula, comment && comment.text());
                        editor.setAttribute('aria-label', accessibilityContent);
                    }
                    editor._originalValue = actualValue;
                },
                _getFormatterString: function (style) {
                    var formatterStr = '';
                    var formatterObj = style && (style.formatter || style._autoFormatter);
                    if (formatterObj) {
                        if (typeof formatterObj === const_string) {
                            formatterStr = formatterObj;
                        } else {
                            formatterStr = formatterObj.formatCached;
                        }
                    }
                    return formatterStr;
                },
                _calcAppendString: function (stringNumber, style) {
                    var _a = CultureManager._getCultureInfo(CultureManager.culture()).NumberFormat;
                    var negativeSign = _a.negativeSign;
                    var numberDecimalSeparator = _a.numberDecimalSeparator;
                    var formatter = this._getFormatterString(style);
                    var startWithPercent = (formatter[0] === '%');
                    var appendString;
                    var formatters = formatter.split(';');
                    if (startWithPercent) {
                        appendString = formatters[0].split('%')[1].split('.')[1];
                    } else if (formatters[0].indexOf('%') > -1) {
                        appendString = '00';
                    }
                    if (appendString === undefined) {
                        appendString = '';
                    }
                    if (stringNumber.split('e').length > 1) {
                        var str1 = stringNumber.split('e')[0], str2 = stringNumber.split('e')[1];
                        return str1 + 'e' + '+' + (parseInt(str2.split('+')[1], 10) + 2);
                    } else {
                        if (stringNumber.split(numberDecimalSeparator).length > 1) {
                            var isMinus = false;
                            if (stringNumber.charAt(0) === negativeSign) {
                                stringNumber = stringNumber.substr(1, stringNumber.length - 1);
                                isMinus = true;
                            }
                            stringNumber = stringNumber + appendString;
                            var pointPosition = stringNumber.indexOf(numberDecimalSeparator);
                            stringNumber = stringNumber.split(numberDecimalSeparator).join('');
                            stringNumber = stringNumber.substr(0, pointPosition + 2) + numberDecimalSeparator + stringNumber.substr(pointPosition + 2, stringNumber.length - 1);
                            var stringArr = stringNumber.split(numberDecimalSeparator);
                            var arr1 = stringArr[0];
                            var arr2 = stringArr[1];
                            while (arr1 && arr1.charAt(0) === '0') {
                                arr1 = arr1.substr(1, arr1.length - 1);
                            }
                            while (arr2 && arr2.charAt(arr2.length - 1) === '0') {
                                arr2 = arr2.substr(0, arr2.length - 1);
                            }
                            if (isMinus && arr1) {
                                arr1 = negativeSign + arr1;
                            }
                            if (arr1 && arr2) {
                                return arr1 + numberDecimalSeparator + arr2;
                            } else if (!arr1 && arr2) {
                                return (isMinus ? negativeSign + '0' + numberDecimalSeparator : '0' + numberDecimalSeparator) + arr2;
                            } else if (arr1 && !arr2) {
                                return arr1;
                            } else {
                                return '0';
                            }
                        } else {
                            if (stringNumber === '0') {
                                return stringNumber;
                            } else {
                                return stringNumber + appendString;
                            }
                        }
                    }
                }
            };
            $.extend(worksheet_1.Worksheet.prototype, sheetEx);
        }),
        './dist/core/worksheet/worksheet-event.js': (function (module, exports, __webpack_require__) {
            Object.defineProperty(exports, '__esModule', { value: true });
            var core_ns_1 = __webpack_require__(/*! ../core.ns */ './dist/core/core.ns.js');
            var worksheet_1 = __webpack_require__(/*! ./worksheet */ './dist/core/worksheet/worksheet.js');
            var Common_1 = __webpack_require__(/*! Common */ 'Common');
            var worksheet_model_1 = __webpack_require__(/*! ./worksheet-model */ './dist/core/worksheet/worksheet-model.js');
            var domUtil_1 = __webpack_require__(/*! ../util/domUtil */ './dist/core/util/domUtil.js');
            var common_1 = __webpack_require__(/*! ../util/common */ './dist/core/util/common.js');
            var core_enum_1 = __webpack_require__(/*! ../core.enum */ './dist/core/core.enum.js');
            var WINDOW = window;
            var DOCUMENT = document;
            var $_each = domUtil_1.GC$.each;
            var browser = common_1._util._browser;
            var util_device = common_1._util._device();
            var cancelDefault = common_1._util._cancelDefault;
            var createElement = common_1._util._createElement;
            var StringHelper = Common_1.Common._StringHelper;
            var stringFormat = Common_1.Common._StringHelper._format;
            var createRange = common_1._createRange;
            var isNullOrUndefined = Common_1.Common._Types._isNullOrUndefined;
            var UI_RES = {
                _EVENT_NS: '.handler'
            };
            var MOUSEDOWN_EVENT = 'mousedown' + UI_RES._EVENT_NS;
            var MOUSEUP_EVENT = 'mouseup' + UI_RES._EVENT_NS;
            var MOUSEMOVE_EVENT = 'mousemove' + UI_RES._EVENT_NS;
            var MOUSEWHEEL_EVENT = 'mousewheel' + UI_RES._EVENT_NS;
            var DOMMOUSESCROLL_EVENT = 'DOMMouseScroll' + UI_RES._EVENT_NS;
            var WHEEL_EVENT = 'wheel' + UI_RES._EVENT_NS;
            var MOUSEOUT_EVENT = 'mouseout' + UI_RES._EVENT_NS;
            var DBLCLICK_EVENT = 'dblclick' + UI_RES._EVENT_NS;
            var keyword_null = null;
            var keyword_undefined = void 0;
            var isNotANumber = isNaN;
            var convertToInt = parseInt;
            var Math_max = Math.max;
            var Math_floor = Math.floor;
            var Math_min = Math.min;
            var Math_abs = Math.abs;
            var Math_ceil = Math.ceil;
            var const_function = 'function';
            var cssPosition = 'position';
            var cssAbsolute = 'absolute';
            var cssBorder = 'border';
            var cssOverflow = 'overflow';
            var cssTop = 'top';
            var cssLeft = 'left';
            var cssWidth = 'width';
            var cssHeight = 'height';
            var cssResize = 'resize';
            var cssHidden = 'hidden';
            var cssVisible = 'visible';
            var cssNone = 'none';
            var attrTabIndex = 'tabindex';
            var attrGcUIElement = 'gcUIElement';
            var CORNER = 'corner';
            var SIZEHIDDENROW = 'sizeHiddenRow';
            var SIZEROW = 'sizeRow';
            var SIZECOL = 'sizeCol';
            var SIZEHIDDENCOL = 'sizeHiddenCol';
            var DEFAULT = 'default';
            var IS_MOBILE_DEVICE = util_device.iphone || util_device.ipad || util_device.android;
            var rm = new Common_1.Common.ResourceManager(core_ns_1.SR);
            var getSR = rm.getResource.bind(rm);
            var RESIZETOOLTIP_GAP = 8;
            function _isHoverOnHeaderSelection(sheet, target) {
                var sheetArea = 3;
                if (getRowViewportIndex(target) < 0) {
                    sheetArea = 1;
                }
                if (getColViewportIndex(target) < 0) {
                    sheetArea = 2;
                }
                if (sheetArea !== 3 && sheet._isSelected(target.row, target.col, sheetArea, true)) {
                    return true;
                }
                return false;
            }
            function refreshHoverCell(sheet, target, render) {
                var isNeedRepaintSelection = false;
                var sheetLayout = sheet._getSheetLayout();
                if (target) {
                    var rowViewportIndex = getRowViewportIndex(target);
                    var colViewportIndex = getColViewportIndex(target);
                    if (rowViewportIndex < 0 || colViewportIndex < 0) {
                        var r = sheet.getCellRect(target.row, target.col, rowViewportIndex, colViewportIndex);
                        if (r && r.width > 0 && r.height > 0) {
                            var adjX = sheetLayout.x;
                            var adjY = sheetLayout.y;
                            if (r.x < sheetLayout._rowHeaderWidth + adjX ||
                                r.y < sheetLayout._colHeaderHeight + adjY ||
                                r.y >= sheetLayout.height - sheetLayout._footerHeight) {
                                var clipRect = new common_1.Rect(r.x - 2, r.y - 2, r.width + 4, r.height + 4);
                                var headerRect = void 0;
                                if (rowViewportIndex < 0 && colViewportIndex < 0) {
                                    headerRect = sheetLayout._headerCornerRect();
                                } else if (rowViewportIndex < 0) {
                                    headerRect = sheetLayout._colHeaderRect(colViewportIndex);
                                } else {
                                    headerRect = sheetLayout._rowHeaderRect(rowViewportIndex);
                                }
                                clipRect = clipRect.getIntersectRect(headerRect);
                                render._update(clipRect.x, clipRect.y, clipRect.width, clipRect.height);
                                isNeedRepaintSelection = _isHoverOnHeaderSelection(sheet, target);
                            }
                        }
                    }
                }
                return isNeedRepaintSelection;
            }
            function isEditing(sheet) {
                return sheet.isEditing();
            }
            function endEdit(sheet) {
                return sheet.endEdit();
            }
            function getFrozenRowCount(sheet) {
                return sheet.frozenRowCount();
            }
            function getFrozenColumnCount(sheet) {
                return sheet.frozenColumnCount();
            }
            function getSheetRowCount(sheet, sheetArea) {
                return sheet.getRowCount(sheetArea);
            }
            function getSheetColumnCount(sheet, sheetArea) {
                return sheet.getColumnCount(sheetArea);
            }
            function getRowViewportIndex(object) {
                return object.rowViewportIndex;
            }
            function getColViewportIndex(object) {
                return object.colViewportIndex;
            }
            function getHitTestType(object) {
                return object.hitTestType;
            }
            function getActiveRowIndex(sheet) {
                return sheet.getActiveRowIndex();
            }
            function getActiveColumnIndex(sheet) {
                return sheet.getActiveColumnIndex();
            }
            function getKeyCode(e) {
                return e.keyCode;
            }
            function getCtrlKey(e) {
                return e.ctrlKey;
            }
            function getShiftKey(e) {
                return e.shiftKey;
            }
            function getAltKey(e) {
                return e.altKey;
            }
            function getMetaKey(e) {
                return e.metaKey;
            }
            function getColCount(obj) {
                return obj.colCount;
            }
            function getRowCount(obj) {
                return obj.rowCount;
            }
            function createOption(action, index, sheetArea) {
                return {
                    action: action,
                    index: index,
                    sheetArea: sheetArea
                };
            }
            function createEventArg(sheet, name, row, col, sheetArea, canCancel) {
                var t = {
                    sheet: sheet,
                    sheetName: name,
                    sheetArea: sheetArea,
                    row: row,
                    col: col
                };
                if (canCancel) {
                    t.cancel = false;
                }
                return t;
            }
            // 更改活动单元格
            function changeActiveCell(handler, row, col, rowViewportIndex, colViewportIndex, doNotSetFocus) {
                var sheet = handler._sheet;
                var args = createEventArg(sheet, sheet.name(), sheet._activeRowIndex, sheet._activeColIndex, keyword_undefined, true);
                sheet._trigger(common_1.Events.LeaveCell, args);
                if (args && args.cancel === true) {
                    return true;
                }
                sheet._setActiveCellImp(row, col, rowViewportIndex, colViewportIndex, doNotSetFocus);
                sheet._trigger(common_1.Events.EnterCell, createEventArg(sheet, sheet.name(), row, col));
                sheet._trigger(common_1.Events.FormulatextboxEnterCell, createEventArg(sheet, sheet.name(), row, col));
                handler._updateValidationUI && handler._updateValidationUI(row, col);
            }
            function getResizeLayout(handler, layoutFn, prevVisualIndexFn, findFn, targetIndex, resizeInfo, resizingRow) {
                var sheet = handler._sheet;
                var layoutModel = layoutFn.call(sheet, resizeInfo.sheetArea);
                if ((resizingRow && !sheet.getRowVisible(resizeInfo.index, resizeInfo.sheetArea)) ||
                    (!resizingRow && !sheet.getColumnVisible(resizeInfo.index, resizeInfo.sheetArea))) {
                    resizeInfo.index = prevVisualIndexFn.call(handler, resizeInfo.index, resizeInfo.sheetArea);
                }
                var layout = findFn.call(layoutModel, resizeInfo.index);
                if (!layout) {
                    layout = findFn.call(layoutModel, targetIndex);
                }
                return layout;
            }
            function updateResizeInfo(resizeInfo, value, layout, isRow, maxSize) {
                var movingKey = isRow ? 'movingY' : 'movingX';
                var startKey = isRow ? 'startY' : 'startX';
                resizeInfo[movingKey] = value;
                if (resizeInfo[movingKey] < resizeInfo[startKey]) {
                    resizeInfo[movingKey] = resizeInfo[startKey];
                }
                var max = isRow ? layout.y + layout.height : layout.x + layout.width;
                if (resizeInfo[movingKey] > max) {
                    resizeInfo[movingKey] = max;
                }
                if (maxSize !== keyword_null && (resizeInfo[movingKey] > resizeInfo[startKey] + maxSize)) {
                    resizeInfo[movingKey] = resizeInfo[startKey] + maxSize;
                }
            }
            function _getRowViewportIndexNearY(sheet, y) {
                var layout = sheet._getSheetLayout();
                if (getFrozenRowCount(sheet) > 0 && y < layout._frozenY + layout._frozenHeight) {
                    return 0;
                } else if (sheet.frozenTrailingRowCount() > 0 && y > layout._frozenTrailingY) {
                    return 2;
                }
                return 1;
            }
            function _getColumnViewportIndexNearX(sheet, x) {
                var layout = sheet._getSheetLayout();
                if (getFrozenColumnCount(sheet) > 0 && x < layout._frozenX + layout._frozenWidth) {
                    return 0;
                } else if (sheet.frozenTrailingColumnCount() > 0 && x > layout._frozenTrailingX) {
                    return 2;
                }
                return 1;
            }
            function _getViewportRowLayoutNearY(sheet, rowViewportIndex, y) {
                var rowLayoutModel = sheet._getRowLayout(rowViewportIndex);
                if (rowLayoutModel) {
                    return rowLayoutModel.findNearY(y);
                }
                return keyword_null;
            }
            function _getViewportColumnLayoutNearX(sheet, columnViewportIndex, x) {
                var colLayoutModel = sheet._getColumnLayout(columnViewportIndex);
                if (colLayoutModel) {
                    return colLayoutModel.findNearX(x);
                }
                return keyword_null;
            }
            function canDoResizeRows(sheet) {
                return !sheet.options.isProtected || sheet.options.protectionOptions.allowResizeRows;
            }
            function canDoResizeColumns(sheet) {
                return !sheet.options.isProtected || sheet.options.protectionOptions.allowResizeColumns;
            }
            function _fitSelection(sheet, range) {
                var row = range.row;
                var rowCount = range.rowCount;
                var col = range.col;
                var colCount = range.colCount;
                var sheetColCount = sheet.getColumnCount();
                var sheetRowCount = sheet.getRowCount();
                if (colCount + col > sheetColCount) {
                    colCount = sheetColCount - col;
                }
                if (rowCount + row > sheetRowCount) {
                    rowCount = sheetRowCount - row;
                }
                return {
                    row: row,
                    col: col,
                    rowCount: rowCount,
                    colCount: colCount
                };
            }
            function _isLastVisibleRowOfViewPort(sheet, index) {
                var lastRowOfCurrViewPort = sheet.getViewportBottomRow(sheet._getRowViewportIndex(index));
                if (lastRowOfCurrViewPort === -1) {
                    lastRowOfCurrViewPort = sheet._getLastVisualRow();
                }
                if (index < lastRowOfCurrViewPort) {
                    var lastVisibleRowIndex = lastRowOfCurrViewPort;
                    for (; lastVisibleRowIndex > index; lastVisibleRowIndex--) {
                        if (sheet.getRowHeight(lastVisibleRowIndex) !== 0) {
                            return false;
                        }
                    }
                }
                return true;
            }
            function _isNotSelectMultiWholeRow(sheet) {
                var selectionModel = sheet._modelManager.getSelections();
                if (selectionModel.length > 0) {
                    var selectedWholeRowCount_1 = 0;
                    var rowCount_1 = sheet.getRowCount();
                    return selectionModel.every(function (selectionItem) {
                        var range = _fitSelection(sheet, selectionItem);
                        var isNotMultiRow = false;
                        if (range.rowCount === 1) {
                            selectedWholeRowCount_1 += 1;
                            isNotMultiRow = selectedWholeRowCount_1 <= 1;
                        }
                        var isSelectionInSheet = range.row < rowCount_1;
                        var isNotHeader = range.col !== -1;
                        return isNotHeader || (isNotMultiRow && isSelectionInSheet);
                    });
                }
            }
            function _isSplitResizeRow(sheet, resizeInfo, isCtrl) {
                var workbook = sheet.parent;
                var rowResizeMode = workbook.options.rowResizeMode;
                if (isCtrl && rowResizeMode === 0) {
                    rowResizeMode = 1;
                }
                if (resizeInfo.action === SIZEHIDDENROW || rowResizeMode !== 1) {
                    return false;
                }
                if (_isLastVisibleRowOfViewPort(sheet, resizeInfo.index)) {
                    return false;
                }
                if (!sheet.getRowResizable(resizeInfo.index, resizeInfo.sheetArea) ||
                    !sheet.getRowResizable(resizeInfo.index + 1, resizeInfo.sheetArea)) {
                    return false;
                }
                return _isNotSelectMultiWholeRow(sheet);
            }
            function _shouldSplitResizeRow(sheet, resizeInfo, rowList, isCtrl) {
                return _isSplitResizeRow(sheet, resizeInfo, isCtrl) &&
                    rowList.length === 1 && rowList[0].firstRow === rowList[0].lastRow;
            }
            function _isLastVisibleColumnOfViewPort(sheet, index) {
                var lastColumnOfCurrViewPort = sheet.getViewportRightColumn(sheet._getColumnViewportIndex(index));
                if (lastColumnOfCurrViewPort === -1) {
                    lastColumnOfCurrViewPort = sheet._getLastVisualColumn();
                }
                if (index < lastColumnOfCurrViewPort) {
                    var lastVisibleColumnIndex = lastColumnOfCurrViewPort;
                    for (; lastVisibleColumnIndex > index; lastVisibleColumnIndex--) {
                        if (sheet.getColumnWidth(lastVisibleColumnIndex) !== 0) {
                            return false;
                        }
                    }
                }
                return true;
            }
            function _isNotSelectMultiWholeColumn(sheet) {
                var selectionModel = sheet._modelManager.getSelections();
                if (selectionModel.length > 0) {
                    var selectedWholeColumnCount_1 = 0;
                    var columnCount_1 = sheet.getColumnCount();
                    return selectionModel.every(function (selectionItem) {
                        var range = _fitSelection(sheet, selectionItem);
                        var isNotMultiColumn = false;
                        if (range.colCount === 1) {
                            selectedWholeColumnCount_1 += 1;
                            isNotMultiColumn = selectedWholeColumnCount_1 <= 1;
                        }
                        var isSelectionInSheet = range.col < columnCount_1;
                        var isNotHeader = range.row !== -1;
                        return isNotHeader || (isNotMultiColumn && isSelectionInSheet);
                    });
                }
            }
            function _isSplitResizeColumn(sheet, resizeInfo, isCtrl) {
                var workbook = sheet.parent;
                var columnResizeMode = workbook.options.columnResizeMode;
                if (isCtrl && columnResizeMode === 0) {
                    columnResizeMode = 1;
                }
                if (resizeInfo.action === SIZEHIDDENCOL || columnResizeMode !== 1) {
                    return false;
                }
                if (_isLastVisibleColumnOfViewPort(sheet, resizeInfo.index)) {
                    return false;
                }
                if (!sheet.getColumnResizable(resizeInfo.index, resizeInfo.sheetArea) ||
                    !sheet.getColumnResizable(resizeInfo.index + 1, resizeInfo.sheetArea)) {
                    return false;
                }
                return _isNotSelectMultiWholeColumn(sheet);
            }
            function _shouldSplitResizeColumn(sheet, resizeInfo, colList, isCtrl) {
                return _isSplitResizeColumn(sheet, resizeInfo, isCtrl) &&
                    colList.length === 1 && colList[0].firstColumn === colList[0].lastColumn;
            }
            function _updateRowResizeInfo(sheet, resizeInfo, sheetArea, y, isCtrl) {
                var rowIndex = resizeInfo.index;
                var layout = sheet._getSheetLayout();
                if (_isSplitResizeRow(sheet, resizeInfo, isCtrl)) {
                    var nextVisibleRow = sheet._getNextVisualRow(rowIndex, sheetArea);
                    var maxHeight = sheet._getZoomRowHeight(rowIndex, sheetArea) + sheet._getZoomRowHeight(nextVisibleRow, sheetArea);
                    updateResizeInfo(resizeInfo, y, layout, true, maxHeight);
                } else {
                    updateResizeInfo(resizeInfo, y, layout, true);
                }
            }
            function _updateColumnResizeInfo(sheet, resizeInfo, sheetArea, x, isCtrl) {
                var columnIndex = resizeInfo.index;
                var layout = sheet._getSheetLayout();
                if (_isSplitResizeColumn(sheet, resizeInfo, isCtrl)) {
                    var nextVisibleColumn = sheet._getNextVisualColumn(columnIndex, sheetArea);
                    var maxWidth = sheet._getZoomColumnWidth(columnIndex, sheetArea) + sheet._getZoomColumnWidth(nextVisibleColumn, sheetArea);
                    updateResizeInfo(resizeInfo, x, layout, false, maxWidth);
                } else {
                    updateResizeInfo(resizeInfo, x, layout, false);
                }
            }
            function getResizeIndexNextToFrozenLine(sheet, targetIndex, isRow) {
                var frozenIndex = isRow ? sheet.frozenRowCount() : sheet.frozenColumnCount();
                var scrollIndex = isRow ? sheet._scrollTopRow : sheet._scrollLeftCol;
                var hasRowColumnScrollHidden = false;
                var visibility;
                var lastUnhiddenScrollIndex = scrollIndex - 1;
                if (frozenIndex > 0 && frozenIndex < scrollIndex) {
                    var tempIndex = scrollIndex - 1;
                    while (tempIndex >= frozenIndex) {
                        visibility = isRow ? sheet.getRowVisible(tempIndex) : sheet.getColumnVisible(tempIndex);
                        if (visibility) {
                            var size = isRow ? sheet.getRowHeight(tempIndex) : sheet.getColumnWidth(tempIndex);
                            if (tempIndex === lastUnhiddenScrollIndex && size === 0) {
                                break;
                            } else if (size > 0) {
                                hasRowColumnScrollHidden = true;
                                break;
                            }
                        } else {
                            lastUnhiddenScrollIndex--;
                        }
                        tempIndex--;
                    }
                }
                var retIndex = hasRowColumnScrollHidden ? frozenIndex : targetIndex;
                retIndex--;
                while (retIndex >= 0) {
                    visibility = isRow ? sheet.getRowVisible(retIndex) : sheet.getColumnVisible(retIndex);
                    if (visibility) {
                        return retIndex;
                    }
                    retIndex--;
                }

                return -1;
            }
            var Timer = (function () {
                function Timer(host) {
                    var self = this;
                    self._host = host;
                    self._interval = keyword_null;
                    self._action = keyword_null;
                    self._intervalId = keyword_null;
                    self._result = keyword_null;
                    self._working = false;
                    self._needIncrease = false;
                }
                Timer.prototype._setAction = function (action) {
                    if (typeof (action) === const_function) {
                        this._action = action;
                    }
                };
                Timer.prototype._setInterval = function (interval) {
                    var self = this;
                    if (!isNotANumber(interval) && interval !== 0) {
                        self._needIncrease = interval > 0;
                        interval = Math_abs(interval);
                        var oldInterval = self._interval;
                        self._interval = interval;
                        if (oldInterval !== interval) {
                            self._start();
                        }
                    } else {
                        self._stop();
                    }
                };
                Timer.prototype._start = function () {
                    var self = this;
                    self._clear();
                    if (!isNotANumber(self._interval)) {
                        self._intervalId = WINDOW.setInterval(function () {
                            self._run();
                        }, self._interval);
                    }
                };
                Timer.prototype._run = function () {
                    var self = this, action = self._action;
                    self._working = true;
                    if (typeof (action) === const_function) {
                        self._result = action.call(self._host, self._needIncrease);
                    }
                };
                Timer.prototype._stop = function () {
                    var self = this;
                    self._clear();
                    self._interval = keyword_null;
                    self._intervalId = keyword_null;
                    self._result = keyword_null;
                    self._working = false;
                };
                Timer.prototype._clear = function () {
                    var intervalId = this._intervalId;
                    if (intervalId) {
                        clearInterval(intervalId);
                    }
                };
                Timer.prototype._dispose = function () {
                    this._stop();
                };
                return Timer;
            }());

            var _SheetEventHandler = (function () {
                function _SheetEventHandler(sheet) {
                    this._tableSelection = 0;
                    var self = this;
                    self._repeatKeyDownTimeoutID = 0;
                    self._focusReleased = false;
                    self._focusSuspended = false;
                    self._dragRect = {};
                    self._sheet = sheet;
                    self._eventId = 'gcEvent' + sheet._id;
                }
                _SheetEventHandler.prototype._dispose = function () {
                    var self = this;
                    if (self._hScrollTimer) {
                        self._hScrollTimer._dispose();
                    }
                    if (self._vScrollTimer) {
                        self._vScrollTimer._dispose();
                    }
                    self._mousePosition = keyword_null;
                };
                _SheetEventHandler.prototype._getHScrollTimer = function () {
                    var self = this;
                    if (!self._hScrollTimer) {
                        self._hScrollTimer = new Timer(self);
                    }
                    return self._hScrollTimer;
                };
                _SheetEventHandler.prototype._getVScrollTimer = function () {
                    var self = this;
                    if (!self._vScrollTimer) {
                        self._vScrollTimer = new Timer(self);
                    }
                    return self._vScrollTimer;
                };
                _SheetEventHandler.prototype._getCanvasOffset = function () {
                    return this._sheet._getCanvasOffset();
                };
                _SheetEventHandler.prototype._getCanvasPosition = function () {
                    var p = domUtil_1.GC$(this._sheet._getCanvas()).position();
                    if (!p) {
                        p = {
                            top: 0,
                            left: 0
                        };
                    }
                    return p;
                };
                _SheetEventHandler.prototype._doMouseDown = function (e) {
                    var isMac = common_1._util._isMacOS();
                    var ctrlKey = getCtrlKey(e);
                    var isMacCtrlAndClick = isMac && ctrlKey === true && e.button === 0;
                    if (e.button === 2 || isMacCtrlAndClick) {
                        return true;
                    }
                    var self = this;
                    var sheet = self._sheet;
                    self._handleDocumentMouseMove();
                    if (browser && browser.msie && e.offsetX !== keyword_undefined && e.offsetY !== keyword_undefined) {
                        var relativeOffsetLeft = 0;
                        var relativeOffsetTop = 0;
                        var canvas = sheet._canvas;
                        if (e.target !== canvas) {
                            var relativeOffset = common_1._util._getRelativeOffset(e.target, canvas);
                            relativeOffsetLeft = relativeOffset._left;
                            relativeOffsetTop = relativeOffset._top;
                        }
                        if (canvas) {
                            var canvasOffsetLeft = e.pageX - (e.offsetX + relativeOffsetLeft);
                            var canvasOffsetTop = e.pageY - (e.offsetY + relativeOffsetTop);
                            canvas.canvasOffset = {
                                top: canvasOffsetTop,
                                left: canvasOffsetLeft
                            };
                        }
                    }
                    var t = sheet._getCanvasOffset();
                    var ret = self._doMouseDownImp(e, e.pageX - t.left, e.pageY - t.top);
                    if (!isEditing(sheet) && !ret) {
                        self._setFocus();
                    }
                    sheet._isMouseDownInSheet = true;
                    return false;
                };
                _SheetEventHandler.prototype._handleDocumentMouseMove = function () {
                    var self = this;
                    if (!self._isMouseCapture) {
                        domUtil_1.GC$(DOCUMENT)
                            .bind('mousemove.gcSheet' + '.' + self._eventId, function (e) {
                                self._doMouseMove(e);
                            })
                            .bind('mouseup.gcSheet' + '.' + self._eventId, function (e) {
                                self._doMouseUp(e);
                            });
                        self._isMouseCapture = true;
                    }
                };
                _SheetEventHandler.prototype._unhandleDocumentMouseMove = function () {
                    if (this._isMouseCapture) {
                        this._isMouseCapture = false;
                        domUtil_1.GC$(DOCUMENT)
                            .unbind('mousemove.gcSheet' + '.' + this._eventId)
                            .unbind('mouseup.gcSheet' + '.' + this._eventId);
                    }
                };
                // 处理canvas上的mousedown事件的具体实现
                _SheetEventHandler.prototype._doMouseDownImp = function (e, x, y) {
                    var self = this;
                    var sheet = self._sheet;
                    var target = sheet.hitTest(x, y);
                    var r = target.row;
                    var c = target.col;
                    var dragInfo = target.dragInfo;
                    var frInfo = target.formulaRangeHitInfo;
                    var cellTypeHitInfo = target.cellTypeHitInfo;
                    var resizeTableHitInfo = target.resizeTableHitInfo;
                    var argObj = {
                        hitInfo: target,
                        e: e,
                        r: keyword_null
                    };
                    worksheet_1.Worksheet._callFeatureHandler(sheet, 'processMouseDown', argObj);
                    var layout = sheet._getSheetLayout();
                    if (x >= layout.x && y >= layout.y) {
                        sheet._currentTarget = target;
                        if (argObj.r) {
                            return;
                        }
                        self._isMouseDown = true;
                        if (target.tableSelectInfo && !sheet._formulaTextBox) {
                            this._startTableSelection(target, sheet);
                        } else if (target.resizeInfo) {
                            if (!endEdit(sheet)) {
                                return;
                            }
                            self._startResizing(target);
                        } else if (target.dragMergeInfo) {
                            if (!endEdit(sheet)) {
                                return;
                            }
                            self._startDragMerge && self._startDragMerge(target);
                        } else if (dragInfo && dragInfo.side && dragInfo.side !== CORNER) {
                            if (!endEdit(sheet)) {
                                return;
                            }
                            self._startDragDropping && self._startDragDropping(target);
                            self._setMetaKeyState(e);
                        } else if (dragInfo && dragInfo.side === CORNER) {
                            if (!endEdit(sheet)) {
                                return;
                            }
                            self._startDragFill && self._startDragFill(target);
                        } else if (target.filterButtonHitInfo) {
                            endEdit(sheet);
                        } else if (frInfo) {
                            if (frInfo.inBorder) {
                                self._startFormulaRangeMoving(target);
                            } else if (frInfo.inTopLeft || frInfo.inTopRight || frInfo.inBottomLeft || frInfo.inBottomRight) {
                                self._startFormulaRangeResizing(target);
                            }
                        } else if (resizeTableHitInfo) {
                            self._startTableResizing && self._startTableResizing(target);
                        } else if (sheet._canSelect(getRowViewportIndex(target) < 0 ? -1 : r, getColViewportIndex(target) < 0 ? -1 : c)) {
                            if (target.tableSelectInfo && sheet._formulaTextBox) {
                                var ftb = sheet._formulaTextBox;
                                var tableSelection = this._getCurrentSelection(target, sheet);
                                target.tableSelectInfo.tableSelection = tableSelection;
                                ftb._setTableSelections(tableSelection);
                            }
                            if (self._dealMouseDownInFormulatextbox && self._dealMouseDownInFormulatextbox(sheet, target)) {
                                return;
                            }
                            var oldActiveRow = getActiveRowIndex(sheet);
                            var oldActiveCol = getActiveColumnIndex(sheet);
                            if (cellTypeHitInfo) {
                                var ct = sheet.getCellType(cellTypeHitInfo.row, cellTypeHitInfo.col, getHitTestType(target));
                                if (!cellTypeHitInfo.sheet) {
                                    cellTypeHitInfo.sheet = sheet;
                                }
                                if (self._canSetSelectionChange(ct, cellTypeHitInfo)) {
                                    var sheetArea = cellTypeHitInfo.sheetArea;
                                    if ((isNullOrUndefined(sheetArea) || sheetArea === 3) &&
                                        (r !== oldActiveRow || c !== oldActiveCol)) {
                                        sheet.suspendPaint();
                                        try {
                                            if (!endEdit(sheet)) {
                                                return;
                                            }
                                            var args = createEventArg(sheet, sheet.name(), oldActiveRow, oldActiveCol, keyword_undefined, true);
                                            sheet._trigger(common_1.Events.LeaveCell, args);
                                            if (args && args.cancel === true) {
                                                return;
                                            }
                                            var oldSels = sheet._modelManager.getSelections();
                                            var span = sheet._modelManager.getSpan(r, c);
                                            var newSels = [
                                                new common_1.Range(span.row, span.col, span.rowCount, span.colCount)
                                            ];
                                            sheet._trigger(common_1.Events.FloatingElementSelected, {
                                                type: 'worksheet'
                                            });
                                            sheet._raiseSelectionChanging(oldSels, newSels);
                                            sheet._setActiveCellAndSelection(r, c, keyword_undefined, keyword_undefined, 1);
                                            sheet._trigger(common_1.Events.EnterCell, createEventArg(sheet, sheet.name(), r, c));
                                            sheet._raiseSelectionChanged(oldSels);
                                            sheet._noMoreSelectionChanged = true;
                                            self._updateValidationUI && self._updateValidationUI(r, c);
                                        } finally {
                                            sheet.resumePaint();
                                        }
                                    }
                                }
                                ct.processCellAndPaddingMouseDown(cellTypeHitInfo);
                            }
                            if (cellTypeHitInfo && cellTypeHitInfo.isReservedLocation) {
                                return true;
                            }
                            self._setMetaKeyState(e);
                            // 改变选择区域
                            self._changeSelection(sheet, target, r, c);
                        }
                    }
                };
                _SheetEventHandler.prototype._changeSelection = function (sheet, target, r, c) {
                    var self = this;
                    try {
                        self._hitTestResult = target;
                        if (isEditing(sheet) && !endEdit(sheet)) {
                            return;
                        }
                    } finally {
                        self._hitTestResult = keyword_null;
                    }
                    if (isNullOrUndefined(r) || isNullOrUndefined(c)) {
                        return;
                    }
                    if (getHitTestType(target) === 3) {
                        self._updateValidationUI && self._updateValidationUI(r, c);
                    }
                    sheet._trigger(common_1.Events.FloatingElementSelected, {
                        type: 'worksheet'
                    });
                    var oldSelections = sheet._modelManager.getSelections();
                    self._startSelecting(target, oldSelections);
                    var newSelections = sheet._modelManager.getSelections();
                    sheet._raiseSelectionChanging(oldSelections, newSelections);
                };
                _SheetEventHandler.prototype._canSetSelectionChange = function (cellType, cellTypeHitInfo) {
                    return cellType && cellTypeHitInfo && cellTypeHitInfo.isReservedLocation && (cellType.activeOnClick ? cellType.activeOnClick() : true);
                };
                _SheetEventHandler.prototype._isInvalidRect = function (rect) {
                    var sheet = this._sheet;
                    if (!sheet) {
                        return true;
                    }
                    var sheetLayout = sheet._getSheetLayout();
                    return isNullOrUndefined(rect.x) || isNullOrUndefined(rect.y) ||
                        isNullOrUndefined(rect.width) || isNullOrUndefined(rect.height) ||
                        rect.x + rect.width > sheetLayout._viewportX + sheet._getActualViewportWidth(sheetLayout) + sheetLayout._frozenTrailingWidth ||
                        rect.y + rect.height > sheetLayout._viewportY + sheet._getActualViewportHeight(sheetLayout) + sheetLayout._frozenTrailingHeight;
                };
                _SheetEventHandler.prototype._commitSelectValue = function (select, row, col, validList, ignoreFormatting) {
                    var sheet = this._sheet;
                    var newValue;
                    for (var i = 0, options = select.options, len = options.length; i < len; i++) {
                        var op = options[i];
                        if (op.selected) {
                            newValue = validList[i].value;
                            break;
                        }
                    }
                    var actualLocked = false;
                    if (sheet.options.isProtected) {
                        var style = sheet.getActualStyle(row, col);
                        if (style) {
                            actualLocked = style.locked;
                        }
                    }
                    if (newValue !== keyword_undefined && !actualLocked) {
                        var cellEditCmd = {
                            cmd: 'editCell',
                            sheetName: sheet.name(),
                            row: row,
                            col: col,
                            newValue: newValue,
                            autoFormat: true,
                            ignoreFormatting: ignoreFormatting
                        };
                        sheet._commandManager().execute(cellEditCmd);
                    }
                    domUtil_1.GC$(select).hide();
                };
                _SheetEventHandler.prototype._startScroll = function () {
                    var self = this;
                    if (!self._startHitInfo) {
                        return;
                    }
                    var hitType = self._startHitInfo._hitTestType;
                    if (hitType === 3 || hitType === 2) {
                        self._getVScrollTimer()._setAction(self._processVSScrolled);
                    }
                    if (hitType === 3 || hitType === 1) {
                        self._getHScrollTimer()._setAction(self._processHSScrolled);
                    }
                };
                _SheetEventHandler.prototype._checkContinueScroll = function () {
                    var self = this;
                    if (self._isSelecting) {
                        self._continueSelecting();
                    }
                    if (self._isDragMerging) {
                        self._continueDragMerge && self._continueDragMerge();
                    }
                    if (self._isDragDropping) {
                        self._continueDragDropping && self._continueDragDropping();
                    }
                    if (self._isDraggingFill) {
                        self._continueDragFill && self._continueDragFill();
                    }
                    if (self._isFormulaRangeAppending) {
                        self._continueFormulaRangeAppending();
                    }
                    if (self._isFormulaRangeMoving) {
                        self._continueFormulaRangeMoving();
                    }
                    if (self._isFormulaRangeResizing) {
                        self._continueFormulaRangeResizing();
                    }
                    if (self._isTableResizing) {
                        self._continueTableResizing && self._continueTableResizing();
                    }
                };
                _SheetEventHandler.prototype._processVSScrolled = function (increase) {
                    var self = this;
                    var adjusted = self._adjustScrollRowViewport();
                    if (!adjusted) {
                        var hi = self._startHitInfo;
                        var sheet = self._sheet;
                        var rowViewportIndex = hi._scrollRowViewportIndex;
                        var topRow = sheet.getViewportTopRow(rowViewportIndex);
                        var bottomRow = sheet.getViewportBottomRow(rowViewportIndex);
                        if (increase) {
                            if (bottomRow < getSheetRowCount(sheet) - sheet.frozenTrailingRowCount() - 1) {
                                sheet._setTopRow(sheet._getNextVisualRow(topRow));
                            } else {
                                var rowLayoutModel = sheet._getRowLayout(rowViewportIndex);
                                if (rowLayoutModel && rowLayoutModel.length > 0) {
                                    var layout = sheet._getSheetLayout();
                                    var lastRow = rowLayoutModel[rowLayoutModel.length - 1];
                                    if (lastRow.y + lastRow.height >= layout._viewportY + sheet._getActualViewportHeight(layout)) {
                                        sheet._setTopRow(sheet._getNextVisualRow(topRow));
                                    }
                                }
                            }
                        } else if (topRow > getFrozenRowCount(sheet)) {
                            sheet._setTopRow(sheet._getPrevVisualRow(topRow));
                        }
                    }
                    self._checkContinueScroll();
                };
                _SheetEventHandler.prototype._processHSScrolled = function (increase) {
                    var self = this;
                    var adjusted = self._adjustScrollColViewport();
                    if (!adjusted) {
                        var sheet = self._sheet;
                        var hi = self._startHitInfo;
                        var colViewportIndex = hi._scrollColViewportIndex;
                        var leftCol = sheet.getViewportLeftColumn(colViewportIndex);
                        var rightCol = sheet.getViewportRightColumn(colViewportIndex);
                        if (increase) {
                            if (rightCol < getSheetColumnCount(sheet) - sheet.frozenTrailingColumnCount() - 1) {
                                sheet._setLeftColumn(sheet._getNextVisualColumn(leftCol));
                            } else {
                                var colLayoutModel = sheet._getColumnLayout(colViewportIndex);
                                if (colLayoutModel && colLayoutModel.length > 0) {
                                    var layout = sheet._getSheetLayout();
                                    var lastCol = colLayoutModel[colLayoutModel.length - 1];
                                    if (lastCol.x + lastCol.width >= layout._viewportX + sheet._getActualViewportWidth(layout)) {
                                        sheet._setLeftColumn(sheet._getNextVisualColumn(leftCol));
                                    }
                                }
                            }
                        } else if (leftCol > getFrozenColumnCount(sheet)) {
                            sheet._setLeftColumn(sheet._getPrevVisualColumn(leftCol));
                        }
                    }
                    self._checkContinueScroll();
                };
                _SheetEventHandler.prototype._adjustScrollRowViewport = function () {
                    var sheet = this._sheet;
                    var layout = sheet._getSheetLayout();
                    var frozenRowCount = getFrozenRowCount(sheet);
                    var frozenTrailingRowCount = sheet.frozenTrailingRowCount();
                    var mousePosition = this._mousePosition;
                    var hi = this._startHitInfo;
                    var rowViewportIndex = hi._scrollRowViewportIndex;
                    var rowLayoutModel, rowLayout;
                    if (rowViewportIndex === 0) {
                        if (mousePosition.y > layout._viewportY) {
                            sheet._setTopRow(sheet._getFirstPageTopRow());
                            hi._scrollRowViewportIndex = 1;
                            return true;
                        }
                    } else if (rowViewportIndex === 1) {
                        rowLayoutModel = sheet._getRowLayout(1);
                        if (rowLayoutModel && rowLayoutModel.length > 0) {
                            rowLayout = rowLayoutModel[0];
                            if (frozenRowCount > 0 &&
                                mousePosition.y < layout._viewportY &&
                                rowLayout.row <= sheet._getFirstPageTopRow()) {
                                hi._scrollRowViewportIndex = 0;
                                return true;
                            }
                            rowLayout = rowLayoutModel[rowLayoutModel.length - 1];
                            if (
                                frozenTrailingRowCount > 0
                                && mousePosition.y > layout._frozenTrailingY
                                && rowLayout.row >= sheet._getLastVisualRow()
                                && rowLayout.y + rowLayout.height <= layout._frozenTrailingY
                            ) {
                                hi._scrollRowViewportIndex = 2;
                                return true;
                            }
                        }
                    } else if (rowViewportIndex === 2) {
                        rowLayoutModel = sheet._getRowLayout(1);
                        if (rowLayoutModel && rowLayoutModel.length > 0 && mousePosition.y < layout._frozenTrailingY) {
                            rowLayout = rowLayoutModel[rowLayoutModel.length - 1];
                            if (rowLayout.y + rowLayout.height > layout._frozenTrailingY) {
                                var viewportHeight = sheet._getActualViewportHeight(layout);
                                var newTopRow = getSheetRowCount(sheet) - frozenTrailingRowCount - 1;
                                var height = 0;
                                for (var r = newTopRow; r >= frozenRowCount; r--) {
                                    height += sheet._getZoomRowHeight(r);
                                    if (height > viewportHeight) {
                                        newTopRow = Math_min(r + 1, newTopRow);
                                        break;
                                    }
                                }
                                sheet._setTopRow(sheet._getNextVisualRow(newTopRow - 1));
                            }
                            hi._scrollRowViewportIndex = 1;
                            return true;
                        }
                    }
                    return false;
                };
                _SheetEventHandler.prototype._adjustScrollColViewport = function () {
                    var sheet = this._sheet;
                    var frozenTrailingColCount = sheet.frozenTrailingColumnCount();
                    var frozenColCount = getFrozenColumnCount(sheet);
                    var layout = sheet._getSheetLayout();
                    var mousePosition = this._mousePosition;
                    var hi = this._startHitInfo;
                    var colViewportIndex = hi._scrollColViewportIndex;
                    var colLayoutModel;
                    var colLayout;
                    if (colViewportIndex === 0) {
                        if (mousePosition.x > layout._viewportX) {
                            sheet._setLeftColumn(sheet._getFirstPageLeftColumn());
                            hi._scrollColViewportIndex = 1;
                            return true;
                        }
                    } else if (colViewportIndex === 1) {
                        colLayoutModel = sheet._getColumnLayout(1);
                        if (colLayoutModel && colLayoutModel.length > 0) {
                            colLayout = colLayoutModel[0];
                            if (frozenColCount > 0 &&
                                mousePosition.x < layout._viewportX &&
                                colLayout.col <= sheet._getFirstPageLeftColumn()) {
                                hi._scrollColViewportIndex = 0;
                                return true;
                            }
                            colLayout = colLayoutModel[colLayoutModel.length - 1];
                            if (frozenTrailingColCount > 0 &&
                                mousePosition.x > layout._frozenTrailingX &&
                                colLayout.col >= sheet._getLastVisualColumn() &&
                                colLayout.x + colLayout.width <= layout._frozenTrailingX) {
                                hi._scrollColViewportIndex = 2;
                                return true;
                            }
                        }
                    } else if (colViewportIndex === 2) {
                        colLayoutModel = sheet._getColumnLayout(1);
                        if (colLayoutModel && colLayoutModel.length > 0 && mousePosition.x < layout._frozenTrailingX) {
                            colLayout = colLayoutModel[colLayoutModel.length - 1];
                            if (colLayout.x + colLayout.width > layout._frozenTrailingX) {
                                var viewportWidth = sheet._getActualViewportWidth(layout);
                                var newLeftColumn = getSheetColumnCount(sheet) - frozenTrailingColCount - 1;
                                var width = 0;
                                for (var c = newLeftColumn; c >= frozenColCount; c--) {
                                    width += sheet._getZoomColumnWidth(c);
                                    if (width > viewportWidth) {
                                        newLeftColumn = Math_min(c + 1, newLeftColumn);
                                        break;
                                    }
                                }
                                sheet._setLeftColumn(sheet._getNextVisualColumn(newLeftColumn - 1));
                            }
                            hi._scrollColViewportIndex = 1;
                            return true;
                        }
                    }
                    return false;
                };
                _SheetEventHandler.prototype._continueScroll = function () {
                    var self = this;
                    if (!self._isWorking && !self._isFloatingObjectWorking && !self._isCommentWorking) {
                        return;
                    }
                    var sheet = self._sheet;
                    var layout = sheet._getSheetLayout();
                    var hi = self._startHitInfo;
                    if (isNullOrUndefined(hi)) {
                        return;
                    }
                    var rowViewportIndex = hi._scrollRowViewportIndex;
                    var colViewportIndex = hi._scrollColViewportIndex;
                    var mousePosition = self._mousePosition;
                    var viewportRect = keyword_null;
                    if (rowViewportIndex >= 0 && colViewportIndex >= 0) {
                        viewportRect = layout._viewportRect(rowViewportIndex, colViewportIndex);
                        if (rowViewportIndex === 0 && sheet._scrollTopRow === sheet.frozenRowCount()) {
                            var rect = layout._viewportRect(1, colViewportIndex);
                            viewportRect.height += rect.height;
                        }
                        if (colViewportIndex === 0 && sheet._scrollLeftCol === sheet.frozenColumnCount()) {
                            var rect = layout._viewportRect(rowViewportIndex, 1);
                            viewportRect.width += rect.width;
                        }
                    } else if (rowViewportIndex >= 0) {
                        viewportRect = layout._rowHeaderRect(rowViewportIndex);
                    } else if (colViewportIndex >= 0) {
                        viewportRect = layout._colHeaderRect(colViewportIndex);
                    }
                    if (viewportRect) {
                        var workbook = sheet.parent;
                        var isMobileScrollbar = workbook && workbook.options.scrollbarAppearance === core_enum_1.ScrollbarAppearance.mobile;
                        var distanceX = 0;
                        var distanceY = 0;
                        var needScrollV = false;
                        var needScrollH = false;
                        if (mousePosition.x <= viewportRect.x) {
                            distanceX = mousePosition.x - viewportRect.x;
                            if (isMobileScrollbar) {
                                needScrollH = true;
                            }
                        } else if (mousePosition.x >= viewportRect.x + viewportRect.width) {
                            distanceX = mousePosition.x - (viewportRect.x + viewportRect.width);

                            if (distanceX === 0) {
                                distanceX = 50;
                            }
                            if (isMobileScrollbar) {
                                needScrollH = true;
                            }
                        } else if (isMobileScrollbar && mousePosition.x === viewportRect.x + viewportRect.width - 1) {
                            distanceX = 50;
                            needScrollH = true;
                        }
                        if (mousePosition.y <= viewportRect.y) {
                            distanceY = mousePosition.y - viewportRect.y;
                            if (isMobileScrollbar) {
                                needScrollV = true;
                            }
                        } else if (mousePosition.y >= viewportRect.y + viewportRect.height) {
                            distanceY = mousePosition.y - (viewportRect.y + viewportRect.height);
                            if (isMobileScrollbar) {
                                needScrollV = true;
                            }
                        }
                        if (workbook && isMobileScrollbar) {
                            if (needScrollV) {
                                workbook._vScrollbar._updateState(core_enum_1.ScrollbarState.show);
                                workbook._scrollService._launchHideScrollbarTimer(true);
                            }
                            if (needScrollH) {
                                workbook._hScrollbar._updateState(core_enum_1.ScrollbarState.show);
                                workbook._scrollService._launchHideScrollbarTimer(false);
                            }
                        }
                        self._getHScrollTimer()._setInterval(self._getIntervalFromDistance(distanceX));
                        self._getVScrollTimer()._setInterval(self._getIntervalFromDistance(distanceY));
                    }
                };
                _SheetEventHandler.prototype._stopScroll = function () {
                    this._getHScrollTimer()._stop();
                    this._getVScrollTimer()._stop();
                };
                _SheetEventHandler.prototype._startResizing = function (target) {
                    var self = this;
                    var layoutPrototype = worksheet_model_1._LayoutModel.prototype;
                    var sheet = self._sheet;
                    var resizeInfo = target.resizeInfo;
                    var rl;
                    var cl;
                    if (resizeInfo.action === SIZEROW || resizeInfo.action === SIZEHIDDENROW) {
                        rl = getResizeLayout(self, sheet._getAllRowLayout, self._getPreVisualRow, layoutPrototype.findRow, target.row, resizeInfo, true);
                        resizeInfo.startY = rl.y;
                    } else {
                        cl = getResizeLayout(self, sheet._getAllColumnLayout, self._getPreVisualCol, layoutPrototype.findCol, target.col, resizeInfo, false);
                        resizeInfo.startX = cl.x;
                    }
                    var workbook = sheet.parent;
                    var x = target.x;
                    var y = target.y;
                    if (workbook) {
                        var showResizeTip = workbook.options.showResizeTip;
                        if ((showResizeTip === 1 &&
                            (resizeInfo.action === SIZECOL || resizeInfo.action === SIZEHIDDENCOL)) ||
                            (showResizeTip === 2 &&
                                (resizeInfo.action === SIZEROW || resizeInfo.action === SIZEHIDDENROW)) ||
                            showResizeTip === 3) {
                            var layout = sheet._getSheetLayout();
                            if (resizeInfo.action === SIZECOL || resizeInfo.action === SIZEHIDDENCOL) {
                                x += RESIZETOOLTIP_GAP;
                                if (x + 70 > layout.width) {
                                    x = x - 70 - 2 * RESIZETOOLTIP_GAP;
                                }
                                y = layout._colHeaderHeight + RESIZETOOLTIP_GAP;
                            } else {
                                x = layout._rowHeaderWidth + RESIZETOOLTIP_GAP;
                                y += RESIZETOOLTIP_GAP;
                                if (y + 30 > layout.height) {
                                    y = y - 30 - 2 * RESIZETOOLTIP_GAP;
                                }
                            }
                            workbook._showTooltip(StringHelper._escapeHtml(self._getMouseDownResizeTooltipContent()), x, y);
                        }
                    }
                    self.isResizing = true;
                    self._isWorking = true;
                    if (self.ctrl) {
                        self._isEnableSplitResize = true;
                    }
                };
                _SheetEventHandler.prototype._continueResizing = function () {
                    var self = this;
                    var sheet = self._sheet;
                    var currentTarget = sheet._currentTarget;
                    var resizeInfo = currentTarget.resizeInfo;
                    var mousePosition = self._mousePosition;
                    var x = mousePosition.x;
                    var y = mousePosition.y;
                    var layout = sheet._getSheetLayout();
                    var workbook = sheet.parent;
                    var sheetArea = resizeInfo.sheetArea;
                    if (!resizeInfo || !self._isWorking || !self.isResizing) {
                        return;
                    }
                    if (currentTarget.x === x && currentTarget.y === y) {
                        return;
                    }

                    if (resizeInfo.action === SIZEROW || resizeInfo.action === SIZEHIDDENROW) {
                        _updateRowResizeInfo(sheet, resizeInfo, sheetArea, y, self._isEnableSplitResize);
                    } else {
                        _updateColumnResizeInfo(sheet, resizeInfo, sheetArea, x, self._isEnableSplitResize);
                    }

                    var render = sheet._render;
                    var ctx = render._getCtx();
                    render._copyDoubleBuffer(layout.x, layout.y, layout.width, layout.height);
                    render._paintAdornment(ctx);

                    if (workbook) {
                        var showResizeTip = workbook.options.showResizeTip;
                        if ((showResizeTip === 1 &&
                            (resizeInfo.action === SIZECOL || resizeInfo.action === SIZEHIDDENCOL)) ||
                            (showResizeTip === 2 && (resizeInfo.action === SIZEROW || resizeInfo.action === SIZEHIDDENROW)) ||
                            showResizeTip === 3) {
                            var tipPosX;
                            var tipPosY;
                            if (resizeInfo.action === SIZECOL || resizeInfo.action === SIZEHIDDENCOL) {
                                tipPosX = resizeInfo.movingX + RESIZETOOLTIP_GAP;
                                tipPosY = layout._colHeaderHeight + RESIZETOOLTIP_GAP;
                                if (tipPosX + 70 > layout.width) {
                                    tipPosX = resizeInfo.movingX - 70 - RESIZETOOLTIP_GAP;
                                }
                            } else {
                                tipPosX = layout._rowHeaderWidth + RESIZETOOLTIP_GAP;
                                tipPosY = resizeInfo.movingY + RESIZETOOLTIP_GAP;
                                if (tipPosY + 30 > layout.height) {
                                    tipPosY = resizeInfo.movingY - 30 - RESIZETOOLTIP_GAP;
                                }
                            }
                            workbook._refreshTooltip(self._getMouseMoveResizeTooltipContent(resizeInfo), tipPosX, tipPosY);
                        }
                    }
                };
                _SheetEventHandler.prototype._stopResizing = function () {
                    var self = this;
                    self.isResizing = false;
                    self._isWorking = false;
                    var needResize = true;
                    var sheet = self._sheet;
                    var currentTarget = sheet._currentTarget;
                    var resizeInfo = currentTarget.resizeInfo;
                    var value;
                    if (!resizeInfo) {
                        return;
                    }
                    self._removeTooltip();
                    if (resizeInfo.action === SIZEROW || resizeInfo.action === SIZEHIDDENROW) {
                        if (!isNullOrUndefined(resizeInfo.movingY)) {
                            value = Math_max(0, (resizeInfo.movingY - resizeInfo.startY) / sheet.zoom());
                            var rowList_1 = [];
                            var rowCmdName = 'resizeRow';
                            if (sheet._isRowSelected(resizeInfo.index)) {
                                domUtil_1.GC$.each(sheet._modelManager.getSelections(), function (i, p) {
                                    if (p.col === -1) {
                                        if (resizeInfo.sheetArea === 1) {
                                            rowList_1.push({
                                                firstRow: resizeInfo.index,
                                                lastRow: resizeInfo.index
                                            });
                                        } else {
                                            var selectedRange = sheet._getActualRange(p);
                                            rowList_1.push({
                                                firstRow: selectedRange.row,
                                                lastRow: selectedRange.row + getRowCount(selectedRange) - 1
                                            });
                                        }
                                    }
                                });
                            } else {
                                rowList_1.push({
                                    firstRow: resizeInfo.index,
                                    lastRow: resizeInfo.index
                                });
                            }
                            if (_shouldSplitResizeRow(sheet, resizeInfo, rowList_1, self._isEnableSplitResize)) {
                                rowCmdName = 'splitResizeRow';
                            }
                            var isColHeader = resizeInfo.sheetArea === 1;
                            sheet._commandManager().execute({
                                cmd: rowCmdName,
                                sheetName: sheet.name(),
                                rows: rowList_1,
                                size: value,
                                columnHeader: isColHeader
                            });
                        } else {
                            needResize = false;
                        }
                    } else if (!isNullOrUndefined(resizeInfo.movingX)) {
                        value = Math_max(0, (resizeInfo.movingX - resizeInfo.startX) / sheet.zoom());
                        var columnList_1 = [];
                        var columnCmdName = 'resizeColumn';
                        if (sheet._isColumnSelected(resizeInfo.index)) {
                            domUtil_1.GC$.each(sheet._modelManager.getSelections(), function (i, p) {
                                if (p.row === -1) {
                                    var selectedRange = sheet._getActualRange(p);
                                    if (resizeInfo.sheetArea === 2) {
                                        columnList_1.push({ firstCol: resizeInfo.index, lastCol: resizeInfo.index });
                                    } else {
                                        columnList_1.push({
                                            firstCol: selectedRange.col,
                                            lastCol: selectedRange.col + getColCount(selectedRange) - 1
                                        });
                                    }
                                }
                            });
                        } else {
                            columnList_1.push({
                                firstCol: resizeInfo.index,
                                lastCol: resizeInfo.index
                            });
                        }
                        if (_shouldSplitResizeColumn(sheet, resizeInfo, columnList_1, self._isEnableSplitResize)) {
                            columnCmdName = 'splitResizeColumn';
                        }
                        var isRowHeader = resizeInfo.sheetArea === 2;
                        sheet._commandManager().execute({
                            cmd: columnCmdName,
                            sheetName: sheet.name(),
                            columns: columnList_1,
                            size: value,
                            rowHeader: isRowHeader
                        });
                    } else {
                        needResize = false;
                    }
                    var target = sheet.hitTest(self._mousePosition.x, self._mousePosition.y);
                    if (target) {
                        self._updateCanvasCursor(target);
                    }
                    if (!needResize) {
                        sheet.repaint();
                    }
                    self._isEnableSplitResize = false;
                };
                _SheetEventHandler.prototype._startSelectingCore = function (target, doNotSetFocus) {
                    var colIndex = 0;
                    var rowIndex = 0;
                    var rowCount = 0;
                    var colCount = 0;
                    var self = this;
                    var sheet = self._sheet;
                    var bm = sheet._bindingManager;
                    var frozenRowCount = getFrozenRowCount(sheet);
                    var frozenColCount = getFrozenColumnCount(sheet);
                    var cancel;
                    var hitTestType = getHitTestType(target);
                    self._oldSelections = self._lastSelections = sheet._modelManager.getSelections();
                    // 如果没有按住 ctrl 或者 shift 就清空之前的选择区域
                    if (!sheet.isCtrlPressed(hitTestType) && !self.shift) {
                        sheet._clearSelectionImp();
                    }
                    var firstRow;
                    var cellRange;
                    var activeRowChanged;
                    // 命中的区域是左上角的单元格，则选择整个工作表。
                    // 如果按住了shift，则
                    // 如果按住ctrl，则
                    if (hitTestType === 0) {
                        if (!self.shift) {
                            firstRow = frozenRowCount ? sheet._getFirstVisualRow() : sheet._scrollTopRow;
                            var leftCol = frozenColCount ? sheet._getFirstVisualColumn() : sheet._scrollLeftCol;
                            cancel = changeActiveCell(self, firstRow, leftCol, 1, 1, doNotSetFocus);
                            if (cancel) {
                                return;
                            }
                        }
                        if (!sheet.isCtrlPressed(hitTestType)) {
                            sheet._clearSelectionImp();
                        }
                        sheet._setSelectedRange(-1, -1, getSheetRowCount(sheet), getSheetColumnCount(sheet), true);
                    }
                    // 命中区域是顶部的列标题，则选择整列
                    // 如果按住了shift，则
                    else if (hitTestType === 1) {
                        if (!self.shift) {
                            firstRow = frozenRowCount ? sheet._getFirstVisualRow() : sheet._scrollTopRow;
                            cellRange = self._getAvailableActiveCell(firstRow, target.col, false);
                            cancel = changeActiveCell(self, cellRange.row, cellRange.col, 1, getColViewportIndex(target), doNotSetFocus);
                            if (cancel) {
                                return;
                            }
                        }
                        if (self.shift || sheet._isDeselecting) {
                            colIndex = Math_min(sheet._activeColIndex, target.col);
                            colCount = Math_abs(sheet._activeColIndex - target.col) + 1;
                            sheet._replaceActiveSelectedRange(-1, colIndex, getSheetRowCount(sheet), colCount, true);
                        } else {
                            sheet._setSelectedRange(-1, sheet._activeColIndex, getSheetRowCount(sheet), 1, true);
                        }
                    }
                    // 命中区域是左侧的行标题，则选择整行
                    // 如果按住了shift，则
                    else if (hitTestType === 2) {
                        if (!self.shift) {
                            var firstCol = frozenColCount ? sheet._getFirstVisualColumn() : sheet._scrollLeftCol;
                            cellRange = self._getAvailableActiveCell(target.row, firstCol, true);
                            activeRowChanged = (sheet._activeRowIndex !== cellRange.row);
                            cancel = changeActiveCell(self, cellRange.row, cellRange.col, getRowViewportIndex(target), 1, doNotSetFocus);
                            if (cancel) {
                                return;
                            }
                            if (activeRowChanged && bm) {
                                bm._doDataItemChanged();
                            }
                        }
                        if (self.shift || sheet._isDeselecting) {
                            rowIndex = Math_min(sheet._activeRowIndex, target.row);
                            rowCount = Math_abs(sheet._activeRowIndex - target.row) + 1;
                            sheet._replaceActiveSelectedRange(rowIndex, -1, rowCount, getSheetColumnCount(sheet), true);
                        } else {
                            sheet._setSelectedRange(sheet._activeRowIndex, -1, 1, getSheetColumnCount(sheet), true);
                        }
                    }
                    // 命中区域是视口
                    else if (hitTestType === 3) {
                        if (!isNotANumber(target.row) && !isNotANumber(target.col)) {
                            if (!self.shift) {
                                if (sheet._activeRowIndex !== target.row || sheet._activeColIndex !== target.col) {
                                    activeRowChanged = (sheet._activeRowIndex !== target.row);
                                    cancel = changeActiveCell(self, target.row, target.col, getRowViewportIndex(target), getColViewportIndex(target), doNotSetFocus);
                                    if (cancel) {
                                        return;
                                    }
                                    if (activeRowChanged && bm) {
                                        bm._doDataItemChanged();
                                    }
                                }
                            }
                            if (self.shift) {
                                sheet._extendSelectedRange(target.row, target.col, true);
                            } else {
                                var span = sheet._modelManager.getSpan(target.row, target.col);
                                if (!sheet._isDeselecting) {
                                    sheet._setSelectedRange(span.row, span.col, getRowCount(span), getColCount(span), true);
                                }
                            }
                        } else if (isEditing(sheet)) {
                            var rect = sheet.getCellRect(sheet._activeRowIndex, sheet._activeColIndex, sheet._activeRowViewportIndex, sheet._activeColViewportIndex);
                            sheet._render._update(rect.x, rect.y, rect.width, rect.height);
                        }
                    }
                };
                _SheetEventHandler.prototype._startSelectingScroll = function (target) {
                    if (!target) {
                        return;
                    }
                    if (getHitTestType(target) === 3 && (isNotANumber(target.row) || isNotANumber(target.col))) {
                        return;
                    }
                    var self = this;
                    self._isWorking = true;
                    self._isSelecting = true;
                    self._startHitInfo = {
                        _scrollRowViewportIndex: getRowViewportIndex(target),
                        _scrollColViewportIndex: getColViewportIndex(target),
                        _hitTestType: getHitTestType(target)
                    };
                    self._startScroll();
                };
                _SheetEventHandler.prototype._getDeselectRange = function (targetRow, targetCol) {
                    var self = this;
                    var sheet = self._sheet;
                    var deselectRange;
                    var targetSpan = sheet.getSpan(targetRow, targetCol);
                    var r = targetRow;
                    var c = targetCol;
                    var rc = 1;
                    var cc = 1;
                    var selectionUnit = sheet.selectionUnit();
                    var isCell = false;
                    if (selectionUnit === 1) {
                        c = -1;
                        cc = -1;
                        r = targetSpan ? targetSpan.row : r;
                        rc = targetSpan ? targetSpan.rowCount : rc;
                    } else if (selectionUnit === 2) {
                        r = -1;
                        rc = -1;
                        c = targetSpan ? targetSpan.col : c;
                        cc = targetSpan ? targetSpan.colCount : cc;
                    } else {
                        isCell = true;
                    }
                    if (targetSpan && isCell) {
                        deselectRange = targetSpan;
                    } else {
                        deselectRange = new common_1.Range(r, c, rc, cc);
                    }
                    return deselectRange;
                };
                _SheetEventHandler.prototype._startSelecting = function (target, selections) {
                    var self = this;
                    var sheet = self._sheet;
                    var targetRow = target.row;
                    var targetCol = target.col;
                    sheet._isDeselecting =
                        self._getIsDeselect(
                            targetRow, targetCol, selections, getHitTestType(target)
                        )
                        && sheet.parent.options.allowUserDeselect;
                    if (sheet._isDeselecting) {
                        sheet._oldActiveRow = sheet._activeRowIndex;
                        sheet._oldActiveCol = sheet._activeColIndex;
                        sheet._deselectRange = self._getDeselectRange(targetRow, targetCol);
                    }
                    self._startSelectingCore(target);
                    self._startSelectingScroll(target);
                };
                _SheetEventHandler.prototype._getIsDeselect = function (row, col, selections, hitTestType) {
                    var self = this;
                    var sheet = self._sheet;
                    var isStartCellInSelection = self._getIsStartCellInSelection(row, col, selections, hitTestType);
                    return isStartCellInSelection && sheet.selectionPolicy() === 2;
                };
                _SheetEventHandler.prototype._getIsStartCellInSelection = function (row, col, selections, hitTestType) {
                    var sheet = this._sheet;
                    var viewportRowCount = sheet.getRowCount();
                    var viewportColumnCount = sheet.getColumnCount();
                    if (!sheet.isCtrlPressed(hitTestType)) {
                        return false;
                    }
                    var flag = false;
                    var len = selections.length;
                    for (var i = 0; i < len; i++) {
                        if (hitTestType === 3) {
                            if (selections[i].contains(row, col, 1, 1)) {
                                flag = true;
                                break;
                            }
                        } else if (hitTestType === 2) {
                            if (selections[i].contains(row, -1, 1, viewportColumnCount) || selections[i].contains(row, 0, 1, viewportColumnCount)) {
                                flag = true;
                                break;
                            }
                        } else if (hitTestType === 1) {
                            if (selections[i].contains(-1, col, viewportRowCount, 1) || selections[i].contains(0, col, viewportRowCount, 1)) {
                                flag = true;
                                break;
                            }
                        }
                    }
                    return flag;
                };
                _SheetEventHandler.prototype._continueSelecting = function () {
                    var self = this;
                    if (!self._startHitInfo || !self._isWorking) {
                        return;
                    }
                    if (self._forceCancelSelectiong === true) {
                        return;
                    }
                    var hitTestType = self._startHitInfo._hitTestType;
                    if (hitTestType === 3) {
                        self._continueCellSelecting();
                    } else if (hitTestType === 2) {
                        self._continueRowSelecting();
                    } else if (hitTestType === 1) {
                        self._continueColumnSelecting();
                    }
                };
                _SheetEventHandler.prototype._continueCellSelecting = function () {
                    var self = this;
                    var sheet = self._sheet;
                    var hitRow = self._getHitRowIndex();
                    var hitCol = self._getHitColumnIndex();
                    if (hitRow >= 0 && hitCol >= 0 && sheet._canSelect(hitRow, hitCol)) {
                        self._continueScroll();
                        var oldSelections = sheet._modelManager.getSelections();
                        if (oldSelections.length === 1) {
                            var extendedRange = sheet._getExtendedRange(hitRow, hitCol, sheet._activeRowIndex, sheet._activeColIndex);
                            var oldRange = oldSelections[0];
                            if (!sheet._isDeselecting && extendedRange.equals(oldRange)) {
                                return;
                            }
                        }
                        sheet._extendSelectedRange(hitRow, hitCol, true);
                        var newSelections = sheet._modelManager.getSelections();
                        sheet._raiseSelectionChanging(oldSelections, newSelections);
                    }
                };
                _SheetEventHandler.prototype._continueRowSelecting = function () {
                    var self = this;
                    var sheet = self._sheet;
                    var hitRow = self._getHitRowIndex(true);
                    if (hitRow >= 0 && sheet._canSelect(hitRow, -1)) {
                        var r = Math_min(sheet._activeRowIndex, hitRow);
                        var rc = Math_max(sheet._activeRowIndex, hitRow) - r + 1;
                        var c = -1;
                        var cc = getSheetColumnCount(sheet);
                        var selectionPolicy = sheet.selectionPolicy();
                        if (selectionPolicy === 0) {
                            return;
                        }
                        var selectionUnit = sheet.selectionUnit();
                        if (selectionUnit === 2) {
                            r = -1;
                            rc = -1;
                        }
                        var oldSelections = sheet._modelManager.getSelections();
                        sheet._replaceActiveSelectedRange(r, c, rc, cc, true);
                        var newSelections = sheet._modelManager.getSelections();
                        sheet._raiseSelectionChanging(oldSelections, newSelections);
                    }
                    self._continueScroll();
                };
                _SheetEventHandler.prototype._continueColumnSelecting = function () {
                    var self = this;
                    var sheet = self._sheet;
                    var hitCol = self._getHitColumnIndex(true);
                    if (hitCol >= 0 && sheet._canSelect(-1, hitCol)) {
                        var c = Math_min(sheet._activeColIndex, hitCol);
                        var cc = Math_max(sheet._activeColIndex, hitCol) - c + 1;
                        var r = -1;
                        var rc = getSheetRowCount(sheet);
                        var selectionPolicy = sheet.selectionPolicy();
                        if (selectionPolicy === 0) {
                            return;
                        }
                        var selectionUnit = sheet.selectionUnit();
                        if (selectionUnit === 1) {
                            c = -1;
                            cc = -1;
                        }
                        var oldSelections = sheet._modelManager.getSelections();
                        sheet._replaceActiveSelectedRange(r, c, rc, cc, true);
                        var newSelections = sheet._modelManager.getSelections();
                        sheet._raiseSelectionChanging(oldSelections, newSelections);
                    }
                    self._continueScroll();
                };
                _SheetEventHandler.prototype._stopSelecting = function () {
                    var self = this;
                    self._startHitInfo = keyword_null;
                    self._stopScroll();
                    self._forceCancelSelectiong = keyword_null;
                    self._isWorking = false;
                    self._isSelecting = false;
                    var sheet = self._sheet;
                    if (sheet._modelManager.getSelections().length === 0) {
                        return;
                    }
                    if (sheet._isDeselecting) {
                        sheet._isDeselecting = false;
                        var deselectRange = sheet._deselectRange;
                        sheet._deselectRange = null;
                        sheet._deselectSelections(sheet._modelManager.getSelections(), deselectRange);
                        delete sheet._oldActiveRow;
                        delete sheet._oldActiveCol;
                    }
                    if (sheet._noMoreSelectionChanged) {
                        delete sheet._noMoreSelectionChanged;
                    } else {
                        var needRaiseChangedEvent = !self._lastSelections;
                        if (!needRaiseChangedEvent) {
                            var currentSelections = sheet._modelManager.getSelections();
                            needRaiseChangedEvent = self._notEqualSelecions(self._lastSelections, currentSelections);
                        }
                        if (needRaiseChangedEvent) {
                            sheet._raiseSelectionChanged(self._oldSelections);
                        }
                    }
                    self._lastSelections = sheet._modelManager.getSelections();
                };
                _SheetEventHandler.prototype._getHitRowViewportIndex = function () {
                    var sheet = this._sheet;
                    var rowViewportIndex = _getRowViewportIndexNearY(sheet, this._mousePosition.y);
                    var scrollRowViewportIndex = this._startHitInfo._scrollRowViewportIndex;
                    var rowLayoutModel = sheet._getRowLayout(1);
                    if (rowViewportIndex === 0 &&
                        scrollRowViewportIndex > 0 &&
                        rowLayoutModel.length > 0 &&
                        rowLayoutModel[0].row > sheet._getFirstPageTopRow()) {
                        rowViewportIndex = 1;
                    } else if (rowViewportIndex === 2 &&
                        scrollRowViewportIndex < 2 &&
                        rowLayoutModel.length > 0 &&
                        rowLayoutModel[rowLayoutModel.length - 1].row < sheet._getLastVisualRow()) {
                        rowViewportIndex = 1;
                    }
                    return rowViewportIndex;
                };
                _SheetEventHandler.prototype._getHitColumnViewportIndex = function () {
                    var sheet = this._sheet;
                    var colViewportIndex = _getColumnViewportIndexNearX(sheet, this._mousePosition.x);
                    var scrollColViewportIndex = this._startHitInfo._scrollColViewportIndex;
                    var colLayoutModel = sheet._getColumnLayout(1);
                    if (colViewportIndex === 0 && scrollColViewportIndex > 0 && colLayoutModel.length > 0 && colLayoutModel[0].col > sheet._getFirstPageLeftColumn()) {
                        colViewportIndex = 1;
                    } else if (colViewportIndex === 2 && scrollColViewportIndex < 2 && colLayoutModel.length > 0 &&
                        colLayoutModel[colLayoutModel.length - 1].col < sheet._getLastVisualColumn()) {
                        colViewportIndex = 1;
                    }
                    return colViewportIndex;
                };
                _SheetEventHandler.prototype._getHitRowIndex = function (needExtendForward) {
                    var sheet = this._sheet;
                    var y = this._mousePosition.y;
                    var rowViewportIndex = this._getHitRowViewportIndex();
                    var rowLayout = _getViewportRowLayoutNearY(sheet, rowViewportIndex, y);
                    if (rowLayout) {
                        var layout = sheet._getSheetLayout();
                        var hitRow = rowLayout.row;
                        if (rowViewportIndex === 1 && y < layout._viewportY) {
                            var firstPageTopRow = sheet._getFirstPageTopRow();
                            if (hitRow > firstPageTopRow) {
                                return (sheet._getNextVisualRow(hitRow - 1) || hitRow);
                            } else if (hitRow === firstPageTopRow && needExtendForward) {
                                return 0;
                            }
                        } else if (rowViewportIndex === 0 && y < layout._frozenY && needExtendForward) {
                            return 0;
                        }
                        if (rowViewportIndex === 1 && y > layout._frozenTrailingY && hitRow > sheet._getLastFullyVisibleRow()) {
                            return (sheet._getPrevVisualRow(hitRow) || hitRow);
                        }
                        return hitRow;
                    }
                    return -1;
                };
                _SheetEventHandler.prototype._getHitColumnIndex = function (needExtendForward) {
                    var sheet = this._sheet;
                    var x = this._mousePosition.x;
                    var colViewportIndex = this._getHitColumnViewportIndex();
                    var colLayout = _getViewportColumnLayoutNearX(sheet, colViewportIndex, x);
                    if (colLayout) {
                        var layout = sheet._getSheetLayout();
                        var hitCol = colLayout.col;
                        if (colViewportIndex === 1 && x < layout._viewportX) {
                            var firstPageLeftColumn = sheet._getFirstPageLeftColumn();
                            if (hitCol > firstPageLeftColumn) {
                                return (sheet._getNextVisualColumn(hitCol - 1) || hitCol);
                            } else if (hitCol === firstPageLeftColumn && needExtendForward) {
                                return 0;
                            }
                        } else if (colViewportIndex === 0 && x < layout._frozenX && needExtendForward) {
                            return 0;
                        }
                        if (colViewportIndex === 1 && x > layout._frozenTrailingX && hitCol > sheet._getLastFullyVisibleColumn()) {
                            return (sheet._getPrevVisualColumn(hitCol) || hitCol);
                        }
                        return hitCol;
                    }
                    return -1;
                };
                _SheetEventHandler.prototype._getIntervalFromDistance = function (distance) {
                    var interval = 0;
                    if (!isNotANumber(distance) && distance !== 0) {
                        var isNegative = (distance < 0);
                        interval = Math_ceil(500 / Math_abs(distance));
                        interval = Math_max(20, interval * 10);
                        if (interval > 200) {
                            interval = 200;
                        }
                        if (isNegative) {
                            interval = -interval;
                        }
                    }
                    return interval;
                };
                _SheetEventHandler.prototype._getPreVisualRow = function (row, sheetArea) {
                    var sheet = this._sheet;
                    var preVisualRow = sheet._getPrevVisualRow(row, sheetArea);
                    return preVisualRow !== keyword_null ? preVisualRow : row;
                };
                _SheetEventHandler.prototype._getPreVisualCol = function (col, sheetArea) {
                    var sheet = this._sheet;
                    var preVisualCol = sheet._getPrevVisualColumn(col, sheetArea);
                    return preVisualCol !== keyword_null ? preVisualCol : col;
                };
                _SheetEventHandler.prototype._getPreVisibleRow = function (row, endRow, sheetArea) {
                    var sheet = this._sheet;
                    while (row > endRow) {
                        row--;
                        if (sheet.getRowVisible(row, sheetArea)) {
                            return row;
                        }
                    }
                    return row;
                };
                _SheetEventHandler.prototype._getPreVisibleCol = function (col, endCol, sheetArea) {
                    var sheet = this._sheet;
                    while (col > endCol) {
                        col--;
                        if (sheet.getColumnVisible(col, sheetArea)) {
                            return col;
                        }
                    }
                    return col;
                };
                _SheetEventHandler.prototype._getResizeRowInfo = function (sheet, target, resizeArea, sheetArea, y) {
                    var op = keyword_null;
                    if (!canDoResizeRows(sheet)) {
                        return op;
                    }
                    var self = this;
                    var rowLayout = sheet._getRowLayout(getRowViewportIndex(target), sheetArea);
                    if (rowLayout && !isNotANumber(target.row) && !isNotANumber(target.col)) {
                        if (!sheet.getRowVisible(target.row, sheetArea)) {
                            target.row = this._getPreVisualRow(target.row, sheetArea);
                        }
                        var rl = rowLayout.findRow(target.row);
                        if (rl) {
                            if (rl.y + rl.height - resizeArea <= y && y <= rl.y + rl.height + resizeArea) {
                                op = createOption(SIZEROW, target.row, sheetArea);
                                var lastRow = rowLayout[rowLayout.length - 1].row;
                                if (lastRow >= 0) {
                                    var lastVisibleRow = sheet._getLastVisualRow(sheetArea);
                                    if (op.index === lastVisibleRow && op.index !== lastRow) {
                                        if (rl.y + rl.height - resizeArea / 2 <= y) {
                                            op = createOption(self._getResizeRowAction(sheet, lastRow, sheetArea), lastRow, sheetArea);
                                        }
                                    }
                                }
                            } else if (rl.y - resizeArea <= y && y <= rl.y + resizeArea && Common_1.Common._ArrayHelper._indexOf(rowLayout, rl) > 0) {
                                var preVisibleRow = self._getPreVisibleRow(target.row, 0, sheetArea);
                                op = createOption(self._getResizeRowAction(sheet, preVisibleRow, sheetArea), preVisibleRow, sheetArea);
                            }
                        }
                        if (!op && getRowViewportIndex(target) === 1 && rowLayout.length > 0) {
                            rl = rowLayout[0];
                            if (Math_max(0, rl.y - resizeArea) <= y && y <= rl.y + resizeArea) {
                                var row = getResizeIndexNextToFrozenLine(sheet, target.row, true);
                                if (row >= 0) {
                                    op = createOption(self._getResizeRowAction(sheet, row, sheetArea), row, sheetArea);
                                }
                            }
                        }
                    }
                    if (op && !sheet.getRowResizable(op.index, sheetArea)) {
                        op = keyword_null;
                    }
                    return op;
                };
                _SheetEventHandler.prototype._getResizeRowAction = function (sheet, row, sheetArea) {
                    var workbook = sheet.parent;
                    if (workbook && workbook.options.resizeZeroIndicator === 1 &&
                        sheet.getRowVisible(row) && sheet._getActualRowHeight(row, sheetArea) === 0) {
                        return SIZEHIDDENROW;
                    }
                    return SIZEROW;
                };
                _SheetEventHandler.prototype._getResizeColInfo = function (sheet, target, resizeArea, sheetArea, x) {
                    var op = keyword_null;
                    if (!canDoResizeColumns(sheet)) {
                        return op;
                    }
                    var self = this;
                    var colLayout = sheet._getColumnLayout(getColViewportIndex(target), sheetArea);
                    if (colLayout && !isNotANumber(target.col) && !isNotANumber(target.row)) {
                        if (!sheet.getColumnVisible(target.col, sheetArea)) {
                            target.col = this._getPreVisualCol(target.col, sheetArea);
                        }
                        var cl = colLayout.findCol(target.col);
                        if (cl) {
                            if (cl.x + cl.width - resizeArea <= x && x <= cl.x + cl.width + resizeArea) {
                                op = createOption(SIZECOL, target.col, sheetArea);
                                var lastCol = colLayout[colLayout.length - 1].col;
                                if (lastCol >= 0) {
                                    var lastVisibleCol = sheet._getLastVisualColumn(sheetArea);
                                    if (op.index === lastVisibleCol && op.index !== lastCol) {
                                        if (cl.x + cl.width - resizeArea / 2 <= x) {
                                            op = createOption(self._getResizeColAction(sheet, lastCol, sheetArea), lastCol, sheetArea);
                                        }
                                    }
                                }
                            } else if (cl.x - resizeArea <= x && x <= cl.x + resizeArea && Common_1.Common._ArrayHelper._indexOf(colLayout, cl) > 0) {
                                var preVisibleCol = self._getPreVisibleCol(target.col, 0, sheetArea);
                                op = createOption(self._getResizeColAction(sheet, preVisibleCol, sheetArea), preVisibleCol, sheetArea);
                            }
                        }
                        if (!op && getColViewportIndex(target) === 1 && colLayout.length > 0) {
                            cl = colLayout[0];
                            if (Math_max(0, cl.x - resizeArea) <= x && x <= cl.x + resizeArea) {
                                var col = getResizeIndexNextToFrozenLine(sheet, target.col, false);
                                if (col >= 0) {
                                    op = createOption(self._getResizeColAction(sheet, col, sheetArea), col, sheetArea);
                                }
                            }
                        }
                    }
                    if (op && !sheet.getColumnResizable(op.index, sheetArea)) {
                        op = keyword_null;
                    }
                    return op;
                };
                _SheetEventHandler.prototype._getResizeColAction = function (sheet, col, sheetArea) {
                    var workbook = sheet.parent;
                    if (workbook && workbook.options.resizeZeroIndicator === 1 &&
                        sheet.getColumnVisible(col) && sheet._getActualColumnWidth(col, sheetArea) === 0) {
                        return SIZEHIDDENCOL;
                    }
                    return SIZECOL;
                };
                _SheetEventHandler.prototype._getResizingRowCol = function (target, x, y, resizeArea) {
                    var self = this;
                    var sheet = self._sheet;
                    var workbook = sheet.parent;
                    var sheet_options = sheet.options;
                    var colHeaderVisible = sheet_options.colHeaderVisible;
                    var rowHeaderVisible = sheet_options.rowHeaderVisible;
                    var op = keyword_null;
                    var r;
                    var c;
                    if (!workbook || workbook.options.allowUserResize) {
                        var sheetLayout = sheet._getSheetLayout();
                        if (getRowViewportIndex(target) < 0 && getColViewportIndex(target) >= 0 && colHeaderVisible) {
                            op = self._getResizeColInfo(sheet, target, resizeArea, 1, x);
                            if (!op) {
                                op = self._getResizeRowInfo(sheet, target, resizeArea, 1, y);
                            }
                        } else if (getRowViewportIndex(target) >= 0 && getColViewportIndex(target) < 0 && rowHeaderVisible) {
                            op = self._getResizeRowInfo(sheet, target, resizeArea, 2, y);
                            if (!op) {
                                op = self._getResizeColInfo(sheet, target, resizeArea, 2, x);
                            }
                        } else if (getRowViewportIndex(target) < 0 && getColViewportIndex(target) < 0) {
                            if ((sheet._getLastVisualRow(2) === keyword_null) && (Math_abs(y - sheetLayout._colHeaderHeight) <= resizeArea)) {
                                var rowLayout = sheet._getRowLayout(1);
                                if (rowLayout && rowLayout.length > 0) {
                                    r = rowLayout[rowLayout.length - 1].row;
                                    if (r >= 0 && sheet.getRowResizable(r, 2)) {
                                        op = createOption(self._getResizeRowAction(sheet, r, 2), r, 2);
                                    }
                                }
                            } else if ((sheet._getLastVisualColumn(1) === keyword_null) && (Math_abs(x - sheetLayout._rowHeaderWidth) <= resizeArea)) {
                                var colLayout = sheet._getColumnLayout(1);
                                if (colLayout && colLayout.length > 0) {
                                    c = colLayout[colLayout.length - 1].col;
                                    if (c >= 0 && sheet.getColumnResizable(c, 1)) {
                                        op = createOption(self._getResizeColAction(sheet, c, 1), c, 1);
                                    }
                                }
                            }
                        } else if (getRowViewportIndex(target) >= 0 && getColViewportIndex(target) >= 0) {
                            r = getSheetRowCount(sheet, 1) - 1;
                            c = getSheetColumnCount(sheet, 2) - 1;
                            var offsetTop = sheet.options.sheetAreaOffset.top;
                            var offsetLeft = sheet.options.sheetAreaOffset.left;
                            if (r >= 0 && sheetLayout._colHeaderHeight === 0 && offsetTop <= y && y <= resizeArea + offsetTop && colHeaderVisible) {
                                op = createOption(self._getResizeRowAction(sheet, r, 1), r, 1);
                            } else if (c >= 0 && sheetLayout._rowHeaderWidth === 0 && offsetLeft <= x && x <= resizeArea + offsetLeft && rowHeaderVisible) {
                                op = createOption(self._getResizeColAction(sheet, c, 2), c, 2);
                            }
                        }
                    }
                    return op;
                };
                _SheetEventHandler.prototype._inGrayArea = function (rowViewportIndex, colViewportIndex, x, y) {
                    var sheet = this._sheet;
                    var layout = sheet._getSheetLayout();
                    var viewportRect = layout._viewportRect(1, 1);
                    if (colViewportIndex === 1) {
                        var colLayoutModel = sheet._getColumnLayout(colViewportIndex);
                        if (colLayoutModel && colLayoutModel.length > 0) {
                            var colLayout = colLayoutModel[colLayoutModel.length - 1];
                            if (colLayout.x + colLayout.width <= x && x < viewportRect.x + viewportRect.width) {
                                return true;
                            }
                        } else if (viewportRect.contains(x, y)) {
                            return true;
                        }
                    }
                    if (rowViewportIndex === 1) {
                        var rowLayoutModel = sheet._getRowLayout(rowViewportIndex);
                        if (rowLayoutModel && rowLayoutModel.length > 0) {
                            var rowLayout = rowLayoutModel[rowLayoutModel.length - 1];
                            if (rowLayout.y + rowLayout.height <= y && y < viewportRect.y + viewportRect.height) {
                                return true;
                            }
                        } else if (viewportRect.contains(x, y)) {
                            return true;
                        }
                    }
                    return false;
                };
                _SheetEventHandler.prototype._doMouseMove = function (e) {
                    var t = this._getCanvasOffset();
                    this._doMouseMoveImp(e, e.pageX - t.left, e.pageY - t.top);
                };
                _SheetEventHandler.prototype._doMouseOut = function () {
                    var sheet = this._sheet;
                    var oldTarget = sheet._currentTarget;
                    if (oldTarget) {
                        var cellTypeHitInfo = oldTarget.cellTypeHitInfo;
                        if (cellTypeHitInfo) {
                            var celltype = sheet.getCellType(cellTypeHitInfo.row, cellTypeHitInfo.col, getHitTestType(oldTarget));
                            celltype._onProcessMouseLeave(cellTypeHitInfo);
                        }
                    }
                    if (this._isWorking) {
                        return;
                    }
                    var outTarget = {
                        x: -10000,
                        y: -10000,
                        rowViewportIndex: keyword_null,
                        colViewportIndex: keyword_null,
                        row: -1,
                        col: -1,
                        resizeInfo: keyword_null,
                        hitTestType: keyword_null
                    };
                    this._setHoverCell(outTarget);
                    if (oldTarget) {
                        var row = oldTarget.row;
                        var col = oldTarget.col;
                        var style = sheet.getActualStyle(row, col);
                        if (sheet._pivotTableTipTimeOut) {
                            clearTimeout(sheet._pivotTableTipTimeOut);
                            delete sheet._pivotTableTipTimeOut;
                        }
                        if (sheet.parent && style && style.showEllipsis) {
                            sheet.parent._removeTooltip();
                        }
                    }
                };
                _SheetEventHandler.prototype._doMouseMoveImp = function (e, x, y) {
                    var self = this;
                    self._mousePosition = {
                        e: e,
                        x: x,
                        y: y
                    };
                    var sheet = self._sheet;
                    if (self._isMouseDown && !common_1._FocusHelper._isActiveElement(sheet)) {
                        common_1._FocusHelper._setActiveElement(sheet);
                    }
                    if (self._isMouseDown && self._isWorking) {
                        if (self.isResizing) {
                            self._continueResizing();
                        } else if (self._isDragMerging) {
                            self._continueDragMerge && self._continueDragMerge();
                        } else if (self._isDragDropping) {
                            self._continueDragDropping && self._continueDragDropping();
                        } else if (self._isDraggingFill) {
                            self._continueDragFill && self._continueDragFill();
                        } else if (self._isFormulaRangeAppending) {
                            self._continueFormulaRangeAppending();
                        } else if (self._isFormulaRangeMoving) {
                            self._continueFormulaRangeMoving();
                        } else if (self._isFormulaRangeResizing) {
                            self._continueFormulaRangeResizing();
                        } else if (self._isTableResizing) {
                            self._continueTableResizing && self._continueTableResizing();
                        } else if (self._isSelecting) {
                            self._continueSelecting();
                        }
                        return;
                    }
                    var target = sheet.hitTest(x, y);
                    self._updateTableSelcetionRange(sheet, target, self);
                    if (!target) {
                        return;
                    } else {
                        if (self._tableSelection === 0 && target.tableSelectInfo && self._isMouseDown) {
                            self._updateTableSelectionActionIndex(sheet, self, target);
                        }
                    }
                    var workbook = sheet.parent;
                    var row = target.row;
                    var col = target.col;
                    var sheetArea = sheet._getSheetArea(target.rowViewportIndex, target.colViewportIndex);
                    var tipContent, style;
                    var pivotTable = target.pivotTableInfo;
                    var isShowPivotToolTip = !isNullOrUndefined(pivotTable) && pivotTable.options.showToolTip;
                    if (workbook) {
                        style = sheet.getActualStyle(row, col, sheetArea);
                        var cellRect = sheet.getCellRect(row, col, target.rowViewportIndex, target.colViewportIndex);
                        if (isShowPivotToolTip && (!sheet.isEditing || !sheet.isEditing())) {
                            tipContent = pivotTable._getPivotTableTipContent(row, col);
                            var pivotToolTipClassName_1 = 'gc-spread-pivot-toolTip';
                            clearTimeout(sheet._pivotTableTipTimeOut);
                            delete sheet._pivotTableTipTimeOut;
                            workbook._removeTooltip();
                            if (tipContent && style._showTip !== false) {
                                sheet._pivotTableTipTimeOut = setTimeout(function (xPoint, yPoint) {
                                    workbook._showTooltip(tipContent, xPoint, yPoint + 15, false, pivotToolTipClassName_1);
                                }.bind(undefined, target.x, target.y), 700);
                            }
                        } else {
                            clearTimeout(sheet._pivotTableTipTimeOut);
                            delete sheet._pivotTableTipTimeOut;
                            tipContent = sheet._modelManager._getCellNodeTipContent(row, col, sheetArea);
                            if (tipContent && style._showTip !== false && sheetArea) {
                                workbook._showTooltip(tipContent, cellRect.x + cellRect.width + 5, cellRect.y + cellRect.height + 5, false);
                            } else {
                                var isScrolltipShowing = workbook.options.showScrollTip && (workbook._vScrollbar._isMousedownInScrollbar || workbook._hScrollbar._isMousedownInScrollbar);
                                if (!isScrolltipShowing) {
                                    workbook._removeTooltip();
                                }
                            }
                        }
                    } else {
                        clearTimeout(sheet._pivotTableTipTimeOut);
                        delete sheet._pivotTableTipTimeOut;
                    }
                    self._updateCanvasCursor(target);
                    if (workbook && workbook.options.enableAccessibility) {
                        var content = sheet._getAccessibilityContent(target);
                        workbook._updateAccessibilityContent(content);
                    }
                    self._setHoverCell(target);
                };
                _SheetEventHandler.prototype._updateTableSelcetionRange = function (sheet, target, self) {
                    if (self._tableSelection === 1) {
                        var row = self._tableSelectionCell.row;
                        var col = self._tableSelectionCell.col;
                        var tcol = target.col;
                        var selection = sheet.getSelections()[0];
                        sheet._replaceActiveSelectedRange(row, col > tcol ? tcol : col, selection.rowCount, ((col - tcol) > 0 ? (col - tcol + 1) : (tcol - col + 1)), true);
                    } else if (self._tableSelection === 2) {
                        var row = self._tableSelectionCell.row;
                        var col = self._tableSelectionCell.col;
                        var trow = target.row;
                        var selection = sheet.getSelections()[0];
                        sheet._replaceActiveSelectedRange(row > trow ? trow : row, col, ((row - trow) > 0 ? (row - trow + 1) : (trow - row + 1)), selection.colCount, true);
                    }
                };
                _SheetEventHandler.prototype._updateTableSelectionActionIndex = function (sheet, self, target) {
                    var row = sheet.getActiveRowIndex();
                    var col = sheet.getActiveColumnIndex();
                    self._tableSelectionCell = {
                        row: row,
                        col: col
                    };
                    var tableSelectionAction = target.tableSelectInfo.action;
                    if (tableSelectionAction === 'tableColSelect') {
                        self._tableSelection = 1;
                    } else if (tableSelectionAction === 'tableRowSelect') {
                        self._tableSelection = 2;
                    }
                };
                _SheetEventHandler.prototype._updateCanvasCursor = function (target) {
                    var self = this;
                    var sheet = self._sheet;
                    var canvas = sheet._getCanvas();
                    if (!canvas) {
                        return;
                    }
                    var oldTarget = sheet._currentTarget;
                    var celltype;
                    var targetChanged = ((!oldTarget) ||
                        (target.row !== oldTarget.row) ||
                        (target.col !== oldTarget.col) ||
                        (getHitTestType(target) !== getHitTestType(oldTarget)) ||
                        (target.resizeInfo && !oldTarget.resizeInfo) ||
                        (!target.resizeInfo && oldTarget.resizeInfo) ||
                        (target.resizeInfo && target.resizeInfo.action !== oldTarget.resizeInfo.action) ||
                        (target.dragInfo && !oldTarget.dragInfo) ||
                        (!target.dragInfo && oldTarget.dragInfo) ||
                        (target.dragInfo && target.dragInfo.action !== oldTarget.dragInfo.action)) ||
                        (target.resizeTableHitInfo && !oldTarget.resizeTableHitInfo) ||
                        (!target.cellTypeHitInfo && oldTarget.cellTypeHitInfo);
                    if (oldTarget && targetChanged) {
                        var cellTypeHitInfo = oldTarget.cellTypeHitInfo;
                        if (cellTypeHitInfo) {
                            celltype = sheet.getCellType(cellTypeHitInfo.row, cellTypeHitInfo.col, getHitTestType(oldTarget));
                            celltype._onProcessMouseLeave(cellTypeHitInfo);
                        }
                    }
                    var resizeInfo = target.resizeInfo;
                    var dragMergeInfo = target.dragMergeInfo;
                    var dragInfo = target.dragInfo;
                    var frInfo = target.formulaRangeHitInfo;
                    var cellTypeInfo = target.cellTypeHitInfo;
                    var render = sheet._render;
                    var resizeTableHitInfo = target.resizeTableHitInfo;
                    var tableSelectInfo = target.tableSelectInfo;
                    if (tableSelectInfo) {
                        if (tableSelectInfo.action === 'tableRowSelect') {
                            canvas.style.cursor = 'url(data:image/ico;base64,AAABAAEACAgAAAEAIABIAQAAFgAAACgAAAAIAAAAEAAAAAEAIAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAAATQAAABEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAAACtAAAAkAAAAAsAAAAAAAAAeAAAAHkAAAB5AAAAewAAANcAAAD9AAAAjAAAAA0AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD5AAAAngAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAPkAAACeAAAAeAAAAHkAAAB5AAAAewAAANcAAAD9AAAAjAAAAA0AAAAAAAAAAAAAAAAAAAAFAAAArQAAAJAAAAALAAAAAAAAAAAAAAAAAAAAAAAAAAUAAABNAAAAEQAAAAAAAAAA4wAAAOEAAAAAAAAAAAAAAAAAAAAAAAAA4QAAAOMAAAA=) 8 4,auto';
                        } else if (tableSelectInfo.action === 'tableColSelect') {
                            canvas.style.cursor = 'url(data:image/ico;base64,AAABAAEACAgAAAEAIABIAQAAFgAAACgAAAAIAAAAEAAAAAEAIAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgAAACKAAAAigAAAAgAAAAAAAAAAAAAAAAAAAAHAAAAfAAAAPYAAAD2AAAAewAAAAcAAAAAAAAACAAAAHwAAAD3AAAA/wAAAP8AAAD3AAAAfAAAAAgAAAAVAAAAVwAAAJ8AAAD/AAAA/wAAAJ4AAABXAAAAFQAAAAAAAAAAAAAAYAAAAP8AAAD/AAAAYAAAAAAAAAAAAAAAAAAAAAAAAABgAAAA/wAAAP8AAABgAAAAAAAAAAAAAAAAAAAAAAAAAGAAAAD/AAAA/wAAAGAAAAAAAAAAAAAAAAAAAAAAAAAAXwAAAPwAAAD8AAAAXwAAAAAAAAAAwwAAAIEAAAAAAAAAAAAAAMMAAADDAAAAwwAAAMMAAAA=) 8 4,auto';
                        } else if (tableSelectInfo.action === 'tableCornerSelect') {
                            canvas.style.cursor = 'url(data:image/ico;base64,AAABAAEACgoAAAEAIADgAQAAFgAAACgAAAAKAAAAFAAAAAEAIAAAAAAAkAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAkAAACTAAAA/QAAAP8AAAD/AAAA/wAAAP8AAAD/AAAAAAAAAAAAAAAAAAAAEwAAAJ8AAAD8AAAA/wAAAP8AAAD/AAAA/wAAAAAAAAAAAAAAAAAAAAAAAAAoAAAA3AAAAP8AAAD/AAAA/wAAAP8AAAAAAAAAAAAAAAAAAAATAAAAngAAAPwAAAD/AAAA/wAAAP8AAAD/AAAAAAAAAAAAAAASAAAAnwAAAP0AAAD/AAAA+gAAANwAAAD6AAAA/wAAAAAAAAASAAAAnwAAAP0AAAD/AAAA/QAAAJ4AAAAlAAAAnwAAAP0AAAAVAAAAngAAAP0AAAD/AAAA/QAAAJ8AAAASAAAAAAAAABQAAACTAAAApwAAAP0AAAD/AAAA/QAAAJ8AAAASAAAAAAAAAAAAAAAAAAAACgAAAG0AAADqAAAA/gAAAJ4AAAASAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACAAAAbQAAAKgAAAAWAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAwAAAAOAAAADwAAAA4AAAAMAAAACAAAAAAQAAAAOAAAAHwAAAD8AAAA==) 10 5,auto';
                        } else if (tableSelectInfo.action === 'tableSelect') {
                            canvas.style.cursor = 'move';
                        } else if (tableSelectInfo.action === 'default') {
                            canvas.style.cursor = '';
                        }
                    } else if (resizeInfo) {
                        if (resizeInfo.action === SIZECOL) {
                            canvas.style.cursor = common_1.CursorResource.ResizeCol;
                        } else if (resizeInfo.action === SIZEROW) {
                            canvas.style.cursor = common_1.CursorResource.ResizeRow;
                        } else if (resizeInfo.action === SIZEHIDDENCOL) {
                            canvas.style.cursor = common_1.CursorResource.ResizeHiddenCol;
                        } else if (resizeInfo.action === SIZEHIDDENROW) {
                            canvas.style.cursor = common_1.CursorResource.ResizeHiddenRow;
                        } else {
                            canvas.style.cursor = DEFAULT;
                        }
                    } else if (dragMergeInfo) {
                        if (dragMergeInfo.left || dragMergeInfo.right) {
                            canvas.style.cursor = 'w-resize';
                        } else if (dragMergeInfo.top || dragMergeInfo.bottom) {
                            canvas.style.cursor = 'n-resize';
                        }
                    } else if (dragInfo && dragInfo.action === 'drag') {
                        if (dragInfo.side === CORNER) {
                            canvas.style.cursor = 'crosshair';
                        } else if (dragInfo.side) {
                            canvas.style.cursor = 'move';
                        } else {
                            canvas.style.cursor = DEFAULT;
                        }
                    } else if (frInfo) {
                        if (frInfo.inBorder) {
                            canvas.style.cursor = 'move';
                        } else if (frInfo.inTopLeft) {
                            canvas.style.cursor = 'nw-resize';
                        } else if (frInfo.inTopRight) {
                            canvas.style.cursor = 'ne-resize';
                        } else if (frInfo.inBottomLeft) {
                            canvas.style.cursor = 'sw-resize';
                        } else if (frInfo.inBottomRight) {
                            canvas.style.cursor = 'se-resize';
                        }
                        var oldFormulaRangeHoving = self.isFormulaRangeHoving;
                        var oldFormulRangeHovingInfo = self._formulRangeHovingInfo;
                        var oldParamRange = (oldFormulRangeHovingInfo && oldFormulRangeHovingInfo.paramRange);
                        var newParamRange = frInfo.paramRange;
                        self.isFormulaRangeHoving = true;
                        self._formulRangeHovingInfo = { paramRange: newParamRange };
                        if (!oldFormulaRangeHoving || newParamRange.index !== oldParamRange.index) {
                            render._paintFormulaTextBox();
                        }
                    } else if (resizeTableHitInfo) {
                        canvas.style.cursor = 'se-resize';
                    } else {
                        if (cellTypeInfo) {
                            celltype = sheet.getCellType(cellTypeInfo.row, cellTypeInfo.col, getHitTestType(target));
                            cellTypeInfo.sheet = sheet;
                            if (targetChanged) {
                                celltype.processMouseEnter(cellTypeInfo);
                            }
                            celltype._onProcessMouseMove(cellTypeInfo);
                        }
                        if (targetChanged || !cellTypeInfo || !cellTypeInfo.isReservedLocation) {
                            canvas.style.cursor = DEFAULT;
                        }
                        if (self.isFormulaRangeHoving) {
                            self.isFormulaRangeHoving = false;
                            self._formulRangeHovingInfo = keyword_null;
                            render._paintFormulaTextBox();
                        }
                    }
                };
                _SheetEventHandler.prototype._doMouseUp = function (e) {
                    var self = this;
                    var sheet = self._sheet;
                    self._unhandleDocumentMouseMove();
                    if (!sheet._isMouseDownInSheet) {
                        return true;
                    }
                    sheet._isMouseDownInSheet = false;
                    self._doMouseUpImp(e);
                    return false;
                };
                _SheetEventHandler.prototype._doMouseUpImp = function (e) {
                    var self = this;
                    var sheet = self._sheet;
                    var ae = common_1._FocusHelper._getActiveElement();
                    self._isMouseDown = false;
                    self._tableSelection = 0;
                    if (ae && ae !== sheet && ae.endEdit) {
                        if (!ae._formulaTextBox || !ae._formulaTextBox._isSelectMode) {
                            ae.endEdit();
                            ae.repaint();
                        }
                    }
                    common_1._FocusHelper._setActiveElement(sheet);
                    if (self.isResizing) {
                        self._stopResizing();
                    } else if (self._isDragMerging) {
                        self._stopDragMerge && self._stopDragMerge();
                    } else if (self._isDragDropping) {
                        self._stopDragDrop && self._stopDragDrop();
                    } else if (self._isDraggingFill) {
                        self._endDragFill && self._endDragFill();
                    } else if (self._isFormulaRangeAppending) {
                        self._stopFormulaRangeAppending();
                    } else if (self._isFormulaRangeMoving) {
                        self._stopFormulaRangeMoving();
                    } else if (self._isFormulaRangeResizing) {
                        self._stopFormulaRangeResizing();
                    } else if (self._isTableResizing) {
                        self._endTableResizing && self._endTableResizing();
                    } else if (sheet._currentTarget) {
                        var currentTarget = sheet._currentTarget;
                        var cellTypeHitInfo = currentTarget.cellTypeHitInfo;
                        if (!currentTarget.filterButtonHitInfo && !currentTarget.resizeInfo &&
                            currentTarget.row >= 0 && currentTarget.col >= 0) {
                            if (cellTypeHitInfo) {
                                var ct = sheet.getCellType(cellTypeHitInfo.row, cellTypeHitInfo.col, getHitTestType(currentTarget));
                                if (!cellTypeHitInfo.sheet) {
                                    cellTypeHitInfo.sheet = sheet;
                                }
                                ct._onProcessMouseUp(cellTypeHitInfo);
                            }
                            if (!cellTypeHitInfo || !cellTypeHitInfo.isReservedLocation) {
                                sheet._trigger(common_1.Events.CellClick, createEventArg(sheet, sheet.name(), currentTarget.row, currentTarget.col, getHitTestType(currentTarget)));
                            }
                            self._stopSelecting();
                            if (sheet._isDropdownSheet && sheet._raiseDropdownSpreadMouseClick) {
                                sheet._raiseDropdownSpreadMouseClick();
                            }
                        }
                    }
                    self._isPivotWorking = false;
                    self._setMetaKeyState(e);
                };
                _SheetEventHandler.prototype._startEdit = function (e, x, y) {
                    var sheet = this._sheet;
                    if (!sheet.isEditing) {
                        return;
                    }
                    if (sheet !== common_1._FocusHelper._getActiveElement()) {
                        return;
                    }
                    var canvas = sheet._getCanvas();
                    if (!getShiftKey(e) && !getCtrlKey(e)) {
                        sheet._doStartEdit(canvas, x, y);
                    }
                };
                _SheetEventHandler.prototype._doKeyDown = function (event) {
                    var self = this;
                    var sheet = self._sheet;
                    if (sheet) {
                        var activeRowIndex = getActiveRowIndex(sheet);
                        var activeColumnIndex = getActiveColumnIndex(sheet);
                        var cellType = sheet.getCellType(activeRowIndex, activeColumnIndex);
                        var context = {
                            isEditing: isEditing(sheet),
                            sheet: sheet,
                            row: activeRowIndex,
                            col: activeColumnIndex,
                            sheetArea: 3
                        };
                        var context1 = {
                            sheet: sheet,
                            row: activeRowIndex,
                            col: activeColumnIndex,
                            sheetArea: 3
                        };
                        if (cellType && cellType.isReservedKey(event, context)) {
                            if (!isEditing(sheet)) {
                                cellType.processKeyDown(event, context1);
                            }
                            return;
                        }
                        var fbx = sheet._formulaTextBox;
                        if (fbx && fbx._isReservedKey(event)) {
                            return;
                        }
                        var attachedFBX = (sheet.parent && sheet.parent._attachedFormulaTextBox);
                        if (attachedFBX && attachedFBX._isReservedKey(event, context)) {
                            return;
                        }
                    }
                    var navKey = (!isEditing(sheet) && !getCtrlKey(event) && !getMetaKey(event) &&
                        (getKeyCode(event) === 34 ||
                            getKeyCode(event) === 33 ||
                            getKeyCode(event) === 37 ||
                            getKeyCode(event) === 39 ||
                            getKeyCode(event) === 9 ||
                            getKeyCode(event) === 13 ||
                            getKeyCode(event) === 38 ||
                            getKeyCode(event) === 40));
                    if (sheet._isTouchMode) {
                        sheet._isTouchMode = false;
                        sheet._render._refreshTouchSelectionIndicator();
                    }
                    var keyMapProcessed;
                    var keyCode = getKeyCode(event);
                    var isEnter = keyCode === 13;
                    var isEsc = keyCode === 27;
                    if (sheet._isDropdownSheet && sheet._raiseDropdownSpreadKeyboardEvent && (isEnter || isEsc)) {
                        sheet._raiseDropdownSpreadKeyboardEvent(isEsc);
                    } else {
                        keyMapProcessed = self._keyDownImp(event);
                    }
                    if (navKey && keyMapProcessed && common_1._FocusHelper._isActiveElement(sheet)) {
                        self._lastKeyDownTime = new Date();
                        if (self._keyPressed) {
                            if (self._keyPressedCount < 25) {
                                self._keyPressedCount++;
                            }
                            cancelDefault(event);
                            return;
                        }
                        self._keyPressed = true;
                        self._keyPressedCount = 1;
                        self._repeatKeyDown(event, true);
                    }
                };
                _SheetEventHandler.prototype._getMouseDownResizeTooltipContent = function () {
                    var sheet = this._sheet;
                    var currentTarget = sheet._currentTarget;
                    var resizeInfo = currentTarget.resizeInfo;
                    if (resizeInfo.action === SIZEROW || resizeInfo.action === SIZEHIDDENROW) {
                        var height = sheet.getRowHeight(resizeInfo.index);
                        return stringFormat(getSR().Tip_Height, [height]);
                    }
                    var width = sheet.getColumnWidth(resizeInfo.index);
                    return stringFormat(getSR().Tip_Width, [width]);
                };
                _SheetEventHandler.prototype._getMouseMoveResizeTooltipContent = function (resizeInfo) {
                    var sheet = this._sheet;
                    if (resizeInfo.action === SIZEROW || resizeInfo.action === SIZEHIDDENROW) {
                        return stringFormat(getSR().Tip_Height, [Math_max(0, Math_floor((resizeInfo.movingY - resizeInfo.startY) / sheet.zoom()))]);
                    }
                    return stringFormat(getSR().Tip_Width, [Math_max(0, Math_floor((resizeInfo.movingX - resizeInfo.startX) / sheet.zoom()))]);
                };
                _SheetEventHandler.prototype._repeatKeyDown = function (event, doNotExecuteImmediately) {
                    var self = this;
                    if (!self._keyPressed) {
                        return;
                    }
                    if (new Date() - self._lastKeyDownTime > 100) {
                        self._clearRepeatKeyDownTimeout();
                        return;
                    }
                    if (!doNotExecuteImmediately) {
                        self._keyDownImp(event);
                    }
                    if (self._keyPressed) {
                        self._repeatKeyDownTimeoutID = WINDOW.setTimeout(function () {
                            self._repeatKeyDown(event);
                        }, 500 / self._keyPressedCount);
                    }
                };
                _SheetEventHandler.prototype._startEditByKeyboard = function (event, isImeInput) {
                    var sheet = this._sheet;
                    var c = sheet._getCanvas();
                    if (c) {
                        sheet._startEditByKeydown = true;
                        try {
                            var editing = isEditing(sheet);
                            if (sheet._startEditImp) {
                                sheet._startEditImp(c, sheet._activeRowIndex, sheet._activeColIndex, keyword_null, keyword_null, true, keyword_null, isImeInput, event);
                            }
                            if (!editing && isEditing(sheet)) {
                                var ct = sheet.getCellType(sheet._activeRowIndex, sheet._activeColIndex);
                                if (ct._triggerButtonClicked &&
                                    getKeyCode(event) === 32 && !getCtrlKey(event) && !getShiftKey(event) && !getAltKey(event)) {
                                    ct._triggerButtonClicked(sheet, sheet._activeRowIndex, sheet._activeColIndex, 3);
                                }
                                if (ct._cancelDefaultKeydown) {
                                    ct._cancelDefaultKeydown(event);
                                }
                            }
                        } finally {
                            sheet._startEditByKeydown = false;
                            var clipboardHelper = sheet._getClipboardHelper();
                            if (clipboardHelper._showInsertCopyPasteCells) {
                                delete clipboardHelper._showInsertCopyPasteCells;
                            }
                        }
                    }
                };
                _SheetEventHandler.prototype._keyDownImp = function (event) {
                    var self = this;
                    var sheet = self._sheet;
                    self._setMetaKeyState(event);
                    if (!isEditing(sheet) && getKeyCode(event) === 27 && !getAltKey(event) && !getCtrlKey(event) && !getShiftKey(event) && sheet._validationInputMessage) {
                        domUtil_1.GC$(sheet._validationInputMessage).remove();
                        sheet._validationInputMessage = keyword_null;
                    }
                    var insertCopyCells = sheet._getClipboardHelper();
                    if (!isEditing(sheet) && getKeyCode(event) === 27 && !getAltKey(event) && !getCtrlKey(event) && !getShiftKey(event) && insertCopyCells._showInsertCopyPasteCells) {
                        delete insertCopyCells._showInsertCopyPasteCells;
                    }
                    if (!isEditing(sheet) &&
                        (getKeyCode(event) === 34 ||
                            getKeyCode(event) === 33 ||
                            getKeyCode(event) === 35 ||
                            getKeyCode(event) === 36 ||
                            getKeyCode(event) === 38 ||
                            getKeyCode(event) === 40)) {
                        cancelDefault(event);
                    }
                    if (!isEditing(sheet) && (getKeyCode(event) === 37 || getKeyCode(event) === 39)) {
                        cancelDefault(event);
                    }

                    if (isEditing(sheet) && getCtrlKey(event) && (getKeyCode(event) === 89 || getKeyCode(event) === 90)) {
                        cancelDefault(event);
                        return false;
                    }
                    var commands = sheet._commandManager();
                    var shortcut = commands.getShortcutKey(getKeyCode(event), getCtrlKey(event), getShiftKey(event), getAltKey(event), getMetaKey(event));
                    var cmds = commands.getCommands(shortcut);
                    if (cmds) {
                        for (var i = 0; i < cmds.length; i++) {
                            var options = {
                                sheetName: sheet.name()
                            };
                            var returnValue = cmds[i].execute(sheet.parent, options);
                            if (returnValue || options._canceled) {
                                if (!returnValue.ignoreCancelDefault) {
                                    cancelDefault(event);
                                }
                                return true;
                            }
                        }
                    }
                    var argObj = {
                        e: event,
                        r: keyword_null
                    };
                    worksheet_1.Worksheet._callFeatureHandler(sheet, 'processKeyDown', argObj);
                    if (argObj.r) {
                        return true;
                    }
                    if (self._allowEnterEditing(event)) {
                        var fbx = sheet._formulaTextBox;
                        if (fbx && fbx._isAppending) {
                            fbx._stopAppending();
                        }
                        var editing = isEditing(sheet);
                        if (!editing) {
                            var hitElement = WINDOW._gcGlobal._getUIElement(event.target);
                            var isAFBX = (hitElement && hitElement.getAttribute(attrGcUIElement) === 'gcAttachedFormulaTextBox');
                            if (!isAFBX) {
                                self._startEditByKeyboard(event);
                            }
                        }
                    }
                    return false;
                };
                _SheetEventHandler.prototype._clearRepeatKeyDownTimeout = function () {
                    var self = this;
                    self._keyPressed = false;
                    if (self._repeatKeyDownTimeoutID > 0) {
                        clearTimeout(self._repeatKeyDownTimeoutID);
                        self._repeatKeyDownTimeoutID = 0;
                    }
                };
                _SheetEventHandler.prototype._doKeyUp = function (event) {
                    var self = this;
                    self._clearRepeatKeyDownTimeout();
                    var sheet = self._sheet;
                    if (sheet) {
                        var activeRowIndex = getActiveRowIndex(sheet);
                        var activeColumnIndex = getActiveColumnIndex(sheet);
                        var cellType = sheet.getCellType(activeRowIndex, activeColumnIndex);
                        var context = {
                            isEditing: isEditing(sheet),
                            sheet: sheet,
                            row: activeRowIndex,
                            col: activeColumnIndex,
                            sheetArea: 3
                        };
                        var context1 = {
                            sheet: sheet,
                            row: activeRowIndex,
                            col: activeColumnIndex,
                            sheetArea: 3
                        };
                        if (cellType && cellType.isReservedKey(event, context)) {
                            if (!isEditing(sheet)) {
                                cellType.processKeyUp(event, context1);
                            }
                            return;
                        }
                        var fbx = sheet._formulaTextBox;
                        if (fbx && fbx._isReservedKey(event)) {
                            return;
                        }
                        var attachedFBX = (sheet.parent && sheet.parent._attachedFormulaTextBox);
                        if (attachedFBX && attachedFBX._isReservedKey(event)) {
                            return;
                        }
                    }
                    self._setMetaKeyState(event);
                };
                _SheetEventHandler.prototype._doCompositionStart = function (event) {
                    var self = this;
                    var sheet = self._sheet;
                    var argObj = {
                        e: event,
                        r: keyword_null
                    };
                    worksheet_1.Worksheet._callFeatureHandler(sheet, 'processCompositionStart', argObj);
                    if (!argObj.r) {
                        this._startEditByKeyboard(event, true);
                    }
                };
                _SheetEventHandler.prototype._allowEnterEditing = function (e) {
                    if (getCtrlKey(e) || getAltKey(e) || getMetaKey(e)) {
                        return false;
                    }
                    return (getKeyCode(e) >= 65 && getKeyCode(e) <= 90) ||
                        ((getKeyCode(e) >= 48 && getKeyCode(e) <= 59) || (getKeyCode(e) >= 96 && getKeyCode(e) <= 105)) ||
                        (getKeyCode(e) >= 186 && getKeyCode(e) <= 192) ||
                        (getKeyCode(e) >= 220 && getKeyCode(e) <= 222 || getKeyCode(e) === 219) ||
                        (getKeyCode(e) >= 106 && getKeyCode(e) <= 111) ||
                        (getKeyCode(e) === 32) ||
                        (getKeyCode(e) === 61) ||
                        (getKeyCode(e) === 173) ||
                        (getKeyCode(e) === 229 || getKeyCode(e) === 0) ||
                        (getKeyCode(e) === 8)
                        ;
                };
                _SheetEventHandler.prototype._setMetaKeyState = function (e) {
                    var self = this;
                    var sheet = self._sheet;
                    var isMac = common_1._util._isMacOS();
                    var ctrl = isMac ? getMetaKey(e) : getCtrlKey(e);
                    self.ctrl = ctrl && !getShiftKey(e);
                    self.shift = getShiftKey(e) && !ctrl;
                    sheet._isNavigateInSelection = false;
                    if (getKeyCode(e) === 9) {
                        var selectionCount = sheet._modelManager.getSelections().length;
                        if (selectionCount > 1) {
                            sheet._isNavigateInSelection = true;
                        } else {
                            var range = sheet._getActiveSelectedRange();
                            if (range && selectionCount > 0) {
                                sheet._isNavigateInSelection = !(sheet._activeRowIndex === range.row &&
                                    sheet._activeColIndex === range.col &&
                                    sheet._activeRowCount >= getRowCount(range) && sheet._activeColCount >= getColCount(range));
                            }
                        }
                    }
                    if (self._isDragDropping === true) {
                        var activeSelRange = sheet._getActiveSelectedRange();
                        var tempInsert = self._isDragInsert;
                        var tempCopy = self._isDragCopy;
                        if (activeSelRange.row === -1 || activeSelRange.col === -1) {
                            self._isDragInsert = getShiftKey(e);
                        } else {
                            self._isDragInsert = false;
                        }
                        self._isDragCopy = ctrl;
                        if (tempInsert !== self._isDragInsert || tempCopy !== self._isDragCopy) {
                            sheet._render._refreshDragDropIndicator && sheet._render._refreshDragDropIndicator();
                        }
                    }
                    self._isControlPressed = ctrl;
                };
                _SheetEventHandler.prototype._resetMetaKeyState = function () {
                    var self = this;
                    self.shift = false;
                    self.ctrl = false;
                    self._sheet._isNavigateInSelection = false;
                    self._isDragDropping = false;
                    self._isDragInsert = false;
                    self._isDragCopy = false;
                    self._isControlPressed = false;
                };
                _SheetEventHandler.prototype._updateEditingEditor = function (eData) {
                    var sheet;
                    var editor;
                    var canvasOffset;
                    if (eData && eData.sheet) {
                        sheet = eData.sheet;
                        editor = eData.editor;
                        canvasOffset = eData.canvasOffset;
                    } else {
                        sheet = this._sheet;
                        editor = sheet._editor;
                    }
                    if (!isEditing(sheet)) {
                        return;
                    }
                    var activeRow = sheet._activeRowIndex;
                    var activeCol = sheet._activeColIndex;
                    var ct = sheet.getCellType(activeRow, activeCol);
                    var sheetLayout = sheet._getSheetLayout();
                    var cellStyle = sheet.getActualStyle(activeRow, activeCol);
                    var cellRect = sheet.getCellRect(activeRow, activeCol);
                    if (editor && editor.parentNode) {
                        var cellWrapperElement = editor.parentNode.parentNode;
                        if (cellRect && cellRect.width > 0 && cellRect.height > 0 && cellRect.x >= sheetLayout._frozenX &&
                            cellRect.y >= sheetLayout._frozenY &&
                            cellRect.x + cellRect.width <= sheetLayout._frozenTrailingX + sheetLayout._frozenTrailingWidth &&
                            cellRect.y + cellRect.height <= sheetLayout._frozenTrailingY + sheetLayout._frozenTrailingHeight) {
                            var context = {
                                sheet: sheet,
                                row: activeRow,
                                col: activeCol,
                                sheetArea: 3,
                                canvasOffset: canvasOffset
                            };
                            ct._updateEditorWrapper(cellWrapperElement, cellStyle, cellRect, context);
                        } else {
                            domUtil_1.GC$(cellWrapperElement).css({ top: -10000, left: -10000 });
                        }
                    }
                    var fbx = sheet._formulaTextBox;
                    if (fbx) {
                        fbx._position();
                    }
                };
                _SheetEventHandler.prototype._getElementById = function (parent, id) {
                    if (!parent) {
                        return keyword_null;
                    }
                    var t = parent.firstChild;
                    while (t) {
                        if (t.id === id || t.name === id) {
                            return t;
                        }
                        var t1 = this._getElementById(t, id);
                        if (t1) {
                            return t1;
                        }
                        t = t.nextSibling;
                    }
                    return keyword_null;
                };
                _SheetEventHandler.prototype._notEqualSelecions = function (oldSelections, newSelections) {
                    var notEqual = true;
                    if (oldSelections.length === newSelections.length) {
                        for (var i = 0; i < oldSelections.length; i++) {
                            var oldItem = oldSelections[i];
                            var newItem = newSelections[i];
                            if (oldItem.row !== newItem.row || oldItem.col !== newItem.col ||
                                getRowCount(oldItem) !== getRowCount(newItem) || getColCount(oldItem) !== getColCount(newItem)) {
                                notEqual = true;
                                break;
                            } else {
                                notEqual = false;
                            }
                        }
                    }
                    return notEqual;
                };
                // 创建焦点持有者
                _SheetEventHandler.prototype._createFocusHolder = function (cellType, row, col, changeFocusHolder) {
                    var self = this;
                    var sheet = self._sheet;
                    var context = {
                        sheet: sheet,
                        row: row,
                        col: col,
                        sheetArea: 3
                    };
                    var host = sheet._getHost();
                    var isImeAware = cellType.isImeAware(context);
                    var focusHolder;
                    var focusHolderPosition = IS_MOBILE_DEVICE ? cssAbsolute : 'fixed';
                    if (changeFocusHolder) {
                        // 销毁原来的焦点持有者
                        self._destroyFocusHolder();
                    }
                    if (isImeAware && !self._cellTypeFocusHolder) {
                        focusHolder = cellType._createCellTypeElement(context);
                        if (!focusHolder) {
                            return
                        }
                        var focusHolderStyle = focusHolder.style;
                        if (!self._focusHolderOldCss) {
                            self._focusHolderOldCss = {
                                overflow: cssVisible,
                                border: cssNone,
                                position: cssAbsolute
                            };
                        }
                        self._focusHolderOldCss.overflow = focusHolderStyle.overflow;
                        self._focusHolderOldCss.border = focusHolderStyle.border;
                        self._focusHolderOldCss.position = focusHolderStyle.position;
                        domUtil_1.GC$(focusHolder).css(
                            [cssPosition, cssOverflow, cssTop, cssLeft, cssWidth, cssHeight, cssBorder],
                            [focusHolderPosition, cssHidden, '0px', '0px', '0px', '0px', cssNone]
                        );
                        if (sheet._setEditorValue && focusHolder.firstChild) {
                            var editorContext = focusHolder.firstChild.firstChild;
                            sheet._setEditorValue(cellType, editorContext, row, col, sheet.getActualStyle(row, col));
                            var value = cellType.getEditorValue(editorContext, context);
                            if (browser.safari && (value === '' || isNullOrUndefined(value))) {
                                cellType.setEditorValue(editorContext, ' ', context);
                            }
                        }
                        if (host) {
                            host.insertBefore(focusHolder, keyword_null);
                        }
                        self._cellTypeFocusHolder = focusHolder;
                    }
                    if (!self._originalFocusHolder) {
                        focusHolder = createElement('div');
                        domUtil_1.GC$(focusHolder).css(
                            [cssPosition, cssOverflow, cssTop, cssLeft, cssWidth, cssHeight],
                            [focusHolderPosition, cssHidden, '0px', '0px', '0px', '0px']
                        );
                        self._originalFocusHolder = focusHolder;
                        var focusElem = createElement('textarea');
                        domUtil_1.GC$(focusElem).attr(attrGcUIElement, 'gcSheetFocusInput')
                            .attr(attrTabIndex, -1)
                            .css(
                                [cssPosition, cssOverflow, cssBorder, cssResize],
                                [cssAbsolute, cssHidden, cssNone, cssNone]
                            );
                        focusElem.value = ' ';
                        focusHolder.insertBefore(focusElem, keyword_null);
                        self._focusElem = focusElem;
                        var readonlyFocusElem = createElement('div');
                        domUtil_1.GC$(readonlyFocusElem)
                            .css(cssPosition, cssAbsolute)
                            .css(cssOverflow, cssHidden)
                            .attr(attrGcUIElement, 'gcSheetFocusInput')
                            .attr(attrTabIndex, -1);
                        focusHolder.insertBefore(readonlyFocusElem, keyword_null);
                        self._readonlyFocusElem = readonlyFocusElem;
                        if (host) {
                            host.insertBefore(focusHolder, keyword_null);
                        }
                    }
                    var inIframe = WINDOW.location !== WINDOW.parent.location;
                    var windowScrolled = WINDOW.scrollX > 0 || WINDOW.scrollY > 0;
                    if (IS_MOBILE_DEVICE || (browser.mozilla && inIframe) || windowScrolled) {
                        if (self._cellTypeFocusHolder) {
                            self._setVisibleLocation(sheet, self._cellTypeFocusHolder);
                        }
                        self._setVisibleLocation(sheet, self._originalFocusHolder);
                    }
                    if (isImeAware) {
                        return self._cellTypeFocusHolder;
                    }
                    return self._focusElem;
                };
                _SheetEventHandler.prototype._resetFocusHolder = function () {
                    var self = this;
                    if (self._cellTypeFocusHolder && self._focusHolderOldCss) {
                        domUtil_1.GC$(self._cellTypeFocusHolder).css(cssOverflow, self._focusHolderOldCss.overflow)
                            .css(cssBorder, self._focusHolderOldCss.border)
                            .css(cssPosition, self._focusHolderOldCss.position);
                    }
                };
                _SheetEventHandler.prototype._destroyFocusHolder = function () {
                    var self = this;
                    if (self._cellTypeFocusHolder) {
                        if (self._cellTypeFocusHolder.parentElement) {
                            self._cellTypeFocusHolder.parentElement.removeChild(self._cellTypeFocusHolder);
                        }
                        if (self._cellTypeFocusHolder.comboBox) {
                            self._cellTypeFocusHolder.comboBox = keyword_null;
                        }
                        self._cellTypeFocusHolder = keyword_null;
                    }
                };
                _SheetEventHandler.prototype._setFocus = function (doNotGetCellTypeFocus) {
                    if (!common_1._FocusHelper._isActiveElement(this._sheet)) {
                        this._setFocusCore(true, true, doNotGetCellTypeFocus);
                    }
                };
                _SheetEventHandler.prototype._setFocusToReadonlyFocusElem = function () {
                    var readonlyFocusElem = this._readonlyFocusElem;
                    if (readonlyFocusElem) {
                        readonlyFocusElem.focus();
                    }
                };
                // 改变焦点的持有者
                _SheetEventHandler.prototype._changeFocusHolder = function () {
                    this._setFocusCore(true, true);
                };
                _SheetEventHandler.prototype._clearTouchSetFocusTimeout = function () {
                    if (this._touchSetFocusTimeout) {
                        clearTimeout(this._touchSetFocusTimeout);
                        this._touchSetFocusTimeout = keyword_null;
                    }
                };
                _SheetEventHandler.prototype._setFocusCore = function (delay, changeFocusHolder, doNotGetCellTypeFocus) {
                    if (arguments.length === 0) {
                        delay = true;
                    }
                    var self = this;
                    if (self._focusSuspended) {
                        return;
                    }
                    self._focusReleased = false;
                    self._clearTouchSetFocusTimeout();
                    var sheet = self._sheet;
                    var activeRow, activeCol;
                    activeRow = getActiveRowIndex(sheet);
                    activeCol = getActiveColumnIndex(sheet);
                    var ct = sheet.getCellType(activeRow, activeCol);
                    self._createFocusHolder(ct, activeRow, activeCol, changeFocusHolder);
                    var context = {
                        sheet: sheet,
                        row: activeRow,
                        col: activeCol,
                        sheetArea: 3
                    };
                    var focusElement;
                    if (!self._cellTypeFocusHolder) {
                        return
                    }
                    if (ct.isImeAware(context) && self._cellTypeFocusHolder.firstChild) {
                        focusElement = self._cellTypeFocusHolder.firstChild.firstChild;
                    } else {
                        focusElement = self._focusElem;
                    }
                    var editor = focusElement;
                    if (changeFocusHolder && !browser.msie) {
                        ct.setImeMode(editor, sheet.getActualStyle(activeRow, activeCol).imeMode, context);
                    }
                    DOCUMENT.body.focus();
                    var setFocusAndIme = function () {
                        var setFocusToEditor = function () {
                            try {
                                if (ct.isImeAware(context)) {
                                    ct.focus(editor, context);
                                    ct.selectAll(editor, context);
                                } else {
                                    focusElement.focus();
                                    focusElement.select();
                                }
                            } catch (ex) { }
                        };
                        if (changeFocusHolder && browser.msie) {
                            ct.setImeMode(editor, sheet.getActualStyle(activeRow, activeCol).imeMode, context);
                        }
                        setFocusToEditor();
                    };
                    var device = util_device;
                    var isMobileDevice = browser.metroMode || device.ipad || device.iphone || device.android;
                    if ((sheet._isTouchMode || isMobileDevice) && (delay || !ct.isImeAware(context))) {
                        if (!isEditing(sheet) && isMobileDevice) {
                            if (changeFocusHolder) {
                                var editorContainer = self._cellTypeFocusHolder && self._cellTypeFocusHolder.firstChild && self._cellTypeFocusHolder.firstChild.firstChild;
                                ct.setImeMode(editorContainer, sheet.getActualStyle(activeRow, activeCol).imeMode, context);
                            }
                        } else {
                            self._touchSetFocusTimeout = WINDOW.setTimeout(function () {
                                if (self._isShapeTextEditorOpened(sheet)) {
                                    return;
                                }
                                self._clearTouchSetFocusTimeout();
                                if (isEditing(sheet)) {
                                    return;
                                }
                                if (sheet._enhanceIme !== false && !doNotGetCellTypeFocus) {
                                    setFocusAndIme();
                                }
                            }, 200);
                        }
                    } else if (sheet._enhanceIme !== false && !doNotGetCellTypeFocus && !self._isShapeTextEditorOpened(sheet)) {
                        setFocusAndIme();
                    }
                    if (!common_1._FocusHelper._isActiveElement(sheet) && !self._isShapeTextEditorOpened(sheet)) {
                        common_1._FocusHelper._setActiveElement(sheet);
                    }
                    if (!self._isClickFloatobjectOrShape(sheet)) {
                        self._updateValidationUI && self._updateValidationUI(sheet._activeRowIndex, sheet._activeColIndex);
                    }
                };
                _SheetEventHandler.prototype._setVisibleLocation = function (sheet, element) {
                    var top;
                    var left;
                    var activeRow = getActiveRowIndex(sheet);
                    var activeCol = getActiveColumnIndex(sheet);
                    var activeRowViewport = sheet._activeRowViewportIndex;
                    var activeColViewport = sheet._activeColViewportIndex;
                    var activeCellRect = sheet.getCellRect(activeRow, activeCol, activeRowViewport, activeColViewport);
                    var self = this;
                    var canvasOffset = sheet._getCanvasOffset();
                    var canvasPosition = self._getCanvasPosition();
                    var cellTypeFocusHolder = self._cellTypeFocusHolder;
                    var cellTypeFocusHolderTop = 0;
                    var cellTypeFocusHolderLeft = 0;
                    var cellTypeFocusHolderHeight = 0;
                    var cellTypeFocusHolderWidth = 0;
                    if (cellTypeFocusHolder) {
                        var $cellTypeFocusHolder = domUtil_1.GC$(cellTypeFocusHolder);
                        cellTypeFocusHolderTop = parseInt($cellTypeFocusHolder.css(cssTop), 10);
                        cellTypeFocusHolderLeft = parseInt($cellTypeFocusHolder.css(cssLeft), 10);
                        cellTypeFocusHolderHeight = parseInt($cellTypeFocusHolder.css(cssHeight), 10);
                        cellTypeFocusHolderWidth = parseInt($cellTypeFocusHolder.css(cssWidth), 10);
                    }
                    if (self._isInvalidRect(activeCellRect)) {
                        top = cellTypeFocusHolderTop;
                        left = cellTypeFocusHolderLeft;
                    } else {
                        top = activeCellRect.y + canvasPosition.top - 2;
                        left = activeCellRect.x + canvasPosition.left - 2;
                    }
                    var minTop = WINDOW.pageYOffset - canvasOffset.top + canvasPosition.top;
                    var maxTop = WINDOW.innerHeight + minTop - cellTypeFocusHolderHeight;
                    var minLeft = WINDOW.pageXOffset - canvasOffset.left + canvasPosition.left;
                    var maxLeft = WINDOW.innerWidth + minLeft - cellTypeFocusHolderWidth;
                    if (isNotANumber(top) || top < minTop || top > maxTop) {
                        top = minTop;
                    }
                    if (isNotANumber(left) || left < minLeft || left > maxLeft) {
                        left = minLeft;
                    }
                    domUtil_1.GC$(element).css(cssTop, top).css(cssLeft, left);
                };
                _SheetEventHandler.prototype._releaseFocus = function (target) {
                    var self = this;
                    self._clearTouchSetFocusTimeout();
                    if (isEditing(self._sheet) || (self._focusReleased && DOCUMENT.activeElement === self._readonlyFocusElem)) {
                        return;
                    }
                    var sheet = self._sheet;
                    var activeRow, activeCol;
                    if (target) {
                        activeRow = target.row;
                        activeCol = target.col;
                    } else {
                        activeRow = sheet._activeRowIndex;
                        activeCol = sheet._activeColIndex;
                    }
                    var ct = sheet.getCellType(activeRow, activeCol);
                    self._createFocusHolder(ct, activeRow, activeCol, false);
                    self._readonlyFocusElem.focus();
                    self._focusReleased = true;
                };
                _SheetEventHandler.prototype._resumeFocus = function (delay, ignoreSetFocus) {
                    var self = this;
                    if (self._focusReleased) {
                        self._focusReleased = false;
                        !ignoreSetFocus && self._setFocusCore(delay);
                    }
                };
                _SheetEventHandler.prototype._switchFocusForClipboard = function (value) {
                    var sheet = this._sheet;
                    var clipboardHelper = sheet._getClipboardHelper();
                    if (clipboardHelper) {
                        clipboardHelper._setClipboardData(value);
                        clipboardHelper._focus();
                        this._focusSuspended = true;
                        if (value) {
                            clipboardHelper._select();
                        }
                    }
                };
                _SheetEventHandler.prototype._switchBackFocusAfterClipboard = function () {
                    var self = this;
                    var clipboardHelper = self._sheet._getClipboardHelper();
                    if (clipboardHelper) {
                        clipboardHelper._setClipboardData('');
                    }
                    self._focusSuspended = false;
                    self._setFocusCore(true, false);
                };
                _SheetEventHandler.prototype._disposeFocusHolders = function () {
                    var self = this;
                    self._clearTouchSetFocusTimeout();
                    var focusHolder = self._cellTypeFocusHolder;
                    if (focusHolder) {
                        domUtil_1.GC$(focusHolder).remove();
                        self._cellTypeFocusHolder = keyword_undefined;
                    }
                    focusHolder = self._originalFocusHolder;
                    if (focusHolder) {
                        domUtil_1.GC$(focusHolder).remove();
                        self._focusElem = keyword_undefined;
                        self._originalFocusHolder = keyword_null;
                        self._readonlyFocusElem = keyword_null;
                    }
                };
                _SheetEventHandler.prototype._showTooltip = function (info, left, top, isAbsoluteDistanse) {
                    var workbook = this._sheet.parent;
                    if (workbook) {
                        workbook._showTooltip(StringHelper._escapeHtml(info), left, top, isAbsoluteDistanse);
                    }
                };
                _SheetEventHandler.prototype._refreshTooltip = function (info, left, top, isAbsoluteDistanse) {
                    var workbook = this._sheet.parent;
                    if (workbook) {
                        workbook._refreshTooltip(info, left, top, isAbsoluteDistanse);
                    }
                };
                _SheetEventHandler.prototype._removeTooltip = function () {
                    var workbook = this._sheet.parent;
                    if (workbook) {
                        workbook._removeTooltip();
                    }
                };
                _SheetEventHandler.prototype._setHoverCell = function (target) {
                    function isResizeInfoEqual(newResizeInfo, oldResizeInfo) {
                        var equal = false;
                        if (!newResizeInfo && !oldResizeInfo) {
                            equal = true;
                        } else if (newResizeInfo && oldResizeInfo) {
                            equal = newResizeInfo.action === oldResizeInfo.action &&
                                newResizeInfo.index === oldResizeInfo.index &&
                                newResizeInfo.sheetArea === oldResizeInfo.sheetArea;
                        }
                        return equal;
                    }
                    var self = this;
                    var sheet = self._sheet;
                    var oldHoverRow = sheet._hoverRow;
                    var oldHoverCol = sheet._hoverCol;
                    var current = sheet._currentTarget;
                    var hoveredCellChanged = false;
                    if (!current) {
                        hoveredCellChanged = true;
                    }
                    if (!hoveredCellChanged && !target) {
                        hoveredCellChanged = true;
                    }
                    if (!hoveredCellChanged) {
                        hoveredCellChanged = (target.col !== current.col ||
                            target.row !== current.row ||
                            getColViewportIndex(target) !== getColViewportIndex(current) ||
                            getRowViewportIndex(target) !== getRowViewportIndex(current) ||
                            getHitTestType(target) !== getHitTestType(current) || !isResizeInfoEqual(target.resizeInfo, current.resizeInfo));
                    }
                    sheet._currentTarget = target;
                    if (hoveredCellChanged) {
                        var statesManager = sheet._statesManager;
                        var isRowStateEnabled = statesManager && statesManager.isEnable(core_enum_1.StatesType.hover, true);
                        var isColumnStateEnabled = statesManager && statesManager.isEnable(core_enum_1.StatesType.hover, false);
                        if (current && !isNullOrUndefined(current.hitTestType)) {
                            sheet._hoverRow = null;
                            sheet._hoverCol = null;
                            sheet._modelManager.setCellState(oldHoverRow, oldHoverCol, core_enum_1.CellStatesType.hover, false, current.hitTestType);
                            if (isRowStateEnabled) {
                                sheet._repaintRow(oldHoverRow);
                            }
                            if (isColumnStateEnabled) {
                                sheet._repaintColumn(oldHoverCol);
                            }
                            if (!isRowStateEnabled && !isColumnStateEnabled) {
                                sheet._repaintChangeCellForCellState && sheet._repaintChangeCellForCellState(core_enum_1.CellStatesType.hover, oldHoverRow, oldHoverCol, current.hitTestType, current.rowViewportIndex, current.colViewportIndex);
                            }
                        }
                        if (target && !isNullOrUndefined(target.hitTestType)) {
                            sheet._hoverRow = target.row;
                            sheet._hoverCol = target.col;
                            if (!target.resizeInfo) {
                                sheet.parent._trigger('CellHover',
                                    {
                                        row: target.row,
                                        col: target.col,
                                        sheetArea: target.hitTestType,
                                        sheet,
                                    }
                                );
                                sheet._modelManager.setCellState(target.row, target.col, core_enum_1.CellStatesType.hover, true, target.hitTestType);
                                if (isRowStateEnabled) {
                                    sheet._repaintRow(target.row);
                                }
                                if (isColumnStateEnabled) {
                                    sheet._repaintColumn(target.col);
                                }
                                if (!isRowStateEnabled && !isColumnStateEnabled) {
                                    sheet._repaintChangeCellForCellState && sheet._repaintChangeCellForCellState(core_enum_1.CellStatesType.hover, target.row, target.col, target.hitTestType, target.rowViewportIndex, target.colViewportIndex);
                                }
                            }
                        }
                        sheet._hoverCell = true;
                        var render = sheet._render;
                        var isNeedRepaintSelection = refreshHoverCell(sheet, current, render);
                        var needRepaint = refreshHoverCell(sheet, target, render);
                        isNeedRepaintSelection = isNeedRepaintSelection || needRepaint;
                        sheet._hoverCell = false;
                        if (isNeedRepaintSelection) {
                            render._repaintSelection();
                        }
                    }
                };
                _SheetEventHandler.prototype._getAvailableActiveCell = function (row, col, isHorizontal) {
                    var range = this._skipSpanCell(row, col, isHorizontal);
                    return this._skipInvisibleCell(range);
                };
                _SheetEventHandler.prototype._skipSpanCell = function (row, col, isHorizontal) {
                    var spanCell = this._sheet._modelManager.getSpan(row, col);
                    var spanRowCount = getRowCount(spanCell);
                    var spanColCount = getColCount(spanCell);
                    if (spanRowCount === 1 && spanColCount === 1) {
                        return spanCell;
                    }
                    if ((isHorizontal && spanRowCount === 1) || (!isHorizontal && spanColCount === 1)) {
                        return spanCell;
                    }
                    if (isHorizontal) {
                        col++;
                    } else {
                        row++;
                    }
                    return this._skipSpanCell(row, col, isHorizontal);
                };
                _SheetEventHandler.prototype._skipInvisibleCell = function (range) {
                    var sheet = this._sheet;
                    var row = range.row, i;
                    var rowCount = getSheetRowCount(sheet);
                    for (i = row; i < rowCount; i++) {
                        if (sheet.getRowVisible(i) === true) {
                            break;
                        }
                    }
                    if (i < rowCount) {
                        row = i;
                    }
                    var col = range.col;
                    var columnCount = getSheetColumnCount(sheet);
                    for (i = col; i < columnCount; i++) {
                        if (sheet.getColumnVisible(i) === true) {
                            break;
                        }
                    }
                    if (i < columnCount) {
                        col = i;
                    }
                    return createRange(row, col, getRowCount(range), getColCount(range));
                };
                _SheetEventHandler.prototype._isClickFloatobjectOrShape = function (sheet) {
                    var floatobjects = sheet.floatingObjects && sheet.floatingObjects.all();
                    var shapes = sheet.shapes && sheet.shapes.all();
                    if (!isNullOrUndefined(floatobjects)) {
                        for (var i = 0; i < floatobjects.length; i++) {
                            if (floatobjects[i].isSelected()) {
                                return true;
                            }
                        }
                    }
                    if (!isNullOrUndefined(shapes)) {
                        for (var j = 0; j < shapes.length; j++) {
                            if (shapes[j].isSelected()) {
                                return true;
                            }
                        }
                    }
                };
                _SheetEventHandler.prototype._isShapeTextEditorOpened = function (sheet) {
                    return typeof sheet.isShapeTextEditorOpened === 'function' && sheet.isShapeTextEditorOpened();
                };
                return _SheetEventHandler;
            }());
            exports._SheetEventHandler = _SheetEventHandler;

            worksheet_1.Worksheet._registerFeature('eventHandler', {
                beforeSetHost: function () {
                    var self = this;
                    self._eventHandler = new _SheetEventHandler(self);
                },
                dispose: function (argus) {
                    var self = this;
                    var eventHandler = self._eventHandler;
                    if (eventHandler) {
                        eventHandler._unhandleDocumentMouseMove();
                        var randomId = eventHandler._eventId;
                        domUtil_1.GC$(self._getCanvas())
                            .unbind(MOUSEDOWN_EVENT + '.' + randomId)
                            .unbind(MOUSEUP_EVENT + '.' + randomId)
                            .unbind(MOUSEMOVE_EVENT + '.' + randomId)
                            .unbind(MOUSEWHEEL_EVENT + '.' + randomId)
                            .unbind(MOUSEOUT_EVENT + '.' + randomId)
                            .unbind(DBLCLICK_EVENT + '.' + randomId);
                        if (browser.mozilla) {
                            var eventName = 'onwheel' in document ? WHEEL_EVENT : DOMMOUSESCROLL_EVENT;
                            domUtil_1.GC$(self._getCanvas())
                                .unbind(eventName + '.' + randomId);
                        }
                        eventHandler._dispose();
                        eventHandler._disposeFocusHolders();
                    }
                    var editor = self._editor;
                    if (editor) {
                        domUtil_1.GC$(editor).remove();
                    }
                    var smartTag = self._fillDialog;
                    if (smartTag) {
                        smartTag.close();
                        self._fillDialog = null;
                    }
                    if (argus.clearCache !== false) {
                        self._mouseDownDelegate = keyword_null;
                        self._mouseMoveDelegate = keyword_null;
                        self._mouseUpDelegate = keyword_null;
                        self._mouseWheelDelegate = keyword_null;
                        self._mouseOutDelegate = keyword_null;
                        self._dblClickDelegate = keyword_null;
                        self._eventHandler = keyword_null;
                    }
                },
                setHost: function (host) {
                    if (!host) {
                        return;
                    }
                    var self = this;
                    var eventHandler = self._eventHandler;
                    self._mouseDownDelegate = function (event) {
                        var argObj = {
                            e: event,
                            r: keyword_null
                        };
                        worksheet_1.Worksheet._callFeatureHandler(self, 'preProcessMouseDown', argObj);
                        self.parent._trigger('spreadMouseDown', domUtil_1.GC$.extend({
                            source: 'sheet'
                        }, argObj));
                        if (argObj.r) {
                            return;
                        }
                        return eventHandler._doMouseDown(event);
                    };
                    self._mouseMoveDelegate = function (event) {
                        var argObj = {
                            e: event,
                            r: keyword_null
                        };
                        worksheet_1.Worksheet._callFeatureHandler(self, 'preProcessMouseMove', argObj);
                        if (argObj.r) {
                            return;
                        }
                        if (eventHandler._isMouseCapture) {
                            return;
                        }
                        eventHandler._doMouseMove(event);
                    };
                    self._mouseUpDelegate = function (event) {
                        var argObj = {
                            e: event,
                            r: keyword_null
                        };
                        worksheet_1.Worksheet._callFeatureHandler(self, 'preProcessMouseUp', argObj);
                        if (argObj.r) {
                            return;
                        }
                        if (!self._continueMouseUpBubble) {
                            if (eventHandler._isMouseCapture) {
                                return;
                            }
                            return eventHandler._doMouseUp(event);
                        }
                    };
                    self._mouseWheelDelegate = function (event) {
                        event = event || WINDOW.event;
                        var argObj = {
                            e: event,
                            r: keyword_null
                        };
                        worksheet_1.Worksheet._callFeatureHandler(self, 'preProcessMouseWheel', argObj);
                        if (argObj.r) {
                            return;
                        }
                        var workbook = self.parent;
                        var scrollByPixel = workbook && workbook.options.scrollByPixel;
                        var detailY = event.detail ? event.detail : event.wheelDelta / -40, detailX = 0;
                        if (event.type === 'wheel') {
                            var FIREFOX_MOUSEWHEEL_RATIO = 51 / 3;
                            var ratio = browser.mozilla && +(browser.version) >= 88 ? FIREFOX_MOUSEWHEEL_RATIO : 1;
                            detailY = event.deltaY / ratio;
                            detailX = event.deltaX / ratio;
                            if (!scrollByPixel) {
                                if (Math_abs(detailY) >= Math_abs(detailX)) {
                                    detailX = 0;
                                } else {
                                    detailY = 0;
                                }
                            }
                        } else {
                            var currentMouseWheel = new Date().valueOf();
                            var wheelDeltaY = event.wheelDeltaY;
                            var wheelDeltaX = event.wheelDeltaX;
                            if (!scrollByPixel) {
                                if (Math_abs(wheelDeltaY) >= Math_abs(wheelDeltaX)) {
                                    wheelDeltaX = 0;
                                } else {
                                    wheelDeltaY = 0;
                                }
                            }
                            var isFirstTime = !self._lastMouseWheel || currentMouseWheel - self._lastMouseWheel > 200;
                            if (browser.safari || browser.chrome) {
                                var ratio = browser.safari ? -4 : -40;
                                if (!isNullOrUndefined(wheelDeltaY)) {
                                    if (isFirstTime) {
                                        detailY = wheelDeltaY / ratio;
                                        detailY = (detailY >= 0 ? 1 : -1) * Math_floor(Math_abs(detailY));
                                        self._remainedDetailY = 0;
                                    } else {
                                        detailY = wheelDeltaY / ratio;
                                        self._remainedDetailY += detailY;
                                        detailY = (detailY >= 0 ? 1 : -1) * Math_floor(Math_abs(self._remainedDetailY));
                                        self._remainedDetailY -= detailY;
                                    }
                                }
                                if (!isNullOrUndefined(wheelDeltaX)) {
                                    if (isFirstTime) {
                                        detailX = wheelDeltaX / ratio;
                                        detailX = (detailX >= 0 ? 1 : -1) * Math_floor(Math_abs(detailX));
                                        self._remainedDetailX = 0;
                                    } else {
                                        detailX = wheelDeltaX / ratio;
                                        self._remainedDetailX += detailX;
                                        detailX = (detailX >= 0 ? 1 : -1) * Math_floor(Math_abs(self._remainedDetailX));
                                        self._remainedDetailX -= detailX;
                                    }
                                }
                            }
                            self._lastMouseWheel = currentMouseWheel;
                        }
                        if (detailY === 0 && detailX === 0) {
                            return false;
                        }
                        var ret = self.parent._scrollService._doMouseWheel(self, event, convertToInt(detailY, 10) || 0, convertToInt(detailX, 10) || 0);
                        workbook._removeTooltip();
                        if (!ret) {
                            return false;
                        }
                    };
                    self._mouseOutDelegate = function (event) {
                        var argObj = {
                            e: event,
                            r: keyword_null
                        };
                        worksheet_1.Worksheet._callFeatureHandler(self, 'preProcessMouseOut', argObj);
                        if (argObj.r) {
                            return;
                        }
                        return eventHandler._doMouseOut(event);
                    };
                    function doDblClickViewport(handler, event) {
                        var t = self._getCanvasOffset();
                        var x = event.pageX - t.left;
                        var y = event.pageY - t.top;
                        var target = self.hitTest(x, y);
                        var dragInfo = target.dragInfo;
                        if (target.tableSelectInfo) {
                            return;
                        }
                        if (dragInfo && handler._doDoubleClickFill && dragInfo.side === 'corner') {
                            handler._doDoubleClickFill();
                        } else {
                            handler._startEdit(event, x, y);
                        }
                    }
                    self._dblClickDelegate = function (event) {
                        var argObj = {
                            e: event,
                            r: keyword_null
                        };
                        worksheet_1.Worksheet._callFeatureHandler(self, 'preProcessMouseDbClick', argObj);
                        if (argObj.r) {
                            return;
                        }
                        var currentTarget = self._currentTarget;
                        if (currentTarget) {
                            var ret = false;
                            if (getHitTestType(currentTarget) === 3) {
                                doDblClickViewport(eventHandler, event);
                            } else {
                                ret = doDblClickHeader(eventHandler, currentTarget);
                            }
                            if (!ret) {
                                self._trigger(
                                    common_1.Events.CellDoubleClick,
                                    createEventArg(
                                        self, self.name(),
                                        currentTarget.row,
                                        currentTarget.col,
                                        getHitTestType(currentTarget)
                                    )
                                );
                            }
                        }
                        function doDblClickHeader(handler, target) {
                            var sheet = handler._sheet;
                            var resizeInfo = target.resizeInfo;
                            if (resizeInfo) {
                                if (resizeInfo.action === SIZEROW || resizeInfo.action === SIZEHIDDENROW) {
                                    var rowList_2 = [];
                                    if (sheet._isRowSelected(resizeInfo.index)) {
                                        $_each(sheet._modelManager.getSelections(), function (i, p) {
                                            if (p.col === -1) {
                                                var selectedRange = sheet._getActualRange(p);
                                                for (var r = 0; r < getRowCount(selectedRange); r++) {
                                                    rowList_2.push({
                                                        row: selectedRange.row + r
                                                    });
                                                }
                                            }
                                        });
                                    } else {
                                        rowList_2.push({
                                            row: resizeInfo.index
                                        });
                                    }
                                    sheet._commandManager().execute({
                                        cmd: 'autoFitRow',
                                        sheetName: sheet.name(),
                                        rows: rowList_2,
                                        columnHeader: resizeInfo.sheetArea === 1
                                    });
                                } else {
                                    var columnList_2 = [];
                                    if (sheet._isColumnSelected(resizeInfo.index)) {
                                        $_each(sheet._modelManager.getSelections(), function (i, p) {
                                            if (p.row === -1) {
                                                var selectedRange = sheet._getActualRange(p);
                                                for (var c = 0; c < getColCount(selectedRange); c++) {
                                                    columnList_2.push({
                                                        col: selectedRange.col + c
                                                    });
                                                }
                                            }
                                        });
                                    } else {
                                        columnList_2.push({
                                            col: resizeInfo.index
                                        });
                                    }
                                    sheet._commandManager().execute({
                                        cmd: 'autoFitColumn',
                                        sheetName: sheet.name(),
                                        columns: columnList_2,
                                        rowHeader: resizeInfo.sheetArea === 2
                                    });
                                }
                                return true;
                            }
                            return false;
                        }
                    };
                    var randomId = eventHandler._eventId;
                    // 在canvas上绑定一些事件
                    host
                        // mousedown
                        .bind(MOUSEDOWN_EVENT + '.' + randomId, function (e) {
                            return self._mouseDownDelegate(e);
                        })
                        // mouseup
                        .bind(MOUSEUP_EVENT + '.' + randomId, function (e) {
                            return self._mouseUpDelegate(e);
                        })
                        // mousemove
                        .bind(MOUSEMOVE_EVENT + '.' + randomId, function (e) {
                            return self._mouseMoveDelegate(e);
                        })
                        // mousewheel
                        .bind(MOUSEWHEEL_EVENT + '.' + randomId, function (e) {
                            return self._mouseWheelDelegate(e);
                        })
                        // mouseout
                        .bind(MOUSEOUT_EVENT + '.' + randomId, function (e) {
                            return self._mouseOutDelegate(e);
                        })
                        // dblclick
                        .bind(DBLCLICK_EVENT + '.' + randomId, function (e) {
                            return self._dblClickDelegate(e);
                        });
                    if (browser.mozilla) {
                        var eventName = 'onwheel' in document ? WHEEL_EVENT : DOMMOUSESCROLL_EVENT;
                        host.bind(eventName + '.' + randomId, function (e) {
                            return self._mouseWheelDelegate(e);
                        });
                    }
                }
            });
        }),
        './dist/core/worksheet/worksheet-formatter.js': (function (module, exports, __webpack_require__) {
            Object.defineProperty(exports, '__esModule', { value: true });
            var domUtil_1 = __webpack_require__(/*! ../util/domUtil */ './dist/core/util/domUtil.js');
            var worksheet_1 = __webpack_require__(/*! ./worksheet */ './dist/core/worksheet/worksheet.js');
            var style_1 = __webpack_require__(/*! ./style */ './dist/core/worksheet/style.js');
            var common_1 = __webpack_require__(/*! ../util/common */ './dist/core/util/common.js');
            var Common_1 = __webpack_require__(/*! Common */ 'Common');
            domUtil_1.GC$.extend(worksheet_1.Worksheet.prototype, {
                getFormatter: function (row, col, sheetArea) {
                    return this._getStyleProperty(row, col, 'formatter', sheetArea);
                },
                setFormatter: function (row, col, value, sheetArea) {
                    var style = this._getStyleImp(row, col, sheetArea);
                    if (!style) {
                        style = new style_1.Style();
                    }
                    style.formatter = value;
                    this.setStyle(row, col, style, sheetArea);
                }
            });
            worksheet_1.Worksheet._registerFeature('formatter', {
                settingText: function (arg) {
                    var isNumber = common_1.util._isStringNumber(arg.value);
                    var GeneralFormatter = Common_1.Formatter && Common_1.Formatter.GeneralFormatter;
                    if (GeneralFormatter && isNumber) {
                        var aValRef = {};
                        new GeneralFormatter().getPreferredDisplayFormatter(arg.value, aValRef);
                        if (typeof aValRef.value === 'number') {
                            arg.value = aValRef.value;
                        }
                    }
                }
            });
        }),
        './dist/core/worksheet/worksheet-json.js': (function (module, exports, __webpack_require__) {
            Object.defineProperty(exports, '__esModule', { value: true });
            var Common_1 = __webpack_require__(/*! Common */ 'Common');
            var worksheet_1 = __webpack_require__(/*! ./worksheet */ './dist/core/worksheet/worksheet.js');
            var style_1 = __webpack_require__(/*! ./style */ './dist/core/worksheet/style.js');
            var ensureStyleParentName = style_1.Style._ensureParentName;
            var common_1 = __webpack_require__(/*! ../util/common */ './dist/core/util/common.js');
            var theme_1 = __webpack_require__(/*! ../util/theme */ './dist/core/util/theme.js');
            var domUtil_1 = __webpack_require__(/*! ../util/domUtil */ './dist/core/util/domUtil.js');
            var stylehelper_1 = __webpack_require__(/*! ./stylehelper */ './dist/core/worksheet/stylehelper.js');
            var core_enum_1 = __webpack_require__(/*! ../core.enum */ './dist/core/core.enum.js');
            var CalcEngine = __webpack_require__(/*! CalcEngine */ 'CalcEngine');
            var _supportsCalc = !!CalcEngine;
            var CultureManager = Common_1.Common.CultureManager;
            var Worksheet_features = worksheet_1.Worksheet._features;
            var isDefined = common_1.util._isDefined;
            var $_each = domUtil_1.GC$.each;
            var $_isEmptyObject = domUtil_1.GC$.isEmptyObject;
            var hasOwnProperty = Common_1.Common._hasOwnProperty;
            var isNullOrUndefined = Common_1.Common._Types._isNullOrUndefined;
            var const_string = 'string';
            var convertToInt = parseInt;
            var isNotANumber = isNaN;
            var keyword_undefined = void 0;
            function _copyDataTableNodeFormula(from, to, r, c) {
                if (from.dataTable) {
                    if (!to.dataTable) {
                        to.dataTable = {};
                    }
                    var rowData = from.dataTable[r];
                    if (rowData) {
                        if (!to.dataTable[r]) {
                            to.dataTable[r] = {};
                        }
                        var cellData = rowData[c];
                        if (!cellData) {
                            return;
                        }
                        if (!to.dataTable[r][c]) {
                            to.dataTable[r][c] = {};
                        }
                        if (cellData.formula) {
                            to.dataTable[r][c].formula = cellData.formula;
                        }
                    }
                }
            }
            function _moveFrozenRowsAsColumnHeaders(sheet, sheetSettings, rowShift, columnShift) {
                var modelManager = sheet._modelManager;
                var sheetModel = modelManager._getSheetModel();
                var columnHeaderModel = modelManager._getSheetModel(core_enum_1.SheetArea.colHeader);
                var rowInfos = modelManager._getAxisModel(true);
                var columnHeaderRowInfos = modelManager._getAxisModel(true, core_enum_1.SheetArea.colHeader);
                var sheetSpanModel = modelManager._getSpanModel();
                var colHeaderSpanModel = modelManager._getSpanModel(core_enum_1.SheetArea.colHeader);
                var colCount = sheetModel.getColumnCount();
                if (isNullOrUndefined(sheetSettings.colHeaderData)) {
                    sheetSettings.colHeaderData = {};
                }
                columnHeaderModel.setRowCount(rowShift);
                for (var r = 0; r < rowShift; r++) {
                    columnHeaderModel.setNode(r, -1, sheetModel._getNode(r, -1));
                    columnHeaderRowInfos._setItem(r, rowInfos._getItem(r));
                    for (var c = columnShift; c < colCount; c++) {
                        columnHeaderModel.setNode(r, c, sheetModel._getNode(r, c));
                        _copyDataTableNodeFormula(sheetSettings.data, sheetSettings.colHeaderData, r, c);
                    }
                }
                var spans = sheetSpanModel.getSpans(common_1._createRange(0, 0, rowShift, colCount));
                spans.forEach(function (span) {
                    colHeaderSpanModel.add(span);
                });
                sheet.frozenRowCount(0);
            }
            function _moveFrozenColumnsAsRowHeaders(sheet, sheetSettings, columnShift, rowShift) {
                var modelManager = sheet._modelManager;
                var sheetModel = modelManager._getSheetModel();
                var rowHeaderModel = modelManager._getSheetModel(core_enum_1.SheetArea.rowHeader);
                var columnInfos = modelManager._getAxisModel(false);
                var rowHeaderColInfos = modelManager._getAxisModel(false, core_enum_1.SheetArea.rowHeader);
                var sheetSpanModel = modelManager._getSpanModel();
                var rowHeaderSpanModel = modelManager._getSpanModel(core_enum_1.SheetArea.rowHeader);
                var rowCount = sheetModel.getRowCount();
                if (isNullOrUndefined(sheetSettings.rowHeaderData)) {
                    sheetSettings.rowHeaderData = {};
                }
                rowHeaderModel.setColumnCount(columnShift);
                for (var c = 0; c < columnShift; c++) {
                    rowHeaderModel.setNode(-1, c, sheetModel._getNode(-1, c));
                    rowHeaderColInfos._setItem(c, columnInfos._getItem(c));
                    for (var r = rowShift; r < rowCount; r++) {
                        rowHeaderModel.setNode(r, c, sheetModel._getNode(r, c));
                        _copyDataTableNodeFormula(sheetSettings.data, sheetSettings.rowHeaderData, r, c);
                    }
                }
                var spans = sheetSpanModel.getSpans(common_1._createRange(0, 0, rowCount, columnShift));
                spans.forEach(function (span) {
                    rowHeaderSpanModel.add(span);
                });
                sheet.frozenColumnCount(0);
            }
            function _isDefaultValue(propertyName, value) {
                switch (propertyName) {
                    case 'frozenRowCount':
                    case 'frozenColCount':
                    case 'frozenTrailingRowCount':
                    case 'frozenTrailingColCount':
                    case 'activeRow':
                    case 'activeCol':
                        return value === 0;
                    case 'rowCount':
                        return value === 200;
                    case 'columnCount':
                        return value === 20;
                    case 'zoomFactor':
                    case 'rowHeaderColCount':
                    case 'colHeaderRowCount':
                        return value === 1;
                    case 'visible':
                        return value === true;
                }
                return false;
            }
            function getDefinedValue(value, defaultValue) {
                return isDefined(value) ? value : defaultValue;
            }
            function setFnIfDefined(sheet, fn, value) {
                if (isDefined(value)) {
                    fn.call(sheet, value, false);
                }
            }
            function callFeaturesFromJSON(sheet, sheetSettings, noSchema, deserializationOptions, setFormulaDirectly, fromWorkbook) {
                if (Worksheet_features) {
                    $_each(Worksheet_features, function (n, f) {
                        var temp = f.fromJson;
                        if (temp) {
                            temp.call(sheet, sheetSettings, noSchema, deserializationOptions, isDefined(setFormulaDirectly) ? setFormulaDirectly : true, fromWorkbook);
                        }
                    });
                }
            }
            function setDynamicArrayArrayInfo(sheet, dataTable) {
                var anchors = sheet._modelManager._dynamicArrayManager.anchors;
                for (var rowKey in anchors) {
                    var row = +rowKey;
                    var rowItem = anchors[rowKey];
                    var rowNode = dataTable[row];
                    if (rowItem && rowNode) {
                        for (var colKey in rowItem) {
                            var col = +colKey;
                            var item = rowItem[colKey];
                            if (item) {
                                var node = rowNode[col];
                                if (node) {
                                    var arrayInfo = {
                                        row: item.row,
                                        rowCount: item.rowCount,
                                        col: item.col,
                                        colCount: item.colCount,
                                        isDynamicArray: true
                                    };
                                    if (!item.isValid) {
                                        arrayInfo.isInvalid = true;
                                    }
                                    node.arrayInfo = arrayInfo;
                                }
                            }
                        }
                    }
                }
            }
            domUtil_1.GC$.extend(worksheet_1.Worksheet.prototype, {
                _setValueToDataTable: function (dataTable, row, col, value) {
                    if (!dataTable[row]) {
                        dataTable[row] = {};
                    }
                    var rowNode = dataTable[row];
                    if (!rowNode[col]) {
                        rowNode[col] = {};
                    }
                    var node = rowNode[col];
                    node.value = value;
                },
                _moveColumnHeadersAsFrozenRows: function (rowShift, columnShift) {
                    var sheet = this;
                    var modelManager = sheet._modelManager;
                    var sheetModel = modelManager._getSheetModel();
                    var columnHeaderModel = modelManager._getSheetModel(core_enum_1.SheetArea.colHeader);
                    var rowInfos = modelManager._getAxisModel(true);
                    var columnHeaderRowInfos = modelManager._getAxisModel(true, core_enum_1.SheetArea.colHeader);
                    var sheetSpanModel = modelManager._getSpanModel();
                    var colHeaderSpanModel = modelManager._getSpanModel(core_enum_1.SheetArea.colHeader);
                    var rowFilter = sheet.rowFilter();
                    var colCount = sheetModel.getColumnCount();
                    for (var r = 0; r < rowShift; r++) {
                        sheetModel.setNode(r, -1, columnHeaderModel._getNode(r, -1));
                        rowInfos._setItem(r, columnHeaderRowInfos._getItem(r));
                        for (var c = columnShift; c < colCount; c++) {
                            var cellNode = columnHeaderModel._getNode(r, c);
                            if (!cellNode) {
                                cellNode = {};
                            }
                            cellNode.style = sheet.getActualStyle(r, c, core_enum_1.SheetArea.colHeader);
                            sheetModel.setNode(r, c, cellNode);
                            var formula = sheet.getFormula(r, c, core_enum_1.SheetArea.colHeader);
                            if (formula) {
                                sheet.setFormula(r, c, formula, core_enum_1.SheetArea.viewport);
                            }
                        }
                    }
                    colHeaderSpanModel.getSpans().forEach(function (span) {
                        sheetSpanModel.add(span);
                    });
                    if (rowFilter && rowFilter.range && rowFilter.range.row === -1) {
                        rowFilter._adjustRangeForFrozen = true;
                    }
                    sheet.frozenRowCount(rowShift);
                    modelManager._resetSheetModel(worksheet_1.Worksheet._defaultColHeaderRowCount, colCount, core_enum_1.SheetArea.colHeader);
                    modelManager._resetAxisModel(false, core_enum_1.SheetArea.colHeader);
                    modelManager._resetSpanModel(core_enum_1.SheetArea.colHeader);
                    sheet._getCalcModel(core_enum_1.SheetArea.colHeader).clearAll();
                },
                _moveRowHeadersAsFrozenColumns: function (columnShift, rowShift) {
                    var sheet = this;
                    var modelManager = sheet._modelManager;
                    var sheetModel = modelManager._getSheetModel();
                    var rowHeaderModel = modelManager._getSheetModel(core_enum_1.SheetArea.rowHeader);
                    var columnInfos = modelManager._getAxisModel(false);
                    var rowHeaderColInfos = modelManager._getAxisModel(false, core_enum_1.SheetArea.rowHeader);
                    var sheetSpanModel = modelManager._getSpanModel();
                    var rowHeaderSpanModel = modelManager._getSpanModel(core_enum_1.SheetArea.rowHeader);
                    var rowCount = sheetModel.getRowCount();
                    for (var c = 0; c < columnShift; c++) {
                        sheetModel.setNode(-1, c, rowHeaderModel._getNode(-1, c));
                        columnInfos._setItem(c, rowHeaderColInfos._getItem(c));
                        for (var r = rowShift; r < rowCount; r++) {
                            var cellNode = rowHeaderModel._getNode(r, c);
                            if (!cellNode) {
                                cellNode = {};
                            }
                            cellNode.style = sheet.getActualStyle(r, c, core_enum_1.SheetArea.rowHeader);
                            sheetModel.setNode(r, c, cellNode);
                            var formula = sheet.getFormula(r, c, core_enum_1.SheetArea.rowHeader);
                            if (formula) {
                                sheet.setFormula(r, c, formula, core_enum_1.SheetArea.viewport);
                            }
                        }
                    }
                    rowHeaderSpanModel.getSpans().forEach(function (span) {
                        sheetSpanModel.add(span);
                    });
                    sheet.frozenColumnCount(columnShift);
                    modelManager._resetSheetModel(rowCount, worksheet_1.Worksheet._defaultRowHeaderColumnCount, core_enum_1.SheetArea.rowHeader);
                    modelManager._resetAxisModel(false, core_enum_1.SheetArea.rowHeader);
                    modelManager._resetSpanModel(core_enum_1.SheetArea.rowHeader);
                    sheet._getCalcModel(core_enum_1.SheetArea.rowHeader).clearAll();
                },
                toJSON: function (serializationOption) {
                    var sheet = this;
                    var ignoreStyle = serializationOption && serializationOption.ignoreStyle;
                    if (serializationOption && !serializationOption._fromWorkbook) {
                        var rowShift = sheet.getRowCount(core_enum_1.SheetArea.colHeader);
                        var columnShift = sheet.getColumnCount(core_enum_1.SheetArea.rowHeader);
                        var rowHeadersAsFrozenColumns = serializationOption.rowHeadersAsFrozenColumns;
                        var columnHeadersAsFrozenRows = serializationOption.columnHeadersAsFrozenRows;
                        var colExpand = rowHeadersAsFrozenColumns && columnShift > 0;
                        var rowExpand = columnHeadersAsFrozenRows && rowShift > 0;
                        if (colExpand) {
                            sheet.addColumns(0, columnShift);
                        }
                        if (rowExpand) {
                            sheet.addRows(0, rowShift, rowExpand);
                        }
                        if (colExpand) {
                            sheet._moveRowHeadersAsFrozenColumns(columnShift, rowExpand ? rowShift : 0);
                        }
                        if (rowExpand) {
                            sheet._moveColumnHeadersAsFrozenRows(rowShift, colExpand ? columnShift : 0);
                        }
                    }
                    var rowCount = sheet.getRowCount();
                    var colCount = sheet.getColumnCount();
                    var colHeaderRowCount = sheet.getRowCount(core_enum_1.SheetArea.colHeader);
                    var rowHeaderColCount = sheet.getColumnCount(core_enum_1.SheetArea.rowHeader);
                    var dataDic = {
                        name: serializationOption && serializationOption.newWorkSheetName || sheet.name(),
                        isSelected: sheet._isSelectedImp(),
                        rowCount: rowCount,
                        columnCount: colCount,
                        activeRow: sheet._activeRowIndex,
                        activeCol: sheet._activeColIndex,
                        zoomFactor: sheet.zoom(),
                        rowHeaderColCount: rowHeaderColCount,
                        colHeaderRowCount: colHeaderRowCount,
                        visible: sheet.visible()
                    };
                    if (!ignoreStyle) {
                        dataDic.frozenRowCount = sheet.frozenRowCount();
                        dataDic.frozenColCount = sheet.frozenColumnCount();
                        dataDic.frozenTrailingRowCount = sheet.frozenTrailingRowCount();
                        dataDic.frozenTrailingColCount = sheet.frozenTrailingColumnCount();
                        dataDic.frozenTrailingRowStickToEdge = sheet._frozenTrailingRowStickToEdge;
                        dataDic.frozenTrailingColumnStickToEdge = sheet._frozenTrailingColumnStickToEdge;
                        dataDic.theme = sheet._currentTheme.toJSON();
                    }
                    var modelManager = sheet._modelManager;
                    var modelJson = modelManager.toJSON(serializationOption);
                    for (var prop in modelJson) {
                        dataDic[prop] = modelJson[prop];
                    }
                    if (Worksheet_features) {
                        $_each(Worksheet_features, function (n, f) {
                            if (f.toJson) {
                                f.toJson.call(sheet, dataDic, serializationOption);
                            }
                        });
                    }
                    var sdata = {};
                    for (var item in dataDic) {
                        if (hasOwnProperty(dataDic, item)) {
                            var value = dataDic[item];
                            if (!isNullOrUndefined(value) && !_isDefaultValue(item, value)) {
                                sdata[item] = value;
                            }
                        }
                    }
                    setDynamicArrayArrayInfo(sheet, dataDic.data.dataTable);
                    $_each(sheet.options, function (p, v) {
                        var tmpValue = v;
                        if (p === 'gridline') {
                            tmpValue = {};
                            var v_color = v.color;
                            var v_showHorizontalGridline = v.showHorizontalGridline;
                            var v_showVerticalGridline = v.showVerticalGridline;
                            if (v_color && v_color !== common_1._ThemeStyleHelper._getCssClassThemeStyle('gc-gridlineColor').borderTopColor) {
                                tmpValue.color = v_color;
                            }
                            if (v_showHorizontalGridline === false) {
                                tmpValue.showHorizontalGridline = v_showHorizontalGridline;
                            }
                            if (v_showVerticalGridline === false) {
                                tmpValue.showVerticalGridline = v_showVerticalGridline;
                            }
                        }
                        if (p === 'sheetAreaOffset') {
                            tmpValue = {};
                            if (v.left) {
                                tmpValue.left = v.left;
                            }
                            if (v.top) {
                                tmpValue.top = v.top;
                            }
                        }
                        if (p !== '_ps' && !isNullOrUndefined(tmpValue) && worksheet_1.Worksheet._defaultOptions[p] !== tmpValue) {
                            if (typeof tmpValue !== 'object' || !$_isEmptyObject(tmpValue)) {
                                sdata[p] = tmpValue;
                            }
                        }
                    });
                    var namedStyles = [];
                    var sheetNamedStyles = sheet._namedStyles;
                    if (sheetNamedStyles) {
                        for (var namedStyle in sheetNamedStyles) {
                            if (hasOwnProperty(sheetNamedStyles, namedStyle)) {
                                var style = sheetNamedStyles[namedStyle];
                                if (style) {
                                    var styleObj = style.toJSON();
                                    var styleFont = style.font;
                                    if (!$_isEmptyObject(styleObj)) {
                                        if (styleFont) {
                                            styleObj.font = stylehelper_1._StyleHelper._normalizeFont(styleFont);
                                        }
                                        namedStyles.push(styleObj);
                                    }
                                }
                            }
                        }
                        if (namedStyles.length > 0) {
                            sdata.namedStyles = namedStyles;
                        }
                    }
                    return sdata;
                },
                fromJSON: function (sheetSettings, setFormulaDirectly, versionInfo, deserializationOptions, fromWorkbook) {
                    var noSchema;
                    var version;
                    if (versionInfo) {
                        noSchema = versionInfo.noSchema;
                        version = versionInfo.version;
                    }
                    if (!sheetSettings) {
                        return;
                    }
                    var sheet = this;
                    var modelManager = sheet._modelManager;
                    var ignoreStyle = deserializationOptions && deserializationOptions.ignoreStyle;
                    sheet._initOptions();
                    worksheet_1.Worksheet._callFeatureHandler(sheet, 'preFromJson');
                    sheet.suspendPaint();
                    modelManager._suspendUpdateAxisInfoCache();
                    modelManager._disposeAxisInfoCache();
                    var oldCulture = CultureManager.culture();
                    CultureManager.culture('');
                    var rowCount = getDefinedValue(sheetSettings.rowCount, worksheet_1.Worksheet._defaultRowCount);
                    var columnCount = getDefinedValue(sheetSettings.columnCount, worksheet_1.Worksheet._defaultColCount);
                    try {
                        sheet._setNameCore(sheetSettings.name + '', true);
                        sheet._isSelectedImp(sheetSettings.isSelected);
                        sheet.setRowCount(rowCount);
                        sheet.setColumnCount(columnCount);
                        sheet._namedStyles = {};
                        var sheetSettings_namedStyles = sheetSettings.namedStyles;
                        if (sheetSettings_namedStyles) {
                            for (var i = 0; i < sheetSettings_namedStyles.length; i++) {
                                var item = sheetSettings_namedStyles[i];
                                var style = new style_1.Style();
                                ensureStyleParentName(item, sheet);
                                style.fromJSON(item, noSchema, sheet);
                                sheet._addNamedStyleImp(style);
                            }
                        }
                        var options = sheet.options;
                        for (var op in options) {
                            if (hasOwnProperty(options, op)) {
                                var value = sheetSettings[op];
                                if (op === 'protectionOptions') {
                                    value = value || sheetSettings.protectionOption;
                                } else if (op === 'allowCellOverflow') {
                                    if (!isDefined(sheetSettings[op])) {
                                        if (!version || version >= 11) {
                                            value = true;
                                        } else {
                                            value = false;
                                        }
                                    } else {
                                        value = sheetSettings[op];
                                    }
                                }
                                if (isDefined(value)) {
                                    if (typeof value === 'object') {
                                        for (var p in value) {
                                            if (hasOwnProperty(value, p)) {
                                                options[op][p] = value[p];
                                            }
                                        }
                                    } else if (op === 'borderWidth') {
                                        options.sheetAreaOffset.left = value;
                                        options.sheetAreaOffset.top = value;
                                    } else {
                                        options[op] = value;
                                    }
                                }
                            }
                        }
                        var activeRowIndex = getDefinedValue(sheetSettings.activeRow, sheet._activeRowIndex);
                        var activeColIndex = getDefinedValue(sheetSettings.activeCol, sheet._activeColIndex);
                        sheet._setActiveCellImp(activeRowIndex, activeColIndex, keyword_undefined, keyword_undefined, true);
                        if (!ignoreStyle) {
                            setFnIfDefined(sheet, sheet.frozenRowCount, sheetSettings.frozenRowCount);
                            setFnIfDefined(sheet, sheet.frozenColumnCount, sheetSettings.frozenColCount);
                            setFnIfDefined(sheet, sheet.frozenTrailingRowCount, sheetSettings.frozenTrailingRowCount);
                            setFnIfDefined(sheet, sheet.frozenTrailingColumnCount, sheetSettings.frozenTrailingColCount);
                            sheet._frozenTrailingRowStickToEdge = isDefined(sheetSettings.frozenTrailingRowStickToEdge) ? sheetSettings.frozenTrailingRowStickToEdge : true;
                            sheet._frozenTrailingColumnStickToEdge = isDefined(sheetSettings.frozenTrailingColumnStickToEdge) ? sheetSettings.frozenTrailingColumnStickToEdge : true;
                        }
                        if (!ignoreStyle) {
                            var sheetSettings_colStyles = sheetSettings.colStyles;
                            if (sheetSettings_colStyles) {
                                for (var t in sheetSettings_colStyles) {
                                    if (!isNotANumber(t)) {
                                        sheet.setStyle(-1, convertToInt(t, 10), sheetSettings_colStyles[t], core_enum_1.SheetArea.viewport);
                                    }
                                }
                            }
                            var sheetSettings_rowStyles = sheetSettings.rowStyles;
                            if (sheetSettings_rowStyles) {
                                for (var rs in sheetSettings_rowStyles) {
                                    if (!isNotANumber(rs)) {
                                        sheet.setStyle(convertToInt(rs, 10), -1, sheetSettings_rowStyles[rs], core_enum_1.SheetArea.viewport);
                                    }
                                }
                            }
                        }
                        var rowHeaderColCount = getDefinedValue(sheetSettings.rowHeaderColCount, worksheet_1.Worksheet._defaultRowHeaderColumnCount);
                        var colHeaderRowCount = getDefinedValue(sheetSettings.colHeaderRowCount, worksheet_1.Worksheet._defaultColHeaderRowCount);
                        sheet.setColumnCount(rowHeaderColCount, core_enum_1.SheetArea.rowHeader);
                        sheet.setRowCount(colHeaderRowCount, core_enum_1.SheetArea.colHeader);
                        sheet._zoomInternal(getDefinedValue(sheetSettings._zoomFactor || sheetSettings.zoomFactor, sheet.zoom()));
                        setFnIfDefined(sheet, sheet.visible, sheetSettings.visible);
                        var validations_1 = sheet._validations;
                        var modelImportOptions = {
                            sheet: sheet,
                            setValidator: function (row, col, validator) {
                                validations_1 && validations_1._importValidator(row, col, validator);
                            },
                            ignoreStyle: ignoreStyle
                        };
                        modelManager.fromJSON(sheetSettings, noSchema, modelImportOptions);
                        sheet.defaults = modelManager.defaults;
                        validations_1 && validations_1._resetCache(true);
                        var sheetSettings_theme = sheetSettings.theme;
                        if (sheetSettings_theme && !ignoreStyle) {
                            var st = sheetSettings_theme;
                            if (typeof st !== const_string && isDefined(st)) {
                                var themeColorWithUnderline = '_themeColor';
                                var nameWidthUnderline = '_name';
                                var tc = st.themeColor || st[themeColorWithUnderline];
                                var themeColor = new theme_1.ColorScheme(tc.name || tc[nameWidthUnderline]);
                                themeColor.fromJSON(tc, noSchema);
                                st = new theme_1.Theme(st.name || st._name, themeColor, st.headingFont || st._headingFont, st.bodyFont || st._bodyFont);
                            }
                            sheet.currentTheme(st);
                        }
                        callFeaturesFromJSON(sheet, sheetSettings, noSchema, deserializationOptions, setFormulaDirectly, fromWorkbook);
                        var frozenColumnsAsRowHeaders = deserializationOptions && deserializationOptions.frozenColumnsAsRowHeaders;
                        var frozenRowsAsColumnHeaders = deserializationOptions && deserializationOptions.frozenRowsAsColumnHeaders;
                        var rowShift = frozenRowsAsColumnHeaders ? (sheetSettings.frozenRowCount || 0) : 0;
                        var columnShift = frozenColumnsAsRowHeaders ? (sheetSettings.frozenColCount || 0) : 0;
                        if (frozenRowsAsColumnHeaders && rowShift > 0) {
                            _moveFrozenRowsAsColumnHeaders(sheet, sheetSettings, rowShift, columnShift);
                        }
                        if (frozenColumnsAsRowHeaders && columnShift > 0) {
                            _moveFrozenColumnsAsRowHeaders(sheet, sheetSettings, columnShift, rowShift);
                        }
                        if (_supportsCalc) {
                            var sheetSource = sheet._getSheetSource();
                            if (rowShift > 0) {
                                sheetSource._rowShift = rowShift;
                            }
                            if (columnShift > 0) {
                                sheetSource._columnShift = columnShift;
                            }
                        }
                        if (!fromWorkbook) {
                            if (rowShift > 0) {
                                sheet.deleteRows(0, rowShift);
                            }
                            if (columnShift > 0) {
                                sheet.deleteColumns(0, columnShift);
                            }
                        }
                        sheet.clearPendingChanges();
                    } finally {
                        CultureManager.culture(oldCulture);
                        modelManager._resumeUpdateAxisInfoCache();
                        sheet.resumePaint();
                    }
                },
                _fromJSONAsync: function (sheetSettings, setFormulaDirectly, versionInfo, deserializationOptions, fromWorkbook) {
                    var noSchema;
                    var version;
                    if (versionInfo) {
                        noSchema = versionInfo.noSchema;
                        version = versionInfo.version;
                    }
                    if (!sheetSettings) {
                        return;
                    }
                    var sheet = this;
                    var modelManager = sheet._modelManager;
                    var ignoreStyle = deserializationOptions.ignoreStyle;
                    sheet._initOptions();
                    worksheet_1.Worksheet._callFeatureHandler(sheet, 'preFromJson');
                    modelManager._suspendUpdateAxisInfoCache();
                    modelManager._disposeAxisInfoCache();
                    var oldCulture = CultureManager.culture();
                    CultureManager.culture('');
                    var rowCount = getDefinedValue(sheetSettings.rowCount, worksheet_1.Worksheet._defaultRowCount);
                    var columnCount = getDefinedValue(sheetSettings.columnCount, worksheet_1.Worksheet._defaultColCount);
                    try {
                        sheet._namedStyles = {};
                        var sheetSettings_namedStyles = sheetSettings.namedStyles;
                        if (sheetSettings_namedStyles) {
                            for (var i = 0; i < sheetSettings_namedStyles.length; i++) {
                                var item = sheetSettings_namedStyles[i];
                                var style = new style_1.Style();
                                ensureStyleParentName(item, sheet);
                                style.fromJSON(item, noSchema, sheet);
                                sheet._addNamedStyleImp(style);
                            }
                        }
                        var options = sheet.options;
                        for (var op in options) {
                            if (hasOwnProperty(options, op)) {
                                var value = sheetSettings[op];
                                if (op === 'protectionOptions') {
                                    value = value || sheetSettings.protectionOption;
                                } else if (op === 'allowCellOverflow') {
                                    if (!isDefined(sheetSettings[op])) {
                                        if (!version || version >= 11) {
                                            value = true;
                                        } else {
                                            value = false;
                                        }
                                    } else {
                                        value = sheetSettings[op];
                                    }
                                }
                                if (isDefined(value)) {
                                    if (typeof value === 'object') {
                                        for (var p in value) {
                                            if (hasOwnProperty(value, p)) {
                                                options[op][p] = value[p];
                                            }
                                        }
                                    } else if (op === 'borderWidth') {
                                        options.sheetAreaOffset.left = value;
                                        options.sheetAreaOffset.top = value;
                                    } else {
                                        options[op] = value;
                                    }
                                }
                            }
                        }
                        var activeRowIndex = getDefinedValue(sheetSettings.activeRow, sheet._activeRowIndex);
                        var activeColIndex = getDefinedValue(sheetSettings.activeCol, sheet._activeColIndex);
                        sheet._setActiveCellImp(activeRowIndex, activeColIndex, keyword_undefined, keyword_undefined, true);
                        if (!ignoreStyle) {
                            setFnIfDefined(sheet, sheet.frozenRowCount, sheetSettings.frozenRowCount);
                            setFnIfDefined(sheet, sheet.frozenColumnCount, sheetSettings.frozenColCount);
                            setFnIfDefined(sheet, sheet.frozenTrailingRowCount, sheetSettings.frozenTrailingRowCount);
                            setFnIfDefined(sheet, sheet.frozenTrailingColumnCount, sheetSettings.frozenTrailingColCount);
                            sheet._frozenTrailingRowStickToEdge = isDefined(sheetSettings.frozenTrailingRowStickToEdge) ? sheetSettings.frozenTrailingRowStickToEdge : true;
                            sheet._frozenTrailingColumnStickToEdge = isDefined(sheetSettings.frozenTrailingColumnStickToEdge) ? sheetSettings.frozenTrailingColumnStickToEdge : true;
                        }
                        if (!ignoreStyle) {
                            var sheetSettings_colStyles = sheetSettings.colStyles;
                            if (sheetSettings_colStyles) {
                                for (var t in sheetSettings_colStyles) {
                                    if (!isNotANumber(t)) {
                                        sheet.setStyle(-1, convertToInt(t, 10), sheetSettings_colStyles[t], core_enum_1.SheetArea.viewport);
                                    }
                                }
                            }
                            var sheetSettings_rowStyles = sheetSettings.rowStyles;
                            if (sheetSettings_rowStyles) {
                                for (var rs in sheetSettings_rowStyles) {
                                    if (!isNotANumber(rs)) {
                                        sheet.setStyle(convertToInt(rs, 10), -1, sheetSettings_rowStyles[rs], core_enum_1.SheetArea.viewport);
                                    }
                                }
                            }
                        }
                        var rowHeaderColCount = getDefinedValue(sheetSettings.rowHeaderColCount, worksheet_1.Worksheet._defaultRowHeaderColumnCount);
                        var colHeaderRowCount = getDefinedValue(sheetSettings.colHeaderRowCount, worksheet_1.Worksheet._defaultColHeaderRowCount);
                        sheet.setColumnCount(rowHeaderColCount, core_enum_1.SheetArea.rowHeader);
                        sheet.setRowCount(colHeaderRowCount, core_enum_1.SheetArea.colHeader);
                        sheet._zoomInternal(getDefinedValue(sheetSettings._zoomFactor || sheetSettings.zoomFactor, sheet.zoom()));
                        var validations_2 = sheet._validations;
                        var modelImportOptions = {
                            sheet: sheet,
                            setValidator: function (row, col, validator) {
                                validations_2 && validations_2._importValidator(row, col, validator);
                            },
                            ignoreStyle: ignoreStyle,
                            incrementalLoading: deserializationOptions.incrementalLoading,
                            incrementLoadTask: deserializationOptions.incrementLoadTask
                        };
                        modelManager.fromJSON(sheetSettings, noSchema, modelImportOptions, function () {
                            sheet.defaults = modelManager.defaults;
                            validations_2 && validations_2._resetCache(true);
                            var sheetSettings_theme = sheetSettings.theme;
                            if (sheetSettings_theme && !ignoreStyle) {
                                var st = sheetSettings_theme;
                                if (typeof st !== const_string && isDefined(st)) {
                                    var themeColorWithUnderline = '_themeColor', nameWidthUnderline = '_name';
                                    var tc = st.themeColor || st[themeColorWithUnderline];
                                    var themeColor = new theme_1.ColorScheme(tc.name || tc[nameWidthUnderline]);
                                    themeColor.fromJSON(tc, noSchema);
                                    st = new theme_1.Theme(st.name || st._name, themeColor, st.headingFont || st._headingFont, st.bodyFont || st._bodyFont);
                                }
                                sheet.currentTheme(st);
                            }
                            callFeaturesFromJSON(sheet, sheetSettings, noSchema, deserializationOptions, setFormulaDirectly, fromWorkbook);
                            var frozenColumnsAsRowHeaders = deserializationOptions && deserializationOptions.frozenColumnsAsRowHeaders;
                            var frozenRowsAsColumnHeaders = deserializationOptions && deserializationOptions.frozenRowsAsColumnHeaders;
                            var rowShift = frozenRowsAsColumnHeaders ? (sheetSettings.frozenRowCount || 0) : 0;
                            var columnShift = frozenColumnsAsRowHeaders ? (sheetSettings.frozenColCount || 0) : 0;
                            if (frozenRowsAsColumnHeaders && rowShift > 0) {
                                _moveFrozenRowsAsColumnHeaders(sheet, sheetSettings, rowShift, columnShift);
                            }
                            if (frozenColumnsAsRowHeaders && columnShift > 0) {
                                _moveFrozenColumnsAsRowHeaders(sheet, sheetSettings, columnShift, rowShift);
                            }
                            if (_supportsCalc) {
                                var sheetSource = sheet._getSheetSource();
                                if (rowShift > 0) {
                                    sheetSource._rowShift = rowShift;
                                }
                                if (columnShift > 0) {
                                    sheetSource._columnShift = columnShift;
                                }
                            }
                            if (!fromWorkbook) {
                                if (rowShift > 0) {
                                    sheet.deleteRows(0, rowShift);
                                }
                                if (columnShift > 0) {
                                    sheet.deleteColumns(0, columnShift);
                                }
                            }
                            sheet.clearPendingChanges();
                            CultureManager.culture(oldCulture);
                            modelManager._resumeUpdateAxisInfoCache();
                            sheet.loaded = true;
                        });
                    } finally { }
                }
            });
        }),
        './dist/core/worksheet/worksheet-model.js': (function (module, exports, __webpack_require__) {
            var __extends = (this && this.__extends) || (function () {
                var extendStatics = function (d, b) {
                    extendStatics = Object.setPrototypeOf ||
                        ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
                        function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };
                    return extendStatics(d, b);
                };
                return function (d, b) {
                    extendStatics(d, b);
                    function __() { this.constructor = d; }
                    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
                };
            })();
            var __rest = (this && this.__rest) || function (s, e) {
                var t = {};
                for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)
                    t[p] = s[p];
                if (s != null && typeof Object.getOwnPropertySymbols === 'function')
                    for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) if (e.indexOf(p[i]) < 0)
                        t[p[i]] = s[p[i]];
                return t;
            };
            Object.defineProperty(exports, '__esModule', { value: true });
            var core_ns_1 = __webpack_require__(/*! ../core.ns */ './dist/core/core.ns.js');
            var style_1 = __webpack_require__(/*! ./style */ './dist/core/worksheet/style.js');
            var Common_1 = __webpack_require__(/*! Common */ 'Common');
            var CalcEngine_1 = __webpack_require__(/*! CalcEngine */ 'CalcEngine');
            var common_1 = __webpack_require__(/*! ../util/common */ './dist/core/util/common.js');
            var util_common = __webpack_require__(/*! ../util/common */ './dist/core/util/common.js');
            var domUtil_1 = __webpack_require__(/*! ../util/domUtil */ './dist/core/util/domUtil.js');
            var core_enum_1 = __webpack_require__(/*! ../core.enum */ './dist/core/core.enum.js');
            var CalcEngine = __webpack_require__(/*! CalcEngine */ 'CalcEngine');
            var celltype_ns_1 = __webpack_require__(/*! ../celltype/celltype.ns */ './dist/core/celltype/celltype.ns.js');
            var _supportsCalc = !!CalcEngine;
            var $_each = domUtil_1.GC$.each, $_isEmptyObject = domUtil_1.GC$.isEmptyObject, $_extend = domUtil_1.GC$.extend;
            var starSizeReg = new RegExp('^\\d*(\\.\\d+)?\\*$');
            var keyword_null = null, keyword_undefined = void 0, const_string = 'string', Math_min = Math.min, Math_floor = Math.floor, Math_max = Math.max, Math_ceil = Math.ceil, UNDERSCORE_DIRTY_NODES = 'dirtyNodes', UNDO_TEXT = 'undo', ROW_INFOS_TEXT = 'rowInfos', COL_INFOS_TEXT = 'colInfos';
            var DEFAULT_SIZE = 'default_size';
            var addElements = Common_1.Common._addElements;
            var deleteElements = Common_1.Common._deleteElements;
            var isNullOrUndefined = Common_1.Common._Types._isNullOrUndefined;
            var convertRichTextValue = common_1.util._convertRichTextValue;
            var tryAddCacheToRichText = common_1.util._tryAddCacheToRichText;
            var isformatString = common_1.util._isFormatString;
            var cloneObj = Common_1.Common._Types._cloneObject;
            var DEFAULT_ROW_COUNT = 200, DEFAULT_COLUMN_COUNT = 20;
            var rm = new Common_1.Common.ResourceManager(core_ns_1.SR);
            var getSR = rm.getResource.bind(rm);
            function getPropertyValue(value, defaultValue) {
                return !isNullOrUndefined(value) ? value : defaultValue;
            }
            function _hasOwnProperty(obj, p) {
                return obj.hasOwnProperty(p);
            }
            function getRowCount(obj) {
                return obj.rowCount;
            }
            function getColCount(obj) {
                return obj.colCount;
            }
            function defineProperty(obj, propName, initValue, setCallback) {
                var data = initValue;
                Object.defineProperty(obj, propName, {
                    get: function () {
                        return data;
                    },
                    set: function (value) {
                        var oldValue = data;
                        data = value;
                        setCallback(this, value, propName, oldValue);
                    }
                });
            }
            function updateCache(model, ranges) {
                model.cache = {};
                if (ranges) {
                    ranges.forEach(function (range) {
                        _onSpanAdded(model, range);
                    });
                }
            }
            function _onSpanAdded(model, range) {
                model._lastNonNullRow = Math_max(model._lastNonNullRow, range.row + getRowCount(range) - 1);
                model._lastNonNullColumn = Math_max(model._lastNonNullColumn, range.col + getColCount(range) - 1);
                if (!model.suspendUpdatingCache) {
                    for (var r = 0; r < range.rowCount; r++) {
                        for (var c = 0; c < range.colCount; c++) {
                            model.cache[(range.row + r) + '_' + (range.col + c)] = range;
                        }
                    }
                }
            }
            function _onSpanRemoved(model, range) {
                if (!model.suspendUpdatingCache) {
                    for (var r = 0; r < range.rowCount; r++) {
                        for (var c = 0; c < range.colCount; c++) {
                            model.cache[(range.row + r) + '_' + (range.col + c)] = keyword_undefined;
                        }
                    }
                }
            }
            var _SpanModel = (function () {
                function _SpanModel() {
                    defineProperty(this, 'spans', [], updateCache);
                    this._lastNonNullColumn = -1;
                    this._lastNonNullRow = -1;
                    this.cache = {};
                    this.suspendUpdatingCache = false;
                }
                _SpanModel.prototype.find = function (row, col) {
                    return this.cache[row + '_' + col] || keyword_null;
                };
                _SpanModel.prototype.get = function (row, col) {
                    return this.find(row, col) || common_1._createRange(row, col, 1, 1);
                };
                _SpanModel.prototype.remove = function (range, changeInfo) {
                    var index = this.spans.indexOf(range);
                    if (index >= 0) {
                        if (changeInfo) {
                            changeInfo[0].push('spans');
                            changeInfo[1] = [].concat(this.spans);
                        }
                        this.removeSpan(index, 1);
                    } else if (changeInfo) {
                        changeInfo.length = 0;
                    }
                };
                _SpanModel.prototype.removeSpan = function (index, count) {
                    for (var i = 0; i < count; i++) {
                        _onSpanRemoved(this, this.spans[index + i]);
                    }
                    this.spans.splice(index, count);
                };
                _SpanModel.prototype.update = function (index, range) {
                    var self = this;
                    _onSpanRemoved(self, self.spans[index]);
                    self.spans[index] = range;
                    _onSpanAdded(self, range);
                };
                _SpanModel.prototype.add = function (range, changeInfo) {
                    if (changeInfo) {
                        changeInfo[0].push('spans');
                        changeInfo[1] = [].concat(this.spans);
                    }
                    _onSpanAdded(this, range);
                    this.spans.push(range);
                };
                _SpanModel.prototype._copy = function (fromRow, fromColumn, toRow, toColumn, rowCount, columnCount, changeInfo) {
                    var self = this;
                    var changed = false, oldSpans;
                    if (changeInfo) {
                        oldSpans = [].concat(self.spans);
                    }
                    var cellSpanCount = self.spans.length;
                    var cellSpan;
                    var cellSpanRow;
                    var cellSpanCol;
                    var i;
                    var tempRanges = [];
                    for (i = 0; i < cellSpanCount; i++) {
                        cellSpan = self.spans[i];
                        cellSpanCol = cellSpan.col;
                        cellSpanRow = cellSpan.row;
                        if ((fromRow === -1 || fromRow <= cellSpanRow && cellSpanRow < fromRow + rowCount) && (fromColumn === -1 || fromColumn <= cellSpanCol && cellSpanCol < fromColumn + columnCount)) {
                            tempRanges.push(common_1._createRange(fromRow === -1 ? cellSpanRow : toRow + cellSpanRow - fromRow, fromColumn === -1 ? cellSpanCol : toColumn + cellSpanCol - fromColumn, getRowCount(cellSpan), getColCount(cellSpan)));
                            changed = true;
                        } else if ((fromRow === -1 || toRow <= cellSpanRow && cellSpanRow < toRow + rowCount) && (fromColumn === -1 || toColumn <= cellSpanCol && cellSpanCol < toColumn + columnCount)) {
                            self.removeSpan(i, 1);
                            i--;
                            cellSpanCount--;
                            changed = true;
                        }
                    }
                    for (i = 0; i < tempRanges.length; i++) {
                        cellSpan = tempRanges[i];
                        if (!self._isValid(self.spans, 0, self.spans.length, cellSpan)) {
                            throw new Error(getSR().Exp_OverlappingSpans);
                        }
                        self.add(cellSpan);
                    }
                    if (changeInfo) {
                        if (changed) {
                            changeInfo[0].push('spans');
                            changeInfo[1] = oldSpans;
                        } else {
                            changeInfo.length = 0;
                        }
                    }
                };
                _SpanModel.prototype._isValid = function (list, start, end, cellRange) {
                    for (var i = start; i < end && i < list.length; i++) {
                        if (list[i].intersect(cellRange.row, cellRange.col, getRowCount(cellRange), getColCount(cellRange))) {
                            return false;
                        }
                    }
                    return true;
                };
                _SpanModel.prototype.getSpans = function (range) {
                    var spans = this.spans;
                    if (!range) {
                        return [].concat(spans);
                    }
                    var t = [];
                    for (var i = 0; i < spans.length; i++) {
                        var rg = spans[i];
                        if (rg.intersect(range.row, range.col, getRowCount(range), getColCount(range))) {
                            t.push(rg);
                        }
                    }
                    return t;
                };
                _SpanModel.prototype._hasPartSpans = function (row, column, rowCount, columnCount) {
                    var spans = this.spans;
                    for (var i = 0; i < spans.length; i++) {
                        var rg = spans[i];
                        if (rg.intersect(row, column, rowCount, columnCount)) {
                            if (row !== -1 && (rg.row < row || rg.row + getRowCount(rg) > row + rowCount) ||
                                column !== -1 && (rg.col < column || rg.col + getColCount(rg) > column + columnCount)) {
                                return true;
                            }
                        }
                    }
                    return false;
                };
                _SpanModel.prototype._hasSpans = function (row, column, rowCount, columnCount) {
                    var ret = false;
                    var spans = this.spans;
                    for (var i = 0, length_1 = spans.length; i < length_1; i++) {
                        if (row >= 0 || column >= 0) {
                            while (i < length_1 && !spans[i].intersect(row, column, rowCount, columnCount)) {
                                i++;
                            }
                        }
                        if (i < length_1) {
                            ret = true;
                            break;
                        }
                    }
                    return ret;
                };
                _SpanModel.prototype._clear = function (row, col, rowCount, colCount, changeInfo) {
                    var spans = this.spans;
                    var changed = false, oldSpans;
                    if (changeInfo) {
                        oldSpans = [].concat(spans);
                    }
                    for (var i = 0; i < spans.length; i++) {
                        var span = spans[i];
                        var spanRow = span.row;
                        var spanCol = span.col;
                        if ((row === -1 || row <= spanRow && spanRow < row + rowCount) && (col === -1 || col <= spanCol && spanCol < col + colCount)) {
                            this.removeSpan(i, 1);
                            i--;
                            changed = true;
                        }
                    }
                    if (changeInfo) {
                        if (changed) {
                            changeInfo[0].push('spans');
                            changeInfo[1] = oldSpans;
                        } else {
                            changeInfo.length = 0;
                        }
                    }
                };
                _SpanModel.prototype._move = function (fromRow, fromCol, toRow, toCol, rowCount, colCount, changeInfo) {
                    var self = this;
                    var changed = false, oldSpans;
                    if (changeInfo) {
                        oldSpans = [].concat(self.spans);
                    }
                    var tmpList = [];
                    var changeList = [];
                    var cellRangeCount = self.spans.length;
                    var cellSpan, cellSpanRow, cellSpanCol;
                    var i, cr;
                    for (i = 0; i < cellRangeCount; i++) {
                        cellSpan = self.spans[i];
                        cellSpanRow = cellSpan.row;
                        cellSpanCol = cellSpan.col;
                        if ((fromRow === -1 || fromRow <= cellSpanRow && cellSpanRow < fromRow + rowCount) && (fromCol === -1 || fromCol <= cellSpanCol && cellSpanCol < fromCol + colCount)) {
                            cr = common_1._createRange(fromRow === -1 ? cellSpanRow : toRow + cellSpanRow - fromRow, fromCol === -1 ? cellSpanCol : toCol + cellSpanCol - fromCol, getRowCount(cellSpan), getColCount(cellSpan));
                            changeList.push(cr);
                            changed = true;
                        } else if ((fromRow === -1 || toRow <= cellSpanRow && cellSpanRow < toRow + rowCount) && (fromCol === -1 || toCol <= cellSpanCol && cellSpanCol < toCol + colCount)) {
                            changed = true;
                        } else {
                            tmpList.push(cellSpan);
                        }
                    }
                    if (changed) {
                        if (changeList.length > 0) {
                            for (i = 0; i < changeList.length; i++) {
                                cr = changeList[i];
                                if (!self._isValid(tmpList, 0, tmpList.length, cr)) {
                                    throw new Error(getSR().Exp_OverlappingSpans);
                                }
                                tmpList.push(cr);
                            }
                        }
                        self.spans.length = 0;
                        self.cache = {};
                        for (i = 0; i < tmpList.length; i++) {
                            self.add(tmpList[i]);
                        }
                        if (changeInfo) {
                            changeInfo[0].push('spans');
                            changeInfo[1] = oldSpans;
                        }
                    } else if (changeInfo) {
                        changeInfo.length = 0;
                    }
                };
                _SpanModel.prototype._addRows = function (row, count, changeInfo) {
                    var self = this;
                    var spans = self.spans;
                    self.suspendUpdatingCache = true;
                    var changed = false, oldSpans;
                    if (changeInfo) {
                        oldSpans = [].concat(spans);
                    }
                    var countOld = spans.length;
                    for (var i = 0; i < countOld; i++) {
                        var cellSpan = spans[i];
                        var cellSpanRow = cellSpan.row;
                        var cellSpanCol = cellSpan.col;
                        var cellSpanRowCount = getRowCount(cellSpan);
                        var cellSpanColCount = getColCount(cellSpan);
                        if (cellSpanRow >= row) {
                            self.update(i, common_1._createRange(cellSpanRow + count, cellSpanCol, cellSpanRowCount, cellSpanColCount));
                            changed = true;
                        } else if (row < cellSpanRow + cellSpanRowCount) {
                            self.update(i, common_1._createRange(cellSpanRow, cellSpanCol, cellSpanRowCount + count, cellSpanColCount));
                            changed = true;
                        }
                    }
                    self.suspendUpdatingCache = false;
                    if (changed) {
                        updateCache(self, spans);
                    }
                    if (changeInfo) {
                        if (changed) {
                            changeInfo[0].push('spans');
                            changeInfo[1] = oldSpans;
                        } else {
                            changeInfo.length = 0;
                        }
                    }
                };
                _SpanModel.prototype._addColumns = function (column, count, changeInfo) {
                    var self = this;
                    var spans = self.spans;
                    self.suspendUpdatingCache = true;
                    var changed = false, oldSpans;
                    if (changeInfo) {
                        oldSpans = [].concat(spans);
                    }
                    var countOld = spans.length;
                    for (var i = 0; i < countOld; i++) {
                        var cellSpan = spans[i];
                        var cellSpanRow = cellSpan.row;
                        var cellSpanCol = cellSpan.col;
                        var cellSpanRowCount = getRowCount(cellSpan);
                        var cellSpanColCount = getColCount(cellSpan);
                        if (cellSpanCol >= column) {
                            self.update(i, common_1._createRange(cellSpanRow, cellSpanCol + count, cellSpanRowCount, cellSpanColCount));
                            changed = true;
                        } else if (column < cellSpanCol + cellSpanColCount) {
                            self.update(i, common_1._createRange(cellSpanRow, cellSpanCol, cellSpanRowCount, cellSpanColCount + count));
                            changed = true;
                        }
                    }
                    self.suspendUpdatingCache = false;
                    if (changed) {
                        updateCache(self, spans);
                    }
                    if (changeInfo) {
                        if (changed) {
                            changeInfo[0].push('spans');
                            changeInfo[1] = oldSpans;
                        } else {
                            changeInfo.length = 0;
                        }
                    }
                };
                _SpanModel.prototype._removeRows = function (row, count, changeInfo) {
                    var self = this, spans = self.spans;
                    self.suspendUpdatingCache = true;
                    var changed = false, oldSpans;
                    if (changeInfo) {
                        oldSpans = [].concat(spans);
                    }
                    var delList = [];
                    var countOld = spans.length;
                    var i;
                    for (i = 0; i < countOld; i++) {
                        var cellSpan = spans[i];
                        var cellSpanRow = cellSpan.row;
                        var cellSpanCol = cellSpan.col;
                        var cellSpanRowCount = getRowCount(cellSpan);
                        var cellSpanColCount = getColCount(cellSpan);
                        if (cellSpanRow >= row) {
                            if (cellSpanRow < row + count) {
                                if (cellSpanRow + cellSpanRowCount <= row + count) {
                                    delList.push(i);
                                    changed = true;
                                } else {
                                    self.update(i, common_1._createRange(row, cellSpanCol, cellSpanRow + cellSpanRowCount - (row + count), cellSpanColCount));
                                    changed = true;
                                }
                            } else {
                                self.update(i, common_1._createRange(cellSpanRow - count, cellSpanCol, cellSpanRowCount, cellSpanColCount));
                                changed = true;
                            }
                        } else if (row < cellSpanRow + cellSpanRowCount) {
                            var range = common_1._createRange(cellSpanRow, cellSpanCol, cellSpanRowCount - Math_min(cellSpanRow + cellSpanRowCount - row, count), cellSpanColCount);
                            self.update(i, range);
                            if (range.rowCount === 1 && range.colCount === 1) {
                                delList.push(i);
                            }
                            changed = true;
                        }
                    }
                    for (i = delList.length - 1; i >= 0; i--) {
                        var index = delList[i];
                        self.removeSpan(index, 1);
                    }
                    self.suspendUpdatingCache = false;
                    if (changed) {
                        updateCache(self, spans);
                    }
                    if (changeInfo) {
                        if (changed) {
                            changeInfo[0].push('spans');
                            changeInfo[1] = oldSpans;
                        } else {
                            changeInfo.length = 0;
                        }
                    }
                };
                _SpanModel.prototype._removeColumns = function (column, count, changeInfo) {
                    var self = this;
                    var spans = self.spans;
                    self.suspendUpdatingCache = true;
                    var changed = false;
                    var oldSpans;
                    if (changeInfo) {
                        oldSpans = [].concat(spans);
                    }
                    var delList = [];
                    var countOld = spans.length;
                    var i;
                    for (i = 0; i < countOld; i++) {
                        var cellSpan = spans[i];
                        var cellSpanRow = cellSpan.row;
                        var cellSpanCol = cellSpan.col;
                        var cellSpanRowCount = getRowCount(cellSpan);
                        var cellSpanColCount = getColCount(cellSpan);
                        if (cellSpanCol >= column) {
                            if (cellSpanCol < column + count) {
                                if (cellSpanCol + cellSpanColCount <= column + count) {
                                    delList.push(i);
                                    changed = true;
                                } else {
                                    self.update(i, common_1._createRange(cellSpanRow, column, cellSpanRowCount, cellSpanCol + cellSpanColCount - (column + count)));
                                    changed = true;
                                }
                            } else {
                                self.update(i, common_1._createRange(cellSpanRow, cellSpanCol - count, cellSpanRowCount, cellSpanColCount));
                                changed = true;
                            }
                        } else if (column < cellSpanCol + cellSpanColCount) {
                            var range = common_1._createRange(cellSpanRow, cellSpanCol, cellSpanRowCount, cellSpanColCount - Math_min(cellSpanCol + cellSpanColCount - column, count));
                            self.update(i, range);
                            if (range.rowCount === 1 && range.colCount === 1) {
                                delList.push(i);
                            }
                            changed = true;
                        }
                    }
                    for (i = delList.length - 1; i >= 0; i--) {
                        var index = delList[i];
                        self.removeSpan(index, 1);
                    }
                    self.suspendUpdatingCache = false;
                    if (changed) {
                        updateCache(self, spans);
                    }
                    if (changeInfo) {
                        if (changed) {
                            changeInfo[0].push('spans');
                            changeInfo[1] = oldSpans;
                        } else {
                            changeInfo.length = 0;
                        }
                    }
                };
                _SpanModel.prototype.toJSON = function () {
                    var array = [].concat(this.spans);
                    return array.length === 0 ? keyword_undefined : array;
                };
                _SpanModel.prototype.fromJSON = function (setting) {
                    if (!setting) {
                        return;
                    }
                    this.spans = [];
                    var spans = setting;
                    for (var i = 0; i < spans.length; i++) {
                        var cr = spans[i];
                        this.add(common_1._createRange(cr.row, cr.col, getRowCount(cr), getColCount(cr)));
                    }
                };
                return _SpanModel;
            }());

            var _XArray = (function () {
                function _XArray() {
                    Array.apply(this, arguments);
                }
                _XArray.prototype.pop = function () {
                    return keyword_null;
                };
                _XArray.prototype.push = function (val) {
                    return 0;
                };
                _XArray.prototype.splice = function (start, deleteCount) {
                    var items = [];
                    for (var _i = 2; _i < arguments.length; _i++) {
                        items[_i - 2] = arguments[_i];
                    }
                    return keyword_null;
                };
                _XArray.prototype.slice = function (start, end) {
                    return null;
                };
                return _XArray;
            }());
            _XArray.prototype = [];

            var _CellOverflowLayoutModel = (function (_super) {
                __extends(_CellOverflowLayoutModel, _super);
                function _CellOverflowLayoutModel() {
                    var _this_1 = _super.call(this) || this;
                    _this_1.headingOverflowlayouts = keyword_null;
                    _this_1.trailingOverflowLayouts = keyword_null;
                    return _this_1;
                }
                _CellOverflowLayoutModel.prototype.find = function (col) {
                    var self = this;
                    var count = self.length;
                    var cellOverflowLayout;
                    var cellOverflowLayouts = [];
                    for (var i = 0; i < count; i++) {
                        cellOverflowLayout = self[i];
                        if (cellOverflowLayout.contains(col)) {
                            cellOverflowLayouts.push(cellOverflowLayout);
                        }
                    }
                    return cellOverflowLayouts;
                };
                return _CellOverflowLayoutModel;
            }(_XArray));
            exports._CellOverflowLayoutModel = _CellOverflowLayoutModel;
            var _CellOverflowLayout = (function () {
                function _CellOverflowLayout(column, startColumn, endColumn, valueWidth, columnWidth, backgroundWidth, backgroundLeftWidth, backgroundRightWidth) {
                    var self = this;
                    self.column = column;
                    self.startColumn = startColumn;
                    self.endColumn = endColumn;
                    self.valueWidth = valueWidth;
                    self.columnWidth = columnWidth;
                    self.backgroundWidth = backgroundWidth;
                    self.backgroundLeftWidth = backgroundLeftWidth;
                    self.backgroundRightWidth = backgroundRightWidth;
                }
                _CellOverflowLayout.prototype.contains = function (col) {
                    return col >= this.startColumn && col <= this.endColumn;
                };
                return _CellOverflowLayout;
            }());
            exports._CellOverflowLayout = _CellOverflowLayout;

            function _normalizeRange(range, sheetRowCount, sheetColCount) {
                var rg = common_1._createRange(-1, -1, -1, -1);
                if (range) {
                    var rangeCol = range.col;
                    var rangeRow = range.row;
                    var isWholeCol = rangeRow === -1;
                    var isWholeRow = rangeCol === -1;
                    rg.row = isWholeCol ? 0 : rangeRow;
                    rg.rowCount = isWholeCol ? sheetRowCount : getRowCount(range);
                    rg.col = isWholeRow ? 0 : rangeCol;
                    rg.colCount = isWholeRow ? sheetColCount : getColCount(range);
                }
                return rg;
            }
            var _SelectionModel = (function () {
                function _SelectionModel() {
                    this.selections = [];
                    this.selectionPolicy = 2;
                    this.selectionUnit = 0;
                }
                _SelectionModel.prototype.getProperty = function (prop) {
                    return this[prop];
                };
                _SelectionModel.prototype.setProperty = function (prop, value, changeInfo) {
                    if (changeInfo) {
                        changeInfo[0].push(prop);
                        changeInfo[1] = this[prop];
                    }
                    this[prop] = value;
                };
                _SelectionModel.prototype.clear = function (changeInfos) {
                    if (changeInfos) {
                        changeInfos.push(['selections', this.get()]);
                        changeInfos.push(['activeSelectedRangeIndex', this.activeSelectedRangeIndex]);
                    }
                    this.selections = [];
                    this.activeSelectedRangeIndex = -1;
                };
                _SelectionModel.prototype.add = function (row, col, rowCount, colCount, changeInfos) {
                    if (changeInfos) {
                        changeInfos.push(['selections', this.get()]);
                        changeInfos.push(['activeSelectedRangeIndex', this.activeSelectedRangeIndex]);
                    }
                    var self = this;
                    var selectionPolicy = self.selectionPolicy;
                    var selectionUnit = self.selectionUnit;
                    if (selectionPolicy === 0) {
                        rowCount = Math_min(rowCount, 1);
                        colCount = Math_min(colCount, 1);
                        self.clear();
                    } else if (selectionPolicy === 1) {
                        self.clear();
                    }
                    if (selectionUnit === 1) {
                        col = -1;
                        colCount = -1;
                    } else if (selectionUnit === 2) {
                        row = -1;
                        rowCount = -1;
                    }
                    self.selections.push(common_1._createRange(row, col, rowCount, colCount));
                    self.activeSelectedRangeIndex = self.selections.length - 1;
                };
                _SelectionModel.prototype.get = function () {
                    return [].concat(this.selections);
                };
                _SelectionModel.prototype.set = function (ranges, changeInfos) {
                    if (changeInfos) {
                        changeInfos.push(['selections', this.get()]);
                        changeInfos.push(['activeSelectedRangeIndex', this.activeSelectedRangeIndex]);
                    }
                    this.selections = ranges;
                    if (this.activeSelectedRangeIndex >= ranges.length) {
                        this.activeSelectedRangeIndex = 0;
                    }
                };
                _SelectionModel.prototype.toJSON = function () {
                    var self = this;
                    var sdata = {};
                    var selectionPolicy = self.selectionPolicy;
                    var selectionUnit = self.selectionUnit;
                    var activeSelectedRangeIndex = self.activeSelectedRangeIndex;
                    var length = self.selections.length;
                    if (selectionPolicy !== 2) {
                        sdata.selectionPolicy = selectionPolicy;
                    }
                    if (selectionUnit !== 0) {
                        sdata.selectionUnit = selectionUnit;
                    }
                    if (activeSelectedRangeIndex !== 0) {
                        sdata.activeSelectedRangeIndex = activeSelectedRangeIndex;
                    }
                    sdata.length = length;
                    for (var i = 0; i < length; i++) {
                        sdata[i] = self.selections[i];
                    }
                    return $_isEmptyObject(sdata) ? keyword_undefined : sdata;
                };
                _SelectionModel.prototype.fromJSON = function (selections, rowCount, columnCount) {
                    var sheetRowCount = rowCount || DEFAULT_ROW_COUNT;
                    var sheetColumnCount = columnCount || DEFAULT_COLUMN_COUNT;
                    var selectionRowCount, selectionColumnCount;
                    if (!selections) {
                        return;
                    }
                    var self = this;
                    self.clear();
                    var selectionPolicy = selections.selectionPolicy;
                    var selectionUnit = selections.selectionUnit;
                    var count = selections.length;
                    if (isNullOrUndefined(count)) {
                        count = 1;
                    }
                    for (var i = 0; i < count; i++) {
                        var cr = selections[i];
                        selectionRowCount = Math_min((cr ? getRowCount(cr) : 1), sheetRowCount);
                        selectionColumnCount = Math_min((cr ? getColCount(cr) : 1), sheetColumnCount);
                        self.selections.push(common_1._createRange(cr ? cr.row : 0, cr ? cr.col : 0, selectionRowCount, selectionColumnCount));
                    }
                    self.activeSelectedRangeIndex = selections.activeSelectedRangeIndex || 0;
                    if (!isNullOrUndefined(selectionPolicy)) {
                        self.selectionPolicy = selectionPolicy;
                    }
                    if (!isNullOrUndefined(selectionUnit)) {
                        self.selectionUnit = selectionUnit;
                    }
                };
                _SelectionModel.prototype._isColumnSelected = function (c) {
                    var selections = this.selections;
                    for (var i = 0; i < selections.length; i++) {
                        var selectedRange = selections[i];
                        var col = selectedRange.col === -1 ? 0 : selectedRange.col;
                        if (selectedRange.row === -1 && c >= col && c < col + getColCount(selectedRange)) {
                            return true;
                        }
                    }
                    return false;
                };
                _SelectionModel.prototype._isRowSelected = function (r) {
                    var selections = this.selections;
                    for (var i = 0; i < selections.length; i++) {
                        var selectedRange = selections[i];
                        var row = selectedRange.row === -1 ? 0 : selectedRange.row;
                        if (selectedRange.col === -1 && r >= row && r < row + getRowCount(selectedRange)) {
                            return true;
                        }
                    }
                    return false;
                };
                _SelectionModel.prototype._isSelected = function (r, c, sheetArea, sheetRowCount, sheetColCount, considerAdjacentCell) {
                    var selected = false;
                    var selections = this.selections;
                    var adjustIndex = considerAdjacentCell ? 1 : 0;
                    for (var i = 0, count = selections.length; i < count; i++) {
                        var cr = selections[i];
                        var selectedRange = _normalizeRange(cr, sheetRowCount, sheetColCount);
                        var selectedRow = selectedRange.row;
                        var selectedCol = selectedRange.col;
                        var containRow = selectedRow - adjustIndex <= r && r < selectedRow + getRowCount(selectedRange) + adjustIndex;
                        var containCol = selectedCol - adjustIndex <= c && c < selectedCol + getColCount(selectedRange) + adjustIndex;
                        if (sheetArea === 3 || isNullOrUndefined(sheetArea)) {
                            selected = containRow && containCol;
                        } else if (sheetArea === 2) {
                            selected = containRow;
                        } else if (sheetArea === 1) {
                            selected = containCol;
                        } else if (sheetArea === 0) {
                            selected = cr.row === -1 && cr.col === -1;
                        }
                        if (selected) {
                            break;
                        }
                    }
                    return selected;
                };
                _SelectionModel.prototype._isAllSelected = function (r, c, sheetArea, sheetRowCount, sheetColCount) {
                    var selections = this.selections;
                    var selected = false;
                    for (var i = 0; i < selections.length; i++) {
                        var selectedRange = selections[i];
                        var selectedRow = selectedRange.row;
                        var selectedCol = selectedRange.col;
                        var selectedRowCount = getRowCount(selectedRange);
                        var selectedColCount = getColCount(selectedRange);
                        var isWholeRow = selectedCol === -1;
                        var isWholeCol = selectedRow === -1;
                        if (!isNullOrUndefined(sheetArea) && sheetArea !== 3) {
                            if (sheetArea === 2) {
                                var row = isWholeCol ? 0 : selectedRow;
                                selected = isWholeRow && r >= row && r < row + selectedRowCount;
                            } else if (sheetArea === 1) {
                                var col = isWholeRow ? 0 : selectedCol;
                                selected = isWholeCol && c >= col && c < col + selectedColCount;
                            } else if (sheetArea === 0) {
                                selected = isWholeCol && isWholeRow && selectedRowCount === sheetRowCount && selectedColCount === sheetColCount;
                            }
                            if (selected) {
                                break;
                            }
                        }
                    }
                    return selected;
                };
                return _SelectionModel;
            }());

            function _find(model, row, col, x, y) {
                var count = model.length;
                var layout;
                var found = false;
                for (var i = 0; i < count; i++) {
                    layout = model[i];
                    if (!isNullOrUndefined(row) && !isNullOrUndefined(col)) {
                        found = layout.contains(row, col);
                    } else if (!isNullOrUndefined(row)) {
                        found = layout.row === row;
                    } else if (!isNullOrUndefined(col)) {
                        found = layout.col === col;
                    } else if (!isNullOrUndefined(x)) {
                        found = layout.containsX(x);
                    } else {
                        found = layout.containsY(y);
                    }
                    if (found) {
                        return layout;
                    }
                }
                return keyword_null;
            }
            function _findNearXY(model, x, y) {
                var ret = keyword_null;
                var count = model.length;
                var isFindX = !isNullOrUndefined(x);
                if (count > 0) {
                    ret = isFindX ? model.findX(x) : model.findY(y);
                    if (!ret) {
                        if (isFindX && x < model[0].x || !isFindX && y < model[0].y) {
                            ret = model[0];
                        } else {
                            ret = model[count - 1];
                        }
                    }
                }
                return ret;
            }

            var _LayoutModel = (function (_super) {
                __extends(_LayoutModel, _super);
                function _LayoutModel() {
                    return _super.call(this) || this;
                }
                _LayoutModel.prototype.findCell = function (row, col) {
                    var count = this.length;
                    var layout;
                    for (var i = 0; i < count; i++) {
                        layout = this[i];
                        if (layout.contains(row, col)) {
                            return layout;
                        }
                    }
                    return keyword_null;
                };
                _LayoutModel.prototype.findRow = function (row) {
                    var count = this.length;
                    var layout;
                    for (var i = 0; i < count; i++) {
                        layout = this[i];
                        if (layout.row === row) {
                            return layout;
                        }
                    }
                    return keyword_null;
                };
                _LayoutModel.prototype.findCol = function (col) {
                    var count = this.length;
                    var layout;
                    for (var i = 0; i < count; i++) {
                        layout = this[i];
                        if (layout.col === col) {
                            return layout;
                        }
                    }
                    return keyword_null;
                };
                _LayoutModel.prototype.findX = function (x) {
                    return _find(this, keyword_undefined, keyword_undefined, x);
                };
                _LayoutModel.prototype.findY = function (y) {
                    return _find(this, keyword_undefined, keyword_undefined, keyword_undefined, y);
                };
                _LayoutModel.prototype.findNearX = function (x) {
                    return _findNearXY(this, x);
                };
                _LayoutModel.prototype.findNearY = function (y) {
                    return _findNearXY(this, keyword_undefined, y);
                };
                return _LayoutModel;
            }(_XArray));
            exports._LayoutModel = _LayoutModel;
            var _Layout = (function () {
                function _Layout(row, col, x, y, width, height, rowCount, colCount, isAutoMerge) {
                    var self = this;
                    self.rowCount = rowCount;
                    self.colCount = colCount;
                    self.row = row;
                    self.col = col;
                    self.x = x;
                    self.y = y;
                    self.width = width;
                    self.height = height;
                    self.isAutoMerge = isAutoMerge;
                }
                _Layout.prototype.contains = function (row, col) {
                    var self = this;
                    return row < self.row + getRowCount(self) && self.row <= row && col < self.col + getColCount(self) && self.col <= col;
                };
                _Layout.prototype.intersect = function (rect) {
                    var self = this;
                    return (self.x < 0 || rect.x < self.x + self.width && self.x < rect.x + rect.width) && (self.y < 0 || rect.y < self.y + self.height && self.y < rect.y + rect.height);
                };
                _Layout.prototype.containsX = function (x) {
                    return this.x <= x && x < this.x + this.width;
                };
                _Layout.prototype.containsY = function (y) {
                    return this.y <= y && y < this.y + this.height;
                };
                return _Layout;
            }());
            exports._Layout = _Layout;


            function getLoadingProgress(status, noCalcAfterLoad) {
                var valuesLoad = status.valuesLoad / status.total;


                return noCalcAfterLoad ? (valuesLoad * 0.4 + 0.1) : (valuesLoad * 0.3 + 0.1);
            }
            function loadCellDataAsync(model, data, rowCount, colCount, options, noSchema, rowIndex, callback) {
                var task = options && options.incrementLoadTask;
                if (!task || task.isTerminated) {
                    return;
                }
                var isBusy = task.isBusyFunc;
                rowIndex = rowIndex || 0;
                var r = rowIndex;
                var dirty = false;
                var maxTimeSpan = 30;
                var startLoading = new Date();
                while (r < rowCount) {
                    var dr = data[r];
                    if (dr) {
                        for (var c = 0; c < colCount; c++) {
                            var node = dr[c];
                            if (node) {
                                dirty = true;
                                _copyFromJSONNode(node, model._getNode(r, c, true), noSchema, r, c, options);
                            }
                        }
                    }
                    r++;

                    if (isBusy && isBusy()) {
                        break;
                    }
                    var endLoading = new Date();
                    if (endLoading - startLoading > maxTimeSpan) {
                        break;
                    }
                }
                if (dirty) {
                    var sheet = options && options.sheet;
                    if (rowIndex !== 0 && sheet.parent.getActiveSheet() === sheet) {
                        for (var i = rowIndex; i < r; i++) {
                            if (sheet._rowLayoutCache.viewport[1].findRow(i)) {
                                sheet.repaint();
                                break;
                            }
                        }
                    }
                    var incrementalLoading = options && options.incrementalLoading;
                    if (incrementalLoading && incrementalLoading.loading) {
                        incrementalLoading.loadStatus.valuesLoad += r - rowIndex;
                        var progress = getLoadingProgress(incrementalLoading.loadStatus, options.doNotRecalculateAfterLoad);
                        incrementalLoading.loading(progress, { sheet: sheet });
                    }
                }
                if (r < rowCount) {
                    options.incrementLoadTask.pushTask(loadCellDataAsync,
                        [
                            model, data, rowCount, colCount, options, noSchema, r, callback
                        ]
                    );
                } else {
                    callback && options.incrementLoadTask.pushTask(callback, []);
                }
            }
            function loadCellData(model, data, rowCount, colCount, options, noSchema) {
                for (var r = 0; r < rowCount; r++) {
                    var dr = data[r];
                    if (dr) {
                        for (var c = 0; c < colCount; c++) {
                            var node = dr[c];
                            if (node) {
                                _copyFromJSONNode(node, model._getNode(r, c, true), noSchema, r, c, options);
                            }
                        }
                    }
                }
            }
            function _setNode4Swap(or, oc, row, col, node, dataTable, rowDataArray, columnDataArray) {
                if (row >= 0 && col >= 0) {
                    if (!dataTable[row]) {
                        dataTable[row] = {};
                    }
                    var dt = dataTable[row];
                    dt[col] = node;
                } else if (row >= 0 && col === -1 && or >= 0 && oc === -1) {
                    rowDataArray[row] = node;
                } else if (col >= 0 && row === -1 && oc >= 0 && or === -1) {
                    columnDataArray[col] = node;
                }
            }
            function _setDirtyNode4Swap(or, oc, row, col, dirtyNode, dirtyNodes, originalItem) {
                if (row >= 0 && col >= 0) {
                    if (!dirtyNodes[row]) {
                        dirtyNodes[row] = {};
                    }
                    dirtyNodes[row].rs = 'e';
                    var dr = dirtyNodes[row];
                    dr.originalItem = originalItem;
                    dr[col] = dirtyNode;
                }
            }
            var _SheetModel = (function () {
                function _SheetModel(rowCount, colCount) {
                    var self = this;
                    self._rowCount = rowCount;
                    self._colCount = colCount;
                    self._init();
                }
                _SheetModel.prototype._init = function () {
                    var self = this;
                    self.dataTable = {};
                    self.rowDataArray = [];
                    self.columnDataArray = [];
                    self.defaultDataNode = keyword_null;
                    self._dirtyNodes = {};
                    self._dirtySuspended = 0;
                    self._lastNonNullColumn = -1;
                    self._lastNonNullRow = -1;
                };
                _SheetModel.prototype.getRowCount = function () {
                    return this._rowCount;
                };
                _SheetModel.prototype.getColumnCount = function () {
                    return this._colCount;
                };
                _SheetModel.prototype.setRowCount = function (c) {
                    this._rowCount = c;
                };
                _SheetModel.prototype.setColumnCount = function (c) {
                    this._colCount = c;
                };
                _SheetModel.prototype._updateDirty = function (row, col, dirtyOption, changeInfo) {
                    var self = this, dirtyNodes = self._dirtyNodes;
                    if (self._dirtySuspended > 0) {
                        return;
                    }
                    if (row >= 0 && col >= 0) {
                        if (changeInfo) {
                            changeInfo.type = 'updateDirty';
                            changeInfo.row = row;
                            changeInfo.col = col;
                            if (!dirtyNodes[row]) {
                                changeInfo.isEmptyRow = true;
                            } else if (!dirtyNodes[row][col]) {
                                changeInfo.isEmptyCol = true;
                            }
                        }
                        if (!dirtyNodes[row]) {
                            dirtyNodes[row] = {};
                        }
                        var dnr = dirtyNodes[row];
                        if (!dnr[col]) {
                            dnr[col] = {};
                        }
                        var node = dnr[col];
                        if (dnr.rs !== 'n') {
                            dnr.rs = 'e';
                        }
                        var originalItem = dirtyOption._originalItem;
                        var oldValue = dirtyOption._oldValue;
                        if (!isNullOrUndefined(originalItem)) {
                            if (changeInfo) {
                                changeInfo.originalItem = dnr.originalItem;
                            }
                            dnr.originalItem = originalItem;
                        }
                        if (!isNullOrUndefined(oldValue)) {
                            if (changeInfo) {
                                changeInfo.oldValue = node.oldValue;
                            }
                            node.oldValue = oldValue;
                        }
                    }
                };
                _SheetModel.prototype._undoUpdateDirty = function (changeInfo) {
                    var dirtyNodes = this._dirtyNodes;
                    var row = changeInfo.row;
                    var col = changeInfo.col;
                    if (changeInfo.isEmptyRow && dirtyNodes) {
                        delete dirtyNodes[row];
                    } else if (changeInfo.isEmptyCol && dirtyNodes[row]) {
                        delete dirtyNodes[row][col];
                    } else {
                        if (changeInfo.hasOwnProperty('originalItem')) {
                            if (isNullOrUndefined(changeInfo.originalItem) && !isNullOrUndefined(dirtyNodes[row].originalItem)) {
                                delete dirtyNodes[row].originalItem;
                            } else {
                                dirtyNodes[row].originalItem = changeInfo.originalItem;
                            }
                        }
                        if (changeInfo.hasOwnProperty('oldValue') && dirtyNodes[row]) {
                            if (isNullOrUndefined(changeInfo.oldValue) && !isNullOrUndefined(dirtyNodes[row][col].oldValue)) {
                                delete dirtyNodes[row][col].oldValue;
                            } else {
                                dirtyNodes[row][col].oldValue = changeInfo.oldValue;
                            }
                        }
                    }
                };
                _SheetModel.prototype.getValue = function (row, col, valueType) {
                    var node = this._getNode(row, col);
                    if (node && !isNullOrUndefined(node.value)) {
                        if (valueType !== 1) {
                            return convertRichTextValue(node.value);
                        }
                        if (!isNullOrUndefined(node.value.richText)) {
                            return $_extend(true, {}, node.value);
                        }
                        return node.value;
                    }
                    return keyword_null;
                };
                _SheetModel.prototype.setValue = function (row, col, value, valueChangeInfo, dirtyChangeInfo) {
                    var node = this._getNode(row, col, true, valueChangeInfo ? valueChangeInfo[0] : keyword_undefined);
                    if (node && (!isNullOrUndefined(node.value) || !isNullOrUndefined(value)) && node.value !== value) {
                        var oldValue = node.value;
                        node.value = value;
                        this._updateDirty(row, col, { _oldValue: oldValue }, dirtyChangeInfo);
                        if (valueChangeInfo) {
                            valueChangeInfo[0].push('value');
                            valueChangeInfo[1] = oldValue;
                        }
                    } else if (valueChangeInfo) {
                        valueChangeInfo.length = 0;
                    }
                };
                _SheetModel.prototype.getStyle = function (row, col, needClone) {
                    var node = this._getNode(row, col);
                    var style = node && node.style;
                    if (style && needClone && style.clone) {
                        style = style.clone(true);
                    }
                    return style;
                };
                _SheetModel.prototype.setStyle = function (row, col, value, changeInfo) {
                    var node = this._getNode(row, col, true, changeInfo ? changeInfo[0] : keyword_undefined);
                    if (node && node.style !== value) {
                        var oldStyle = node.style;
                        node.style = value;
                        if (changeInfo) {
                            changeInfo[0].push('style');
                            changeInfo[1] = oldStyle;
                        }
                    } else if (changeInfo) {
                        changeInfo.length = 0;
                    }
                };
                _SheetModel.prototype.getCellState = function (row, col) {
                    var node = this._getNode(row, col);
                    if (node) {
                        return node.cellState;
                    }
                    return keyword_null;
                };
                // 设置单元格状态
                _SheetModel.prototype.setCellState = function (row, col, value, isAdd) {
                    var state;
                    var node;
                    var old = this.getCellState(row, col) || 0;
                    if (isAdd) {
                        state = old | value;
                    } else {
                        state = old & (~value);
                    }
                    if (state !== 0) {
                        node = this._getNode(row, col, true, keyword_undefined, true);
                        if (node) {
                            node.cellState = state;
                        }
                    } else {
                        node = this._getNode(row, col);
                        if (node) {
                            delete node.cellState;
                        }
                        if ($_isEmptyObject(node)) {
                            deleteItem(this.dataTable, row, col);
                            if ($_isEmptyObject(this.dataTable[row])) {
                                delete this.dataTable[row];
                            }
                        }
                    }
                };
                _SheetModel.prototype.getValueForKey = function (row, col, key) {
                    var node = this._getNode(row, col);
                    return node && node[key];
                };
                _SheetModel.prototype.setValueForKey = function (row, col, key, value, changeInfo) {
                    var node = this._getNode(row, col, true, changeInfo ? changeInfo[0] : keyword_undefined);
                    if (node && node[key] !== value) {
                        var oldValue = node[key];
                        node[key] = value;
                        if (changeInfo) {
                            changeInfo[0].push(key);
                            changeInfo[1] = oldValue;
                        }
                    } else if (changeInfo) {
                        changeInfo.length = 0;
                    }
                };
                _SheetModel.prototype._addRows = function (row, count, isUndoDeleteRows) {
                    var self = this;
                    var oldRowCount = self._rowCount;
                    var dataTable = self.dataTable;
                    var dirtyNodes = self._dirtyNodes;
                    if (0 <= row && row <= oldRowCount && count >= 0) {
                        addElements(dataTable, oldRowCount, row, count);
                        addElements(self.rowDataArray, oldRowCount, row, count);
                        addElements(dirtyNodes, oldRowCount, row, count);
                        self._rowCount += count;
                        if (!isUndoDeleteRows) {
                            for (var i = 0; i < count; i++) {
                                dataTable[row + i] = { rs: 'n' };
                                dirtyNodes[row + i] = { rs: 'n' };
                            }
                        }
                    }
                };
                _SheetModel.prototype._deleteRows = function (row, count, changes) {
                    var self = this;
                    var oldRowCount = self._rowCount;
                    if (0 <= row && row < oldRowCount && count > 0) {
                        if (row + count > oldRowCount) {
                            count = oldRowCount - row;
                        }
                        if (changes) {
                            for (var i = 0; i < count; i++) {
                                var rowIndex = row + i;
                                changes.push([['dataTable', rowIndex], self.dataTable[rowIndex]]);
                                changes.push([['rowDataArray', rowIndex], self.rowDataArray[rowIndex]]);
                                changes.push([[UNDERSCORE_DIRTY_NODES, rowIndex], self._dirtyNodes[rowIndex]]);
                            }
                        }
                        deleteElements(self.dataTable, oldRowCount, row, count);
                        deleteElements(self.rowDataArray, oldRowCount, row, count);
                        deleteElements(self._dirtyNodes, oldRowCount, row, count);
                        self._rowCount -= count;
                    }
                };
                _SheetModel.prototype._addColumns = function (col, count) {
                    var self = this;
                    var oldColCount = self._colCount;
                    if (0 <= col && col <= oldColCount && count >= 0) {
                        for (var i = 0; i < self._rowCount; i++) {
                            var tr = self.dataTable[i];
                            if (tr && col < oldColCount) {
                                addElements(tr, oldColCount, col, count);
                            }
                        }
                        addElements(self.columnDataArray, oldColCount, col, count);
                        self._colCount += count;
                    }
                };
                _SheetModel.prototype._deleteColumns = function (col, count, changes) {
                    var self = this;
                    var oldColCount = self._colCount;
                    if (0 <= col && col < oldColCount && count > 0) {
                        for (var i = 0; i < self._rowCount; i++) {
                            var tr = self.dataTable[i];
                            if (tr) {
                                if (changes) {
                                    for (var j = 0; j < count; j++) {
                                        var colIndex = col + j;
                                        changes.push([['dataTable', i, colIndex], tr[colIndex]]);
                                    }
                                }
                                deleteElements(tr, oldColCount, col, count);
                            }
                        }
                        if (changes) {
                            for (var k = 0; k < count; k++) {
                                var columnIndex = col + k;
                                changes.push([['columnDataArray', columnIndex], self.columnDataArray[columnIndex]]);
                            }
                        }
                        deleteElements(self.columnDataArray, oldColCount, col, count);
                        if (col + count > oldColCount) {
                            count = oldColCount - col;
                        }
                        self._colCount -= count;
                    }
                };
                _SheetModel.prototype._getNode = function (row, col, create, paths, ignoreUpdateLstNonNull) {
                    var self = this;
                    var dataTable = self.dataTable;
                    var columnDataArray = self.columnDataArray;
                    var rowDataArray = self.rowDataArray;
                    var node = keyword_null;
                    if (row < self._rowCount && col < self._colCount) {
                        if (row >= 0 && col >= 0) {
                            var dr = dataTable[row];
                            if (create) {
                                if (!dr) {
                                    dr = dataTable[row] = {};
                                }
                                if (!ignoreUpdateLstNonNull && row > self._lastNonNullRow) {
                                    self._lastNonNullRow = row;
                                }
                            }
                            if (dr) {
                                node = dr[col];
                                if (create) {
                                    if (!node) {
                                        node = dr[col] = {};
                                    }
                                    if (!ignoreUpdateLstNonNull && self._lastNonNullColumn < col) {
                                        self._lastNonNullColumn = col;
                                    }
                                }
                            }
                            if (paths) {
                                paths.push('dataTable', row, col);
                            }
                        } else if (row === -1 && col >= 0) {
                            node = columnDataArray[col];
                            if (create) {
                                if (!node) {
                                    node = columnDataArray[col] = {};
                                }
                                if (!ignoreUpdateLstNonNull && self._lastNonNullColumn < col) {
                                    self._lastNonNullColumn = col;
                                }
                            }
                            if (paths) {
                                paths.push('columnDataArray', col);
                            }
                        } else if (row >= 0 && col === -1) {
                            node = rowDataArray[row];
                            if (create) {
                                if (!node) {
                                    node = rowDataArray[row] = {};
                                }
                                if (!ignoreUpdateLstNonNull && self._lastNonNullRow < row) {
                                    self._lastNonNullRow = row;
                                }
                            }
                            if (paths) {
                                paths.push('rowDataArray', row);
                            }
                        } else if (row === -1 && col === -1) {
                            node = self.defaultDataNode;
                            if (create && !node) {
                                node = self.defaultDataNode = {};
                            }
                            if (paths) {
                                paths.push('defaultDataNode');
                            }
                        }
                    }
                    return node;
                };
                _SheetModel.prototype.setNode = function (row, col, nodeValue) {
                    var self = this;
                    var dataTable = self.dataTable;
                    var columnDataArray = self.columnDataArray;
                    var rowDataArray = self.rowDataArray;
                    if (row < self._rowCount && col < self._colCount) {
                        if (row >= 0 && col >= 0) {
                            var dr = dataTable[row];
                            if (!dr) {
                                dr = dataTable[row] = {};
                            }
                            dr[col] = nodeValue;
                        } else if (row === -1 && col >= 0) {
                            columnDataArray[col] = nodeValue;
                        } else if (col === -1 && row >= 0) {
                            rowDataArray[row] = nodeValue;
                        }
                    }
                };
                _SheetModel.prototype._swapNode = function (row, col, row2, col2, changeInfos) {
                    var paths;
                    var paths2;
                    if (changeInfos) {
                        paths = [];
                        paths2 = [];
                    }
                    var self = this;
                    var dataTable = self.dataTable;
                    var rowDataArray = self.rowDataArray;
                    var columnDataArray = self.columnDataArray;
                    var dirtyNodes = self._dirtyNodes;
                    var node = self._getNode(row, col, keyword_undefined, paths);
                    var dirtyNode = dirtyNodes[row] && dirtyNodes[row][col];
                    var originalItem = dirtyNodes[row] && dirtyNodes[row].originalItem;
                    var node2 = self._getNode(row2, col2, keyword_undefined, paths2);
                    var dirtyNode2 = dirtyNodes[row2] && dirtyNodes[row2][col2];
                    var originalItem2 = dirtyNodes[row2] && dirtyNodes[row2].originalItem;
                    if (changeInfos) {
                        changeInfos.push([paths, node]);
                        changeInfos.push([paths2, node2]);
                    }
                    if (node) {
                        _setNode4Swap(row, col, row2, col2, node, dataTable, rowDataArray, columnDataArray);
                    } else if (node2) {
                        _setNode4Swap(row, col, row2, col2, keyword_null, dataTable, rowDataArray, columnDataArray);
                    }
                    if (node2) {
                        _setNode4Swap(row2, col2, row, col, node2, dataTable, rowDataArray, columnDataArray);
                    } else if (node) {
                        _setNode4Swap(row2, col2, row, col, keyword_null, dataTable, rowDataArray, columnDataArray);
                    }
                    if (dirtyNode) {
                        _setDirtyNode4Swap(row, col, row2, col2, dirtyNode, dirtyNodes, originalItem);
                    } else if (dirtyNode2) {
                        _setDirtyNode4Swap(row, col, row2, col2, keyword_null, dirtyNodes, originalItem);
                    }
                    if (dirtyNode2) {
                        _setDirtyNode4Swap(row2, col2, row, col, dirtyNode2, dirtyNodes, originalItem2);
                    } else if (dirtyNode) {
                        _setDirtyNode4Swap(row2, col2, row, col, keyword_null, dirtyNodes, originalItem2);
                    }
                };
                _SheetModel.prototype._nextNonNullRow = function (row) {
                    row++;
                    var rowCount = this._rowCount;
                    var dataTable = this.dataTable;
                    while (row >= 0 && row < rowCount) {
                        if (dataTable[row]) {
                            break;
                        }
                        row++;
                    }
                    if (row < rowCount) {
                        return row;
                    }
                    return -1;
                };
                _SheetModel.prototype._nextNonNullColumn = function (row, col) {
                    var self = this;
                    var dr = keyword_null;
                    var colCount = self._colCount;
                    if (row >= 0 && row < self._rowCount) {
                        dr = self.dataTable[row];
                    }
                    if (dr) {
                        col++;
                        while (col >= 0 && col < colCount) {
                            if (dr[col]) {
                                break;
                            }
                            col++;
                        }
                        if (col < colCount) {
                            return col;
                        }
                    }
                    return -1;
                };
                _SheetModel.prototype._clearValues = function (src) {
                    var row = src.row;
                    var col = src.col;
                    var rowCount = src.rowCount;
                    var colCount = src.colCount;
                    var self = this;
                    for (var r = row, i = 0; i < rowCount; i++, r++) {
                        for (var c = col, j = 0; j < colCount; j++, c++) {
                            var node = self._getNode(r, c);
                            if (node) {
                                node.value = keyword_null;
                            }
                        }
                    }
                };
                _SheetModel.prototype._getFormatString = function (row, col, sheet) {
                    var formatter = sheet && sheet.getFormatter(row, col);
                    if (isformatString(formatter)) {
                        return formatter;
                    }
                    return false;
                };
                _SheetModel.prototype.clear = function (row, column, rowCount, columnCount, type, ignoredRowList, changeInfos) {
                    var self = this;
                    var oldRowCount = self._rowCount;
                    var oldColCount = self._colCount;
                    var nodes = [];
                    var node, c, r;
                    var needChangeInfo = !!changeInfos;
                    var pathsArray = [];
                    var paths;
                    if (row >= 0 && column >= 0) {
                        rowCount = Math_min(rowCount, oldRowCount - row);
                        columnCount = Math_min(columnCount, oldColCount - column);
                        if (rowCount > 0 && columnCount > 0) {
                            for (r = row; r < row + rowCount; r++) {
                                if (!ignoredRowList || Common_1.Common._ArrayHelper._indexOf(ignoredRowList, r) < 0) {
                                    for (c = column; c < column + columnCount; c++) {
                                        if (needChangeInfo) {
                                            paths = [];
                                        }
                                        node = self._getNode(r, c, keyword_undefined, paths);
                                        if (node) {
                                            nodes.push(node);
                                            if (needChangeInfo) {
                                                pathsArray.push(paths);
                                            }

                                            if ((type & 1) > 0 && !isNullOrUndefined(node.value)) {
                                                var dirtyChangeInfo = void 0;
                                                if (needChangeInfo) {
                                                    dirtyChangeInfo = {};
                                                }
                                                self._updateDirty(r, c, { _oldValue: node.value }, dirtyChangeInfo);
                                                if (dirtyChangeInfo) {
                                                    changeInfos.push(dirtyChangeInfo);
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    } else if (row >= 0 && column === -1) {
                        rowCount = Math_min(rowCount, oldRowCount - row);
                        if (rowCount > 0) {
                            for (r = row; r < row + rowCount; r++) {
                                if (needChangeInfo) {
                                    paths = [];
                                }
                                node = self._getNode(r, -1, keyword_undefined, paths);
                                if (node) {
                                    nodes.push(node);
                                    if (needChangeInfo) {
                                        pathsArray.push(paths);
                                    }
                                }
                            }
                        }
                    } else if (row === -1 && column >= 0) {
                        columnCount = Math_min(columnCount, oldColCount - column);
                        if (columnCount > 0) {
                            for (c = column; c < column + columnCount; c++) {
                                if (needChangeInfo) {
                                    paths = [];
                                }
                                node = self._getNode(-1, c, keyword_undefined, paths);
                                if (node) {
                                    nodes.push(node);
                                    if (needChangeInfo) {
                                        pathsArray.push(paths);
                                    }
                                }
                            }
                        }
                    } else if (row === -1 && column === -1) {
                        if (needChangeInfo) {
                            paths = [];
                        }
                        node = self._getNode(-1, -1, keyword_undefined, paths);
                        if (node) {
                            nodes.push(node);
                            if (needChangeInfo) {
                                pathsArray.push(paths);
                            }
                        }
                    }
                    var _loop_1 = function (i) {
                        node = nodes[i];
                        if (node) {
                            var propertyNameOldValueArray = needChangeInfo ? [] : keyword_undefined;
                            if ((type & 8) > 0) {
                                if (propertyNameOldValueArray) {
                                    propertyNameOldValueArray.push(['tag', node.tag]);
                                }
                                node.tag = keyword_null;
                            }
                            if ((type & 2) > 0) {
                                if (propertyNameOldValueArray) {
                                    propertyNameOldValueArray.push(['style', node.style]);
                                }
                                node.style = keyword_null;
                            }
                            if ((type & 1) > 0) {
                                if (propertyNameOldValueArray) {
                                    propertyNameOldValueArray.push(['value', node.value]);
                                }
                                node.value = keyword_null;
                            }
                            if ((type & 16) > 0) {
                                if (propertyNameOldValueArray) {
                                    propertyNameOldValueArray.push(['sparkline', node.sparkline]);
                                }
                                node.sparkline = keyword_null;
                            }
                            if ((type & 64) > 0) {
                                if (propertyNameOldValueArray) {
                                    propertyNameOldValueArray.push(['bindingPath', node.bindingPath]);
                                }
                                node.bindingPath = keyword_null;
                            }
                            if ((type & 256) > 0) {
                                if (propertyNameOldValueArray) {
                                    propertyNameOldValueArray.push(['hyperlink', node.hyperlink]);
                                }
                                node.hyperlink = keyword_null;
                            }
                            if ((type & 4) > 0) {
                                if (propertyNameOldValueArray) {
                                    propertyNameOldValueArray.push(['comment', node.comment]);
                                }
                                node.comment = keyword_null;
                            }
                            if (needChangeInfo) {
                                propertyNameOldValueArray.forEach(function (propertyNameOldValue) {
                                    var tmp = [].concat(pathsArray[i]);
                                    tmp.push(propertyNameOldValue[0]);
                                    propertyNameOldValue[0] = tmp;
                                    changeInfos.push(propertyNameOldValue);
                                });
                            }
                        }
                    };
                    for (var i = 0; i < nodes.length; i++) {
                        _loop_1(i);
                    }
                };
                _SheetModel.prototype.toJSON = function (sheetArea, serializationOption, sheet) {
                    var needJudgeFormatString = sheet && sheet.parent && !$_isEmptyObject(sheet.parent._formatStringCustomNameInfos);
                    function _toJSONNode(row, col, node, sheetArea, checkDefaultValue, formatString) {
                        if (!node) {
                            return keyword_null;
                        }
                        var jsonNode = {};
                        var nodeValue = node.value;
                        if (!isNullOrUndefined(nodeValue)) {
                            jsonNode.value = nodeValue;
                        }
                        if (serializationOption && serializationOption.saveAsView) {
                            var formatter = void 0;
                            if (formatString) {
                                formatter = formatString;
                            } else if (needJudgeFormatString) {
                                formatter = sheet && sheet.getFormatter(row, col);
                            }
                            if (isformatString(formatter)) {
                                var formatStringResult = sheet._getFormatStringResult(row, col, formatter, nodeValue);
                                if (!isNullOrUndefined(formatStringResult)) {
                                    jsonNode.value = formatStringResult;
                                }
                            }
                        }
                        var ignoreStyle = serializationOption && serializationOption.ignoreStyle;
                        if (!ignoreStyle) {
                            var nodeStyle = node.style;
                            if (typeof nodeStyle === 'string') {
                                jsonNode.style = nodeStyle;
                            } else if (nodeStyle) {
                                var style = nodeStyle.toJSON(sheetArea, checkDefaultValue);
                                if (style) {
                                    style.name = keyword_undefined;

                                    style.fontForColumnWidth = nodeStyle.fontForColumnWidth;
                                    jsonNode.style = style;
                                }
                            }
                        }
                        var nodeBindingPath = node.bindingPath;
                        if (!isNullOrUndefined(nodeBindingPath)) {
                            jsonNode.bindingPath = nodeBindingPath;
                        }
                        var nodeTag = node.tag;
                        if (!isNullOrUndefined(nodeTag)) {
                            jsonNode.tag = nodeTag;
                        }
                        var nodeHyperlink = node.hyperlink;
                        if (!isNullOrUndefined(nodeHyperlink)) {
                            jsonNode.hyperlink = cloneObj(nodeHyperlink);
                            delete jsonNode.hyperlink.isVisited;
                        }
                        return jsonNode;
                    }
                    var self = this;
                    var jsonData = {};
                    var ndata = {};
                    var rowCount = self._rowCount;
                    var colCount = self._colCount;
                    var dataTable = self.dataTable;
                    var rowData = self.rowDataArray;
                    var colData = self.columnDataArray;
                    var r, c;
                    if (serializationOption && serializationOption.saveAsView) {
                        var row = 0;
                        while (row < rowCount) {
                            var ndr = {};
                            var hasRowData = false;
                            var dr = dataTable[row];
                            var col = 0;
                            while (col < colCount) {
                                var ndc = {};
                                if (dr && dr[col] || colData[col]) {
                                    ndc = _toJSONNode(row, col, self._getNode(row, col, true));
                                } else if (sheetArea === 3 && needJudgeFormatString) {
                                    var formatter = this._getFormatString(row, col, sheet);
                                    if (formatter) {
                                        ndc = _toJSONNode(row, col, self._getNode(row, col, true), 3, false, formatter);
                                    }
                                }
                                if (!$_isEmptyObject(ndc)) {
                                    ndr[col] = ndc;
                                    hasRowData = true;
                                }
                                col++;
                            }
                            if (hasRowData) {
                                ndata[row] = ndr;
                            }
                            row++;
                        }
                    } else {
                        r = self._nextNonNullRow(-1);
                        while (r >= 0) {
                            var ndr = {};
                            var hasRowData = false;
                            c = self._nextNonNullColumn(r, -1);
                            while (c >= 0) {
                                var node = self._getNode(r, c);
                                if (node) {
                                    var ndc = _toJSONNode(r, c, node);
                                    if (!$_isEmptyObject(ndc)) {
                                        ndr[c] = ndc;
                                        hasRowData = true;
                                    }
                                }
                                c = self._nextNonNullColumn(r, c);
                            }
                            if (hasRowData) {
                                ndata[r] = ndr;
                            }
                            r = self._nextNonNullRow(r);
                        }
                    }
                    if (!$_isEmptyObject(ndata)) {
                        jsonData.dataTable = ndata;
                    }
                    var nRowData = [];
                    for (r = 0; r < rowCount; r++) {
                        if (_hasOwnProperty(rowData, r) && rowData[r]) {
                            var rowDataJSON = _toJSONNode(r, -1, rowData[r]);
                            if (!$_isEmptyObject(rowDataJSON)) {
                                nRowData[r] = rowDataJSON;
                            }
                        }
                    }
                    if (nRowData.length > 0) {
                        jsonData.rowDataArray = nRowData;
                    }
                    var nColData = [];
                    for (c = 0; c < colCount; c++) {
                        if (_hasOwnProperty(colData, c) && colData[c]) {
                            var colDataJSON = _toJSONNode(-1, c, colData[c]);
                            if (!$_isEmptyObject(colDataJSON)) {
                                nColData[c] = colDataJSON;
                            }
                        }
                    }
                    if (nColData.length > 0) {
                        jsonData.columnDataArray = nColData;
                    }
                    var defaultDataNode = _toJSONNode(-1, -1, self.defaultDataNode, sheetArea, true);
                    if (!$_isEmptyObject(defaultDataNode)) {
                        jsonData.defaultDataNode = defaultDataNode;
                    }
                    return jsonData;
                };
                _SheetModel.prototype.fromJSON = function (setting, noSchema, options, area, callback) {
                    var incrementalLoading = options && options.incrementalLoading;
                    if (!setting) {
                        incrementalLoading && callback && setTimeout(callback, 0);
                        return;
                    }
                    var self = this;
                    self._init();
                    self._dirtySuspended++;
                    var data = setting.dataTable, r, c;
                    var rowCount = self._rowCount;
                    var colCount = self._colCount;
                    var dr, node;
                    if (data) {
                        if (incrementalLoading && area === 3) {
                            loadCellDataAsync(self, data, rowCount, colCount, options, noSchema, keyword_undefined, callback);
                        } else {
                            loadCellData(self, data, rowCount, colCount, options, noSchema);
                        }
                    } else if (incrementalLoading) {
                        callback && setTimeout(callback, 0);
                    }
                    var rowData = setting.rowDataArray || setting._rowDataArray;
                    if (rowData) {
                        for (r = 0; r < rowCount; r++) {
                            if (_hasOwnProperty(rowData, r) && rowData[r]) {
                                _copyFromJSONNode(rowData[r], self._getNode(r, -1, true), noSchema, r, -1, options);
                            }
                        }
                    }
                    var colData = setting.columnDataArray || setting._columnDataArray;
                    if (colData) {
                        for (c = 0; c < colCount; c++) {
                            if (_hasOwnProperty(colData, c) && colData[c]) {
                                _copyFromJSONNode(colData[c], self._getNode(-1, c, true), noSchema, -1, c, options);
                            }
                        }
                    }
                    var defDataNode = setting.defaultDataNode || setting._defaultDataNode;
                    if (defDataNode) {
                        _copyFromJSONNode(defDataNode, self._getNode(-1, -1, true), noSchema, -1, -1, options);
                    }
                    self._dirtySuspended--;
                };
                return _SheetModel;
            }());
            var _AxisModel = (function () {
                function _AxisModel() {
                    this.infos = [];
                }
                _AxisModel.prototype._getInfo = function (index, create) {
                    var infos = this.infos;
                    var info = infos[index];
                    if (!info && create) {
                        info = infos[index] = {};
                    }
                    return info;
                };
                _AxisModel.prototype._addItems = function (index, count) {
                    var infos = this.infos, length = infos.length;
                    if (0 <= index && index <= length && count > 0) {
                        addElements(infos, length, index, count);
                    }
                };
                _AxisModel.prototype._deleteItems = function (index, count, changes) {
                    var infos = this.infos, length = infos.length;
                    if (0 <= index && index < length && count > 0) {
                        count = Math_min(count, length - index);
                        if (changes) {
                            for (var i = 0; i < count; i++) {
                                var tmpIndex = index + i;
                                changes.push([['infos', tmpIndex], infos[tmpIndex]]);
                            }
                        }
                        deleteElements(infos, length, index, count);
                    }
                };
                _AxisModel.prototype._getItemCount = function () {
                    return this.infos.length;
                };
                _AxisModel.prototype._getItems = function () {
                    return this.infos;
                };
                _AxisModel.prototype._getItem = function (index) {
                    return this.infos[index];
                };
                _AxisModel.prototype._setItem = function (index, item, changeInfo) {
                    var oldItem = this.infos[index];
                    this.infos[index] = item;
                    if (changeInfo) {
                        changeInfo[0].push('infos', index);
                        changeInfo[1] = oldItem;
                    }
                };
                _AxisModel.prototype.getSize = function (index) {
                    var info = this.infos[index];
                    var size = keyword_null;
                    if (info) {
                        if (info.visible === false) {
                            size = 0;
                        } else if (typeof info.size === 'number') {
                            size = Math_floor(info.size);
                        }
                    }
                    return size;
                };
                _AxisModel.prototype.getActualSize = function (index) {
                    var info = this.infos[index];
                    return info ? Math_floor(info.size) : keyword_null;
                };
                _AxisModel.prototype.setSize = function (index, value, changeInfo) {
                    var info = this._getInfo(index, true);
                    var oldSize = info.size;
                    if (oldSize !== value) {
                        info.size = value;
                    }
                    if (changeInfo) {
                        changeInfo[0].push('infos', index, 'size');
                        changeInfo[1] = oldSize;
                    }
                };
                _AxisModel.prototype.getStarSize = function (index) {
                    var info = this.infos[index];
                    if (info) {
                        return info.starSize;
                    }
                    return keyword_undefined;
                };
                _AxisModel.prototype.setStarSize = function (index, value, changeInfo) {
                    var info = this._getInfo(index, true);
                    var oldSize = info.starSize;
                    if (isNullOrUndefined(value) && isNullOrUndefined(oldSize)) {
                        return;
                    }
                    if (oldSize !== value) {
                        if (isNullOrUndefined(value)) {
                            delete info.starSize;
                        } else {
                            info.starSize = value;
                        }
                    }
                    if (changeInfo) {
                        changeInfo[0].push('infos', index, 'starSize');
                        changeInfo[1] = oldSize;
                    }
                };
                _AxisModel.prototype.toJSON = function (serializationOption) {
                    var infos = this.infos;
                    var array = [];
                    if (serializationOption && serializationOption.ignoreStarSize) {
                        for (var i = 0; i < infos.length; i++) {
                            if (!isNullOrUndefined(infos[i])) {
                                var _a = infos[i];
                                var cellType = _a.cellType;
                                var others = __rest(_a, ['cellType']);
                                array[i] = cloneObj(others);
                                if (cellType) {
                                    if (cellType.toJSON) {
                                        cellType = cellType.toJSON();
                                    }
                                    var dict = celltype_ns_1._typeDict;
                                    var typeName = cellType.typeName;
                                    var celltypeClass = dict[cellType.type] || dict[typeName] || util_common.getTypeFromString(typeName);
                                    if (celltypeClass) {
                                        var resultCellType = new celltypeClass();
                                        resultCellType.fromJSON(cellType, serializationOption);
                                        array[i].cellType = resultCellType;
                                    }
                                }
                                delete array[i].starSize;
                            }
                        }
                    } else {
                        for (var i = 0; i < infos.length; i++) {
                            if (!isNullOrUndefined(infos[i])) {
                                array[i] = infos[i];
                            }
                        }
                    }
                    return array.length > 0 ? array : keyword_undefined;
                };
                _AxisModel.prototype.fromJSON = function (setting) {
                    if (setting) {
                        this.infos = setting;
                    }
                };
                return _AxisModel;
            }());
            var _AxisModel_prototype = _AxisModel.prototype;
            $_each({ visible: true, resizable: true, pageBreak: false }, function (p, v) {
                var partOfName = p[0].toUpperCase() + p.substr(1);
                _AxisModel_prototype['get' + partOfName] = function (index) {
                    var result = v;
                    var info = this.infos[index];
                    if (info && !isNullOrUndefined(info[p])) {
                        result = info[p];
                    }
                    return result;
                };
                _AxisModel_prototype['set' + partOfName] = function (index, value, changeInfo) {
                    var info = this._getInfo(index, true);
                    var oldValue = info[p];
                    if (oldValue !== value) {
                        info[p] = value;
                    }
                    if (changeInfo) {
                        changeInfo[0].push('infos', index, p);
                        changeInfo[1] = oldValue;
                    }
                };
            });
            function _copyFromJSONNode(node, targetNode, noSchema, row, col, options) {
                if (node) {
                    var nodeValue = node.value;
                    if (nodeValue !== keyword_undefined) {
                        nodeValue = nodeValue;
                        if (nodeValue !== keyword_null && (nodeValue._calcError || nodeValue._error && !isNullOrUndefined(nodeValue._code))) {
                            var value = _supportsCalc && CalcEngine_1.CalcError.parse(nodeValue._calcError || nodeValue._error);
                            if (value !== keyword_undefined) {
                                value = tryAddCacheToRichText(value);
                                nodeValue = value;
                            }
                        }
                        targetNode.value = nodeValue;
                    }
                    var nodeStyle = node.style;
                    var sheet = options && options.sheet;
                    if (nodeStyle !== keyword_undefined && !options.ignoreStyle) {
                        var style = keyword_null;
                        if (typeof (nodeStyle) === const_string) {
                            targetNode.style = nodeStyle;
                            style = sheet && (sheet._getNamedStyleImp(nodeStyle, false) || sheet.parent && sheet.parent._getNamedStyleImp(nodeStyle, false));
                        } else if (nodeStyle) {
                            style = new style_1.Style();
                            style.fromJSON(nodeStyle, noSchema);

                            style.name = keyword_undefined;
                            targetNode.style = style;
                        }
                        style && style.validator && options && options.setValidator && options.setValidator(row, col, style.validator);
                    }
                    var nodeVisualState = node.visualState;
                    if (nodeVisualState !== keyword_undefined) {
                        targetNode.visualState = nodeVisualState;
                    }
                    var nodeBindingPath = node.bindingPath;
                    if (nodeBindingPath !== keyword_undefined) {
                        targetNode.bindingPath = nodeBindingPath;
                    }
                    var tagObj = node.tag;
                    if (tagObj !== keyword_undefined) {
                        var typeName = tagObj.typeName;
                        if (typeof typeName === const_string) {
                            var tagClass = util_common.getTypeFromString(typeName);
                            if (tagClass) {
                                tagObj = new tagClass();
                                if (tagObj.fromJSON) {
                                    tagObj.fromJSON(node.tag);
                                }
                            }
                        }
                        targetNode.tag = tagObj;
                    }
                    var hyperlink = node.hyperlink;
                    if (hyperlink !== keyword_undefined) {
                        targetNode.hyperlink = cloneObj(hyperlink);
                    }
                }
            }
            var DEFAULT_ROW_HEIGHT = 20;
            var DEFAULT_COL_WIDTH = 62;
            var DEFAULT_ROW_HEADER_COL_WIDTH = 46;
            var DEFAULT_COL_HEADER_ROW_HEIGHT = 24;
            function undoChange(root, change) {
                var paths = change[0];
                var node = root;
                var i = 0;
                for (; i < paths.length - 1; i++) {
                    var propName = paths[i];
                    if (propName === UNDERSCORE_DIRTY_NODES) {
                        node = node._dirtyNodes;
                    } else {
                        if (!node[propName]) {
                            node[propName] = {};
                        }
                        node = node[propName];
                    }
                }
                node[paths[i]] = change[1];
                var changeType = paths[paths.length - 1];
                var type, index = paths[paths.length - 2];
                var sheetArea = paths[1];
                if (changeType === 'size') {
                    type = paths[0] === ROW_INFOS_TEXT ? core_enum_1.AxisInfoChangeType.setRowHeight : core_enum_1.AxisInfoChangeType.setColumnWidth;
                } else if (changeType === 'visible') {
                    type = paths[0] === ROW_INFOS_TEXT ? core_enum_1.AxisInfoChangeType.setRowVisible : core_enum_1.AxisInfoChangeType.setColumnVisible;
                }
                if (!isNullOrUndefined(type)) {
                    root._updateAxisInfoCache({
                        type: type,
                        index: index,
                        sheetArea: sheetArea
                    });
                }
            }
            function setSelectionPolicyOrUnit(context, key, value) {
                var changeInfo = context._inTransaction > 0 ? [['selectionModel'], keyword_undefined] : keyword_undefined;
                context.selectionModel.setProperty(key, value, changeInfo);
                if (changeInfo) {
                    context._changes.push(changeInfo);
                }
            }
            function updateItemInfo(target, row, col, value, removeItem) {
                if (removeItem === void 0) { removeItem = false; }
                var rowItem = target[row];
                if (removeItem) {
                    if (rowItem) {
                        delete rowItem[col];
                    }
                    return;
                }
                if (!rowItem) {
                    rowItem = target[row] = {};
                }
                rowItem[col] = value;
            }
            function setCacheValue(valueCache, row, col, value) {
                updateItemInfo(valueCache, row, col, { value: value });
            }
            function setValueInfo(setValueInfos, row, col, value, oldValue, isAnchorCell) {
                updateItemInfo(setValueInfos, row, col, { value: value, oldValue: oldValue, isAnchorCell: isAnchorCell });
            }
            function getCachedValue(valueCache, row, col, sheetSource) {
                var rowItem = valueCache[row];
                var item = rowItem && rowItem[col];
                if (item) {
                    return item.value;
                }
                var value = sheetSource.getValue(row, col);
                setCacheValue(valueCache, row, col, value);
                return value;
            }
            function getKey(row, col) {
                return [row, col].join(',');
            }
            function addToArray(array, item) {
                if (array.indexOf(item) === -1) {
                    array.push(item);
                }
            }
            function fillArray(item, len) {
                var array = new Array(len);
                for (var i = 0; i < len; i++) {
                    array[i] = item;
                }
                return array;
            }
            function getItem(array, row, col) {
                var item = array[row];
                return item && item[col];
            }
            function getItemByKey(array, key) {
                var _a = key.split(',').map(function (s) {
                    return +s;
                });
                var row = _a[0];
                var col = _a[1];
                var item = array[row];
                return item && item[col];
            }
            function deleteItem(array, row, col, removeEmptyItem) {
                var item = array[row];
                if (item) {
                    delete item[col];
                }
                if (removeEmptyItem && $_isEmptyObject(item)) {
                    delete array[row];
                }
            }

            var MAXCELLS = 500000;
            var _DynamicArrayManager = (function () {
                function _DynamicArrayManager(modelManager) {
                    this.modelManager = modelManager;
                    this.anchors = {};
                    this.cells = {};
                    this.invalidAnchors = {};
                }
                _DynamicArrayManager.prototype._dispose = function () {
                    this.modelManager = keyword_null;
                };
                _DynamicArrayManager.prototype.getAnchorCell = function (row, col) {
                    return getItem(this.anchors, row, col);
                };
                _DynamicArrayManager.prototype.getAnchorItem = function (row, col) {
                    return getItem(this.cells, row, col);
                };
                _DynamicArrayManager.prototype.getAnchorInfo = function (row, col, ignoreState) {
                    var self = this, anchors = self.anchors;
                    var anchor = self.getAnchorCell(row, col);
                    if (anchor) {
                        return anchor;
                    }
                    var cell = self.getAnchorItem(row, col);
                    if (cell) {
                        var anchorRefs = cell.anchorRefs;
                        for (var refKey in anchorRefs) {
                            if (anchorRefs[refKey]) {
                                var refAnchor = getItemByKey(anchors, refKey);
                                if (ignoreState || refAnchor.isValid) {
                                    return refAnchor;
                                }
                            }
                        }
                    }
                };
                _DynamicArrayManager.prototype.isCellHasItsOwnValue = function (row, col, key) {
                    var self = this;
                    var cell = self.getAnchorItem(row, col);
                    if (cell) {
                        if (!isNullOrUndefined(cell.value) || cell._setBy) {
                            return true;
                        }
                        var anchorRefs = cell.anchorRefs;
                        var anchors = self.anchors;
                        for (var refKey in anchorRefs) {
                            if (key !== refKey && anchorRefs[refKey]) {
                                var anchor = getItemByKey(anchors, refKey);
                                if (anchor && anchor.isValid) {
                                    return true;
                                }
                            }
                        }
                    }
                    return false;
                };
                _DynamicArrayManager.prototype.removeRef = function (sheetSource, anchor, key, setValueInfos, valueCache, removeEmptyItem) {
                    var self = this;
                    var cells = self.cells;
                    var isValid = anchor.isValid;
                    var baseRow = anchor.row;
                    var baseCol = anchor.col;
                    var rowCount = anchor.rowCount;
                    var colCount = anchor.colCount;
                    var c = 1;
                    for (var r = 0, row = baseRow; r < rowCount; r++, row++) {
                        for (var col = baseCol + c; c < colCount; c++, col++) {
                            var item = getItem(cells, row, col);
                            var anchorRefs = item && item.anchorRefs;
                            var isSingleRef = true;
                            if (isValid) {
                                var oldValue = sheetSource.getValue(row, col);
                                var value = item && item.value;
                                if (isNullOrUndefined(value)) {
                                    var setBy = item && item._setBy;
                                    var needClearValue = !setBy || setBy === key;
                                    if (anchorRefs) {
                                        for (var refKey in anchorRefs) {
                                            if (refKey !== key && anchorRefs[refKey]) {
                                                isSingleRef = false;
                                                break;
                                            }
                                        }
                                    }
                                    if (needClearValue) {
                                        setValueInfo(setValueInfos, row, col, keyword_null, oldValue, anchor.row === row && anchor.col === col);
                                    } else {
                                        value = oldValue;
                                    }
                                }
                                valueCache && setCacheValue(valueCache, row, col, value);
                            }
                            if (anchorRefs) {
                                delete anchorRefs[key];
                                if (isSingleRef && removeEmptyItem && $_isEmptyObject(anchorRefs)) {
                                    deleteItem(cells, row, col, true);
                                }
                            }
                        }
                        c = 0;
                    }
                };
                _DynamicArrayManager.prototype._getIsAllowSpill = function (sheetSource, row, col, rowCount, colCount) {
                    var sheetRowCount = sheetSource.getRowCount();
                    var sheetColCount = sheetSource.getColumnCount();
                    if (row + rowCount > sheetRowCount || col + colCount > sheetColCount) {
                        return false;
                    }
                    if (rowCount * colCount > MAXCELLS) {
                        return false;
                    }
                    var sheet = sheetSource.getSheet();
                    var range = common_1._createRange(row, col, rowCount, colCount);
                    if (sheet._modelManager.getSpans(range).length) {
                        return false;
                    }
                    var tables = sheet.tables;
                    if (tables && tables._has && tables._has(row, col, rowCount, colCount)) {
                        return false;
                    }
                    return true;
                };
                _DynamicArrayManager.prototype.setArray = function (sheetSource, row, col, rowCount, colCount, values, forceSpill) {
                    var self = this;
                    var key = getKey(row, col);
                    var anchors = self.anchors;
                    var anchor = getItem(anchors, row, col);
                    var cells = self.cells;
                    if (anchor && !values) {
                        var _a = self.updateItem(sheetSource, row, col);
                        var valueInfos = _a[0];
                        var dirtyAnchors = _a[1];
                        return [anchor, valueInfos, dirtyAnchors];
                    }
                    var setValueInfos = {};
                    var valueCache = {};
                    var withRemove = false;
                    if (anchor && anchor.isValid) {
                        withRemove = true;
                        self.removeRef(sheetSource, anchor, key, setValueInfos, valueCache, true);
                    }
                    var oldAnchor = anchor;
                    anchor = {
                        row: row,
                        col: col,
                        rowCount: rowCount,
                        colCount: colCount,
                        values: values,
                        isValid: false
                    };
                    updateItemInfo(anchors, row, col, anchor);
                    var timestamp = sheetSource.getCalcService()._timestamp;
                    anchor._timestamp = timestamp;
                    var isVolatileSize = oldAnchor && oldAnchor._timestamp === timestamp && (rowCount !== oldAnchor.rowCount || colCount !== oldAnchor.colCount);
                    var isFromJSON = sheetSource._isFromJSON;
                    var isInvalid = isFromJSON && getItem(self.invalidAnchors, row, col);
                    if (isInvalid) {
                        setValueInfo(setValueInfos, row, col, _supportsCalc && CalcEngine_1.Errors.Spill, keyword_null, anchor.row === row && anchor.col === col);
                        self._initAnchorItems(row, col, rowCount, colCount, cells, isFromJSON, valueCache, sheetSource, key, true);
                    } else if (values) {
                        var oldValue = getCachedValue(valueCache, row, col, sheetSource);
                        var allowSpill = !isVolatileSize && self._getIsAllowSpill(sheetSource, row, col, rowCount, colCount);
                        if (allowSpill) {
                            self._initAnchorItems(row, col, rowCount, colCount, cells, isFromJSON, valueCache, sheetSource, key);
                            if (!isFromJSON && !forceSpill) {
                                var c = 1;
                                for (var r = 0, currentRow = row; r < rowCount; r++, currentRow++) {
                                    for (var currentColumn = col + c; c < colCount; c++, currentColumn++) {
                                        var currentValue = getCachedValue(valueCache, currentRow, currentColumn, sheetSource);
                                        if (!isNullOrUndefined(currentValue) && self.isCellHasItsOwnValue(currentRow, currentColumn, key)) {
                                            allowSpill = false;
                                            if (withRemove) {
                                                updateItemInfo(setValueInfos, currentRow, currentColumn, currentValue, true);
                                            } else {
                                                break;
                                            }
                                        }
                                    }
                                    if (!withRemove && !allowSpill) {
                                        break;
                                    }
                                    c = 0;
                                }
                            }
                        }
                        if (allowSpill) {
                            for (var r = 0, currentRow = row; r < rowCount; r++, currentRow++) {
                                var arrayItem = values[r];
                                for (var c = 0, currentColumn = col; c < colCount; c++, currentColumn++) {
                                    var currentValue = getCachedValue(valueCache, currentRow, currentColumn, sheetSource);
                                    var t = arrayItem && arrayItem[c], value = t;
                                    if (isNullOrUndefined(t)) {
                                        value = 0;
                                    } else if (_supportsCalc && (CalcEngine_1.Convert._isArray(t) || CalcEngine_1.Convert._isReference(t))) {
                                        if (t.getRowCount() === 1 && t.getColumnCount() === 1) {
                                            if (CalcEngine_1.Convert._isArray(t)) {
                                                value = t.getValue(0, 0);
                                            } else {
                                                value = t.getValue(0, 0, 0);
                                            }
                                        } else {
                                            value = CalcEngine_1.Errors.Calc;
                                        }
                                    }
                                    setValueInfo(setValueInfos, currentRow, currentColumn, value, currentValue, anchor.row === currentRow && anchor.col === currentColumn);
                                    if (r || c) {
                                        getItem(cells, currentRow, currentColumn)._setBy = key;
                                    }
                                }
                            }
                        } else {
                            setValueInfo(setValueInfos, row, col, _supportsCalc && CalcEngine_1.Errors.Spill, oldValue, anchor.row === row && anchor.col === col);
                        }
                        anchor.isValid = allowSpill;
                        if (oldAnchor && allowSpill !== oldAnchor.isValid) {
                            self.modelManager._backupAnchorCellState(row, col, !allowSpill);
                        }
                    }
                    return [anchor, setValueInfos, [oldAnchor]];
                };
                _DynamicArrayManager.prototype._initAnchorItems = function (row, col, rowCount, colCount, cells, isFromJSON, valueCache, sheetSource, key, isForSpillErrorAnchor) {
                    var c = 1;
                    for (var r = 0; r < rowCount; r++) {
                        var currentRow = row + r;
                        for (; c < colCount; c++) {
                            var currentCol = col + c;
                            var cell = !isForSpillErrorAnchor && getItem(cells, currentRow, currentCol);
                            if (!cell) {
                                cell = { anchorRefs: {} };
                                if (!isFromJSON || isForSpillErrorAnchor) {
                                    cell.value = getCachedValue(valueCache, currentRow, currentCol, sheetSource);
                                }
                                updateItemInfo(cells, currentRow, currentCol, cell);
                            }
                            cell.anchorRefs[key] = true;
                        }
                        c = 0;
                    }
                };
                _DynamicArrayManager.prototype.updateItem = function (sheetSource, row, col, value, setValueInfos, dirtyAnchors) {
                    if (setValueInfos === void 0) {
                        setValueInfos = {};
                    }
                    if (dirtyAnchors === void 0) {
                        dirtyAnchors = [];
                    }
                    var key = getKey(row, col);
                    var self = this;
                    var anchors = self.anchors;
                    var anchor = getItem(anchors, row, col);
                    if (anchor) {
                        self.removeRef(sheetSource, anchor, key, setValueInfos, keyword_undefined, true);
                        deleteItem(setValueInfos, row, col);
                        deleteItem(anchors, row, col, true);
                    }
                    var cells = self.cells;
                    var cell = getItem(cells, row, col);
                    if (cell) {
                        self.modelManager._backupAnchorItemState(row, col, cell.value);
                        cell.value = value;
                        delete cell._setBy;
                        var anchorRefs = cell.anchorRefs;
                        for (var refKey in anchorRefs) {
                            if (anchorRefs[refKey]) {
                                var refAnchor = getItemByKey(anchors, refKey);
                                addToArray(dirtyAnchors, refAnchor);
                            }
                        }
                    }
                    if (anchor || cell) {
                        return [anchor && setValueInfos, dirtyAnchors];
                    }
                };
                _DynamicArrayManager.prototype._setInvalidState = function (row, col) {
                    updateItemInfo(this.invalidAnchors, row, col, true);
                };
                _DynamicArrayManager.prototype._clearDynamicArrayState = function () {
                    this.invalidAnchors = {};
                };
                _DynamicArrayManager.prototype._onAddRemoveRows = function (sheetSource, row, rowCount) {
                    var self = this;
                    var anchors = self.anchors;
                    var changedItems = [];
                    for (var rowKey in anchors) {
                        if (anchors.hasOwnProperty(rowKey)) {
                            var r = +rowKey;
                            var toBeMoved = r >= row;
                            var rowItem = anchors[rowKey];
                            for (var colKey in rowItem) {
                                if (rowItem.hasOwnProperty(colKey)) {
                                    var c = +colKey;
                                    if (!toBeMoved) {
                                        var anchor = rowItem[colKey];
                                        toBeMoved = anchor && anchor.rowCount + r >= row;
                                    }
                                    if (toBeMoved) {
                                        changedItems.push([r, c]);
                                    }
                                }
                            }
                        }
                    }
                    if (changedItems.length) {
                        changedItems.forEach(function (t) {
                            self.updateItem(sheetSource, t[0], t[1], keyword_undefined);
                        });
                    }
                };
                _DynamicArrayManager.prototype._addRows = function (sheetSource, row, rowCount) {
                    this._onAddRemoveRows(sheetSource, row, rowCount);
                };
                _DynamicArrayManager.prototype._removeRows = function (sheetSource, row, rowCount) {
                    this._onAddRemoveRows(sheetSource, row, rowCount);
                };
                _DynamicArrayManager.prototype._onAddRemoveColumns = function (sheetSource, col) {
                    var self = this;
                    var anchors = self.anchors;
                    var changedItems = [];
                    for (var rowKey in anchors) {
                        if (anchors.hasOwnProperty(rowKey)) {
                            var r = +rowKey;
                            var rowItem = anchors[rowKey];
                            for (var colKey in rowItem) {
                                if (rowItem.hasOwnProperty(colKey)) {
                                    var c = +colKey;
                                    var toBeMoved = c >= col;
                                    if (!toBeMoved) {
                                        var anchor = rowItem[colKey];
                                        toBeMoved = anchor && anchor.colCount + c >= col;
                                    }
                                    if (toBeMoved) {
                                        changedItems.push([r, c]);
                                    }
                                }
                            }
                        }
                    }
                    if (changedItems.length) {
                        changedItems.forEach(function (t) {
                            self.updateItem(sheetSource, t[0], t[1], keyword_undefined);
                        });
                    }
                };
                _DynamicArrayManager.prototype._addColumns = function (sheetSource, col, colCount) {
                    this._onAddRemoveColumns(sheetSource, col);
                };
                _DynamicArrayManager.prototype._removeColumns = function (sheetSource, col, colCount) {
                    this._onAddRemoveColumns(sheetSource, col);
                };
                return _DynamicArrayManager;
            }());
            exports._DynamicArrayManager = _DynamicArrayManager;
            function clearSpillValuesOnAddRemove(modelManager, index, count, isInsert, isRow) {
                var sheetModel = modelManager._getSheetModel(3);
                var dynamicArrayManager = modelManager._dynamicArrayManager;
                var anchors = dynamicArrayManager.anchors;
                var dirtyAnchors = [];
                for (var rowKey in anchors) {
                    if (anchors.hasOwnProperty(rowKey)) {
                        var rowItem = anchors[rowKey];
                        if (rowItem) {
                            for (var colKey in rowItem) {
                                if (rowItem.hasOwnProperty(colKey)) {
                                    var anchor = rowItem[colKey];
                                    if (anchor) {
                                        var row = anchor.row;
                                        var col = anchor.col;
                                        var rowCount = anchor.rowCount;
                                        var colCount = anchor.colCount;
                                        if ((isRow ? (row + rowCount) : (col + colCount)) >= index) {
                                            if (anchor.isValid) {
                                                sheetModel._clearValues(anchor);
                                            }
                                            if ((isRow ? row : col) < index) {
                                                dirtyAnchors.push(anchor);
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                if (dirtyAnchors.length) {
                    CalcEngine_1.markAnchorCellDirty(dirtyAnchors, modelManager._sheet._getCalcModel(), dynamicArrayManager);
                }
            }
            exports.clearSpillValuesOnAddRemove = clearSpillValuesOnAddRemove;
            function filterOutAutoMerge(spans) {
                if (spans) {
                    return spans.filter(function (range) {
                        return !range.isAutoMerge;
                    });
                }
                return spans;
            }
            // 模型管理器
            var _SheetModelManager = (function () {
                function _SheetModelManager(sheet, viewportRowCount, viewportColCount, colHeaderRowCount, rowHeaderColCount, name) {
                    this._dynamicArrayUpdateInfos = [];
                    var self = this;
                    self._sheet = sheet;
                    // 工作表模型主要有4类，对应不同的区域
                    self.sheetModels = [
                        // 左上角单元格
                        keyword_undefined,
                        // 列标题区域
                        new _SheetModel(colHeaderRowCount, viewportColCount),
                        // 行标题区域
                        new _SheetModel(viewportRowCount, rowHeaderColCount),
                        // 视口区域
                        new _SheetModel(viewportRowCount, viewportColCount)
                    ];
                    var rowInfos = self.rowInfos = [];
                    rowInfos[0] = rowInfos[1] = new _AxisModel();
                    rowInfos[2] = rowInfos[3] = new _AxisModel();
                    var colInfos = self.colInfos = [];
                    colInfos[0] = colInfos[2] = new _AxisModel();
                    colInfos[1] = colInfos[3] = new _AxisModel();
                    self.spanModels = [
                        keyword_undefined,
                        new _SpanModel(),
                        new _SpanModel(),
                        new _SpanModel()
                    ];
                    // 选择模型
                    self.selectionModel = new _SelectionModel();
                    // 动态数组管理器 
                    self._dynamicArrayManager = new _DynamicArrayManager(self);
                    self.name = name || '';
                    self.isSelected = false;
                    self.zoomFactor = 1;
                    function setCallback(obj, value, propName, oldValue) {
                        if (self._inTransaction > 0) {
                            self._changes.push([
                                ['defaults', propName],
                                oldValue
                            ]);
                        }
                        self._sheet._invalidate();
                    }
                    var defaults = self.defaults = {};
                    defineProperty(defaults, 'rowHeight', DEFAULT_ROW_HEIGHT, setCallback);
                    defineProperty(defaults, 'colWidth', DEFAULT_COL_WIDTH, setCallback);
                    defineProperty(defaults, 'rowHeaderColWidth', DEFAULT_ROW_HEADER_COL_WIDTH, setCallback);
                    defineProperty(defaults, 'colHeaderRowHeight', DEFAULT_COL_HEADER_ROW_HEIGHT, setCallback);
                    defineProperty(defaults, '_isExcelDefaultColumnWidth', false, setCallback);
                    self._inTransaction = 0;
                    _SheetModelManager._callFeatureHandler(this, 'init');
                    self._initAxisInfoCache(viewportRowCount, viewportColCount);
                }
                _SheetModelManager.prototype._initAxisInfoCache = function (rowCount, columnCount) {
                    var self = this;
                    self._updateAxisInfoCache({
                        type: core_enum_1.AxisInfoChangeType.setRowCount,
                        count: rowCount
                    });
                    self._updateAxisInfoCache({
                        type: core_enum_1.AxisInfoChangeType.setColumnCount,
                        count: columnCount
                    });
                };
                _SheetModelManager.prototype._updateAxisInfoCache = function (args) {
                    var self = this;
                    var sheet = self._sheet;
                    var type = args.type;
                    var _a = args.sheetArea;
                    var sheetArea = _a === void 0 ? core_enum_1.SheetArea.viewport : _a;
                    if (sheetArea !== core_enum_1.SheetArea.viewport) {
                        return;
                    }
                    if (isNullOrUndefined(self._axisRowInfoCache)) {
                        self._axisRowInfoCache = [];
                    }
                    if (isNullOrUndefined(self._axisColInfoCache)) {
                        self._axisColInfoCache = [];
                    }
                    if (self._axisInfoSuspendList) {
                        self._addUpdateAxisInfoArgs(args);
                        return;
                    }
                    var _axisRowInfoCache = self._axisRowInfoCache;
                    var _axisColInfoCache = self._axisColInfoCache;
                    switch (type) {
                        case core_enum_1.AxisInfoChangeType.setRowCount: {
                            var count = args.count;
                            var oldCount = _axisRowInfoCache.length;
                            var newCount = count - oldCount;
                            if (newCount > 0) {
                                var newArray = fillArray(DEFAULT_SIZE, newCount);
                                for (var i = 0; i < newArray.length; i++) {
                                    _axisRowInfoCache.splice(oldCount + i, 0, newArray[i]);
                                }
                            } else {
                                _axisRowInfoCache.length = count;
                            }
                            break;
                        }
                        case core_enum_1.AxisInfoChangeType.setColumnCount: {
                            var count = args.count;
                            var oldCount = _axisColInfoCache.length;
                            var newCount = count - oldCount;
                            if (newCount > 0) {
                                var newArray = fillArray(DEFAULT_SIZE, newCount);
                                for (var i = 0; i < newArray.length; i++) {
                                    _axisColInfoCache.splice(oldCount + i, 0, newArray[i]);
                                }
                            } else {
                                _axisColInfoCache.length = count;
                            }
                            break;
                        }
                        case core_enum_1.AxisInfoChangeType.addRows: {
                            var index = args.index;
                            var count = args.count;
                            var addItems = fillArray(DEFAULT_SIZE, count);
                            for (var i = 0; i < addItems.length; i++) {
                                _axisRowInfoCache.splice(index + i, 0, addItems[i]);
                            }
                            break;
                        }
                        case core_enum_1.AxisInfoChangeType.deleteRows: {
                            var index = args.index;
                            var count = args.count;
                            _axisRowInfoCache.splice(index, count);
                            break;
                        }
                        case core_enum_1.AxisInfoChangeType.addColumns: {
                            var index = args.index;
                            var count = args.count;
                            var addItems = fillArray(DEFAULT_SIZE, count);
                            for (var i = 0; i < addItems.length; i++) {
                                _axisColInfoCache.splice(index + i, 0, addItems[i]);
                            }
                            break;
                        }
                        case core_enum_1.AxisInfoChangeType.deleteColumns: {
                            var index = args.index;
                            var count = args.count;
                            _axisColInfoCache.splice(index, count);
                            break;
                        }
                        case core_enum_1.AxisInfoChangeType.setRowHeight:
                        case core_enum_1.AxisInfoChangeType.setRowVisible: {
                            var index = args.index;
                            var size = args.value;
                            _axisRowInfoCache[index] = size;
                            break;
                        }
                        case core_enum_1.AxisInfoChangeType.setColumnWidth:
                        case core_enum_1.AxisInfoChangeType.setColumnVisible: {
                            var index = args.index;
                            var size = args.value;
                            _axisColInfoCache[index] = size;
                            break;
                        }
                        case core_enum_1.AxisInfoChangeType.filterRows: {
                            var indexes = args.index;
                            for (var _i = 0, _b = indexes; _i < _b.length; _i++) {
                                var index = _b[_i];
                                var size = sheet.getRowHeight(index);
                                _axisRowInfoCache[index] = size;
                            }
                            break;
                        }
                        case core_enum_1.AxisInfoChangeType.outlineExpandRows: {
                            var indexes = args.index;
                            for (var i = 0; i < indexes.length; i++) {
                                var index = indexes[i];
                                var size = sheet.getRowHeight(index);
                                _axisRowInfoCache[index] = size;
                            }
                            break;
                        }
                        case core_enum_1.AxisInfoChangeType.outlineExpandColumns: {
                            var indexes = args.index;
                            for (var i = 0; i < indexes.length; i++) {
                                var index = indexes[i];
                                var size = sheet.getColumnWidth(index);
                                _axisColInfoCache[index] = size;
                            }
                            break;
                        }
                    }
                };
                _SheetModelManager.prototype._getRowHeightFromAxisInfoCache = function (index) {
                    if (!this._axisRowInfoCache) {
                        return;
                    }
                    var rowHeight = this._axisRowInfoCache[index];
                    return rowHeight === DEFAULT_SIZE ? this.defaults.rowHeight : rowHeight;
                };
                _SheetModelManager.prototype._getColWidthFromAxisInfoCache = function (index) {
                    if (!this._axisColInfoCache) {
                        return;
                    }
                    var colWidth = this._axisColInfoCache[index];
                    return colWidth === DEFAULT_SIZE ? this.defaults.colWidth : colWidth;
                };
                _SheetModelManager.prototype._suspendUpdateAxisInfoCache = function () {
                    this._axisInfoSuspendList = [];
                };
                _SheetModelManager.prototype._resumeUpdateAxisInfoCache = function () {
                    var self = this;
                    var suspendList = self._axisInfoSuspendList;
                    self._axisInfoSuspendList = keyword_null;
                    if (suspendList) {
                        for (var _i = 0, suspendList_1 = suspendList; _i < suspendList_1.length; _i++) {
                            var args = suspendList_1[_i];
                            self._updateAxisInfoCache(args);
                        }
                    }
                };
                _SheetModelManager.prototype._addUpdateAxisInfoArgs = function (args) {
                    this._axisInfoSuspendList && this._axisInfoSuspendList.push(args);
                };
                _SheetModelManager.prototype._disposeAxisInfoCache = function () {
                    var self = this;
                    self._axisRowInfoCache = keyword_null;
                    self._axisColInfoCache = keyword_null;
                };
                _SheetModelManager.prototype._dispose = function (clearCache) {
                    if (clearCache !== false) {
                        var self_1 = this;
                        self_1._sheet = keyword_null;
                        self_1.sheetModels = keyword_null;
                        if (self_1._dynamicArrayManager) {
                            self_1._dynamicArrayManager._dispose();
                            self_1._dynamicArrayManager = keyword_null;
                        }
                        self_1._disposeAxisInfoCache();
                    }
                    _SheetModelManager._callFeatureHandler(this, 'dispose', {
                        clearCache: clearCache
                    });
                };
                _SheetModelManager.prototype.addRows = function (row, rowCount, sheetModelOnly, isUndoDeleteRows) {
                    var self = this;
                    var changeInfo;
                    if (self._inTransaction > 0) {
                        changeInfo = {
                            row: row,
                            rowCount: rowCount,
                            type: 'addRows'
                        };
                        self._changes.push(changeInfo);
                    }
                    self._getSheetModel(3)._addRows(row, rowCount, isUndoDeleteRows);
                    self._getSheetModel(2)._addRows(row, rowCount, isUndoDeleteRows);
                    self._getSpanModel(3)._addRows(row, rowCount);
                    self._getSpanModel(2)._addRows(row, rowCount);
                    self._getAxisModel(true, 3)._addItems(row, rowCount);
                    _supportsCalc && self._dynamicArrayManager._addRows(self._sheet._getSheetSource(), row, rowCount);
                    if (!sheetModelOnly) {
                        _SheetModelManager._callFeatureHandler(self, 'addRows', {
                            row: row,
                            rowCount: rowCount,
                            changes: self._changes
                        });
                    }
                    self._updateAxisInfoCache({
                        type: core_enum_1.AxisInfoChangeType.addRows,
                        index: row,
                        count: rowCount
                    });
                };
                _SheetModelManager.prototype._undoAddRows = function (changeInfo) {
                    var self = this;
                    var row = changeInfo.row;
                    var rowCount = changeInfo.rowCount;
                    clearSpillValuesOnAddRemove(self, row, rowCount, false, true);
                    self.deleteRows(row, rowCount, true);
                    _SheetModelManager._callFeatureHandler(self, 'undoAddRows', {
                        row: row,
                        rowCount: rowCount
                    });
                };
                _SheetModelManager.prototype.deleteRows = function (row, rowCount, sheetModelOnly) {
                    var self = this;
                    var changeInfo;
                    var viewportSheetModelChanges;
                    var rowHeaderSheetModelChanges;
                    var viewportSpanModelChanges;
                    var rowHeaderSpanModelChanges;
                    var viewportAxisModelChanges;
                    if (self._inTransaction > 0) {
                        viewportSheetModelChanges = [];
                        rowHeaderSheetModelChanges = [];
                        viewportSpanModelChanges = [
                            ['spanModels', 3], keyword_undefined
                        ];
                        rowHeaderSpanModelChanges = [
                            ['spanModels', 2], keyword_undefined
                        ];
                        viewportAxisModelChanges = [];
                        changeInfo = {
                            row: row,
                            rowCount: rowCount,
                            type: 'deleteRows'
                        };
                        self._changes.push(changeInfo);
                    }
                    self._getSheetModel(3)._deleteRows(row, rowCount, viewportSheetModelChanges);
                    self._getSheetModel(2)._deleteRows(row, rowCount, rowHeaderSheetModelChanges);
                    self._getSpanModel(3)._removeRows(row, rowCount, viewportSpanModelChanges);
                    self._getSpanModel(2)._removeRows(row, rowCount, rowHeaderSpanModelChanges);
                    self._getAxisModel(true, 3)._deleteItems(row, rowCount, viewportAxisModelChanges);
                    _supportsCalc && self._dynamicArrayManager._removeRows(self._sheet._getSheetSource(), row, rowCount);
                    if (!sheetModelOnly) {
                        _SheetModelManager._callFeatureHandler(self, 'deleteRows', {
                            row: row,
                            rowCount: rowCount,
                            changes: self._changes
                        });
                    }
                    if (changeInfo) {
                        var changes = changeInfo.changes = [];
                        var partPath = ['sheetModels', 3];
                        for (var i = 0; i < viewportSheetModelChanges.length; i++) {
                            viewportSheetModelChanges[i][0] = partPath.concat(viewportSheetModelChanges[i][0]);
                            changes.push(viewportSheetModelChanges[i]);
                        }
                        partPath = ['sheetModels', 2];
                        for (var i = 0; i < rowHeaderSheetModelChanges.length; i++) {
                            rowHeaderSheetModelChanges[i][0] = partPath.concat(rowHeaderSheetModelChanges[i][0]);
                            changes.push(rowHeaderSheetModelChanges[i]);
                        }
                        if (viewportSpanModelChanges.length > 0) {
                            changes.push(viewportSpanModelChanges);
                        }
                        if (rowHeaderSpanModelChanges.length > 0) {
                            changes.push(rowHeaderSpanModelChanges);
                        }
                        partPath = [ROW_INFOS_TEXT, 3];
                        for (var i = 0; i < viewportAxisModelChanges.length; i++) {
                            viewportAxisModelChanges[i][0] = partPath.concat(viewportAxisModelChanges[i][0]);
                            changes.push(viewportAxisModelChanges[i]);
                        }
                    }
                    self._updateAxisInfoCache({
                        type: core_enum_1.AxisInfoChangeType.deleteRows,
                        index: row,
                        count: rowCount
                    });
                };
                _SheetModelManager.prototype._undoDeleteRows = function (changeInfo) {
                    var self = this;
                    var row = changeInfo.row;
                    var rowCount = changeInfo.rowCount;
                    clearSpillValuesOnAddRemove(self, row, rowCount, true, true);
                    self.addRows(row, rowCount, true, true);
                    var changes = changeInfo.changes;
                    for (var j = changes.length - 1; j >= 0; j--) {
                        undoChange(self, changes[j]);
                    }

                    var deleteRows = self._sheet && self._sheet._deletedRows;
                    deleteRows && deleteRows.splice(deleteRows.length - rowCount, rowCount);
                };
                _SheetModelManager.prototype.addColumns = function (col, colCount, sheetModelOnly) {
                    var self = this;
                    var changeInfo;
                    if (self._inTransaction > 0) {
                        changeInfo = {
                            col: col,
                            colCount: colCount,
                            type: 'addColumns'
                        };
                        self._changes.push(changeInfo);
                    }
                    self._getSheetModel(3)._addColumns(col, colCount);
                    self._getSheetModel(1)._addColumns(col, colCount);
                    self._getSpanModel(3)._addColumns(col, colCount);
                    self._getSpanModel(1)._addColumns(col, colCount);
                    self._getAxisModel(false, 3)._addItems(col, colCount);
                    _supportsCalc && self._dynamicArrayManager._addColumns(self._sheet._getSheetSource(), col, colCount);
                    if (!sheetModelOnly) {
                        _SheetModelManager._callFeatureHandler(self, 'addColumns', {
                            col: col,
                            colCount: colCount,
                            changes: self._changes
                        });
                    }
                    self._updateAxisInfoCache({ type: core_enum_1.AxisInfoChangeType.addColumns, index: col, count: colCount });
                };
                _SheetModelManager.prototype._undoAddColumns = function (changeInfo) {
                    var self = this;
                    var col = changeInfo.col;
                    var colCount = changeInfo.colCount;
                    clearSpillValuesOnAddRemove(self, col, colCount, false, false);
                    self.deleteColumns(col, colCount, true);
                };
                _SheetModelManager.prototype.deleteColumns = function (col, colCount, sheetModelOnly) {
                    var self = this;
                    var changeInfo;
                    var viewportSheetModelChanges;
                    var colHeaderSheetModelChanges;
                    var viewportSpanModelChanges;
                    var colHeaderSpanModelChanges;
                    var viewportAxisModelChanges;
                    if (self._inTransaction > 0) {
                        viewportSheetModelChanges = [];
                        colHeaderSheetModelChanges = [];
                        viewportSpanModelChanges = [['spanModels', 3], keyword_undefined];
                        colHeaderSpanModelChanges = [['spanModels', 1], keyword_undefined];
                        viewportAxisModelChanges = [];
                        changeInfo = {
                            col: col,
                            colCount: colCount,
                            type: 'deleteColumns'
                        };
                        self._changes.push(changeInfo);
                    }
                    self._getSheetModel(3)._deleteColumns(col, colCount, viewportSheetModelChanges);
                    self._getSheetModel(1)._deleteColumns(col, colCount, colHeaderSheetModelChanges);
                    self._getSpanModel(3)._removeColumns(col, colCount, viewportSpanModelChanges);
                    self._getSpanModel(1)._removeColumns(col, colCount, colHeaderSpanModelChanges);
                    self._getAxisModel(false, 3)._deleteItems(col, colCount, viewportAxisModelChanges);
                    _supportsCalc && self._dynamicArrayManager._removeColumns(self._sheet._getSheetSource(), col, colCount);
                    if (!sheetModelOnly) {
                        _SheetModelManager._callFeatureHandler(self, 'deleteColumns', {
                            col: col,
                            colCount: colCount,
                            changes: self._changes
                        });
                    }
                    if (changeInfo) {
                        var changes = changeInfo.changes = [];
                        var partPath = ['sheetModels', 3];
                        for (var i = 0; i < viewportSheetModelChanges.length; i++) {
                            viewportSheetModelChanges[i][0] = partPath.concat(viewportSheetModelChanges[i][0]);
                            changes.push(viewportSheetModelChanges[i]);
                        }
                        partPath = ['sheetModels', 1];
                        for (var i = 0; i < colHeaderSheetModelChanges.length; i++) {
                            colHeaderSheetModelChanges[i][0] = partPath.concat(colHeaderSheetModelChanges[i][0]);
                            changes.push(colHeaderSheetModelChanges[i]);
                        }
                        if (viewportSpanModelChanges.length > 0) {
                            changes.push(viewportSpanModelChanges);
                        }
                        if (colHeaderSpanModelChanges.length > 0) {
                            changes.push(colHeaderSpanModelChanges);
                        }
                        partPath = [COL_INFOS_TEXT, 3];
                        for (var i = 0; i < viewportAxisModelChanges.length; i++) {
                            viewportAxisModelChanges[i][0] = partPath.concat(viewportAxisModelChanges[i][0]);
                            changes.push(viewportAxisModelChanges[i]);
                        }
                    }
                    self._updateAxisInfoCache({ type: core_enum_1.AxisInfoChangeType.deleteColumns, index: col, count: colCount });
                };
                _SheetModelManager.prototype._undoDeleteColumns = function (changeInfo) {
                    var self = this;
                    var col = changeInfo.col;
                    var colCount = changeInfo.colCount;
                    clearSpillValuesOnAddRemove(self, col, colCount, true, false);
                    self.addColumns(col, colCount, true);
                    var changes = changeInfo.changes;
                    for (var j = changes.length - 1; j >= 0; j--) {
                        undoChange(self, changes[j]);
                    }
                };
                _SheetModelManager.prototype.getRowCount = function (sheetArea) {
                    return this._getSheetModel(sheetArea).getRowCount();
                };
                _SheetModelManager.prototype.setRowCount = function (rowCount, sheetArea, sheetModelOnly) {
                    var self = this;
                    var oldRowCount = self.getRowCount(sheetArea);
                    if (self._inTransaction > 0) {
                        self._changes.push({ oldRowCount: oldRowCount, sheetArea: sheetArea, type: 'setRowCount' });
                    }
                    if (sheetArea === 3 || sheetArea === 2) {
                        if (oldRowCount > rowCount) {
                            self.deleteRows(rowCount, oldRowCount - rowCount, sheetModelOnly);
                        }
                        self._getSheetModel(3).setRowCount(rowCount);
                        self._getSheetModel(2).setRowCount(rowCount);
                    } else if (sheetArea === 1) {
                        if (oldRowCount > rowCount) {
                            self._getAxisModel(true, sheetArea)._deleteItems(rowCount, oldRowCount - rowCount);
                        }
                        self._getSheetModel(sheetArea).setRowCount(rowCount);
                    }
                    self._updateAxisInfoCache({ type: core_enum_1.AxisInfoChangeType.setRowCount, count: rowCount, sheetArea: sheetArea });
                };
                _SheetModelManager.prototype._undoSetRowCount = function (change) {
                    this.setRowCount(change.oldRowCount, change.sheetArea, true);
                };
                _SheetModelManager.prototype.getColumnCount = function (sheetArea) {
                    return this._getSheetModel(sheetArea).getColumnCount();
                };
                _SheetModelManager.prototype.setColumnCount = function (colCount, sheetArea, sheetModelOnly) {
                    var self = this;
                    var oldColCount = self.getColumnCount(sheetArea);
                    if (self._inTransaction > 0) {
                        self._changes.push({
                            oldColCount: oldColCount,
                            sheetArea: sheetArea,
                            type: 'setColumnCount'
                        });
                    }
                    if (sheetArea === 3 || sheetArea === 1) {
                        if (oldColCount > colCount) {
                            self.deleteColumns(colCount, oldColCount - colCount, sheetModelOnly);
                        }
                        self._getSheetModel(3).setColumnCount(colCount);
                        self._getSheetModel(1).setColumnCount(colCount);
                    } else if (sheetArea === 2) {
                        if (oldColCount > colCount) {
                            self._getAxisModel(false, sheetArea)._deleteItems(colCount, oldColCount - colCount);
                        }
                        self._getSheetModel(sheetArea).setColumnCount(colCount);
                    }
                    self._updateAxisInfoCache({ type: core_enum_1.AxisInfoChangeType.setColumnCount, count: colCount, sheetArea: sheetArea });
                };
                _SheetModelManager.prototype._undoSetColumnCount = function (change) {
                    this.setColumnCount(change.oldColCount, change.sheetArea, true);
                };
                _SheetModelManager.prototype.getLastNonNullRow = function (sheetArea, noNeedCount) {
                    var itemCount = noNeedCount ? 0 : this._getAxisModel(true, sheetArea)._getItemCount() - 1;
                    return Math_max(this._getSheetModel(sheetArea)._lastNonNullRow, this._getSpanModel(sheetArea)._lastNonNullRow, itemCount);
                };
                _SheetModelManager.prototype.getLastNonNullCol = function (sheetArea, noNeedCount) {
                    var itemCount = noNeedCount ? 0 : this._getAxisModel(false, sheetArea)._getItemCount() - 1;
                    return Math_max(this._getSheetModel(sheetArea)._lastNonNullColumn, this._getSpanModel(sheetArea)._lastNonNullColumn, itemCount);
                };
                _SheetModelManager.prototype._calcStarSize = function () {
                    var self = this;
                    var sheet = self._sheet;
                    var rowResult = sheet._getBounds().height !== 0 && self._calcStarSizeImp(true, sheet.defaults.rowHeight);
                    var colResult = sheet._getBounds().width !== 0 && self._calcStarSizeImp(false, sheet.defaults.colWidth);
                    function raiseEvent(isRow, results) {
                        var starItemsLength = results.length;
                        for (var i = 0; i < starItemsLength; i++) {
                            var item = results[i][0];
                            var newValue = results[i][1];
                            var oldValue = results[i][2];
                            if (oldValue !== newValue) {
                                if (isRow) {
                                    sheet._raiseRowChanged(item, 3, 'height', newValue, oldValue);
                                } else {
                                    sheet._raiseColumnChanged(item, 3, 'width', newValue, oldValue);
                                }
                            }
                        }
                    }
                    rowResult && raiseEvent(true, rowResult);
                    colResult && raiseEvent(false, colResult);
                };
                _SheetModelManager.prototype._calcStarSizeImp = function (isRow, defaultValue) {
                    var self = this;
                    var sheet = self._sheet;
                    var result = [];
                    var zoomFactor = sheet.zoom();
                    var count = isRow ? sheet.getRowCount() : sheet.getColumnCount();
                    var axisModel = self._getAxisModel(isRow, 3);
                    var headerLength = 0;
                    var remainedPxLength;
                    var outline = 0;
                    if (sheet._getOutlineLayout) {
                        if (isRow) {
                            outline = sheet._getOutlineLayout().height;
                        } else {
                            outline = sheet._getOutlineLayout().width;
                        }
                    }
                    if (isRow) {
                        if (sheet.options.colHeaderVisible) {
                            for (var i = 0; i < sheet.getRowCount(1); i++) {
                                headerLength += Math_ceil(zoomFactor * sheet.getRowHeight(i, 1));
                            }
                        }
                        remainedPxLength = sheet._getBounds().height - sheet.options.sheetAreaOffset.top - outline - headerLength;
                    } else {
                        if (sheet.options.rowHeaderVisible) {
                            for (var i = 0; i < sheet.getColumnCount(2); i++) {
                                headerLength += Math_ceil(zoomFactor * sheet.getColumnWidth(i, 2));
                            }
                        }
                        remainedPxLength = sheet._getBounds().width - sheet.options.sheetAreaOffset.left - outline - headerLength;
                    }
                    var starItems = [];
                    var starValues = [];
                    var oldValues = [];
                    var starSum = 0;
                    var getVisibleFunc = isRow ? sheet.getRowVisible : sheet.getColumnVisible;
                    for (var i = 0; i < count; i++) {
                        var visible = getVisibleFunc.call(sheet, i);
                        var size = sheet._modelManager.getSize(isRow, 3, i);
                        var starSize = sheet._modelManager.getStarSize(isRow, 3, i);
                        if (starSizeReg.test(starSize)) {
                            var star = starSize === '*' ? 1 : parseFloat(starSize.replace('*', ''));
                            if (visible && star > 0) {
                                starSum += star;
                                starItems.push(i);
                                starValues.push(star);
                                oldValues.push(size);
                            } else {
                                result.push([i, 0, size]);
                            }
                        } else {
                            if (typeof size === 'number') {
                                size = Math.floor(size);
                            } else {
                                size = defaultValue;
                            }
                            if (visible) {
                                remainedPxLength -= Math_ceil(zoomFactor * size);
                                if (remainedPxLength < 1) {
                                    return;
                                }
                            }
                        }
                    }
                    if (starSum + result.length === 0 || remainedPxLength < 1) {
                        return;
                    }
                    var starItemsLength = starItems.length;
                    for (var i = 0; i < starItemsLength - 1; i++) {
                        var factor = remainedPxLength / starSum / zoomFactor;
                        var star = starValues[i];
                        var size = Math_floor(factor * star);
                        var realSize = Math_ceil(zoomFactor * size);
                        result.push([starItems[i], size, oldValues[i]]);
                        remainedPxLength -= realSize;
                        starSum -= star;
                        if (realSize < 1 || remainedPxLength < 1) {
                            return;
                        }
                    }
                    var lastSize = Math_ceil((remainedPxLength - 0.0001) / zoomFactor);
                    result.push([starItems[starItemsLength - 1], lastSize, oldValues[starItemsLength - 1]]);
                    for (var i = 0; i < result.length; i++) {
                        var index = result[i][0];
                        var value = result[i][1];
                        axisModel.setSize(index, value);
                        var type = isRow ? core_enum_1.AxisInfoChangeType.setRowHeight : core_enum_1.AxisInfoChangeType.setColumnWidth;
                        self._updateAxisInfoCache({
                            type: type,
                            index: index
                        });
                    }
                    return result;
                };
                _SheetModelManager.prototype.setCellState = function (row, col, value, isAdd, sheetArea) {
                    var sheetModel = this._getSheetModel(sheetArea);
                    if (sheetModel) {
                        sheetModel.setCellState(row, col, value, isAdd);
                    }
                };
                _SheetModelManager.prototype.toJSON = function (serializationOption) {
                    var self = this;
                    var json = {};
                    json.data = self._getSheetModel(3).toJSON(3, serializationOption, self._sheet);
                    json.rowHeaderData = self._getSheetModel(2).toJSON(2, serializationOption);
                    json.colHeaderData = self._getSheetModel(1).toJSON(1, serializationOption);
                    json.rows = self._getAxisModel(true, 3).toJSON(serializationOption);
                    json.columns = self._getAxisModel(false, 3).toJSON(serializationOption);
                    json.rowHeaderColInfos = self._getAxisModel(false, 2).toJSON(serializationOption);
                    json.colHeaderRowInfos = self._getAxisModel(true, 1).toJSON(serializationOption);
                    var sheet = self._sheet;
                    json.leftCellIndex = sheet.getViewportLeftColumn(1);
                    json.topCellIndex = sheet.getViewportTopRow(1);
                    var ignoreStyle = serializationOption && serializationOption.ignoreStyle;
                    if (!ignoreStyle) {
                        json.spans = filterOutAutoMerge(self._getSpanModel(3).toJSON());
                        json.rowHeaderSpan = filterOutAutoMerge(self._getSpanModel(2).toJSON());
                        json.colHeaderSpan = filterOutAutoMerge(self._getSpanModel(1).toJSON());
                    }
                    json.selections = self.selectionModel.toJSON();
                    var optionDefaults = self.defaults;
                    var defaults = {
                        colHeaderRowHeight: optionDefaults.colHeaderRowHeight,
                        colWidth: optionDefaults.colWidth,
                        rowHeaderColWidth: optionDefaults.rowHeaderColWidth,
                        rowHeight: optionDefaults.rowHeight,
                        _isExcelDefaultColumnWidth: optionDefaults._isExcelDefaultColumnWidth
                    };
                    var isSameWithDefaults = defaults.rowHeight === DEFAULT_ROW_HEIGHT
                        && defaults.colWidth === DEFAULT_COL_WIDTH
                        && defaults.rowHeaderColWidth === DEFAULT_ROW_HEADER_COL_WIDTH
                        && defaults.colHeaderRowHeight === DEFAULT_COL_HEADER_ROW_HEIGHT;
                    if (!isSameWithDefaults) {
                        json.defaults = defaults;
                    }
                    return json;
                };
                _SheetModelManager.prototype.fromJSON = function (setting, noSchema, options, callback) {
                    var self = this;
                    self._getSheetModel(3).fromJSON(setting.data, noSchema, options, 3, callback);
                    self._getSheetModel(2).fromJSON(setting.rowHeaderData, noSchema, options);
                    self._getSheetModel(1).fromJSON(setting.colHeaderData, noSchema, options);
                    self._sheet.showCell(setting.topCellIndex || 0, setting.leftCellIndex || 0, core_enum_1.VerticalPosition.top, core_enum_1.HorizontalPosition.left);
                    self._getAxisModel(true, 3).fromJSON(setting.rows);
                    self._getAxisModel(false, 3).fromJSON(setting.columns);
                    self._getAxisModel(false, 2).fromJSON(setting.rowHeaderColInfos);
                    self._getAxisModel(true, 1).fromJSON(setting.colHeaderRowInfos);
                    if (setting && setting.rows) {
                        var indexKeys = Object.keys(setting.rows);
                        for (var _i = 0, indexKeys_1 = indexKeys; _i < indexKeys_1.length; _i++) {
                            var index = indexKeys_1[_i];
                            var axisInfo = setting.rows[index];
                            if (!isNullOrUndefined(axisInfo)) {
                                self._updateAxisInfoCache({
                                    type: core_enum_1.AxisInfoChangeType.setRowHeight,
                                    index: +index
                                });
                            }
                        }
                    }
                    if (setting && setting.columns) {
                        var indexKeys = Object.keys(setting.columns);
                        for (var _a = 0, indexKeys_2 = indexKeys; _a < indexKeys_2.length; _a++) {
                            var index = indexKeys_2[_a];
                            var axisInfo = setting.columns[index];
                            if (!isNullOrUndefined(axisInfo)) {
                                self._updateAxisInfoCache({
                                    type: core_enum_1.AxisInfoChangeType.setColumnWidth,
                                    index: +index
                                });
                            }
                        }
                    }
                    var ignoreStyle = options && options.ignoreStyle;
                    if (!ignoreStyle) {
                        self._getSpanModel(3).fromJSON(setting.spans);
                        self._getSpanModel(2).fromJSON(setting.rowHeaderSpan);
                        self._getSpanModel(1).fromJSON(setting.colHeaderSpan);
                    }
                    self.selectionModel.fromJSON(setting.selections, setting.rowCount, setting.columnCount);
                    var tagObj = setting.tag;
                    if (tagObj !== keyword_undefined) {
                        var tagTypeName = tagObj.typeName;
                        if (typeof tagTypeName === const_string) {
                            var tagClass = util_common.getTypeFromString(tagTypeName);
                            if (tagClass) {
                                tagObj = new tagClass();
                                if (tagObj.fromJSON) {
                                    tagObj.fromJSON(setting.tag);
                                }
                            }
                        }
                        self.do('setValueForKey', -1, -1, 'tag', tagObj, 3);
                    }
                    var setting_defaults = setting.defaults;
                    if (setting_defaults !== keyword_undefined) {
                        var defaults = self.defaults;
                        defaults.colHeaderRowHeight = getPropertyValue(setting_defaults.colHeaderRowHeight, DEFAULT_COL_HEADER_ROW_HEIGHT);
                        defaults.colWidth = getPropertyValue(setting_defaults.colWidth, DEFAULT_COL_WIDTH);
                        defaults.rowHeaderColWidth = getPropertyValue(setting_defaults.rowHeaderColWidth, DEFAULT_ROW_HEADER_COL_WIDTH);
                        defaults.rowHeight = getPropertyValue(setting_defaults.rowHeight, DEFAULT_ROW_HEIGHT);
                        defaults._isExcelDefaultColumnWidth = setting_defaults._isExcelDefaultColumnWidth;
                    }
                };
                _SheetModelManager.prototype.startTransaction = function () {
                    if (this._inTransaction === 0) {
                        this._changes = [];
                        var sheet = this._sheet;
                        var needEvent = !sheet.isEventSuspended();
                        if (needEvent) {
                            this._changes.events = [];
                        }
                        _SheetModelManager._callFeatureHandler(this, 'startTransaction');
                    }
                    this._inTransaction++;
                };
                _SheetModelManager.prototype.endTransaction = function () {
                    this._inTransaction--;
                    if (this._inTransaction === 0) {
                        _SheetModelManager._callFeatureHandler(this, 'endTransaction');
                        var changes = this._changes;
                        this._changes = keyword_undefined;
                        var events = changes.events;
                        if (events && events.length === 0) {
                            delete changes.events;
                        }
                        return changes;
                    }
                    return [];
                };
                _SheetModelManager.prototype._getChangesForCalcEngine = function () {
                    var changes = this._changes;
                    if (changes) {
                        if (!changes.calc) {
                            changes.calc = [];
                        }
                        return changes.calc;
                    }
                };
                _SheetModelManager.prototype._backupAnchorCellState = function (row, col, isValid) {
                    var changes = this._changes;
                    if (changes) {
                        changes.push({
                            type: 'setIsValid',
                            value: [row, col, isValid]
                        });
                    }
                };
                _SheetModelManager.prototype._backupAnchorItemState = function (row, col, value) {
                    var changes = this._changes;
                    if (changes) {
                        changes.push({
                            type: 'dirtyItem',
                            value: [row, col, value]
                        });
                    }
                };
                _SheetModelManager.prototype._undoAnchorCellState = function (change) {
                    var value = change.value;
                    if (value) {
                        var dynamicArrayManager = this._dynamicArrayManager;
                        var anchor = dynamicArrayManager.getAnchorCell(value[0], value[1]);
                        if (anchor) {
                            var isValid = value[2];
                            anchor.isValid = isValid;
                        }
                    }
                };
                _SheetModelManager.prototype._undoAnchorItemState = function (change) {
                    var changeValue = change.value;
                    if (changeValue) {
                        var row = changeValue[0];
                        var col = changeValue[1];
                        var value = changeValue[2];
                        var dynamicArrayManager = this._dynamicArrayManager;
                        var anchorItem = dynamicArrayManager.getAnchorItem(row, col);
                        if (anchorItem) {
                            anchorItem.value = value;
                        }
                    }
                };
                _SheetModelManager.prototype.undo = function (changes) {
                    var changedCells = [];
                    var events = changes && changes.events;
                    if (events) {
                        this._raiseUndoEvents(events, true);
                    }
                    if (changes) {
                        for (var j = changes.length - 1; j >= 0; j--) {
                            var change = changes[j];
                            var changeType = change.type;
                            if (!changeType) {
                                undoChange(this, change);
                            } else if (changeType === 'addRows') {
                                this._undoAddRows(change);
                            } else if (changeType === 'addColumns') {
                                this._undoAddColumns(change);
                            } else if (changeType === 'deleteRows') {
                                this._undoDeleteRows(change);
                            } else if (changeType === 'deleteColumns') {
                                this._undoDeleteColumns(change);
                            } else if (changeType === 'setTag') {
                                this._undoSetTag(change);
                            } else if (changeType === 'setRowCount') {
                                this._undoSetRowCount(change);
                            } else if (changeType === 'setColumnCount') {
                                this._undoSetColumnCount(change);
                            } else if (changeType === 'setZoomFactor') {
                                this._undoSetZoomFactor(change.value);
                            } else if (changeType === 'updateDirty') {
                                this._undoUpdateDirty(change);
                                changedCells.push(change);
                            } else if (changeType === 'setName') {
                                this._undoSetName(change.value);
                            } else if (changeType === 'sortRange') {
                                this._undoSortRange(change);
                            } else if (changeType === 'setIsValid') {
                                this._undoAnchorCellState(change);
                            } else if (changeType === 'dirtyItem') {
                                this._undoAnchorItemState(change);
                            }
                        }
                    }
                    var sheet = this._sheet;
                    sheet._composedDefaultStyle = {};
                    sheet._clearStyleCache();
                    var hasChangedCells = changedCells.length > 0, calcService;
                    if (hasChangedCells) {
                        calcService = sheet._calcService;
                        calcService && calcService.suspend();
                        changedCells.forEach(function (changeItem) {
                            sheet._postSetValue(changeItem.row, changeItem.col, 3, false);
                        });
                    }
                    var tableChanges = changes && changes._tableChanges;
                    if (tableChanges && tableChanges.length > 0) {
                        _SheetModelManager._callFeatureHandler(this, UNDO_TEXT, {
                            _tableChanges: tableChanges
                        });
                        delete changes._tableChanges;
                    }
                    var calcChanges = changes && changes.calc;
                    if (calcChanges && calcChanges.length) {
                        sheet._undoCalcChange(calcChanges);
                    }
                    if (hasChangedCells) {
                        calcService && calcService.resume(false);
                        sheet._clearConditionalFormatsCache();
                    }
                    if (changes) {
                        _SheetModelManager._callFeatureHandler(this, UNDO_TEXT, changes);
                    }
                    if (events) {
                        this._raiseUndoEvents(events, false);
                    }
                };
                _SheetModelManager.prototype.do = function (methodName) {
                    var methodArgs = [];
                    for (var _i = 1; _i < arguments.length; _i++) {
                        methodArgs[_i - 1] = arguments[_i];
                    }
                    var self = this;
                    if (methodName) {
                        var method = self[methodName];
                        method && method.apply(self, methodArgs);
                    }
                };
                _SheetModelManager.prototype._getSheetModel = function (sheetArea) {
                    if (isNullOrUndefined(sheetArea)) {
                        sheetArea = 3;
                    }
                    return this.sheetModels[sheetArea];
                };
                _SheetModelManager.prototype._resetSheetModel = function (rowCount, colCount, sheetArea) {
                    if (isNullOrUndefined(sheetArea)) {
                        sheetArea = 3;
                    }
                    this.sheetModels[sheetArea] = new _SheetModel(rowCount, colCount);
                };
                _SheetModelManager.prototype._addEventItem = function (args) {
                    var self = this;
                    var changes = self._changes;
                    var events = changes && changes.events;
                    if (events) {
                        events.push(args);
                    }
                };
                _SheetModelManager.prototype._raiseUndoEvents = function (events, beforeUndo) {
                    var sheet = this._sheet;
                    sheet._isUndo = true;
                    for (var i = events.length - 1; i >= 0; i--) {
                        var args = events[i];
                        var eventType = args[0];
                        var fn = void 0;
                        if (eventType === 'cellChanged' && !beforeUndo) {
                            fn = sheet._raiseCellChanged;
                        } else if (eventType === 'rowChanged' && !beforeUndo) {
                            fn = sheet._raiseRowChanged;
                        } else if (eventType === 'columnChanged' && !beforeUndo) {
                            fn = sheet._raiseColumnChanged;
                        } else if (eventType === 'zoomChanged' && !beforeUndo) {
                            fn = sheet._raiseZoomChanged;
                        } else if (eventType === 'rowChanging' && beforeUndo) {
                            fn = sheet._raiseRowChanging;
                        } else if (eventType === 'columnChanging' && beforeUndo) {
                            fn = sheet._raiseColumnChanging;
                        } else if (eventType === 'tableRowsChanged' && !beforeUndo) {
                            fn = sheet._raiseTableRowsChanged;
                        } else if (eventType === 'tableColumnsChanged' && !beforeUndo) {
                            fn = sheet._raiseTableColumnsChanged;
                        } else if (eventType === 'rangeChanged' && !beforeUndo) {
                            fn = sheet._dispatchRangChangedIncludeTables;
                        }
                        if (fn) {
                            [].splice.call(events, i, 1);
                            fn.apply(sheet, [].slice.call(args, 1));
                        }
                    }
                    sheet._isUndo = false;
                };
                _SheetModelManager.prototype.getValue = function (row, col, sheetArea, sheetModelOnly, valueType) {
                    if (isNullOrUndefined(sheetArea)) {
                        sheetArea = 3;
                    }
                    var externalValue;
                    var hasExternalValue = false;
                    var modelValueFirst = !!this._sheet._parentSheet;
                    if (!sheetModelOnly) {
                        var argObj_1 = {
                            row: row,
                            col: col,
                            sheetArea: sheetArea,
                            isValueGet: false,
                            value: keyword_undefined
                        };
                        _SheetModelManager._callFeatureHandler(this, 'getValue', argObj_1, function () {
                            return argObj_1.isValueGet;
                        });
                        if (argObj_1.isValueGet) {
                            if (modelValueFirst) {
                                externalValue = argObj_1.value;
                                hasExternalValue = true;
                            } else {
                                return argObj_1.value;
                            }
                        }
                    }
                    var value = this._getSheetModel(sheetArea).getValue(row, col, valueType);
                    if (modelValueFirst && hasExternalValue && !this._isCellDirty(row, col, sheetArea)) {
                        value = externalValue;
                    }
                    return value;
                };
                _SheetModelManager.prototype.setValue = function (row, col, value, sheetArea, sheetModelOnly, ignoreEvent, isSpillValue) {
                    if (isNullOrUndefined(sheetArea)) {
                        sheetArea = 3;
                    }
                    var oldValue, _this = this;
                    var sheet = _this._sheet;
                    var needEvent = !ignoreEvent && !sheet.isEventSuspended();
                    if (needEvent) {
                        oldValue = sheet.getValue(row, col, sheetArea, 1);
                    }
                    var needApplyChanges = false;
                    if (_supportsCalc && sheet.getCalcService().allowDynamicArray && !_this._dynamicArrayProcessing && (sheetArea === 3)) {
                        _this._dynamicArrayUpdateInfos.push(_this._dynamicArrayManager.updateItem(sheet._getSheetSource(), row, col, value));
                        needApplyChanges = true;
                    }
                    var isValueSet = false;
                    if (!sheetModelOnly) {
                        var argObj_2 = {
                            row: row,
                            col: col,
                            value: value,
                            sheetArea: sheetArea,
                            isValueSet: false,
                            changes: _this._changes
                        };
                        _SheetModelManager._callFeatureHandler(_this, 'setValue', argObj_2, function () {
                            return argObj_2.isValueSet;
                        });
                        isValueSet = argObj_2.isValueSet;
                    }
                    if (!isValueSet) {
                        var valueChangeInfo = void 0;
                        var dirtyChangeInfo = void 0;
                        if (_this._inTransaction > 0 && !isSpillValue) {
                            valueChangeInfo = [
                                ['sheetModels', sheetArea],
                                keyword_undefined
                            ];
                            dirtyChangeInfo = {
                                sheetArea: sheetArea
                            };
                        }
                        _this._getSheetModel(sheetArea).setValue(row, col, value, valueChangeInfo, dirtyChangeInfo);
                        if (valueChangeInfo && valueChangeInfo.length > 0) {
                            _this._changes.push(valueChangeInfo);
                        }

                        if (dirtyChangeInfo && dirtyChangeInfo.type) {
                            _this._changes.push(dirtyChangeInfo);
                        }
                        sheet._clearConditionalFormatsCache();
                    }
                    if (needEvent) {
                        var isValueChanged = oldValue !== value;
                        var isDate = false;
                        var dateValue = void 0;
                        if (typeof value === const_string) {
                            dateValue = common_1.util._tryConvertOADateToDate(value);
                            if (dateValue instanceof Date) {
                                isDate = true;
                            }
                            if (oldValue instanceof Date) {
                                isValueChanged = oldValue.valueOf() !== dateValue.valueOf();
                            }
                        }
                        if (isValueChanged) {
                            sheet._raiseCellChanged('value', row, col, sheetArea, oldValue, (isDate && dateValue) ? dateValue : value);
                        }
                    } else {
                        sheet._clearCameraShapeCache(sheet, [
                            {
                                row: row,
                                col: col
                            }
                        ], 0);
                    }
                    if (needApplyChanges) {
                        _this.applyDynamicChanges();
                    }
                };
                _SheetModelManager.prototype.applyDynamicChanges = function () {
                    var _this = this;
                    var dynamicArrayUpdateInfos = _this._dynamicArrayUpdateInfos;
                    var sheet = _this._sheet;
                    if (!_this._dynamicArrayProcessing) {
                        if (dynamicArrayUpdateInfos.length) {
                            _this._dynamicArrayProcessing = true;
                            var sheetSource = sheet._getSheetSource();
                            var calcModel = sheet._getCalcModel();
                            for (var _i = 0, dynamicArrayUpdateInfos_1 = dynamicArrayUpdateInfos; _i < dynamicArrayUpdateInfos_1.length; _i++) {
                                var result = dynamicArrayUpdateInfos_1[_i];
                                if (result) {
                                    CalcEngine_1.setSpillValues(result[0], sheetSource);
                                    CalcEngine_1.markAnchorCellDirty(result[1], calcModel, _this._dynamicArrayManager);
                                }
                            }
                            dynamicArrayUpdateInfos.length = 0;
                            _this._dynamicArrayProcessing = false;
                        }
                    }
                };
                _SheetModelManager.prototype.getDynamicArrayInfo = function (row, col) {
                    return this._dynamicArrayManager.getAnchorInfo(row, col);
                };
                _SheetModelManager.prototype.getStyle = function (row, col, sheetArea) {
                    return this._getSheetModel(sheetArea).getStyle(row, col, this._inTransaction > 0);
                };
                _SheetModelManager.prototype.setStyle = function (row, col, style, sheetArea) {
                    if (isNullOrUndefined(sheetArea)) {
                        sheetArea = 3;
                    }
                    var changeInfo = this._inTransaction > 0 ? [
                        ['sheetModels', sheetArea],
                        keyword_undefined
                    ] : keyword_undefined;
                    this._getSheetModel(sheetArea).setStyle(row, col, style, changeInfo);
                    if (changeInfo && changeInfo.length > 0) {
                        this._changes.push(changeInfo);
                    }
                };
                _SheetModelManager.prototype.getValueForKey = function (row, col, key, sheetArea) {
                    return this._getSheetModel(sheetArea).getValueForKey(row, col, key);
                };
                _SheetModelManager.prototype.setValueForKey = function (row, col, key, value, sheetArea) {
                    if (isNullOrUndefined(sheetArea)) {
                        sheetArea = 3;
                    }
                    var changeInfo = this._inTransaction > 0 ? [
                        ['sheetModels', sheetArea],
                        keyword_undefined
                    ] : keyword_undefined;
                    this._getSheetModel(sheetArea).setValueForKey(row, col, key, value, changeInfo);
                    if (changeInfo && changeInfo.length > 0) {
                        this._changes.push(changeInfo);
                    }
                };
                _SheetModelManager.prototype.clear = function (row, column, rowCount, columnCount, type, ignoredRowList, sheetArea) {
                    if (isNullOrUndefined(sheetArea)) {
                        sheetArea = 3;
                    }
                    var changeInfos = this._inTransaction > 0 ? [] : keyword_undefined;
                    var self = this;
                    var needApplyChanges = false;
                    if (_supportsCalc && !self._dynamicArrayProcessing && (sheetArea === 3)) {
                        var sheet = self._sheet;
                        var sheetSource = sheet._getSheetSource();
                        var dynamicArrayUpdateInfos = self._dynamicArrayUpdateInfos;
                        var dynamicArrayManager = self._dynamicArrayManager;
                        var setValueInfos = {};
                        var dirtyAnchors = [];
                        for (var r = 0; r < rowCount; r++) {
                            for (var c = 0; c < columnCount; c++) {
                                dynamicArrayManager.updateItem(sheetSource, row + r, column + c, keyword_null, setValueInfos, dirtyAnchors);
                            }
                        }
                        dynamicArrayUpdateInfos.push([setValueInfos, dirtyAnchors]);
                        needApplyChanges = true;
                    }
                    this._getSheetModel(sheetArea).clear(row, column, rowCount, columnCount, type, ignoredRowList, changeInfos);
                    _SheetModelManager._callFeatureHandler(this, 'clear', {
                        row: row,
                        col: column,
                        rowCount: rowCount,
                        colCount: columnCount,
                        type: type,
                        ignoredRowList: ignoredRowList,
                        sheetArea: sheetArea,
                        changes: this._changes
                    });
                    if (changeInfos) {
                        var partOfPath = ['sheetModels', sheetArea];
                        for (var index = 0, len = changeInfos.length; index < len; index++) {
                            var info = changeInfos[index];
                            info[0] = partOfPath.concat(info[0]);
                            this._changes.push(info);
                        }
                    }
                    if (needApplyChanges) {
                        this.applyDynamicChanges();
                    }
                };
                _SheetModelManager.prototype.swapNode = function (row, col, row2, col2, sheetArea) {
                    if (isNullOrUndefined(sheetArea)) {
                        sheetArea = 3;
                    }
                    var changeInfos = this._inTransaction > 0 ? [] : keyword_undefined;
                    this._getSheetModel(sheetArea)._swapNode(row, col, row2, col2, changeInfos);
                    if (changeInfos) {
                        var partOfPath = ['sheetModels', sheetArea];
                        for (var index = 0, len = changeInfos.length; index < len; index++) {
                            var info = changeInfos[index];
                            info[0] = partOfPath.concat(info[0]);
                            this._changes.push(info);
                        }
                    }
                };
                _SheetModelManager.prototype._updateDirty = function (row, col, dirtyOption, sheetArea) {
                    var changeInfo;
                    if (this._inTransaction > 0) {
                        changeInfo = { sheetArea: sheetArea };
                        if (isNullOrUndefined(sheetArea)) {
                            changeInfo.sheetArea = 3;
                        }
                    }
                    this._getSheetModel(sheetArea)._updateDirty(row, col, dirtyOption, changeInfo);
                    if (changeInfo) {
                        this._changes.push(changeInfo);
                    }
                };
                _SheetModelManager.prototype._undoUpdateDirty = function (changeInfo) {
                    this._getSheetModel(changeInfo.sheetArea)._undoUpdateDirty(changeInfo);
                };
                _SheetModelManager.prototype._getDirtyNodes = function (sheetArea) {
                    return this._getSheetModel(sheetArea)._dirtyNodes;
                };
                _SheetModelManager.prototype._isCellDirty = function (row, col, sheetArea) {
                    var dirtyNodes = this._getDirtyNodes(sheetArea);
                    var rowNode = dirtyNodes[row];
                    if (rowNode) {
                        var cellNode = rowNode[col];
                        if (cellNode) {
                            return true;
                        }
                    }
                    return false;
                };
                _SheetModelManager.prototype._clearDirtyNodesByRow = function (row, rowCount, sheetArea) {
                    var dirtyNode = this._getSheetModel(sheetArea)._dirtyNodes;
                    for (var index = 0; index < rowCount; index++) {
                        var rowIndex = row + index;
                        if (rowIndex in dirtyNode) {
                            delete dirtyNode[rowIndex];
                        }
                    }
                };
                _SheetModelManager.prototype._clearDeletedRows = function (row, rowCount) {
                    var sheet = this._sheet;
                    var deletedRows = sheet._deletedRows;
                    if (deletedRows) {
                        for (var index = deletedRows.length - 1; index >= 0; index--) {
                            var rowIndex = deletedRows[index].row;
                            if (row <= rowIndex && rowIndex < row + rowCount) {
                                deletedRows.splice(index);
                            }
                        }
                    }
                };
                _SheetModelManager.prototype._clearDirtyNodes = function (sheetArea) {
                    this._getSheetModel(sheetArea)._dirtyNodes = {};
                };
                _SheetModelManager.prototype._clearInsertChangeNodes = function (isClearWholeRowCol, isWholeRow, row, rowCount) {
                    var dirtyNodes = this._getDirtyNodes();
                    var t;
                    var node, rowIndex;
                    if (dirtyNodes) {
                        for (t in dirtyNodes) {
                            if (_hasOwnProperty(dirtyNodes, t)) {
                                node = dirtyNodes[t];
                                rowIndex = parseInt(t, 10);
                                if (
                                    node
                                    && node.rs === 'n'
                                    && (
                                        isClearWholeRowCol
                                        || (isWholeRow && row <= rowIndex && rowIndex < row + rowCount)
                                    )
                                ) {
                                    dirtyNodes[t] = {};
                                }
                            }
                        }
                    }
                };
                _SheetModelManager.prototype._clearDirtyChangeNodes = function (isWholeRow, row, col, rowCount, colCount) {
                    var self = this;
                    var dirtyNodes = self._getDirtyNodes();
                    var sheet = self._sheet;
                    var tables = sheet.tables;
                    if (!$_isEmptyObject(dirtyNodes)) {
                        var rowArray = [];
                        if (row >= 0) {
                            for (var rowIndex = row; rowIndex < row + rowCount; rowIndex++) {
                                rowArray.push(rowIndex);
                            }
                        } else {
                            for (var r in dirtyNodes) {
                                if (_hasOwnProperty(dirtyNodes, r)) {
                                    rowArray.push(parseInt(r, 10));
                                }
                            }
                        }
                        var wholeTableList = [];
                        var intersectTableList_1 = [];
                        if (tables) {
                            wholeTableList = tables._getWholeTablesInRange(row, col, rowCount, colCount);
                            intersectTableList_1 = tables._getIntersectTablesInRange(row, col, rowCount, colCount);
                            if (wholeTableList.length > 0) {
                                _SheetModelManager._callFeatureHandler(this, 'clearPendingChanges', {
                                    tableList: wholeTableList
                                });
                            }
                        }
                        var dirtyRow_1;
                        var node_1;
                        $_each(rowArray, function (i, index) {
                            dirtyRow_1 = dirtyNodes[index];
                            if (dirtyRow_1 && dirtyRow_1.rs === 'e') {
                                var intersectTableListLength = intersectTableList_1.length;
                                if (isWholeRow) {
                                    if ((
                                        !tables
                                        || intersectTableListLength === 0
                                        || !tables._isCellInTableList(intersectTableList_1, index, -1)
                                    )) {
                                        dirtyNodes[index] = {};
                                    } else {
                                        var cc = sheet.getColumnCount();
                                        for (var columnIndex = 0; columnIndex < cc; columnIndex++) {
                                            if (!tables || intersectTableListLength === 0 || !tables._isCellInTableList(intersectTableList_1, index, columnIndex)) {
                                                node_1 = dirtyRow_1[columnIndex];
                                                if (node_1) {
                                                    delete dirtyRow_1[columnIndex];
                                                }
                                            }
                                        }
                                    }
                                } else {
                                    for (var columnIndex = col; columnIndex < col + colCount; columnIndex++) {
                                        if (
                                            !tables
                                            || intersectTableListLength === 0
                                            || !tables._isCellInTableList(intersectTableList_1, index, columnIndex)
                                        ) {
                                            node_1 = dirtyRow_1[columnIndex];
                                            if (node_1) {
                                                delete dirtyRow_1[columnIndex];
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    }
                };
                _SheetModelManager.prototype._clearAllDirtyChangeNodes = function () {
                    var self = this;
                    var dirtyNodes = self._getDirtyNodes();
                    for (var r in dirtyNodes) {
                        if (_hasOwnProperty(dirtyNodes, r)) {
                            if (dirtyNodes[r].rs === 'e') {
                                dirtyNodes[r] = {};
                            }
                        }
                    }
                };
                _SheetModelManager.prototype._suspendDirty = function (sheetArea) {
                    this._getSheetModel(sheetArea)._dirtySuspended++;
                };
                _SheetModelManager.prototype._resumeDirty = function (sheetArea) {
                    var sheetModel = this._getSheetModel(sheetArea);
                    sheetModel._dirtySuspended--;
                    var dirtySuspended = sheetModel._dirtySuspended;
                    if (dirtySuspended < 0) {
                        sheetModel._dirtySuspended = 0;
                    }
                };
                _SheetModelManager.prototype.getName = function () {
                    return this.name || '';
                };
                _SheetModelManager.prototype.setName = function (name) {
                    var _this = this;
                    if (_this._inTransaction > 0) {
                        _this._changes.push({
                            type: 'setName',
                            value: _this.name
                        });
                    }
                    _this.name = name;
                };
                _SheetModelManager.prototype._getSelectedState = function () {
                    return this.isSelected;
                };
                _SheetModelManager.prototype._setSelectedState = function (isSelected) {
                    this.isSelected = isSelected;
                };
                _SheetModelManager.prototype._undoSetName = function (name) {
                    this._sheet.name(name);
                };
                _SheetModelManager.prototype._undoSetTag = function ({ row, col, tag }) {
                    this._sheet.setTag(row, col, tag);
                };
                _SheetModelManager.prototype._undoSortRange = function (value) {
                    var start, list = [];
                    if (value.byRows) {
                        start = value.row;
                    } else {
                        start = value.column;
                    }
                    value.array.map(function (item, index) {
                        list[item - start] = index + start;
                    });
                    this._sheet.sortRange(value.row, value.column, value.rowCount, value.columnCount, value.byRows, value.sortInfo, keyword_null, list);
                };
                _SheetModelManager.prototype.getZoomFactor = function () {
                    return this.zoomFactor;
                };
                _SheetModelManager.prototype.setZoomFactor = function (zoomFactor) {
                    var _this = this;
                    if (_this._inTransaction > 0) {
                        _this._changes.push({
                            type: 'setZoomFactor',
                            value: _this.zoomFactor
                        });
                    }
                    _this.zoomFactor = zoomFactor;
                };
                _SheetModelManager.prototype._undoSetZoomFactor = function (zoomFactor) {
                    this._sheet.zoom(zoomFactor);
                };
                _SheetModelManager.prototype._getSpanModel = function (sheetArea) {
                    if (isNullOrUndefined(sheetArea)) {
                        sheetArea = 3;
                    }
                    return this.spanModels[sheetArea];
                };
                _SheetModelManager.prototype._resetSpanModel = function (sheetArea) {
                    if (isNullOrUndefined(sheetArea)) {
                        sheetArea = 3;
                    }
                    this.spanModels[sheetArea] = new _SpanModel();
                };
                _SheetModelManager.prototype.getSpans = function (range, sheetArea, excludeAutoMerge) {
                    var spans = this._getSpanModel(sheetArea).getSpans(range);
                    if (excludeAutoMerge) {
                        spans = spans.filter(function (rangeEx) {
                            return !rangeEx.isAutoMerge;
                        });
                    }
                    return spans;
                };
                _SheetModelManager.prototype.getSpan = function (row, col, sheetArea) {
                    return this._getSpanModel(sheetArea).get(row, col);
                };
                _SheetModelManager.prototype._getCellNodeTipContent = function (row, col, sheetArea) {
                    if (isNullOrUndefined(sheetArea)) {
                        sheetArea = 3;
                    }
                    var sheetModel = this._getSheetModel(sheetArea);
                    if (sheetModel && sheetModel._getNode) {
                        var cellNode = sheetModel._getNode(row, col);
                        if (cellNode && cellNode.tipContent) {
                            return cellNode.tipContent;
                        } else {
                            return null;
                        }
                    } else {
                        return null;
                    }
                };
                _SheetModelManager.prototype._setCellNodeTipContent = function (row, col, tipContent, sheetArea) {
                    if (isNullOrUndefined(sheetArea)) {
                        sheetArea = 3;
                    }
                    var cellNode = this._getSheetModel(sheetArea)._getNode(row, col);
                    if (!tipContent && cellNode) {
                        delete cellNode.tipContent;
                    } else if (tipContent && cellNode) {
                        cellNode.tipContent = tipContent;
                    } else if (tipContent && !cellNode) {
                        cellNode = this._getSheetModel(sheetArea)._getNode(row, col, true);
                        cellNode.tipContent = tipContent;
                    }
                };
                _SheetModelManager.prototype._hasSpans = function (row, col, rowCount, colCount, sheetArea) {
                    return this._getSpanModel(sheetArea)._hasSpans(row, col, rowCount, colCount);
                };
                _SheetModelManager.prototype._hasPartSpans = function (row, col, rowCount, colCount, sheetArea) {
                    return this._getSpanModel(sheetArea)._hasPartSpans(row, col, rowCount, colCount);
                };
                _SheetModelManager.prototype.findSpan = function (row, col, sheetArea) {
                    return this._getSpanModel(sheetArea).find(row, col);
                };
                _SheetModelManager.prototype.removeSpan = function (range, sheetArea) {
                    if (isNullOrUndefined(sheetArea)) {
                        sheetArea = 3;
                    }
                    var changeInfo = this._inTransaction > 0 ? [
                        ['spanModels', sheetArea],
                        keyword_undefined
                    ] : keyword_undefined;
                    this._getSpanModel(sheetArea).remove(range, changeInfo);
                    if (changeInfo && changeInfo.length > 0) {
                        this._changes.push(changeInfo);
                    }
                };
                _SheetModelManager.prototype.addSpan = function (range, sheetArea) {
                    if (isNullOrUndefined(sheetArea)) {
                        sheetArea = 3;
                    }
                    var changeInfo = this._inTransaction > 0 ? [
                        ['spanModels', sheetArea],
                        keyword_undefined
                    ] : keyword_undefined;
                    this._getSpanModel(sheetArea).add(range, changeInfo);
                    if (changeInfo && changeInfo.length > 0) {
                        this._changes.push(changeInfo);
                    }
                };
                _SheetModelManager.prototype.clearSpan = function (row, col, rowCount, colCount, sheetArea) {
                    if (isNullOrUndefined(sheetArea)) {
                        sheetArea = 3;
                    }
                    var changeInfo = this._inTransaction > 0 ? [
                        ['spanModels', sheetArea],
                        keyword_undefined
                    ] : keyword_undefined;
                    this._getSpanModel(sheetArea)._clear(row, col, rowCount, colCount, changeInfo);
                    if (changeInfo && changeInfo.length > 0) {
                        this._changes.push(changeInfo);
                    }
                };
                _SheetModelManager.prototype.moveSpan = function (fromRow, fromCol, toRow, toCol, rowCount, colCount, sheetArea) {
                    if (isNullOrUndefined(sheetArea)) {
                        sheetArea = 3;
                    }
                    var changeInfo = this._inTransaction > 0 ? [
                        ['spanModels', sheetArea],
                        keyword_undefined
                    ] : keyword_undefined;
                    this._getSpanModel(sheetArea)._move(fromRow, fromCol, toRow, toCol, rowCount, colCount, changeInfo);
                    if (changeInfo && changeInfo.length > 0) {
                        this._changes.push(changeInfo);
                    }
                };
                _SheetModelManager.prototype.copySpan = function (fromRow, fromCol, toRow, toCol, rowCount, colCount, sheetArea) {
                    if (isNullOrUndefined(sheetArea)) {
                        sheetArea = 3;
                    }
                    var changeInfo = this._inTransaction > 0 ? [
                        ['spanModels', sheetArea],
                        keyword_undefined
                    ] : keyword_undefined;
                    this._getSpanModel(sheetArea)._copy(fromRow, fromCol, toRow, toCol, rowCount, colCount, changeInfo);
                    if (changeInfo && changeInfo.length > 0) {
                        this._changes.push(changeInfo);
                    }
                };
                _SheetModelManager.prototype.addSelection = function (row, col, rowCount, colCount) {
                    var changeInfos = this._inTransaction > 0 ? [] : keyword_undefined;
                    this.selectionModel.add(row, col, rowCount, colCount, changeInfos);
                    if (changeInfos) {
                        for (var i = 0; i < changeInfos.length; i++) {
                            var changeInfo = changeInfos[i];
                            changeInfo[0] = ['selectionModel'].concat(changeInfo[0]);
                            this._changes.push(changeInfo);
                        }
                    }
                };
                _SheetModelManager.prototype.getSelections = function () {
                    return this.selectionModel.get();
                };
                _SheetModelManager.prototype.setSelections = function (ranges) {
                    var changeInfos = this._inTransaction > 0 ? [] : keyword_undefined;
                    this.selectionModel.set(ranges, changeInfos);
                    if (changeInfos) {
                        for (var i = 0; i < changeInfos.length; i++) {
                            var changeInfo = changeInfos[i];
                            changeInfo[0] = ['selectionModel'].concat(changeInfo[0]);
                            this._changes.push(changeInfo);
                        }
                    }
                };
                _SheetModelManager.prototype.clearSelection = function () {
                    var changeInfos = this._inTransaction > 0 ? [] : keyword_undefined;
                    this.selectionModel.clear(changeInfos);
                    if (changeInfos) {
                        for (var i = 0; i < changeInfos.length; i++) {
                            var changeInfo = changeInfos[i];
                            changeInfo[0] = ['selectionModel'].concat(changeInfo[0]);
                            this._changes.push(changeInfo);
                        }
                    }
                };
                _SheetModelManager.prototype.getActiveSelectedRangeIndex = function () {
                    return this.selectionModel.getProperty('activeSelectedRangeIndex');
                };
                _SheetModelManager.prototype.setActiveSelectedRangeIndex = function (value) {
                    var changeInfo = this._inTransaction > 0 ? [
                        ['selectionModel'],
                        keyword_undefined
                    ] : keyword_undefined;
                    this.selectionModel.setProperty('activeSelectedRangeIndex', value, changeInfo);
                    if (changeInfo) {
                        this._changes.push(changeInfo);
                    }
                };
                _SheetModelManager.prototype.getSelectionPolicy = function () {
                    return this.selectionModel.getProperty('selectionPolicy');
                };
                _SheetModelManager.prototype.setSelectionPolicy = function (value) {
                    setSelectionPolicyOrUnit(this, 'selectionPolicy', value);
                };
                _SheetModelManager.prototype.getSelectionUnit = function () {
                    return this.selectionModel.getProperty('selectionUnit');
                };
                _SheetModelManager.prototype.setSelectionUnit = function (value) {
                    setSelectionPolicyOrUnit(this, 'selectionUnit', value);
                };
                _SheetModelManager.prototype._isColumnSelected = function (col) {
                    return this.selectionModel._isColumnSelected(col);
                };
                _SheetModelManager.prototype._isRowSelected = function (row) {
                    return this.selectionModel._isRowSelected(row);
                };
                _SheetModelManager.prototype._isSelected = function (row, col, sheetArea, sheetRowCount, sheetColCount, considerAdjacentCell) {
                    return this.selectionModel._isSelected(row, col, sheetArea, sheetRowCount, sheetColCount, considerAdjacentCell);
                };
                _SheetModelManager.prototype._isAllSelected = function (row, col, sheetArea, sheetRowCount, sheetColCount) {
                    return this.selectionModel._isAllSelected(row, col, sheetArea, sheetRowCount, sheetColCount);
                };
                _SheetModelManager.prototype._getAxisModel = function (isRow, sheetArea) {
                    if (isNullOrUndefined(sheetArea)) {
                        sheetArea = 3;
                    }
                    var infos = isRow ? this.rowInfos : this.colInfos;
                    return infos[sheetArea];
                };
                _SheetModelManager.prototype._resetAxisModel = function (isRow, sheetArea) {
                    if (isNullOrUndefined(sheetArea)) {
                        sheetArea = 3;
                    }
                    var infos = isRow ? this.rowInfos : this.colInfos;
                    infos[sheetArea] = new _AxisModel();
                };
                _SheetModelManager.prototype.getPageBreak = function (isRow, sheetArea, index) {
                    var axisModel = this._getAxisModel(isRow, sheetArea);
                    return axisModel.getPageBreak(index);
                };
                _SheetModelManager.prototype.setPageBreak = function (isRow, sheetArea, index, value) {
                    if (isNullOrUndefined(sheetArea)) {
                        sheetArea = 3;
                    }
                    var changeInfo = this._inTransaction > 0 ? [
                        [
                            isRow ? ROW_INFOS_TEXT : COL_INFOS_TEXT,
                            sheetArea
                        ],
                        keyword_undefined
                    ] : keyword_undefined;
                    var axisModel = this._getAxisModel(isRow, sheetArea);
                    axisModel.setPageBreak(index, value, changeInfo);
                    if (changeInfo) {
                        this._changes.push(changeInfo);
                    }
                };
                _SheetModelManager.prototype.getVisible = function (isRow, sheetArea, index) {
                    var axisModel = this._getAxisModel(isRow, sheetArea);
                    return axisModel.getVisible(index);
                };
                _SheetModelManager.prototype.setVisible = function (isRow, sheetArea, index, value) {
                    var self = this;
                    if (isNullOrUndefined(sheetArea)) {
                        sheetArea = 3;
                    }
                    var changeInfo = self._inTransaction > 0 ? [
                        [
                            isRow ? ROW_INFOS_TEXT : COL_INFOS_TEXT,
                            sheetArea
                        ],
                        keyword_undefined
                    ] : keyword_undefined;
                    var axisModel = self._getAxisModel(isRow, sheetArea);
                    axisModel.setVisible(index, value, changeInfo);
                    if (changeInfo) {
                        self._changes.push(changeInfo);
                    }
                    var type = isRow ? core_enum_1.AxisInfoChangeType.setRowVisible : core_enum_1.AxisInfoChangeType.setColumnVisible;
                    self._updateAxisInfoCache({
                        type: type,
                        index: index,
                        sheetArea: sheetArea
                    });
                };
                _SheetModelManager.prototype.getResizable = function (isRow, sheetArea, index) {
                    var axisModel = this._getAxisModel(isRow, sheetArea);
                    return axisModel.getResizable(index);
                };
                _SheetModelManager.prototype.setResizable = function (isRow, sheetArea, index, value) {
                    if (isNullOrUndefined(sheetArea)) {
                        sheetArea = 3;
                    }
                    var changeInfo = this._inTransaction > 0 ? [
                        [
                            isRow ? ROW_INFOS_TEXT : COL_INFOS_TEXT,
                            sheetArea
                        ],
                        keyword_undefined
                    ] : keyword_undefined;
                    var axisModel = this._getAxisModel(isRow, sheetArea);
                    axisModel.setResizable(index, value, changeInfo);
                    if (changeInfo) {
                        this._changes.push(changeInfo);
                    }
                };
                _SheetModelManager.prototype.getSize = function (isRow, sheetArea, index) {
                    var axisModel = this._getAxisModel(isRow, sheetArea);
                    return axisModel.getSize(index);
                };
                _SheetModelManager.prototype.getStarSize = function (isRow, sheetArea, index) {
                    var axisModel = this._getAxisModel(isRow, sheetArea);
                    return axisModel.getStarSize(index);
                };
                _SheetModelManager.prototype.getActualSize = function (isRow, sheetArea, index) {
                    var axisModel = this._getAxisModel(isRow, sheetArea);
                    return axisModel.getActualSize(index);
                };
                _SheetModelManager.prototype.setSize = function (isRow, sheetArea, index, value) {
                    var self = this;
                    if (isNullOrUndefined(sheetArea)) {
                        sheetArea = 3;
                    }
                    var changeInfo = self._inTransaction > 0 ? [
                        [
                            isRow ? ROW_INFOS_TEXT : COL_INFOS_TEXT,
                            sheetArea
                        ],
                        keyword_undefined
                    ] : keyword_undefined;
                    var axisModel = self._getAxisModel(isRow, sheetArea);
                    axisModel.setSize(index, value, changeInfo);
                    if (changeInfo) {
                        self._changes.push(changeInfo);
                    }
                    self.setStarSize(isRow, sheetArea, index, keyword_null);
                    var type = isRow ? core_enum_1.AxisInfoChangeType.setRowHeight : core_enum_1.AxisInfoChangeType.setColumnWidth;
                    self._updateAxisInfoCache({
                        type: type,
                        index: index,
                        value: value,
                        sheetArea: sheetArea
                    });
                };
                _SheetModelManager.prototype.setStarSize = function (isRow, sheetArea, index, value) {
                    if (isNullOrUndefined(sheetArea)) {
                        sheetArea = 3;
                    }
                    var changeInfo = this._inTransaction > 0 ? [[isRow ? ROW_INFOS_TEXT : COL_INFOS_TEXT, sheetArea], keyword_undefined] : keyword_undefined;
                    var axisModel = this._getAxisModel(isRow, sheetArea);
                    axisModel.setStarSize(index, value, changeInfo);
                    if (changeInfo && !isNullOrUndefined(changeInfo[1])) {
                        this._changes.push(changeInfo);
                    }
                };
                _SheetModelManager.prototype._getItemCount = function (isRow, sheetArea) {
                    var axisModel = this._getAxisModel(isRow, sheetArea);
                    return axisModel._getItemCount();
                };
                _SheetModelManager.prototype._getItems = function (isRow, sheetArea) {
                    var axisModel = this._getAxisModel(isRow, sheetArea);
                    return axisModel._getItems();
                };
                _SheetModelManager.prototype._getItem = function (isRow, sheetArea, index) {
                    var axisModel = this._getAxisModel(isRow, sheetArea);
                    return axisModel._getItem(index);
                };
                _SheetModelManager.prototype.setItem = function (isRow, sheetArea, index, value) {
                    var self = this;
                    if (isNullOrUndefined(sheetArea)) {
                        sheetArea = 3;
                    }
                    var changeInfo = self._inTransaction > 0 ? [[isRow ? ROW_INFOS_TEXT : COL_INFOS_TEXT, sheetArea], keyword_undefined] : keyword_undefined;
                    var axisModel = self._getAxisModel(isRow, sheetArea);
                    axisModel._setItem(index, value, changeInfo);
                    if (value) {
                        if (!isNullOrUndefined(value.size)) {
                            var axisInfoChangeType = isRow ? core_enum_1.AxisInfoChangeType.setRowHeight : core_enum_1.AxisInfoChangeType.setColumnWidth;
                            self._updateAxisInfoCache({ type: axisInfoChangeType, index: index, value: value.size, sheetArea: sheetArea });
                        }
                        if (!isNullOrUndefined(value.visible)) {
                            var axisInfoChangeType = isRow ? core_enum_1.AxisInfoChangeType.setRowVisible : core_enum_1.AxisInfoChangeType.setColumnVisible;
                            self._updateAxisInfoCache({ type: axisInfoChangeType, index: index, sheetArea: sheetArea });
                        }
                    }
                    if (changeInfo) {
                        self._changes.push(changeInfo);
                    }
                };
                return _SheetModelManager;
            }());
            exports._SheetModelManager = _SheetModelManager;
            common_1._defineFeature(_SheetModelManager);
        }),
        './dist/core/worksheet/worksheet-render.js': (function (module, exports, __webpack_require__) {
            Object.defineProperty(exports, '__esModule', { value: true });
            var Common_1 = __webpack_require__(/*! Common */ 'Common');
            var worksheet_1 = __webpack_require__(/*! ./worksheet */ './dist/core/worksheet/worksheet.js');
            var common_1 = __webpack_require__(/*! ../util/common */ './dist/core/util/common.js');
            var STYLE_HELPER_MODULE = __webpack_require__(/*! ./stylehelper */ './dist/core/worksheet/stylehelper.js');
            var worksheet_model_1 = __webpack_require__(/*! ./worksheet-model */ './dist/core/worksheet/worksheet-model.js');
            var worksheet_border_1 = __webpack_require__(/*! ./worksheet-border */ './dist/core/worksheet/worksheet-border.js');
            var core_enum_1 = __webpack_require__(/*! ../core.enum */ './dist/core/core.enum.js');
            var getSparklineModule = function (sheet) {
                return sheet.getSparkline;
            };
            var ArrayHelper = Common_1.Common._ArrayHelper;
            var getHAlignByValueType = common_1._util._getHAlignByValueType;
            var getFontHeight = common_1._util._getFontHeight;
            var setContextFont = common_1._util._setContextFont;
            var isformatString = common_1._util._isFormatString;
            var isNullOrUndefined = Common_1.Common._Types._isNullOrUndefined;
            var isNeedUseSymbolFormDataType = common_1._util._isNeedUseSymbolFormDataType;
            var DefaultFontSize = STYLE_HELPER_MODULE._DefaultFontSize;
            var StyleHelper_scaleFont = STYLE_HELPER_MODULE._StyleHelper._scaleFont;
            var keyword_null = null, Math_min = Math.min, Math_max = Math.max, Math_abs = Math.abs, Math_sin = Math.sin, Math_cos = Math.cos, Math_tan = Math.tan, Math_floor = Math.floor, Math_round = Math.round, parseIntFunc = parseInt;
            var STR_BLACK = 'black', STR_TRANSPARENT = 'transparent', STR_ROW_HEADER = 'rowHeader', STR_COLUMN_HEADER = 'columnHeader', DEFAULT_BACKCOLOR = 'white';
            var const_number = 'number';
            function getHeight(obj) {
                return obj.height;
            }
            function getWidth(obj) {
                return obj.width;
            }
            function _strokeLine(ctx, lineWidth, strokeStyle, x1, y1, x2, y2) {
                ctx.beginPath();
                ctx.lineWidth = lineWidth;
                ctx.strokeStyle = strokeStyle;
                ctx.moveTo(x1, y1);
                ctx.lineTo(x2, y2);
                ctx.stroke();
            }

            var TEXT_WIDTH_OFFSET = 2;
            var MAX_CELLOVERFLOW_DISTANCE = 100;
            function getCellPaddingOffset(cellPadding, zoomFactor) {
                var offset = 0;
                if (typeof cellPadding === 'string') {
                    var paddingArray = cellPadding.split(' ', 4), length_1 = paddingArray.length;
                    if (length_1 === 1) {
                        offset = parseIntFunc(paddingArray[0]) * 2;
                    } else if (length_1 === 2 || length_1 === 3) {
                        offset = parseIntFunc(paddingArray[1]) * 2;
                    } else if (length_1 === 4) {
                        offset = parseIntFunc(paddingArray[1]) + parseIntFunc(paddingArray[3]);
                    }
                }
                return offset * zoomFactor;
            }
            function getCellWidth(data, text, style, defaultFont, sheet, row, col, printZoomFactor) {
                var zoomFactor = sheet.zoom();
                var font = style.font;
                var textIndent = style.textIndent;
                var textOrientation = style.textOrientation;
                var isVerticalText = style.isVerticalText;
                var hasTextIndent = style.textIndent && style.textIndent !== 0;
                var isRotateText = textOrientation !== 0 && !isNullOrUndefined(textOrientation);
                var result, textOrientationRadian, sinTextOrientation, cosTextOrientation;
                if (font) {
                    font = StyleHelper_scaleFont(font, zoomFactor).font;
                } else {
                    font = defaultFont;
                }
                if (typeof printZoomFactor === const_number && printZoomFactor !== 1) {
                    font = StyleHelper_scaleFont(font, printZoomFactor).font;
                }
                var textWidth = 0, dataTemp = data;
                if (data && dataTemp.richText) {
                    textWidth = getHorizontalRichTextWidth(dataTemp.richText, font, zoomFactor);
                } else if (data && isRotateText && !isVerticalText && !hasTextIndent) {
                    textOrientationRadian = Math_abs(textOrientation * Math.PI / 180);
                    sinTextOrientation = Math_sin(textOrientationRadian);
                    cosTextOrientation = Math_cos(textOrientationRadian);
                    if (style.wordWrap) {
                        var cachePool = sheet._cachePool;
                        var cellHeight = cachePool._getZoomRowHeight(row);
                        textWidth = common_1._WordWrapHelper._getRotateTextWordWrapWidth(row, col, sinTextOrientation, cosTextOrientation, text, font, cellHeight);
                    } else {
                        var lineHeight = getFontHeight(font);
                        textWidth = common_1._WordWrapHelper._measureText(text, font) * cosTextOrientation + lineHeight * sinTextOrientation;
                    }
                } else {
                    textWidth = common_1._WordWrapHelper._measureText(text, font);
                }
                textWidth += getIndentWidth(sheet, textIndent, row, col) + TEXT_WIDTH_OFFSET;
                result = textWidth + getCellPaddingOffset(style.cellPadding, zoomFactor);
                return result;
            }
            function getRotateCellRect(textOrientation, width, height) {
                if (textOrientation && -90 <= textOrientation && textOrientation <= 90) {
                    var moveLength = Math_floor(height / Math_tan(Math_abs(textOrientation * Math.PI / 180)));
                    return moveLength + width + 4;
                }
            }
            function getHorizontalRichTextWidth(richText, defaultFont, zoomFactor) {
                scaleFontByZoomFactor(richText, defaultFont, zoomFactor);
                return common_1._WordWrapHelper._getTextLengthInLine(richText, defaultFont, 1);
            }
            function scaleFontByZoomFactor(richText, defaultFont, zoomFactor) {
                for (var _i = 0, richText_1 = richText; _i < richText_1.length; _i++) {
                    var richTextItem = richText_1[_i];
                    var font = void 0;
                    richTextItem.style = richTextItem.style || {};
                    var style = richTextItem.style;
                    if (style.font) {
                        font = StyleHelper_scaleFont(style.font, zoomFactor).font;
                    } else {
                        font = defaultFont;
                    }
                    style.font = font;
                }
            }
            function getIndentWidth(sheet, textIndent, row, col) {
                if (!isNullOrUndefined(row) && !isNullOrUndefined(col) && sheet.outlineColumn) {
                    var width = sheet.outlineColumn._getWidth(row, col);
                    if (width) {
                        return width;
                    }
                }
                return textIndent ? textIndent * 8 : 0;
            }
            function buildCellOverflowLayoutModelForLeftOrRight(sheet, cellLayoutModel, defaultCellType, defaultFont, cellContext, row, col, deadCol, isLeft) {
                if (isNeedUseSymbolFormDataType(cellContext.data) && sheet.parent && sheet.parent.options.numbersFitMode !== core_enum_1.NumbersFitMode.overflow) {
                    return keyword_null;
                }
                var cachePool = sheet._cachePool, colWidth = getWidth(cellContext), backgroundWidth = getWidth(cellContext), data, style = cellContext.style, nextCol, text = cellContext.text, printZoomFactor = cellContext.printZoomFactor, watermark = style.watermark, wordWrap = style.wordWrap, textOrientation = style.textOrientation, textWidth, nextStyle;
                var allowCellOverflow = sheet.options.allowCellOverflow;
                if (cellLayoutModel.findCell(row, col)) {
                    return keyword_null;
                }
                if (style.cellButtons && style.cellButtons.length > 0) {
                    return keyword_null;
                }
                var cellType = style.cellType || defaultCellType;
                if (!cellType.allowOverflow || (!text && !watermark) || (!textOrientation && (wordWrap && sheet.parent && sheet.parent.options.numbersFitMode !== core_enum_1.NumbersFitMode.overflow))) {
                    return keyword_null;
                }
                if (!text) {
                    text = watermark;
                }
                if (allowCellOverflow || textOrientation) {
                    textWidth = getCellWidth(cellContext.data, text, style, defaultFont, sheet, row, col, printZoomFactor);
                } else {
                    return keyword_null;
                }
                if (textWidth <= backgroundWidth) {
                    return keyword_null;
                }
                var startCol = col, endCol = col;
                for (nextCol = col + (isLeft ? 1 : -1); isLeft ? (nextCol <= deadCol) : (nextCol >= deadCol); nextCol += (isLeft ? 1 : -1)) {
                    if (cellLayoutModel.findCell(row, nextCol)) {
                        break;
                    }
                    nextStyle = cachePool._getActualStyle(row, nextCol);
                    data = cachePool._getDisplayValue(row, nextCol, 3, 1, nextStyle);
                    if (!nextStyle.textOrientation && !isNullOrUndefined(data)) {
                        break;
                    }
                    if (nextStyle.watermark) {
                        break;
                    }
                    if ((nextStyle.cellType && nextStyle.cellType.typeName !== '1') || (nextStyle.cellButtons && nextStyle.cellButtons.length > 0)) {
                        break;
                    }
                    if (isLeft) {
                        endCol = nextCol;
                    } else {
                        startCol = nextCol;
                    }
                    backgroundWidth += cachePool._getZoomColWidth(nextCol);
                    if (textWidth <= backgroundWidth) {
                        break;
                    }
                }
                if ((isLeft && endCol === col) || (!isLeft && startCol === col)) {
                    return keyword_null;
                }
                return new worksheet_model_1._CellOverflowLayout(col, startCol, endCol, textWidth, colWidth, backgroundWidth, isLeft ? -1 : backgroundWidth, isLeft ? backgroundWidth : -1);
            }
            var _CellOverflowLayoutBuilder = (function () {
                function _CellOverflowLayoutBuilder(sheet, rowViewportIndex, colViewportIndex) {
                    var self = this;
                    self._sheet = sheet;
                    self._colLayoutModel = sheet._getColumnLayout(colViewportIndex);
                    self._cellLayoutModel = sheet._getCellLayout(rowViewportIndex, colViewportIndex, core_enum_1.SheetArea.viewport, true);
                    self._defaultFont = StyleHelper_scaleFont(sheet._render._getDefaultFont(), sheet.zoom()).font;
                    self._defaultCellType = sheet._getDefaultCellType();
                    self._cachedCellOverflowModels = {};
                }
                _CellOverflowLayoutBuilder.prototype._getCellOverflowLayoutModel = function (row, ctx, printZoomFactor) {
                    var self = this;
                    var cache = self._cachedCellOverflowModels[row];
                    if (cache) {
                        return cache;
                    }
                    var sheet = self._sheet, cachePool = sheet._cachePool, colLayoutModel = self._colLayoutModel, count = colLayoutModel.length, textOrientation, isVerticalText, hasTextIndent, colLayout, col, style, data, width, height, hAlign, text;
                    var cellOverflowLayoutModel = new worksheet_model_1._CellOverflowLayoutModel(), cellOverflowLayout;
                    if (!ctx) {
                        ctx = common_1._WordWrapHelper._getCtx();
                    }
                    if (count > 0) {
                        cellOverflowLayoutModel.headingOverflowlayouts = self._buildHeadingCellOverflowLayout(row, ctx);
                        var vpLeft = colLayoutModel[0].col, vpRight = colLayoutModel[count - 1].col;
                        for (var i = 0; i < count; i++) {
                            colLayout = colLayoutModel[i];
                            if (getWidth(colLayout) <= 0) {
                                continue;
                            }
                            col = colLayout.col;

                            style = cachePool._getActualStyle(row, col);
                            data = cachePool._getDisplayValue(row, col, 3, 1);
                            textOrientation = style.textOrientation;
                            isVerticalText = style.isVerticalText;
                            hasTextIndent = style.textIndent && style.textIndent !== 0;
                            var hasBorder = style && (style.borderLeft || style.borderTop || style.borderRight || style.borderBottom);
                            if (isNullOrUndefined(data) && !style.watermark) {
                                continue;
                            }
                            if (style.shrinkToFit || (!textOrientation && (style.wordWrap && sheet.parent && sheet.parent.options.numbersFitMode === core_enum_1.NumbersFitMode.mask)) || isVerticalText) {
                                continue;
                            }
                            var cfs = sheet.conditionalFormats;
                            if (cfs) {
                                var dataBarAndIconSet = cfs._getIconSetAndDataBar(sheet, row, col, data), dataBar = dataBarAndIconSet.dataBar, iconSet = dataBarAndIconSet.iconSet;
                                if (dataBar && dataBar.showBarOnly || iconSet && iconSet.showIconOnly) {
                                    continue;
                                }
                            }
                            width = cachePool._getZoomColWidth(col);
                            height = cachePool._getZoomRowHeight(row);
                            var cellType = style.cellType || self._defaultCellType;
                            var formatData = {};
                            text = common_1._CacheMgr._getFormattedTextByStyle(sheet, style, data, formatData, { row: row, col: col, sheet: sheet });
                            if (formatData && formatData.content && formatData.content.length > 0 && !style.shrinkToFit && textOrientation) {
                                text = cellType._getFormatedTextFitCellWhenRotate(ctx, formatData.content, height - 4, style.font);
                            }
                            hAlign = style.hAlign;
                            if (hAlign === 3) {
                                hAlign = getHAlignByValueType(hAlign, data, style.formatter, textOrientation);
                            }
                            if (hasBorder && textOrientation && !isVerticalText && !hasTextIndent) {
                                if (0 > textOrientation && textOrientation > -90) {
                                    cellOverflowLayout = self._buildCellOverflowLayoutForRotate({
                                        data: data,
                                        style: style,
                                        width: width,
                                        text: text,
                                        printZoomFactor: printZoomFactor
                                    }, row, col, vpLeft);
                                    if (cellOverflowLayout) {
                                        cellOverflowLayoutModel.push(cellOverflowLayout);
                                    }
                                } else if (0 < textOrientation && textOrientation < 90) {
                                    cellOverflowLayout = self._buildCellOverflowLayoutForRotate({
                                        data: data,
                                        style: style,
                                        width: width,
                                        text: text,
                                        printZoomFactor: printZoomFactor
                                    }, row, col, vpRight, true);
                                    if (cellOverflowLayout) {
                                        cellOverflowLayoutModel.push(cellOverflowLayout);
                                    }
                                }
                            } else if (hAlign === 0) {
                                cellOverflowLayout = self._buildCellOverflowLayoutForLeft({
                                    data: data,
                                    style: style,
                                    width: width,
                                    text: text,
                                    printZoomFactor: printZoomFactor
                                }, row, col, vpRight);
                                if (cellOverflowLayout) {
                                    cellOverflowLayoutModel.push(cellOverflowLayout);
                                }
                            } else if (hAlign === 2) {
                                cellOverflowLayout = self._buildCellOverflowLayoutForRight({
                                    data: data,
                                    style: style,
                                    width: width,
                                    text: text,
                                    printZoomFactor: printZoomFactor
                                }, row, col, vpLeft);
                                if (cellOverflowLayout) {
                                    cellOverflowLayoutModel.push(cellOverflowLayout);
                                }
                            } else if (hAlign === 1) {
                                cellOverflowLayout = self._buildCellOverflowLayoutForCenter({
                                    data: data,
                                    style: style,
                                    width: width,
                                    text: text,
                                    printZoomFactor: printZoomFactor
                                }, row, col, vpLeft, vpRight);
                                if (cellOverflowLayout) {
                                    cellOverflowLayoutModel.push(cellOverflowLayout);
                                }
                            }
                        }
                        cellOverflowLayoutModel.trailingOverflowLayouts = self._buildTrailingCellOverflowLayout(row, ctx);
                    }
                    self._cachedCellOverflowModels[row] = cellOverflowLayoutModel;
                    return cellOverflowLayoutModel;
                };
                _CellOverflowLayoutBuilder.prototype._buildCellOverflowLayoutForLeft = function (cellContext, row, col, deadCol) {
                    var self = this;
                    return buildCellOverflowLayoutModelForLeftOrRight(self._sheet, self._cellLayoutModel, self._defaultCellType, self._defaultFont, cellContext, row, col, deadCol, true);
                };
                _CellOverflowLayoutBuilder.prototype._buildCellOverflowLayoutForRight = function (cellContext, row, col, deadCol) {
                    var self = this;
                    return buildCellOverflowLayoutModelForLeftOrRight(self._sheet, self._cellLayoutModel, self._defaultCellType, self._defaultFont, cellContext, row, col, deadCol);
                };
                _CellOverflowLayoutBuilder.prototype._buildCellOverflowLayoutForRotate = function (cellContext, row, col, deadCol, isLeft) {
                    var self = this;
                    var sheet = self._sheet;
                    var cellLayoutModel = self._cellLayoutModel;
                    var defaultCellType = self._defaultCellType;
                    var defaultFont = self._defaultFont;
                    var cachePool = sheet._cachePool;
                    var colWidth = getWidth(cellContext);
                    var backgroundWidth = getWidth(cellContext);
                    var style = cellContext.style;
                    var nextCol;
                    var text = cellContext.text;
                    var printZoomFactor = cellContext.printZoomFactor;
                    var watermark = style.watermark;
                    var wordWrap = style.wordWrap;
                    var textOrientation = style.textOrientation;
                    var textWidth;
                    var nextStyle;
                    var hasBorder = style && (style.borderLeft || style.borderTop || style.borderRight || style.borderBottom);
                    var isVerticalText = style.isVerticalText;
                    var hasTextIndent = style.textIndent && style.textIndent !== 0;
                    var allowCellOverflow = sheet.options.allowCellOverflow;
                    if (cellLayoutModel.findCell(row, col)) {
                        return keyword_null;
                    }
                    if (style.cellButtons && style.cellButtons.length > 0) {
                        return keyword_null;
                    }
                    var cellType = style.cellType || defaultCellType;
                    if (!cellType.allowOverflow || (!text && !watermark) || (!textOrientation && wordWrap)) {
                        return keyword_null;
                    }
                    if (!text) {
                        text = watermark;
                    }
                    if (allowCellOverflow || textOrientation) {
                        if (hasBorder && !isVerticalText && !hasTextIndent) {
                            textWidth = getRotateCellRect(textOrientation, cachePool._getZoomColWidth(col), cachePool._getZoomRowHeight(row));
                        } else {
                            textWidth = getCellWidth(cellContext.data, text, style, defaultFont, sheet, row, col, printZoomFactor);
                        }
                    } else {
                        return keyword_null;
                    }
                    if (textWidth <= backgroundWidth) {
                        return keyword_null;
                    }
                    var startCol = col;
                    var endCol = col;
                    for (nextCol = col + (isLeft ? 1 : -1); isLeft ? (nextCol <= deadCol) : (nextCol >= deadCol); nextCol += (isLeft ? 1 : -1)) {
                        if (cellLayoutModel.findCell(row, nextCol)) {
                            break;
                        }
                        nextStyle = cachePool._getActualStyle(row, nextCol);
                        if (nextStyle.watermark) {
                            break;
                        }
                        if ((nextStyle.cellType && nextStyle.cellType.typeName !== '1') || (nextStyle.cellButtons && nextStyle.cellButtons.length > 0)) {
                            break;
                        }
                        if (isLeft) {
                            endCol = nextCol;
                        } else {
                            startCol = nextCol;
                        }
                        backgroundWidth += cachePool._getZoomColWidth(nextCol);
                        if (textWidth <= backgroundWidth) {
                            break;
                        }
                    }
                    if ((isLeft && endCol === col) || (!isLeft && startCol === col)) {
                        return keyword_null;
                    }
                    return new worksheet_model_1._CellOverflowLayout(col, startCol, endCol, textWidth, colWidth, backgroundWidth, isLeft ? -1 : backgroundWidth, isLeft ? backgroundWidth : -1);
                };
                _CellOverflowLayoutBuilder.prototype._buildCellOverflowLayoutForCenter = function (cellContext, row, col, leftDeadCol, rightDeadCol) {
                    if (isNeedUseSymbolFormDataType(cellContext.data) && this._sheet.parent && this._sheet.parent.options.numbersFitMode !== core_enum_1.NumbersFitMode.overflow) {
                        return keyword_null;
                    }
                    var self = this;
                    var sheet = self._sheet;
                    var cachePool = sheet._cachePool;
                    var cellLayoutModel = self._cellLayoutModel;
                    var colWidth = getWidth(cellContext);
                    var backgroundWidth = getWidth(cellContext);
                    var data;
                    var style = cellContext.style;
                    var nextCol;
                    var text = cellContext.text;
                    var printZoomFactor = cellContext.printZoomFactor;
                    var textOrientation = style.textOrientation;
                    var watermark = style.watermark;
                    var wordWrap = style.wordWrap;
                    var textWidth;
                    var nextStyle;
                    var allowCellOverflow = sheet.options.allowCellOverflow;
                    if (cellLayoutModel.findCell(row, col)) {
                        return keyword_null;
                    }
                    if (style.cellButtons && style.cellButtons.length > 0) {
                        return keyword_null;
                    }
                    var cellType = style.cellType || self._defaultCellType;
                    if (!cellType.allowOverflow || (!text && !watermark) || (!textOrientation && (wordWrap && sheet.parent && sheet.parent.options.numbersFitMode !== core_enum_1.NumbersFitMode.overflow))) {
                        return keyword_null;
                    }
                    if (!text) {
                        text = watermark;
                    }
                    if (allowCellOverflow || textOrientation) {
                        textWidth = getCellWidth(cellContext.data, text, style, self._defaultFont, sheet, row, col, printZoomFactor);
                    } else {
                        return keyword_null;
                    }
                    if (textWidth <= backgroundWidth) {
                        return keyword_null;
                    }
                    var startCol = col;
                    var leftBackgroundWidth = backgroundWidth / 2;
                    for (nextCol = col - 1; nextCol >= leftDeadCol; nextCol--) {
                        if (cellLayoutModel.findCell(row, nextCol)) {
                            break;
                        }
                        nextStyle = cachePool._getActualStyle(row, nextCol);
                        data = cachePool._getDisplayValue(row, nextCol, 3, 1, nextStyle);
                        if (!nextStyle.textOrientation && !isNullOrUndefined(data)) {
                            break;
                        }
                        if (nextStyle.watermark) {
                            break;
                        }
                        if ((nextStyle.cellType && nextStyle.cellType.typeName !== '1') || (nextStyle.cellButtons && nextStyle.cellButtons.length > 0)) {
                            break;
                        }
                        startCol = nextCol;
                        leftBackgroundWidth += cachePool._getZoomColWidth(nextCol);
                        if (textWidth / 2 <= leftBackgroundWidth) {
                            break;
                        }
                    }
                    var endCol = col;
                    var rightBackgroundWidth = backgroundWidth / 2;
                    for (nextCol = col + 1; nextCol <= rightDeadCol; nextCol++) {
                        if (cellLayoutModel.findCell(row, nextCol)) {
                            break;
                        }
                        nextStyle = cachePool._getActualStyle(row, nextCol);
                        data = cachePool._getDisplayValue(row, nextCol, 3, 1, nextStyle);
                        if (!nextStyle.textOrientation && !isNullOrUndefined(data)) {
                            break;
                        }
                        if (nextStyle.watermark) {
                            break;
                        }
                        if ((nextStyle.cellType && nextStyle.cellType.typeName !== '1') || (nextStyle.cellButtons && nextStyle.cellButtons.length > 0)) {
                            break;
                        }
                        endCol = nextCol;
                        rightBackgroundWidth += cachePool._getZoomColWidth(nextCol);
                        if (textWidth / 2 <= rightBackgroundWidth) {
                            break;
                        }
                    }
                    if (startCol === endCol) {
                        return keyword_null;
                    }
                    return new worksheet_model_1._CellOverflowLayout(col, startCol, endCol, textWidth, colWidth, leftBackgroundWidth + rightBackgroundWidth, leftBackgroundWidth, rightBackgroundWidth);
                };
                _CellOverflowLayoutBuilder.prototype._buildHeadingCellOverflowLayout = function (row, ctx) {
                    var self = this;
                    var sheet = self._sheet;
                    var cachePool = sheet._cachePool;
                    var colLayoutModel = self._colLayoutModel;
                    var vpLeft = colLayoutModel[0].col;
                    var vpRight = colLayoutModel[colLayoutModel.length - 1].col;
                    var modelManager = sheet._modelManager;
                    var style;
                    var data;
                    var width;
                    var height;
                    var hAlign;
                    var nextCol;
                    var ret;
                    var text;
                    var cellContext;
                    var cellType;
                    var formatData;
                    var headingCellOverflowLayoutResult = [];
                    for (var i = 1; i < MAX_CELLOVERFLOW_DISTANCE; i++) {
                        nextCol = vpLeft - i;
                        if (nextCol < 0) {
                            return headingCellOverflowLayoutResult;
                        }
                        if (modelManager.findSpan(row, nextCol) || (sheet._autoMergeManager && sheet._autoMergeManager._getSpan(row, nextCol, core_enum_1.SheetArea.viewport))) {
                            return headingCellOverflowLayoutResult;
                        }
                        data = cachePool._getDisplayValue(row, nextCol, 3, 1);
                        width = cachePool._getZoomColWidth(nextCol);
                        if (width > 0 && (!isNullOrUndefined(data))) {
                            style = cachePool._getActualStyle(row, nextCol);
                            hAlign = style.hAlign;
                            if (hAlign === 3) {
                                hAlign = getHAlignByValueType(hAlign, data, undefined, style.textOrientation);
                            }
                            height = cachePool._getZoomRowHeight(row);
                            cellType = style.cellType || self._defaultCellType;
                            formatData = {};
                            text = common_1._CacheMgr._getFormattedTextByStyle(sheet, style, data, formatData, { row: row, col: nextCol, sheet: sheet });
                            if (formatData && formatData.content && formatData.content.length > 0 && !style.shrinkToFit && style.textOrientation) {
                                text = cellType._getFormatedTextFitCellWhenRotate(ctx, formatData.content, height - 4, style.font);
                            }
                            cellContext = {
                                data: data,
                                style: style,
                                width: width,
                                text: text
                            };
                            if (0 < style.textOrientation && style.textOrientation < 90) {
                                ret = self._buildCellOverflowLayoutForRotate(cellContext, row, nextCol, vpRight, true);
                            } else if (hAlign === 0) {
                                ret = self._buildCellOverflowLayoutForLeft(cellContext, row, nextCol, vpRight);
                            } else if (hAlign === 1) {
                                ret = self._buildCellOverflowLayoutForCenter(cellContext, row, nextCol, vpLeft, vpRight);
                            }
                            if (ret && ret.endColumn >= vpLeft) {
                                headingCellOverflowLayoutResult.push(ret);
                            }
                        }
                    }
                    return headingCellOverflowLayoutResult;
                };
                _CellOverflowLayoutBuilder.prototype._buildTrailingCellOverflowLayout = function (row, ctx) {
                    var self = this;
                    var sheet = self._sheet;
                    var cachePool = sheet._cachePool;
                    var colLayoutModel = self._colLayoutModel;
                    var vpLeft = colLayoutModel[0].col;
                    var vpRight = colLayoutModel[colLayoutModel.length - 1].col;
                    var modelManager = sheet._modelManager;
                    var style;
                    var data;
                    var width;
                    var height;
                    var hAlign;
                    var cellType;
                    var formatData;
                    var colCount = sheet.getColumnCount();
                    var nextCol;
                    var ret;
                    var text;
                    var cellContext;
                    var trailingCellOverflowLayoutResult = [];
                    for (var i = 1; i < MAX_CELLOVERFLOW_DISTANCE; i++) {
                        nextCol = vpRight + i;
                        if (nextCol >= colCount) {
                            return trailingCellOverflowLayoutResult;
                        }
                        if (modelManager.findSpan(row, nextCol) || (sheet._autoMergeManager && sheet._autoMergeManager._getSpan(row, nextCol, core_enum_1.SheetArea.viewport))) {
                            return trailingCellOverflowLayoutResult;
                        }
                        data = cachePool._getDisplayValue(row, nextCol, 3, 1);
                        width = cachePool._getZoomColWidth(nextCol);
                        if (width > 0 && (!isNullOrUndefined(data))) {
                            style = cachePool._getActualStyle(row, nextCol);
                            hAlign = style.hAlign;
                            if (hAlign === 3) {
                                hAlign = getHAlignByValueType(hAlign, data, undefined, style.textOrientation);
                            }
                            height = cachePool._getZoomRowHeight(row);
                            cellType = style.cellType || self._defaultCellType;
                            formatData = {};
                            text = common_1._CacheMgr._getFormattedTextByStyle(sheet, style, data, formatData, { row: row, col: nextCol, sheet: sheet });
                            if (formatData && formatData.content && formatData.content.length > 0 && !style.shrinkToFit && style.textOrientation) {
                                text = cellType._getFormatedTextFitCellWhenRotate(ctx, formatData.content, height - 4, style.font);
                            }
                            cellContext = {
                                data: data,
                                style: style,
                                width: width,
                                text: text
                            };
                            if (0 > style.textOrientation && style.textOrientation > -90) {
                                ret = self._buildCellOverflowLayoutForRotate(cellContext, row, nextCol, vpLeft, false);
                            } else if (hAlign === 2) {
                                ret = self._buildCellOverflowLayoutForRight(cellContext, row, nextCol, vpLeft);
                            } else if (hAlign === 1) {
                                ret = self._buildCellOverflowLayoutForCenter(cellContext, row, nextCol, vpLeft, vpRight);
                            }
                            if (ret && ret.startColumn <= vpRight) {
                                trailingCellOverflowLayoutResult.push(ret);
                            }
                        }
                    }
                    return trailingCellOverflowLayoutResult;
                };
                return _CellOverflowLayoutBuilder;
            }());
            exports._CellOverflowLayoutBuilder = _CellOverflowLayoutBuilder;
            function needPaintSelection(sheet) {
                var parent = sheet.parent;
                var args = {
                    nps: true
                };
                worksheet_1.Worksheet._callFeatureHandler(sheet, 'needPaintSelection', args);
                return (common_1._FocusHelper._isActiveElement(sheet) || parent && !parent.options.hideSelection) && args.nps;
            }
            exports.needPaintSelection = needPaintSelection;
            function getSheetBackColor(sheet) {
                var parent = sheet.parent;
                return parent && parent.options.backColor || DEFAULT_BACKCOLOR;
            }
            var _SheetRender = (function () {
                function _SheetRender(sheet) {
                    this._sheet = sheet;
                }
                _SheetRender.prototype._getCtx = function () {
                    var sheet = this._sheet;
                    var ctx = keyword_null;
                    var c = sheet._getCanvas();
                    if (c && c.getContext) {
                        ctx = c.getContext('2d');
                    }
                    return ctx;
                };
                _SheetRender.prototype._getBufferCtx = function () {
                    var self = this;
                    var sheet = self._sheet;
                    var rect = sheet._getBounds();
                    var canvas = sheet._canvas;
                    var width = getWidth(canvas);
                    var height = getHeight(canvas);
                    var buffer = self._buffer;
                    var bufferCtx;
                    if (!buffer || getWidth(buffer) !== width || getHeight(buffer) !== height) {
                        if (buffer) {
                            common_1._DPIHelper._disposeCanvasForSheet(sheet, buffer);
                            buffer.remove();
                        }
                        self._buffer = buffer = common_1._util._createElement('canvas');
                        document.body.append(buffer);
                        if (buffer.getContext) {
                            self._bufferCtx = buffer.getContext('2d');
                            common_1._DPIHelper._adjustDevicePixel(buffer, keyword_null, sheet);
                            common_1._DPIHelper._setSize(buffer, getWidth(rect), getHeight(rect));
                        }
                    }
                    bufferCtx = self._bufferCtx;
                    if (bufferCtx) {
                        bufferCtx.beginPath();
                        setContextFont(bufferCtx, self._getZoomFont(self._getDefaultFont()));
                        bufferCtx.name = 'bufferContext';
                    }
                    return bufferCtx;
                };
                _SheetRender.prototype._getDefaultFont = function () {
                    if (!this._defaultFont) {
                        this._defaultFont = DefaultFontSize + ' ' + this._sheet.currentTheme().bodyFont();
                    }
                    return this._defaultFont;
                };
                _SheetRender.prototype._resetDefaultFont = function () {
                    this._defaultFont = keyword_null;
                };
                _SheetRender.prototype._getGrayAreaBackColor = function (isDrawImage) {
                    var sheet = this._sheet;
                    var workbook = sheet.parent;
                    var bkColorString = workbook ? (workbook.options.grayAreaBackColor || common_1._ThemeStyleHelper._getContentThemeStyle('gc-grayArea').backgroundColor) : 'gray';
                    var bkColor = common_1._ThemeContext._getColor(sheet, bkColorString);
                    if (!isDrawImage) {
                        return bkColor;
                    }
                    var bkImg = workbook ? workbook.options.backgroundImage : keyword_null;
                    if (bkImg) {
                        bkColor = STR_TRANSPARENT;
                    }
                    return bkColor;
                };
                _SheetRender.prototype._getZoomFont = function (font) {
                    var sheet = this._sheet;
                    var zoomFactor = sheet.zoom();
                    return zoomFactor === 1 ? font : StyleHelper_scaleFont(font, zoomFactor).font;
                };
                _SheetRender.prototype._copyDoubleBuffer = function (srcX, srcY, srcW, srcH, clipRect) {
                    var self = this;
                    var buffer = self._buffer;
                    var ctx = self._getCtx();
                    if (srcW <= 0 || srcH <= 0 || !buffer || !ctx) {
                        return;
                    }
                    if (!clipRect) {
                        clipRect = self._sheet._getBounds();
                    }
                    var ratioX = common_1._DPIHelper._getScaleX(buffer);
                    var ratioY = common_1._DPIHelper._getScaleY(buffer);
                    if (ratioX !== 1) {
                        srcX *= ratioX;
                        srcY *= ratioY;
                        srcW *= ratioX;
                        srcH *= ratioY;
                        clipRect = new common_1.Rect(clipRect.x * ratioX, clipRect.y * ratioY, getWidth(clipRect) * ratioX, getHeight(clipRect) * ratioY);
                    }
                    var intersectRect = clipRect.getIntersect(srcX, srcY, srcW, srcH);
                    if (!intersectRect) {
                        return;
                    }
                    intersectRect.round();
                    srcX = intersectRect.x;
                    srcY = intersectRect.y;
                    srcW = getWidth(intersectRect);
                    srcH = getHeight(intersectRect);
                    var maxWidth = getWidth(buffer);
                    if (maxWidth && srcX + srcW > maxWidth) {
                        srcX = maxWidth - srcW;
                        if (srcX < 0) {
                            srcW += srcX;
                            srcX = 0;
                        }
                    }
                    var maxHeight = getHeight(buffer);
                    if (maxHeight && srcY + srcH > maxHeight) {
                        srcY = maxHeight - srcH;
                        if (srcY < 0) {
                            srcH += srcY;
                            srcY = 0;
                        }
                    }
                    common_1._CanvasHelper._scaleTo(ctx, 1, 1);
                    ctx.clearRect(srcX, srcY, srcW, srcH);
                    ctx.drawImage(buffer, srcX, srcY, srcW, srcH, srcX, srcY, srcW, srcH);
                    common_1._CanvasHelper._scaleTo(ctx, ratioX, ratioY);
                };
                _SheetRender.prototype._copyDoubleBufferRect = function (rect, clipRect) {
                    if (rect) {
                        this._copyDoubleBuffer(rect.x, rect.y, getWidth(rect), getHeight(rect), clipRect);
                    }
                };
                _SheetRender.prototype._copyScreen = function (srcX, srcY, srcW, srcH, destX, destY) {
                    if (srcW > 0 && srcH > 0) {
                        try {
                            var self_1 = this;
                            var sheet = self_1._sheet;
                            var ctx = self_1._getCtx();
                            var canvas = sheet._getCanvas();
                            var bufferCtx = self_1._getBufferCtx();
                            var buffer = self_1._buffer;
                            var destW = srcW;
                            var destH = srcH;
                            var destXE = destX;
                            var destYE = destY;
                            var destWE = destW;
                            var destHE = destH;
                            var ratioX = common_1._DPIHelper._getScaleX(canvas);
                            var ratioY = common_1._DPIHelper._getScaleY(canvas);
                            srcX = Math_round(srcX * ratioX);
                            srcY = Math_round(srcY * ratioY);
                            srcW = Math_round(srcW * ratioX);
                            srcH = Math_round(srcH * ratioY);
                            destXE = Math_round(destXE * ratioX);
                            destYE = Math_round(destYE * ratioY);
                            destWE = Math_round(destWE * ratioX);
                            destHE = Math_round(destHE * ratioY);
                            var maxWidth = getWidth(buffer);
                            var maxHeight = getHeight(buffer);
                            if (maxWidth && srcX + srcW > maxWidth) {
                                srcX = maxWidth - srcW;
                                if (srcX < 0) {
                                    srcW += srcX;
                                    srcX = 0;
                                }
                            }
                            if (maxHeight && srcY + srcH > maxHeight) {
                                srcY = maxHeight - srcH;
                                if (srcY < 0) {
                                    srcH += srcY;
                                    srcY = 0;
                                }
                            }
                            if (maxWidth && destXE + destWE > maxWidth) {
                                destXE = maxWidth - destWE;
                                if (destXE < 0) {
                                    destWE += destXE;
                                    destXE = 0;
                                }
                            }
                            if (maxHeight && destYE + destHE > maxHeight) {
                                destYE = maxHeight - destHE;
                                if (destYE < 0) {
                                    destHE += destYE;
                                    destYE = 0;
                                }
                            }
                            common_1._CanvasHelper._scaleTo(ctx, 1, 1);
                            common_1._CanvasHelper._scaleTo(bufferCtx, 1, 1);
                            ctx.clearRect(destXE, destYE, destWE, destHE);
                            ctx.drawImage(buffer, srcX, srcY, srcW, srcH, destXE, destYE, destWE, destHE);
                            bufferCtx.clearRect(destXE, destYE, destWE, destHE);
                            bufferCtx.drawImage(canvas, destXE, destYE, destWE, destHE, destXE, destYE, destWE, destHE);
                            common_1._CanvasHelper._scaleTo(ctx, ratioX, ratioY);
                            common_1._CanvasHelper._scaleTo(bufferCtx, ratioX, ratioY);
                        } catch (e) { }
                    }
                };
                _SheetRender.prototype._repaintSelection = function (range, clipRect, ctx, onlyPaintAdorner) {
                    var self = this;
                    if (!ctx) {
                        ctx = self._getCtx();
                    }
                    var ret = false;
                    var sheet = self._sheet;
                    var newRange = common_1._createRange(-1, -1, -1, -1);
                    var isNavigateInSelection = sheet._isNavigateInSelection;
                    var modelManager = sheet._modelManager;
                    var cr;
                    if (range) {
                        if (sheet.options.allowCellOverflow) {
                            newRange = common_1._createRange(range.row, 0, range.rowCount, sheet.getColumnCount());
                        } else {
                            newRange = common_1._createRange(range.row, range.col, range.rowCount, range.colCount);
                        }
                        if (!isNavigateInSelection) {
                            if (newRange.col >= 0) {
                                var startCol = newRange.col;
                                var endCol = newRange.col + newRange.colCount - 1;
                                var rCount = sheet.getRowCount(1);
                                for (var r = 0; r < rCount; r++) {
                                    cr = modelManager.findSpan(r, newRange.col, 1);
                                    if (cr) {
                                        startCol = Math_min(cr.col, startCol);
                                    } else if (sheet._deselectRange) {
                                        startCol = Math_min(sheet._deselectRange.col, startCol);
                                    }
                                    cr = modelManager.findSpan(r, newRange.col + newRange.colCount - 1, 1);
                                    if (cr) {
                                        endCol = Math_max(cr.col + cr.colCount - 1, endCol);
                                    } else if (sheet._deselectRange) {
                                        endCol = Math_max(sheet._deselectRange.col + sheet._deselectRange.colCount - 1, endCol);
                                    }
                                }
                                newRange.col = startCol;
                                newRange.colCount = endCol - startCol + 1;
                            }
                            if (newRange.row >= 0) {
                                var startRow = newRange.row;
                                var endRow = newRange.row + newRange.rowCount - 1;
                                var cCount = sheet.getColumnCount(2);
                                for (var c = 0; c < cCount; c++) {
                                    cr = modelManager.findSpan(newRange.row, c, 2);
                                    if (cr) {
                                        startRow = Math_min(cr.row, startRow);
                                    } else if (sheet._deselectRange) {
                                        startRow = Math_min(sheet._deselectRange.row, startRow);
                                    }
                                    cr = modelManager.findSpan(newRange.row + newRange.rowCount - 1, c, 2);
                                    if (cr) {
                                        endRow = Math_max(cr.row + cr.rowCount - 1, endRow);
                                    } else if (sheet._deselectRange) {
                                        endRow = Math_max(sheet._deselectRange.row + sheet._deselectRange.rowCount - 1, endRow);
                                    }
                                }
                                newRange.row = startRow;
                                newRange.rowCount = endRow - startRow + 1;
                            }
                        }
                    }
                    var rect = sheet._getRangeWholeRect(newRange);
                    if (sheet.cellStates) {
                        if (sheet.cellStates.hasIntersectInSeletionState(newRange.row, newRange.col, newRange.rowCount, newRange.colCount)) {
                            sheet.repaint(rect);
                        }
                    }
                    var statesManager = sheet._statesManager;
                    var isRowSelectedStateEnable = statesManager && statesManager.isEnable(core_enum_1.StatesType.selected, true);
                    var isColumnSelectedStateEnable = statesManager && statesManager.isEnable(core_enum_1.StatesType.selected, false);
                    if (range) {
                        if (isRowSelectedStateEnable) {
                            rect = sheet._getRangeWholeRect(common_1._createRange(range.row, -1, range.rowCount, -1));
                        }
                        if (isColumnSelectedStateEnable) {
                            var columnDirectionRect = sheet._getRangeWholeRect(common_1._createRange(-1, range.col, -1, range.colCount));
                            rect.x = Math_min(rect.x, columnDirectionRect.x);
                            rect.y = Math_min(rect.y, columnDirectionRect.y);
                            rect.width = Math_max(rect.width, columnDirectionRect.width);
                            rect.height = Math_max(rect.height, columnDirectionRect.height);
                        }
                    }
                    var rangeWidth = getWidth(rect);
                    var rangeHeight = getHeight(rect);
                    var rangeX = rect.x;
                    var rangeY = rect.y;
                    if (rangeWidth >= 0 || rangeHeight >= 0) {
                        var expandX = -9;
                        var expandY = -9;
                        var expandWidth = 18;
                        var expandHeight = 30;
                        rect.x += expandX;
                        rect.y += expandY;
                        rect.width += expandWidth;
                        rect.height += expandHeight;
                        if (clipRect) {
                            rect = rect.getIntersectRect(clipRect);
                            if (!rect) {
                                return;
                            }
                        }
                        var layout = sheet._getSheetLayout();
                        if (rangeHeight > 0 && !isNavigateInSelection) {
                            sheet._dirty = true;
                            self._paint(ctx, new common_1.Rect(layout.x, Math_max(layout._frozenY, rangeY), layout._rowHeaderWidth, rangeHeight), onlyPaintAdorner);
                        }
                        if (rangeWidth > 0 && !isNavigateInSelection) {
                            sheet._dirty = true;
                            self._paint(ctx, new common_1.Rect(Math_max(layout._frozenX, rangeX), layout.y, rangeWidth, layout._colHeaderHeight), onlyPaintAdorner);
                        }
                        if (newRange.row === -1 && newRange.col === -1 && !isNavigateInSelection) {
                            sheet._dirty = true;
                            self._paint(ctx, layout._headerCornerRect(), onlyPaintAdorner);
                        }
                        if (rangeWidth > 0 && rangeHeight > 0) {
                            if (isRowSelectedStateEnable || isColumnSelectedStateEnable) {
                                sheet._dirty = true;
                            }
                            self._paint(ctx, rect, onlyPaintAdorner);
                        }
                        ret = true;
                    }
                    return ret;
                };
                _SheetRender.prototype._update = function (x, y, width, height, ignoreDirtyFlag) {
                    var self = this;
                    var sheet = self._sheet;
                    if (sheet._layoutSuspended <= 0) {
                        var ctx = self._getCtx();
                        if (ctx) {
                            if (!ignoreDirtyFlag) {
                                sheet._dirty = true;
                            }
                            self._paint(ctx, new common_1.Rect(x, y, width, height));
                        }
                    }
                };
                _SheetRender.prototype.repaint = function (clipRect) {
                    var self = this;
                    var sheet = self._sheet;
                    if (sheet._layoutSuspended > 0) {
                        return;
                    }
                    var ctx = self._getCtx();
                    if (ctx) {
                        sheet._dirty = true;
                        self._paint(ctx, clipRect);
                    }
                };
                _SheetRender.prototype._paint = function (ctx, clipRect, onlyPaintAdorner) {
                    var self = this;
                    if (ctx && self._sheet._layoutSuspended <= 0) {
                        if (!onlyPaintAdorner) {
                            self._paintBody(ctx, clipRect);
                        }
                        self._paintAdornment(ctx, clipRect);
                    }
                };
                _SheetRender.prototype._paintBody = function (ctx, clipRect, clipRect2) {
                    var self = this;
                    var sheet = self._sheet;
                    if (ctx && sheet._layoutSuspended <= 0) {
                        var bufferCtx = self._getBufferCtx();
                        var paintContext = bufferCtx ? bufferCtx : ctx;
                        var rect = sheet._getBounds();
                        if (!clipRect) {
                            clipRect = rect;
                        }
                        if (clipRect) {
                            clipRect.round();
                        }
                        if (clipRect2) {
                            clipRect2.round();
                        }
                        if (sheet._dirty) {
                            sheet._dirty = false;
                            if (bufferCtx) {
                                bufferCtx.clearRect(clipRect.x, clipRect.y, getWidth(clipRect), getHeight(clipRect));
                                if (clipRect2) {
                                    bufferCtx.clearRect(clipRect2.x, clipRect2.y, getWidth(clipRect2), getHeight(clipRect2));
                                }
                                common_1._CanvasHelper._translate(bufferCtx, -rect.x, -rect.y);
                            }
                            self._paintSheet(paintContext, clipRect);
                            if (clipRect2) {
                                self._paintSheet(paintContext, clipRect2);
                            }
                            if (bufferCtx) {
                                common_1._CanvasHelper._translate(bufferCtx, rect.x, rect.y);
                            }
                        }
                        if (bufferCtx) {
                            self._copyDoubleBufferRect(clipRect);
                            if (clipRect2) {
                                self._copyDoubleBufferRect(clipRect2);
                            }
                        }
                    }
                };
                _SheetRender.prototype._paintAdornment = function (ctx, clipRect) {
                    var self = this;
                    var sheet = self._sheet;
                    var isTouchMode = sheet._isTouchMode;
                    if (!ctx || sheet._layoutSuspended > 0) {
                        return;
                    }
                    if (clipRect) {
                        clipRect.round();
                    }
                    var layout = sheet._getSheetLayout();
                    var rect;
                    var actualClipRect;
                    var r;
                    var c;
                    worksheet_1.Worksheet._callFeatureHandler(sheet, 'beforePaintAdornment', {
                        ctx: ctx,
                        clipRect: clipRect
                    });
                    if (!sheet._hoverCell) {
                        if (isTouchMode) {
                            rect = layout._headerCornerRect();
                            self._copyDoubleBufferRect(rect);
                            for (r = 0; r <= 2; r++) {
                                rect = layout._rowHeaderRect(r);
                                if (!rect || getWidth(rect) === 0 || getHeight(rect) === 0) {
                                    continue;
                                }
                                self._copyDoubleBufferRect(rect);
                            }
                            for (c = 0; c <= 2; c++) {
                                rect = layout._colHeaderRect(c);
                                if (!rect || getWidth(rect) === 0 || getHeight(rect) === 0) {
                                    continue;
                                }
                                self._copyDoubleBufferRect(rect);
                            }
                        }
                        for (r = 0; r <= 2; r++) {
                            for (c = 0; c <= 2; c++) {
                                rect = layout._viewportRect(r, c);
                                if (!rect || getWidth(rect) === 0 || getHeight(rect) === 0) {
                                    continue;
                                }
                                actualClipRect = clipRect;
                                if ((isTouchMode && (r !== 1 || c !== 1)) || (sheet.parent && sheet.parent.options.allowUserDragMerge)) {
                                    self._copyDoubleBufferRect(rect);
                                    actualClipRect = rect;
                                }
                                if (!actualClipRect || rect.intersectRect(actualClipRect)) {
                                    self._paintSelection(ctx, r, c, actualClipRect);
                                }
                            }
                        }
                        self._paintResizeLine(ctx);
                        worksheet_1.Worksheet._callFeatureHandler(sheet, 'paintAdornment', {
                            ctx: ctx,
                            clipRect: clipRect
                        });
                    }
                };
                _SheetRender.prototype._paintBackground = function (ctx, rect) {
                    var sheet = this._sheet;
                    var workbook = sheet.parent;
                    var options = workbook ? workbook.options : {};
                    var bkColorString = getSheetBackColor(sheet);
                    var bkColor = common_1._ThemeContext._getColor(sheet, bkColorString);
                    var bkImg = options.backgroundImage;
                    if (bkImg) {
                        bkColor = STR_TRANSPARENT;
                    }
                    ctx.save();
                    ctx.fillStyle = bkColor;
                    ctx.fillRect(rect.x, rect.y, getWidth(rect), getHeight(rect));
                    ctx.restore();
                };
                _SheetRender.prototype._isNeedTopLine = function (row) {
                    var sheet = this._sheet;
                    var layout = sheet._getSheetLayout();
                    return (layout._colHeaderHeight === 0 && row === sheet._getFirstVisualRow(3));
                };
                _SheetRender.prototype._isNeedLeftLine = function (col) {
                    var sheet = this._sheet;
                    var layout = sheet._getSheetLayout();
                    return (layout._rowHeaderWidth === 0 && col === sheet._getFirstVisualColumn(3));
                };
                _SheetRender.prototype._paintHeadersAndViewport = function (ctx, clipRect, isPrinting, printZoomFactor) {
                    var self = this;
                    var sheet = self._sheet;
                    var options = sheet.options;
                    var layout = sheet._getSheetLayout();
                    var offsetTop = options.sheetAreaOffset.top;
                    var offsetLeft = options.sheetAreaOffset.left;
                    var colHeaderVisible = layout._colHeaderHeight !== 0;
                    var rowHeaderVisible = layout._rowHeaderWidth !== 0;
                    var outlineLayout = sheet._getOutlineLayout && sheet._getOutlineLayout() || {
                        x: options.sheetAreaOffset.left,
                        y: options.sheetAreaOffset.top,
                        width: 0,
                        height: 0
                    };
                    var isNotHaveRowOutline = outlineLayout.width === 0;
                    var isNotColOutline = outlineLayout.height === 0;
                    var r;
                    var c;
                    var intersectRect;
                    for (c = 0; c <= 2; c++) {
                        var colHeaderRect = layout._colHeaderRect(c);
                        if (colHeaderRect) {
                            if (colHeaderVisible && isNotColOutline) {
                                colHeaderRect.y = colHeaderRect.y - offsetTop;
                                colHeaderRect.height = colHeaderRect.height + offsetTop;
                                if (!rowHeaderVisible && isNotHaveRowOutline) {
                                    colHeaderRect.x = colHeaderRect.x - offsetLeft;
                                    colHeaderRect.width = colHeaderRect.width + offsetLeft;
                                }
                            }
                            intersectRect = clipRect ? colHeaderRect.getIntersectRect(clipRect) : colHeaderRect;
                            if (intersectRect) {
                                self._paintColHeader(ctx, c, intersectRect, isPrinting, printZoomFactor);
                            }
                        }
                    }
                    for (r = 0; r <= 2; r++) {
                        var rowHeaderRect = layout._rowHeaderRect(r);
                        if (rowHeaderRect) {
                            if (rowHeaderVisible && isNotHaveRowOutline) {
                                rowHeaderRect.x = rowHeaderRect.x - offsetLeft;
                                rowHeaderRect.width = rowHeaderRect.width + offsetLeft;
                                if (!colHeaderVisible && isNotColOutline) {
                                    rowHeaderRect.y = rowHeaderRect.y - offsetTop;
                                    rowHeaderRect.height = rowHeaderRect.height + offsetTop;
                                }
                            }
                            intersectRect = clipRect ? rowHeaderRect.getIntersectRect(clipRect) : rowHeaderRect;
                            if (intersectRect) {
                                self._paintRowHeader(ctx, r, intersectRect, isPrinting, printZoomFactor);
                            }
                        }
                        for (c = 0; c <= 2; c++) {
                            var viewportRect = layout._viewportRect(r, c);
                            if (self._isNeedTopLine(sheet._getViewportFirstVisualRow(r)) && isNotColOutline) {
                                viewportRect.y = viewportRect.y - offsetTop;
                                viewportRect.height = viewportRect.height + offsetTop;
                            }
                            if (self._isNeedLeftLine(sheet._getViewportFirstVisualColumn(c)) && isNotHaveRowOutline) {
                                viewportRect.x = viewportRect.x - offsetLeft;
                                viewportRect.width = viewportRect.width + offsetLeft;
                            }
                            if (viewportRect) {
                                intersectRect = clipRect ? viewportRect.getIntersectRect(clipRect) : viewportRect;
                                if (intersectRect) {
                                    self._paintViewport(ctx, r, c, intersectRect, isPrinting, printZoomFactor);
                                }
                            }
                        }
                    }

                    var headerCornerRect = layout._headerCornerRect();
                    if (headerCornerRect) {
                        intersectRect = clipRect ? headerCornerRect.getIntersectRect(clipRect) : headerCornerRect;
                        if (intersectRect) {
                            self._paintColHeaderCorner(ctx, intersectRect, isPrinting, printZoomFactor);
                        }
                    }
                };
                _SheetRender.prototype._paintGrayArea = function (ctx) {
                    var self = this;
                    var sheet = self._sheet;
                    var layout = sheet._getSheetLayout();
                    var headerX = layout._headerX;
                    var headerY = layout._headerY;
                    var layout_width = getWidth(layout);
                    var frozenTrailingY = layout._frozenTrailingY;
                    var frozenTrailingHeight = layout._frozenTrailingHeight;
                    var grayAreaX = layout._grayAreaX;
                    var grayAreaWidth = layout._grayAreaWidth;
                    var grayAreaY = layout._grayAreaY;
                    var grayAreaHeight = layout._grayAreaHeight;
                    if (grayAreaHeight > 0) {
                        ctx.fillStyle = self._getGrayAreaBackColor(false);
                        ctx.fillRect(headerX, grayAreaY, layout_width, grayAreaHeight);
                    }
                    if (grayAreaWidth > 0) {
                        ctx.fillStyle = self._getGrayAreaBackColor(false);
                        ctx.fillRect(grayAreaX, headerY, grayAreaWidth, grayAreaY);
                        var frozenTrailingRowStickToEdge = sheet._frozenTrailingRowStickToEdge;
                        if (frozenTrailingRowStickToEdge) {
                            ctx.fillRect(grayAreaX, frozenTrailingY, grayAreaWidth, frozenTrailingHeight);
                        }
                    }
                };
                _SheetRender.prototype._paintSheetOffset = function (ctx, rect) {
                    var self = this;
                    var sheet = self._sheet;
                    var grayAreaBackColor = self._getGrayAreaBackColor(false);
                    var options = sheet.options;
                    var offsetLeft = options.sheetAreaOffset.left;
                    var offsetTop = options.sheetAreaOffset.top;
                    var rectX = rect.x;
                    var rectY = rect.y;
                    var width = getWidth(rect);
                    var height = getHeight(rect);
                    ctx.save();
                    if (offsetLeft > 0) {
                        _strokeLine(ctx, offsetLeft, grayAreaBackColor, rectX + offsetLeft / 2, offsetTop > 0 ? (rectY + offsetTop) : rectY, rectX + offsetLeft / 2, rectY + Math_max(0, height));
                    }
                    if (offsetTop > 0) {
                        _strokeLine(ctx, offsetTop, grayAreaBackColor, offsetLeft > 0 ? (rectX + offsetLeft) : rectX, rectY + offsetTop / 2, rectX + Math_max(0, width), rectY + offsetTop / 2);
                    }
                    if (offsetLeft > 0 && offsetTop > 0) {
                        ctx.fillStyle = self._getGrayAreaBackColor(false);
                        ctx.fillRect(rectX, rectY, offsetLeft, offsetTop);
                    }
                    ctx.beginPath();
                    ctx.restore();
                };
                _SheetRender.prototype._paintSheet = function (ctx, clipRect) {
                    var self = this;
                    var sheet = self._sheet;
                    if (!ctx || sheet._layoutSuspended > 0) {
                        return;
                    }
                    var rect = sheet._getBounds();
                    ctx.save();
                    if (!clipRect) {
                        ctx.rect(rect.x, rect.y, getWidth(rect), getHeight(rect));
                    } else {
                        ctx.rect(clipRect.x, clipRect.y, getWidth(clipRect), getHeight(clipRect));
                    }
                    ctx.clip();
                    ctx.beginPath();
                    self._paintBackground(ctx, rect);
                    worksheet_1.Worksheet._callFeatureHandler(sheet, 'paint', {
                        ctx: ctx,
                        clipRect: clipRect
                    });
                    self._paintSheetOffset(ctx, rect);
                    self._paintHeadersAndViewport(ctx, clipRect, false);
                    self._paintGrayArea(ctx);
                    self._paintFrozenLine(ctx);
                    worksheet_1.Worksheet._callFeatureHandler(sheet, 'paintSheetEnd', {
                        ctx: ctx,
                        clipRect: clipRect
                    });
                    ctx.beginPath();
                    ctx.restore();
                };
                _SheetRender.prototype._paintSheetForPrint = function (ctx, clipRect, printZoomFactor) {
                    var self = this;
                    var sheet = self._sheet;
                    if (!ctx) {
                        return;
                    }
                    var rect = sheet._getBounds();
                    ctx.save();
                    var actualClipRect = clipRect || new common_1.Rect(rect.x, rect.y, getWidth(rect), getHeight(rect));
                    ctx.rect(actualClipRect.x, actualClipRect.y, getWidth(actualClipRect), getHeight(actualClipRect));
                    ctx.clip();
                    ctx.beginPath();
                    self._paintBackground(ctx, rect);
                    self._paintHeadersAndViewport(ctx, actualClipRect, true, printZoomFactor);
                    ctx.beginPath();
                    ctx.restore();
                };
                _SheetRender.prototype._paintResizeLine = function (ctx) {
                    var x;
                    var y;
                    var movingX;
                    var movingY;
                    var endX;
                    var endY;
                    var sheet = this._sheet;
                    var eventHandler = sheet._eventHandler;
                    var currentTarget = sheet._currentTarget;
                    if (eventHandler && eventHandler.isResizing && currentTarget) {
                        var resizeInfo = currentTarget.resizeInfo;
                        if (resizeInfo) {
                            var sheetLayout = sheet._getSheetLayout();
                            var lineColor = '#A9A9B8';
                            ctx.save();
                            if (ctx.strokeStyle !== lineColor) {
                                ctx.strokeStyle = lineColor;
                            }
                            if (ctx.lineWidth !== 1) {
                                ctx.lineWidth = 1;
                            }
                            ctx.beginPath();
                            if (resizeInfo.action === 'sizeRow' || resizeInfo.action === 'sizeHiddenRow') {
                                y = Math_max(0, resizeInfo.startY - 0.5);
                                movingY = resizeInfo.movingY - 0.5;
                                endX = sheetLayout.x + getWidth(sheetLayout);
                                for (x = sheetLayout.x; x < endX; x += 6) {
                                    ctx.moveTo(x, y);
                                    ctx.lineTo(x + 4, y);
                                    ctx.moveTo(x, movingY);
                                    ctx.lineTo(x + 4, movingY);
                                }
                            } else {
                                x = Math_max(0, resizeInfo.startX - 0.5);
                                movingX = resizeInfo.movingX - 0.5;
                                endY = sheetLayout.y + getHeight(sheetLayout);
                                for (y = sheetLayout.y; y < endY; y += 6) {
                                    ctx.moveTo(x, y);
                                    ctx.lineTo(x, y + 4);
                                    ctx.moveTo(movingX, y);
                                    ctx.lineTo(movingX, y + 4);
                                }
                            }
                            ctx.stroke();
                            ctx.beginPath();
                            ctx.restore();
                        }
                    }
                };
                _SheetRender.prototype._paintColHeaderCorner = function (ctx, clipRect, isPrinting, printZoomFactor) {
                    var sheet = this._sheet;
                    ctx.beginPath();
                    var rect = sheet._getSheetLayout()._headerCornerRect();
                    var x = rect.x;
                    var y = rect.y;
                    var width = getWidth(rect);
                    var height = getHeight(rect);
                    var style = sheet.getActualStyle(-1, -1, 0);
                    this._paintCells(ctx, [{
                        data: keyword_null,
                        row: -1,
                        col: -1,
                        x: x,
                        y: y,
                        width: width,
                        height: height,
                        style: style.clone()
                    }], 0, isPrinting, printZoomFactor);
                    var border = new worksheet_border_1._Borders(sheet, sheet._getRowLayout(0, 0), sheet._getColumnLayout(0, 0), 0);
                    border._addCellLines(0, 0, x, y, width, height);
                    border.paint(ctx);
                };
                _SheetRender.prototype._paintFrozenLine = function (ctx) {
                    var sheet = this._sheet;
                    var frozenRowCount = sheet.frozenRowCount();
                    var frozenColCount = sheet.frozenColumnCount();
                    var frozenTrailingRowCount = sheet.frozenTrailingRowCount();
                    var frozenTrailingColCount = sheet.frozenTrailingColumnCount();
                    if (frozenRowCount || frozenColCount || frozenTrailingRowCount || frozenTrailingColCount) {
                        var sheetLayout = sheet._getSheetLayout();
                        var viewportX = sheetLayout._viewportX;
                        var viewportY = sheetLayout._viewportY;
                        var frozenTrailingX = sheetLayout._frozenTrailingX;
                        var frozenTrailingY = sheetLayout._frozenTrailingY;
                        var sheetLayout_x = sheetLayout.x;
                        var sheetLayout_y = sheetLayout.y;
                        var sheetLayout_width = getWidth(sheetLayout);
                        var sheetLayout_height = getHeight(sheetLayout);
                        ctx.save();
                        ctx.strokeStyle = common_1._ThemeContext._getColor(sheet, sheet.options.frozenlineColor);
                        ctx.lineWidth = 1;
                        ctx.beginPath();
                        if (frozenColCount) {
                            ctx.moveTo(viewportX - 0.5, sheetLayout_y);
                            ctx.lineTo(viewportX - 0.5, sheetLayout_y + sheetLayout_height);
                        }
                        if (frozenRowCount) {
                            ctx.moveTo(sheetLayout_x, viewportY - 0.5);
                            ctx.lineTo(sheetLayout_x + sheetLayout_width, viewportY - 0.5);
                        }
                        if (frozenTrailingColCount) {
                            ctx.moveTo(frozenTrailingX - 0.5, sheetLayout_y);
                            ctx.lineTo(frozenTrailingX - 0.5, sheetLayout_y + sheetLayout_height);
                        }
                        if (frozenTrailingRowCount) {
                            ctx.moveTo(sheetLayout_x, frozenTrailingY - 0.5);
                            ctx.lineTo(sheetLayout_x + sheetLayout_width, frozenTrailingY - 0.5);
                        }
                        ctx.stroke();
                        ctx.restore();
                    }
                };
                _SheetRender.prototype._paintColHeader = function (ctx, c, clipRect, isPrinting, printZoomFactor) {
                    this._paintViewportImp(ctx, -1, c, 1, clipRect, isPrinting, printZoomFactor);
                };
                _SheetRender.prototype._paintRowHeader = function (ctx, r, clipRect, isPrinting, printZoomFactor) {
                    this._paintViewportImp(ctx, r, -1, 2, clipRect, isPrinting, printZoomFactor);
                };
                _SheetRender.prototype._paintViewport = function (ctx, rowViewportIndex, colViewportIndex, clipRect, isPrinting, printZoomFactor) {
                    var sheet = this._sheet;
                    var vpCalcSheetModel = sheet._vpCalcSheetModel;
                    if (vpCalcSheetModel) {
                        var calcService = vpCalcSheetModel.getCalcService();
                        if (calcService && calcService.calcOnDemand) {
                            var source = vpCalcSheetModel._source;
                            source.clearValueCache && source.clearValueCache();
                        }
                    }
                    this._paintViewportImp(ctx, rowViewportIndex, colViewportIndex, 3, clipRect, isPrinting, printZoomFactor);
                    var cutCopyIndicatorManager = this._sheet._cutCopyIndicatorManager;
                    if (cutCopyIndicatorManager) {
                        cutCopyIndicatorManager._paintCutCopyIndicator(ctx, clipRect, rowViewportIndex, colViewportIndex);
                    }
                };
                _SheetRender.prototype._paintDynamicArrayIndicator = function (ctx, rowViewportIndex, colViewportIndex, clipRect, anchor) {
                    var self = this;
                    var sheet = self._sheet;
                    var rect = sheet.getRangeRect(rowViewportIndex, colViewportIndex, common_1._createRange(anchor.row, anchor.col, anchor.rowCount, anchor.colCount));
                    rect = rect.getIntersectRect(sheet._getSheetLayout()._viewportRect(rowViewportIndex, colViewportIndex));
                    if (rect) {
                        rect.round();
                        var isValid = anchor.isValid;
                        ctx.save();
                        ctx.lineWidth = 1;
                        ctx.strokeStyle = 'mediumblue';
                        if (!isValid) {
                            ctx.setLineDash([6, 2]);
                        }
                        var x = rect.x + 0.5;
                        var y = rect.y + 0.5;
                        ctx.strokeRect(x, y, getWidth(rect), getHeight(rect));
                        ctx.beginPath();
                        ctx.restore();
                    }
                };
                _SheetRender.prototype._paintSelection = function (ctx, rowViewportIndex, colViewportIndex, clipRect) {
                    var self = this;
                    var sheet = self._sheet;
                    var posAdjust;
                    var sizeAdjust;
                    var selectionBackColor;
                    var selectionBorderColor;
                    if (needPaintSelection(sheet)) {
                        if (!sheet.addSelection) {
                            return;
                        }
                        var modelManager = sheet._modelManager;
                        var eventHandler = sheet._eventHandler;
                        var selections = modelManager.getSelections();
                        var selectionCount = selections.length;
                        clipRect = self._getClipRect(rowViewportIndex, colViewportIndex, clipRect);
                        if (!clipRect) {
                            return;
                        }
                        var themeStyle = common_1._ThemeStyleHelper._getCssClassThemeStyle('gc-selection');
                        var themeVersion = parseIntFunc(themeStyle.zIndex);
                        if (themeVersion > 2007) {
                            self._paintHeaderSelection(ctx, rowViewportIndex, colViewportIndex, clipRect);
                        }
                        var anchor = modelManager._selectedAnchor = modelManager._dynamicArrayManager.getAnchorInfo(sheet.getActiveRowIndex(), sheet.getActiveColumnIndex());
                        if (anchor) {
                            self._paintDynamicArrayIndicator(ctx, rowViewportIndex, colViewportIndex, clipRect, anchor);
                        }
                        var selectionRects = self._getPaintingRects(rowViewportIndex, colViewportIndex, selections, clipRect), selectionRectCount = selectionRects.length, selectionRect = void 0;
                        if (selectionRectCount <= 0) {
                            return;
                        }
                        var deselectRect = self._getPaintingRects(rowViewportIndex, colViewportIndex, [sheet._deselectRange], clipRect)[0];
                        var needClip = false, i = void 0;
                        for (i = 0; i < selectionRectCount; i++) {
                            selectionRect = selectionRects[i];
                            if (!clipRect.containsRect(selectionRect)) {
                                needClip = true;
                                break;
                            }
                        }
                        if (deselectRect && !clipRect.containsRect(deselectRect)) {
                            needClip = true;
                        }
                        ctx.save();
                        if (needClip) {
                            ctx.rect(clipRect.x, clipRect.y, getWidth(clipRect), getHeight(clipRect));
                            ctx.clip();
                        }
                        ctx.beginPath();
                        selectionBorderColor = common_1._ThemeContext._getColor(sheet, sheet.getSelectionBorderColor());
                        selectionBackColor = common_1._ThemeContext._getColor(sheet, sheet.getSelectionBackColor());
                        if (ctx.fillStyle !== selectionBackColor) {
                            ctx.fillStyle = selectionBackColor;
                        }
                        posAdjust = 0;
                        sizeAdjust = 0;
                        if (themeVersion > 2007) {
                            posAdjust = 1;
                            sizeAdjust = -3;
                        }
                        for (i = 0; i < selectionRectCount; i++) {
                            selectionRect = selectionRects[i];
                            ctx.fillRect(selectionRect.x + posAdjust, selectionRect.y + posAdjust, getWidth(selectionRect) + sizeAdjust, getHeight(selectionRect) + sizeAdjust);
                            if (selectionCount > 1) {
                                ctx.strokeStyle = selectionBorderColor;
                                ctx.lineWidth = 1;
                                ctx.strokeRect(selectionRect.x - 0.5, selectionRect.y - 0.5, selectionRect.width, selectionRect.height);
                            }
                        }

                        if (!sheet._isDropdownSheet) {
                            var activeRowIndex = sheet._activeRowIndex;
                            var activeColIndex = sheet._activeColIndex;
                            if (deselectRect) {
                                activeRowIndex = sheet._oldActiveRow;
                                activeColIndex = sheet._oldActiveCol;
                            }
                            var rect = sheet.getCellRect(activeRowIndex, activeColIndex, rowViewportIndex, colViewportIndex);
                            var rectX = void 0;
                            var rectY = void 0;
                            var rectWidth = void 0;
                            var rectHeight = void 0;
                            if (rect && rect.intersectRect(clipRect)) {
                                rectX = rect.x;
                                rectY = rect.y;
                                rectWidth = getWidth(rect);
                                rectHeight = getHeight(rect);
                                posAdjust = 1;
                                sizeAdjust = -2;
                                if (themeVersion > 2007) {
                                    posAdjust = 0;
                                    sizeAdjust = 0;
                                }
                                self._copyDoubleBuffer(rectX + posAdjust, rectY + posAdjust, rectWidth + sizeAdjust, rectHeight + sizeAdjust);
                                if (selectionCount > 1) {
                                    ctx.strokeStyle = selectionBorderColor;
                                    ctx.lineWidth = 2;
                                    ctx.strokeRect(rectX, rectY, rectWidth - 1, rectHeight - 1);
                                }
                            }
                        }
                        ctx.restore();
                        ctx.save();
                        ctx.beginPath();
                        if (selectionCount === 1) {
                            if (eventHandler && eventHandler._isDraggingFill && eventHandler._isDragClear && eventHandler._isDragClear() && !eventHandler._isDragAroundIndicator) {
                                var fillRange = eventHandler._getCurrentFillRange && eventHandler._getCurrentFillRange();
                                var fillRect = sheet.getRangeRect(rowViewportIndex, colViewportIndex, fillRange);
                                var fillRectWidth = getWidth(fillRect);
                                var fillRectHeight = getHeight(fillRect);
                                if (fillRect && fillRectWidth > 0 && fillRectHeight > 0) {
                                    ctx.fillStyle = themeStyle && themeStyle.color;
                                    ctx.fillRect(fillRect.x, fillRect.y, fillRectWidth, fillRectHeight);
                                }
                            }
                            if (selectionRect && getWidth(selectionRect) >= 0 && getHeight(selectionRect) >= 0) {
                                self._adjustClipRect(clipRect, sheet, rowViewportIndex, colViewportIndex, themeVersion);
                                self._paintSelectionBorder(ctx, rowViewportIndex, colViewportIndex, selectionRect, clipRect, selections[0]);
                            }
                        }
                        if (deselectRect) {
                            ctx.save();
                            if (needClip) {
                                ctx.rect(clipRect.x, clipRect.y, getWidth(clipRect), getHeight(clipRect));
                                ctx.clip();
                            }
                            ctx.beginPath();
                            ctx.fillStyle = 'rgba(255,255,255,0.4)';
                            ctx.fillRect(deselectRect.x + posAdjust, deselectRect.y + posAdjust, getWidth(deselectRect) + sizeAdjust, getHeight(deselectRect) + sizeAdjust);
                            ctx.strokeStyle = common_1._ThemeContext._getColor(sheet, sheet.getSelectionBorderColor());
                            ctx.lineWidth = 1;
                            ctx.strokeRect(deselectRect.x - 0.5, deselectRect.y - 0.5, getWidth(deselectRect), getHeight(deselectRect));
                            ctx.restore();
                        }
                        sheet._trigger('customPaintSelection', {
                            ctx,
                            sheet,
                        });
                        ctx.beginPath();
                        ctx.restore();
                    }
                };
                _SheetRender.prototype._adjustClipRect = function (clipRect, sheet, rowViewportIndex, colViewportIndex, themeVersion) {
                    var frozenTrailingRowCount = sheet.frozenTrailingRowCount();
                    var frozenTrailingColCount = sheet.frozenTrailingColumnCount();
                    var selections = sheet.getSelections();
                    var layout = sheet._getSheetLayout();
                    var lastViewportRowIndex = sheet.getRowCount() - frozenTrailingRowCount - 1;
                    var lastViewportColIndex = sheet.getColumnCount() - frozenTrailingColCount - 1;
                    var colLayout = sheet._getColumnLayout(1, 3);
                    var rowLayout = sheet._getRowLayout(1, 3);
                    if (selections.length === 1 && themeVersion > 2007) {
                        var frozenRowCount = sheet.frozenRowCount();
                        var frozenColCount = sheet.frozenColumnCount();
                        var sel = selections[0];
                        var selRow = sel.row;
                        var selCol = sel.col;
                        var selRowCount = sel.rowCount;
                        var selColCount = sel.colCount;
                        if (frozenRowCount > 0) {
                            if (selRow >= frozenRowCount && sheet._getPrevVisualRow(selRow) < frozenRowCount) {
                                clipRect.y -= 2;
                                clipRect.height += 2;
                            } else if (selRow + selRowCount <= frozenRowCount && sheet._getNextVisualRow(selRow + selRowCount - 1) === sheet._scrollTopRow) {
                                clipRect.height += 2;
                            }
                        }
                        if (frozenColCount > 0) {
                            if (selCol >= frozenColCount && sheet._getPrevVisualColumn(selCol) < frozenColCount) {
                                clipRect.x -= 2;
                                clipRect.width += 2;
                            } else if (selCol + selColCount <= frozenColCount && sheet._getNextVisualColumn(selCol + selColCount - 1) === sheet._scrollLeftCol) {
                                clipRect.width += 2;
                            }
                        }
                        if (selRow === 0 && selCol === 0) {
                            clipRect.x -= 2;
                            clipRect.y -= 2;
                            clipRect.width += 2;
                            clipRect.height += 2;
                        }
                        if (selRow === -1) {
                            selRow = 0;
                            selRowCount = sheet.getRowCount();
                        }
                        if (selCol === -1) {
                            selCol = 0;
                            selColCount = sheet.getColumnCount();
                        }
                        var isLastRowInViewportVisible = false;
                        var isLastColInViewportVisible = false;
                        var lastViewportRowLayout = rowLayout.findRow(lastViewportRowIndex);
                        var lastViewportColLayout = colLayout.findCol(lastViewportColIndex);
                        if (lastViewportRowLayout && lastViewportRowLayout.y + getHeight(lastViewportRowLayout) < layout._viewportY + sheet._getActualViewportHeight(layout)) {
                            isLastRowInViewportVisible = true;
                        }
                        if (lastViewportColLayout && lastViewportColLayout.x + getWidth(lastViewportColLayout) < layout._viewportX + sheet._getActualViewportWidth(layout)) {
                            isLastColInViewportVisible = true;
                        }
                        if (isLastRowInViewportVisible && selRow + selRowCount - 1 === lastViewportRowIndex) {
                            clipRect.height += 2;
                        }
                        if (isLastColInViewportVisible && selCol + selColCount - 1 === lastViewportColIndex) {
                            clipRect.width += 2;
                        }
                    }
                };
                _SheetRender.prototype._paintHeaderSelection = function (ctx, rowViewportIndex, colViewportIndex, clipRect) {
                    var self = this;
                    var sheet = self._sheet;
                    var selections = sheet._modelManager.getSelections();
                    var layout = sheet._getSheetLayout();
                    var layout_frozenX = layout._frozenX;
                    var layout_frozenY = layout._frozenY;
                    var selectionCount = selections.length;
                    var colHeaderVisible = layout._colHeaderHeight !== 0;
                    var rowHeaderVisible = layout._rowHeaderWidth !== 0;
                    if (selectionCount <= 0) {
                        return;
                    }
                    var selection = selections[0];
                    var selRow = selection.row;
                    var selRowCount = selection.rowCount;
                    var selCol = selection.col;
                    var selColCount = selection.colCount;
                    if (selRow === -1) {
                        selRow = 0;
                    }
                    if (selCol === -1) {
                        selCol = 0;
                    }
                    if (selRowCount === -1) {
                        selRowCount = sheet.getRowCount();
                    }
                    if (selColCount === -1) {
                        selColCount = sheet.getColumnCount();
                    }
                    ctx.save();
                    ctx.beginPath();
                    ctx.lineWidth = 2;
                    ctx.strokeStyle = sheet.getSelectionBorderColor();
                    var clipRectX = clipRect.x;
                    var clipRectY = clipRect.y;
                    var clipRectWidth = getWidth(clipRect);
                    var clipRectHeight = getHeight(clipRect);
                    var frozenRowCount = sheet.frozenRowCount();
                    if (colHeaderVisible && (selectionCount !== 1 || frozenRowCount !== 0 || sheet._scrollTopRow <= selRow || sheet._scrollTopRow >= selRow + selRowCount)) {
                        var columnHeaderScope = self._getColumnHeaderSelectionRects(colViewportIndex);
                        for (var i = 0, len = columnHeaderScope.length; i < len; i++) {
                            var colRect = columnHeaderScope[i];
                            var leftExpand = 0;
                            var rightExpand = 0;
                            var startX = colRect.x;
                            var endX = colRect.x + getWidth(colRect);
                            if (colRect.x < clipRectX + clipRectWidth && clipRectX < colRect.x + getWidth(colRect)) {
                                if (selectionCount === 1 && (frozenRowCount === 0 && sheet._scrollTopRow === selRow || frozenRowCount > 0 && selRow === 0)) {
                                    leftExpand = -1;
                                    rightExpand = 1;
                                }
                                if (colRect.x < clipRectX) {
                                    leftExpand = 0;
                                    startX = clipRectX;
                                }
                                if (colRect.x + getWidth(colRect) > clipRectX + clipRectWidth) {
                                    rightExpand = 0;
                                    endX = clipRectX + clipRectWidth;
                                }
                                ctx.moveTo(startX + leftExpand - 1, layout_frozenY - 1);
                                ctx.lineTo(endX + rightExpand, layout_frozenY - 1);
                                ctx.stroke();
                            }
                        }
                    }
                    var frozenColCount = sheet.frozenColumnCount();
                    if (rowHeaderVisible && (selectionCount !== 1 || frozenColCount !== 0 || sheet._scrollLeftCol <= selCol || sheet._scrollLeftCol >= selCol + selColCount)) {
                        var rowHeaderScope = self._getRowHeaderSelectionRects(rowViewportIndex);
                        for (var j = 0, length_2 = rowHeaderScope.length; j < length_2; j++) {
                            var rowRect = rowHeaderScope[j];
                            var topExpand = 0;
                            var bottomExpand = 0;
                            var startY = rowRect.y;
                            var endY = rowRect.y + getHeight(rowRect);
                            if (rowRect.y < clipRectY + clipRectHeight && clipRectY < rowRect.y + getHeight(rowRect)) {
                                if (selectionCount === 1 && (frozenColCount === 0 && sheet._scrollLeftCol === selCol || frozenColCount > 0 && selCol === 0)) {
                                    topExpand = -1;
                                    bottomExpand = 1;
                                }
                                if (rowRect.y < clipRectY) {
                                    topExpand = 0;
                                    startY = clipRectY;
                                }
                                if (rowRect.y + getHeight(rowRect) > clipRectY + clipRectHeight) {
                                    bottomExpand = 0;
                                    endY = clipRectY + clipRectHeight;
                                }
                                ctx.moveTo(layout_frozenX - 1, startY + topExpand - 1);
                                ctx.lineTo(layout_frozenX - 1, endY + bottomExpand);
                                ctx.stroke();
                            }
                        }
                    }
                    ctx.beginPath();
                    ctx.restore();
                };
                _SheetRender.prototype._getColumnHeaderSelectionRects = function (colViewportIndex) {
                    var sheet = this._sheet;
                    var selections = sheet._modelManager.getSelections();
                    var selectionCount = selections.length;
                    var columnLayout = sheet._getColumnLayout(colViewportIndex);
                    var columnHeaderScope = [];
                    var rectCache = {}, cacheKey;
                    for (var i = 0; i < selectionCount; i++) {
                        var sel = selections[i];
                        if (sel) {
                            var selCol = sel.col;
                            if (selCol === -1) {
                                var fronzenColLayout = sheet._getColumnLayout(0, 3);
                                var viewportColLayout = sheet._getColumnLayout(1, 3);
                                var trailingFrozenColLayout = sheet._getColumnLayout(2, 3);
                                var x = -1;
                                var width = -1;
                                if (fronzenColLayout.length > 0) {
                                    x = fronzenColLayout[0].x;
                                    width = fronzenColLayout[fronzenColLayout.length - 1].x + fronzenColLayout[fronzenColLayout.length - 1].width - x;
                                    columnHeaderScope.push(new common_1.Rect(x, -1, width, -1));
                                }
                                if (viewportColLayout.length > 0) {
                                    x = viewportColLayout[0].x;
                                    width = viewportColLayout[viewportColLayout.length - 1].x + viewportColLayout[viewportColLayout.length - 1].width - x;
                                    columnHeaderScope.push(new common_1.Rect(x, -1, width, -1));
                                }
                                if (trailingFrozenColLayout.length > 0) {
                                    x = trailingFrozenColLayout[0].x;
                                    width = trailingFrozenColLayout[trailingFrozenColLayout.length - 1].x + trailingFrozenColLayout[trailingFrozenColLayout.length - 1].width - x;
                                    columnHeaderScope.push(new common_1.Rect(x, -1, width, -1));
                                }
                            } else if (columnLayout) {
                                var selStartColumnLayout = columnLayout.findCol(selCol);
                                var selEndColumnLayout = columnLayout.findCol(selCol + sel.colCount - 1);
                                if (selStartColumnLayout || selEndColumnLayout) {
                                    var rect = new common_1.Rect(-1, -1, -1, -1);
                                    if (selStartColumnLayout) {
                                        rect.x = selStartColumnLayout.x;
                                    } else {
                                        rect.x = columnLayout[0].x;
                                    }
                                    if (selEndColumnLayout) {
                                        rect.width = selEndColumnLayout.x + getWidth(selEndColumnLayout) - rect.x;
                                    } else {
                                        rect.width = columnLayout[columnLayout.length - 1].x + columnLayout[columnLayout.length - 1].width - rect.x;
                                    }
                                    cacheKey = [rect.x, rect.width].join('_');
                                    if (rectCache[cacheKey]) {
                                        continue;
                                    }
                                    rectCache[cacheKey] = true;
                                    columnHeaderScope.push(rect);
                                }
                            }
                        }
                    }
                    return columnHeaderScope;
                };
                _SheetRender.prototype._getRowHeaderSelectionRects = function (rowViewportIndex) {
                    var sheet = this._sheet;
                    var selections = sheet._modelManager.getSelections();
                    var selectionCount = selections.length;
                    var rowLayout = sheet._getRowLayout(rowViewportIndex), rowHeaderScope = [];
                    var rectCache = {}, cacheKey;
                    for (var i = 0; i < selectionCount; i++) {
                        var sel = selections[i];
                        if (sel) {
                            var selRow = sel.row;
                            if (selRow === -1) {
                                var fronzenRowLayout = sheet._getRowLayout(0, 3);
                                var viewportRowLayout = sheet._getRowLayout(1, 3);
                                var trailingFrozenRowLayout = sheet._getRowLayout(2, 3);
                                var y = -1;
                                var height = -1;
                                if (fronzenRowLayout.length > 0) {
                                    y = fronzenRowLayout[0].y;
                                    height = fronzenRowLayout[fronzenRowLayout.length - 1].y + fronzenRowLayout[fronzenRowLayout.length - 1].height - y;
                                    rowHeaderScope.push(new common_1.Rect(-1, y, -1, height));
                                }
                                if (viewportRowLayout.length > 0) {
                                    y = viewportRowLayout[0].y;
                                    height = viewportRowLayout[viewportRowLayout.length - 1].y + viewportRowLayout[viewportRowLayout.length - 1].height - y;
                                    rowHeaderScope.push(new common_1.Rect(-1, y, -1, height));
                                }
                                if (trailingFrozenRowLayout.length > 0) {
                                    y = trailingFrozenRowLayout[0].y;
                                    height = trailingFrozenRowLayout[trailingFrozenRowLayout.length - 1].y + trailingFrozenRowLayout[trailingFrozenRowLayout.length - 1].height - y;
                                    rowHeaderScope.push(new common_1.Rect(-1, y, -1, height));
                                }
                            } else if (rowLayout) {
                                var selStartRowLayout = rowLayout.findRow(selRow);
                                var selEndRowLayout = rowLayout.findRow(selRow + sel.rowCount - 1);
                                if (selStartRowLayout || selEndRowLayout) {
                                    var rect = new common_1.Rect(-1, -1, -1, -1);
                                    if (selStartRowLayout) {
                                        rect.y = selStartRowLayout.y;
                                    } else {
                                        rect.y = rowLayout[0].y;
                                    }
                                    if (selEndRowLayout) {
                                        rect.height = selEndRowLayout.y + getHeight(selEndRowLayout) - rect.y;
                                    } else {
                                        rect.height = rowLayout[rowLayout.length - 1].y + rowLayout[rowLayout.length - 1].height - rect.y;
                                    }
                                    cacheKey = [rect.y, rect.height].join('_');
                                    if (rectCache[cacheKey]) {
                                        continue;
                                    }
                                    rectCache[cacheKey] = true;
                                    rowHeaderScope.push(rect);
                                }
                            }
                        }
                    }
                    return rowHeaderScope;
                };
                _SheetRender.prototype._paintSelectionBorder = function (ctx, rowViewportIndex, colViewportIndex, selectRect, clipRect, selection) {
                    var self = this;
                    var sheet = self._sheet;
                    var parent = sheet.parent;
                    var eventHandler = sheet._eventHandler;
                    var selectRect_x = selectRect.x;
                    var selectRect_y = selectRect.y;
                    var selectRect_width = getWidth(selectRect);
                    var selectRect_height = getHeight(selectRect);
                    var topRow = sheet.getViewportTopRow(rowViewportIndex);
                    var leftColumn = sheet.getViewportLeftColumn(colViewportIndex);
                    var bottomRow = sheet.getViewportBottomRow(rowViewportIndex);
                    var rightColumn = sheet.getViewportRightColumn(colViewportIndex);
                    var clipRectOffsetX = 0;
                    var clipRectOffsetY = 0;
                    var layout = sheet._getSheetLayout();
                    var colHeaderVisible = layout._colHeaderHeight !== 0;
                    var rowHeaderVisible = layout._rowHeaderWidth !== 0;
                    if (!rowHeaderVisible && (selection.col === leftColumn || selection.col === -1)) {
                        clipRectOffsetX = 2;
                    }
                    if (!colHeaderVisible && (selection.row === topRow || selection.row === -1)) {
                        clipRectOffsetY = 2;
                    }
                    if (selection.row + selection.rowCount === bottomRow + 1) {
                        clipRect.height = clipRect.height + 1;
                    }
                    if (selection.col + selection.colCount === rightColumn + 1) {
                        clipRect.width = clipRect.width + 1;
                    }
                    if (selectRect_width >= 0 && selectRect_height >= 0 && (!clipRect || selectRect.intersect(clipRect.x - 1, clipRect.y - 1, getWidth(clipRect) + 2, getHeight(clipRect) + 2))) {
                        ctx.save();
                        if (clipRect && !clipRect.containsRect(selectRect)) {
                            ctx.rect(clipRect.x - clipRectOffsetX, clipRect.y - clipRectOffsetY, getWidth(clipRect), getHeight(clipRect));
                            ctx.clip();
                        }
                        ctx.beginPath();
                        ctx.strokeStyle = common_1._ThemeContext._getColor(sheet, sheet.getSelectionBorderColor());
                        ctx.lineWidth = 2;
                        if (selectRect_width > 0 && selectRect_height > 0) {
                            if (eventHandler && eventHandler._isDraggingFill) {
                                var currentFillDirection = eventHandler._currentFillDirection;
                                if (currentFillDirection === 2) {
                                    ctx.moveTo(selectRect_x + 0.5, selectRect_y - 0.5);
                                    ctx.lineTo(selectRect_x + selectRect_width - 1, selectRect_y - 0.5);
                                } else if (currentFillDirection === 3) {
                                    ctx.moveTo(selectRect_x + 0.5, selectRect_y + selectRect_height - 0.5);
                                    ctx.lineTo(selectRect_x + selectRect_width - 1, selectRect_y + selectRect_height - 0.5);
                                } else if (currentFillDirection === 0) {
                                    ctx.moveTo(selectRect_x - 0.5, selectRect_y + 0.5);
                                    ctx.lineTo(selectRect_x - 0.5, selectRect_y + selectRect_height - 1);
                                } else if (currentFillDirection === 1) {
                                    ctx.moveTo(selectRect_x + selectRect_width - 0.5, selectRect_y + 0.5);
                                    ctx.lineTo(selectRect_x + selectRect_width - 0.5, selectRect_y + selectRect_height - 1);
                                }
                            } else {
                                var themeVersion = parent && parent._themeVersion;
                                if (themeVersion > 2007) {
                                    ctx.rect(selectRect_x - 1, selectRect_y - 1, selectRect_width + 1, selectRect_height + 1);
                                } else {
                                    ctx.rect(selectRect_x - 0.5, selectRect_y - 0.5, selectRect_width, selectRect_height);
                                }
                            }
                            ctx.stroke();
                            if (parent && parent.options.allowUserDragFill && self._paintDragFillIndicator) {
                                self._paintDragFillIndicator(ctx, rowViewportIndex, colViewportIndex, selectRect, clipRect);
                            }
                        } else if (selectRect_width === 0 || selectRect_height === 0) {
                            ctx.strokeRect(selectRect_x - 1, selectRect_y - 1, selectRect_width + 1, selectRect_height + 1);
                        }
                        ctx.beginPath();
                        ctx.restore();
                    }
                };
                _SheetRender.prototype._getClipRect = function (rowViewportIndex, colViewportIndex, clipRect) {
                    var sheet = this._sheet;
                    var layout = sheet._getSheetLayout();
                    var paintRect = layout._viewportRect(rowViewportIndex, colViewportIndex);
                    if (colViewportIndex === 1) {
                        var colLayouts = sheet._getColumnLayout(colViewportIndex);
                        var lastColLayout = colLayouts.length > 0 ? colLayouts[colLayouts.length - 1] : keyword_null;
                        if (lastColLayout) {
                            paintRect.width = Math_min(getWidth(paintRect), lastColLayout.x + getWidth(lastColLayout) - layout._viewportX);
                        }
                    }
                    if (rowViewportIndex === 1) {
                        var rowLayouts = sheet._getRowLayout(rowViewportIndex);
                        var lastRowLayout = rowLayouts.length > 0 ? rowLayouts[rowLayouts.length - 1] : keyword_null;
                        if (lastRowLayout) {
                            paintRect.height = Math_min(getHeight(paintRect), lastRowLayout.y + getHeight(lastRowLayout) - layout._viewportY);
                        }
                    }
                    if (clipRect) {
                        clipRect = clipRect.getIntersect(paintRect.x, paintRect.y, getWidth(paintRect), getHeight(paintRect));
                    } else {
                        clipRect = paintRect;
                    }
                    return clipRect;
                };
                _SheetRender.prototype._getPaintingRects = function (rowViewportIndex, colViewportIndex, ranges, clipRect) {
                    var sheet = this._sheet;
                    var modelManager = sheet._modelManager;
                    var span;
                    var count = ranges.length;
                    var cr;
                    var rects = [];
                    var rect;
                    for (var i = 0; i < count; i++) {
                        cr = ranges[i];
                        if (cr) {
                            span = modelManager.findSpan(cr.row, cr.col);
                            if (span && span.containsRange(cr)) {
                                cr = span;
                            }
                            rect = sheet.getRangeRect(rowViewportIndex, colViewportIndex, cr);
                            if (rect && rect.x <= clipRect.x + getWidth(clipRect) && rect.y <= clipRect.y + getHeight(clipRect) &&
                                clipRect.x <= rect.x + getWidth(rect) && clipRect.y <= rect.y + getHeight(rect)) {
                                rects.push(rect);
                            }
                        }
                    }
                    return rects;
                };
                _SheetRender.prototype._paintDashRect = function (ctx, rect, color) {
                    ctx.save();
                    var rectX = rect.x;
                    var rectY = rect.y;
                    var rectWidth = getWidth(rect);
                    var rectHeight = getHeight(rect);
                    var dashLines = [6, 6];
                    if (ctx.setLineDash) {
                        ctx.beginPath();
                        ctx.lineWidth = 2;
                        ctx.strokeStyle = color;
                        ctx.setLineDash(dashLines);
                        ctx.rect(rectX, rectY, rectWidth - 1, rectHeight - 1);
                        ctx.stroke();
                    } else {
                        ctx.beginPath();
                        ctx.lineWidth = 2;
                        ctx.strokeStyle = color;
                        var dash1 = dashLines[0];
                        var dash2 = dashLines[1];
                        var x = void 0;
                        var y = void 0;
                        var remainderWidth = void 0;
                        var remainderHeight = void 0;
                        x = rectX;
                        y = rectY;
                        remainderWidth = rectWidth;
                        while (remainderWidth > 0) {
                            if (remainderWidth >= dash1 + dash2) {
                                ctx.moveTo(x, y);
                                ctx.lineTo(x + dash1, y);
                                x = x + dash1 + dash2;
                                remainderWidth = remainderWidth - dash1 - dash2;
                            } else if (remainderWidth >= dash1) {
                                ctx.moveTo(x, y);
                                ctx.lineTo(x + dash1, y);
                                remainderWidth = remainderWidth - dash1 - dash2;
                                break;
                            } else if (remainderWidth > 0) {
                                ctx.moveTo(x, y);
                                ctx.lineTo(x + remainderWidth, y);
                                remainderWidth = remainderWidth - dash1 - dash2;
                                break;
                            }
                        }
                        x = rectX + rectWidth - 1;
                        y = rectY + 1;
                        remainderHeight = rectHeight - 1;
                        if (remainderWidth < 0) {
                            remainderWidth = Math_abs(remainderWidth);
                            if (remainderWidth > dash2) {
                                ctx.moveTo(x, y - 2);
                                ctx.lineTo(x, y + (remainderWidth - dash2));
                            }
                            y = y + remainderWidth;
                            remainderHeight = remainderHeight - remainderWidth;
                        }
                        while (remainderHeight > 0) {
                            if (remainderHeight >= dash1 + dash2) {
                                ctx.moveTo(x, y);
                                ctx.lineTo(x, y + dash1);
                                y = y + dash1 + dash2;
                                remainderHeight = remainderHeight - dash1 - dash2;
                            } else if (remainderHeight >= dash1) {
                                ctx.moveTo(x, y);
                                ctx.lineTo(x, y + dash1);
                                remainderHeight = remainderHeight - dash1 - dash2;
                            } else if (remainderHeight > 0) {
                                ctx.moveTo(x, y);
                                ctx.lineTo(x, y + remainderHeight);
                                remainderHeight = remainderHeight - dash1 - dash2;
                            }
                        }
                        x = rectX + rectWidth - 2;
                        y = rectY + rectHeight - 1;
                        remainderWidth = rectWidth - 1;
                        if (remainderHeight < 0) {
                            remainderHeight = Math_abs(remainderHeight);
                            if (remainderHeight > dash2) {
                                ctx.moveTo(x + 2, y);
                                ctx.lineTo(x - (remainderHeight - dash2), y);
                            }
                            x = x - remainderHeight;
                            remainderWidth = remainderWidth - remainderHeight;
                        }
                        while (remainderWidth > 0) {
                            if (remainderWidth >= dash1 + dash2) {
                                ctx.moveTo(x, y);
                                ctx.lineTo(x - dash1, y);
                                x = x - dash1 - dash2;
                                remainderWidth = remainderWidth - dash1 - dash2;
                            } else if (remainderWidth >= dash1) {
                                ctx.moveTo(x, y);
                                ctx.lineTo(x - dash1, y);
                                remainderWidth = remainderWidth - dash1 - dash2;
                                break;
                            } else if (remainderWidth > 0) {
                                ctx.moveTo(x, y);
                                ctx.lineTo(x - remainderWidth, y);
                                remainderWidth = remainderWidth - dash1 - dash2;
                                break;
                            }
                        }
                        x = rectX;
                        y = rectY + rectHeight - 2;
                        remainderHeight = rectHeight - 1;
                        if (remainderWidth < 0) {
                            remainderWidth = Math_abs(remainderWidth);
                            if (remainderWidth > dash2) {
                                ctx.moveTo(x, y + 2);
                                ctx.lineTo(x, y - (remainderWidth - dash2));
                            }
                            y = y - remainderWidth;
                            remainderHeight = remainderHeight - remainderWidth;
                        }
                        while (remainderHeight > 0) {
                            if (remainderHeight >= dash1 + dash2) {
                                ctx.moveTo(x, y);
                                ctx.lineTo(x, y - dash1);
                                y = y - dash1 - dash2;
                                remainderHeight = remainderHeight - dash1 - dash2;
                            } else if (remainderHeight >= dash1) {
                                ctx.moveTo(x, y);
                                if (y - dash1 === rectY) {
                                    ctx.lineTo(x, y - dash1 - 1);
                                } else {
                                    ctx.lineTo(x, y - dash1);
                                }
                                remainderHeight = remainderHeight - dash1 - dash2;
                            } else if (remainderHeight > 0) {
                                if (y > rectY) {
                                    ctx.moveTo(x, y);
                                    ctx.lineTo(x, y - remainderHeight);
                                }
                                remainderHeight = remainderHeight - dash1 - dash2;
                            }
                        }
                        ctx.stroke();
                    }
                    ctx.beginPath();
                    ctx.restore();
                };
                _SheetRender.prototype._setLeftAndRightValidationUIModel = function (validationUIModel, colLayouts, cachePool, rowLayout, highlightInvalid, sheet, sheetArea) {
                    if (colLayouts.length !== 0) {
                        var leftFirstColumnOutViewport = colLayouts[0].col - 1;
                        var rightFirstColumnOutViewport = colLayouts[colLayouts.length - 1].col + 1;
                        var leftCellData = cachePool._getDisplayValue(rowLayout.row, leftFirstColumnOutViewport, sheetArea, 1);
                        if (highlightInvalid && leftFirstColumnOutViewport >= 0 && !(sheet.isValid ? sheet.isValid(rowLayout.row, leftFirstColumnOutViewport, leftCellData) : true)) {
                            validationUIModel.push({
                                style: sheet.getDataValidator(rowLayout.row, leftFirstColumnOutViewport).highlightStyle(),
                                x: colLayouts[0].x - sheet.getColumnWidth(leftFirstColumnOutViewport),
                                y: rowLayout.y,
                                width: sheet.getColumnWidth(leftFirstColumnOutViewport),
                                height: rowLayout.height
                            });
                        }
                        var rightCellData = cachePool._getDisplayValue(rowLayout.row, rightFirstColumnOutViewport, sheetArea, 1);
                        if (highlightInvalid && !(sheet.isValid ? sheet.isValid(rowLayout.row, rightFirstColumnOutViewport, rightCellData) : true)) {
                            var endColumnInfo = colLayouts[colLayouts.length - 1];
                            validationUIModel.push({
                                style: sheet.getDataValidator(rowLayout.row, rightFirstColumnOutViewport).highlightStyle(),
                                x: endColumnInfo.x + endColumnInfo.width,
                                y: rowLayout.y,
                                width: sheet.getColumnWidth(rightFirstColumnOutViewport),
                                height: rowLayout.height
                            });
                        }
                    }
                };
                _SheetRender.prototype._getSpanSizeInfo = function (cellLayout, sheet, sheetArea) {
                    var cachePool = sheet._cachePool;
                    var row = cellLayout.row;
                    var col = cellLayout.col;
                    var rowSizes = {};
                    var colSizes = {};
                    var styleList = [];
                    var rowCount = cellLayout.rowCount;
                    var colCount = cellLayout.colCount;
                    for (var j = 0; j < colCount; j++) {
                        colSizes[j] = sheet._getZoomColumnWidth(j + col, sheetArea);
                    }
                    for (var i = 0; i < rowCount; i++) {
                        rowSizes[i] = sheet._getZoomRowHeight(i + row, sheetArea);
                        var temp = [];
                        for (var k = 0; k < colCount; k++) {
                            temp.push(cachePool._getActualStyle(row + i, col + k, sheetArea));
                        }
                        styleList.push(temp);
                    }
                    return {
                        rowSizes: rowSizes,
                        colSizes: colSizes,
                        styleList: styleList
                    };
                };
                _SheetRender.prototype._paintViewportImp = function (ctx, rowViewportIndex, colViewportIndex, sheetArea, clipRect, isPrinting, printZoomFactor) {
                    if (isNullOrUndefined(sheetArea)) {
                        sheetArea = 3;
                    }
                    var self = this;
                    var sheet = self._sheet;
                    var workbook = sheet.parent;
                    var viewportRect = sheet._getSheetLayout()._viewportRect(rowViewportIndex, colViewportIndex);
                    var resizeZeroIndicator = workbook && workbook.options.resizeZeroIndicator;
                    var rowLayouts = sheet._getRowLayout(rowViewportIndex, sheetArea);
                    var colLayouts = sheet._getColumnLayout(colViewportIndex, sheetArea);
                    var sheetAreaOffset = sheet.options.sheetAreaOffset;
                    var outlineLayout = sheet._getOutlineLayout && sheet._getOutlineLayout() || {
                        x: sheetAreaOffset.left,
                        y: sheetAreaOffset.top,
                        width: 0,
                        height: 0
                    };
                    var rowLayoutCount = rowLayouts.length;
                    var colLayoutCount = colLayouts.length;
                    if (rowLayoutCount < 0 || colLayoutCount < 0) {
                        return;
                    }
                    var spanLayouts = sheet._getCellLayout(rowViewportIndex, colViewportIndex, sheetArea, true);
                    var hasSpanLayout = spanLayouts.length > 0;
                    var rowLayout;
                    var colLayout;
                    var cellLayout;
                    var cachePool = sheet._cachePool;
                    var row;
                    var col;
                    var x = 0;
                    var y = 0;
                    var width = 0;
                    var height = 0;
                    var data;
                    var style;
                    var border = new worksheet_border_1._Borders(sheet, rowLayouts, colLayouts, sheetArea);
                    var tmpAddSpans = [];
                    var paintingCells = [];
                    var overflowPaintingCells = [];
                    var validationUIModel = [];
                    var isNeedhighlightInvalid = !isPrinting && sheetArea === 3 && workbook && workbook.options.highlightInvalidData;
                    ctx.save();
                    ctx.beginPath();
                    var doubleGridLinesInfo = [];
                    var lastDoubleGridLineRow = -1;
                    var lastDoubleGridLineCol = -1;
                    var firstVisualRow = sheet._getFirstVisualRow(3);
                    var firstVisualColumn = sheet._getFirstVisualColumn(3);
                    var layout = sheet._getSheetLayout();
                    var isLayoutHeightZero = layout._colHeaderHeight === 0 && outlineLayout.height === 0;
                    var isLayoutWidthZero = layout._rowHeaderWidth === 0 && outlineLayout.width === 0;
                    var supportSparkline = !!getSparklineModule(this._sheet);
                    var SheetsCalc = __webpack_require__(/*! SheetsCalc */ 'SheetsCalc');
                    var activeRow = sheet.getActiveRowIndex();
                    var activeCol = sheet.getActiveColumnIndex();
                    var table = this._getIncludeActiveColRowTable(sheetArea, sheet, activeRow, activeCol);
                    for (var i = 0; i < rowLayoutCount; i++) {
                        rowLayout = rowLayouts[i];
                        self._setLeftAndRightValidationUIModel(validationUIModel, colLayouts, cachePool, rowLayout, isNeedhighlightInvalid, sheet, sheetArea);
                        for (var j = 0; j < colLayoutCount; j++) {
                            colLayout = colLayouts[j];
                            cellLayout = hasSpanLayout && spanLayouts.findCell(rowLayout.row, colLayout.col);
                            if (cellLayout) {
                                row = cellLayout.row;
                                col = cellLayout.col;
                                x = cellLayout.x;
                                y = cellLayout.y;
                                width = getWidth(cellLayout);
                                height = getHeight(cellLayout);
                                if (cellLayout.isAutoMerge) {
                                    var adjustedRect = self._adjustCellLayout(cellLayout, rowViewportIndex, colViewportIndex, sheetArea);
                                    x = adjustedRect.x;
                                    y = adjustedRect.y;
                                    width = adjustedRect.width;
                                    height = adjustedRect.height;
                                }
                                if (!cellLayout.spanSizeInfo) {
                                    cellLayout.spanSizeInfo = self._getSpanSizeInfo(cellLayout, sheet, sheetArea);
                                }
                            } else {
                                row = rowLayout.row;
                                col = colLayout.col;
                                x = colLayout.x;
                                y = rowLayout.y;
                                width = getWidth(colLayout);
                                height = getHeight(rowLayout);
                            }
                            if (resizeZeroIndicator === 1) {
                                if (rowViewportIndex === -1 && sheet.getColumnVisible(col) && sheet._getActualColumnWidth(col) === 0) {
                                    if (lastDoubleGridLineCol < 0 || lastDoubleGridLineCol !== col - 1) {
                                        doubleGridLinesInfo.push({ x1: x, y1: y, x2: x, y2: y + height, horizontal: false });
                                    }
                                    lastDoubleGridLineCol = col;
                                }
                                if (colViewportIndex === -1 && sheet.getRowVisible(row) && sheet._getActualRowHeight(row) === 0) {
                                    if (lastDoubleGridLineRow < 0 || lastDoubleGridLineRow !== row - 1) {
                                        doubleGridLinesInfo.push({ x1: x, y1: y, x2: x + width, y2: y, horizontal: true });
                                    }
                                    lastDoubleGridLineRow = row;
                                }
                            }
                            if (clipRect && (x + width <= clipRect.x || x >= clipRect.x + getWidth(clipRect) ||
                                y + height <= clipRect.y || y >= clipRect.y + getHeight(clipRect))) {
                                continue;
                            }
                            if (width === 0 || height === 0) {
                                continue;
                            }
                            var isTableHeader = false;
                            if (!cellLayout || !ArrayHelper._contains(tmpAddSpans, cellLayout)) {
                                var tableFilter = false;
                                data = cachePool._getDisplayValue(row, col, sheetArea, 1);
                                var filterButtonModel = sheet._getFilterButtonModel && sheet._getFilterButtonModel();
                                if (table && row === 0 && col >= table._col && table._row + table._rowCount > sheet._scrollTopRow && col < table._col + table._colCount) {
                                    data = sheet.getCell(table._row, col).text() + '';
                                    isTableHeader = true;
                                    tableFilter = table.filterButtonVisible();
                                    if (filterButtonModel) {
                                        for (var p = 0; p < filterButtonModel.length; p++) {
                                            if (filterButtonModel[p].col === col && filterButtonModel[p].rowFilter._table === table) {
                                                this._changeFilterButtonModelPosition(filterButtonModel[p], 1, 0, true);
                                                break;
                                            }
                                        }
                                    }
                                } else if (filterButtonModel && filterButtonModel.length > 0) {
                                    var filterButtonTable = filterButtonModel[0].rowFilter && filterButtonModel[0].rowFilter._table;
                                    for (var p = filterButtonModel.length - 1; p >= 0; p--) {
                                        if (filterButtonModel[p].tableColumnHeaderFilter && filterButtonModel[p].col === col) {
                                            this._changeFilterButtonModelPosition(filterButtonModel[p], 3, filterButtonTable._row, false);
                                            break;
                                        }
                                    }
                                }
                                style = cachePool._getActualStyle(row, col, sheetArea);
                                if (isNeedhighlightInvalid && !(sheet.isValid ? sheet.isValid(row, col, data) : true)) {
                                    validationUIModel.push({
                                        style: sheet.getDataValidator(row, col).highlightStyle(),
                                        x: x,
                                        y: y,
                                        width: width,
                                        height: height
                                    });
                                }
                                if (sheetArea === 3) {
                                    var _name = style.formatter;
                                    if (SheetsCalc && !isPrinting && _name && isformatString(_name)) {
                                        var formatStringCustomName = sheet.parent && sheet.parent._getFormatStringCustomName(_name);
                                        if (formatStringCustomName) {
                                            var expression = formatStringCustomName.getExpression();
                                            data = SheetsCalc.evaluateExpression(sheet, expression, row, col);
                                        }
                                    }
                                }
                                border._addCellLines(row, col, x, y, width, height, style, cellLayout, row === firstVisualRow && isLayoutHeightZero, col === firstVisualColumn && isLayoutWidthZero, data);
                                if (isTableHeader) {
                                    style.hAlign = 0;
                                }
                                paintingCells.push({
                                    data: data,
                                    row: row,
                                    col: col,
                                    x: x,
                                    y: y,
                                    width: width,
                                    sparkline: supportSparkline && sheet.getSparkline(row, col),
                                    height: height,
                                    style: style,
                                    cellLayout: cellLayout,
                                    tableFilter: tableFilter
                                });
                                if (cellLayout) {
                                    tmpAddSpans.push(cellLayout);
                                }
                            }
                        }
                    }
                    if (paintingCells.length > 0) {
                        if (sheetArea === 3 && sheet.options.allowCellOverflow) {
                            var layoutBuilder = cachePool._getCellOverflowBuilder(rowViewportIndex, colViewportIndex, function () {
                                return new _CellOverflowLayoutBuilder(sheet, rowViewportIndex, colViewportIndex);
                            });
                            overflowPaintingCells = self._buildCellOverflowValueLayout(ctx, layoutBuilder, paintingCells, border, printZoomFactor);
                            if (overflowPaintingCells.length > 0) {
                                var clipRectBeginX = clipRect.x;
                                var clipRectEndX = clipRect.x + clipRect.width;
                                for (var i = 0; i < overflowPaintingCells.length; i++) {
                                    var overflowPaintingCell = overflowPaintingCells[i];
                                    if (overflowPaintingCell) {
                                        var _row = overflowPaintingCell.row;
                                        var _col = overflowPaintingCell.col;
                                        var overflowLayout = overflowPaintingCell.cellOverflowLayout && overflowPaintingCell.cellOverflowLayout.layout;
                                        if (overflowLayout) {
                                            var cellBeginX = overflowLayout.x;
                                            var cellEndX = cellBeginX + overflowLayout.width;
                                            if (cellBeginX < clipRectBeginX) {
                                                clipRectBeginX = cellBeginX;
                                            }
                                            if (cellEndX > clipRectEndX) {
                                                clipRectEndX = cellEndX;
                                            }
                                        }
                                        border._addCellLines(_row, _col, overflowPaintingCell.x, overflowPaintingCell.y, overflowPaintingCell.width, overflowPaintingCell.height, overflowPaintingCell.style, overflowPaintingCell.cellLayout, _row === firstVisualRow && isLayoutHeightZero, _col === firstVisualColumn && isLayoutWidthZero, overflowPaintingCell.data);
                                    }
                                }
                                paintingCells = paintingCells.concat(overflowPaintingCells);
                                if (!isPrinting) {
                                    clipRect.x = clipRectBeginX;
                                    clipRect.width = clipRectEndX - clipRectBeginX;
                                    if (viewportRect) {
                                        clipRect = clipRect ? viewportRect.getIntersectRect(clipRect) : viewportRect;
                                    }
                                }
                            }
                        }
                        if (clipRect) {
                            var printInfo = sheet.printInfo && sheet.printInfo();
                            if (isPrinting && printInfo && (printInfo.columnStart() > 0 || printInfo.rowStart() > 0) && !printInfo.showBorder()) {
                                ctx.rect(clipRect.x - (printInfo.columnStart() > 0 ? 2 : 0), clipRect.y - (printInfo.rowStart() > 0 ? 2 : 0), getWidth(clipRect) + (printInfo.columnStart() > 0 ? 4 : 0), getHeight(clipRect) + (printInfo.rowStart() > 0 ? 4 : 0));
                            } else {
                                ctx.rect(clipRect.x, clipRect.y, getWidth(clipRect), getHeight(clipRect));
                            }
                            ctx.clip();
                        }
                        self._paintCells(ctx, paintingCells, sheetArea, isPrinting, printZoomFactor);
                    }
                    worksheet_1.Worksheet._callFeatureHandler(sheet, 'paintViewport', {
                        ctx: ctx,
                        rowViewportIndex: rowViewportIndex,
                        colViewportIndex: colViewportIndex,
                        sheetArea: sheetArea,
                        clipRect: clipRect,
                        isPrinting: isPrinting
                    });
                    border.paint(ctx);
                    if (doubleGridLinesInfo.length > 0) {
                        self._paintDoubleGridLines(ctx, doubleGridLinesInfo, 1, 3);
                    }
                    if (validationUIModel.length > 0) {
                        var newClipRect = viewportRect.getIntersectRect(clipRect);
                        ctx.rect(newClipRect.x, newClipRect.y, getWidth(newClipRect), getHeight(newClipRect));
                        ctx.clip();
                        self._paintValidationUI(ctx, validationUIModel);
                    }
                    ctx.restore();
                };
                _SheetRender.prototype._changeFilterButtonModelPosition = function (filterButtonModel, sheetArea, row, tableColumnHeaderFilter) {
                    filterButtonModel.sheetArea = sheetArea;
                    filterButtonModel.row = row;
                    filterButtonModel.tableColumnHeaderFilter = tableColumnHeaderFilter;
                };
                _SheetRender.prototype._getIncludeActiveColRowTable = function (sheetArea, sheet, activeRow, activeCol) {
                    if (sheet.tables && sheetArea === 1 && sheet.frozenRowCount() === 0 && sheet.frozenColumnCount() === 0) {
                        var activetable = sheet.tables.find(activeRow, activeCol);
                        if (activetable && activetable._showHeader && activetable._row < sheet._scrollTopRow) {
                            return activetable;
                        }
                    }
                    return null;
                };
                _SheetRender.prototype._adjustCellLayout = function (cellLayout, rowViewportIndex, colViewportIndex, sheetArea) {
                    var row = cellLayout.row;
                    var col = cellLayout.col;
                    var x = cellLayout.x;
                    var y = cellLayout.y;
                    var width = cellLayout.width;
                    var height = cellLayout.height;
                    var sheet = this._sheet;
                    var layout = sheet._getSheetLayout();
                    if (rowViewportIndex === 1 && (sheetArea === 3 || sheetArea === 2)) {
                        var viewportRect = layout._rowHeaderRect(rowViewportIndex);
                        var minRow = sheet.frozenRowCount();
                        var maxRow = sheet.getRowCount(sheetArea) - sheet.frozenTrailingRowCount() - 1;
                        var viewportY = viewportRect.y;
                        var viewportHeight = viewportRect.height;
                        if (y < viewportY && minRow <= row && row <= maxRow) {
                            height = height - (viewportY - y);
                            y = viewportY;
                        }
                        if (y + height > viewportY + viewportHeight && minRow <= row + cellLayout.rowCount - 1 && row + cellLayout.rowCount - 1 <= maxRow) {
                            height = height - ((y + height) - (viewportY + viewportHeight));
                        }
                    }
                    if (colViewportIndex === 1 && (sheetArea === 3 || sheetArea === 1)) {
                        var viewportRect = layout._colHeaderRect(colViewportIndex);
                        var minCol = sheet.frozenColumnCount();
                        var maxCol = sheet.getColumnCount(sheetArea) - sheet.frozenTrailingColumnCount() - 1;
                        var viewportX = viewportRect.x;
                        var viewportWidth = viewportRect.width;
                        if (x < viewportX && minCol <= col && col <= maxCol) {
                            width = width - (viewportX - x);
                            x = viewportX;
                        }
                        if (x + width > viewportX + viewportWidth && minCol <= col + cellLayout.colCount - 1 && col + cellLayout.colCount - 1 <= maxCol) {
                            width = width - ((x + width) - (viewportX + viewportWidth));
                        }
                    }
                    return new common_1.Rect(x, y, width, height);
                };
                _SheetRender.prototype._paintDoubleGridLines = function (ctx, doubleGridLinesInfo, lineWidth, lineDistance) {
                    if (doubleGridLinesInfo.length === 0) {
                        return;
                    }
                    for (var i = 0, length_3 = doubleGridLinesInfo.length; i < length_3; i++) {
                        var lineInfo = doubleGridLinesInfo[i];
                        var x1 = lineInfo.x1;
                        var y1 = lineInfo.y1;
                        var x2 = lineInfo.x2;
                        var y2 = lineInfo.y2;
                        var horizontal = lineInfo.horizontal;
                        ctx.beginPath();
                        ctx.save();
                        ctx.lineWidth = lineWidth;
                        ctx.strokeStyle = this._getHeaderGridLineColor(ctx, horizontal, x1, y1, x2, y2);
                        ctx.fillStyle = this._getHeaderBackColor(ctx, horizontal, x1, y1, x2, y2);
                        if (horizontal) {
                            var topYOffset = -3;
                            var bottomYOffset = 1;
                            var x1Offset = -1;
                            var x2Offset = -2;
                            ctx.fillRect(x1, y1 + topYOffset, x2 - x1 - 1, lineDistance + 2 * lineWidth);
                            y1 += 0.5;
                            y2 += 0.5;
                            ctx.moveTo(x1 + x1Offset, y1 + topYOffset);
                            ctx.lineTo(x2 + x2Offset, y2 + topYOffset);
                            ctx.moveTo(x1 + x1Offset, y1 + bottomYOffset);
                            ctx.lineTo(x2 + x2Offset, y2 + bottomYOffset);
                        } else {
                            var leftXOffset = -3;
                            var rightXOffset = 1;
                            var y1Offset = 0;
                            var y2Offset = -1;
                            ctx.fillRect(x1 + leftXOffset, y1 + y1Offset, lineDistance + 2 * lineWidth, y2 - y1 - 1);
                            x1 += 0.5;
                            x2 += 0.5;
                            ctx.moveTo(x1 + leftXOffset, y1 + y1Offset);
                            ctx.lineTo(x2 + leftXOffset, y2 + y2Offset);
                            ctx.moveTo(x1 + rightXOffset, y1 + y1Offset);
                            ctx.lineTo(x2 + rightXOffset, y2 + y2Offset);
                        }
                        ctx.stroke();
                        ctx.restore();
                    }
                };
                _SheetRender.prototype._getHeaderBackColor = function (ctx, horizontal, x1, y1, x2, y2) {
                    var headerBackColor;
                    var headerTypeString = horizontal ? STR_ROW_HEADER : STR_COLUMN_HEADER;
                    var themeStyle = common_1._ThemeStyleHelper._getVisualStateThemeStyle(0, 'gc-' + headerTypeString + '-normal');
                    var backColor = themeStyle && themeStyle.backgroundColor;
                    var backgroundImg = themeStyle && themeStyle.backgroundImage;
                    if (!horizontal && backgroundImg && backgroundImg.indexOf('linear-gradient') !== -1) {
                        var colors = common_1._util._getLinearGradientColors(backgroundImg);
                        headerBackColor = ctx.createLinearGradient(x1, y1, x2, y2);
                        for (var i = 0, len = colors.length; i < len; i++) {
                            var color1 = colors[i];
                            headerBackColor.addColorStop(color1.point, color1.color);
                        }
                    } else if (backColor) {
                        headerBackColor = backColor;
                    }
                    return headerBackColor;
                };
                _SheetRender.prototype._getHeaderGridLineColor = function (ctx, horizontal, x1, y1, x2, y2) {
                    var headerGridLineColor = ctx.createLinearGradient(x1, y1, x2, y2);
                    var headerTypeString = horizontal ? STR_ROW_HEADER : STR_COLUMN_HEADER;
                    var themeStyle = common_1._ThemeStyleHelper._getVisualStateThemeStyle(0, 'gc-' + headerTypeString + '-normal');
                    if (horizontal) {
                        headerGridLineColor.addColorStop(0, themeStyle.borderTopColor);
                        headerGridLineColor.addColorStop(1, themeStyle.borderBottomColor);
                    } else {
                        headerGridLineColor.addColorStop(0, themeStyle.borderLeftColor);
                        headerGridLineColor.addColorStop(1, themeStyle.borderRightColor);
                    }
                    return headerGridLineColor;
                };
                _SheetRender.prototype._paintValidationUI = function (ctx, validationUIModel) {
                    var self = this;
                    var sheet = self._sheet;
                    var imageLoader = sheet._getImageLoader();
                    if (validationUIModel) {
                        var length_4 = validationUIModel.length;
                        for (var i = 0; i < length_4; i++) {
                            var validationUI = validationUIModel[i];
                            var x = validationUI.x;
                            var y = validationUI.y;
                            var width = validationUI.width;
                            var height = validationUI.height;
                            var style = validationUI.style;
                            var type = style.type;
                            if (type === 0) {
                                this._paintCircleValidationUI(ctx, x, y, width, height, style);
                            }
                            if (type === 1) {
                                this._paintDogearValidationUI(ctx, x, y, width, height, style);
                            }
                            if (type === 2) {
                                this._paintIconValidationUI(ctx, x, y, width, height, style, imageLoader);
                            }
                        }
                    }
                };
                _SheetRender.prototype._paintCircleValidationUI = function (ctx, xs, ys, ws, hs, style) {
                    var color = style.color;
                    var x = xs - 4;
                    var y = ys - 4;
                    var w = ws + 8;
                    var h = hs + 8;
                    var kappa = 0.5522848;
                    var ox = w / 2 * kappa;
                    var oy = h / 2 * kappa;
                    var xe = x + w;
                    var ye = y + h;
                    var xm = x + w / 2;
                    var ym = y + h / 2;
                    ctx.save();
                    ctx.lineWidth = 2;
                    ctx.strokeStyle = color;
                    ctx.beginPath();
                    ctx.moveTo(x, ym);
                    ctx.bezierCurveTo(x, ym - oy, xm - ox, y, xm, y);
                    ctx.bezierCurveTo(xm + ox, y, xe, ym - oy, xe, ym);
                    ctx.bezierCurveTo(xe, ym + oy, xm + ox, ye, xm, ye);
                    ctx.bezierCurveTo(xm - ox, ye, x, ym + oy, x, ym);
                    ctx.closePath();
                    ctx.stroke();
                    ctx.restore();
                };
                _SheetRender.prototype._paintDogearValidationUI = function (ctx, x, y, w, h, style) {
                    x = x - 0.5;
                    y = y - 0.5;
                    var x1, y1, x2, y2, x3, y3;
                    var sl = Math.min(w / 4, h / 4);
                    var color = style.color;
                    var position = style.position;
                    ctx.save();
                    ctx.beginPath();
                    if (position === 0) {
                        x1 = x;
                        y1 = y;
                        x2 = x;
                        y2 = y1 + sl;
                        x3 = x1 + sl;
                        y3 = y1;
                    } else if (position === 2) {
                        x1 = x + w;
                        y1 = y + h;
                        x2 = x1;
                        y2 = y1 - sl;
                        x3 = x1 - sl;
                        y3 = y1;
                    } else if (position === 3) {
                        x1 = x;
                        y1 = y + h;
                        x2 = x;
                        y2 = y1 - sl;
                        x3 = x1 + sl;
                        y3 = y1;
                    } else if (position === 1) {
                        x1 = x + w;
                        y1 = y;
                        x2 = x1;
                        y2 = y1 + sl;
                        x3 = x1 - sl;
                        y3 = y1;
                    }
                    ctx.moveTo(x1, y1);
                    ctx.lineTo(x2, y2);
                    ctx.lineTo(x3, y3);
                    ctx.fillStyle = color;
                    ctx.fill();
                    ctx.closePath();
                    ctx.restore();
                };
                _SheetRender.prototype._paintIconValidationUI = function (ctx, x, y, w, h, style, imageLoader) {
                    x = x - 0.5;
                    y = y - 0.5;
                    var sheet = this._sheet;
                    var zoomFactor = sheet.zoom();
                    var ix;
                    var iy;
                    var imageWidth = 15;
                    var imageHeight = 15;
                    var iconUrl = style.image;
                    var position = style.position;
                    var outsideLengthTemp = 3;
                    var color = style.color;
                    ctx.save();
                    ctx.beginPath();
                    ctx.lineWidth = 2;
                    ctx.strokeStyle = color;
                    ctx.rect(x, y, w, h);
                    ctx.stroke();
                    if (iconUrl && iconUrl !== 'none' && imageLoader) {
                        if (position === 4) {
                            ix = x - (imageWidth + outsideLengthTemp);
                        } else if (position === 5) {
                            ix = x + w + outsideLengthTemp;
                        }
                        try {
                            if (imageLoader._getState(iconUrl)) {
                                var Img = imageLoader._getImage(iconUrl);
                                iy = y + h / 2 - imageHeight / 2;
                                ctx.drawImage(Img, ix, iy, imageWidth, imageHeight);
                            } else {
                                imageLoader._addImage(iconUrl);
                            }
                        } catch (ex) { }
                    } else {
                        if (position === 4) {
                            ix = x - (imageWidth + outsideLengthTemp) * zoomFactor;
                        } else if (position === 5) {
                            ix = x + w + (outsideLengthTemp * zoomFactor);
                        }
                        iy = y + h / 2 - imageHeight * zoomFactor / 2;
                        ctx.translate(ix, iy);
                        ctx.scale(0.015 * zoomFactor, 0.015 * zoomFactor);
                        ctx.beginPath();
                        ctx.moveTo(512, 0);
                        ctx.bezierCurveTo(229.248, 0, 0, 229.184, 0, 512);
                        ctx.bezierCurveTo(0, 794.816, 229.248, 1024, 512, 1024);
                        ctx.bezierCurveTo(794.752, 1024, 1024, 794.752, 1024, 512);
                        ctx.bezierCurveTo(1024, 229.24800000000005, 794.752, 0, 512, 0);
                        ctx.closePath();
                        ctx.moveTo(783.488, 692.992);
                        ctx.lineTo(692.9920000000001, 783.4879999999999);
                        ctx.lineTo(512, 602.496);
                        ctx.lineTo(331.00800000000004, 783.4879999999999);
                        ctx.lineTo(240.51200000000006, 692.992);
                        ctx.lineTo(421.504, 512);
                        ctx.lineTo(240.512, 330.944);
                        ctx.lineTo(331.008, 240.44800000000004);
                        ctx.lineTo(512, 421.44);
                        ctx.lineTo(692.992, 240.384);
                        ctx.lineTo(783.4879999999999, 330.88);
                        ctx.lineTo(602.496, 512);
                        ctx.lineTo(783.488, 692.992);
                        ctx.closePath();
                        ctx.fillStyle = color;
                        ctx.fill();
                        ctx.stroke();
                    }
                    ctx.restore();
                };
                _SheetRender.prototype._paintCells = function (ctx, cells, sheetArea, isPrinting, printZoomFactor, paintSheet, baseRow, baseCol, fontZoomFactor) {
                    if (baseRow === void 0) {
                        baseRow = 0;
                    }
                    if (baseCol === void 0) {
                        baseCol = 0;
                    }
                    if (fontZoomFactor === void 0) {
                        fontZoomFactor = 1;
                    }
                    var self = this;
                    var sheet = self._sheet;
                    var isViewportArea = sheetArea === 3;
                    var zoomFactor = (paintSheet ? paintSheet.zoom() : sheet.zoom()) * fontZoomFactor;
                    var defaultFontInfo = StyleHelper_scaleFont(self._getDefaultFont(), zoomFactor);
                    var defaultStyle = sheet.getDefaultStyle(sheetArea);
                    var defaultCellType = sheet._getDefaultCellType(sheetArea);
                    var conditionalFormats = self._sheet.conditionalFormats;
                    var sheetBackColor = getSheetBackColor(sheet);
                    var rowHeaderLeftCol = sheet._getFirstVisualColumn(2);
                    var colHeaderTopRow = sheet._getFirstVisualRow(1);
                    var imageLoader = paintSheet ? paintSheet._getImageLoader() : sheet._getImageLoader();
                    ctx.save();
                    ctx.beginPath();
                    ctx.fillStyle = defaultStyle && defaultStyle.foreColor || STR_BLACK;
                    setContextFont(ctx, defaultFontInfo.font);
                    ctx.textAlign = isViewportArea ? 'left' : 'center';
                    var i;
                    var k;
                    var count = cells.length;
                    var cell;
                    var cellType;
                    var data;
                    var row;
                    var col;
                    var x;
                    var y;
                    var width;
                    var height;
                    var style;
                    var tableFilter;
                    var cellOverflowLayout;
                    var richText;
                    var visualState;
                    var fontInfo;
                    var lineHeight;
                    var overflowCells = [];
                    var overflowCell;
                    var options = {
                        sheet: sheet,
                        row: -1,
                        col: -1,
                        fontInfo: keyword_null,
                        lineHeight: -1,
                        imageLoader: imageLoader,
                        conditionalFormats: conditionalFormats,
                        sheetArea: sheetArea,
                        parentBackColor: sheetBackColor
                    };
                    for (i = 0; i < count; i++) {
                        cell = cells[i];
                        data = cell.data;
                        tableFilter = cell.tableFilter;
                        row = cell.row;
                        col = cell.col;
                        x = cell.x;
                        y = cell.y;
                        width = getWidth(cell);
                        height = getHeight(cell);
                        style = cell.style;
                        cellOverflowLayout = cell.cellOverflowLayout;
                        if (style.font) {
                            fontInfo = StyleHelper_scaleFont(style.font, zoomFactor);
                        } else {
                            fontInfo = defaultFontInfo;
                        }
                        if (isPrinting && typeof printZoomFactor === const_number && printZoomFactor !== 1) {
                            fontInfo = StyleHelper_scaleFont(fontInfo.font, printZoomFactor);
                        }
                        style.font = fontInfo.font;
                        if (width > 0 && height > 0) {
                            cellType = style.cellType || defaultCellType;
                            x--;
                            y--;
                            width++;
                            height++;
                            if (isViewportArea) {
                                options.sparkline = cell.sparkline;
                            } else {
                                if (isPrinting) {
                                    visualState = 0;
                                } else {
                                    visualState = self._getVisualState(row, col, sheetArea);
                                }
                                options.visualState = visualState;
                            }
                            lineHeight = getFontHeight(fontInfo.font);
                            options.lineHeight = lineHeight;
                            options.row = row + baseRow;
                            options.col = col + baseCol;
                            options.fontInfo = fontInfo;
                            options.cellOverflowLayout = cellOverflowLayout;
                            options.needTopGridline = (sheetArea === 1 && row === colHeaderTopRow || sheetArea === 0);
                            options.needLeftGridline = (sheetArea === 2 && col === rowHeaderLeftCol || sheetArea === 0);
                            options.isPrinting = isPrinting;
                            options.printZoomFactor = printZoomFactor;
                            cellType._paint(ctx, data, x, y, width, height, style, options, tableFilter);
                            if (cellOverflowLayout && !options.showBarIconOnly) {
                                var cellRect = new common_1.Rect(x, y, width, height);
                                var contentRect = cellType._getContentRectImp ? cellType._getContentRectImp(ctx, cellRect, style, options) : cellRect;
                                overflowCells.push({
                                    cellType: cellType,
                                    data: data,
                                    x: contentRect.x,
                                    y: contentRect.y,
                                    width: contentRect.width,
                                    height: contentRect.height,
                                    style: style,
                                    richText: richText,
                                    options: {
                                        sheet: sheet,
                                        row: row,
                                        col: col,
                                        fontInfo: fontInfo,
                                        lineHeight: lineHeight,
                                        cellOverflowLayout: cellOverflowLayout,
                                        parentBackColor: sheetBackColor,
                                        imageLoader: imageLoader
                                    }
                                });
                            }
                        }
                    }
                    count = overflowCells.length;
                    if (count > 0) {
                        var isEditing = sheet.isEditing();
                        var activeRow = sheet._activeRowIndex;
                        var activeCol = sheet._activeColIndex;
                        for (k = 0; k < count; k++) {
                            overflowCell = overflowCells[k];
                            data = overflowCell.data;
                            options = overflowCell.options;
                            if (isEditing && options.row === activeRow && options.col === activeCol) {
                                continue;
                            }
                            var sparkLine = getSparklineModule(this._sheet);
                            if (sparkLine && (data && data.typeName === 'SparklineExValue')) {
                                continue;
                            }
                            self._paintPaddingValueForOverflow(ctx, overflowCell);
                        }
                    }
                    ctx.restore();
                    count = cells.length;
                    for (i = 0; i < count; i++) {
                        cell = cells[i];
                        worksheet_1.Worksheet._callFeatureHandler(sheet, 'paintCell', {
                            ctx: ctx,
                            sheetArea: sheetArea,
                            cell: cell,
                            isPrinting: isPrinting
                        });
                    }
                };
                _SheetRender.prototype._paintPaddingValueForOverflow = function (ctx, overflowCell) {
                    var cellType = overflowCell.cellType;
                    var data = overflowCell.data;
                    var x = overflowCell.x;
                    var y = overflowCell.y;
                    var width = getWidth(overflowCell);
                    var height = getHeight(overflowCell);
                    var style = overflowCell.style;
                    var options = overflowCell.options;
                    var cellOverflowlayout = options.cellOverflowLayout;
                    if (cellOverflowlayout && cellType._callPaintCellPaddingFeatureHandler) {
                        var layout = cellOverflowlayout.layout;
                        var rect = new common_1.Rect(layout ? layout.x : x, layout ? layout.y : y, layout ? layout.width : width, layout ? layout.height : height);
                        cellType._callPaintCellPaddingFeatureHandler(ctx, rect, options, data);
                    }
                    if (cellType.paintValue) {
                        cellType.paintValue(ctx, data, x, y, width, height, style, options);
                    }
                };
                _SheetRender.prototype._getVisualState = function (row, col, sheetArea) {
                    var sheet = this._sheet;
                    var visualState = 0;
                    if (needPaintSelection(sheet)) {
                        if (sheetArea === 3 || isNullOrUndefined(sheetArea)) {
                            if (!sheet.isEditing() && sheet._isActiveCell(row, col)) {
                                visualState = 3;
                            } else if (sheet._isSelected(row, col, sheetArea)) {
                                visualState = 2;
                            }
                        } else {
                            if (sheet._isSelected(row, col, sheetArea)) {
                                visualState = 1;
                                if (sheet._isAllSelected(row, col, sheetArea)) {
                                    visualState = 2;
                                }
                            }
                            if (sheet._isHover(row, col, sheetArea)) {
                                visualState = 4;
                            }
                        }
                    }
                    return visualState;
                };
                _SheetRender.prototype._buildCellOverflowValueLayout = function (ctx, layoutBuilder, paintingCells, border, printZoomFactor) {
                    var sheet = this._sheet;
                    var cachePool = sheet._cachePool;
                    var count = paintingCells.length;
                    var cell;
                    var data;
                    var style;
                    var row;
                    var overflowPaintcells = [];
                    var col;
                    var y;
                    var width;
                    var height;
                    var backgroundWidth;
                    var textX;
                    var newX;
                    var newCell;
                    var overflowLayoutModel;
                    var headingOverflowLayouts;
                    var trailingOverflowLayouts;
                    var overflowLayouts;
                    var processed = {};
                    var removeIndexes = [];
                    var _loop_1 = function (i) {
                        cell = paintingCells[i];
                        row = cell.row;
                        col = cell.col;
                        y = cell.y;
                        height = getHeight(cell);
                        overflowLayoutModel = layoutBuilder._getCellOverflowLayoutModel(row, ctx, printZoomFactor);
                        headingOverflowLayouts = overflowLayoutModel.headingOverflowlayouts;
                        trailingOverflowLayouts = overflowLayoutModel.trailingOverflowLayouts;
                        if (!processed[row]) {
                            var rowProcessed_1 = {};
                            for (var _i = 0, overflowLayoutModel_1 = overflowLayoutModel; _i < overflowLayoutModel_1.length; _i++) {
                                var modelItem = overflowLayoutModel_1[_i];
                                rowProcessed_1[modelItem.column] = false;
                            }
                            if (headingOverflowLayouts) {
                                headingOverflowLayouts.forEach(function (item) {
                                    rowProcessed_1[item.column] = false;
                                });
                            }
                            if (trailingOverflowLayouts) {
                                trailingOverflowLayouts.forEach(function (item) {
                                    rowProcessed_1[item.column] = false;
                                });
                            }
                            processed[row] = rowProcessed_1;
                        }
                        var overflowRowProcessed = processed[row];
                        overflowLayouts = overflowLayoutModel.find(col);
                        for (var s = 0; s < overflowLayouts.length; s++) {
                            var overflowLayout = overflowLayouts[s];
                            if (overflowLayout) {
                                var columnCellRect = sheet.getCellRect(row, overflowLayout.column, keyword_null, keyword_null, true);
                                if (!overflowRowProcessed[overflowLayout.column]) {
                                    var column = overflowLayout.column;
                                    style = cachePool._getActualStyle(row, column);
                                    if (style.showEllipsis) {
                                        continue;
                                    }
                                    data = cachePool._getDisplayValue(row, column, 3, 1, style);
                                    width = overflowLayout.columnWidth;
                                    backgroundWidth = overflowLayout.backgroundWidth;
                                    if (overflowLayout.backgroundLeftWidth < 0) {
                                        textX = columnCellRect.x;
                                    } else if (overflowLayout.backgroundRightWidth < 0) {
                                        textX = columnCellRect.x + getWidth(columnCellRect) - backgroundWidth;
                                    } else {
                                        textX = columnCellRect.x + getWidth(columnCellRect) / 2 - overflowLayout.backgroundLeftWidth;
                                    }
                                    newCell = {
                                        data: data,
                                        row: row,
                                        col: column,
                                        x: columnCellRect.x,
                                        y: y,
                                        width: width,
                                        height: height,
                                        cellOverflowLayout: overflowLayout,
                                        style: style
                                    };
                                    overflowPaintcells.push(newCell);
                                    overflowLayout.layout = new common_1.Rect(textX, y, backgroundWidth, height);
                                    style = cachePool._getActualStyle(row, column);
                                    border._addCellOverlfowLayout(row, column, overflowLayout, style, columnCellRect.x, y, width, height);
                                    overflowRowProcessed[overflowLayout.column] = true;
                                }
                                if (overflowLayout.column === col && overflowRowProcessed[overflowLayout.column]) {
                                    removeIndexes.push(i);
                                }
                            }
                        }
                        if (headingOverflowLayouts) {
                            for (var k = 0; k < headingOverflowLayouts.length; k++) {
                                var headingOverflowLayout = headingOverflowLayouts[k];
                                if (headingOverflowLayout && !overflowRowProcessed[headingOverflowLayout.column] && headingOverflowLayout.contains(cell.col)) {
                                    col = headingOverflowLayout.column;
                                    style = cachePool._getActualStyle(row, col);
                                    if (style.showEllipsis) {
                                        continue;
                                    }
                                    data = cachePool._getDisplayValue(row, col, 3, 1, style);
                                    width = headingOverflowLayout.columnWidth;
                                    backgroundWidth = headingOverflowLayout.backgroundWidth;
                                    var endColumnCellRect = sheet.getCellRect(row, headingOverflowLayout.endColumn, keyword_null, keyword_null, true);
                                    textX = endColumnCellRect.x + getWidth(endColumnCellRect) - backgroundWidth;
                                    newCell = {
                                        data: data,
                                        row: row,
                                        col: col,
                                        x: textX,
                                        y: y,
                                        width: width,
                                        height: height,
                                        style: style,
                                        cellOverflowLayout: headingOverflowLayout
                                    };
                                    overflowPaintcells.push(newCell);
                                    headingOverflowLayout.layout = new common_1.Rect(textX, y, backgroundWidth, height);
                                    overflowRowProcessed[headingOverflowLayout.column] = true;
                                    border._addCellOverlfowLayout(row, col, headingOverflowLayout, style, textX, y, width, height);
                                }
                            }
                        }
                        if (trailingOverflowLayouts) {
                            for (var j = 0; j < trailingOverflowLayouts.length; j++) {
                                var trailingOverflowLayout = trailingOverflowLayouts[j];
                                if (trailingOverflowLayout && !overflowRowProcessed[trailingOverflowLayout.column] && trailingOverflowLayout.contains(cell.col)) {
                                    col = trailingOverflowLayout.column;
                                    style = cachePool._getActualStyle(row, col);
                                    if (style.showEllipsis) {
                                        continue;
                                    }
                                    data = cachePool._getDisplayValue(row, col, 3, 1, style);
                                    width = trailingOverflowLayout.columnWidth;
                                    backgroundWidth = trailingOverflowLayout.backgroundWidth;
                                    var startColumnCellRect = sheet.getCellRect(row, trailingOverflowLayout.startColumn, keyword_null, keyword_null, true);
                                    textX = startColumnCellRect.x;
                                    newX = startColumnCellRect.x + backgroundWidth - width;
                                    newCell = {
                                        data: data,
                                        row: row,
                                        col: col,
                                        x: newX,
                                        y: y,
                                        width: width,
                                        height: height,
                                        style: style,
                                        cellOverflowLayout: trailingOverflowLayout
                                    };
                                    overflowPaintcells.push(newCell);
                                    trailingOverflowLayout.layout = new common_1.Rect(textX, y, backgroundWidth, height);
                                    border._addCellOverlfowLayout(row, col, trailingOverflowLayout, style, textX, y, width, height);
                                    overflowRowProcessed[trailingOverflowLayout.column] = true;
                                }
                            }
                        }
                    };
                    for (var i = 0; i < count; i++) {
                        _loop_1(i);
                    }
                    if (removeIndexes.length > 0) {
                        for (var j = removeIndexes.length - 1; j >= 0; j--) {
                            paintingCells.splice(removeIndexes[j], 1);
                        }
                    }
                    function compare(obj1, obj2) {
                        var row1 = obj1.row;
                        var row2 = obj2.row;
                        var col1 = obj1.col;
                        var col2 = obj2.col;
                        if (row1 !== row2) {
                            return row1 - row2;
                        } else if (col1 !== col2) {
                            return col1 - col2;
                        }
                    }
                    if (overflowPaintcells.length > 0) {
                        overflowPaintcells.sort(compare);
                    }
                    return overflowPaintcells;
                };
                return _SheetRender;
            }());
            exports._SheetRender = _SheetRender;

            var CUTCOPYINDICATOR_EVENT_NS = '.cutCopyIndicator';
            var Events_CellChanged = common_1.Events.CellChanged, Events_ClipboardChanged = common_1.Events.ClipboardChanged, Events_ValueChanged = common_1.Events.ValueChanged, Events_ColumnChanged = common_1.Events.ColumnChanged, Events_RowChanged = common_1.Events.RowChanged, Events_RangeChanged = common_1.Events.RangeChanged, Events_ClipboardPasting = common_1.Events.ClipboardPasting, Events_ClipboardPasted = common_1.Events.ClipboardPasted, Events_DragMerging = common_1.Events.DragMerging, Events_FloatingElementSelected = common_1.Events.FloatingElementSelected;
            var _CutCopyIndicatorManager = (function () {
                function _CutCopyIndicatorManager(sheet) {
                    var self = this;
                    self._needPaint = false;
                    self._pasteInternal = false;
                    self._sheet = sheet;
                    self._bindEvents();
                }
                _CutCopyIndicatorManager.prototype._isPastedInternal = function (value) {
                    var self = this;
                    if (arguments.length === 0) {
                        return self._pasteInternal;
                    }
                    self._pasteInternal = value;
                };
                _CutCopyIndicatorManager.prototype._needPaintIndicator = function (value, pasteFromSystem) {
                    var self = this;
                    if (arguments.length === 0) {
                        return self._needPaint;
                    }
                    if (self._needPaint !== value || value || pasteFromSystem) {
                        self._needPaint = value;
                        var sheet_1 = self._sheet;
                        if (sheet_1) {
                            sheet_1._invalidate();
                        }
                    }
                };
                _CutCopyIndicatorManager.prototype._bindEvents = function () {
                    var self = this;
                    var sheet = self._sheet;
                    var cacheNeedPaintIndicator = false;
                    var CONST_RESIZABLE = 'resizable';
                    var CONST_ISVISIBLE = 'isVisible';
                    function setNeedPaintFalseHandler() {
                        self._needPaint && self._needPaintIndicator(false);
                    }
                    function onRowColumnChanged(propertyName, name) {
                        if (propertyName !== CONST_RESIZABLE && propertyName !== name && propertyName !== CONST_ISVISIBLE) {
                            setNeedPaintFalseHandler();
                        }
                    }
                    sheet._bind(Events_ClipboardChanged + CUTCOPYINDICATOR_EVENT_NS, function () {
                        self._needPaintIndicator(true);
                    });
                    sheet._bind(Events_ValueChanged + CUTCOPYINDICATOR_EVENT_NS, setNeedPaintFalseHandler);
                    sheet._bind(Events_CellChanged + CUTCOPYINDICATOR_EVENT_NS, setNeedPaintFalseHandler);
                    sheet._bind(Events_ColumnChanged + CUTCOPYINDICATOR_EVENT_NS, function (event, data) {
                        onRowColumnChanged(data.propertyName, 'width');
                    });
                    sheet._bind(Events_RowChanged + CUTCOPYINDICATOR_EVENT_NS, function (event, data) {
                        onRowColumnChanged(data.propertyName, 'height');
                    });
                    sheet._bind(Events_RangeChanged + CUTCOPYINDICATOR_EVENT_NS, function (event, data) {
                        if (!(data.action === 6 && sheet._calcService && sheet._calcService.calcOnDemand)) {
                            setNeedPaintFalseHandler();
                        }
                    });
                    sheet._bind(Events_ClipboardPasting + CUTCOPYINDICATOR_EVENT_NS, function () {
                        cacheNeedPaintIndicator = self._needPaintIndicator();
                    });
                    sheet._bind(Events_ClipboardPasted + CUTCOPYINDICATOR_EVENT_NS, function (event, args) {
                        var cellRange = args.cellRange;
                        var ch = args.sheet._getClipboardHelper();
                        var ranges = ch._ranges;
                        var needPaint = cacheNeedPaintIndicator;
                        var pasteFromSystem;
                        if (cellRange && ranges && ch._fromSheet) {
                            if (!self._isPastedInternal()) {
                                needPaint = false;
                                pasteFromSystem = true;
                            } else {
                                needPaint = false;
                            }
                            self._needPaintIndicator(needPaint, pasteFromSystem);
                        }
                    });
                    sheet._bind(Events_DragMerging + CUTCOPYINDICATOR_EVENT_NS, setNeedPaintFalseHandler);
                    sheet._bind(Events_FloatingElementSelected + CUTCOPYINDICATOR_EVENT_NS, function (event, data) {
                        if (data.type !== 'worksheet') {
                            sheet.endEdit();
                            common_1._FocusHelper._hideSelectionImp(sheet);
                        }
                    });
                };
                _CutCopyIndicatorManager.prototype._paintCutCopyIndicator = function (ctx, clipRect, rowViewportIndex, colViewportIndex) {
                    var self = this;
                    if (self._needPaint) {
                        var sheet = self._sheet;
                        var render = sheet._render;
                        var workbook = sheet.parent;
                        var options = workbook ? workbook.options : {};
                        var ch = sheet._getClipboardHelper(), ranges = ch._ranges;
                        var visible = options.cutCopyIndicatorVisible;
                        if (isNullOrUndefined(visible)) {
                            visible = true;
                        }
                        var color = common_1._ThemeContext._getColor(sheet, options.cutCopyIndicatorBorderColor || 'blue');
                        if (visible && ch._fromSheet === sheet && ranges) {
                            var viewportRect = render._getClipRect(rowViewportIndex, colViewportIndex, keyword_null);
                            var indicatorRects = render._getPaintingRects(rowViewportIndex, colViewportIndex, ranges, clipRect);
                            if (indicatorRects && viewportRect) {
                                ctx.save();
                                ctx.rect(viewportRect.x, viewportRect.y, getWidth(viewportRect), getHeight(viewportRect));
                                ctx.clip();
                                for (var _i = 0, indicatorRects_1 = indicatorRects; _i < indicatorRects_1.length; _i++) {
                                    var indicatorRect = indicatorRects_1[_i];
                                    render._paintDashRect(ctx, indicatorRect, color);
                                }
                                ctx.beginPath();
                                ctx.restore();
                            }
                        }
                    }
                };
                _CutCopyIndicatorManager.prototype._onRowsAdded = function () {
                    this._needPaintIndicator(false);
                };
                _CutCopyIndicatorManager.prototype._onRowsDeleted = function () {
                    this._needPaintIndicator(false);
                };
                _CutCopyIndicatorManager.prototype._onColumnsAdded = function () {
                    this._needPaintIndicator(false);
                };
                _CutCopyIndicatorManager.prototype._onColumnsDeleted = function () {
                    this._needPaintIndicator(false);
                };
                _CutCopyIndicatorManager.prototype._cancelIndicator = function () {
                    this._needPaintIndicator(false);
                };
                _CutCopyIndicatorManager.prototype._dispose = function () {
                    var sheet = this._sheet;
                    sheet._unbind(Events_CellChanged + CUTCOPYINDICATOR_EVENT_NS);
                    sheet._unbind(Events_ClipboardChanged + CUTCOPYINDICATOR_EVENT_NS);
                    sheet._unbind(Events_ValueChanged + CUTCOPYINDICATOR_EVENT_NS);
                    sheet._unbind(Events_ColumnChanged + CUTCOPYINDICATOR_EVENT_NS);
                    sheet._unbind(Events_RowChanged + CUTCOPYINDICATOR_EVENT_NS);
                    sheet._unbind(Events_RangeChanged + CUTCOPYINDICATOR_EVENT_NS);
                    sheet._unbind(Events_ClipboardPasting + CUTCOPYINDICATOR_EVENT_NS);
                    sheet._unbind(Events_ClipboardPasted + CUTCOPYINDICATOR_EVENT_NS);
                    sheet._unbind(Events_DragMerging + CUTCOPYINDICATOR_EVENT_NS);
                    sheet._unbind(Events_FloatingElementSelected + CUTCOPYINDICATOR_EVENT_NS);
                };
                return _CutCopyIndicatorManager;
            }());
            exports._CutCopyIndicatorManager = _CutCopyIndicatorManager;

            worksheet_1.Worksheet._registerFeature('render', {
                init: function () {
                    var self = this;
                    self._render = new _SheetRender(self);
                    self._cutCopyIndicatorManager = new _CutCopyIndicatorManager(self);
                },
                dispose: function (argus) {
                    var self = this;
                    if (argus.clearCache !== false) {
                        if (self._render) {
                            self._render._sheet = keyword_null;
                            self._render = keyword_null;
                        }
                        var cutCopyIndicatorManager = self._cutCopyIndicatorManager;
                        if (cutCopyIndicatorManager) {
                            cutCopyIndicatorManager._dispose();
                            self._cutCopyIndicatorManager = keyword_null;
                        }
                    }
                },
                onLayoutChanged: function (args) {
                    var self = this;
                    var cutCopyIndicator = self._cutCopyIndicatorManager;
                    if (!cutCopyIndicator) {
                        return;
                    }
                    var changeType = args.changeType;
                    if (changeType === 'addRows') {
                        cutCopyIndicator._onRowsAdded();
                    } else if (changeType === 'deleteRows') {
                        cutCopyIndicator._onRowsDeleted();
                    } else if (changeType === 'addColumns') {
                        cutCopyIndicator._onColumnsAdded();
                    } else if (changeType === 'deleteColumns') {
                        cutCopyIndicator._onColumnsDeleted();
                    }
                }
            });
        }),
        './dist/core/worksheet/worksheet-selection.js': (function (module, exports, __webpack_require__) {
            Object.defineProperty(exports, '__esModule', { value: true });
            var worksheet_1 = __webpack_require__(/*! ./worksheet */ './dist/core/worksheet/worksheet.js');
            var common_1 = __webpack_require__(/*! ../util/common */ './dist/core/util/common.js');
            var Common_1 = __webpack_require__(/*! Common */ 'Common');
            var domUtil_1 = __webpack_require__(/*! ../util/domUtil */ './dist/core/util/domUtil.js');
            var core_enum_1 = __webpack_require__(/*! ../core.enum */ './dist/core/core.enum.js');
            var isNullOrUndefined = Common_1.Common._Types._isNullOrUndefined, _ArrayHelper_getLength = Common_1.Common._ArrayHelper._getLength;
            var keyword_null = null;
            var Math_max = Math.max;
            var Math_min = Math.min;
            var GC_SELECTION = 'gc-selection';
            function getSheetColumnCount(sheet, sheetArea) {
                return sheet.getColumnCount(sheetArea);
            }
            function getSheetRowCount(sheet, sheetArea) {
                return sheet.getRowCount(sheetArea);
            }
            function getRowCount(obj) {
                return obj.rowCount;
            }
            function getColCount(obj) {
                return obj.colCount;
            }
            function replaceItem(arr, index, newArr) {
                var result = [], len = arr.length, item;
                for (var i = 0; i < len; i++) {
                    item = arr[i];
                    if (i === index) {
                        result = result.concat(newArr);
                    } else {
                        result.push(item);
                    }
                }
                return result;
            }
            function getLastVisibleCol(sheet, col, colCount) {
                for (var i = colCount - 1; i >= 0; i--) {
                    if (sheet.getColumnVisible(col + i)) {
                        return col + i;
                    }
                }
                return col + colCount - 1;
            }
            function getLastVisibleRow(sheet, row, rowCount) {
                for (var i = rowCount - 1; i >= 0; i--) {
                    if (sheet.getRowVisible(row + i)) {
                        return row + i;
                    }
                }
                return row + rowCount - 1;
            }
            domUtil_1.GC$.extend(worksheet_1.Worksheet.prototype, {
                addSelection: function (row, column, rowCount, columnCount) {
                    var self = this;
                    var r = row;
                    var c = column;
                    var rc = rowCount;
                    var cc = columnCount;
                    if (r !== -1 && c !== -1) {
                        var spans = self._modelManager.getSpans();
                        if (spans && _ArrayHelper_getLength(spans) > 0) {
                            var newSelection = self._cellRangeInflate(spans, common_1._createRange(row, column, rowCount, columnCount));
                            r = newSelection.row;
                            c = newSelection.col;
                            rc = getRowCount(newSelection);
                            cc = getColCount(newSelection);
                        }
                    }
                    self._modelManager.do('addSelection', r, c, rc, cc);
                    self._invalidate();
                },
                setSelection: function (row, column, rowCount, columnCount) {
                    this._setSelectionImp(row, column, rowCount, columnCount, 2);
                },
                _setSelectionImp: function (row, column, rowCount, columnCount, focusPolicy) {
                    var self = this;
                    var sheetRowCount = getSheetRowCount(self);
                    var sheetColCount = getSheetColumnCount(self);
                    if (row >= sheetRowCount) {
                        row = sheetRowCount - 1;
                    }
                    if (column >= sheetColCount) {
                        column = sheetColCount - 1;
                    }
                    var activeRow = Math_max(0, row);
                    var activeCol = Math_max(0, column);
                    self._clearSelectionImp();
                    var setFocus = (focusPolicy === 2) ? common_1._FocusHelper._isActiveElement(self) : focusPolicy === 1;
                    self._setActiveCellImp(activeRow, activeCol, self._getRowViewportIndex(activeRow), self._getColumnViewportIndex(activeCol), !setFocus);
                    self.addSelection(row, column, rowCount, columnCount);
                },
                getSelections: function () {
                    return this._modelManager.getSelections();
                },
                clearSelection: function () {
                    var self = this;
                    self._clearSelectionImp();
                    self._setActiveCellImp(0, 0);
                    worksheet_1.Worksheet._callFeatureHandler(self, 'clearSelection');
                    self._invalidate();
                },
                _clearSelectionImp: function () {
                    this._modelManager.do('clearSelection');
                },
                _canSelect: function (row, column, style) {
                    var self = this;
                    var options = self.options;
                    var protectionOptions = options.protectionOptions;
                    var allowLocked = protectionOptions.allowSelectLockedCells !== false;
                    var allowUnlocked = protectionOptions.allowSelectUnlockedCells !== false;
                    if (
                        !options.isProtected
                        || allowLocked
                        && allowUnlocked
                    ) {
                        return true;
                    }
                    if (!allowLocked && !allowUnlocked) {
                        return false;
                    }
                    var locked = style ? style.locked : self._getStyleProperty(row, column, 'locked');
                    var isFullRow = column < 0;
                    var isFullCol = row < 0;
                    if (allowLocked === locked && (isFullCol || isFullRow)) {
                        var rowCount = isFullCol ? getSheetRowCount(self) : 1;
                        row = isFullCol ? 0 : row;
                        var colCount = isFullRow ? getSheetColumnCount(self) : 1;
                        column = isFullRow ? 0 : column;
                        var modelManager = self._modelManager;
                        var lastRow = row + rowCount - 1;
                        var lastCol = column + colCount - 1;
                        var r = void 0;
                        var c = void 0;
                        for (r = row; r <= lastRow; r++) {
                            for (c = column; c <= lastCol; c++) {
                                style = modelManager.getStyle(r, c);
                                if (style && allowLocked !== style.locked) {
                                    return false;
                                }
                            }
                        }
                        if (isFullCol) {
                            for (r = row; r <= lastRow; r++) {
                                style = modelManager.getStyle(r, -1);
                                if (style && allowLocked !== style.locked) {
                                    return false;
                                }
                            }
                        }
                        if (isFullRow) {
                            for (c = column; c <= lastCol; c++) {
                                style = modelManager.getStyle(-1, c);
                                if (style && allowLocked !== style.locked) {
                                    return false;
                                }
                            }
                        }
                    }
                    return allowLocked === locked;
                },
                _containsLockedCellsInSelection: function (row, column, rowCount, columnCount) {
                    var self = this;
                    row = row < 0 ? 0 : row;
                    column = column < 0 ? 0 : column;
                    for (var i = row; i < row + rowCount; i++) {
                        for (var j = column; j < column + columnCount; j++) {
                            if (self._getStyleProperty(i, j, 'locked')) {
                                return true;
                            }
                        }
                    }
                },
                _isFullRows: function () {
                    var selections = this.getSelections();
                    for (var i = 0; i < selections.length; i++) {
                        if (selections[i].col !== -1) {
                            return false;
                        }
                    }
                    return true;
                },
                _isFullCols: function () {
                    var selections = this.getSelections();
                    for (var i = 0; i < selections.length; i++) {
                        if (selections[i].row !== -1) {
                            return false;
                        }
                    }
                    return true;
                },
                selectionPolicy: function (value) {
                    var self = this, modelManager = self._modelManager;
                    if (arguments.length === 0) {
                        return modelManager.getSelectionPolicy();
                    }
                    modelManager.do('setSelectionPolicy', value);
                    return self;
                },
                selectionUnit: function (value) {
                    var self = this, modelManager = self._modelManager;
                    if (arguments.length === 0) {
                        return modelManager.getSelectionUnit();
                    }
                    modelManager.do('setSelectionUnit', value);
                    return self;
                },
                getSelectionBackColor: function () {
                    return this.options.selectionBackColor || common_1._ThemeStyleHelper._getCssClassThemeStyle(GC_SELECTION).backgroundColor;
                },
                getSelectionBorderColor: function () {
                    return this.options.selectionBorderColor || common_1._ThemeStyleHelper._getCssClassThemeStyle(GC_SELECTION).borderTopColor;
                },
                _selectionIndicatorColor: function (color) {
                    if (color) {
                        this.options._selectionIndicatorColor = color;
                    } else {
                        return this.options._selectionIndicatorColor;
                    }
                },
                _saveAndClearSheetSelections: function () {
                    var self = this;
                    var selections = self._modelManager.getSelections();
                    if (_ArrayHelper_getLength(selections) > 0) {
                        var selectionModelCache = {
                            selections: selections
                        };
                        var activeSelectedRangeIndex = self._modelManager.getActiveSelectedRangeIndex();
                        if (activeSelectedRangeIndex !== 0) {
                            selectionModelCache.activeSelectedRangeIndex = activeSelectedRangeIndex;
                        }
                        self._selectionModelCache = selectionModelCache;
                        self._clearSelectionImp();
                        self._render._repaintSelection();
                    }
                },
                _loadAndSetSheetSelections: function () {
                    var self = this, selectionModelCache = self._selectionModelCache, selections = selectionModelCache && selectionModelCache.selections;
                    if (selections) {
                        self._modelManager.do('setSelections', selections);
                        self._modelManager.do('setActiveSelectedRangeIndex', selectionModelCache.activeSelectedRangeIndex || 0);
                    }
                },
                _moveActiveCellUp: function (row, col, wrap) {
                    var self = this;
                    var upCell = self._getMoveUpCell(row, col, wrap, self._leadingCellCol || 0);
                    if (upCell) {
                        var r = upCell.row, c = upCell.col, leadingCellCol = upCell.leadingCellCol;
                        if (self._canMoveCurrentTo(r, c)) {
                            self._leadingCellRow = r;
                            self._leadingCellCol = leadingCellCol;
                            self._setActiveCellCore(r, c);
                        }
                    }
                },
                _getMoveUpCell: function (row, col, wrap, leadingCellCol) {
                    var self = this;
                    var rowCount = getSheetRowCount(self);
                    var colCount = getSheetColumnCount(self);
                    var r = row, c;
                    if (r === 0 && !wrap || !(rowCount !== 0 && colCount !== 0)) {
                        return keyword_null;
                    }
                    var cell = self._getPrevRow(r, leadingCellCol);
                    if (!wrap) {
                        self._adjustCell(cell);
                    }
                    r = cell.r;
                    c = cell.c;
                    if (r < 0 && wrap) {
                        c = self._getPrevVisualColumn(c);
                        if (c < 0 || isNullOrUndefined(c)) {
                            c = self._getPrevVisualColumn(colCount);
                        }
                        leadingCellCol = c;
                        cell = self._getPrevRow(rowCount, c);
                        r = cell.r;
                        c = cell.c;

                        if (c === col && r <= row) {
                            return keyword_null;
                        }
                    }
                    return {
                        row: r,
                        col: c,
                        leadingCellCol: leadingCellCol
                    };
                },
                _moveActiveCellDown: function (row, col, wrap) {
                    var self = this;
                    var downCell = self._getMoveDownCell(row, col, wrap, self._leadingCellCol || 0);
                    if (downCell && (downCell.row !== row || downCell.col !== col)) {
                        var r = downCell.row, c = downCell.col, leadingCellCol = downCell.leadingCellCol;
                        if (self._canMoveCurrentTo(r, c)) {
                            self._leadingCellRow = r;
                            self._leadingCellCol = leadingCellCol;
                            self._setActiveCellCore(r, c);
                        }
                    }
                },
                _getMoveDownCell: function (row, col, wrap, leadingCellCol) {
                    var self = this;
                    var rowCount = getSheetRowCount(self);
                    var colCount = getSheetColumnCount(self);
                    var r = row, c;
                    if (r === rowCount - 1 && !wrap || !(rowCount !== 0 && colCount !== 0)) {
                        return;
                    }
                    var cell = self._getNextRow(r, leadingCellCol);
                    if (!wrap) {
                        self._adjustCell(cell);
                    }
                    r = cell.r;
                    c = cell.c;
                    if (r === rowCount && wrap) {
                        c = self._getNextVisualColumn(c);
                        if (c >= colCount || isNullOrUndefined(c)) {
                            c = self._getNextVisualColumn(-1);
                        }
                        leadingCellCol = c;
                        cell = self._getNextRow(-1, c);
                        r = cell.r;
                        c = cell.c;
                        if (c === col && r >= row) {
                            return;
                        }
                    }
                    return {
                        row: r,
                        col: c,
                        leadingCellCol: leadingCellCol
                    };
                },
                _moveActiveCellLast: function () {
                    var self = this;
                    var lastCell = self._getMoveLastCell();
                    if (lastCell) {
                        var r = lastCell.row, c = lastCell.col;
                        self._leadingCellRow = r;
                        self._leadingCellCol = c;
                        self._setActiveCellCore(r, c);
                    }
                },
                _getMoveLastCell: function () {
                    var self = this;
                    var r = self._getLastVisualRow();
                    var lastCol = self._getLastVisualColumn();
                    var c = lastCol;
                    if (!r && !c) {
                        return keyword_null;
                    }
                    var options = self.options, protectionOption = options.protectionOptions;
                    var allowLocked = protectionOption.allowSelectLockedCells !== false;
                    var allowUnlocked = protectionOption.allowSelectUnlockedCells !== false;
                    if (
                        !options.isProtected
                        || allowLocked
                        && allowUnlocked
                    ) {
                        return {
                            row: r,
                            col: c
                        };
                    }
                    if (!allowLocked && !allowUnlocked) {
                        return keyword_null;
                    }
                    for (; r !== keyword_null && r >= 0; r = self._getPrevVisualRow(r)) {
                        for (c = lastCol; c !== keyword_null && c >= 0; c = self._getPrevVisualColumn(c)) {
                            var locked = self._getStyleProperty(r, c, 'locked');
                            if (allowLocked === locked) {
                                return {
                                    row: r,
                                    col: c
                                };
                            }
                        }
                    }
                    return keyword_null;
                },
                _moveActiveCellFirst: function () {
                    var self = this;
                    var first = self._getMoveFirstCell();
                    if (first) {
                        var r = first.row, c = first.col;
                        self._leadingCellRow = r;
                        self._leadingCellCol = c;
                        self._setActiveCellCore(r, c);
                    }
                },
                _getMoveFirstCell: function () {
                    var self = this;
                    var r = self._getNextVisualRow(self.frozenRowCount() - 1);
                    var firstCol = self._getNextVisualColumn(self.frozenColumnCount() - 1);
                    var c = firstCol;
                    var lastRow = self._getLastVisualRow();
                    var lastCol = self._getLastVisualColumn();
                    if (r === keyword_null || c === keyword_null) {
                        return keyword_null;
                    }
                    var options = self.options, protectionOption = options.protectionOptions;
                    var allowLocked = protectionOption.allowSelectLockedCells !== false;
                    var allowUnlocked = protectionOption.allowSelectUnlockedCells !== false;
                    if (
                        !options.isProtected
                        ||
                        allowLocked
                        && allowUnlocked
                    ) {
                        return {
                            row: r,
                            col: c
                        };
                    }
                    if (!allowLocked && !allowUnlocked) {
                        return keyword_null;
                    }
                    for (; r !== keyword_null && r <= lastRow; r = self._getNextVisualRow(r)) {
                        for (c = firstCol; c !== keyword_null && c <= lastCol; c = self._getNextVisualColumn(c)) {
                            var locked = self._getStyleProperty(r, c, 'locked');
                            if (allowLocked === locked) {
                                return {
                                    row: r,
                                    col: c
                                };
                            }
                        }
                    }
                    return keyword_null;
                },
                _moveActiveCellLeft: function (row, col, wrap) {
                    var self = this;
                    var leftCell;
                    var tableManager = self.tables;
                    if (!wrap) {
                        leftCell = self._getMoveLeftCell(row, col, wrap, self._leadingCellRow || 0);
                    } else {
                        leftCell = tableManager && tableManager._getTableMoveLeftCell(row, col);
                        if (!leftCell) {
                            leftCell = self._getMoveLeftCell(row, col, wrap, self._leadingCellRow || 0);
                        }
                    }
                    if (leftCell) {
                        var r = leftCell.row, c = leftCell.col, leadingCellRow = leftCell.leadingCellRow;
                        if (self._canMoveCurrentTo(r, c)) {
                            self._leadingCellRow = leadingCellRow;
                            self._leadingCellCol = c;
                            self._setActiveCellCore(r, c);
                        }
                    }
                },
                _getMoveLeftCell: function (row, col, wrap, leadingCellRow) {
                    var self = this;
                    var rowCount = getSheetRowCount(self);
                    var colCount = getSheetColumnCount(self);
                    var r, c = col;
                    if (c === 0 && !wrap || !(rowCount !== 0 && colCount !== 0)) {
                        return keyword_null;
                    }
                    var cell = self._getPrevColumn(leadingCellRow, c), startLeadingCellRow = leadingCellRow;
                    if (!wrap) {
                        self._adjustCell(cell);
                    }
                    r = cell.r;
                    c = cell.c;
                    while (c < 0 && wrap) {
                        r = self._getPrevVisualRow(r, 3, true);
                        if (r < 0 || isNullOrUndefined(r)) {
                            r = self._getPrevVisualRow(rowCount, 3, true);
                        }
                        leadingCellRow = r;
                        cell = self._getPrevColumn(leadingCellRow, colCount);
                        r = cell.r;
                        c = cell.c;
                        if (r === row && c < col) {
                            return keyword_null;
                        } else if (r === row && c === col) {
                            if (leadingCellRow === startLeadingCellRow) {
                                return keyword_null;
                            }
                            cell = self._getPrevColumn(leadingCellRow, c);
                            r = cell.r;
                            c = cell.c;
                        }
                    }
                    return {
                        row: r,
                        col: c,
                        leadingCellRow: leadingCellRow
                    };
                },
                _adjustCell: function (cell) {
                    var self = this, adjusted = false;
                    if (cell.r < 0) {
                        cell.r = self._getFirstVisualRow();
                    } else if (cell.r >= getSheetRowCount(self)) {
                        cell.r = self._getLastVisualRow();
                        adjusted = true;
                    }
                    if (cell.c < 0) {
                        cell.c = self._getFirstVisualColumn();
                    } else if (cell.c >= getSheetColumnCount(self)) {
                        cell.c = self._getLastVisualColumn();
                        adjusted = true;
                    }
                    if (adjusted) {
                        var currentSpan = self._modelManager.getSpan(cell.r, cell.c);
                        if (currentSpan.row !== cell.r) {
                            cell.r = currentSpan.row;
                        }
                        if (currentSpan.col !== cell.c) {
                            cell.c = currentSpan.col;
                        }
                    }
                },
                _moveActiveCellLeftInSelection: function (row, col) {
                    var self = this;
                    var modelManager = self._modelManager, startRangeIndex = modelManager.getActiveSelectedRangeIndex(), prevRangeIndex = -1;
                    var startRange = self._getActualRange(self._getActiveSelectedRange()), beginRow = startRange.row, beginCol = startRange.col, endCol = startRange.col + getColCount(startRange) - 1;
                    var r = row, c = col, cell;
                    while (true) {
                        cell = self._getPrevColumnInSelection(r, c);
                        r = cell.r;
                        c = cell.c;
                        if (c >= beginCol) {
                            break;
                        }
                        if (prevRangeIndex === startRangeIndex && r === row && c <= col) {
                            return;
                        }
                        r--;
                        if (r >= beginRow) {
                            c = endCol + 1;
                        } else {
                            var prevRange = self._getActualRange(self._getActiveSelectedRange(3));
                            prevRangeIndex = modelManager.getActiveSelectedRangeIndex();
                            beginRow = prevRange.row;
                            beginCol = prevRange.col;
                            endCol = prevRange.col + getColCount(prevRange) - 1;
                            r = prevRange.row + getRowCount(prevRange) - 1;
                            c = prevRange.col + getColCount(prevRange);
                        }
                    }
                    if (r >= 0) {
                        self._setActiveCellCore(r, c);
                        self._leadingCellRow = r;
                        self._leadingCellCol = c;
                    }
                },
                _moveActiveCellRightInSelection: function (row, col) {
                    var self = this;
                    var modelManager = self._modelManager, startRangeIndex = modelManager.getActiveSelectedRangeIndex(), nextRangeIndex = -1;
                    var startRange = self._getActualRange(self._getActiveSelectedRange()), beginCol = startRange.col, endRow = startRange.row + getRowCount(startRange) - 1, endCol = startRange.col + getColCount(startRange) - 1;
                    var r = row, c = col, cell;
                    while (true) {
                        cell = self._getNextColumnInSelection(r, c);
                        r = cell.r;
                        c = cell.c;
                        if (c <= endCol) {
                            break;
                        }
                        if (nextRangeIndex === startRangeIndex && r === row && c >= col) {
                            return;
                        }
                        r++;
                        if (r <= endRow) {
                            c = beginCol - 1;
                        } else {
                            var nextRange = self._getActualRange(self._getActiveSelectedRange(4));
                            nextRangeIndex = modelManager.getActiveSelectedRangeIndex();
                            beginCol = nextRange.col;
                            endRow = nextRange.row + getRowCount(nextRange) - 1;
                            endCol = nextRange.col + getColCount(nextRange) - 1;
                            r = nextRange.row;
                            c = nextRange.col - 1;
                        }
                    }
                    if (r >= 0) {
                        self._setActiveCellCore(r, c);
                        self._leadingCellRow = r;
                        self._leadingCellCol = c;
                    }
                },
                _moveActiveCellRight: function (row, col, wrap) {
                    var self = this;
                    var rightCell;
                    var tableManager = self.tables;
                    if (!wrap) {
                        rightCell = self._getMoveRightCell(row, col, wrap, self._leadingCellRow || 0);
                    } else {
                        rightCell = tableManager && tableManager._getTableMoveRightCell(row, col);
                        if (!rightCell) {
                            rightCell = self._getMoveRightCell(row, col, wrap, self._leadingCellRow || 0);
                        }
                    }
                    if (rightCell && (rightCell.row !== row || rightCell.col !== col)) {
                        var r = rightCell.row;
                        var c = rightCell.col;
                        var leadingCellRow = rightCell.leadingCellRow;
                        if (self._canMoveCurrentTo(r, c)) {
                            self._leadingCellRow = leadingCellRow;
                            self._leadingCellCol = c;
                            self._setActiveCellCore(r, c);
                        }
                    }
                },
                _getMoveRightCell: function (row, col, wrap, leadingCellRow) {
                    var self = this;
                    var rowCount = getSheetRowCount(self);
                    var colCount = getSheetColumnCount(self);
                    var r;
                    var c = col;
                    if (c === colCount - 1 && !wrap || !(rowCount !== 0 && colCount !== 0)) {
                        return keyword_null;
                    }
                    var cell = self._getNextColumn(leadingCellRow, c), startLeadingCellRow = leadingCellRow;
                    if (!wrap) {
                        self._adjustCell(cell);
                    }
                    r = cell.r;
                    c = cell.c;
                    while (c === colCount && wrap) {
                        if (
                            row === (rowCount - 1)
                            && row === r
                            && (!self.getRowVisible(r, 3) || !(self._getZoomRowHeight(r, 3) > 0))
                        ) {
                            return keyword_null;
                        }
                        r = self._getNextVisualRow(r, 3, true);
                        if (r >= rowCount || isNullOrUndefined(r)) {
                            r = self._getNextVisualRow(-1, 3, true);
                        }
                        leadingCellRow = r;
                        cell = self._getNextColumn(leadingCellRow, -1);
                        r = cell.r;
                        c = cell.c;
                        if (r === row && c > col) {
                            return keyword_null;
                        } else if (r === row && c === col) {
                            if (leadingCellRow === startLeadingCellRow) {
                                return keyword_null;
                            }
                            cell = self._getNextColumn(leadingCellRow, c);
                            r = cell.r;
                            c = cell.c;
                        }
                    }
                    return {
                        row: r,
                        col: c,
                        leadingCellRow: leadingCellRow
                    };
                },
                _getPrevColumn: function (r, c) {
                    var self = this;
                    var row, col = c;
                    while (col >= 0) {
                        row = r;
                        col--;
                        if (col < 0) {
                            break;
                        }
                        var spans = self._modelManager.getSpans(common_1._createRange(row, col, 1, 1));
                        if (spans && _ArrayHelper_getLength(spans) > 0) {
                            var span = spans[0];
                            if (col >= span.col) {
                                col = span.col;
                                row = span.row;
                            }
                        }
                        if (self._canMoveCurrentTo(row, col)) {
                            return {
                                r: row,
                                c: col
                            };
                        }
                    }
                    return {
                        r: row,
                        c: col
                    };
                },
                _getPrevColumnInSelection: function (r, c) {
                    var self = this;
                    while (c >= 0) {
                        c--;
                        if (c < 0) {
                            break;
                        }
                        var span = self._modelManager.findSpan(r, c);
                        if (span) {
                            var activeSelectedRange = self._getActiveSelectedRange();
                            if (
                                activeSelectedRange.row <= span.row
                                && span.row + getRowCount(span) <= activeSelectedRange.row + getRowCount(activeSelectedRange)
                                && activeSelectedRange.col <= span.col
                                && span.col + getColCount(span) <= activeSelectedRange.col + getColCount(activeSelectedRange)
                            ) {
                                if (!(span.row === r && span.col === c)) {
                                    continue;
                                }
                            } else {
                                continue;
                            }
                            if (c >= span.col) {
                                c = span.col;
                                r = span.row;
                            }
                        }
                        if (self._canMoveCurrentTo(r, c)) {
                            return {
                                r: r,
                                c: c
                            };
                        }
                    }
                    return {
                        r: r,
                        c: c
                    };
                },
                _getNextColumn: function (r, c) {
                    var self = this;
                    var colCount = getSheetColumnCount(self);
                    var row;
                    var col = c;
                    while (col < colCount) {
                        row = r;
                        var currentSpan = self._modelManager.getSpan(row, col);
                        col = currentSpan.col + getColCount(currentSpan);
                        if (col >= colCount) {
                            break;
                        }
                        var spans = self._modelManager.getSpans(common_1._createRange(row, col, 1, 1));
                        if (spans && _ArrayHelper_getLength(spans) > 0) {
                            var span = spans[0];
                            if (col > span.col) {
                                col = Math_max(col, span.col + getColCount(span));
                            } else {
                                row = span.row;
                            }
                        }
                        if (self._canMoveCurrentTo(row, col)) {
                            return {
                                r: row,
                                c: col
                            };
                        }
                    }
                    return {
                        r: row,
                        c: col
                    };
                },
                _getNextColumnInSelection: function (r, c) {
                    var self = this, modelManager = self._modelManager;
                    var colCount = getSheetColumnCount(self);
                    while (c < colCount) {
                        var currentSpan = modelManager.getSpan(r, c);
                        c = currentSpan.col + getColCount(currentSpan);
                        if (c >= colCount) {
                            break;
                        }
                        var span = modelManager.findSpan(r, c);
                        if (span) {
                            var activeSelectedRange = self._getActiveSelectedRange();
                            if (
                                activeSelectedRange.row <= span.row
                                && span.row + getRowCount(span) <= activeSelectedRange.row + getRowCount(activeSelectedRange)
                                && activeSelectedRange.col <= span.col
                                && span.col + getColCount(span) <= activeSelectedRange.col + getColCount(activeSelectedRange)
                            ) {
                                if (!(span.row === r && span.col === c)) {
                                    continue;
                                }
                            } else {
                                continue;
                            }
                            if (c > span.col) {
                                c = Math_max(c, span.col + getColCount(span));
                            } else {
                                r = span.row;
                            }
                        }
                        if (self._canMoveCurrentTo(r, c)) {
                            return {
                                r: r,
                                c: c
                            };
                        }
                    }
                    return {
                        r: r,
                        c: c
                    };
                },
                _canMoveCurrentTo: function (r, c) {
                    var self = this;
                    if (!self._canSelect(r, c)) {
                        return false;
                    }
                    var canMove = (r >= 0 && r < getSheetRowCount(self) && c >= 0 && c < getSheetColumnCount(self) &&
                        self.getRowVisible(r) && self.getColumnVisible(c) &&
                        self._getZoomRowHeight(r) > 0 && self._getZoomColumnWidth(c) > 0);
                    var checkTab = !!self._isTabNavigation;
                    if (canMove === true && checkTab === true) {
                        var tabStop = self._getStyleProperty(r, c, 'tabStop');
                        if (tabStop === false) {
                            canMove = false;
                        }
                    }
                    return canMove;
                },
                _getPrevRow: function (r, c) {
                    var self = this;
                    while (r >= 0) {
                        r--;
                        if (r < 0) {
                            break;
                        }
                        var spans = self._modelManager.getSpans(common_1._createRange(r, c, 1, 1));
                        if (spans && _ArrayHelper_getLength(spans) > 0) {
                            var span = spans[0];
                            if (r >= span.row) {
                                r = span.row;
                                c = span.col;
                            }
                        }
                        if (self._canMoveCurrentTo(r, c)) {
                            return {
                                r: r,
                                c: c
                            };
                        }
                    }
                    return {
                        r: r,
                        c: c
                    };
                },
                _getNextRow: function (r, c) {
                    var self = this;
                    var rowCount = getSheetRowCount(self);
                    while (r < rowCount) {
                        var currentSpan = self._modelManager.getSpan(r, c);
                        r = currentSpan.row + getRowCount(currentSpan);
                        if (r >= rowCount) {
                            break;
                        }
                        var spans = self._modelManager.getSpans(common_1._createRange(r, c, 1, 1));
                        if (spans && _ArrayHelper_getLength(spans) > 0) {
                            var span = spans[0];
                            if (r > span.row) {
                                r = Math_max(r, span.row + getRowCount(span));
                            } else {
                                c = span.col;
                            }
                        }
                        if (self._canMoveCurrentTo(r, c)) {
                            return {
                                r: r,
                                c: c
                            };
                        }
                    }
                    return {
                        r: r,
                        c: c
                    };
                },
                _setSelectedRange: function (r, c, rc, cc, repaint) {
                    var self = this;
                    self._modelManager.do('addSelection', r, c, rc, cc);
                    if (repaint && self._layoutSuspended <= 0) {
                        self._render._repaintSelection();
                    }
                },
                _extendSelectedRange: function (r, c, repaint) {
                    var self = this;
                    var extendedRange = self._getExtendedRange(r, c, self._activeRowIndex, self._activeColIndex);
                    var newRow = extendedRange.row;
                    var newCol = extendedRange.col;
                    var newRowCount = getRowCount(extendedRange);
                    var newColCount = getColCount(extendedRange);
                    var selectionPolicy = self.selectionPolicy();
                    var selectionUnit = self.selectionUnit();
                    if (selectionPolicy === 0) {
                        return;
                    } else if (selectionPolicy === 1) {
                        self._modelManager.do('clearSelection');
                    }
                    if (selectionUnit === 1) {
                        newCol = -1;
                        newColCount = -1;
                    } else if (selectionUnit === 2) {
                        newRow = -1;
                        newRowCount = -1;
                    }
                    self._replaceActiveSelectedRange(newRow, newCol, newRowCount, newColCount, repaint);
                },
                _getExtendedRange: function (r, c, anchorRow, anchorCol, oneMergedCellAsOneCell) {
                    var self = this;
                    if (isNullOrUndefined(anchorRow)) {
                        anchorRow = self._activeRowIndex;
                    }
                    if (isNullOrUndefined(anchorCol)) {
                        anchorCol = self._activeColIndex;
                    }
                    var modelManager = self._modelManager;
                    var anchorRange = modelManager.getSpan(anchorRow, anchorCol);
                    var endRange = modelManager.getSpan(r, c);
                    if (oneMergedCellAsOneCell && anchorRange.equals(endRange)) {
                        return new common_1.Range(anchorRange.row, anchorRange.col, 1, 1);
                    }
                    var extendedRange = anchorRange.union(endRange);
                    var spans = self._modelManager.getSpans();
                    if (spans && _ArrayHelper_getLength(spans) > 0) {
                        extendedRange = self._inflateRangeToCoverSpans(spans, extendedRange);
                    }
                    return extendedRange;
                },
                _replaceActiveSelectedRange: function (r, c, rc, cc, repaint) {
                    var self = this, modelManager = self._modelManager;
                    var oldSelectedRange = self._getActiveSelectedRange();
                    var oldDeselectRange;
                    if (_ArrayHelper_getLength(modelManager.getSelections()) > 0) {
                        var newRange = common_1._createRange(r, c, rc, cc);
                        if (self._isDeselecting) {
                            oldDeselectRange = self._deselectRange;
                            self._deselectRange = newRange;
                        } else {
                            var selections = modelManager.getSelections();
                            selections[modelManager.getActiveSelectedRangeIndex()] = newRange;
                            modelManager.do('setSelections', selections);
                        }
                    } else if (!self._isDeselecting) {
                        modelManager.do('addSelection', r, c, rc, cc);
                    }
                    if (repaint && self._layoutSuspended <= 0) {
                        var newSelectedRange = self._getActiveSelectedRange();
                        if (
                            !self._isDeselecting
                            && newSelectedRange.row === oldSelectedRange.row
                            && newSelectedRange.col === oldSelectedRange.col
                            && getRowCount(newSelectedRange) === getRowCount(oldSelectedRange)
                            && getColCount(newSelectedRange) === getColCount(oldSelectedRange)
                        ) {
                            return;
                        }
                        var render = self._render;
                        if (self._isDeselecting) {
                            var unionRange = self._deselectRange;
                            if (oldDeselectRange && oldDeselectRange.containsRange(unionRange)) {
                                unionRange = oldDeselectRange;
                            } else if (oldDeselectRange) {
                                unionRange = oldDeselectRange.union(unionRange);
                            }
                            unionRange = unionRange.union(common_1._createRange(self.getActiveRowIndex(), self.getActiveColumnIndex(), 1, 1));
                            oldSelectedRange = unionRange.union(oldSelectedRange);
                            newSelectedRange = unionRange.union(newSelectedRange);
                        }
                        if (oldSelectedRange.containsRange(newSelectedRange)) {
                            render._repaintSelection(oldSelectedRange);
                        } else if (newSelectedRange.containsRange(oldSelectedRange)) {
                            render._repaintSelection(newSelectedRange);
                        } else {
                            render._repaintSelection(oldSelectedRange);
                            render._repaintSelection(newSelectedRange);
                            render._repaintSelection(self._deselectRange);
                        }
                    }
                },
                _getSpanRange: function (range) {
                    var spans = [];
                    if (range) {
                        spans = this._modelManager.getSpans(range);
                    }
                    return spans;
                },
                _isRangeIntersectSpan: function (range, span) {
                    var rangeRow = range.row;
                    var rangeCol = range.col;
                    var rangeRowCount = range.rowCount;
                    var rangeColCount = range.colCount;
                    var spanRow = span.row;
                    var spanCol = span.col;
                    var spanRowCount = span.rowCount;
                    var spanColCount = span.colCount;
                    var rangeEndRow = rangeRow + rangeRowCount;
                    var rangeEndCol = rangeCol + rangeColCount;
                    var spanEndRow = spanRow + spanRowCount;
                    var spanEndCol = spanCol + spanColCount;
                    var intersect = false;
                    var isContained = false;
                    var result;
                    if (range.intersect(spanRow, spanCol, spanRowCount, spanColCount)) {
                        result = rangeRow > spanRow || rangeCol > spanCol ||
                            rangeEndRow < spanEndRow || rangeEndCol < spanEndCol;
                        intersect = result;
                        isContained = !result;
                    }
                    span._isContained = span._isContained || isContained;
                    return intersect;
                },
                _getRangeWithoutSpan: function (rangeArr, spans, maxRowCount, maxColCount) {
                    var resultRange = [];
                    var currentRangeArr = [];
                    for (var i = 0; i < rangeArr.length; i++) {
                        currentRangeArr = this._deselectSpan(rangeArr[i], spans, maxRowCount, maxColCount);
                        resultRange = resultRange.concat(currentRangeArr);
                    }
                    return resultRange;
                },
                _deselectSpan: function (currentRange, spans, maxRowCount, maxColCount) {
                    var currentRangeArr = [];
                    var spansLen = spans.length;
                    var range;
                    var span;
                    var deselectSpanResult;
                    currentRangeArr.push(currentRange);
                    for (var k = spansLen - 1; k >= 0; k--) {
                        span = spans[k];
                        for (var j = 0; j < currentRangeArr.length;) {
                            range = currentRangeArr[j];
                            if (this._isRangeIntersectSpan(range, span)) {
                                deselectSpanResult = this._deselectSelection(range, span, maxRowCount, maxColCount);
                                currentRangeArr = replaceItem(currentRangeArr, j, deselectSpanResult);
                                j += deselectSpanResult.length;
                            } else {
                                j++;
                            }
                        }
                    }
                    return currentRangeArr;
                },
                _isSpanIntersectRange: function (span, range) {
                    var row = range.row;
                    var col = range.col;
                    var rowCount = range.rowCount;
                    var colCount = range.colCount;
                    return span.intersect(row, col, rowCount, colCount);
                },
                _getSpanArrNotIntersectDeselectRange: function (spanArr, deselectRange) {
                    var len = spanArr.length;
                    var resultArr = [];
                    var spanRange;
                    for (var i = len - 1; i >= 0; i--) {
                        spanRange = spanArr[i];
                        if (!this._isSpanIntersectRange(spanRange, deselectRange)) {
                            resultArr.push(spanRange);
                        }
                    }
                    return resultArr;
                },
                _currentSelectionIsSpan: function (selection) {
                    var result = false;
                    var spans = this._modelManager.getSpans(selection);
                    if (spans.length === 1) {
                        result = selection.equals(spans[0]);
                    }
                    return result;
                },
                _uniqueConcat: function (rangeArr, concatArr) {
                    var tempArr = rangeArr;
                    var len = concatArr.length;
                    var tempLen = tempArr.length;
                    var isUnique = true;
                    var tempItem;
                    var item;
                    for (var i = len - 1; i >= 0; i--) {
                        item = concatArr[i];
                        for (var j = tempLen - 1; j >= 0; j--) {
                            tempItem = tempArr[j];
                            if (tempItem.equals(item)) {
                                isUnique = false;
                                break;
                            }
                        }
                        if (isUnique) {
                            tempArr.push(item);
                        }
                    }
                    return tempArr;
                },
                _removeContainedSpan: function (spanArr) {
                    var len = spanArr.length;
                    var indexArr = [];
                    var span;
                    for (var i = len - 1; i >= 0; i--) {
                        span = spanArr[i];
                        if (span._isContained) {
                            delete span._isContained;
                            indexArr.push(i);
                        }
                    }
                    var indexArrLen = indexArr.length;
                    for (var j = 0; j < indexArrLen; j++) {
                        spanArr.splice(indexArr[j], 1);
                    }
                },
                _deselectSelection: function (originalRange, deselectRange, maxRowCount, maxColCount) {
                    deselectRange = this._getActualRange(deselectRange);
                    var result = [];
                    var newRange = originalRange.getIntersect(deselectRange, maxRowCount, maxColCount);
                    if (originalRange && newRange) {
                        var originalRow = originalRange.row >= 0 ? originalRange.row : 0;
                        var originalCol = originalRange.col >= 0 ? originalRange.col : 0;
                        var originalRowCount = originalRange.rowCount;
                        var originalColCount = originalRange.colCount;
                        var newRow = newRange.row;
                        var newCol = newRange.col;
                        var newRowCount = newRange.rowCount;
                        var newColCount = newRange.colCount;
                        var originalEndRow = originalRow + originalRowCount;
                        var originalEndCol = originalCol + originalColCount;
                        var newEndRow = newRow + newRowCount;
                        var newEndCol = newCol + newColCount;
                        if (originalEndRow - newEndRow > 0) {
                            result.push(common_1._createRange(newEndRow, originalCol, originalEndRow - newEndRow, originalColCount));
                        }
                        if (originalEndCol - newEndCol > 0) {
                            result.push(common_1._createRange(newRow, newEndCol, newRowCount, originalEndCol - newEndCol));
                        }
                        if (newCol - originalCol > 0) {
                            result.push(common_1._createRange(newRow, originalCol, newRowCount, newCol - originalCol));
                        }
                        if (newRow - originalRow > 0) {
                            result.push(common_1._createRange(originalRow, originalCol, newRow - originalRow, originalColCount));
                        }
                    } else {
                        result.push(originalRange);
                    }
                    return result;
                },
                _deselectSelections: function (selections, deselectRange) {
                    var result = [];
                    var maxRowCount = this.getRowCount(3);
                    var maxColCount = this.getColumnCount(3);
                    var ignoreSpan = this.deselectIgnoreSpan();
                    var hasSetActiveCell;
                    if (selections && selections.length > 0) {
                        var len = selections.length;
                        var temArr = [];
                        var spanArr = [];
                        var tempSpanArr = [];
                        var selc = void 0;
                        var spans = void 0;
                        hasSetActiveCell = false;
                        for (var i = len - 1; i >= 0; i--) {
                            selc = selections[i];
                            if (!ignoreSpan && this._currentSelectionIsSpan(selc) && !this._isSpanIntersectRange(selc, deselectRange)) {
                                spanArr = this._uniqueConcat(spanArr, [selc]);
                                continue;
                            }
                            temArr = this._deselectSelection(selc, deselectRange, maxRowCount, maxColCount);
                            if (!ignoreSpan) {
                                spans = this._getSpanRange(selc);
                                if (spans.length > 0) {
                                    temArr = this._getRangeWithoutSpan(temArr, spans, maxRowCount, maxColCount);
                                    tempSpanArr = this._getSpanArrNotIntersectDeselectRange(spans, deselectRange);
                                    spanArr = this._uniqueConcat(spanArr, tempSpanArr);
                                    this._removeContainedSpan(spanArr);
                                }
                            }
                            var temArrLen = _ArrayHelper_getLength(temArr);
                            if (!hasSetActiveCell && temArrLen > 0) {
                                this.setSelection(temArr[temArrLen - 1].row, temArr[temArrLen - 1].col, 1, 1);
                                hasSetActiveCell = true;
                            }
                            result = temArr.concat(result);
                        }
                        if (!ignoreSpan) {
                            result = spanArr.concat(result);
                        }
                    }
                    this._clearSelectionImp();
                    var resultLen = result.length;
                    this.suspendPaint();
                    for (var j = 0; j < resultLen; j++) {
                        this.addSelection(result[j].row, result[j].col, result[j].rowCount, result[j].colCount);
                    }

                    if (!hasSetActiveCell) {
                        this.setActiveCell(this._activeRowIndex, this._activeColIndex);
                    }
                    this.resumePaint();
                },
                _changeActiveSelectedRange: function (key, isCtrl) {
                    var self = this;
                    var oldSelections = self._modelManager.getSelections();
                    if (_ArrayHelper_getLength(oldSelections) <= 0) {
                        return;
                    }
                    var oldActiveRange = self._getActiveSelectedRange();
                    var newRange = self._getKeyboardSelectedRange(oldActiveRange, key, isCtrl);
                    if (newRange) {
                        var newRow = newRange.row, newCol = newRange.col, newRowCount = getRowCount(newRange), newColCount = getColCount(newRange);
                        var selectionPolicy = self.selectionPolicy();
                        var selectionUnit = self.selectionUnit();
                        if (selectionPolicy === 0) {
                            return;
                        } else if (selectionPolicy === 1) {
                            self._modelManager.do('clearSelection');
                        }
                        if (selectionUnit === 1) {
                            newCol = -1;
                            newColCount = -1;
                        } else if (selectionUnit === 2) {
                            newRow = -1;
                            newRowCount = -1;
                        }
                        self._replaceActiveSelectedRange(newRow, newCol, newRowCount, newColCount, true);
                        var newSelections = self._modelManager.getSelections();
                        if (self._eventHandler._notEqualSelecions(oldSelections, newSelections)) {
                            self._raiseSelectionChanging(oldSelections, newSelections);
                            self._raiseSelectionChanged(oldSelections);
                        }
                    }
                },
                _getKeyboardSelectedRange: function (activeRange, key, isCtrl, anchorRow, anchorCol) {
                    var self = this;
                    var range = self._getActualRange(activeRange);
                    var newRange = keyword_null;
                    if (key === 37) {
                        newRange = isCtrl ? self._searchSelectedRangebyLeftCtrl(range, false, anchorRow, anchorCol) : self._searchSelectedRangebyLeft(range, anchorRow, anchorCol);
                    } else if (key === 39) {
                        newRange = isCtrl ? self._searchSelectedRangebyRightCtrl(range, false, anchorRow, anchorCol) : self._searchSelectedRangebyRight(range, anchorRow, anchorCol);
                    } else if (key === 38) {
                        newRange = isCtrl ? self._searchSelectedRangebyUpCtrl(range, false, anchorRow, anchorCol) : self._searchSelectedRangebyUp(range, anchorRow, anchorCol);
                    } else if (key === 40) {
                        newRange = isCtrl ? self._searchSelectedRangebyDownCtrl(range, false, anchorRow, anchorCol) : self._searchSelectedRangebyDown(range, anchorRow, anchorCol);
                    } else if (key === 36) {
                        newRange = isCtrl ? self._searchSelectedRangebyHomeCtrl(range, anchorRow, anchorCol) : self._searchSelectedRangebyHome(range, anchorRow, anchorCol);
                    } else if (key === 35) {
                        newRange = isCtrl ? self._searchSelectedRangebyEndCtrl(range, anchorRow, anchorCol) : self._searchSelectedRangebyEnd(range, anchorRow, anchorCol);
                    } else if (key === 33) {
                        newRange = self._searchSelectedRangebyPageUp(range, anchorRow, anchorCol);
                    } else if (key === 34) {
                        newRange = self._searchSelectedRangebyPageDown(range, anchorRow, anchorCol);
                    }
                    if (newRange) {
                        if (activeRange.row < 0) {
                            newRange.row = -1;
                            newRange.rowCount = self.getRowCount();
                        }
                        if (activeRange.col < 0) {
                            newRange.col = -1;
                            newRange.colCount = self.getColumnCount();
                        }
                    }
                    return newRange;
                },
                _searchSelectedRangebyLeft: function (activeRange, anchorRow, anchorCol) {
                    var self = this;
                    var activeRangeRow = activeRange.row;
                    var activeRangeCol = activeRange.col;
                    var activeRangeRowCount = getRowCount(activeRange);
                    var activeRangeColCount = getColCount(activeRange);
                    var beginCol = activeRangeCol + activeRangeColCount - 1;
                    var endCol = 0;
                    var startPositionRow = getLastVisibleRow(self, activeRangeRow, activeRangeRowCount);
                    var extendedRange;
                    var row;
                    var col;
                    var row2;
                    var col2;
                    var rowCount;
                    var colCount;
                    while (beginCol > endCol) {
                        beginCol--;
                        if (!self._canMoveCurrentTo(startPositionRow, beginCol)) {
                            continue;
                        }
                        extendedRange = self._getExtendedRange(startPositionRow, beginCol, anchorRow, anchorCol);
                        row = Math_min(activeRangeRow, extendedRange.row);
                        col = Math_min(activeRangeCol, extendedRange.col);
                        row2 = Math_max(activeRangeRow + activeRangeRowCount - 1, extendedRange.row + getRowCount(extendedRange) - 1);
                        col2 = Math_min(activeRangeCol + activeRangeColCount - 1, extendedRange.col + getColCount(extendedRange) - 1);
                        rowCount = row2 - row + 1;
                        colCount = col2 - col + 1;
                        if (!(row === activeRangeRow && col === activeRangeCol && rowCount === activeRangeRowCount && colCount === activeRangeColCount)) {
                            var scrollLeftCol = self._scrollLeftCol;
                            var activeCol = self._activeColIndex;
                            if (activeRangeCol < activeCol) {
                                if (col <= scrollLeftCol) {
                                    self._setLeftColumn(col);
                                }
                            } else if (activeRangeCol === activeCol && col2 <= scrollLeftCol) {
                                self._setLeftColumn(col2);
                            }
                            var scrollByPixel = self.parent && self.parent.options.scrollByPixel;
                            if (scrollByPixel && col === scrollLeftCol && self._scrollLeftColOffset !== 0) {
                                self._setLeftColumn(col, 0);
                            }
                            return common_1._createRange(row, col, rowCount, colCount);
                        }
                    }
                    return keyword_null;
                },
                _searchSelectedRangebyLeftCtrl: function (activeRange, isHomeKey, anchorRow, anchorCol) {
                    var self = this;
                    var activeRangeRow = activeRange.row;
                    var activeRangeCol = activeRange.col;
                    var frozenColCount = self.frozenColumnCount();
                    var firstCol = frozenColCount ? self._getNextVisualColumn(frozenColCount - 1) : self._getFirstVisualColumn();
                    var beginCol = isHomeKey ? firstCol : self._getFirstVisualColumn();
                    if (isNullOrUndefined(beginCol)) {
                        return;
                    } else if (frozenColCount <= 0 || isHomeKey) {
                        self._setLeftColumn(beginCol);
                    }
                    var extendedRange;
                    var row;
                    var col;
                    var row2;
                    var col2;
                    var rowCount;
                    var colCount;
                    extendedRange = self._getExtendedRange(activeRangeRow, beginCol, anchorRow, anchorCol);
                    row = Math_min(activeRangeRow, extendedRange.row);
                    col = Math_min(activeRangeCol, extendedRange.col);
                    row2 = Math_max(activeRangeRow + getRowCount(activeRange) - 1, extendedRange.row + getRowCount(extendedRange) - 1);
                    col2 = Math_min(activeRangeCol + getColCount(activeRange) - 1, extendedRange.col + getColCount(extendedRange) - 1);
                    rowCount = row2 - row + 1;
                    colCount = col2 - col + 1;
                    return common_1._createRange(row, col, rowCount, colCount);
                },
                _getNewLeftColumnForSelectByRight: function (col) {
                    var self = this;
                    var scrollByPixel = self.parent && self.parent.options.scrollByPixel;
                    var newCol;
                    var newOffset;
                    if (!scrollByPixel) {
                        (newCol = self._getNewLeftColumnAndOffset(col, 2).col);
                        newOffset = 0;
                    } else {
                        var cachePool = self._cachePool;
                        var columnViewportIndex = self._getColumnViewportIndex(col);
                        var dWidth = self.getViewportWidth(columnViewportIndex);
                        for (; 0 <= col; col--) {
                            dWidth -= cachePool._getZoomColWidth(col);
                            if (dWidth < 0) {
                                break;
                            }
                        }
                        newCol = col;
                        newOffset = dWidth;
                    }
                    return {
                        _col: newCol,
                        _offset: newOffset
                    };
                },
                _searchSelectedRangebyRight: function (activeRange, anchorRow, anchorCol) {
                    var self = this;
                    var activeRangeRow = activeRange.row;
                    var activeRangeCol = activeRange.col;
                    var activeRangeRowCount = getRowCount(activeRange);
                    var activeRangeColCount = getColCount(activeRange);
                    var beginCol = activeRangeCol;
                    var endCol = getSheetColumnCount(self) - 1;
                    var startPositionRow = getLastVisibleRow(self, activeRangeRow, activeRangeRowCount);
                    var extendedRange;
                    var row;
                    var col;
                    var row2;
                    var col2;
                    var rowCount;
                    var colCount;
                    while (beginCol < endCol) {
                        beginCol++;
                        if (!self._canMoveCurrentTo(startPositionRow, beginCol)) {
                            continue;
                        }
                        extendedRange = self._getExtendedRange(startPositionRow, beginCol, anchorRow, anchorCol);
                        row = Math_min(activeRangeRow, extendedRange.row);
                        col = Math_max(activeRangeCol, extendedRange.col);
                        row2 = Math_max(activeRangeRow + activeRangeRowCount - 1, extendedRange.row + getRowCount(extendedRange) - 1);
                        col2 = Math_max(activeRangeCol + activeRangeColCount - 1, extendedRange.col + getColCount(extendedRange) - 1);
                        rowCount = row2 - row + 1;
                        colCount = col2 - col + 1;
                        if (!(row === activeRangeRow && col === activeRangeCol && rowCount === activeRangeRowCount && colCount === activeRangeColCount)) {
                            var pageRightCol = self._getPageRightColumn();
                            var activeCol = self._activeColIndex;
                            if (activeRangeCol < activeCol) {
                                if (col >= pageRightCol) {
                                    var colInfo = self._getNewLeftColumnForSelectByRight(col);
                                    self._setLeftColumn(colInfo._col, colInfo._offset);
                                }
                            } else if (activeRangeCol === activeCol && col2 >= pageRightCol) {
                                var colInfo = self._getNewLeftColumnForSelectByRight(col2);
                                self._setLeftColumn(colInfo._col, colInfo._offset);
                            }
                            return common_1._createRange(row, col, rowCount, colCount);
                        }
                    }
                    return keyword_null;
                },
                _searchSelectedRangebyRightCtrl: function (activeRange, isEndKey, anchorRow, anchorCol) {
                    var self = this;
                    var activeRangeRow = activeRange.row;
                    var activeRangeCol = activeRange.col;
                    var newPageLeftCol = self._getLastPageLeftColumn();
                    if (isNullOrUndefined(newPageLeftCol)) {
                        return;
                    }
                    self._setLeftColumn(newPageLeftCol);
                    var endCol = self._getLastVisualColumn();
                    if (!isEndKey) {
                        endCol += self.frozenTrailingColumnCount();
                    }
                    var extendedRange;
                    var row;
                    var col;
                    var row2;
                    var col2;
                    var rowCount;
                    var colCount;
                    extendedRange = self._getExtendedRange(activeRangeRow, endCol, anchorRow, anchorCol);
                    row = Math_min(activeRangeRow, extendedRange.row);
                    col = Math_max(activeRangeCol, extendedRange.col);
                    row2 = Math_max(activeRangeRow + getRowCount(activeRange) - 1, extendedRange.row + getRowCount(extendedRange) - 1);
                    col2 = Math_max(activeRangeCol + getColCount(activeRange) - 1, extendedRange.col + getColCount(extendedRange) - 1);
                    rowCount = row2 - row + 1;
                    colCount = col2 - col + 1;
                    return common_1._createRange(row, col, rowCount, colCount);
                },
                _searchSelectedRangebyUp: function (activeRange, anchorRow, anchorCol) {
                    var self = this;
                    var activeRangeRow = activeRange.row;
                    var activeRangeCol = activeRange.col;
                    var activeRangeRowCount = getRowCount(activeRange);
                    var activeRangeColCount = getColCount(activeRange);
                    var beginRow = activeRangeRow + activeRangeRowCount - 1;
                    var endRow = 0;
                    var startPositionCol = getLastVisibleCol(self, activeRangeCol, activeRangeColCount);
                    var extendedRange;
                    var row;
                    var col;
                    var row2;
                    var col2;
                    var rowCount;
                    var colCount;
                    while (beginRow > endRow) {
                        beginRow--;
                        if (!self._canMoveCurrentTo(beginRow, startPositionCol)) {
                            continue;
                        }
                        extendedRange = self._getExtendedRange(beginRow, startPositionCol, anchorRow, anchorCol);
                        row = Math_min(activeRangeRow, extendedRange.row);
                        col = Math_min(activeRangeCol, extendedRange.col);
                        row2 = Math_min(activeRangeRow + activeRangeRowCount - 1, extendedRange.row + getRowCount(extendedRange) - 1);
                        col2 = Math_max(activeRangeCol + activeRangeColCount - 1, extendedRange.col + getColCount(extendedRange) - 1);
                        rowCount = row2 - row + 1;
                        colCount = col2 - col + 1;
                        if (!(row === activeRangeRow && col === activeRangeCol && rowCount === activeRangeRowCount && colCount === activeRangeColCount)) {
                            var scrollTopRow = self._scrollTopRow;
                            var activeRow = self._activeRowIndex;
                            if (activeRangeRow < activeRow) {
                                if (row <= scrollTopRow) {
                                    self._setTopRow(row);
                                }
                            } else if (activeRangeRow === activeRow && row2 <= scrollTopRow) {
                                self._setTopRow(row2);
                            }
                            var scrollByPixel = self.parent && self.parent.options.scrollByPixel;
                            if (scrollByPixel && row === scrollTopRow && self._scrollTopRowOffset !== 0) {
                                self._setTopRow(row, 0);
                            }
                            return common_1._createRange(row, col, rowCount, colCount);
                        }
                    }
                    return keyword_null;
                },
                _searchSelectedRangebyUpCtrl: function (activeRange, isHomeKey, anchorRow, anchorCol) {
                    var self = this;
                    var activeRangeRow = activeRange.row;
                    var activeRangeCol = activeRange.col;
                    var frozenRowCount = self.frozenRowCount();
                    var firstRow = frozenRowCount ? self._getNextVisualRow(frozenRowCount - 1) : self._getFirstVisualRow();
                    var beginRow = isHomeKey ? firstRow : self._getFirstVisualRow();
                    if (isNullOrUndefined(beginRow)) {
                        return;
                    } else if (frozenRowCount <= 0 || isHomeKey) {
                        self._setTopRow(beginRow);
                    }
                    var extendedRange;
                    var row;
                    var col;
                    var row2;
                    var col2;
                    var rowCount;
                    var colCount;
                    extendedRange = self._getExtendedRange(beginRow, activeRangeCol, anchorRow, anchorCol);
                    row = Math_min(activeRangeRow, extendedRange.row);
                    col = Math_min(activeRangeCol, extendedRange.col);
                    row2 = Math_min(activeRangeRow + getRowCount(activeRange) - 1, extendedRange.row + getRowCount(extendedRange) - 1);
                    col2 = Math_max(activeRangeCol + getColCount(activeRange) - 1, extendedRange.col + getColCount(extendedRange) - 1);
                    rowCount = row2 - row + 1;
                    colCount = col2 - col + 1;
                    return common_1._createRange(row, col, rowCount, colCount);
                },
                _getNewTopRowForSelectByDown: function (row) {
                    var self = this;
                    var scrollByPixel = self.parent && self.parent.options.scrollByPixel;
                    var newRow;
                    var newOffset;
                    if (!scrollByPixel) {
                        newRow = self._getNewTopRow(row, 2);
                        newOffset = 0;
                    } else {
                        var cachePool = self._cachePool;
                        var rowViewportIndex = self._getRowViewportIndex(row);
                        var height = self.getViewportHeight(rowViewportIndex);
                        for (; 0 <= row; row--) {
                            height -= cachePool._getZoomRowHeight(row);
                            if (height < 0) {
                                break;
                            }
                        }
                        newRow = row;
                        newOffset = height;
                    }
                    return {
                        _row: newRow,
                        _offset: newOffset
                    };
                },
                _searchSelectedRangebyDown: function (activeRange, anchorRow, anchorCol) {
                    var self = this;
                    var activeRangeRow = activeRange.row;
                    var activeRangeCol = activeRange.col;
                    var activeRangeRowCount = getRowCount(activeRange);
                    var activeRangeColCount = getColCount(activeRange);
                    var beginRow = activeRangeRow;
                    var endRow = getSheetRowCount(self) - 1;
                    var startPositionCol = getLastVisibleCol(self, activeRangeCol, activeRangeColCount);
                    var extendedRange;
                    var row;
                    var col;
                    var row2;
                    var col2;
                    var rowCount;
                    var colCount;
                    while (beginRow < endRow) {
                        beginRow++;
                        if (!self._canMoveCurrentTo(beginRow, startPositionCol)) {
                            continue;
                        }
                        extendedRange = self._getExtendedRange(beginRow, startPositionCol, anchorRow, anchorCol);
                        row = Math_max(activeRangeRow, extendedRange.row);
                        col = Math_min(activeRangeCol, extendedRange.col);
                        row2 = Math_max(activeRangeRow + activeRangeRowCount - 1, extendedRange.row + getRowCount(extendedRange) - 1);
                        col2 = Math_max(activeRangeCol + activeRangeColCount - 1, extendedRange.col + getColCount(extendedRange) - 1);
                        rowCount = row2 - row + 1;
                        colCount = col2 - col + 1;
                        if (!(row === activeRangeRow && col === activeRangeCol && rowCount === activeRangeRowCount && colCount === activeRangeColCount)) {
                            var pageBottomRow = self._getPageBottomRow();
                            var activeRow = self._activeRowIndex;
                            if (activeRangeRow < activeRow) {
                                if (row >= pageBottomRow) {
                                    var rowInfo = self._getNewTopRowForSelectByDown(row);
                                    self._setTopRow(rowInfo._row, rowInfo._offset);
                                }
                            } else if (activeRangeRow === activeRow && row2 >= pageBottomRow) {
                                var rowInfo = self._getNewTopRowForSelectByDown(row2);
                                self._setTopRow(rowInfo._row, rowInfo._offset);
                            }
                            return common_1._createRange(row, col, rowCount, colCount);
                        }
                    }
                    return keyword_null;
                },
                _searchSelectedRangebyDownCtrl: function (activeRange, isEndKey, anchorRow, anchorCol) {
                    var self = this;
                    var activeRangeRow = activeRange.row;
                    var activeRangeCol = activeRange.col;
                    var newTopRow = self._getLastPageTopRow();
                    if (isNullOrUndefined(newTopRow)) {
                        return;
                    }
                    self._setTopRow(newTopRow);
                    var endRow = self._getLastVisualRow();
                    if (!isEndKey) {
                        endRow += self.frozenTrailingRowCount();
                    }
                    var extendedRange;
                    var row;
                    var col;
                    var row2;
                    var col2;
                    var rowCount;
                    var colCount;
                    extendedRange = self._getExtendedRange(endRow, activeRangeCol, anchorRow, anchorCol);
                    row = Math_max(activeRangeRow, extendedRange.row);
                    col = Math_min(activeRangeCol, extendedRange.col);
                    row2 = Math_max(activeRangeRow + getRowCount(activeRange) - 1, extendedRange.row + getRowCount(extendedRange) - 1);
                    col2 = Math_max(activeRangeCol + getColCount(activeRange) - 1, extendedRange.col + getColCount(extendedRange) - 1);
                    rowCount = row2 - row + 1;
                    colCount = col2 - col + 1;
                    return common_1._createRange(row, col, rowCount, colCount);
                },
                _searchSelectedRangebyHome: function (activeRange, anchorRow, anchorCol) {
                    var self = this;
                    var activeRangeRow = activeRange.row;
                    var activeRangeCol = activeRange.col;
                    var activeRangeRowCount = getRowCount(activeRange);
                    var activeRangeColCount = getColCount(activeRange);
                    var beginCol = self.frozenColumnCount() - 1;
                    var endCol = self._activeColIndex;
                    var startPositionRow = activeRangeRow + activeRangeRowCount - 1;
                    var extendedRange;
                    var row;
                    var col;
                    var row2;
                    var col2;
                    var rowCount;
                    var colCount;
                    while (beginCol < endCol) {
                        beginCol++;
                        if (!self._canMoveCurrentTo(startPositionRow, beginCol)) {
                            continue;
                        }
                        if (activeRangeCol <= beginCol && (activeRangeCol + activeRangeColCount - 1) === self._activeColIndex) {
                            break;
                        }
                        extendedRange = self._getExtendedRange(startPositionRow, beginCol, anchorRow, anchorCol);
                        row = Math_min(activeRangeRow, extendedRange.row);
                        col = Math_min(activeRangeCol, extendedRange.col);
                        row2 = Math_max(activeRangeRow + activeRangeRowCount - 1, extendedRange.row + getRowCount(extendedRange) - 1);
                        col2 = Math_min(activeRangeCol + activeRangeColCount - 1, extendedRange.col + getColCount(extendedRange) - 1);
                        rowCount = row2 - row + 1;
                        colCount = col2 - col + 1;
                        self._setLeftColumn(self._getFirstVisualColumn());
                        return common_1._createRange(row, col, rowCount, colCount);
                    }
                    return keyword_null;
                },
                _searchSelectedRangebyHomeCtrl: function (activeRange, anchorRow, anchorCol) {
                    activeRange = this._searchSelectedRangebyLeftCtrl(activeRange, true, anchorRow, anchorCol);
                    activeRange = this._searchSelectedRangebyUpCtrl(activeRange, true, anchorRow, anchorCol);
                    return activeRange;
                },
                _searchSelectedRangebyEnd: function (activeRange, anchorRow, anchorCol) {
                    var self = this;
                    var activeRangeRow = activeRange.row;
                    var activeRangeCol = activeRange.col;
                    var activeRangeRowCount = getRowCount(activeRange);
                    var activeRangeColCount = getColCount(activeRange);
                    var beginCol = getSheetColumnCount(self);
                    var endCol = self._activeColIndex;
                    var startPositionRow = activeRangeRow + activeRangeRowCount - 1;
                    var extendedRange;
                    var row;
                    var col;
                    var row2;
                    var col2;
                    var rowCount;
                    var colCount;
                    while (beginCol > endCol) {
                        beginCol--;
                        if (!self._canMoveCurrentTo(startPositionRow, beginCol)) {
                            continue;
                        }
                        if (activeRangeCol + activeRangeColCount - 1 >= beginCol && activeRangeCol === self._activeColIndex) {
                            break;
                        }
                        extendedRange = self._getExtendedRange(startPositionRow, beginCol, anchorRow, anchorCol);
                        row = Math_min(activeRangeRow, extendedRange.row);
                        col = Math_max(activeRangeCol, extendedRange.col);
                        row2 = Math_max(activeRangeRow + activeRangeRowCount - 1, extendedRange.row + getRowCount(extendedRange) - 1);
                        col2 = Math_max(activeRangeCol + activeRangeColCount - 1, extendedRange.col + getColCount(extendedRange) - 1);
                        rowCount = row2 - row + 1;
                        colCount = col2 - col + 1;
                        self._setLeftColumn(self._getLastPageLeftColumn());
                        return common_1._createRange(row, col, rowCount, colCount);
                    }
                    return keyword_null;
                },
                _searchSelectedRangebyEndCtrl: function (activeRange, anchorRow, anchorCol) {
                    activeRange = this._searchSelectedRangebyRightCtrl(activeRange, true, anchorRow, anchorCol);
                    activeRange = this._searchSelectedRangebyDownCtrl(activeRange, true, anchorRow, anchorCol);
                    return activeRange;
                },
                _searchSelectedRangebyPageUp: function (activeRange, anchorRow, anchorCol) {
                    var self = this;
                    var activeRangeRow = activeRange.row;
                    var activeRangeCol = activeRange.col;
                    var activeRangeRowCount = getRowCount(activeRange);
                    var prevPageTopRow = self._getPrevPageTopRow();
                    if (isNullOrUndefined(prevPageTopRow)) {
                        return keyword_null;
                    }
                    var rls = self._getRowLayout(1);
                    var scrolled = self._setTopRow(prevPageTopRow);
                    var beginRow = -1;
                    if (scrolled) {
                        beginRow = self._getNextVisualRow(activeRangeRow + activeRangeRowCount - 1 - _ArrayHelper_getLength(rls));
                    } else if (self.frozenRowCount() <= 0) {
                        beginRow = self._getFirstVisualRow();
                    }
                    if (beginRow < self._scrollTopRow) {
                        beginRow = self._scrollTopRow;
                    } else if (beginRow >= self._getPageBottomRow()) {
                        beginRow = self._getPrevVisualRow(self._getPageBottomRow());
                    }
                    var extendedRange;
                    var row;
                    var col;
                    var row2;
                    var col2;
                    var rowCount;
                    var colCount;
                    extendedRange = self._getExtendedRange(beginRow, activeRangeCol, anchorRow, anchorCol);
                    row = Math_min(activeRangeRow, extendedRange.row);
                    col = Math_min(activeRangeCol, extendedRange.col);
                    row2 = Math_min(activeRangeRow + activeRangeRowCount - 1, extendedRange.row + getRowCount(extendedRange) - 1);
                    col2 = Math_max(activeRangeCol + getColCount(activeRange) - 1, extendedRange.col + getColCount(extendedRange) - 1);
                    rowCount = row2 - row + 1;
                    colCount = col2 - col + 1;
                    return common_1._createRange(row, col, rowCount, colCount);
                },
                _searchSelectedRangebyPageDown: function (activeRange, anchorRow, anchorCol) {
                    var self = this;
                    var activeRangeRow = activeRange.row;
                    var activeRangeCol = activeRange.col;
                    var activeRangeRowCount = getRowCount(activeRange);
                    var nextPageTopRow = self._getNextPageTopRow();
                    if (isNullOrUndefined(nextPageTopRow)) {
                        return keyword_null;
                    }
                    var rls = self._getRowLayout(1);
                    self._setTopRow(nextPageTopRow);
                    var beginRow = self._getPrevVisualRow(activeRangeRow + activeRangeRowCount - 1 + _ArrayHelper_getLength(rls));
                    if (beginRow < self._scrollTopRow) {
                        beginRow = self._scrollTopRow;
                    } else if (beginRow >= self._getPageBottomRow()) {
                        if (self._scrollTopRow >= self._getLastPageTopRow()) {
                            beginRow = self._getPageBottomRow();
                        } else {
                            beginRow = self._getPrevVisualRow(self._getPageBottomRow());
                        }
                    }
                    var extendedRange;
                    var row;
                    var col;
                    var row2;
                    var col2;
                    var rowCount;
                    var colCount;
                    extendedRange = self._getExtendedRange(beginRow, activeRangeCol, anchorRow, anchorCol);
                    row = Math_max(activeRangeRow, extendedRange.row);
                    col = Math_min(activeRangeCol, extendedRange.col);
                    row2 = Math_max(activeRangeRow + activeRangeRowCount - 1, extendedRange.row + getRowCount(extendedRange) - 1);
                    col2 = Math_max(activeRangeCol + getColCount(activeRange) - 1, extendedRange.col + getColCount(extendedRange) - 1);
                    rowCount = row2 - row + 1;
                    colCount = col2 - col + 1;
                    return common_1._createRange(row, col, rowCount, colCount);
                },
                _getPrevPageTopRow: function () {
                    var self = this;
                    var rls = self._getRowLayout(1);
                    if (!rls || _ArrayHelper_getLength(rls) <= 0) {
                        return keyword_null;
                    }
                    var frozenRowCount = self.frozenRowCount();
                    var firstRow = frozenRowCount ? self._getNextVisualRow(frozenRowCount - 1) : self._getFirstVisualRow();
                    var h = 0;
                    var r = self._scrollTopRow;
                    var sheetLayout = self._getSheetLayout();
                    while (r > firstRow) {
                        r--;
                        h += self._getZoomRowHeight(r);
                        if (h > self._getActualViewportHeight(sheetLayout)) {
                            break;
                        }
                    }
                    return r;
                },
                _getPrevPageLeftColumn: function () {
                    var self = this;
                    var rls = self._getColumnLayout(1);
                    if (!rls || _ArrayHelper_getLength(rls) <= 0) {
                        return keyword_null;
                    }
                    var frozenColCount = self.frozenColumnCount();
                    var firstColumn = frozenColCount ? self._getNextVisualColumn(frozenColCount - 1) : self._getFirstVisualColumn();
                    var w = 0;
                    var c = self._scrollLeftCol;
                    var sheetLayout = self._getSheetLayout();
                    while (c > firstColumn) {
                        c--;
                        w += self._getZoomColumnWidth(c);
                        if (w > self._getActualViewportWidth(sheetLayout)) {
                            break;
                        }
                    }
                    return c;
                },
                _getNextPageTopRow: function () {
                    var rls = this._getRowLayout(1);
                    var length = _ArrayHelper_getLength(rls);
                    if (rls && length > 0) {
                        var lastRow = rls[length - 1].row;
                        if (this._getLastVisualRow() <= lastRow) {
                            return this._scrollTopRow;
                        }
                        return lastRow;
                    }
                    return keyword_null;
                },
                _getLastPageTopRow: function () {
                    var self = this;
                    if (self._getLastVisualRow() === self._getPageBottomRow()) {
                        var sheetLayout = self._getSheetLayout();
                        var rls = self._getRowLayout(1);
                        var length_1 = _ArrayHelper_getLength(rls);
                        if (rls && length_1 >= 1) {
                            var endRowLayout = rls[length_1 - 1];
                            if (endRowLayout.y + endRowLayout.height <= sheetLayout._viewportY + self._getActualViewportHeight(sheetLayout)) {
                                return self._scrollTopRow;
                            }
                        }
                    }
                    var catchTopRow = self._scrollTopRow;
                    try {
                        self._scrollTopRow = self._getLastVisualRow();
                        var lastPageTopRow = self._getPrevPageTopRow();
                        lastPageTopRow = self._getNextVisualRow(lastPageTopRow);
                        return lastPageTopRow;
                    } catch (e) {

                    } finally {
                        self._scrollTopRow = catchTopRow;
                    }
                },
                _getLastPageLeftColumn: function () {
                    var self = this;
                    var sheetLayout;
                    if (self._getLastVisualColumn() === self._getPageRightColumn()) {
                        sheetLayout = self._getSheetLayout();
                        var rls = self._getColumnLayout(1);
                        var length_2 = _ArrayHelper_getLength(rls);
                        if (rls && length_2 >= 1) {
                            var endColLayout = rls[length_2 - 1];
                            if (endColLayout.x + endColLayout.width <= sheetLayout._viewportX + sheetLayout.width) {
                                return self._scrollLeftCol;
                            }
                        }
                    }
                    sheetLayout = self._getSheetLayout();
                    var width = 0;
                    var col = self._getLastVisualColumn();
                    while (col > 0) {
                        width += self._getZoomColumnWidth(col);
                        if (width > self._getActualViewportWidth(sheetLayout)) {
                            break;
                        }
                        col--;
                    }
                    if (col > 0) {
                        col = self._getNextVisualColumn(col);
                    }
                    return col;
                },
                _getPageBottomRow: function () {
                    var rls = this._getRowLayout(1);
                    var length = _ArrayHelper_getLength(rls);
                    if (rls && length > 0) {
                        return rls[length - 1].row;
                    }
                    return keyword_null;
                },
                _getPageRightColumn: function () {
                    var rls = this._getColumnLayout(1);
                    var length = _ArrayHelper_getLength(rls);
                    if (rls && length > 0) {
                        return rls[length - 1].col;
                    }
                    return keyword_null;
                },
                _getLastFullyVisibleRow: function () {
                    var self = this;
                    var rls = self._getRowLayout(1);
                    var length = _ArrayHelper_getLength(rls);
                    if (rls && length > 0) {
                        var layout = self._getSheetLayout();
                        var i = length - 1;
                        if (rls[i].y + rls[i].height <= layout._viewportY + self._getActualViewportHeight(layout)) {
                            return rls[i].row;
                        }
                        return rls[Math_max(i - 1, 0)].row;
                    }
                    return keyword_null;
                },
                _getLastFullyVisibleColumn: function () {
                    var self = this;
                    var cls = self._getColumnLayout(1);
                    var length = _ArrayHelper_getLength(cls);
                    if (cls && length > 0) {
                        var layout = self._getSheetLayout();
                        var i = length - 1;
                        if (cls[i].x + cls[i].width <= layout._viewportX + self._getActualViewportWidth(layout)) {
                            return cls[i].col;
                        }
                        return cls[Math_max(i - 1, 0)].col;
                    }
                    return keyword_null;
                },
                _getLastVisualRow: function (sheetArea) {
                    if (isNullOrUndefined(sheetArea)) {
                        sheetArea = 3;
                    }
                    var rowCount = getSheetRowCount(this, sheetArea);
                    if (sheetArea === 3 || sheetArea === 2) {
                        rowCount = rowCount - this.frozenTrailingRowCount();
                    }
                    return this._getPrevVisualRow(rowCount, sheetArea);
                },
                _getLastVisualColumn: function (sheetArea) {
                    if (isNullOrUndefined(sheetArea)) {
                        sheetArea = 3;
                    }
                    var colCount = getSheetColumnCount(this, sheetArea);
                    if (sheetArea === 3 || sheetArea === 1) {
                        colCount = colCount - this.frozenTrailingColumnCount();
                    }
                    return this._getPrevVisualColumn(colCount, sheetArea);
                },
                _inflateRangeToCoverSpans: function (spans, cellRange) {
                    if (spans) {
                        for (var i = 0, length_3 = _ArrayHelper_getLength(spans); i < length_3; i++) {
                            var cr = spans[i];
                            if (cellRange.intersect(cr.row, cr.col, getRowCount(cr), getColCount(cr))) {
                                spans.splice(i, 1);
                                i--;
                                return this._inflateRangeToCoverSpans(spans, cellRange.union(cr));
                            }
                        }
                    }
                    return cellRange;
                },
                _getActiveSelectedRange: function (dir) {
                    var self = this;
                    var modelManager = self._modelManager;
                    var selectionModelLength = _ArrayHelper_getLength(modelManager.getSelections());
                    var activeSelectedRange = common_1._createRange(-1, -1, 0, 0);
                    if (selectionModelLength <= 0) {
                        return activeSelectedRange;
                    }
                    var activeSelectedRangeIndex = modelManager.getActiveSelectedRangeIndex();
                    if (dir === 3) {
                        activeSelectedRangeIndex--;
                        if (activeSelectedRangeIndex < 0) {
                            activeSelectedRangeIndex = selectionModelLength - 1;
                        }
                        modelManager.do('setActiveSelectedRangeIndex', activeSelectedRangeIndex);
                    } else if (dir === 4) {
                        activeSelectedRangeIndex++;
                        if (activeSelectedRangeIndex >= selectionModelLength) {
                            activeSelectedRangeIndex = 0;
                        }
                        modelManager.do('setActiveSelectedRangeIndex', activeSelectedRangeIndex);
                    }
                    activeSelectedRangeIndex = modelManager.getActiveSelectedRangeIndex();
                    if (activeSelectedRangeIndex >= 0) {
                        activeSelectedRange = modelManager.getSelections()[activeSelectedRangeIndex];
                    }
                    return activeSelectedRange;
                }
            });
            worksheet_1.Worksheet._registerFeature('selection', {
                init: function () {
                    this._modelManager.do('addSelection', 0, 0, 1, 1);
                    this._modelManager.setCellState(0, 0, core_enum_1.CellStatesType.active, true, core_enum_1.SheetArea.viewport);
                }
            });
        }),
        './dist/core/worksheet/worksheet-sort.js': (function (module, exports, __webpack_require__) {
            Object.defineProperty(exports, '__esModule', { value: true });
            var Common_1 = __webpack_require__(/*! Common */ 'Common');
            var domUtil_1 = __webpack_require__(/*! ../util/domUtil */ './dist/core/util/domUtil.js');
            var util_common = __webpack_require__(/*! ../util/common */ './dist/core/util/common.js');
            var worksheet_1 = __webpack_require__(/*! ./worksheet */ './dist/core/worksheet/worksheet.js');
            var CalcEngine = __webpack_require__(/*! CalcEngine */ 'CalcEngine');
            var _supportsCalc = !!CalcEngine;
            var core_ns_1 = __webpack_require__(/*! ../core.ns */ './dist/core/core.ns.js');
            var rm = new Common_1.Common.ResourceManager(core_ns_1.SR);
            var getSR = rm.getResource.bind(rm);
            var DateTimeHelper_toOADate = Common_1.Common._DateTimeHelper._toOADate;
            var arrayHelper = Common_1.Common._ArrayHelper;
            var isNullOrUndefined = Common_1.Common._Types._isNullOrUndefined;
            var const_boolean = 'boolean';
            var const_string = 'string';
            var const_number = 'number';
            var BACK_COLOR = 'backColor';
            var FONT_COLOR = 'fontColor';
            var keyword_undefined = void 0;
            function getSwapIndex(array, start, index) {
                var t = array[index - start];
                while (t < index) {
                    t = array[t - start];
                }
                return t;
            }
            function formatColor(color, currentTheme) {
                if (typeof color === 'object') {
                    return JSON.stringify(color);
                }
                color = currentTheme.getColor(color);
                return Common_1.Common._ColorHelper._toString(Common_1.Common._ColorHelper._fromString(color));
            }
            function isEquals(v1, v2) {
                if (v1 instanceof Date && v2 instanceof Date) {
                    return DateTimeHelper_toOADate(v1) === DateTimeHelper_toOADate(v2);
                } else if (typeof v1 === const_string && typeof v2 === const_string) {
                    return v1.toLowerCase() === v2.toLowerCase();
                }
                return v1 === v2;
            }
            function colorCompare(sheet, style1, style2, color, isBackColor) {
                var ret;
                var color1;
                var color2;
                var theme = sheet.currentTheme();
                if (!isNullOrUndefined(style1)) {
                    color1 = isBackColor ? style1.backColor : style1.foreColor;
                    if (!isNullOrUndefined(color1)) {
                        color1 = formatColor(color1, theme);
                    }
                }
                if (!isNullOrUndefined(style2)) {
                    color2 = isBackColor ? style2.backColor : style2.foreColor;
                    if (!isNullOrUndefined(color2)) {
                        color2 = formatColor(color2, theme);
                    }
                }
                color1 = color1 || '';
                color2 = color2 || '';
                if (color1 === color2) {
                    ret = 0;
                } else if (color1 === color) {
                    ret = 1;
                } else if (color2 === color) {
                    ret = -1;
                } else {
                    ret = 0;
                }
                return ret;
            }
            function isGreaterThan(v1, v2) {
                if (v1 instanceof Date) {
                    v1 = DateTimeHelper_toOADate(v1);
                }
                if (v2 instanceof Date) {
                    v2 = DateTimeHelper_toOADate(v2);
                }
                var value1Type = typeof v1;
                var value2Type = typeof v2;
                var value1IsSting = value1Type === const_string;
                var value2IsString = value2Type === const_string;
                var value2IsNumber = value2Type === const_number;
                if (value1Type !== value2Type && (value1Type === const_number || value2IsNumber)) {
                    return value2IsNumber;
                }
                if (value1Type === const_boolean && value2IsString) {
                    return true;
                }
                if (value1IsSting && value2Type === const_boolean) {
                    return false;
                }
                if (value1IsSting && value2IsString) {
                    return v1.toLowerCase() > v2.toLowerCase();
                }
                return v1 > v2;
            }
            function sortCompare(x, y, sheet, byRows, sortInfo, cellValueCache) {
                var ret;
                var x_sortInfo = sortInfo;
                var x_index = x;
                var y_index = y;
                if (x_sortInfo) {
                    for (var i = 0; i < x_sortInfo.length; i++) {
                        if (x_sortInfo[i]) {
                            var ascending = x_sortInfo[i].ascending;
                            var index = x_sortInfo[i].index;
                            if (0 <= index) {
                                var value1 = void 0;
                                var value2 = void 0;
                                var row1 = byRows ? x_index : index;
                                var column1 = byRows ? index : x_index;
                                var row2 = byRows ? y_index : index;
                                var column2 = byRows ? index : y_index;
                                if (cellValueCache) {
                                    value1 = cellValueCache[row1][column1];
                                    value2 = cellValueCache[row2][column2];
                                } else {
                                    value1 = sheet.getValue(row1, column1);
                                    value2 = sheet.getValue(row2, column2);
                                }
                                if (x_sortInfo[i].compareFunction) {
                                    ret = x_sortInfo[i].compareFunction(value1, value2);
                                    if (!ascending) {
                                        ret = ret * -1;
                                    }
                                } else if (!isNullOrUndefined(x_sortInfo[i].color)) {
                                    var style1 = void 0;
                                    var style2 = void 0;
                                    style1 = sheet.getActualStyle(row1, column1, 3, false, false, true);
                                    style2 = sheet.getActualStyle(row2, column2, 3, false, false, true);
                                    ret = colorCompare(sheet, style1, style2, x_sortInfo[i].color, x_sortInfo[i].isBackColor);
                                    if (!ascending) {
                                        ret = ret * -1;
                                    }
                                } else {
                                    var value1IsNullOrEmptyOrNaN = isNullOrUndefined(value1) || value1 === '' || (typeof value1 === const_number && isNaN(value1)), value2IsNullOrEmptyOrNaN = isNullOrUndefined(value2) || value2 === '' || (typeof value2 === const_number && isNaN(value2));
                                    if (value1IsNullOrEmptyOrNaN || value2IsNullOrEmptyOrNaN) {
                                        if (value1IsNullOrEmptyOrNaN && value2IsNullOrEmptyOrNaN) {
                                            ret = 0;
                                        } else if (value1IsNullOrEmptyOrNaN && !value2IsNullOrEmptyOrNaN) {
                                            ret = 1;
                                        } else if (!value1IsNullOrEmptyOrNaN && value2IsNullOrEmptyOrNaN) {
                                            ret = -1;
                                        }
                                    } else if (isEquals(value1, value2)) {
                                        ret = 0;
                                    } else if (isGreaterThan(value1, value2)) {
                                        ret = (ascending ? 1 : -1);
                                    } else {
                                        ret = (ascending ? -1 : 1);
                                    }
                                }
                            }
                        }
                        if (ret !== 0) {
                            break;
                        }
                    }
                }
                return ret;
            }
            function quickSortImp(arr, sheet, byRows, sortInfo, cellValueCache) {
                var arrLength = arr.length;
                if (arrLength <= 1) {
                    return arr;
                }
                var pivotIndex = Math.floor(arrLength / 2);
                var pivot = arr[pivotIndex];
                var left = [];
                var right = [];
                var equal = [];
                for (var i = 0; i < arrLength; i++) {
                    if (pivotIndex === i) {
                        equal.push(arr[i]);
                        continue;
                    }
                    var compareResult = sortCompare(arr[i], pivot, sheet, byRows, sortInfo, cellValueCache);
                    if (compareResult < 0) {
                        left.push(arr[i]);
                    } else if (compareResult > 0) {
                        right.push(arr[i]);
                    } else {
                        equal.push(arr[i]);
                    }
                }
                return quickSortImp(left, sheet, byRows, sortInfo, cellValueCache).concat(equal, quickSortImp(right, sheet, byRows, sortInfo, cellValueCache));
            }
            function _removeHidden(sheet, byRows, array) {
                var filterOutRows = [];
                if (byRows) {
                    for (var i = array.length - 1; i >= 0; i--) {
                        var item = array[i];
                        if (sheet.getRowHeight(item) === 0) {
                            array.splice(i, 1);
                            filterOutRows.push({
                                _index: i,
                                _value: item
                            });
                        }
                    }
                } else {
                    for (var i = array.length - 1; i >= 0; i--) {
                        var item = array[i];
                        if (sheet.getColumnWidth(item) === 0) {
                            array.splice(i, 1);
                            filterOutRows.push({
                                _index: i,
                                _value: item
                            });
                        }
                    }
                }
                return filterOutRows;
            }
            function _addHidden(hidden, array) {
                for (var i = hidden.length - 1; i >= 0; i--) {
                    var rowItem = hidden[i];
                    array.splice(rowItem._index, 0, rowItem._value);
                }
            }
            function _flatSort(sheet, row, column, rowCount, columnCount, byRows, sortInfo, sortOption, cellValueCache) {
                var count = byRows ? rowCount : columnCount;
                var startIndex = byRows ? row : column;
                var array = [];
                var temp;
                for (temp = 0; temp < count; temp++) {
                    array[temp] = startIndex + temp;
                }
                var hidden = sortOption.ignoreHidden ? _removeHidden(sheet, byRows, array) : [];
                var tempList = array.concat([]);
                var isChanged = false;
                array = quickSortImp(array, sheet, byRows, sortInfo, cellValueCache);
                for (var k = 0; k < array.length; k++) {
                    if (array[k] !== tempList[k]) {
                        isChanged = true;
                        break;
                    }
                }
                _addHidden(hidden, array);
                return {
                    array: array,
                    isChanged: isChanged
                };
            }
            function _groupSort(sheet, row, column, rowCount, columnCount, byRows, sortInfo, sortOption, cellValueCache) {
                var count = byRows ? rowCount : columnCount;
                var startIndex = byRows ? row : column;
                var outlines = byRows ? sheet.rowOutlines : sheet.columnOutlines;
                var range = outlines._expandGroupForSort(startIndex, count);
                var arrayList = outlines._getSortingItems(range, sortOption.groupSort);
                if (!arrayList) {
                    var temp = [];
                    for (var i = 0; i < count; i++) {
                        temp.push(startIndex + i);
                    }
                    arrayList = [temp];
                }
                for (var i = 0; i < arrayList.length; i++) {
                    arrayList[i] = quickSortImp(arrayList[i], sheet, byRows, sortInfo, cellValueCache);
                }
                var result = outlines._composeSortingResult(arrayList, range, sortOption.groupSort);
                var array = result.array;
                if (result.isChanged) {
                    moveHiddenRow(sheet, byRows, result, array, range, startIndex, count);
                }
                return {
                    array: array,
                    isChanged: result.isChanged
                };
            }
            function moveHiddenRow(sheet, byRows, result, array, range, startIndex, count) {
                var outlines = byRows ? sheet.rowOutlines : sheet.columnOutlines;
                var sizeZero = [];
                var hidden = [];
                if (byRows) {
                    for (var i = startIndex; i < startIndex + count; i++) {
                        if (sheet._isRowFilterOut(i) || (sheet.rowOutlines && sheet.rowOutlines.isCollapsed(i))) {

                        } else if (!sheet.getRowVisible(i, 3, true)) {
                            hidden.push(i);
                            sheet.setRowVisible(i, true);
                        } else if (sheet.getRowHeight(i) === 0) {
                            sizeZero.push(i);
                            sheet.setRowHeight(i, sheet.defaults.rowHeight);
                        }
                    }
                    outlines._moveGroupForSorting(result.groupSwap, result.array, range.start);
                    for (var i = 0; i < hidden.length; i++) {
                        var headIndex = arrayHelper._indexOf(array, hidden[i]) + startIndex;
                        sheet.setRowVisible(headIndex, false);
                    }
                    for (var i = 0; i < sizeZero.length; i++) {
                        var headIndex = arrayHelper._indexOf(array, sizeZero[i]) + startIndex;
                        sheet.setRowHeight(headIndex, 0);
                    }
                } else {
                    for (var i = startIndex; i < startIndex + count; i++) {
                        if (sheet.columnOutlines && sheet.columnOutlines.isCollapsed(i)) {

                        } else if (!sheet.getColumnVisible(i, 3)) {
                            hidden.push(i);
                            sheet.setColumnVisible(i, true);
                        } else if (sheet.getColumnWidth(i) === 0) {
                            sizeZero.push(i);
                            sheet.setColumnWidth(i, sheet.defaults.colWidth);
                        }
                    }
                    outlines._moveGroupForSorting(result.groupSwap, result.array, range.start);
                    for (var i = 0; i < hidden.length; i++) {
                        var headIndex = arrayHelper._indexOf(array, hidden[i]) + startIndex;
                        sheet.setColumnVisible(headIndex, false);
                    }
                    for (var i = 0; i < sizeZero.length; i++) {
                        var headIndex = arrayHelper._indexOf(array, sizeZero[i]) + startIndex;
                        sheet.setColumnWidth(headIndex, 0);
                    }
                }
            }
            function beforeSwapCalcModel(calcModel, row, col) {
                var cellCalc = calcModel._getCellCalc(row, col, false);
                if (cellCalc && cellCalc.hasListeners()) {
                    cellCalc._addListenersToAdjust();
                }
            }
            function afterSwapCalcModel(calcModel, row, col, changeInfo) {
                var SheetsCalc = __webpack_require__(/*! SheetsCalc */ 'SheetsCalc');
                if (SheetsCalc) {
                    var expr = SheetsCalc.CalcOperatorAdjustor._copyExpression(calcModel._source, calcModel._source, calcModel._getExpr(row, col), row, col, 0, 0);
                    calcModel._setExpr(row, col, expr, changeInfo);
                    var cellCalc = calcModel._getCellCalc(row, col, !!expr);
                    if (cellCalc) {
                        cellCalc._startListening();
                    }
                }
            }
            function swapDataImp(sheet, row, column, rowCount, columnCount, byRows, isBindingMode, array, cellValueCache, changedCells, calcModel, sheetSource) {
                var modelrow;
                var modelcol;
                var modelrow2;
                var modelcol2;
                var data1;
                var data2;
                var comment1;
                var comment2;
                var modelManager = sheet._modelManager;
                var comments = modelManager._comments;
                var viewIndex;
                var needComments = comments && comments._commentList.length > 0;
                var outerIndex;
                var outerStartIndex = byRows ? row : column;
                var outerEndIndex = byRows ? row + rowCount : column + columnCount;
                var innerIndex;
                var innerStartIndex = byRows ? column : row;
                var innerEndIndex = byRows ? column + columnCount : row + rowCount;
                for (outerIndex = outerStartIndex; outerIndex < outerEndIndex; outerIndex++) {
                    viewIndex = getSwapIndex(array, outerStartIndex, outerIndex);
                    if (outerIndex === viewIndex) {
                        continue;
                    }
                    if (byRows) {
                        modelrow = outerIndex;
                        modelrow2 = viewIndex;
                    } else {
                        modelcol = outerIndex;
                        modelcol2 = viewIndex;
                    }
                    for (innerIndex = innerStartIndex; innerIndex < innerEndIndex; innerIndex++) {
                        if (byRows) {
                            modelcol = innerIndex;
                            modelcol2 = innerIndex;
                        } else {
                            modelrow = innerIndex;
                            modelrow2 = innerIndex;
                        }
                        if (isBindingMode) {
                            data1 = cellValueCache[modelrow][modelcol];
                            data2 = cellValueCache[modelrow2][modelcol2];
                        }
                        if (needComments) {
                            comment1 = comments.get(modelrow, modelcol);
                            comment2 = comments.get(modelrow2, modelcol2);
                        }
                        if (calcModel && sheetSource) {
                            beforeSwapCalcModel(calcModel, modelrow, modelcol);
                            beforeSwapCalcModel(calcModel, modelrow2, modelcol2);
                            calcModel._swapNode(modelrow, modelcol, modelrow2, modelcol2);
                            afterSwapCalcModel(calcModel, modelrow, modelcol);
                            afterSwapCalcModel(calcModel, modelrow2, modelcol2);
                        }
                        modelManager.do('swapNode', modelrow, modelcol, modelrow2, modelcol2);
                        sheet._validations && sheet._swapValidator(modelrow, modelcol, modelrow2, modelcol2);
                        if (needComments) {
                            comments._swap(comment1, modelrow, modelcol, comment2, modelrow2, modelcol2);
                        }
                        if (isBindingMode) {
                            cellValueCache[modelrow][modelcol] = data2;
                            cellValueCache[modelrow2][modelcol2] = data1;
                        }
                        changedCells.push({
                            row: modelrow,
                            col: modelcol
                        });
                        changedCells.push({
                            row: modelrow2,
                            col: modelcol2
                        });
                    }
                }
            }
            // 交换数据
            function swapData(sheet, isChanged, row, column, rowCount, columnCount, byRows, sortInfo, isBindingMode, array, cellValueCache) {
                var changedCells = [];
                var oldInTransactionValue = sheet._modelManager._inTransaction;
                if (oldInTransactionValue > 0 && isChanged) {
                    sheet._modelManager._inTransaction = 0;
                    [].push.apply(sheet._modelManager._changes, [{
                        row: row,
                        column: column,
                        rowCount: rowCount,
                        columnCount: columnCount,
                        byRows: byRows,
                        sortInfo: sortInfo,
                        type: 'sortRange',
                        array: array.concat([])
                    }]);
                }
                var calcModel = _supportsCalc && sheet._getCalcModel();
                var sheetSource = _supportsCalc && sheet._getSheetSource();
                swapDataImp(sheet, row, column, rowCount, columnCount, byRows, isBindingMode, array, cellValueCache, changedCells, calcModel, sheetSource);
                if (isBindingMode) {
                    for (var rIndex = row; rIndex < row + rowCount; rIndex++) {
                        for (var cIndex = column; cIndex < column + columnCount; cIndex++) {
                            sheet.setValue(rIndex, cIndex, cellValueCache[rIndex][cIndex]);
                        }
                    }
                }
                if (calcModel) {
                    for (var rowIndex = row; rowIndex < row + rowCount; rowIndex++) {
                        for (var colIndex = column; colIndex < column + columnCount; colIndex++) {
                            var expression = calcModel._getExpr(rowIndex, colIndex);
                            if (expression) {
                                calcModel._setExpression(rowIndex, colIndex, expression, keyword_undefined);
                            }
                        }
                    }
                    sheet.getCalcService().recalcRange(sheetSource, row, column, rowCount, columnCount);
                }
                worksheet_1.Worksheet._callFeatureHandler(sheet, 'sortRangeChanged', {
                    column: column,
                    columnCount: columnCount
                });
                if (oldInTransactionValue > 0) {
                    sheet._modelManager._inTransaction = oldInTransactionValue;
                }
                return changedCells;
            }
            function sortImp(sheet, row, column, rowCount, columnCount, byRows, sortInfo, sortOption, undoSortArray, isBindingMode) {
                var changedCells;
                var cellValueCache;
                sheet.suspendPaint();
                sheet.suspendEvent();
                _supportsCalc && sheet.suspendCalcService();
                try {
                    if (isBindingMode) {
                        cellValueCache = [];
                        for (var rIndex = row; rIndex < row + rowCount; rIndex++) {
                            cellValueCache[rIndex] = [];
                            for (var cIndex = column; cIndex < column + columnCount; cIndex++) {
                                cellValueCache[rIndex][cIndex] = sheet.getValue(rIndex, cIndex);
                            }
                        }
                    }
                    var array = void 0;
                    var sortRs = void 0;
                    if (undoSortArray) {
                        array = undoSortArray;
                    } else if (sortOption.groupSort === 0) {
                        sortRs = _flatSort(sheet, row, column, rowCount, columnCount, byRows, sortInfo, sortOption, cellValueCache);
                        array = sortRs.array;
                    } else {
                        sortRs = _groupSort(sheet, row, column, rowCount, columnCount, byRows, sortInfo, sortOption, cellValueCache);
                        array = sortRs.array;
                    }
                    if (array) {
                        changedCells = swapData(sheet, sortRs && sortRs.isChanged, row, column, rowCount, columnCount, byRows, sortInfo, isBindingMode, array, cellValueCache);
                        return true;
                    }
                    return false;
                } finally {
                    _supportsCalc && sheet.resumeCalcService(false);
                    sheet.resumeEvent();
                    sheet.resumePaint();
                    sheet._raiseRangeDataChanged(row, column, rowCount, columnCount, changedCells, 4, keyword_undefined, keyword_undefined, keyword_undefined, !!undoSortArray);
                }
            }
            function sortInfoHandler(sheet, sortInfos) {
                var result = [];
                for (var _i = 0, sortInfos_1 = sortInfos; _i < sortInfos_1.length; _i++) {
                    var sortInfo = sortInfos_1[_i];
                    if (sortInfo.compareFunction) {
                        var item = sortInfo;
                        result.push({
                            index: item.index,
                            ascending: item.ascending,
                            compareFunction: item.compareFunction
                        });
                    } else if (sortInfo.order && sortInfo.hasOwnProperty(BACK_COLOR)) {
                        var item = sortInfo;
                        var ascending = item.order !== 'top';
                        var color = isNullOrUndefined(item.backColor) ? '' : formatColor(item.backColor, sheet.currentTheme());
                        result.push({
                            index: item.index,
                            ascending: ascending,
                            color: color,
                            isBackColor: true,
                        });
                    } else if (sortInfo.order && sortInfo.hasOwnProperty(FONT_COLOR)) {
                        var item = sortInfo;
                        var ascending = item.order !== 'top';
                        var color = isNullOrUndefined(item.fontColor) ? '' : formatColor(item.fontColor, sheet.currentTheme());
                        result.push({
                            index: item.index,
                            ascending: ascending,
                            color: color,
                            isBackColor: false,
                        });
                    } else {
                        if (sortInfo.color) {
                            sortInfo.color = formatColor(sortInfo.color, sheet.currentTheme());
                        }
                        result.push(sortInfo);
                    }
                }
                return result;
            }
            domUtil_1.GC$.extend(worksheet_1.Worksheet.prototype, {
                sortRange: function (row, column, rowCount, columnCount, byRows, sortInfos, sortOption, undoSortArray, isNeedInvalidEvent) {
                    var self = this;
                    var sheetRowCount = self.getRowCount();
                    var sheetColumnCount = self.getColumnCount();
                    if (row === -1) {
                        row = 0;
                    }
                    if (rowCount === -1) {
                        rowCount = sheetRowCount;
                    }
                    if (column === -1) {
                        column = 0;
                    }
                    if (columnCount === -1) {
                        columnCount = sheetColumnCount;
                    }
                    if (row < 0 || row >= sheetRowCount || column < 0 || column >= sheetColumnCount ||
                        rowCount < 0 || row + rowCount > sheetRowCount || columnCount < 0 || column + columnCount > sheetColumnCount || !sortInfos) {
                        return false;
                    }
                    sortOption = self._getSortOption(util_common._createRange(row, column, rowCount, columnCount), byRows, sortOption);
                    var count = byRows ? rowCount : columnCount;
                    var startIndex = byRows ? row : column;
                    var outlines = byRows ? self.rowOutlines : self.columnOutlines;
                    if (!undoSortArray && sortOption.groupSort > 0) {
                        if (!outlines) {
                            return false;
                        }
                        var range = outlines._expandGroupForSort(startIndex, count);
                        if (byRows) {
                            rowCount = range.count;
                            row = range.start;
                        } else {
                            columnCount = range.count;
                            column = range.start;
                        }
                    }
                    if (_supportsCalc && !self._checkArrayFormula(row, column, rowCount, columnCount, false)) {
                        if (isNeedInvalidEvent) {
                            self._raiseInvalidOperation(7, getSR().Exp_InvalidSortArrayFormulaInRange);
                        }
                        return false;
                    }
                    var spans = self._modelManager.getSpans(util_common._createRange(row, column, rowCount, columnCount));
                    if (spans && spans.length > 0) {
                        if (isNeedInvalidEvent) {
                            self._raiseInvalidOperation(7, getSR().Exp_InvalidSortSpanInRange);
                        }
                        return false;
                    }
                    var tableManager = self.tables;
                    var tableArray;
                    var hasOneWholeTable;
                    if (tableManager) {
                        tableArray = tableManager._findByRange(row, column, rowCount, columnCount);
                        hasOneWholeTable = tableArray.length === 1 && tableArray[0].dataRange().equals(util_common._createRange(row, column, rowCount, columnCount));
                        if (!(tableArray.length <= 0 || hasOneWholeTable)) {
                            if (isNeedInvalidEvent) {
                                self._raiseInvalidOperation(7, getSR().Exp_InvalidSortPartTableOrMultiTableInRange);
                            }
                            return false;
                        }
                    }
                    var bm = self._bindingManager;
                    var isBindingMode = (bm && bm._dataSource) || (hasOneWholeTable && tableArray[0] && tableArray[0]._getDataSource());
                    var result = sortImp(self, row, column, rowCount, columnCount, byRows, sortInfoHandler(self, sortInfos), sortOption, undoSortArray, isBindingMode);
                    result && sortOption.groupSort !== 0 && self._rowFilter && self._rowFilter.reFilter();
                    return result;
                },
                _getSortOption: function (range, byRows, sortOption) {
                    var self = this;
                    var actualRange = self._getActualRange(range);
                    var count = byRows ? actualRange.rowCount : actualRange.colCount;
                    var startIndex = byRows ? actualRange.row : actualRange.col;
                    var outlines = byRows ? self.rowOutlines : self.columnOutlines;
                    if (isNullOrUndefined(sortOption)) {
                        sortOption = {};
                    }
                    if (self.outlineColumn && self.outlineColumn._hasOutlineColumn() && byRows) {
                        var outlineColumnIndex = self.outlineColumn._outlineColumnOptions.columnIndex;
                        if (!(actualRange.col <= outlineColumnIndex && outlineColumnIndex <= actualRange.col + actualRange.colCount)) {
                            sortOption.groupSort = 0;
                        }
                    }
                    if (isNullOrUndefined(sortOption.groupSort)) {
                        if (isNullOrUndefined(sortOption.ignoreHidden)) {
                            sortOption.groupSort = outlines && outlines._containsGroup(startIndex, count) ? 1 : 0;
                        } else {
                            sortOption.groupSort = 0;
                        }
                    }
                    if (sortOption.groupSort === 0) {
                        sortOption.ignoreHidden = isNullOrUndefined(sortOption.ignoreHidden) ? true : sortOption.ignoreHidden;
                    } else {
                        sortOption.ignoreHidden = false;
                    }
                    return sortOption;
                },
                _canDoSort: function () {
                    var options = this.options;
                    return !options.isProtected || options.protectionOptions.allowSort;
                },
                _swapValidator: function (fromRow, fromCol, toRow, toCol) {
                    var self = this;
                    var validator1 = self.getDataValidator(fromRow, fromCol);
                    var validator2 = self.getDataValidator(toRow, toCol);
                    self.setDataValidator(fromRow, fromCol, validator2);
                    self.setDataValidator(toRow, toCol, validator1);
                }
            });

        }),
        './dist/core/worksheet/worksheet-static.js': (function (module, exports, __webpack_require__) {
            Object.defineProperty(exports, '__esModule', { value: true });
            var core_ns_1 = __webpack_require__(/*! ../core.ns */ './dist/core/core.ns.js');
            var common_1 = __webpack_require__(/*! ../util/common */ './dist/core/util/common.js');
            var Common_1 = __webpack_require__(/*! Common */ 'Common');
            var CalcEngine = __webpack_require__(/*! CalcEngine */ 'CalcEngine');
            var _supportsCalc = !!CalcEngine;
            var domUtil_1 = __webpack_require__(/*! ../util/domUtil */ './dist/core/util/domUtil.js');
            var isNullOrUndefined = Common_1.Common._Types._isNullOrUndefined;
            var $_each = domUtil_1.GC$.each;
            var keyword_null = null, keyword_undefined = void 0, Math_min = Math.min, Math_max = Math.max;
            var rm = new Common_1.Common.ResourceManager(core_ns_1.SR);
            var getSR = rm.getResource.bind(rm);
            function _getRowCount(sheet, sheetArea) {
                return sheet.getRowCount(sheetArea);
            }
            function _getColumnCount(sheet, sheetArea) {
                return sheet.getColumnCount(sheetArea);
            }
            function getActualColumnWidth(sheet, col, sheetArea) {
                return sheet._getActualColumnWidth(col, sheetArea);
            }
            function getActualRowHeight(sheet, row, sheetArea) {
                return sheet._getActualRowHeight(row, sheetArea);
            }
            function setColumnWidth(sheet, col, width, sheetArea) {
                sheet.setColumnWidth(col, width, sheetArea);
            }
            function setRowHeight(sheet, row, height, sheetArea) {
                sheet.setRowHeight(row, height, sheetArea);
            }
            function getActualStyle(sheet, row, col, sheetArea, ignoreSheet) {
                return sheet.getActualStyle(row, col, sheetArea, keyword_undefined, keyword_undefined, keyword_undefined, ignoreSheet);
            }
            function getDefaultStyle(sheet, sheetArea) {
                return sheet.getDefaultStyle(sheetArea);
            }
            function setDefaultStyle(sheet, style, sheetArea) {
                sheet.setDefaultStyle(style, sheetArea);
            }
            function setStyleWithoutLocked(sheet, row, col, style, sheetArea) {
                sheet._setStyleWithoutLocked(row, col, style, sheetArea);
            }
            function raiseInvalidRangeException(item, value, start, end) {
                throw new Error(Common_1.Common._StringHelper._format(getSR().Exp_InvalidAndSpace, [item, value, start, end]));
            }
            function isRowFilterOut(row, ignoreFilteredOutRow, sheet) {
                return (ignoreFilteredOutRow && sheet._isRowFilterOut && sheet._isRowFilterOut(row));
            }
            function checkArguments(src, fromRow, fromColumn, dest, toRow, toColumn, rowCount, columnCount, isMove) {
                if (!src) {
                    throw new Error(getSR().Exp_SrcIsNull);
                }
                if (!dest) {
                    throw new Error(getSR().Exp_DestIsNull);
                }
                var srcRowCount = _getRowCount(src);
                var srcColumnCount = _getColumnCount(src);
                var destRowCount = _getRowCount(dest);
                var destColumnCount = _getColumnCount(dest);
                if (fromRow < -1 || fromRow >= srcRowCount) {
                    raiseInvalidRangeException('from row index', fromRow, '-1', (srcRowCount - 1));
                }
                if (fromColumn < -1 || fromColumn >= srcColumnCount) {
                    raiseInvalidRangeException('from column index', fromColumn, '-1', (srcColumnCount - 1));
                }
                if (toRow < -1 || toRow >= destRowCount) {
                    raiseInvalidRangeException('to row index', toRow, '-1', (destRowCount - 1));
                }
                if (toColumn < -1 || toColumn >= destColumnCount) {
                    raiseInvalidRangeException('to column index', toColumn, '-1', (destColumnCount - 1));
                }
                var fromColumn2 = fromColumn;
                if (fromColumn < 0) {
                    fromColumn2 = 0;
                    columnCount = srcColumnCount;
                }
                var toColumn2 = toColumn < 0 ? 0 : toColumn;
                if (columnCount < 1 || fromColumn2 + columnCount > srcColumnCount || toColumn2 + columnCount > destColumnCount) {
                    raiseInvalidRangeException('column count', columnCount, '1', Math_min(srcColumnCount - fromColumn2, destColumnCount - toColumn2));
                }
                var fromRow2 = fromRow;
                if (fromRow < 0) {
                    fromRow2 = 0;
                    rowCount = srcRowCount;
                }
                var toRow2 = toRow < 0 ? 0 : toRow;
                if (rowCount < 1 || fromRow2 + rowCount > srcRowCount || toRow2 + rowCount > destRowCount) {
                    raiseInvalidRangeException('row count', rowCount, '1', Math_min(srcRowCount - fromRow2, destRowCount - toRow2));
                }
            }
            function cloneObject(obj) {
                if (!obj) {
                    return obj;
                }
                if (typeof (obj) === 'number' || typeof (obj) === 'string' || typeof (obj) === 'boolean' || isNullOrUndefined(obj)) {
                    return obj;
                } else if (obj.clone) {
                    return obj.clone();
                } else if (obj instanceof Date) {
                    return new Date(obj.valueOf());
                }
                var objClone;
                var key;
                var value;
                if (obj instanceof Object) {
                    objClone = new obj.constructor();
                } else {
                    objClone = new obj.constructor(obj.valueOf());
                }
                for (key in obj) {
                    if (obj.hasOwnProperty(key)) {
                        value = obj[key];
                        if (obj.hasOwnProperty(key) && objClone[key] !== value) {
                            if (typeof (value) === 'object') {
                                objClone[key] = cloneObject(value);
                            } else {
                                objClone[key] = value;
                            }
                        }
                    }
                }
                objClone.toString = obj.toString;
                objClone.valueOf = obj.valueOf;
                return objClone;
            }
            function crossSheetCopySpans(srcModelManager, fromRow, fromColumn, destModelManager, toRow, toColumn, rowCount, columnCount, sheetArea) {
                var srcSpans = srcModelManager.getSpans(keyword_undefined, sheetArea);
                var destSpans = destModelManager.getSpans(keyword_undefined, sheetArea);
                var addList = [];
                var i;
                var cs;
                var cs_row;
                var cs_col;
                var cs_rowCount;
                var cs_colCount;
                if (srcSpans) {
                    for (i = 0; i < srcSpans.length; i++) {
                        cs = srcSpans[i];
                        cs_row = cs.row;
                        cs_col = cs.col;
                        cs_rowCount = cs.rowCount;
                        cs_colCount = cs.colCount;
                        if (fromRow === -1) {
                            if (fromColumn <= cs_col && cs_col + cs_colCount <= fromColumn + columnCount) {
                                addList.push(common_1._createRange(cs_row, toColumn + cs_col - fromColumn, cs_rowCount, cs_colCount));
                            }
                        } else if (fromColumn === -1) {
                            if (fromRow <= cs_row && cs_row + cs_rowCount <= fromRow + rowCount) {
                                addList.push(common_1._createRange(toRow + cs_row - fromRow, cs_col, cs_rowCount, cs_colCount));
                            }
                        } else if (fromRow <= cs_row && cs_row < fromRow + rowCount && fromColumn <= cs_col && cs_col < fromColumn + columnCount) {
                            addList.push(common_1._createRange(toRow + cs_row - fromRow, toColumn + cs_col - fromColumn, cs_rowCount, cs_colCount));
                        }
                    }
                }
                if (destSpans) {
                    for (i = 0; i < destSpans.length; i++) {
                        cs = destSpans[i];
                        cs_row = cs.row;
                        cs_col = cs.col;
                        var contains = void 0;
                        var containsCol = cs_col >= toColumn && cs_col < toColumn + columnCount;
                        var containsRow = cs_row >= toRow && cs_row < toRow + rowCount;
                        if (fromRow === -1) {
                            contains = containsCol;
                        } else if (fromColumn === -1) {
                            contains = containsRow;
                        } else {
                            contains = containsRow && containsCol;
                        }
                        if (contains) {
                            var cellSpan = destModelManager.findSpan(cs_row, cs_col, sheetArea);
                            if (cellSpan && cellSpan.row === cs_row && cellSpan.col === cs_col) {
                                destModelManager.do('removeSpan', cellSpan, sheetArea);
                            }
                        }
                    }
                }
                for (i = 0; i < addList.length; i++) {
                    destModelManager.do('addSpan', addList[i], sheetArea);
                }
            }
            function copyOrMoveConditionalFormat(src, fromRow, fromColumn, dest, toRow, toColumn, rowCount, columnCount, isMove, ignorePasteSkipInvisibleRange) {
                var cf = src.conditionalFormats;
                var destCf = dest.conditionalFormats;
                var sameSheet = isSameSheet(src, dest);
                if (cf && destCf && !src._fromTable) {
                    var destRanges = cf._copyRules(fromRow, fromColumn, destCf, toRow, toColumn, rowCount, columnCount, sameSheet, ignorePasteSkipInvisibleRange);
                    if (isMove) {
                        cf._onRulesMoved(fromRow, fromColumn, rowCount, columnCount, destRanges, sameSheet);
                    }
                }
            }
            function copyOrMoveSparkline(src, fromRow, fromColumn, dest, toRow, toColumn, rowCount, columnCount, isMove, ignorePasteSkipInvisibleRange) {
                if (fromRow < 0) {
                    fromRow = 0;
                    rowCount = Math_min(_getRowCount(src), _getRowCount(dest));
                }
                if (toRow < 0) {
                    toRow = 0;
                }
                if (fromColumn < 0) {
                    fromColumn = 0;
                    columnCount = Math_min(_getColumnCount(src), _getColumnCount(dest));
                }
                if (toColumn < 0) {
                    toColumn = 0;
                }
                var crossSheet = !(src === dest && src.name() === dest.name());
                var sparkline;
                if (crossSheet) {
                    sparkline = dest._sparklineGroupManager;
                    if (sparkline) {
                        if (isMove) {
                            if (src._sparklineGroupManager.count() > 0) {
                                sparkline._exMove(src, fromRow, fromColumn, toRow, toColumn, rowCount, columnCount);
                            }
                        } else {
                            sparkline._exCopy(src, fromRow, fromColumn, toRow, toColumn, rowCount, columnCount, keyword_undefined, ignorePasteSkipInvisibleRange);
                        }
                    }
                } else {
                    sparkline = src._sparklineGroupManager;
                    if (sparkline) {
                        if (isMove) {
                            if (sparkline.count() > 0) {
                                sparkline._move(fromRow, fromColumn, toRow, toColumn, rowCount, columnCount);
                            }
                        } else {
                            sparkline._copy(fromRow, fromColumn, toRow, toColumn, rowCount, columnCount, keyword_undefined, ignorePasteSkipInvisibleRange);
                        }
                    }
                }
            }
            function copyOrMoveColumnRangeGroup(src, fromColumn, dest, toColumn, columnCount, isMove) {
                if (fromColumn < 0) {
                    fromColumn = 0;
                    columnCount = Math_min(_getColumnCount(src), _getColumnCount(dest));
                }
                if (toColumn < 0) {
                    toColumn = 0;
                }
                var src_columnOutlines = src.columnOutlines;
                var dest_columnOutlines = dest.columnOutlines;
                var crossSheet = !(src === dest && src.name() === dest.name());
                if (crossSheet) {
                    if (src_columnOutlines && dest_columnOutlines) {
                        dest_columnOutlines._exMoveOrCopy(src_columnOutlines, fromColumn, toColumn, columnCount, isMove);
                    }
                } else if (src_columnOutlines) {
                    src_columnOutlines._moveOrCopy(fromColumn, toColumn, columnCount, isMove);
                }
            }
            function copyOrMoveRowRangeGroup(src, fromRow, dest, toRow, rowCount, isMove) {
                if (fromRow < 0) {
                    fromRow = 0;
                    rowCount = Math_min(_getRowCount(src), _getRowCount(dest));
                }
                if (toRow < 0) {
                    toRow = 0;
                }
                var crossSheet = !(src === dest && src.name() === dest.name());
                var src_rowOutlines = src.rowOutlines;
                var dest_rowOutlines = dest.rowOutlines;
                if (crossSheet) {
                    if (src_rowOutlines && dest_rowOutlines) {
                        dest_rowOutlines._exMoveOrCopy(src_rowOutlines, fromRow, toRow, rowCount, isMove);
                    }
                } else if (src_rowOutlines) {
                    src_rowOutlines._moveOrCopy(fromRow, toRow, rowCount, isMove);
                }
            }
            function copyOrMoveSpanImp(src, fromRow, fromColumn, dest, toRow, toColumn, rowCount, columnCount, isMove, sheetArea) {
                var crossSheet = !(src === dest && src.name() === dest.name());
                var modelManager = src._modelManager;
                var srcSpanModel = modelManager._getSpanModel(sheetArea);
                if (crossSheet) {
                    crossSheetCopySpans(modelManager, fromRow, fromColumn, dest._modelManager, toRow, toColumn, rowCount, columnCount, sheetArea);
                    if (isMove && srcSpanModel) {
                        modelManager.do('clearSpan', fromRow, fromColumn, rowCount, columnCount, sheetArea);
                    }
                } else if (isMove) {
                    modelManager.do('moveSpan', fromRow, fromColumn, toRow, toColumn, rowCount, columnCount, sheetArea);
                } else {
                    modelManager.do('copySpan', fromRow, fromColumn, toRow, toColumn, rowCount, columnCount, sheetArea);
                }
            }
            function copyOrMoveSpan(src, srcRow, srcColumn, dest, toRow, toColumn, rowCount, columnCount, isMove) {
                var fromRow = srcRow;
                var fromColumn = srcColumn;
                if (fromRow < 0) {
                    fromRow = 0;
                    rowCount = Math_min(_getRowCount(src), _getRowCount(dest));
                }
                if (toRow < 0) {
                    toRow = 0;
                }
                if (fromColumn < 0) {
                    fromColumn = 0;
                    columnCount = Math_min(_getColumnCount(src), _getColumnCount(dest));
                }
                if (toColumn < 0) {
                    toColumn = 0;
                }
                if (srcRow < 0) {
                    copyOrMoveSpanImp(src, -1, fromColumn, dest, -1, toColumn, -1, columnCount, isMove, 1);
                }
                if (srcColumn < 0) {
                    copyOrMoveSpanImp(src, fromRow, -1, dest, toRow, -1, rowCount, -1, isMove, 2);
                }
                copyOrMoveSpanImp(src, fromRow, fromColumn, dest, toRow, toColumn, rowCount, columnCount, isMove);
            }
            function copyOrMoveColumnAxis(src, fromColumn, dest, toColumn, columnCount, option, isMove, ignorePasteSkipInvisibleRange, ignoreSheet) {
                if (fromColumn < 0) {
                    fromColumn = 0;
                    columnCount = Math_min(_getColumnCount(src), _getColumnCount(dest));
                }
                if (toColumn < 0) {
                    toColumn = 0;
                }
                var pasteSkipInvisibleRange = !ignorePasteSkipInvisibleRange && dest._getPasteSkipInvisibleRange();
                var colHeader = 1;
                var columnDataArray = [];
                for (var c = 0, fromColumnIndex = 0; c < columnCount && c < _getColumnCount(dest, colHeader); c++) {
                    if (pasteSkipInvisibleRange && (dest.getColumnWidth(toColumn + c) === 0)) {
                        columnCount++;
                        continue;
                    }
                    var columnData = {};
                    if ((option & 64) > 0) {
                        var width = getActualColumnWidth(src, fromColumnIndex + fromColumn);
                        if (!isNullOrUndefined(width)) {
                            columnData.size = width;
                            if (isMove) {
                                setColumnWidth(src, c + fromColumn, src.defaults.colWidth);
                            }
                        }
                        var visible = src.getColumnVisible(fromColumnIndex + fromColumn);
                        if (!isNullOrUndefined(visible)) {
                            columnData.visible = visible;
                            if (isMove) {
                                src.setColumnVisible(c + fromColumn, true);
                            }
                        }
                        var style = getActualStyle(src, -1, fromColumnIndex + fromColumn, keyword_undefined, ignoreSheet);
                        columnData.style = style;
                        if (isMove) {
                            setStyleWithoutLocked(src, -1, c + fromColumn, keyword_null);
                        }
                        style = getActualStyle(src, -1, fromColumnIndex + fromColumn, colHeader, ignoreSheet);
                        columnData.headerStyle = style;
                        if (isMove) {
                            setStyleWithoutLocked(src, -1, c + fromColumn, keyword_null, colHeader);
                        }
                    }
                    if ((option & 128) > 0) {
                        var tag = src.getTag(-1, fromColumnIndex + fromColumn);
                        if (!isNullOrUndefined(tag)) {
                            columnData.tag = tag;
                            if (isMove) {
                                src.setTag(-1, c + fromColumn, keyword_undefined);
                            }
                        }
                    }
                    columnDataArray[fromColumnIndex + fromColumn] = columnData;
                    fromColumnIndex++;
                }
                for (var c = 0, fromColumnIndex = 0; c < columnCount && c < _getColumnCount(dest, colHeader); c++) {
                    if (pasteSkipInvisibleRange && (dest.getColumnWidth(toColumn + c) === 0)) {
                        columnCount++;
                        continue;
                    }
                    var columnData = columnDataArray[fromColumnIndex + fromColumn];
                    if ((option & 64) > 0) {
                        var width = columnData.size;
                        if (!isNullOrUndefined(width)) {
                            setColumnWidth(dest, c + toColumn, width);
                        }
                        var visible = columnData.visible;
                        if (!isNullOrUndefined(visible)) {
                            dest.setColumnVisible(c + toColumn, visible);
                        }
                        var style = columnData.style;
                        if (!style) {
                            setStyleWithoutLocked(dest, -1, c + toColumn, keyword_null);
                        } else {
                            setStyleWithoutLocked(dest, -1, c + toColumn, style.clone());
                        }
                        style = columnData.headerStyle;
                        if (!style) {
                            setStyleWithoutLocked(dest, -1, c + toColumn, keyword_null, colHeader);
                        } else {
                            setStyleWithoutLocked(dest, -1, c + toColumn, style.clone(), colHeader);
                        }
                    }
                    if ((option & 128) > 0) {
                        var tag = columnData.tag;
                        if (!isNullOrUndefined(tag)) {
                            dest.setTag(-1, c + toColumn, tag);
                        }
                    }
                    fromColumnIndex++;
                }
                var destColHeaderRowCount = _getRowCount(dest, colHeader);
                var colHeaderRowCount = Math_min(_getRowCount(src, colHeader), destColHeaderRowCount);
                for (var r = 0, fromRowIndex = 0; r < colHeaderRowCount && r < destColHeaderRowCount; r++) {
                    if (pasteSkipInvisibleRange && (dest.getRowHeight(r, colHeader) === 0)) {
                        colHeaderRowCount++;
                        continue;
                    }
                    var height = getActualRowHeight(src, fromRowIndex, colHeader);
                    if (!isNullOrUndefined(height)) {
                        if (isMove) {
                            setRowHeight(src, r, src.defaults.colHeaderRowHeight, colHeader);
                        }
                        setRowHeight(dest, r, height, colHeader);
                    }
                    fromRowIndex++;
                }
            }
            function copyOrMoveRowAxis(src, fromRow, dest, toRow, rowCount, option, ignoreFilteredOutRow, isMove, ignorePasteSkipInvisibleRange, ignoreSheet) {
                if (fromRow < 0) {
                    fromRow = 0;
                    rowCount = Math_min(_getRowCount(src), _getRowCount(dest));
                }
                if (toRow < 0) {
                    toRow = 0;
                }
                var pasteSkipInvisibleRange = !ignorePasteSkipInvisibleRange && dest._getPasteSkipInvisibleRange();
                var rowHeader = 2;
                var rowDataArray = [];
                for (var r = 0, fromRowIndex = 0; r < rowCount && (toRow + r < _getRowCount(dest, rowHeader)); r++) {
                    if (pasteSkipInvisibleRange && (dest.getRowHeight(toRow + r) === 0)) {
                        rowCount++;
                        continue;
                    }
                    if (!isMove && isRowFilterOut(toRow + r, ignoreFilteredOutRow, dest)) {
                        fromRowIndex++;
                        continue;
                    }
                    var rowData = {};
                    if ((option & 64) > 0) {
                        var height = getActualRowHeight(src, fromRowIndex + fromRow);
                        if (!isNullOrUndefined(height)) {
                            rowData.size = height;
                            if (isMove) {
                                setRowHeight(src, r + fromRow, src.defaults.rowHeight);
                            }
                        }
                        var visible = src.getRowVisible(fromRowIndex + fromRow);
                        if (!isNullOrUndefined(visible)) {
                            rowData.visible = visible;
                            if (isMove) {
                                src.setRowVisible(r + fromRow, true);
                            }
                        }
                        var style = getActualStyle(src, fromRowIndex + fromRow, -1, keyword_undefined, ignoreSheet);
                        rowData.style = style;
                        if (isMove) {
                            setStyleWithoutLocked(src, r + fromRow, -1, keyword_null);
                        }
                        style = getActualStyle(src, fromRowIndex + fromRow, -1, rowHeader, ignoreSheet);
                        rowData.headerStyle = style;
                        if (isMove) {
                            setStyleWithoutLocked(src, r + fromRow, -1, keyword_null, rowHeader);
                        }
                    }
                    if ((option & 128) > 0) {
                        var tag = src.getTag(fromRowIndex + fromRow, -1);
                        if (!isNullOrUndefined(tag)) {
                            rowData.tag = tag;
                            if (isMove) {
                                src.setTag(r + fromRow, -1, keyword_undefined);
                            }
                        }
                    }
                    rowDataArray[fromRowIndex + fromRow] = rowData;
                    fromRowIndex++;
                }
                for (var r = 0, fromRowIndex = 0; r < rowCount && (toRow + r < _getRowCount(dest, rowHeader)); r++) {
                    if (pasteSkipInvisibleRange && (dest.getRowHeight(toRow + r) === 0)) {
                        rowCount++;
                        continue;
                    }
                    if (!isMove && isRowFilterOut(toRow + r, ignoreFilteredOutRow, dest)) {
                        fromRowIndex++;
                        continue;
                    }
                    var rowData = rowDataArray[fromRowIndex + fromRow];
                    if ((option & 64) > 0) {
                        var height = rowData.size;
                        if (!isNullOrUndefined(height)) {
                            setRowHeight(dest, r + toRow, height);
                        }
                        var visible = rowData.visible;
                        if (!isNullOrUndefined(visible)) {
                            dest.setRowVisible(r + toRow, visible);
                        }
                        var style = rowData.style;
                        if (!style) {
                            setStyleWithoutLocked(dest, r + toRow, -1, keyword_null);
                        } else {
                            setStyleWithoutLocked(dest, r + toRow, -1, style.clone());
                        }
                        style = rowData.headerStyle;
                        if (!style) {
                            setStyleWithoutLocked(dest, r + toRow, -1, keyword_null, rowHeader);
                        } else {
                            setStyleWithoutLocked(dest, r + toRow, -1, style.clone(), rowHeader);
                        }
                    }
                    if ((option & 128) > 0) {
                        var tag = rowData.tag;
                        if (!isNullOrUndefined(tag)) {
                            dest.setTag(r + toRow, -1, tag);
                        }
                    }
                    fromRowIndex++;
                }
                var destRowHeaderColCount = _getColumnCount(dest, rowHeader);
                var rowHeaderColCount = Math_min(_getColumnCount(src, rowHeader), destRowHeaderColCount);
                for (var c = 0, fromColumnIndex = 0; c < rowHeaderColCount && c < destRowHeaderColCount; c++) {
                    if (pasteSkipInvisibleRange && (dest.getColumnWidth(c, rowHeader) === 0)) {
                        rowHeaderColCount++;
                        continue;
                    }
                    var width = getActualColumnWidth(src, fromColumnIndex, rowHeader);
                    if (!isNullOrUndefined(width)) {
                        if (isMove) {
                            setColumnWidth(src, c, src.defaults.rowHeaderColWidth, rowHeader);
                        }
                        setColumnWidth(dest, c, width, rowHeader);
                    }
                    fromColumnIndex++;
                }
            }
            function copyOrMoveSheetInfo(src, dest, option, isMove) {
                if ((src !== dest) || (src.name() !== dest.name())) {
                    if ((option & 64) > 0) {
                        var style = getDefaultStyle(src);
                        setDefaultStyle(dest, isMove ? style : style.clone());
                        style = getDefaultStyle(src, 1);
                        setDefaultStyle(dest, isMove ? style : style.clone(), 1);
                        style = getDefaultStyle(src, 2);
                        setDefaultStyle(dest, isMove ? style : style.clone(), 2);
                        if (isMove) {
                            setDefaultStyle(src, keyword_null);
                            setDefaultStyle(src, keyword_null, 1);
                            setDefaultStyle(src, keyword_null, 2);
                        }
                    }
                    var dest_defaults = dest.defaults, src_defaults = src.defaults;
                    dest_defaults.colWidth = src_defaults.colWidth;
                    dest_defaults.rowHeight = src_defaults.rowHeight;
                    dest_defaults.rowHeaderColWidth = src_defaults.rowHeaderColWidth;
                    dest_defaults.colHeaderRowHeight = src_defaults.colHeaderRowHeight;
                    if (isMove) {
                        src_defaults.colWidth = 62;
                        src_defaults.rowHeight = 20;
                        src_defaults.rowHeaderColWidth = 40;
                        src_defaults.colHeaderRowHeight = 20;
                    }
                }
            }
            function copyProperty(src, srcRow, srcColumn, dest, destRow, destColumn, copyRowCount, copyColumnCount, ignoreFilteredOutRow, copyPasteHeaders, getCallback, setCallback, ignorePasteSkipInvisibleRange) {
                var crossSheet = !(src === dest && src.name() === dest.name());
                var pasteSkipInvisibleRange = !ignorePasteSkipInvisibleRange && dest._getPasteSkipInvisibleRange();
                var hRowCount;
                var hColumnCount;
                var r;
                var c;
                var savedModel;
                var result;
                var fromRowIndex;
                var fromColumnIndex;
                if (((copyPasteHeaders & 2) === 2) && srcRow < 0) {
                    var fColumn = srcColumn;
                    var tColumn = destColumn;
                    hRowCount = Math_min(_getRowCount(src, 1), _getRowCount(dest, 1));
                    hColumnCount = copyColumnCount;
                    if (srcColumn < 0) {
                        fColumn = 0;
                        hColumnCount = _getColumnCount(src);
                    }
                    if (destColumn < 0) {
                        tColumn = 0;
                    }
                    var hOldColumnCount = hColumnCount;
                    if (crossSheet) {
                        for (r = 0, fromRowIndex = 0; r < hRowCount && r < _getRowCount(dest, 1); r++) {
                            if (pasteSkipInvisibleRange && (dest.getRowHeight(r, 1) === 0)) {
                                hRowCount++;
                                continue;
                            }
                            for (c = 0, fromColumnIndex = 0, hColumnCount = hOldColumnCount; c < hColumnCount && c < _getColumnCount(dest, 1); c++) {
                                if (pasteSkipInvisibleRange && (dest.getColumnWidth(tColumn + c, 1) === 0)) {
                                    hColumnCount++;
                                    continue;
                                }
                                result = getCallback(src, fromRowIndex, fColumn + fromColumnIndex, 1);
                                setCallback(dest, r, tColumn + c, cloneObject(result), 1);
                                fromColumnIndex++;
                            }
                            fromRowIndex++;
                        }
                    } else {
                        savedModel = new common_1._SparseArray();
                        for (r = 0; r < hRowCount; r++) {
                            for (c = 0; c < hColumnCount; c++) {
                                result = getCallback(src, r, fColumn + c, 1);
                                if (!isNullOrUndefined(result)) {
                                    savedModel.set(r, c, cloneObject(result));
                                }
                            }
                        }
                        for (r = 0, fromRowIndex = 0; r < hRowCount && r < _getRowCount(dest, 1); r++) {
                            if (pasteSkipInvisibleRange && (dest.getRowHeight(r, 1) === 0)) {
                                hRowCount++;
                                continue;
                            }
                            for (c = 0, fromColumnIndex = 0, hColumnCount = hOldColumnCount; c < hColumnCount && c < _getColumnCount(dest, 1); c++) {
                                if (pasteSkipInvisibleRange && (dest.getColumnWidth(tColumn + c, 1) === 0)) {
                                    hColumnCount++;
                                    continue;
                                }
                                setCallback(dest, r, tColumn + c, savedModel.get(fromRowIndex, fromColumnIndex), 1);
                                fromColumnIndex++;
                            }
                            fromRowIndex++;
                        }
                    }
                }

                if (((copyPasteHeaders & 1) === 1) && srcColumn < 0) {
                    var fRow = srcRow;
                    var tRow = destRow;
                    hRowCount = copyRowCount;
                    hColumnCount = Math_min(_getColumnCount(src, 2), _getColumnCount(dest, 2));
                    if (srcRow < 0) {
                        fRow = 0;
                        hRowCount = _getRowCount(src);
                    }
                    if (destRow < 0) {
                        tRow = 0;
                    }
                    var hOldColumnCount = hColumnCount;
                    if (crossSheet) {
                        for (r = 0, fromRowIndex = 0; r < hRowCount && r < _getRowCount(dest, 2); r++) {
                            if (pasteSkipInvisibleRange && (dest.getRowHeight(tRow + r, 2) === 0)) {
                                hRowCount++;
                                continue;
                            }
                            for (c = 0, fromColumnIndex = 0, hColumnCount = hOldColumnCount; c < hColumnCount && c < _getColumnCount(dest, 2); c++) {
                                if (pasteSkipInvisibleRange && (dest.getColumnWidth(c, 2) === 0)) {
                                    hColumnCount++;
                                    continue;
                                }
                                result = getCallback(src, fRow + fromRowIndex, fromColumnIndex, 2);
                                setCallback(dest, tRow + r, c, cloneObject(result), 2);
                                fromColumnIndex++;
                            }
                            fromRowIndex++;
                        }
                    } else {
                        savedModel = new common_1._SparseArray();
                        for (r = 0; r < hRowCount; r++) {
                            for (c = 0; c < hColumnCount; c++) {
                                result = getCallback(src, fRow + r, c, 2);
                                if (!isNullOrUndefined(result)) {
                                    savedModel.set(r, c, cloneObject(result));
                                }
                            }
                        }
                        for (r = 0, fromRowIndex = 0; r < hRowCount && r < _getRowCount(dest, 2); r++) {
                            if (pasteSkipInvisibleRange && (dest.getRowHeight(tRow + r, 2) === 0)) {
                                hRowCount++;
                                continue;
                            }
                            for (c = 0, fromColumnIndex = 0, hColumnCount = hOldColumnCount; c < hColumnCount && c < _getColumnCount(dest, 2); c++) {
                                if (pasteSkipInvisibleRange && (dest.getColumnWidth(c, 2) === 0)) {
                                    hColumnCount++;
                                    continue;
                                }
                                setCallback(dest, tRow + r, c, savedModel.get(fromRowIndex, fromColumnIndex), 2);
                                fromColumnIndex++;
                            }
                            fromRowIndex++;
                        }
                    }
                }
                var fromRow = srcRow;
                var fromColumn = srcColumn;
                var toRow = destRow;
                var toColumn = destColumn;
                var rowCount = copyRowCount;
                var columnCount = copyColumnCount;
                var destRowCount = _getRowCount(dest);
                var destColumnCount = _getColumnCount(dest);
                if (srcRow < 0) {
                    fromRow = 0;
                    rowCount = Math_min(_getRowCount(src), destRowCount);
                }
                if (srcColumn < 0) {
                    fromColumn = 0;
                    columnCount = Math_min(_getColumnCount(src), destColumnCount);
                }
                if (destRow < 0) {
                    toRow = 0;
                }
                if (destColumn < 0) {
                    toColumn = 0;
                }
                var oldColumnCount = columnCount;
                if (crossSheet) {
                    for (fromRowIndex = 0, r = 0; r < rowCount && (toRow + r < destRowCount); r++) {
                        if (pasteSkipInvisibleRange && (dest.getRowHeight(toRow + r) === 0)) {
                            rowCount++;
                            continue;
                        } else if (isRowFilterOut(toRow + r, ignoreFilteredOutRow, dest)) {
                            fromRowIndex++;
                            continue;
                        }
                        for (fromColumnIndex = 0, c = 0, columnCount = oldColumnCount; c < columnCount && (toColumn + c < destColumnCount); c++) {
                            if (pasteSkipInvisibleRange && (dest.getColumnWidth(toColumn + c) === 0)) {
                                columnCount++;
                                continue;
                            }
                            result = getCallback(src, fromRow + fromRowIndex, fromColumn + fromColumnIndex, 3);
                            setCallback(dest, toRow + r, toColumn + c, cloneObject(result), 3);
                            fromColumnIndex++;
                        }
                        fromRowIndex++;
                    }
                } else {
                    savedModel = new common_1._SparseArray();
                    try {
                        for (r = 0; r < rowCount; r++) {
                            for (c = 0; c < columnCount; c++) {
                                result = getCallback(src, fromRow + r, fromColumn + c, 3);
                                if (!isNullOrUndefined(result)) {
                                    savedModel.set(r, c, cloneObject(result));
                                }
                            }
                        }
                        for (fromRowIndex = 0, r = 0; r < rowCount && (toRow + r < destRowCount); r++) {
                            if (pasteSkipInvisibleRange && (dest.getRowHeight(toRow + r) === 0)) {
                                rowCount++;
                                continue;
                            } else if (isRowFilterOut(toRow + r, ignoreFilteredOutRow, dest)) {
                                fromRowIndex++;
                                continue;
                            }
                            for (fromColumnIndex = 0, c = 0, columnCount = oldColumnCount; c < columnCount && (toColumn + c < destColumnCount); c++) {
                                if (pasteSkipInvisibleRange && (dest.getColumnWidth(toColumn + c) === 0)) {
                                    columnCount++;
                                    continue;
                                }
                                setCallback(dest, toRow + r, toColumn + c, savedModel.get(fromRowIndex, fromColumnIndex), 3);
                                fromColumnIndex++;
                            }
                            fromRowIndex++;
                        }
                    } catch (ex) {
                        throw ex;
                    }
                }
            }
            function getCacheKeyForAnchor(anchor) {
                return [anchor.row, anchor.col].join(',');
            }
            function copyMoveValue(src, srcRow, srcColumn, dest, destRow, destColumn, copyRowCount, copyColumnCount, ignoreFilteredOutRow, copyPasteHeaders, isMove, alongWithFormula, ignorePasteSkipInvisibleRange) {
                var srcRange;
                if (isMove) {
                    srcRange = common_1._createRange(srcRow, srcColumn, copyRowCount, copyColumnCount);
                }
                copyProperty(src, srcRow, srcColumn, dest, destRow, destColumn, copyRowCount, copyColumnCount, ignoreFilteredOutRow, copyPasteHeaders, function (sheet, r, c, sheetArea) {
                    var isViewport = sheetArea === 3;
                    var value;
                    var modelManager = sheet._modelManager;
                    var movedAnchors = {};
                    if (isViewport) {
                        var anchor = (isMove || alongWithFormula) && modelManager.getDynamicArrayInfo(r, c);
                        if (anchor && anchor.isValid) {
                            value = keyword_null;
                            if (isMove) {
                                var key = getCacheKeyForAnchor(anchor);
                                if (!movedAnchors[key]) {
                                    movedAnchors[key] = anchor;
                                    var row = anchor.row, col = anchor.col;
                                    if (srcRange.contains(row, col, 1, 1)) {
                                        modelManager._getSheetModel(3)._clearValues(anchor);
                                    }
                                }
                            }
                        } else {
                            value = sheet.getValue(r, c, sheetArea, 1);
                        }
                    } else {
                        value = modelManager.getValue(r, c, sheetArea, true, 1);
                        if (sheetArea === 1 && isNullOrUndefined(value)) {
                            var bm = sheet._bindingManager;
                            if (bm && bm._dataSource) {
                                var ci = modelManager._getItem(false, 3, c);
                                var colHeaderAutoTextIndex = sheet.options.colHeaderAutoTextIndex;
                                if (ci && ((colHeaderAutoTextIndex >= 0 && r === colHeaderAutoTextIndex) || (colHeaderAutoTextIndex === -1 && r === _getRowCount(sheet, sheetArea) - 1))) {
                                    value = ci.displayName || ci.name;
                                }
                            }
                        }
                    }
                    if (isMove) {
                        if (isViewport) {
                            sheet._setValueInternal(r, c, keyword_null, sheetArea, false);
                        } else {
                            sheet._modelManager.do('setValue', r, c, keyword_null, sheetArea, true, true);
                        }
                    }
                    return value;
                }, function (sheet, r, c, value, sheetArea) {
                    if (isNullOrUndefined(value)) {
                        sheet._setValueInternal(r, c, keyword_null, sheetArea, false);
                    } else {
                        sheet._setValueInternal(r, c, value, sheetArea, false);
                    }
                }, ignorePasteSkipInvisibleRange);
            }
            function setCacheData(src, range, cache) {
                var actualRange = src._getActualRange(range);
                var row = actualRange.row;
                var col = actualRange.col;
                var rowCount = actualRange.rowCount;
                var colCount = actualRange.colCount;
                for (var r = 0; r < rowCount; r++) {
                    var rowCache = cache[row + r] = cache[row + r] || {};
                    for (var c = 0; c < colCount; c++) {
                        rowCache[col + c] = true;
                    }
                }
            }
            function copyMoveStyle(src, srcRow, srcColumn, dest, destRow, destColumn, copyRowCount, copyColumnCount, ignoreFilteredOutRow, copyPasteHeaders, isMove, ignoreSheet, ignorePasteSkipInvisibleRange) {
                var cache = {};
                if (src.tables) {
                    var srcRange = common_1._createRange(srcRow, srcColumn, copyRowCount, copyColumnCount);
                    var destRange = common_1._createRange(destRow, destColumn, copyRowCount, copyColumnCount);
                    var allTables = src.tables.all();
                    var tableRange = void 0;
                    for (var i = 0, length_1 = allTables.length; i < length_1; i++) {
                        tableRange = allTables[i].range();
                        if (srcRange.containsRange(tableRange)) {
                            setCacheData(src, tableRange, cache);
                        } else if (tableRange.containsRange(srcRange) && tableRange.containsRange(destRange)) {
                            setCacheData(src, srcRange, cache);
                        } else if (tableRange.intersect(srcRange.row, srcRange.col, srcRange.rowCount, srcRange.colCount) && tableRange.containsRange(destRange)) {
                            var intersectRange = tableRange.getIntersect(srcRange);
                            setCacheData(src, intersectRange, cache);
                        }
                    }
                }
                copyProperty(src, srcRow, srcColumn, dest, destRow, destColumn, copyRowCount, copyColumnCount, ignoreFilteredOutRow, copyPasteHeaders, function (sheet, r, c, sheetArea) {
                    var hasTableStyle = (sheetArea === 3 || isNullOrUndefined(sheetArea)) && cache[r] && cache[r][c];
                    var t = sheet.getCompositeStyle(r, c, sheetArea, keyword_undefined, keyword_undefined, keyword_undefined, keyword_undefined, hasTableStyle, keyword_undefined, keyword_undefined, ignoreSheet);
                    if (isMove) {
                        sheet.setStyle(r, c, keyword_null, sheetArea);
                    }
                    return t;
                }, function (sheet, r, c, style, sheetArea) {
                    sheet.setStyle(r, c, style, sheetArea);
                }, ignorePasteSkipInvisibleRange);
            }
            function copyMoveValidator(src, srcRow, srcColumn, dest, destRow, destColumn, copyRowCount, copyColumnCount, ignoreFilteredOutRow, isMove, ignorePasteSkipInvisibleRange) {
                var validators = src._validations._validators;
                for (var key in validators) {
                    var item = validators[key];
                    if (item) {
                        var condition = item.condition();
                        if (condition) {
                            condition.initExpression();
                        }
                    }
                }
                copyProperty(src, srcRow, srcColumn, dest, destRow, destColumn, copyRowCount, copyColumnCount, ignoreFilteredOutRow, 0, function (sheet, r, c) {
                    var validator = sheet.getDataValidator(r, c, 3);
                    if (validator) {
                        if (isMove) {
                            sheet.setDataValidator(r, c, keyword_null);
                        }

                        if (isSameSheet(src, dest)) {
                            validator._fromCopyMove = true;
                        }
                    }

                    return validator;
                }, function (sheet, r, c, validator) {
                    sheet.setDataValidator(r, c, validator);

                    if (isSameSheet(src, dest)) {
                        validator && delete validator._fromCopyMove;
                    }
                }, ignorePasteSkipInvisibleRange);
            }
            function isSameSheet(src, sheet) {
                return src === sheet && src.name() === sheet.name();
            }
            function copyMoveComment(src, srcRow, srcColumn, dest, destRow, destColumn, copyRowCount, copyColumnCount, ignoreFilteredOutRow, isMove, ignorePasteSkipInvisibleRange) {
                copyProperty(src, srcRow, srcColumn, dest, destRow, destColumn, copyRowCount, copyColumnCount, ignoreFilteredOutRow, 0, function (sheet, r, c) {
                    var commentManager = sheet._modelManager._comments;
                    var comment = commentManager && commentManager.get(r, c);
                    if (comment && isMove) {
                        commentManager.remove(r, c);
                    }
                    return comment;
                }, function (sheet, r, c, comment) {
                    var commentManager = sheet._modelManager._comments;
                    commentManager && commentManager._addInternal(r, c, comment);
                }, ignorePasteSkipInvisibleRange);
            }
            function copyMoveTag(src, srcRow, srcColumn, dest, destRow, destColumn, copyRowCount, copyColumnCount, ignoreFilteredOutRow, copyPasteHeaders, isMove, ignorePasteSkipInvisibleRange) {
                copyProperty(src, srcRow, srcColumn, dest, destRow, destColumn, copyRowCount, copyColumnCount, ignoreFilteredOutRow, copyPasteHeaders, function (sheet, r, c, sheetArea) {
                    var t;
                    // 行的移动需要copy tag
                    if (sheet.getTagWhenCopyOrMove) {
                        t = sheet.getTagWhenCopyOrMove(r, c, sheetArea, isMove);
                    } else {
                        t = sheet.getTag(r, c, sheetArea);
                    }
                    if (!isNullOrUndefined(t) && isMove) {
                        sheet.setTag(r, c, keyword_undefined);
                    }
                    return t;
                }, function (sheet, r, c, value, sheetArea) {
                    dest.setTag(r, c, value, sheetArea);
                }, ignorePasteSkipInvisibleRange);
            }
            function copyMoveBindingPath(src, srcRow, srcColumn, dest, destRow, destColumn, copyRowCount, copyColumnCount, ignoreFilteredOutRow, isMove, ignorePasteSkipInvisibleRange) {
                var savedValues = [];
                var bindingPathInfos = [];
                var visibleToInvisibleRowMap = {};
                var visibleToInvisibleColMap = {};
                var getPasteSkipInvisibleRange = !ignorePasteSkipInvisibleRange && dest._getPasteSkipInvisibleRange();
                if (getPasteSkipInvisibleRange) {
                    var rowCount = copyRowCount;
                    var colCount = copyColumnCount;
                    rowCount += dest._getNextInvisibleCount(destRow, rowCount, true);
                    colCount += dest._getNextInvisibleCount(destColumn, colCount);
                    var destRowCount = dest.getRowCount();
                    var destColumnCount = dest.getColumnCount();
                    for (var toRowIndex = 0, fromRowIndex = 0; toRowIndex < rowCount && (toRowIndex + destRow < destRowCount); toRowIndex++) {
                        if (dest.getRowHeight(destRow + toRowIndex) === 0) {
                            continue;
                        }
                        visibleToInvisibleRowMap[fromRowIndex] = toRowIndex;
                        fromRowIndex++;
                    }
                    for (var toColIndex = 0, fromColIndex = 0; toColIndex < colCount && (toColIndex + destColumn < destColumnCount); toColIndex++) {
                        if (dest.getColumnWidth(destColumn + toColIndex) === 0) {
                            continue;
                        }
                        visibleToInvisibleColMap[fromColIndex] = toColIndex;
                        fromColIndex++;
                    }
                }
                copyProperty(src, srcRow, srcColumn, dest, destRow, destColumn, copyRowCount, copyColumnCount, ignoreFilteredOutRow, 0, function (sheet, r, c) {
                    var path = sheet.getBindingPath && sheet.getBindingPath(r, c);
                    if (path) {
                        var row = r - Math_max(0, srcRow), col = c - Math_max(0, srcColumn);
                        if (getPasteSkipInvisibleRange) {
                            row = visibleToInvisibleRowMap[row];
                            col = visibleToInvisibleColMap[col];
                        }
                        savedValues.push({
                            row: row,
                            col: col,
                            value: sheet.getValue(r, c)
                        });
                    }
                    if (isMove) {
                        src.setBindingPath && src.setBindingPath(r, c, keyword_null);
                    }
                    return path;
                }, function (sheet, r, c, value) {
                    bindingPathInfos.push({ sheet: sheet, r: r, c: c, value: value });
                }, ignorePasteSkipInvisibleRange);
                return { savedValues: savedValues, bindingPathInfos: bindingPathInfos };
            }
            function setBindingPathInfos(bindingPathInfos) {
                bindingPathInfos.forEach(function (info) {
                    var sheet = info.sheet;
                    var r = info.r;
                    var c = info.c;
                    var value = info.value;
                    sheet.setBindingPath && sheet.setBindingPath(r, c, value);
                });
            }
            function copyMoveHyperlink(src, srcRow, srcColumn, dest, destRow, destColumn, copyRowCount, copyColumnCount, ignoreFilteredOutRow, copyPasteHeaders, isMove, ignorePasteSkipInvisibleRange) {
                copyProperty(src, srcRow, srcColumn, dest, destRow, destColumn, copyRowCount, copyColumnCount, ignoreFilteredOutRow, copyPasteHeaders, function (sheet, r, c, sheetArea) {
                    var hyperlink = sheet.getHyperlink && sheet.getHyperlink(r, c, sheetArea);
                    if (!isNullOrUndefined(hyperlink) && isMove) {
                        sheet.setHyperlink && sheet.setHyperlink(r, c, keyword_undefined);
                    }
                    return hyperlink;
                }, function (sheet, r, c, value, sheetArea) {
                    dest.setHyperlink && dest.setHyperlink(r, c, value, sheetArea);
                }, ignorePasteSkipInvisibleRange);
            }
            function moveFormula(src, fromRow, fromColumn, dest, toRow, toColumn, rowCount, columnCount) {
                var SheetsCalc = __webpack_require__(/*! SheetsCalc */ 'SheetsCalc');
                if (SheetsCalc) {
                    SheetsCalc.CalcOperatorAdjustor.moveFormula(src, fromRow, fromColumn, dest, toRow, toColumn, rowCount, columnCount);
                }
            }
            function adjustCustomNameOnMove(src, srcRow, srcColumn, dest, destRow, destColumn, moveRowCount, moveColumnCount) {
                var SheetsCalc = __webpack_require__(/*! SheetsCalc */ 'SheetsCalc');
                if (SheetsCalc) {
                    var _adjustCustomNameExpOnMove_1 = SheetsCalc._adjustCustomNameExpOnMove;
                    var oldExpr_1, newExpr_1;
                    var changeInfo_1 = src._modelManager._getChangesForCalcEngine();
                    if (!src.parent || !src.parent.sheets) {
                        var sheetNames = src.getCustomNames();
                        if (sheetNames) {
                            $_each(sheetNames, function (i, ne) {
                                oldExpr_1 = ne.getExpression();
                                newExpr_1 = _adjustCustomNameExpOnMove_1(src, src, srcRow, srcColumn, dest, destRow, destColumn, moveRowCount, moveColumnCount, oldExpr_1);
                                if (newExpr_1 !== oldExpr_1) {
                                    ne._setExpression(newExpr_1, changeInfo_1);
                                }
                            });
                        }
                        return;
                    }
                    var sheets_1 = src.parent.sheets, workbook = src.parent.getCustomNames();
                    if (workbook) {
                        $_each(workbook, function (i, ne) {
                            oldExpr_1 = ne.getExpression();
                            newExpr_1 = _adjustCustomNameExpOnMove_1(null, src, srcRow, srcColumn, dest, destRow, destColumn, moveRowCount, moveColumnCount, oldExpr_1);
                            if (newExpr_1 !== oldExpr_1) {
                                ne._setExpression(newExpr_1, changeInfo_1);
                            }
                        });
                    }
                    var _loop_1 = function (sheetIndex) {
                        var sheetNames = sheets_1[sheetIndex].getCustomNames();
                        if (sheetNames) {
                            $_each(sheetNames, function (i, ne) {
                                oldExpr_1 = ne.getExpression();
                                newExpr_1 = _adjustCustomNameExpOnMove_1(sheets_1[sheetIndex], src, srcRow, srcColumn, dest, destRow, destColumn, moveRowCount, moveColumnCount, oldExpr_1);
                                if (newExpr_1 !== oldExpr_1) {
                                    ne._setExpression(newExpr_1, changeInfo_1);
                                }
                            });
                        }
                    };
                    for (var sheetIndex = 0; sheetIndex < sheets_1.length; sheetIndex++) {
                        _loop_1(sheetIndex);
                    }
                }
            }

            function copyOrMoveTo(src, srcRow, srcColumn, dest, destRow, destColumn, rowCount, columnCount, option, ignoreFilteredOutRow, copyPasteHeaders, isMove, ignoreSheet, ignorePasteSkipInvisibleRange) {
                checkArguments(src, srcRow, srcColumn, dest, destRow, destColumn, rowCount, columnCount, isMove);
                var isOpreatingBindingColumns, fColumn, hColumnCount, isContainFormula;

                var savedPivotTables;
                if ((option & 1) > 0 && (option & 2) > 0) {
                    var srcPivotTableManager = src.pivotTables;
                    if (srcPivotTableManager) {
                        savedPivotTables = srcPivotTableManager._onCopyOrMoving(common_1._createRange(Math_max(0, srcRow), Math_max(0, srcColumn), srcRow < 0 ? Math_min(_getRowCount(src), _getRowCount(dest)) : rowCount, srcColumn < 0 ? Math_min(_getColumnCount(src), _getColumnCount(dest)) : columnCount), isMove);
                    }
                }
                if (isMove) {
                    if (srcRow < 0) {
                        fColumn = srcColumn;
                        hColumnCount = columnCount;
                        if (srcColumn < 0) {
                            fColumn = 0;
                            hColumnCount = Math_min(_getColumnCount(src), _getColumnCount(dest));
                        }
                        var tColumn = destColumn;
                        if (destColumn < 0) {
                            tColumn = 0;
                        }
                        isOpreatingBindingColumns = true;
                        for (var c = 0; c < hColumnCount; c++) {
                            var srcItem = src._modelManager._getItem(false, 3, fColumn + c);
                            var destItem = src._modelManager._getItem(false, 3, tColumn + c);
                            var srcItemName = srcItem && srcItem.name;
                            var destItemName = destItem && destItem.name;
                            if (!srcItem || !destItem || !srcItemName || !destItemName) {
                                isOpreatingBindingColumns = false;
                            }
                            destItem = domUtil_1.GC$.extend(true, {}, dest._modelManager._getItem(false, 3, tColumn + c) || {});
                            destItem.displayName = srcItem && srcItem.displayName;
                            destItem.name = srcItem && srcItem.name;
                            dest._modelManager.do('setItem', false, 3, tColumn + c, destItem);
                        }
                    }
                }
                if ((option & 64) > 0) {
                    copyMoveStyle(src, srcRow, srcColumn, dest, destRow, destColumn, rowCount, columnCount, ignoreFilteredOutRow, copyPasteHeaders, isMove, ignoreSheet, ignorePasteSkipInvisibleRange);
                    if (!src._fromTable) {
                        src._validations && copyMoveValidator(src, srcRow, srcColumn, dest, destRow, destColumn, rowCount, columnCount, ignoreFilteredOutRow, isMove, ignorePasteSkipInvisibleRange);
                    }
                }

                if ((option & 512) > 0) {
                    copyOrMoveConditionalFormat(src, srcRow, srcColumn, dest, destRow, destColumn, rowCount, columnCount, isMove, ignorePasteSkipInvisibleRange);
                }

                var savedTables;
                if ((option & 1) > 0 && (option & 2) > 0) {
                    var srcTableManager = src.tables;
                    if (srcTableManager) {
                        savedTables = srcTableManager._onCopyOrMoving(common_1._createRange(Math_max(0, srcRow), Math_max(0, srcColumn), srcRow < 0 ? Math_min(_getRowCount(src), _getRowCount(dest)) : rowCount, srcColumn < 0 ? Math_min(_getColumnCount(src), _getColumnCount(dest)) : columnCount), isMove);
                    }
                }
                var hasCalc = _supportsCalc;
                if (hasCalc) {
                    src.suspendCalcService();
                    dest.suspendCalcService();
                }
                var savedValues = [], bindingPathResult = keyword_null, bindingPathInfos = [];
                if ((option & 256) > 0) {
                    bindingPathResult = copyMoveBindingPath(src, srcRow, srcColumn, dest, destRow, destColumn, rowCount, columnCount, ignoreFilteredOutRow, isMove, ignorePasteSkipInvisibleRange);
                    savedValues = bindingPathResult.savedValues;
                    bindingPathInfos = bindingPathResult.bindingPathInfos;
                }
                try {
                    var destPivotTableManager = dest.pivotTables;

                    if ((option & 1) > 0 && (option & 2) > 0 && destPivotTableManager) {
                        destPivotTableManager._onCopyOrMoved(savedPivotTables, src, Math_max(0, srcRow), Math_max(0, srcColumn), dest, Math_max(0, destRow), Math_max(0, destColumn), rowCount, columnCount, isMove);
                    }
                    if ((option & 1) > 0 && !isOpreatingBindingColumns) {
                        copyMoveValue(src, srcRow, srcColumn, dest, destRow, destColumn, rowCount, columnCount, ignoreFilteredOutRow, copyPasteHeaders, isMove, (option & 2) > 0, ignorePasteSkipInvisibleRange);

                        if (isMove) {
                            dest._trigger('shiftCellsDown', {
                                row: destRow,
                                col: destColumn,
                                changedRowCount: destRow - srcRow,
                                changedColCount: destColumn - srcColumn
                            }, true);
                        }


                        setBindingPathInfos(bindingPathInfos);

                        if (_supportsCalc && (option & 2) === 0) {
                            dest.clearFormula(destRow, destColumn, rowCount, columnCount, function (sheet, row) {
                                return !ignoreFilteredOutRow || !sheet._isRowFilterOut || !sheet._isRowFilterOut(row);
                            });
                        }

                        if ((option & 256) > 0) {
                            var count = savedValues.length;
                            var baseRow = destRow < 0 ? 0 : destRow;
                            var baseCol = destColumn < 0 ? 0 : destColumn;
                            for (var i = 0; i < count; i++) {
                                var cv = savedValues[i];
                                if (!isMove && isRowFilterOut(baseRow + cv.row, ignoreFilteredOutRow, dest)) {
                                    continue;
                                }
                                dest.setValue(baseRow + cv.row, baseCol + cv.col, cv.value);
                            }
                        }
                    } else {
                        setBindingPathInfos(bindingPathInfos);
                    }
                    var destTableManager = dest.tables;

                    if ((option & 1) > 0 && (option & 2) > 0 && destTableManager) {
                        destTableManager._onCopyOrMoved(savedTables, Math_max(0, srcRow), Math_max(0, srcColumn), Math_max(0, destRow), Math_max(0, destColumn), isMove);
                    }
                    if (_supportsCalc) {
                        if (isMove) {
                            adjustCustomNameOnMove(src, srcRow, srcColumn, dest, destRow, destColumn, rowCount, columnCount);
                            if ((option & 2) > 0) {
                                moveFormula(src, srcRow, srcColumn, dest, destRow, destColumn, rowCount, columnCount);
                            }
                        } else if ((option & 2) > 0) {
                            var SheetsCalc = __webpack_require__(/*! SheetsCalc */ 'SheetsCalc');
                            SheetsCalc && SheetsCalc._copyFormula(src, srcRow, srcColumn, dest, destRow, destColumn, rowCount, columnCount, ignoreFilteredOutRow, ignorePasteSkipInvisibleRange);
                        }
                        if ((option & 1) > 0 && (option & 2) > 0 && destTableManager) {
                            destTableManager._syncFormulaInTables(savedTables);
                        }
                    }
                } finally {
                    if (hasCalc) {
                        src.resumeCalcService(false);
                        dest.resumeCalcService(false);
                    }
                }
                if ((option & 4) > 0) {
                    copyMoveComment(src, srcRow, srcColumn, dest, destRow, destColumn, rowCount, columnCount, ignoreFilteredOutRow, isMove, ignorePasteSkipInvisibleRange);
                }
                if ((option & 128) > 0) {
                    copyMoveTag(src, srcRow, srcColumn, dest, destRow, destColumn, rowCount, columnCount, ignoreFilteredOutRow, copyPasteHeaders, isMove, ignorePasteSkipInvisibleRange);
                }
                if ((option & 1024) > 0) {
                    copyMoveHyperlink(src, srcRow, srcColumn, dest, destRow, destColumn, rowCount, columnCount, ignoreFilteredOutRow, copyPasteHeaders, isMove, ignorePasteSkipInvisibleRange);
                }
                if ((option & 16) > 0) {
                    copyOrMoveSparkline(src, srcRow, srcColumn, dest, destRow, destColumn, rowCount, columnCount, isMove, ignorePasteSkipInvisibleRange);
                }
                if ((option & 8) > 0) {
                    if (srcRow < 0) {
                        copyOrMoveColumnRangeGroup(src, srcColumn, dest, destColumn, columnCount, isMove);
                    }
                    if (srcColumn < 0) {
                        copyOrMoveRowRangeGroup(src, srcRow, dest, destRow, rowCount, isMove);
                    }
                }
                if ((option & 32) > 0) {
                    if (isMove || !(rowCount === 1 && columnCount === 1)) {
                        copyOrMoveSpan(src, srcRow, srcColumn, dest, destRow, destColumn, rowCount, columnCount, isMove);
                    }
                }

                if (srcRow < 0 && destRow <= 0) {
                    copyOrMoveColumnAxis(src, srcColumn, dest, destColumn, columnCount, option, isMove, ignorePasteSkipInvisibleRange, ignoreSheet);
                }

                if (srcColumn < 0 && destColumn <= 0) {
                    copyOrMoveRowAxis(src, srcRow, dest, destRow, rowCount, option, ignoreFilteredOutRow, isMove, ignorePasteSkipInvisibleRange, ignoreSheet);
                }

                if (srcRow < 0 && destRow <= 0 && srcColumn < 0 && destColumn <= 0) {
                    copyOrMoveSheetInfo(src, dest, option, isMove);
                }
                if (isMove) {
                    if (srcRow < 0) {
                        fColumn = srcColumn;
                        hColumnCount = columnCount;
                        if (srcColumn < 0) {
                            fColumn = 0;
                            hColumnCount = Math_min(_getColumnCount(src), _getColumnCount(dest));
                        }
                        for (var c = 0; c < hColumnCount; c++) {
                            if (src.getDataColumnName && src.getDataColumnName(fColumn + c)) {
                                src._modelManager.do('setItem', false, 3, fColumn + c, keyword_null);
                            }
                        }
                    }
                }
            }
            exports.staticMembers = {
                copyTo: function (src, srcRow, srcColumn, dest, destRow, destColumn, copyRowCount, copyColumnCount, option, ignoreFilteredOutRow, copyPasteHeaders, ignorePasteSkipInvisibleRange) {
                    copyOrMoveTo(src, srcRow, srcColumn, dest, destRow, destColumn, copyRowCount, copyColumnCount, option, ignoreFilteredOutRow, copyPasteHeaders, false, keyword_undefined, ignorePasteSkipInvisibleRange);
                },
                moveTo: function (src, srcRow, srcColumn, dest, destRow, destColumn, moveRowCount, moveColumnCount, option, ignoreSheet) {
                    copyOrMoveTo(src, srcRow, srcColumn, dest, destRow, destColumn, moveRowCount, moveColumnCount, option, keyword_undefined, 3, true, ignoreSheet);
                }
            };
        }),
        './dist/core/worksheet/worksheet-ui.js': (function (module, exports, __webpack_require__) {
            Object.defineProperty(exports, '__esModule', { value: true });
            var worksheet_1 = __webpack_require__(/*! ./worksheet */ './dist/core/worksheet/worksheet.js');
            var style_1 = __webpack_require__(/*! ./style */ './dist/core/worksheet/style.js');
            var domUtil_1 = __webpack_require__(/*! ../util/domUtil */ './dist/core/util/domUtil.js');
            var common_1 = __webpack_require__(/*! ../util/common */ './dist/core/util/common.js');
            var Common_1 = __webpack_require__(/*! Common */ 'Common');
            var core_enum_1 = __webpack_require__(/*! ../core.enum */ './dist/core/core.enum.js');
            var CalcEngine = __webpack_require__(/*! CalcEngine */ 'CalcEngine');
            var clipboardhelper_1 = __webpack_require__(/*! ./clipboardhelper */ './dist/core/worksheet/clipboardhelper.js');
            var _supportsCalc = !!CalcEngine;
            var getEditingSpan = common_1.util._getEditingSpan;
            var KEYWORD_UNDEFINED = void 0;
            var KEYWORD_NULL = null;
            var isNullOrUndefined = Common_1.Common._Types._isNullOrUndefined;
            var sheetPrototype = worksheet_1.Worksheet.prototype;
            function _isNumberType(value) {
                return typeof value === 'number';
            }
            function _isStringType(value) {
                return typeof value === 'string';
            }
            function _convertToInt(value) {
                return parseInt(value, 10);
            }
            function _convertToPositive(value) {
                return Math.abs(value);
            }
            function defProperty(getCallback, setCallback) {
                var getFn = getCallback, setFn = setCallback;
                return function (value) {
                    var self = this, sheet = self.sheet, row = self.row, col = self.col, sheetArea = self.sheetArea;
                    if (arguments.length === 0) {
                        return getFn.call(sheet, row, col, sheetArea);
                    }
                    if (row >= 0 && col >= 0) {
                        for (var r = row; r < row + self.rowCount; r++) {
                            for (var c = col; c < col + self.colCount; c++) {
                                if (isValidIndex(sheet, r, c, sheetArea)) {
                                    setFn.call(sheet, r, c, value, sheetArea);
                                }
                            }
                        }
                    }
                    return self;
                };
            }
            function isValidIndex(sheet, row, col, sheetArea) {
                var rowCount = sheet.getRowCount(sheetArea);
                var colCount = sheet.getColumnCount(sheetArea);
                return ((col < 0 && 0 <= row && row < rowCount) ||
                    (row < 0 && 0 <= col && col < colCount) ||
                    (0 <= row && row < rowCount && 0 <= col && col < colCount)) ||
                    (row === -1 && col === -1);
            }
            function _setCellStyle(sheet, r, c, propertyName, value, sheetArea) {
                if (isValidIndex(sheet, r, c, sheetArea)) {
                    var style = sheet._getStyleObject(r, c, sheetArea);
                    if (!style) {
                        style = new style_1.Style();
                    }
                    if (typeof (style) === 'string') {
                        var parentName = style;
                        style = new style_1.Style();
                        style.parentName = parentName;
                    }
                    if (propertyName === 'font') {
                        _adjustThemeFont(sheet, style, value);
                    }
                    style[propertyName] = value;
                    sheet.setStyle(r, c, style, sheetArea);
                }
            }
            function _adjustThemeFont(sheet, oldStyle, value) {
                if (!isNullOrUndefined(oldStyle.themeFont)) {
                    var htmlSpan = getEditingSpan(), style = htmlSpan.style;
                    var oldFont = oldStyle.font;
                    style.font = oldFont;
                    var oldFontFamily = oldFont && style.fontFamily;
                    style.font = value;
                    var newFontFamily = value && style.fontFamily;
                    if (newFontFamily !== oldFontFamily) {
                        oldStyle.themeFont = KEYWORD_UNDEFINED;
                    }
                }
            }
            var CellRange = (function () {
                function CellRange(sheet, row, col, rowCount, colCount, sheetArea) {
                    var self = this;
                    if (row < 0) {
                        row = rowCount = -1;
                    }
                    if (col < 0) {
                        col = colCount = -1;
                    }
                    self.sheet = sheet;
                    self.row = row;
                    self.rowCount = isNullOrUndefined(rowCount) ? 1 : rowCount;
                    self.col = col;
                    self.colCount = isNullOrUndefined(colCount) ? 1 : colCount;
                    self.sheetArea = isNullOrUndefined(sheetArea) ? 3 : sheetArea;
                }
                CellRange.prototype.tag = function (value) {
                    var self = this;
                    var sheet = self.sheet;
                    var row = self.row;
                    var col = self.col;
                    var rowCount = self.rowCount;
                    var colCount = self.colCount;
                    var sheetArea = self.sheetArea;
                    var r;
                    var c;
                    if (arguments.length === 0) {
                        return sheet.getTag(row, col, sheetArea);
                    }
                    if (row >= 0 && col >= 0) {
                        for (r = row; r < row + rowCount; r++) {
                            for (c = col; c < col + colCount; c++) {
                                sheet.setTag(r, c, value, sheetArea);
                            }
                        }
                    } else if (row >= 0) {
                        for (r = row; r < row + rowCount; r++) {
                            sheet.setTag(r, -1, value, sheetArea);
                        }
                    } else if (col >= 0) {
                        for (c = col; c < col + colCount; c++) {
                            sheet.setTag(-1, c, value, sheetArea);
                        }
                    }
                    return self;
                };
                CellRange.prototype.width = function (value) {
                    var self = this;
                    var sheet = self.sheet;
                    var row = self.row;
                    var col = self.col;
                    var sheetArea = self.sheetArea;
                    if (arguments.length === 0) {
                        if (row < 0) {
                            return sheet.getColumnWidth(col, sheetArea);
                        }
                    } else {
                        if (row < 0) {
                            for (var c = 0; c < self.colCount; c++) {
                                sheet.setColumnWidth(c + col, value, sheetArea);
                            }
                        }
                        return self;
                    }
                };
                CellRange.prototype.height = function (value) {
                    var self = this;
                    var sheet = self.sheet;
                    var row = self.row;
                    var col = self.col;
                    var sheetArea = self.sheetArea;
                    if (arguments.length === 0) {
                        if (col < 0) {
                            return sheet.getRowHeight(row, sheetArea);
                        }
                    } else {
                        if (col < 0) {
                            for (var r = 0; r < self.rowCount; r++) {
                                sheet.setRowHeight(r + row, value, sheetArea);
                            }
                        }
                        return self;
                    }
                };
                CellRange.prototype.visible = function (value) {
                    var self = this;
                    var sheet = self.sheet;
                    var row = self.row;
                    var col = self.col;
                    var sheetArea = self.sheetArea;
                    if (arguments.length === 0) {
                        if (col < 0 && row >= 0) {
                            return sheet.getRowVisible(row, sheetArea);
                        } else if (col >= 0 && row < 0) {
                            return sheet.getColumnVisible(col, sheetArea);
                        }
                    } else {
                        if (col < 0 && row >= 0) {
                            for (var r = 0; r < self.rowCount; r++) {
                                sheet.setRowVisible(r + row, value, sheetArea);
                            }
                        } else if (col >= 0 && row < 0) {
                            for (var c = 0; c < self.colCount; c++) {
                                sheet.setColumnVisible(c + col, value, sheetArea);
                            }
                        }
                        return self;
                    }
                };
                CellRange.prototype.resizable = function (value) {
                    var self = this, sheet = self.sheet, row = self.row, col = self.col, sheetArea = self.sheetArea;
                    if (arguments.length === 0) {
                        if (col < 0 && row >= 0) {
                            return sheet.getRowResizable(row, sheetArea);
                        } else if (col >= 0 && row < 0) {
                            return sheet.getColumnResizable(col, sheetArea);
                        }
                    } else {
                        if (col < 0 && row >= 0) {
                            for (var r = 0; r < self.rowCount; r++) {
                                sheet.setRowResizable(r + row, value, sheetArea);
                            }
                        } else if (col >= 0 && row < 0) {
                            for (var c = 0; c < self.colCount; c++) {
                                sheet.setColumnResizable(c + col, value, sheetArea);
                            }
                        }
                        return self;
                    }
                };
                CellRange.prototype._getStyleProperty = function (propertyName) {
                    var self = this;
                    return self.sheet._getStyleProperty(self.row, self.col, propertyName, self.sheetArea);
                };
                CellRange.prototype._setStyleProperty = function (propertyName, value) {
                    var self = this;
                    var r;
                    var c;
                    var sheet = self.sheet;
                    var row = self.row;
                    var col = self.col;
                    var rowCount = self.rowCount;
                    var colCount = self.colCount;
                    var sheetArea = self.sheetArea;
                    sheet.suspendPaint();
                    if (row >= 0 && col >= 0) {
                        for (r = row; r < row + rowCount; r++) {
                            for (c = col; c < col + colCount; c++) {
                                _setCellStyle(sheet, r, c, propertyName, value, sheetArea);
                            }
                        }
                    } else if (row >= 0) {
                        c = -1;
                        for (r = row; r < row + rowCount; r++) {
                            _setCellStyle(sheet, r, c, propertyName, value, sheetArea);
                        }
                    } else if (col >= 0) {
                        r = -1;
                        for (c = col; c < col + colCount; c++) {
                            _setCellStyle(sheet, r, c, propertyName, value, sheetArea);
                        }
                    } else if (row === -1 && col === -1 && rowCount === -1 && colCount === -1) {
                        r = -1;
                        c = -1;
                        _setCellStyle(sheet, r, c, propertyName, value, sheetArea);
                    }
                    sheet.resumePaint();
                    return self;
                };
                CellRange.prototype.clear = function (type) {
                    var self = this;
                    self.sheet.clear(self.row, self.col, self.rowCount, self.colCount, self.sheetArea, type);
                };
                CellRange.prototype.setBorder = function (border, option) {
                    var self = this;
                    var sheet = self.sheet;
                    var sheetArea = self.sheetArea;
                    sheet.suspendPaint();
                    try {
                        var cellRange = new common_1.Range(self.row, self.col, self.rowCount, self.colCount);
                        var actualRange = sheet._getActualRange(cellRange, sheetArea);
                        var row = actualRange.row;
                        var col = actualRange.col;
                        var rowCount = actualRange.rowCount;
                        var colCount = actualRange.colCount;
                        var r = void 0, c = void 0;
                        var all = option.all;
                        var outline = option.outline;
                        var inside = option.inside;
                        if (option.left || all || outline) {
                            for (r = 0; r < rowCount; r++) {
                                sheet.getCell(row + r, col, sheetArea).borderLeft(border);
                            }
                        }
                        if (option.top || all || outline) {
                            for (c = 0; c < colCount; c++) {
                                sheet.getCell(row, col + c, sheetArea).borderTop(border);
                            }
                        }
                        if (option.right || all || outline) {
                            for (r = 0; r < rowCount; r++) {
                                sheet.getCell(row + r, col + colCount - 1, sheetArea).borderRight(border);
                            }
                        }
                        if (option.bottom || all || outline) {
                            for (c = 0; c < colCount; c++) {
                                sheet.getCell(row + rowCount - 1, col + c, sheetArea).borderBottom(border);
                            }
                        }
                        if (option.diagonalUp) {
                            for (r = 0; r < rowCount; r++) {
                                for (c = 0; c < colCount; c++) {
                                    sheet.getCell(row + r, col + c, sheetArea).diagonalUp(border);
                                }
                            }
                        }
                        if (option.diagonalDown) {
                            for (r = 0; r < rowCount; r++) {
                                for (c = 0; c < colCount; c++) {
                                    sheet.getCell(row + r, col + c, sheetArea).diagonalDown(border);
                                }
                            }
                        }
                        if (option.innerHorizontal || all || inside) {
                            for (r = 0; r < rowCount - 1; r++) {
                                for (c = 0; c < colCount; c++) {
                                    sheet.getCell(row + r, col + c, sheetArea).borderBottom(border);
                                    sheet.getCell(row + r + 1, col + c, sheetArea).borderTop(border);
                                }
                            }
                        }
                        if (option.innerVertical || all || inside) {
                            for (c = 0; c < colCount - 1; c++) {
                                for (r = 0; r < rowCount; r++) {
                                    sheet.getCell(row + r, col + c, sheetArea).borderRight(border);
                                    sheet.getCell(row + r, col + c + 1, sheetArea).borderLeft(border);
                                }
                            }
                        }
                    } finally {
                        sheet.resumePaint();
                    }
                };
                CellRange.prototype.toHtml = function (headerOptions, includeStyle) {
                    if (headerOptions === void 0) {
                        headerOptions = core_enum_1.HeaderOptions.noHeaders;
                    }
                    if (includeStyle === void 0) {
                        includeStyle = true;
                    }
                    var _this = this;
                    if (_this.sheetArea === core_enum_1.SheetArea.corner) {
                        return '';
                    }
                    return clipboardhelper_1._ClipboardHelper._getRangeHtml(_this.sheet, headerOptions, _this.row, _this.rowCount, _this.col, _this.colCount, _this.sheetArea, includeStyle, [], [], true, true, includeStyle, true);
                };
                CellRange._defProperty = defProperty;
                return CellRange;
            }());
            exports.CellRange = CellRange;
            CellRange.prototype.value = defProperty(sheetPrototype.getValue, sheetPrototype.setValue);
            CellRange.prototype.text = defProperty(sheetPrototype.getText, sheetPrototype.setText);
            CellRange.prototype.formula = defProperty(function (row, col) {
                return _supportsCalc && this.getFormula(row, col);
            }, function (row, col, formula, sheetArea) {
                _supportsCalc && this.setFormula(row, col, formula, sheetArea);
            });
            CellRange.prototype.styleName = defProperty(sheetPrototype.getStyleName, sheetPrototype.setStyleName);

            domUtil_1.GC$.each(
                [
                    'backColor', 'foreColor', 'hAlign', 'vAlign', 'themeFont', 'font',
                    'formatter', 'borderLeft', 'borderTop', 'borderRight', 'borderBottom',
                    'diagonalDown', 'diagonalUp', 'locked', 'textIndent', 'wordWrap',
                    'showEllipsis', 'shrinkToFit', 'backgroundImage', 'backgroundImageLayout',
                    'cellType', 'tabStop', 'textDecoration', 'imeMode', 'watermark',
                    'cellPadding', 'labelOptions', 'quotePrefix', 'isVerticalText', 'cellButtons',
                    'dropDowns', 'textOrientation'
                ], function (i, p) {
                    CellRange.prototype[p] = function (value) {
                        return arguments.length === 0 ? this._getStyleProperty(p) : this._setStyleProperty(p, value);
                    };
                });

            function _adjustAddress(address) {
                address = address.replace(/[^\:]+\!/g, '');
                address = address.replace(/\$/g, '');
                return address;
            }
            function _parseRangeString(value) {
                var _a = value.split(':');
                var startRange = _a[0];
                var endRange = _a[1];
                var REG = /([A-Z]+)(\d+)?(\D+)?/;
                var columnMarker;
                var rowMarker;
                if (!isNaN(Number(startRange))) {
                    rowMarker = startRange;
                } else {
                    var matches = startRange.match(REG);
                    var unexpectedCharacter = matches[3];
                    if (unexpectedCharacter) {
                        return KEYWORD_NULL;
                    }
                    columnMarker = matches[1];
                    rowMarker = matches[2];
                }
                if (startRange && !endRange) {
                    if (columnMarker && rowMarker) {
                        var row = _getRowIndexFromRowMaker(rowMarker);
                        var col = _getColIndexFromColumnMarker(columnMarker);
                        return [row, col, 1, 1];
                    }
                } else if (startRange && endRange) {
                    var endColumnMarker = void 0;
                    var endRowMarker = void 0;
                    if (!isNaN(Number(endRange))) {
                        endRowMarker = endRange;
                    } else {
                        var endMatches = endRange.match(REG);
                        var unexpectedCharacter = endMatches[3];
                        if (unexpectedCharacter) {
                            return KEYWORD_NULL;
                        }
                        endColumnMarker = endMatches[1];
                        endRowMarker = endMatches[2];
                    }
                    if (!columnMarker && rowMarker && !endColumnMarker && endRowMarker) {
                        var startRowIndex = _getRowIndexFromRowMaker(rowMarker);
                        var endRowIndex = _getRowIndexFromRowMaker(endRowMarker);
                        var row = Math.min(startRowIndex, endRowIndex);
                        var rowCount = _convertToPositive(startRowIndex - endRowIndex) + 1;
                        return [row, -1, rowCount, -1];
                    } else if (columnMarker && !rowMarker && endColumnMarker && !endRowMarker) {
                        var startColIndex = _getColIndexFromColumnMarker(columnMarker);
                        var endColIndex = _getColIndexFromColumnMarker(endColumnMarker);
                        var col = Math.min(startColIndex, endColIndex);
                        var colCount = _convertToPositive(startColIndex - endColIndex) + 1;
                        return [-1, col, -1, colCount];
                    } else if (columnMarker && rowMarker && endColumnMarker && endRowMarker) {
                        var startRowIndex = _getRowIndexFromRowMaker(rowMarker);
                        var endRowIndex = _getRowIndexFromRowMaker(endRowMarker);
                        var startColIndex = _getColIndexFromColumnMarker(columnMarker);
                        var endColIndex = _getColIndexFromColumnMarker(endColumnMarker);
                        var row = Math.min(startRowIndex, endRowIndex);
                        var rowCount = _convertToPositive(startRowIndex - endRowIndex) + 1;
                        var col = Math.min(startColIndex, endColIndex);
                        var colCount = _convertToPositive(startColIndex - endColIndex) + 1;
                        return [row, col, rowCount, colCount];
                    }
                }
                return KEYWORD_NULL;
            }
            exports._parseRangeString = _parseRangeString;
            function _getRowIndexFromRowMaker(marker) {
                return _convertToInt(marker) - 1;
            }
            function _getColIndexFromColumnMarker(marker) {
                var BASE_CHAR_CODE = 65 - 1, CHAR_COUNT = 26;
                var index = 0, length = marker.length;
                for (var i = 0; i < length; i++) {
                    var converted = marker[i].charCodeAt(0) - BASE_CHAR_CODE;
                    index += Math.pow(CHAR_COUNT, (length - i - 1)) * converted;
                }
                return index - 1;
            }
            exports._getColIndexFromColumnMarker = _getColIndexFromColumnMarker;
            domUtil_1.GC$.extend(sheetPrototype, {
                getRange: function () {
                    var firstArgument = arguments[0];
                    var row, col, rowCount, colCount, sheetArea;
                    if (_isStringType(firstArgument)) {
                        var address = firstArgument.toUpperCase();
                        var isR1C1 = this.parent && this.parent.options.referenceStyle === 1;
                        if (isR1C1) {
                            return KEYWORD_NULL;
                        } else {
                            sheetArea = arguments[1];
                            address = _adjustAddress(address);
                            if (address.split(',').length > 1) {
                                return KEYWORD_NULL;
                            }
                            if (_supportsCalc) {
                                var SheetsCalc = __webpack_require__(/*! SheetsCalc */ 'SheetsCalc');
                                var range = SheetsCalc.formulaToRange(this, address, KEYWORD_UNDEFINED, KEYWORD_UNDEFINED, sheetArea);
                                if (range) {
                                    row = range.row;
                                    col = range.col;
                                    rowCount = range.rowCount;
                                    colCount = range.colCount;
                                } else {
                                    return KEYWORD_NULL;
                                }
                            } else {
                                var res = _parseRangeString(address);
                                if (!res) {
                                    return KEYWORD_NULL;
                                }
                                row = res[0], col = res[1], rowCount = res[2], colCount = res[3];
                            }
                        }
                    } else if (_isNumberType(firstArgument)) {
                        row = firstArgument;
                        col = arguments[1];
                        rowCount = arguments[2];
                        colCount = arguments[3];
                        sheetArea = arguments[4];
                    }
                    return new CellRange(this, row, col, rowCount, colCount, sheetArea);
                },
                getCell: function (row, col, sheetArea) {
                    if (isNullOrUndefined(col)) {
                        col = -1;
                    }
                    return new CellRange(this, row, col, 1, 1, sheetArea);
                }
            });
        }),
        './dist/core/worksheet/worksheet.js': (function (module, exports, __webpack_require__) {
            Object.defineProperty(exports, '__esModule', { value: true });
            var core_ns_1 = __webpack_require__(/*! ../core.ns */ './dist/core/core.ns.js');
            var common_1 = __webpack_require__(/*! ../util/common */ './dist/core/util/common.js');
            var imageLoader_1 = __webpack_require__(/*! ../util/imageLoader */ './dist/core/util/imageLoader.js');
            var tasks_1 = __webpack_require__(/*! ../util/tasks */ './dist/core/util/tasks.js');
            var style_1 = __webpack_require__(/*! ./style */ './dist/core/worksheet/style.js');
            var worksheet_model_1 = __webpack_require__(/*! ./worksheet-model */ './dist/core/worksheet/worksheet-model.js');
            var domUtil_1 = __webpack_require__(/*! ../util/domUtil */ './dist/core/util/domUtil.js');
            var textcelltype_1 = __webpack_require__(/*! ../celltype/textcelltype */ './dist/core/celltype/textcelltype.js');
            var CalcEngine_1 = __webpack_require__(/*! CalcEngine */ 'CalcEngine');
            var headercelltype_1 = __webpack_require__(/*! ../celltype/headercelltype */ './dist/core/celltype/headercelltype.js');
            var core_enum_1 = __webpack_require__(/*! ../core.enum */ './dist/core/core.enum.js');
            var Common_1 = __webpack_require__(/*! Common */ 'Common');
            var CalcEngine = __webpack_require__(/*! CalcEngine */ 'CalcEngine');
            var _supportsCalc = !!CalcEngine;
            var SheetsCalc;
            var theme_1 = __webpack_require__(/*! ../util/theme */ './dist/core/util/theme.js');
            var stylehelper_1 = __webpack_require__(/*! ./stylehelper */ './dist/core/worksheet/stylehelper.js');
            var tryAddCacheToRichText = common_1.util._tryAddCacheToRichText;
            var isFormatString = common_1.util._isFormatString;
            var isNullOrUndefined = Common_1.Common._Types._isNullOrUndefined;
            var _createElement = common_1.util._createElement;
            var defProperty = common_1.util._defProperty;
            var createOptions = common_1.util._createOptions;
            var isValidSheetName = common_1.util._isValidSheetName;
            var $_each = domUtil_1.GC$.each, $_isEmptyObject = domUtil_1.GC$.isEmptyObject;
            var hasOwnProperty = Common_1.Common._hasOwnProperty;
            var tryConvertDateToOADate = common_1.util._tryConvertDateToOADate;
            var tryConvertOADateToDate = common_1.util._tryConvertOADateToDate;
            var starSizeReg = new RegExp('^\\d*(\\.\\d+)?\\*$');
            var _StringHelper = Common_1.Common._StringHelper;
            var DOCUMENT = document, convertToInt = parseInt, convertToFloat = parseFloat, isNotANumber = isNaN, keyword_null = null, keyword_undefined = void 0, Math_min = Math.min, Math_max = Math.max, Math_floor = Math.floor, Math_ceil = Math.ceil, Math_abs = Math.abs, Math_round = Math.round, const_undefined = 'undefined', const_string = 'string', cssWidth = 'width', cssHeight = 'height', cssBlack = 'black', const_tag = 'tag', const_onLayoutChanged = 'onLayoutChanged', const_beforeLayoutChanged = 'beforeLayoutChanged', const_onPaintSuspend = 'onPaintSuspend', const_isVisible = 'isVisible', const_starSize = 'starSize', const_resizable = 'resizable', _gcSheet = '.gcSheet', _gcSheetInternal = '.gcSheetInternal';
            var tableStyleProperties = {
                backColor: true,
                foreColor: true,
                font: true,
                borderLeft: true,
                borderTop: true,
                borderRight: true,
                borderBottom: true,
                textDecoration: true,
                cellType: true,
                formatter: true
            };
            var rm = new Common_1.Common.ResourceManager(core_ns_1.SR);
            var getSR = rm.getResource.bind(rm);
            function getDirtyOrInsertRows(sheet, isDirtyRows) {
                var rows = [];
                var dirtyNodes = sheet._modelManager._getDirtyNodes(), t, node, obj;
                if (dirtyNodes) {
                    for (t in dirtyNodes) {
                        if (hasOwnProperty(dirtyNodes, t)) {
                            node = dirtyNodes[t];
                            if (node) {
                                if (!isDirtyRows && node.rs === 'n') {
                                    obj = {
                                        row: +t,
                                        item: sheet.getDataItem && sheet.getDataItem(+t)
                                    };
                                    rows.push(obj);
                                }
                                if (isDirtyRows && node.rs === 'e') {
                                    for (var colIndex in node) {
                                        if (!isNotANumber(colIndex)) {
                                            var node_1 = node[colIndex];
                                            if (node_1) {
                                                obj = {
                                                    row: +t,
                                                    item: sheet.getDataItem && sheet.getDataItem(+t)
                                                };
                                                obj.originalItem = node.originalItem;
                                                rows.push(obj);
                                                break;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                return rows;
            }
            function getColsWidth(cachePool, c1, c2) {
                var width = 0;
                for (var c = c1; c <= c2; c++) {
                    width += cachePool._getZoomColWidth(c);
                }
                return width;
            }
            function getRowsHeight(cachePool, r1, r2) {
                var height = 0;
                for (var r = r1; r <= r2; r++) {
                    height += cachePool._getZoomRowHeight(r);
                }
                return height;
            }
            function getColumnCount(obj) {
                return obj.getColumnCount();
            }
            function getRowCount(obj) {
                return obj.getRowCount();
            }
            function getFrozenTrailingColumnCount(obj) {
                return obj.frozenTrailingColumnCount();
            }
            function getFrozenTrailingRowCount(obj) {
                return obj.frozenTrailingRowCount();
            }
            function frozenTrailingRowStickToEdge(obj) {
                return obj._frozenTrailingRowStickToEdge;
            }
            function frozenTrailingColumnStickToEdge(obj) {
                return obj._frozenTrailingColumnStickToEdge;
            }
            function getFrozenColumnCount(obj) {
                return obj.frozenColumnCount();
            }
            function getFrozenRowCount(obj) {
                return obj.frozenRowCount();
            }
            function composeConditionalFormattingFont(conditionalFormattingStyle, normalStyle) {
                var conditionalFormattingStyleFont = common_1.util._getFontObject(conditionalFormattingStyle.font);
                var normalStyleFont = common_1.util._getFontObject(normalStyle.font);
                return conditionalFormattingStyleFont.fontStyle + ' '
                    + conditionalFormattingStyleFont.fontWeight + ' '
                    + normalStyleFont.fontSize + ' '
                    + normalStyleFont.fontFamily;
            }
            function object_defineProperty(obj, pn, callback) {
                Object.defineProperty(obj, pn, {
                    get: function () {
                        return this['_' + pn];
                    },
                    set: function (value) {
                        var old = this['_' + pn];
                        if (old !== value) {
                            this['_' + pn] = value;
                            if (callback) {
                                callback(pn, value, old);
                            }
                        }
                    }
                });
            }

            var ClearPendingChangeType;
            (function (ClearPendingChangeType) {
                ClearPendingChangeType[ClearPendingChangeType['dirty'] = 1] = 'dirty';
                ClearPendingChangeType[ClearPendingChangeType['insert'] = 2] = 'insert';
                ClearPendingChangeType[ClearPendingChangeType['delete'] = 4] = 'delete';
            })(ClearPendingChangeType = exports.ClearPendingChangeType || (exports.ClearPendingChangeType = {}));
            function getDirtyValue(sheet, row, col, oldValue) {
                return {
                    row: row,
                    col: col,
                    newValue: sheet.getValue(row, col),
                    oldValue: oldValue
                };
            }
            var InvalidType;
            (function (InvalidType) {
                InvalidType[InvalidType['setFormula'] = 0] = 'setFormula';
                InvalidType[InvalidType['copyPaste'] = 1] = 'copyPaste';
                InvalidType[InvalidType['dragFill'] = 2] = 'dragFill';
                InvalidType[InvalidType['dragDrop'] = 3] = 'dragDrop';
                InvalidType[InvalidType['changePartOfArrayFormula'] = 4] = 'changePartOfArrayFormula';
                InvalidType[InvalidType['changeSheetName'] = 5] = 'changeSheetName';
                InvalidType[InvalidType['table'] = 6] = 'table';
                InvalidType[InvalidType['hideSheet'] = 7] = 'hideSheet';
                InvalidType[InvalidType['pivotTable'] = 8] = 'pivotTable';
                InvalidType[InvalidType['PTOverlapPT'] = 9] = 'PTOverlapPT';
            })(InvalidType = exports.InvalidType || (exports.InvalidType = {}));

            var defaultOptions = {
                rowHeaderVisible: true,
                colHeaderVisible: true,
                // 剪贴板选项
                clipBoardOptions: 0,
                frozenlineColor: cssBlack,
                rowHeaderAutoText: 1,
                colHeaderAutoText: 2,
                rowHeaderAutoTextIndex: -1,
                colHeaderAutoTextIndex: -1,
                sheetTabColor: keyword_null,
                selectionBackColor: keyword_null,
                selectionBorderColor: keyword_null,
                allowCellOverflow: true,
                showFormulas: false,
                // 工作表收到保护
                isProtected: false,
                protectionOptions: {},
                gridline: {},
                sheetAreaOffset: {
                    left: 0,
                    top: 0
                }
            };
            function _resetSheetRecalculatedStatus(parent) {
                if (!parent) {
                    return;
                }
                var sheets = parent.sheets;
                var len = sheets.length;
                var currentSheet;
                for (var i = 0; i < len; i++) {
                    currentSheet = sheets[i];
                    if (currentSheet._isRecalculated === true) {
                        delete currentSheet._isRecalculated;
                    }
                }
            }
            var Worksheet = (function () {
                function Worksheet(name) {
                    var self = this;
                    self._id = Worksheet._ID;
                    Worksheet._ID++;
                    self.options = createOptions(defaultOptions, function (pn, value, old) {
                        self._onOptionChanged(pn, value, old);
                    });
                    self._init(name);
                    self._tasks = new tasks_1.Tasks(function () {
                        return this.tasks.pop();
                    }, function () {
                        var wb = self.parent;
                        return ((wb && wb._scrollService._scrolling) || self._eventHandler._isWorking || self._eventHandler._isSelecting || self._eventHandler._isMouseDown);
                    });
                }
                Worksheet.prototype.sortRange = function (row, column, rowCount, columnCount, byRows, sortInfo, sortOption, undoSortArray, isNeedInvalidEvent) {
                    return false;
                };
                Worksheet.prototype._onOptionChanged = function (pn, value, old) {
                    var self = this;
                    var parent = self.parent;
                    switch (pn) {
                        case 'allowCellOverflow':
                        case 'showFormulas':
                        case 'colHeaderAutoText':
                        case 'colHeaderAutoTextIndex':
                        case 'colHeaderVisible':
                        case 'frozenlineColor':
                        case 'rowHeaderAutoText':
                        case 'rowHeaderAutoTextIndex':
                        case 'rowHeaderVisible':
                        case 'selectionBackColor':
                        case 'selectionBorderColor':
                            self._invalidate();
                            break;
                        case 'sheetAreaOffset':
                            var sheetAreaOffsetCallback_1 = function (prop, newValue) {
                                if (newValue < 0) {
                                    self.options.sheetAreaOffset[prop] = 0;
                                }
                                self._invalidate();
                            };
                            var sheetAreaOffsetObj_1 = self.options.sheetAreaOffset;
                            ['left', 'top'].forEach(function (prop) {
                                var oldPropertyValue = value[prop];
                                object_defineProperty(sheetAreaOffsetObj_1, prop, sheetAreaOffsetCallback_1);
                                sheetAreaOffsetObj_1[prop] = oldPropertyValue;
                            });
                            break;
                        case 'gridline':
                            var callback_1 = function () {
                                self._invalidate();
                            };
                            var gridlineObj_1 = self.options.gridline;
                            ['color', 'showHorizontalGridline', 'showVerticalGridline'].forEach(function (prop) {
                                var oldPropertyValue = value[prop];
                                object_defineProperty(gridlineObj_1, prop, callback_1);
                                gridlineObj_1[prop] = oldPropertyValue;
                            });
                            break;
                        case 'isProtected':
                            if (value) {
                                parent && parent.undoManager()._filter(function (item) {
                                    return item.sheetId !== self._id;
                                });
                            }
                            self._adjustActiveCellToSelectable();
                            Worksheet._callFeatureHandler(self, 'onProtectChanged');
                            self._invalidate();
                            break;
                        case 'protectionOptions':
                            self._adjustActiveCellToSelectable();
                            Worksheet._callFeatureHandler(self, '');
                            break;
                        case 'sheetTabColor':
                            parent && parent._doTabHSResize();
                            break;
                    }
                };
                Worksheet.prototype.name = function (value) {
                    var self = this;
                    var parent = self.parent;
                    if (arguments.length === 0) {
                        return self._modelManager ? self._modelManager.getName() : '';
                    }
                    if (!isValidSheetName(value, parent ? parent.sheets : null, self)) {
                        throw getSR().Exp_NotSupported;
                    }
                    self._setNameCore(value);
                    if (parent) {
                        parent._doTabHSResize();
                    }
                    return self;
                };
                Worksheet.prototype.isSelected = function (selectedState) {
                    return this._isSelectedImp(selectedState);
                };
                Worksheet.prototype._isSelectedImp = function (selectedState, triggerEvent) {
                    var self = this;
                    var spread = self.parent;
                    var currentSelectedState = self._modelManager ? self._modelManager._getSelectedState() : false;
                    if (isNullOrUndefined(selectedState)) {
                        return currentSelectedState;
                    }
                    if (selectedState !== currentSelectedState) {
                        var sheetName = self.name();
                        var sheetIndex = spread && spread.getSheetIndex(sheetName);
                        var args = void 0;
                        if (triggerEvent) {
                            args = {
                                oldValue: currentSelectedState,
                                newValue: selectedState,
                                sheetName: sheetName,
                                propertyName: 'isSelected',
                                cancel: false,
                                sheetIndex: sheetIndex
                            };
                            spread && spread._trigger(common_1.Events.SheetChanging, args);
                        }
                        if (!triggerEvent || (args && args.cancel === false)) {
                            self._modelManager._setSelectedState(selectedState);
                            spread && spread._tabStrip && spread._tabStrip.repaint();
                            if (triggerEvent) {
                                spread && spread._trigger(common_1.Events.SheetChanged, {
                                    oldValue: currentSelectedState,
                                    newValue: selectedState,
                                    sheetName: sheetName,
                                    propertyName: 'isSelected',
                                    sheetIndex: sheetIndex
                                });
                            }
                        }
                    }
                    return self;
                };
                Worksheet.prototype._setNameCore = function (name, isFromJSON) {
                    var self = this;
                    var oldName = self.name();
                    if (!isFromJSON) {
                        Worksheet._callFeatureHandler(self, 'beforeSetName', {
                            oldName: oldName,
                            newName: name
                        });
                    }
                    this._modelManager.do('setName', name);
                    if (!isFromJSON) {
                        Worksheet._callFeatureHandler(self, 'setName', {
                            oldName: oldName,
                            newName: name
                        });
                    }
                };
                Worksheet.prototype.addRows = function (row, count, rowExpand) {
                    if (count <= 0) {
                        return;
                    }
                    var self = this;
                    var oldRowCount = getRowCount(self);
                    if (row < 0 || row > oldRowCount) {
                        row = oldRowCount;
                    }
                    if (self._modelManager._inTransaction === 0) {
                        self.parent && self.parent._undoManager.clear();
                    }
                    self.suspendPaint();
                    try {
                        self._updateActiveCellState(false);
                        var args = {
                            changeType: 'addingRows',
                            row: row,
                            rowCount: count,
                            canAdd: true
                        };
                        Worksheet._callFeatureHandler(self, const_onLayoutChanged, args);
                        if (!args.canAdd) {
                            return;
                        }
                        if (!isNullOrUndefined(args.newRow)) {
                            row = args.newRow;
                        }
                        var changeType = 'addRows';
                        if (!self._raiseRowChanging(row, 3, changeType, count, oldRowCount)) {
                            return;
                        }
                        this._modelManager.do('addRows', row, count);
                        self._needSyncVScrollbarSize = true;
                        Worksheet._callFeatureHandler(self, const_onLayoutChanged, {
                            changeType: changeType,
                            row: row,
                            oldValue: oldRowCount,
                            rowCount: count,
                            rowExpand: rowExpand
                        });
                        Worksheet._callFeatureHandler(self, const_onLayoutChanged, {
                            changeType: 'addRows2',
                            row: row,
                            oldValue: oldRowCount,
                            rowCount: count
                        });
                        self.tables && self.tables._noticeChartUpdateTableRange(true, row);
                        self._raiseRowChanged(row, 3, changeType, count, oldRowCount);
                    } finally {
                        self._updateActiveCellState(true);
                        self.resumePaint();
                    }
                };
                Worksheet.prototype._updateActiveCellState = function (isAdd) {
                    var self = this;
                    var rowIndex = self._activeRowIndex;
                    var colIndex = self._activeColIndex;
                    self._modelManager.setCellState(rowIndex, colIndex, core_enum_1.CellStatesType.active, isAdd, core_enum_1.SheetArea.viewport);
                };
                Worksheet.prototype.deleteRows = function (row, count) {
                    var self = this;
                    var oldRowCount = getRowCount(self);
                    if (0 > row || row >= oldRowCount || count <= 0) {
                        return;
                    }
                    if (self._modelManager._inTransaction === 0) {
                        self.parent && self.parent._undoManager.clear();
                    }
                    self.suspendPaint();
                    try {
                        self._updateActiveCellState(false);
                        var args = {
                            changeType: 'deletingRows',
                            row: row,
                            rowCount: count,
                            canDelete: true
                        };
                        Worksheet._callFeatureHandler(self, const_onLayoutChanged, args);
                        if (!args.canDelete) {
                            return;
                        }
                        var changeType = 'deleteRows';
                        if (!self._raiseRowChanging(row, 3, changeType, count, oldRowCount)) {
                            return;
                        }
                        self._dispatchRangChangedIncludeTables(row, count, 0, this.getColumnCount());
                        self._modelManager.do('deleteRows', row, count);
                        var top_1 = self._scrollTopRow;
                        if (top_1 >= 0) {
                            var newTop = -1;
                            var frozenRowCount = getFrozenRowCount(self);
                            for (var t = top_1; t >= frozenRowCount; t--) {
                                if (self.getRowVisible(t) && self._getZoomRowHeight(t) > 0) {
                                    newTop = t;
                                    break;
                                }
                            }
                            if (newTop === -1) {
                                newTop = 0;
                            }
                            if (top_1 !== newTop) {
                                self._setTopRow(newTop);
                            }
                        }

                        var rowCount = oldRowCount;
                        if (self.getActiveRowIndex() >= rowCount) {
                            self.setActiveCell(rowCount - 1, self.getActiveColumnIndex());
                        }
                        self._needSyncVScrollbarSize = true;
                        Worksheet._callFeatureHandler(self, const_onLayoutChanged, {
                            changeType: changeType,
                            row: row,
                            oldValue: oldRowCount,
                            rowCount: count
                        });
                        self.tables && self.tables._noticeChartUpdateTableRange(true, row);
                        self._raiseRowChanged(row, 3, changeType, count, oldRowCount);
                    } finally {
                        self._updateActiveCellState(true);
                        self.resumePaint();
                    }
                };
                Worksheet.prototype.addColumns = function (col, count) {
                    if (count <= 0) {
                        return;
                    }
                    var self = this;
                    var oldColCount = getColumnCount(self);
                    if (col < 0 || col > oldColCount) {
                        col = oldColCount;
                    }
                    if (self._modelManager._inTransaction === 0) {
                        self.parent && self.parent._undoManager.clear();
                    }
                    var args = {
                        changeType: 'addingColumns',
                        col: col,
                        colCount: count,
                        canAdd: true
                    };
                    Worksheet._callFeatureHandler(self, const_onLayoutChanged, args);
                    if (!args.canAdd) {
                        return;
                    }
                    self._updateActiveCellState(false);
                    var changeType = 'addColumns';
                    if (!self._raiseColumnChanging(col, 3, changeType, count, oldColCount)) {
                        return;
                    }
                    self._modelManager.do('addColumns', col, count);
                    self._needSyncHScrollbarSize = true;
                    Worksheet._callFeatureHandler(self, const_onLayoutChanged, {
                        changeType: changeType,
                        col: col,
                        oldValue: oldColCount,
                        colCount: count
                    });
                    Worksheet._callFeatureHandler(self, const_onLayoutChanged, {
                        changeType: 'addColumns2',
                        col: col,
                        oldValue: oldColCount,
                        colCount: count
                    });
                    self.tables && self.tables._noticeChartUpdateTableRange(false, col);
                    self._raiseColumnChanged(col, 3, changeType, count, oldColCount);
                    self._updateActiveCellState(true);
                    self._invalidate();
                };
                Worksheet.prototype.deleteColumns = function (col, count) {
                    var self = this;
                    var oldColCount = getColumnCount(self);
                    if (0 > col || col >= oldColCount || count <= 0) {
                        return;
                    }
                    if (self._modelManager._inTransaction === 0) {
                        self.parent && self.parent._undoManager.clear();
                    }
                    var args = {
                        changeType: 'deletingColumns',
                        col: col,
                        colCount: count,
                        canDelete: true
                    };
                    Worksheet._callFeatureHandler(self, const_onLayoutChanged, args);
                    if (!args.canDelete) {
                        return;
                    }
                    self._updateActiveCellState(false);
                    var changeType = 'deleteColumns';
                    self._dispatchRangChangedIncludeTables(0, this.getRowCount(), col, count);
                    if (!self._raiseColumnChanging(col, 3, changeType, count, oldColCount)) {
                        return;
                    }
                    self._modelManager.do('deleteColumns', col, count);
                    var left = self._scrollLeftCol;
                    if (left >= 0) {
                        var newLeft = -1;
                        var frozenColCount = getFrozenColumnCount(self);
                        for (var t = left; t >= frozenColCount; t--) {
                            if (self.getColumnVisible(t) && self._getZoomColumnWidth(t) > 0) {
                                newLeft = t;
                                break;
                            }
                        }
                        if (newLeft === -1) {
                            newLeft = 0;
                        }
                        if (left !== newLeft) {
                            self._setLeftColumn(newLeft);
                        }
                    }
                    var columnCount = oldColCount;
                    if (self.getActiveColumnIndex() >= columnCount) {
                        self.setActiveCell(self.getActiveRowIndex(), columnCount - 1);
                    }
                    self._needSyncHScrollbarSize = true;
                    Worksheet._callFeatureHandler(self, const_onLayoutChanged, {
                        changeType: changeType,
                        col: col,
                        oldValue: oldColCount,
                        colCount: count
                    });
                    Worksheet._callFeatureHandler(self, const_onLayoutChanged, {
                        changeType: 'deleteColumns2',
                        col: col,
                        oldValue: oldColCount,
                        colCount: count
                    });
                    self.tables && self.tables._noticeChartUpdateTableRange(false, col);
                    self._raiseColumnChanged(col, 3, changeType, count, oldColCount);
                    self._updateActiveCellState(true);
                    self._invalidate();
                };
                // 获取或设置工作表的尾随冻结行数
                Worksheet.prototype.frozenTrailingRowCount = function (rowCount, stickToEdge) {
                    var self = this;
                    if (arguments.length === 0) {
                        return self._frozenTrailingRowCount;
                    }
                    if (rowCount >= 0) {
                        if (isNullOrUndefined(stickToEdge)) {
                            stickToEdge = true;
                        }
                        self._frozenTrailingRowCount = rowCount;
                        self._frozenTrailingRowStickToEdge = stickToEdge;
                        self._needSyncVScrollbarSize = true;
                        self._invalidate();
                    }
                    return self;
                };
                Worksheet.prototype.frozenTrailingColumnCount = function (colCount, stickToEdge) {
                    var self = this;
                    if (arguments.length === 0) {
                        return self._frozenTrailingColumnCount;
                    }
                    if (colCount >= 0) {
                        if (isNullOrUndefined(stickToEdge)) {
                            stickToEdge = true;
                        }
                        self._frozenTrailingColumnCount = colCount;
                        self._frozenTrailingColumnStickToEdge = stickToEdge;
                        self._needSyncHScrollbarSize = true;
                        self._invalidate();
                    }
                    return self;
                };
                Worksheet.prototype.getFrozenTrailingState = function (isRow) {
                    var self = this;
                    return isRow ? self._frozenTrailingRowStickToEdge : self._frozenTrailingColumnStickToEdge;
                };
                Worksheet.prototype._getActualViewportWidth = function (layout) {
                    var isFrozenTrailingColumnStickToEdge = frozenTrailingColumnStickToEdge(this);
                    var viewportWidth = layout._viewportWidth;
                    return isFrozenTrailingColumnStickToEdge ? viewportWidth + layout._grayAreaWidth : viewportWidth;
                };
                Worksheet.prototype._getActualViewportHeight = function (layout) {
                    var isFrozenTrailingRowStickToEdge = frozenTrailingRowStickToEdge(this);
                    var viewportHeight = layout._viewportHeight;
                    return isFrozenTrailingRowStickToEdge ? viewportHeight + layout._grayAreaHeight : viewportHeight;
                };
                Worksheet.prototype.getRowCount = function (sheetArea) {
                    if (sheetArea === 0) {
                        return 0;
                    }
                    return this._modelManager.getRowCount(sheetArea);
                };
                Worksheet.prototype.getColumnCount = function (sheetArea) {
                    if (sheetArea === 0) {
                        return 0;
                    }
                    return this._modelManager.getColumnCount(sheetArea);
                };
                Worksheet.prototype.setRowCount = function (rowCount, sheetArea) {
                    if (isNullOrUndefined(sheetArea)) {
                        sheetArea = 3;
                    }
                    var self = this;
                    var args = {
                        changeType: 'settingRowCount',
                        rowCount: rowCount,
                        sheetArea: sheetArea,
                        canSet: true
                    };
                    Worksheet._callFeatureHandler(self, const_onLayoutChanged, args);
                    if (!args.canSet) {
                        return;
                    }
                    self.setRowCountCore(rowCount, sheetArea);
                };
                Worksheet.prototype.setRowCountCore = function (rowCount, sheetArea) {
                    rowCount = convertToInt(rowCount, 10);
                    if (isNotANumber(rowCount)) {
                        return;
                    }
                    if (isNullOrUndefined(sheetArea)) {
                        sheetArea = 3;
                    }
                    var self = this;
                    var dataModelRowCount = self.getRowCount(sheetArea);
                    if (rowCount < 0 || rowCount === dataModelRowCount) {
                        return;
                    }
                    if (sheetArea === 3 || sheetArea === 2) {
                        self._modelManager.do('setRowCount', rowCount, sheetArea);
                        if (getFrozenRowCount(self) > rowCount) {
                            self.frozenRowCount(rowCount);
                        }
                    } else if (sheetArea === 1) {
                        self._modelManager.do('setRowCount', rowCount, sheetArea);
                    }
                    Worksheet._callFeatureHandler(self, const_onLayoutChanged, {
                        changeType: 'setRowCount',
                        rowCount: rowCount,
                        sheetArea: sheetArea
                    });
                    self._needSyncVScrollbarSize = true;
                    if (self._activeRowIndex >= rowCount && (sheetArea === 3 || sheetArea === 2)) {
                        self.setActiveCell(rowCount - 1, self.getActiveColumnIndex());
                    }
                    self._invalidate();
                    self.clearPendingChanges();
                };
                Worksheet.prototype.setColumnCount = function (colCount, sheetArea) {
                    colCount = convertToInt(colCount, 10);
                    if (isNotANumber(colCount)) {
                        return;
                    }
                    var self = this;
                    var dataModelColumnCount = self.getColumnCount(sheetArea);
                    if (colCount < 0 || colCount === dataModelColumnCount) {
                        return;
                    }
                    if (isNullOrUndefined(sheetArea)) {
                        sheetArea = 3;
                    }
                    if (sheetArea === 3 || sheetArea === 1) {
                        self._modelManager.do('setColumnCount', colCount, sheetArea);
                        if (getFrozenColumnCount(self) > colCount) {
                            self.frozenColumnCount(colCount);
                        }
                    } else if (sheetArea === 2) {
                        self._modelManager.do('setColumnCount', colCount, sheetArea);
                    }
                    Worksheet._callFeatureHandler(self, const_onLayoutChanged, {
                        changeType: 'setColumnCount',
                        colCount: colCount,
                        sheetArea: sheetArea
                    });
                    self._needSyncHScrollbarSize = true;
                    if (self._activeColIndex >= colCount && (sheetArea === 3 || sheetArea === 1)) {
                        self.setActiveCell(self.getActiveRowIndex(), colCount - 1);
                    }
                    self._invalidate();
                    self.clearPendingChanges();
                };
                Worksheet.prototype._getFormatStringResult = function (row, col, formatter) {
                    var self = this;
                    if (!SheetsCalc) {
                        SheetsCalc = __webpack_require__(/*! SheetsCalc */ 'SheetsCalc');
                    }
                    if (SheetsCalc) {
                        var formatStringCustomName = typeof formatter === 'string' && self.parent && self.parent._getFormatStringCustomName(formatter);
                        if (formatStringCustomName && row !== -1 && col !== -1) {
                            var expression = formatStringCustomName.getExpression();
                            return SheetsCalc.evaluateExpression(self, expression, row, col);
                        }
                    }
                    return keyword_undefined;
                };
                Worksheet.prototype._getTextForShowFormulasMode = function (row, col, sheetArea) {
                    var self = this;
                    if (self.options.showFormulas && sheetArea === 3) {
                        var f = self.getFormula(row, col);
                        if (f) {
                            if (f[0] !== '=') {
                                f = '=' + f;
                            }
                            return f;
                        }
                        var info = self._modelManager && self._modelManager._dynamicArrayManager && self._modelManager._dynamicArrayManager.getAnchorInfo(row, col);
                        if (info) {
                            return '';
                        }
                    }
                };
                Worksheet.prototype.getText = function (row, col, sheetArea) {
                    if (isNullOrUndefined(sheetArea)) {
                        sheetArea = 3;
                    }
                    var self = this;
                    var formula = self._getTextForShowFormulasMode(row, col, sheetArea);
                    if (!isNullOrUndefined(formula)) {
                        return formula;
                    }
                    var ct = self.getCellType(row, col, sheetArea);
                    var v = self.getValue(row, col, sheetArea);
                    var fmt = self._getStyleProperty(row, col, 'formatter', sheetArea);
                    if (!fmt) {
                        fmt = self._getStyleProperty(row, col, '_autoFormatter', sheetArea);
                    }
                    var formattedData = {};
                    var quotePrefix = self._getStyleProperty(row, col, 'quotePrefix', sheetArea);
                    v = ct.format(v, fmt, formattedData, {
                        sheet: self,
                        row: row,
                        col: col,
                        sheetArea: sheetArea,
                        quotePrefix: quotePrefix
                    });
                    if (v && typeof v === 'string') {
                        v = v.replace(/\r\n?/g, '\n');
                    }
                    return v;
                };
                Worksheet.prototype.setText = function (row, col, value, sheetArea) {
                    var self = this;
                    if (isNullOrUndefined(sheetArea)) {
                        sheetArea = 3;
                    }
                    var tempText = value;
                    var arg = {
                        value: value
                    };
                    Worksheet._callFeatureHandler(self, 'settingText', arg);
                    value = arg.value;
                    var t = value;
                    var ct = self.getCellType(row, col, sheetArea);
                    var formatStr = self.getFormatter && self.getFormatter(row, col, sheetArea);
                    if (ct && formatStr && !isFormatString(formatStr)) {
                        var context = {
                            sheet: self,
                            row: row,
                            col: col,
                            sheetArea: sheetArea
                        };
                        t = ct.parse(tempText, formatStr, context);
                        t = isNullOrUndefined(t) ? value : t;
                    }
                    self._setValueInternal(row, col, t, sheetArea);
                    self._invalidate();
                };
                Worksheet.prototype.getValue = function (row, col, sheetArea, valueType) {
                    if (sheetArea === 0) {
                        return keyword_null;
                    }
                    if (isNullOrUndefined(sheetArea)) {
                        sheetArea = 3;
                    }
                    var self = this;
                    var options = self.options;
                    var modelManager = self._modelManager;
                    var rowCount = modelManager.getRowCount(sheetArea);
                    var columnCount = modelManager.getColumnCount(sheetArea);
                    var t = self._getValueImp(modelManager, row, col, sheetArea, valueType);
                    var index;
                    if (sheetArea === 1) {
                        if (isNullOrUndefined(t)) {
                            var bm = self._bindingManager;
                            if (bm && bm._dataSource) {
                                var ci = self._modelManager._getItem(false, 3, col);
                                var colHeaderAutoTextIndex = options.colHeaderAutoTextIndex;
                                if (ci && ((colHeaderAutoTextIndex >= 0 && row === colHeaderAutoTextIndex) || (colHeaderAutoTextIndex === -1 && row === (rowCount - 1)))) {
                                    t = ci.displayName || ci.name;
                                }
                            }
                            if (isNullOrUndefined(t)) {
                                index = options.colHeaderAutoTextIndex;
                                if (index < 0 || index >= rowCount) {
                                    index = rowCount - 1;
                                }
                                if (row === index) {
                                    var colHeaderAutoText = options.colHeaderAutoText;
                                    if (colHeaderAutoText === 2) {
                                        t = common_1.util._indexToLetters(col + 1);
                                    } else if (colHeaderAutoText === 1) {
                                        t = col + 1;
                                    }
                                }
                            }
                        }
                    } else if (sheetArea === 2 && isNullOrUndefined(t)) {
                        index = options.rowHeaderAutoTextIndex;
                        if (index < 0 || index >= columnCount) {
                            index = columnCount - 1;
                        }
                        if (col === index) {
                            var rowHeaderAutoText = options.rowHeaderAutoText;
                            if (rowHeaderAutoText === 2) {
                                t = common_1.util._indexToLetters(row + 1);
                            } else if (rowHeaderAutoText === 1) {
                                t = row + 1;
                            }
                        }
                    }
                    return t;
                };
                Worksheet.prototype.setValue = function (row, col, value, sheetArea, ignoreRecalc) {
                    this._setValueInternal(row, col, value, sheetArea, ignoreRecalc);
                    var parent = this.parent;
                    var activeSheet = parent && parent.getActiveSheet();
                    if (activeSheet && activeSheet._isRecalculated === true) {
                        activeSheet._invalidate();
                    } else {
                        this._invalidate();
                    }
                    _resetSheetRecalculatedStatus(parent);
                };
                Worksheet.prototype._postSetValue = function (row, col, sheetArea, ignoreRecalc) {
                    var self = this;
                    if (!ignoreRecalc && _supportsCalc) {
                        self._recalcCell(row, col, sheetArea);
                    }
                    self._updateTableSlicer && self._updateTableSlicer(row, col, 1, 1, sheetArea);
                };
                Worksheet.prototype._clearConditionalFormatsCache = function () {
                    var conditionalFormats = this.conditionalFormats;
                    if (conditionalFormats) {
                        conditionalFormats._clearCache();
                    }
                };
                Worksheet.prototype._clearCameraShapeCache = function (currentSheet, changedCells, changeType) {
                    if (!(currentSheet && currentSheet.parent && currentSheet.parent.sheets)) {
                        return;
                    }
                    var sheets = currentSheet.parent.sheets;
                    var sheetName = currentSheet.name();
                    sheets.forEach(function (sheet) {
                        var cameraShapes = sheet.cameraShapes;
                        if (cameraShapes && cameraShapes.length > 0) {
                            cameraShapes.forEach(function (shape) {
                                if (shape.cameraImageCache) {
                                    var wrapper = shape._shapeWrapper;
                                    var rangeInfo = wrapper._shapeData._sourceRangeInfo;
                                    if (
                                        rangeInfo
                                        && (
                                            sheet.name() === sheetName
                                            || (rangeInfo.sheet && rangeInfo.sheet.name() === sheetName)
                                        )
                                    ) {
                                        for (var i = 0; i < changedCells.length; i++) {
                                            var cellRange = rangeInfo.cellRange;
                                            if (
                                                changedCells[i].row !== undefined
                                                && changedCells[i].col === undefined && changeType === 2
                                            ) {
                                                if (
                                                    changedCells[i].row >= cellRange.row
                                                    && changedCells[i].row < cellRange.row + cellRange.rowCount
                                                ) {
                                                    shape.cameraImageCache = null;
                                                    wrapper._shapeData._shouldUpdateSize && wrapper._updateSize();
                                                    break;
                                                }
                                            }
                                            if (
                                                changedCells[i].row === undefined
                                                && changedCells[i].col !== undefined
                                                && changeType === 1
                                            ) {
                                                if (
                                                    changedCells[i].col >= cellRange.col
                                                    && changedCells[i].col < cellRange.col + cellRange.colCount
                                                ) {
                                                    shape.cameraImageCache = null;
                                                    wrapper._shapeData._shouldUpdateSize && wrapper._updateSize();
                                                    break;
                                                }
                                            }
                                            if (changeType === 0) {
                                                if (
                                                    changedCells[i].rowCount === undefined
                                                    && changedCells[i].colCount === undefined
                                                    && cellRange.contains(changedCells[i].row, changedCells[i].col)
                                                ) {
                                                    shape.cameraImageCache = null;
                                                    break;
                                                }
                                                if (
                                                    changedCells[i].rowCount !== undefined
                                                    && changedCells[i].colCount !== undefined
                                                    && cellRange.intersect(changedCells[i].row, changedCells[i].col, changedCells[i].rowCount, changedCells[i].colCount)
                                                ) {
                                                    shape.cameraImageCache = null;
                                                    break;
                                                }
                                            }
                                        }
                                    }
                                }
                            });
                        }
                    });
                };
                Worksheet.prototype._setValueInternal = function (row, col, value, sheetArea, ignoreRecalc) {
                    if (sheetArea === 0) {
                        return;
                    }
                    if (isNullOrUndefined(sheetArea)) {
                        sheetArea = 3;
                    }
                    var self = this;
                    var modelManager = self._modelManager;
                    var rowCount = modelManager.getRowCount(sheetArea);
                    var colCount = modelManager.getColumnCount(sheetArea);
                    if (row < 0 || row >= rowCount || col < 0 || col >= colCount) {
                        return;
                    }
                    value = tryConvertDateToOADate(value);
                    value = tryAddCacheToRichText(value);
                    modelManager.do('setValue', row, col, value, sheetArea);
                    self._postSetValue(row, col, sheetArea, ignoreRecalc);
                    self._clearConditionalFormatsCache();
                };
                Worksheet.prototype._getActualStyleImp = function (row, column, sheetArea, sheetStyleOnly, notClone, isForFilter) {
                    var self = this;
                    var resultStyle;
                    resultStyle = self.getActualStyle(row, column, sheetArea, sheetStyleOnly, notClone, isForFilter);
                    _composeTableFooterStyle(self, row, column, resultStyle, sheetArea);
                    return resultStyle;
                };
                Worksheet.prototype.getActualStyle = function (row, column, sheetArea, sheetStyleOnly, notClone, isForFilter, ignoreSheet) {
                    if (isNullOrUndefined(sheetArea)) {
                        sheetArea = 3;
                    }
                    if (sheetArea === 0) {
                        return new style_1.Style();
                    }
                    if (row === -1 && column === -1) {
                        return this.getDefaultStyle(sheetArea);
                    }
                    var self = this;
                    var info;
                    var composedStyle;
                    var cellStyle;
                    var rowStyle;
                    var colStyle;
                    var cache = self._styleComposeCache;
                    var cellCache;
                    var cellStyleForConditionalFormats;
                    var rowCache;
                    var colCache;
                    var sheetAreaCache;
                    var cellStyleKey;
                    var rowStyleKey;
                    var colStyleKey;
                    var STR__SPREADJSDEFAULT = '__spreadJSDefault';
                    var STR__UNDEFINED = '__undefined';
                    var modelManager = this._modelManager;
                    var pivotTable;
                    var pivotTableStyle;
                    if (sheetArea === 3 && self.pivotTables) {
                        pivotTable = self.pivotTables.findPivotTable(row, column) || keyword_null;
                        pivotTableStyle = pivotTable && pivotTable._getStyleByRange(row, column);
                    }
                    cellStyle = modelManager.getStyle(row, column, sheetArea);
                    rowStyle = modelManager.getStyle(row, -1, sheetArea);
                    colStyle = modelManager.getStyle(-1, column, sheetArea);
                    cellStyle = cellStyle ? cellStyle : keyword_null;
                    rowStyle = rowStyle ? rowStyle : keyword_null;
                    colStyle = colStyle ? colStyle : keyword_null;
                    if (ignoreSheet) {
                        if (row === -1) {
                            rowStyle = keyword_null;
                        }
                        if (column === -1) {
                            colStyle = keyword_null;
                        }
                    }
                    cellStyleKey = STR__UNDEFINED;
                    var isPrint = self.parent && self.parent._isPrintWorkbook;
                    if (cellStyle) {
                        cellStyleKey = cellStyle.charAt ? cellStyle : STR__SPREADJSDEFAULT + cellStyle._id;
                    }
                    rowStyleKey = STR__UNDEFINED;
                    if (rowStyle) {
                        rowStyleKey = rowStyle.charAt ? rowStyle : STR__SPREADJSDEFAULT + rowStyle._id;
                    }
                    colStyleKey = STR__UNDEFINED;
                    if (colStyle) {
                        colStyleKey = colStyle.charAt ? colStyle : STR__SPREADJSDEFAULT + colStyle._id;
                    }
                    sheetAreaCache = cache[sheetArea];
                    cellCache = sheetAreaCache[cellStyleKey];
                    var tables = self.tables;
                    var table = (sheetArea === 3 && tables && !isForFilter) ? tables.find(row, column) : keyword_null;
                    if (!table && !pivotTable) {
                        if (!cellCache) {
                            cellCache = sheetAreaCache[cellStyleKey] = {};
                        }
                        rowCache = cellCache[rowStyleKey];
                        if (!rowCache) {
                            rowCache = cellCache[rowStyleKey] = {};
                        } else {
                            colCache = rowCache[colStyleKey];
                        }
                    }
                    if (!colCache) {
                        composedStyle = self.getCompositeStyle(row, column, sheetArea, cellStyle, rowStyle, colStyle, table, keyword_undefined, isForFilter, pivotTableStyle, ignoreSheet, pivotTable);
                    }
                    if (sheetArea === 3 && !sheetStyleOnly) {
                        var conditionalFormats = self.conditionalFormats;
                        if (conditionalFormats) {
                            info = conditionalFormats._applyFormats(info, row, column, sheetArea);
                        }
                        if ((isNullOrUndefined(info) || isNullOrUndefined(info.foreColor))) {
                            var f = (info && info.formatter) || (colCache && colCache.formatter) || (composedStyle && composedStyle.formatter);
                            if (f && !isForFilter && !isFormatString(f)) {
                                try {
                                    var GeneralFormatter = Common_1.Formatter && Common_1.Formatter.GeneralFormatter;
                                    if (GeneralFormatter && typeof f === const_string) {
                                        f = common_1._CacheMgr._getFormatter(f);
                                    }
                                } catch (e) { }
                                if (f.hasFormatedColor && f.hasFormatedColor() || Common_1.Formatter && f instanceof Common_1.Formatter.FormatterBase) {
                                    var clr = { conditionalForeColor: keyword_null };
                                    f.format(self.getValue(row, column), clr);
                                    if (clr.conditionalForeColor) {
                                        if (isNullOrUndefined(info)) {
                                            info = new style_1.Style();
                                        }
                                        info.foreColor = clr.conditionalForeColor;
                                    }
                                }
                            }
                        }
                    }
                    if (info) {
                        cellStyleForConditionalFormats = colCache ? colCache : composedStyle;
                        info._compose(cellStyleForConditionalFormats);
                        if (info && info.font && cellStyleForConditionalFormats && cellStyleForConditionalFormats.font && info.font !== cellStyleForConditionalFormats.font) {
                            info.font = composeConditionalFormattingFont(info, cellStyleForConditionalFormats);
                        }
                        composedStyle = info;
                    } else if (colCache) {
                        if (self.cellStates && !sheetStyleOnly && !isPrint) {
                            var cellStateStyle = self.cellStates.getStyle(row, column, sheetArea, keyword_null, colCache.locked);
                            if (cellStateStyle) {
                                cellStateStyle._compose(colCache);
                                colCache = cellStateStyle;
                                colCache._normalize(self._currentTheme);
                            }
                        }
                        return notClone ? colCache : colCache.clone(true);
                    }
                    if (!ignoreSheet) {
                        if (isNullOrUndefined(composedStyle.locked)) {
                            composedStyle.locked = true;
                        }
                        composedStyle = composedStyle._normalize(self._currentTheme);
                    }
                    if (!info && !table && !pivotTable) {
                        rowCache[colStyleKey] = composedStyle.clone(true);
                    }
                    if (self.cellStates && !sheetStyleOnly && !isPrint) {
                        var readOnlyStyle = self.cellStates.getStyle(row, column, sheetArea, keyword_null, composedStyle.locked);
                        if (readOnlyStyle) {
                            readOnlyStyle._compose(composedStyle);
                            composedStyle = readOnlyStyle;
                            composedStyle = composedStyle._normalize(self._currentTheme);
                        }
                    }
                    return composedStyle;
                };
                Worksheet.prototype._getStyleProperty = function (row, col, property, sheetArea) {
                    if (sheetArea === 0) {
                        return keyword_undefined;
                    }
                    if (isNullOrUndefined(sheetArea)) {
                        sheetArea = 3;
                    }
                    var self = this;
                    var s;
                    var parentName;
                    var temp;
                    var modelManager = self._modelManager;
                    var result;
                    var hasResult = false;
                    var themeFont;
                    if (sheetArea === 3) {
                        if (property === 'foreColor') {
                            var f = self._getStyleProperty(row, col, 'formatter', sheetArea);
                            try {
                                var GeneralFormatter = Common_1.Formatter && Common_1.Formatter.GeneralFormatter;
                                if (GeneralFormatter && typeof f === const_string) {
                                    f = common_1._CacheMgr._getFormatter(f);
                                }
                            } catch (e) { }
                            if (
                                f
                                && (
                                    f.hasFormatedColor
                                    && f.hasFormatedColor()
                                    || Common_1.Formatter
                                    && f instanceof Common_1.Formatter.FormatterBase
                                )
                            ) {
                                var clr = {
                                    conditionalForeColor: keyword_null
                                };
                                f.format(self.getValue(row, col), clr);
                                if (clr.conditionalForeColor) {
                                    result = clr.conditionalForeColor;
                                    hasResult = true;
                                }
                            }
                        }
                        var conditionalFormats = self.conditionalFormats;
                        if (conditionalFormats && (conditionalFormats.count() > 0)) {
                            var cs = conditionalFormats._getConditionalStyle(row, col, property, sheetArea);
                            hasResult = cs._hasResult;
                            result = cs._result;
                        }
                    }
                    var level = 0;
                    while (!hasResult && level <= 4) {
                        if (level === 0) {
                            s = modelManager.getStyle(row, col, sheetArea);
                        } else if (level === 1) {
                            var tables = self.tables, table = (sheetArea === 3 && tables) ? tables.find(row, col) : keyword_null;
                            if (table && tableStyleProperties[property]) {
                                s = table._getStyle(row, col, property);
                            }
                        } else if (level === 2) {
                            s = modelManager.getStyle(row, -1, sheetArea);
                        } else if (level === 3) {
                            s = modelManager.getStyle(-1, col, sheetArea);
                        } else {
                            s = self.getDefaultStyle(sheetArea);
                        }
                        level++;
                        if (s && s.charAt && (typeof s === const_string)) {
                            s = self._name2Style(s);
                        }
                        if (!s) {
                            continue;
                        }
                        if (property === 'font' && s.themeFont && !themeFont) {
                            themeFont = s.themeFont;
                        }
                        if (s[property] !== keyword_undefined) {
                            result = s[property];
                            hasResult = true;
                            break;
                        }
                        parentName = s.parentName;
                        while (parentName) {
                            temp = self._name2Style(parentName);
                            if (!temp) {
                                break;
                            }
                            if (temp[property] !== keyword_undefined) {
                                result = temp[property];
                                hasResult = true;
                                break;
                            }
                            parentName = temp.parentName;
                        }
                    }
                    if (property === 'locked') {
                        return (isNullOrUndefined(result)) ? true : result;
                    } else if (hasResult || themeFont) {
                        if (property === 'foreColor' || property === 'backColor' || property === 'font' ||
                            property === 'borderLeft' || property === 'borderTop' || property === 'borderRight' || property === 'borderBottom') {
                            s = new style_1.Style();
                            s[property] = result;
                            if (property === 'font' && themeFont) {
                                s.themeFont = themeFont;
                            }
                            s._normalize(self._currentTheme);
                            result = s[property];
                        }
                        return result;
                    }
                    return keyword_undefined;
                };
                Worksheet.prototype.getStyle = function (row, col, sheetArea) {
                    return this._getStyleImp(row, col, sheetArea, true);
                };
                Worksheet.prototype._getStyleImp = function (row, col, sheetArea, clearCache) {
                    if (isNullOrUndefined(sheetArea)) {
                        sheetArea = 3;
                    }
                    if (sheetArea !== 0) {
                        var modelManager = this._modelManager;
                        var result = modelManager.getStyle(row, col, sheetArea);
                        if (result instanceof style_1.Style) {
                            if (clearCache) {
                                this._clearStyleCache();
                            }
                            return result;
                        } else if (typeof (result) === const_string) {
                            var namedStyle = this._name2Style(result);
                            if (namedStyle !== keyword_null && namedStyle !== keyword_undefined) {
                                var tmp = new style_1.Style();
                                tmp._compose(namedStyle, false);
                                if (clearCache) {
                                    this._clearStyleCache();
                                }
                                return tmp;
                            }
                        }
                    }
                    return keyword_null;
                };
                Worksheet.prototype.addNamedStyle = function (style) {
                    this._addNamedStyleImp(style);
                    this._invalidate();
                };
                Worksheet.prototype._addNamedStyleImp = function (style) {
                    if (style) {
                        if (!style.name) {
                            throw new Error(getSR().Exp_EmptyNamedStyle);
                        }
                        var name_1 = style.name.toUpperCase();
                        this._namedStyles[name_1] = style;
                    }
                };
                Worksheet.prototype.getNamedStyle = function (name) {
                    return this._getNamedStyleImp(name, true);
                };
                Worksheet.prototype._getNamedStyleImp = function (name, clearCache) {
                    var namedStyles = this._namedStyles;
                    if (namedStyles && name) {
                        name = name.toUpperCase();
                        var result = namedStyles[name];
                        if (result && clearCache) {
                            this._clearStyleCache();
                        }
                        return result;
                    }
                    return keyword_null;
                };
                Worksheet.prototype._clearStyleCache = function () {
                    this._styleComposeCache = [{}, {}, {}, {}];
                };
                Worksheet.prototype.removeNamedStyle = function (name) {
                    var namedStyles = this._namedStyles;
                    if (namedStyles && name) {
                        name = name.toUpperCase();
                        if (hasOwnProperty(namedStyles, name)) {
                            var formatter = namedStyles[name].formatter;
                            if (formatter && typeof (formatter) === 'string' && this.parent._formatStringCustomNameInfos[formatter]) {
                                this.parent._removeFormatStringCustomName(formatter);
                            }
                            delete namedStyles[name];
                            this._clearStyleCache();
                            this._invalidate();
                        }
                    }
                };
                Worksheet.prototype.getNamedStyles = function () {
                    var namedStylesClone = [];
                    var namedStyles = this._namedStyles;
                    if (namedStyles) {
                        $_each(namedStyles, function (index, item) {
                            namedStylesClone.push(item);
                        });
                    }
                    this._clearStyleCache();
                    return namedStylesClone;
                };
                Worksheet.prototype.setStyle = function (row, col, value, sheetArea) {
                    if (isNullOrUndefined(sheetArea)) {
                        sheetArea = 3;
                    }
                    if (value && value.backColor && typeof value.backColor === 'object') {
                        stylehelper_1._StyleHelper.processStops(value.backColor);
                    }
                    var self = this;
                    self._setStyleObject(row, col, value, sheetArea);
                    if (row === -1 && col === -1) {
                        self._composedDefaultStyle[sheetArea] = keyword_null;
                    }
                    if (row === -1 || col === -1) {
                        var validator = value && value.validator;
                        if (validator && (validator.condition() && validator.condition().conType() === 4)) {
                            validator.condition().getExpected(this, row < 0 ? 0 : row, col < 0 ? 0 : col);
                        }
                    }
                    self._clearStyleCache();
                    self._invalidate();
                };
                Worksheet.prototype._setStyleWithoutLocked = function (row, col, value, sheetArea) {
                    var self = this;
                    if (!self.options.isProtected) {
                        self.setStyle(row, col, value, sheetArea);
                    } else {
                        var oldStyle = self.getStyle(row, col, sheetArea);
                        var oldLocked = void 0;
                        if (value) {
                            oldLocked = oldStyle ? oldStyle.locked : keyword_undefined;
                            if (value.locked !== oldLocked) {
                                value.locked = oldLocked;
                            }
                            self.setStyle(row, col, value, sheetArea);
                        } else if (oldStyle) {
                            oldLocked = oldStyle.locked;
                            if (oldLocked !== keyword_undefined) {
                                value = new style_1.Style();
                                value.locked = oldLocked;
                            }
                            self.setStyle(row, col, value, sheetArea);
                        }
                    }
                };
                Worksheet.prototype.getStyleName = function (row, col, sheetArea) {
                    var style = this._getStyleObject(row, col, sheetArea);
                    if (style instanceof style_1.Style) {
                        return style.name;
                    }
                    return style;
                };
                Worksheet.prototype.setStyleName = function (row, col, value, sheetArea) {
                    if (typeof value === const_string) {
                        this._setStyleObject(row, col, value, sheetArea);
                        this._invalidate();
                    }
                };
                Worksheet.prototype._getStyleObject = function (row, col, sheetArea) {
                    if (isNullOrUndefined(sheetArea)) {
                        sheetArea = 3;
                    }
                    var result;
                    if (sheetArea !== 0) {
                        result = this._modelManager.getStyle(row, col, sheetArea);
                    }
                    return result || keyword_null;
                };
                Worksheet.prototype.getNamedStyleName = function (row, col, sheetArea) {
                    var styleObject = this._getStyleObject(row, col, sheetArea);
                    if (typeof styleObject === 'string') {
                        return styleObject;
                    } else {
                        return keyword_undefined;
                    }
                };
                Worksheet.prototype._setStyleObject = function (row, col, value, sheetArea) {
                    if (isNullOrUndefined(sheetArea)) {
                        sheetArea = 3;
                    }
                    if (sheetArea !== 0) {
                        var self_1 = this;
                        var oldStyleObject = self_1._getStyleObject(row, col, sheetArea);
                        var modelManager = self_1._modelManager;
                        var rowCount = modelManager.getRowCount(sheetArea);
                        var colCount = modelManager.getColumnCount(sheetArea);
                        if (row < -1 || row >= rowCount || col < -1 || col >= colCount) {
                            return;
                        }
                        var valueTemp = value;
                        var oldValue = modelManager.getStyle(row, col, sheetArea);
                        if (typeof valueTemp === const_string) {
                            valueTemp = self_1._name2Style(valueTemp);
                        }
                        var formatter = valueTemp && valueTemp.formatter;
                        if (formatter && isFormatString(formatter)) {
                            self_1._processFormatString(row, col, formatter);
                        }
                        modelManager.do('setStyle', row, col, value, sheetArea);
                        var oldTypeName = oldStyleObject && oldStyleObject.cellType && oldStyleObject.cellType.typeName || keyword_null;
                        var newTypeName = value && value.cellType && value.cellType.typeName || keyword_null;
                        if (row === self_1._activeRowIndex && col === self_1._activeColIndex &&
                            oldTypeName !== newTypeName && common_1._FocusHelper._isActiveElement(self_1)) {
                            self_1._eventHandler._changeFocusHolder();
                        }
                        var pn = '[styleinfo]';
                        if (row !== -1 && col !== -1) {
                            self_1._raiseCellChanged(pn, row, col, sheetArea, oldValue, value);
                        } else if (row !== -1 && col === -1) {
                            self_1._raiseRowChanged(row, sheetArea, pn, value, oldValue);
                        } else if (row === -1 && col !== -1) {
                            self_1._raiseColumnChanged(col, sheetArea, pn, value, oldValue);
                        }
                    }
                };
                Worksheet.prototype._processFormatString = function (row, col, formatter) {
                    var self = this;
                    if (!SheetsCalc) {
                        SheetsCalc = __webpack_require__(/*! SheetsCalc */ 'SheetsCalc');
                    }
                    if (SheetsCalc) {
                        if (row === -1) {
                            row = 0;
                        }
                        if (col === -1) {
                            col = 0;
                        }
                        var cellRange = self.getCell(row, col, 3);
                        var cellReference = SheetsCalc.rangeToFormula(cellRange, row, col, 3);
                        var newformatStr = formatter.trim();
                        if (newformatStr.charAt(0) === '=') {
                            if (newformatStr.indexOf('@') >= 0) {
                                newformatStr = newformatStr.replace(/@/g, cellReference);
                            }
                        }
                        if (newformatStr.indexOf('{{') >= 0 && newformatStr.indexOf('}}') >= 0) {
                            var formulaArray = newformatStr.split(/{{|}}/);
                            if (formulaArray[0] === '') {
                                formulaArray.shift();
                            }
                            if (formulaArray[formulaArray.length - 1] === '') {
                                formulaArray.pop();
                            }
                            for (var i = 0; i < formulaArray.length; i++) {
                                if (formulaArray[i].indexOf('=') === -1) {
                                    formulaArray[i] = '"' + formulaArray[i] + '"';
                                } else {
                                    if (formulaArray[i].indexOf('@') >= 0) {
                                        formulaArray[i] = formulaArray[i].replace(/@/g, cellReference);
                                    }
                                    var result = SheetsCalc.evaluateFormula(self, formulaArray[i]);
                                    if (result instanceof CalcEngine_1.CalcError) {
                                        formulaArray[i] = '"' + result.toString() + '"';
                                    } else {
                                        formulaArray[i] = formulaArray[i].replace(/=/g, '');
                                    }
                                }
                            }
                            newformatStr = '=CONCAT(' + formulaArray.join(',') + ')';
                        }
                        var spread = self.parent;
                        if (!spread._getFormatStringCustomName(formatter)) {
                            spread._addCustomNameCore(spread._formatStringCustomNameInfos, formatter, newformatStr, row, col, true, '');
                        }
                    }
                };
                Worksheet.prototype.getDefaultStyle = function (sheetArea) {
                    if (isNullOrUndefined(sheetArea)) {
                        sheetArea = 3;
                    }
                    var self = this;
                    var composedDefaultStyle = self._composedDefaultStyle;
                    var cachedStyle = composedDefaultStyle[sheetArea];
                    if (cachedStyle) {
                        return cachedStyle;
                    }
                    if (sheetArea !== 0) {
                        var modelManager = self._modelManager;
                        var sheetDefStyle = modelManager.getStyle(-1, -1, sheetArea);
                        if (typeof (sheetDefStyle) === const_string) {
                            sheetDefStyle = self._name2Style(sheetDefStyle);
                        }
                        if (!sheetDefStyle) {
                            sheetDefStyle = new style_1.Style();
                            modelManager.do('setStyle', -1, -1, sheetDefStyle, sheetArea);
                        }
                        sheetDefStyle = sheetDefStyle;
                        var isHeader = (sheetArea === 1 || sheetArea === 2);
                        if (typeof (sheetDefStyle.hAlign) === const_undefined) {
                            sheetDefStyle.hAlign = isHeader ? 1 : 3;
                        }
                        if (typeof (sheetDefStyle.vAlign) === const_undefined) {
                            sheetDefStyle.vAlign = isHeader ? 1 : 0;
                        }
                        if (typeof (sheetDefStyle.imeMode) === const_undefined) {
                            sheetDefStyle.imeMode = 1;
                        }
                        if (!sheetDefStyle.font && typeof (sheetDefStyle.themeFont) === const_undefined) {
                            sheetDefStyle.themeFont = 'Body';
                        }
                        composedDefaultStyle[sheetArea] = sheetDefStyle;
                        return sheetDefStyle;
                    }
                    var defStyle = new style_1.Style();
                    defStyle.locked = true;
                    composedDefaultStyle[sheetArea] = defStyle;
                    return defStyle;
                };
                Worksheet.prototype.setDefaultStyle = function (style, sheetArea) {
                    if (isNullOrUndefined(sheetArea)) {
                        sheetArea = 3;
                    }
                    var self = this;
                    if (sheetArea !== 0) {
                        self._modelManager.do('setStyle', -1, -1, style, sheetArea);
                    }
                    self._composedDefaultStyle[sheetArea] = keyword_null;
                    self._clearStyleCache();
                    self._invalidate();
                };
                Worksheet.prototype._name2Style = function (name) {
                    var style = this._getNamedStyleImp(name, false);
                    if (style) {
                        return style;
                    }
                    var parent = this.parent;
                    if (parent) {
                        return parent._getNamedStyleImp(name, false);
                    }
                    return keyword_null;
                };

                Worksheet.prototype.getCompositeStyle = function (row, column, sheetArea, cellStyle, rowStyle, colStyle, table, hasTableStyle, isForFilter, pivotTableStyle, ignoreSheet, pivotTable) {
                    if (isNullOrUndefined(sheetArea)) {
                        sheetArea = 3;
                    }
                    var self = this;
                    var destInfo = new style_1.Style();
                    var changed = false;
                    var temp;
                    var parentName;
                    if (sheetArea !== 0) {
                        var modelManager = self._modelManager;
                        var tables = self.tables;
                        var pivotTables = self.pivotTables;
                        var rowCount = modelManager.getRowCount(sheetArea);
                        var colCount = modelManager.getColumnCount(sheetArea);
                        var s = void 0;
                        if (0 <= row && row < rowCount && 0 <= column && column < colCount) {
                            s = cellStyle !== keyword_undefined ? cellStyle : modelManager.getStyle(row, column, sheetArea);
                            if (s && s.charAt) {
                                s = self._name2Style(s);
                            }
                            if (s) {
                                destInfo._compose(s, true, 10);
                                changed = true;
                                parentName = s.parentName;
                                while (parentName) {
                                    temp = self._name2Style(parentName);
                                    if (!temp) {
                                        break;
                                    }
                                    destInfo._compose(temp, false, 10, true);
                                    parentName = temp.parentName;
                                }
                            }
                        }
                        if (hasTableStyle) {
                            return destInfo;
                        }
                        if (table === keyword_undefined && !isForFilter) {
                            table = (sheetArea === 3 && tables) ? tables.find(row, column) : keyword_null;
                        }
                        if (table && !isForFilter) {
                            table._compose(row, column, destInfo);
                            changed = true;
                        }
                        if (pivotTable === keyword_undefined && !isForFilter) {
                            pivotTable = (sheetArea === 3 && pivotTables) ? pivotTables.findPivotTable(row, column) : keyword_null;
                            pivotTableStyle = pivotTable && pivotTable._getStyleByRange(row, column);
                        }
                        if (pivotTableStyle) {
                            if (pivotTableStyle && pivotTableStyle.parentName) {
                                var parentStyle = self._name2Style(pivotTableStyle.parentName);
                                parentStyle && pivotTableStyle._compose(parentStyle);
                            }
                            pivotTableStyle._compose(destInfo);
                            destInfo = pivotTableStyle;
                            changed = true;
                        }
                        if (pivotTable) {
                            pivotTable._composeTheme(row, column, destInfo);
                            changed = true;
                        }
                        if (0 <= row && row < rowCount) {
                            s = rowStyle !== keyword_undefined ? rowStyle : modelManager.getStyle(row, -1, sheetArea);
                            if (s && s.charAt) {
                                s = self._name2Style(s);
                            }
                            if (s) {
                                destInfo._compose(s, !changed, 30);
                                changed = true;
                                parentName = s.parentName;
                                while (parentName) {
                                    temp = self._name2Style(parentName);
                                    if (!temp) {
                                        break;
                                    }
                                    destInfo._compose(temp, false, 30, true);
                                    parentName = temp.parentName;
                                }
                            }
                        }
                        if (0 <= column && column < colCount) {
                            s = colStyle !== keyword_undefined ? colStyle : modelManager.getStyle(-1, column, sheetArea);
                            if (s && s.charAt) {
                                s = self._name2Style(s);
                            }
                            if (s) {
                                destInfo._compose(s, !changed, 40);
                                changed = true;
                                parentName = s.parentName;
                                while (parentName) {
                                    temp = self._name2Style(parentName);
                                    if (!temp) {
                                        break;
                                    }
                                    destInfo._compose(temp, false, 40, true);
                                    parentName = temp.parentName;
                                }
                            }
                        }
                    }
                    var sheetInfo = self.getDefaultStyle(sheetArea);
                    if (sheetInfo && sheetInfo.charAt) {
                        sheetInfo = self._name2Style(sheetInfo);
                    }
                    if (sheetInfo && !ignoreSheet) {
                        destInfo._compose(sheetInfo, !changed, 50);
                        parentName = sheetInfo.parentName;
                        while (parentName) {
                            temp = self._name2Style(parentName);
                            if (!temp) {
                                break;
                            }
                            destInfo._compose(temp, false, 50, true);
                            parentName = temp.parentName;
                        }
                    }
                    return destInfo;
                };
                Worksheet.prototype.getCellType = function (row, col, sheetArea) {
                    return this._getStyleProperty(row, col, 'cellType', sheetArea) || this._getDefaultCellType(sheetArea);
                };
                Worksheet.prototype._getDefaultCellType = function (sheetArea) {
                    if (isNullOrUndefined(sheetArea)) {
                        sheetArea = 3;
                    }
                    var defaultCellType = this._defaultCellType;
                    if (!defaultCellType) {
                        defaultCellType = this._defaultCellType = new textcelltype_1.Text();
                    }
                    if (sheetArea === 3) {
                        return defaultCellType;
                    } else if (sheetArea === 1) {
                        return new headercelltype_1.ColumnHeader();
                    } else if (sheetArea === 2) {
                        return new headercelltype_1.RowHeader();
                    } else if (sheetArea === 0) {
                        return new headercelltype_1.Corner();
                    }
                    return defaultCellType;
                };
                Worksheet.prototype.setCellType = function (row, col, value, sheetArea) {
                    var style = this._getStyleImp(row, col, sheetArea);
                    if (!style) {
                        style = new style_1.Style();
                    }
                    style.cellType = value;
                    this.setStyle(row, col, style, sheetArea);
                };
                Worksheet.prototype._addSpanImp = function (row, col, rowCount, colCount, sheetArea) {
                    var self = this;
                    if (isNullOrUndefined(sheetArea)) {
                        sheetArea = 3;
                    }
                    var modelManager = self._modelManager;
                    modelManager.do('clearSpan', row, col, rowCount, colCount, sheetArea);
                    var r = common_1._createRange(row, col, rowCount, colCount);
                    var actualRange = self._getActualRange(r, sheetArea);
                    var newRange = self._adjustSpanRange(actualRange, sheetArea);
                    modelManager.do('addSpan', newRange, sheetArea);
                    if (sheetArea === 3) {
                        var selections = self.getSelections();
                        for (var i = 0; i < selections.length; i++) {
                            if (selections[i].intersect(row, col, rowCount, colCount)) {
                                selections[i] = selections[i].union(r);
                            }
                        }
                        modelManager.do('setSelections', selections);
                    }
                    self._invalidate();
                };
                Worksheet.prototype._adjustSpanRange = function (range, sheetArea) {
                    var sheetRowCount = this.getRowCount(sheetArea);
                    var sheetColumnCount = this.getColumnCount(sheetArea);
                    var row = range.row;
                    var col = range.col;
                    var rowCount = range.rowCount;
                    var colCount = range.colCount;
                    if (row + rowCount > sheetRowCount) {
                        rowCount = sheetRowCount - row;
                    }
                    if (col + colCount > sheetColumnCount) {
                        colCount = sheetColumnCount - col;
                    }
                    return common_1._createRange(row, col, rowCount, colCount);
                };
                Worksheet.prototype.addSpan = function (row, col, rowCount, colCount, sheetArea) {
                    var self = this;
                    if (rowCount === 1 && colCount === 1 || sheetArea === 0) {
                        return;
                    }
                    var sheetRowCount = self.getRowCount(sheetArea);
                    var sheetColumnCount = self.getColumnCount(sheetArea);
                    if (row >= sheetRowCount || col >= sheetColumnCount || row < -1 || col < -1) {
                        return;
                    }
                    var canSpan = true;
                    if (_supportsCalc && (sheetArea === 3 || isNullOrUndefined(sheetArea))) {
                        canSpan = self._checkArrayFormula(row, col, rowCount, colCount, false);
                        if (self.pivotTables) {
                            canSpan = canSpan && self.pivotTables._rangeIntersectPivotTable(row, col, rowCount, colCount);
                        }
                    }
                    if (canSpan) {
                        var modelManager = self._modelManager;
                        if (modelManager._hasPartSpans(row, col, rowCount, colCount, sheetArea)) {
                            throw new Error(getSR().Exp_InvalidRange);
                        }
                        if (self._removeCommentsWhenAddSpan) {
                            self._removeCommentsWhenAddSpan(row, col, rowCount, colCount);
                        }
                        self._addSpanImp(row, col, rowCount, colCount, sheetArea);
                        var e = {
                            sheet: self,
                            row: row,
                            col: col,
                            rowCount: rowCount,
                            colCount: colCount,
                            sheetArea: sheetArea,
                            changeType: 'addSpan'
                        };
                        Worksheet._callFeatureHandler(self, const_onLayoutChanged, e);
                        self._trigger('spanChanged', e);
                    }
                };
                Worksheet.prototype.removeSpan = function (row, col, sheetArea) {
                    var self = this;
                    if (isNullOrUndefined(sheetArea)) {
                        sheetArea = 3;
                    }
                    var modelManager = self._modelManager;
                    var span = modelManager.findSpan(row, col, sheetArea);
                    if (span && span.row === row && span.col === col) {
                        modelManager.do('removeSpan', span, sheetArea);
                    }
                    var e = {
                        sheet: self,
                        row: row,
                        col: col,
                        sheetArea: sheetArea,
                        changeType: 'removeSpan'
                    };
                    Worksheet._callFeatureHandler(self, const_onLayoutChanged, e);
                    self._trigger('spanChanged', e);
                    self._invalidate();
                };
                Worksheet.prototype.getSpans = function (range, sheetArea) {
                    if (sheetArea === 0) {
                        return [];
                    }
                    return this._modelManager.getSpans(range, sheetArea, true);
                };
                Worksheet.prototype.getSpan = function (row, col, sheetArea) {
                    if (sheetArea === 0) {
                        return keyword_null;
                    }
                    return this._modelManager.findSpan(row, col, sheetArea);
                };
                Worksheet.prototype.repaint = function (clipRect) {
                    if (this._layoutSuspended <= 0 && this._render) {
                        this._render.repaint(clipRect);
                    }
                };
                Worksheet.prototype._repaintRow = function (row, rowCount) {
                    if (rowCount === void 0) {
                        rowCount = 1;
                    }
                    var rect = this._getRangeWholeRect(new common_1.Range(row, -1, rowCount, -1));
                    rect.y -= 1;
                    rect.height += 1;
                    this.repaint(rect);
                };
                Worksheet.prototype._repaintColumn = function (column, columnCount) {
                    if (columnCount === void 0) { columnCount = 1; }
                    var rect = this._getRangeWholeRect(new common_1.Range(-1, column, -1, columnCount));
                    rect.x -= 1;
                    rect.width += 1;
                    this.repaint(rect);
                };
                Worksheet.prototype._scrollByMoveCell = function (cellRowIndex, cellColIndex) {
                    var self = this;
                    var workbook = self.parent;
                    var isMobileScrollbar = workbook && workbook.options.scrollbarAppearance === core_enum_1.ScrollbarAppearance.mobile;
                    var scrollHorizontally = false;
                    var scrollVertically = false;
                    var scrollByPixel = workbook && workbook.options.scrollByPixel;
                    var frozenRowCount = getFrozenRowCount(self);
                    var frozenColCount = getFrozenColumnCount(self);
                    var firstCol = frozenColCount ? self._getNextVisualColumn(frozenColCount - 1) : self._getFirstVisualColumn();
                    var firstRow1 = frozenRowCount ? self._getNextVisualRow(frozenRowCount - 1) : self._getFirstVisualRow();
                    if (cellColIndex < self._scrollLeftCol && cellColIndex >= firstCol) {
                        scrollHorizontally = true;
                        self._setLeftColumn(self._getPrevVisualColumn(cellColIndex + 1), 0);
                    } else if (scrollByPixel && cellColIndex === self._scrollLeftCol && self._scrollLeftColOffset !== 0) {
                        scrollHorizontally = true;
                        self._setLeftColumn(cellColIndex, 0);
                    }
                    if (cellColIndex > self._getLastFullyVisibleColumn() && cellColIndex <= self._getLastVisualColumn()) {
                        var w = 0;
                        var c = cellColIndex;
                        var sheetLayout1 = self._getSheetLayout();
                        var viewportWidth = self._getActualViewportWidth(sheetLayout1);
                        var tempSpan = self._modelManager.findSpan(cellRowIndex, c);
                        if (tempSpan) {
                            c = tempSpan.col + tempSpan.colCount - 1;
                        }
                        while (c > self._scrollLeftCol) {
                            w += self._getZoomColumnWidth(c);
                            if (w > viewportWidth) {
                                break;
                            }
                            c--;
                        }
                        var newLeftCol = void 0;
                        var newLeftColOffset = void 0;
                        if (scrollByPixel) {
                            if (c === self._scrollLeftCol && w < viewportWidth) {
                                w += self._getZoomColumnWidth(c);
                            }
                            newLeftCol = c;
                            newLeftColOffset = viewportWidth - w;
                        } else {
                            newLeftCol = self._getNextVisualColumn(c);
                            newLeftColOffset = 0;
                        }
                        scrollHorizontally = true;
                        self._setLeftColumn(newLeftCol, newLeftColOffset);
                    }
                    if (cellRowIndex < self._scrollTopRow && cellRowIndex >= firstRow1) {
                        scrollVertically = true;
                        self._setTopRow(self._getPrevVisualRow(cellRowIndex + 1), 0);
                    } else if (scrollByPixel && cellRowIndex === self._scrollTopRow && self._scrollTopRowOffset !== 0) {
                        scrollVertically = true;
                        self._setTopRow(cellRowIndex, 0);
                    }
                    if (cellRowIndex > self._getLastFullyVisibleRow() && cellRowIndex <= self._getLastVisualRow()) {
                        var h = 0;
                        var r = cellRowIndex;
                        var tempSpan1 = self._modelManager.findSpan(r, cellColIndex);
                        if (tempSpan1) {
                            r = tempSpan1.row + tempSpan1.rowCount - 1;
                        }
                        var sheetLayout = self._getSheetLayout();
                        var viewportHeight = self._getActualViewportHeight(sheetLayout);
                        while (r > self._scrollTopRow) {
                            h += self._getZoomRowHeight(r);
                            if (h > viewportHeight) {
                                break;
                            }
                            r--;
                        }
                        var newTopRow = void 0, newTopRowOffset = void 0;
                        if (scrollByPixel) {
                            if (r === self._scrollTopRow && h < viewportHeight) {
                                h += self._getZoomRowHeight(r);
                            }
                            newTopRow = r;
                            newTopRowOffset = viewportHeight - h;
                        } else {
                            newTopRow = self._getNextVisualRow(r);
                            newTopRowOffset = 0;
                        }
                        scrollVertically = true;
                        self._setTopRow(newTopRow, newTopRowOffset);
                    }
                    if (!scrollByPixel && cellColIndex === self._getLastVisualColumn()) {
                        self._setLeftColumn(self._getLastPageLeftColumn(), 0);
                    }
                    if (isMobileScrollbar) {
                        var scrollbarV = workbook._vScrollbar, scrollbarH = workbook._hScrollbar;
                        var scrollService = workbook._scrollService;
                        if (scrollVertically) {
                            scrollbarV._updateState(core_enum_1.ScrollbarState.show);
                            scrollService._launchHideScrollbarTimer(true);
                        }
                        if (scrollHorizontally) {
                            scrollbarH._updateState(core_enum_1.ScrollbarState.show);
                            scrollService._launchHideScrollbarTimer(false);
                        }
                    }
                };
                // 命中测试，从 workbook 的坐标系统中得到特定的区域
                Worksheet.prototype.hitTest = function (x, y, forMove, ignoreProtected) {
                    var self = this;
                    self._getSheetLayout();
                    var target = {
                        x: x,
                        y: y
                    };
                    var rowOutlines = self.rowOutlines;
                    var columnOutlines = self.columnOutlines;
                    var outlineHitInfo;
                    var rowViewportIndex;
                    var colViewportIndex;
                    if (rowOutlines) {
                        outlineHitInfo = rowOutlines.hitTest(self, x, y);
                    }
                    if (!outlineHitInfo && columnOutlines) {
                        outlineHitInfo = columnOutlines.hitTest(self, x, y);
                    }
                    if (outlineHitInfo) {
                        target.outlineHitInfo = outlineHitInfo;
                    } else {
                        rowViewportIndex = self._getRowViewportIndexFromY(y);
                        colViewportIndex = self._getColumnViewportIndexFromX(x);
                        target.rowViewportIndex = rowViewportIndex;
                        target.colViewportIndex = colViewportIndex;
                        target.row = self._getRowIndexFromY(y, rowViewportIndex);
                        target.col = self._getColumnIndexFromX(x, colViewportIndex);
                        if (rowViewportIndex >= 0 && rowViewportIndex <= 2 && colViewportIndex >= 0) {
                            var cellLayout = self._getCellLayoutByCell(rowViewportIndex, colViewportIndex, keyword_undefined, target.row, target.col);
                            if (cellLayout && forMove !== true) {
                                target.row = cellLayout.row;
                                target.col = cellLayout.col;
                            }
                        }
                        target.hitTestType = self._getSheetArea(rowViewportIndex, colViewportIndex);
                        var eventHandler = self._eventHandler;
                        var rowFilterTable = self._rowFilter;
                        var tableFilterButtonHitInfo = rowFilterTable && rowFilterTable.hitTest(target, x, y);
                        var tableManager = self.tables;
                        var table = void 0;
                        if (tableManager) {
                            if (target.rowViewportIndex === -1) {
                                table = tableManager && tableManager.find(self.getActiveRowIndex(), self.getActiveColumnIndex());
                            } else {
                                table = tableManager.find(target.row, target.col);
                            }
                        }
                        if (!tableFilterButtonHitInfo) {
                            var tableFilter = table && table._rowFilter;
                            tableFilterButtonHitInfo = tableFilter && tableFilter.hitTest(target, x, y);
                        }
                        var tableSelectInfo = tableManager && !tableFilterButtonHitInfo && tableManager._getTableSelectionInfo(x, y, target);
                        if (tableSelectInfo) {
                            target.tableSelectInfo = tableSelectInfo;
                            if (tableSelectInfo.table && tableSelectInfo.table._rowFilter) {
                                target.filterButtonHitInfo = tableFilterButtonHitInfo;
                            }
                            return target;
                        }
                        var dragMergeInfo = eventHandler._getDragMergeInfo && eventHandler._getDragMergeInfo(target, x, y);
                        if (dragMergeInfo) {
                            target.dragMergeInfo = dragMergeInfo;
                        } else {
                            var dragInfo = eventHandler._getDragInfo && eventHandler._getDragInfo(target, x, y);
                            if (dragInfo) {
                                target.dragInfo = dragInfo;
                            } else {
                                var resizeInfo = eventHandler._getResizingRowCol(target, x, y, 5);
                                if (resizeInfo) {
                                    target.resizeInfo = resizeInfo;
                                } else {
                                    var formulaRangeInfo = eventHandler._getFormulaRangeHitInfo ? eventHandler._getFormulaRangeHitInfo(target, x, y) : keyword_null;
                                    if (formulaRangeInfo) {
                                        target.formulaRangeHitInfo = formulaRangeInfo;
                                    } else {
                                        var comments = self._modelManager._comments, commentHitInfo = comments && comments.hitTest(x, y);
                                        if (commentHitInfo) {
                                            target.commentHitInfo = commentHitInfo;
                                        } else {
                                            var floatingObjectModel = self._floatingObjectModel;
                                            var floatObjectInfo = floatingObjectModel && floatingObjectModel.hitTest(x, y, ignoreProtected);
                                            var shapeHitInfo = void 0;
                                            if (self.shapes) {
                                                shapeHitInfo = self.shapes.hitTest(x, y);
                                            }
                                            if (shapeHitInfo) {
                                                target.shapeHitInfo = shapeHitInfo;
                                            } else if (floatObjectInfo) {
                                                target.floatingObjectHitInfo = floatObjectInfo;
                                            } else {
                                                if (tableFilterButtonHitInfo) {
                                                    target.filterButtonHitInfo = tableFilterButtonHitInfo;
                                                } else {
                                                    var resizeTableHitInfo = table && !table._inBinding() && eventHandler._getResizeIndicatorHitInfo && eventHandler._getResizeIndicatorHitInfo(target, table);
                                                    if (resizeTableHitInfo) {
                                                        target.resizeTableHitInfo = resizeTableHitInfo;
                                                    } else {
                                                        target.cellTypeHitInfo = self._getCellTypeHitInfo(target, x, y);
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                    var pivotTable = self.pivotTables && self.pivotTables.findPivotTable(target.row, target.col);
                    if (!isNullOrUndefined(pivotTable)) {
                        target.pivotTableInfo = pivotTable;
                    }
                    return target;
                };
                Worksheet.prototype.getCellRect = function (row, col, rowViewportIndex, colViewportIndex, needAutoMerge) {
                    var sheetArea = 3;
                    if (rowViewportIndex === -1) {
                        sheetArea = 1;
                    } else if (colViewportIndex === -1) {
                        sheetArea = 2;
                    }
                    var self = this;
                    var sheetLayout = self._getSheetLayout();
                    if (rowViewportIndex === -1 && colViewportIndex === -1) {
                        return new common_1.Rect(sheetLayout._headerX, sheetLayout._headerY, sheetLayout._rowHeaderWidth, sheetLayout._colHeaderHeight);
                    }
                    var bounds = self._getBounds();
                    if (isNullOrUndefined(rowViewportIndex)) {
                        rowViewportIndex = self._getRowViewportIndex(row);
                    }
                    if (isNullOrUndefined(colViewportIndex)) {
                        colViewportIndex = self._getColumnViewportIndex(col);
                    }
                    var rowLayout = self._getRowLayout(rowViewportIndex, sheetArea).findRow(row);
                    var colLayout = self._getColumnLayout(colViewportIndex, sheetArea).findCol(col);
                    var cellLayout = self._getCellLayout(rowViewportIndex, colViewportIndex, sheetArea, needAutoMerge).findCell(row, col);
                    if (cellLayout) {
                        return new common_1.Rect(cellLayout.x - bounds.x, cellLayout.y - bounds.y, cellLayout.width, cellLayout.height);
                    }
                    if (rowLayout && colLayout) {
                        return new common_1.Rect(colLayout.x - bounds.x, rowLayout.y - bounds.y, colLayout.width, rowLayout.height);
                    }
                    return new common_1.Rect();
                };
                Worksheet.prototype._setActiveCellCore = function (row, col, doNotSetFocus) {
                    var self = this;
                    var eventHandler = self._eventHandler;
                    var activeCellChanged = false;
                    var oldRowIndex = self._activeRowIndex;
                    var oldColIndex = self._activeColIndex;
                    if (!isNullOrUndefined(row)) {
                        self._activeRowIndex = row;
                        activeCellChanged = true;
                    }
                    if (!isNullOrUndefined(col)) {
                        self._activeColIndex = col;
                        activeCellChanged = true;
                    }
                    var statesManager = self._statesManager;
                    var isRowStateEnabled = statesManager && statesManager.isEnable(core_enum_1.StatesType.active, true);
                    var isColumnStateEnabled = statesManager && statesManager.isEnable(core_enum_1.StatesType.active, false);
                    if (isRowStateEnabled) {
                        self._repaintRow(oldRowIndex);
                        self._repaintRow(row);
                    }
                    if (isColumnStateEnabled) {
                        self._repaintColumn(oldColIndex);
                        self._repaintColumn(col);
                    }
                    self._modelManager.setCellState(oldRowIndex, oldColIndex, core_enum_1.CellStatesType.active, false, core_enum_1.SheetArea.viewport);
                    if (!isRowStateEnabled && !isColumnStateEnabled) {
                        self._repaintChangeCellForCellState && self._repaintChangeCellForCellState(core_enum_1.CellStatesType.active, oldRowIndex, oldColIndex, core_enum_1.SheetArea.viewport);
                    }
                    self._modelManager.setCellState(row, col, core_enum_1.CellStatesType.active, true, core_enum_1.SheetArea.viewport);
                    if (!isRowStateEnabled && !isColumnStateEnabled) {
                        self._repaintChangeCellForCellState && self._repaintChangeCellForCellState(core_enum_1.CellStatesType.active, row, col, core_enum_1.SheetArea.viewport);
                    }
                    if (!doNotSetFocus && eventHandler && activeCellChanged) {
                        eventHandler._changeFocusHolder();
                        var modelManager = self._modelManager;
                        var anchor = modelManager.getDynamicArrayInfo(row, col);
                        var oldAnchor = modelManager._selectedAnchor;
                        if (anchor !== oldAnchor) {
                            modelManager._selectedAnchor = anchor;
                            if (self._layoutSuspended <= 0) {
                                var range = void 0;
                                if (anchor && oldAnchor) {
                                    range = common_1.getUnionRange(anchor, oldAnchor);
                                } else {
                                    anchor = anchor || oldAnchor;
                                    range = common_1._createRange(anchor.row, anchor.col, anchor.rowCount, anchor.colCount);
                                }
                                self._render._repaintSelection(range);
                            }
                        }
                    }
                };
                Worksheet.prototype._getRepaintRectForCellState = function (sheet, row, col, rowViewportIndex, colViewportIndex) {
                    var rect = sheet.getCellRect(row, col, rowViewportIndex, colViewportIndex);
                    var x = rect.x;
                    var y = rect.y;
                    var width = rect.width;
                    var height = rect.height;
                    rect.x = x - 2;
                    rect.y = y - 2;
                    rect.width = width + 4;
                    rect.height = height + 4;
                    return rect;
                };
                // 设置活动单元格的具体实现
                Worksheet.prototype._setActiveCellImp = function (row, col, rowViewportIndex, colViewportIndex, doNotSetFocus) {
                    var self = this;
                    var activeRowIndex = self._activeRowIndex;
                    var activeColIndex = self._activeColIndex;
                    var modelManager = self._modelManager;
                    var span = modelManager.getSpan(row, col);
                    self._activeRowCount = span.rowCount;
                    self._activeColCount = span.colCount;
                    if (self._layoutSuspended <= 0) {
                        var activeSpan = modelManager.getSpan(activeRowIndex, activeColIndex);
                        self._render._repaintSelection(common_1._createRange(activeRowIndex, activeColIndex, activeSpan.rowCount, activeSpan.colCount));
                    }
                    self._activeRowViewportIndex = rowViewportIndex;
                    self._activeColViewportIndex = colViewportIndex;
                    self._setActiveCellCore(row, col, doNotSetFocus);
                    self._leadingCellRow = row;
                    self._leadingCellCol = col;
                };
                Worksheet.prototype.setActiveCell = function (row, col, rowViewportIndex, colViewportIndex) {
                    this._setActiveCellAndSelection(row, col, rowViewportIndex, colViewportIndex, 2);
                };
                Worksheet.prototype._setActiveCellAndSelection = function (row, col, rowViewportIndex, colViewportIndex, focusPolicy) {
                    var self = this;
                    var rowCount = getRowCount(self);
                    var colCount = getColumnCount(self);
                    if (row < 0) {
                        row = 0;
                    } else if (row >= rowCount) {
                        row = Math_max(0, rowCount - 1);
                    }
                    if (col < 0) {
                        col = 0;
                    } else if (col >= colCount) {
                        col = Math_max(0, colCount - 1);
                    }
                    self._clearSelectionImp();
                    var setFocus = (focusPolicy === 2) ? common_1._FocusHelper._isActiveElement(self) : focusPolicy === 1;
                    self._setActiveCellImp(row, col, rowViewportIndex, colViewportIndex, !setFocus);
                    var enterCellArgs = {
                        sheet: self,
                        sheetName: self.name(),
                        row: row,
                        col: col
                    };
                    self._trigger(common_1.Events.FormulatextboxEnterCell, enterCellArgs);
                    var span = self._modelManager.getSpan(row, col);
                    self._setSelectedRange(span.row, span.col, span.rowCount, span.colCount);
                    self._invalidate();
                };
                Worksheet.prototype.getActiveRowIndex = function () {
                    return this._activeRowIndex;
                };
                Worksheet.prototype.getActiveColumnIndex = function () {
                    return this._activeColIndex;
                };
                Worksheet.prototype.getRowResizable = function (row, sheetArea) {
                    return this._modelManager.getResizable(true, sheetArea, row);
                };
                Worksheet.prototype.setRowResizable = function (row, value, sheetArea) {
                    this._setRowColInfo(row, value, const_resizable, true, sheetArea);
                };
                Worksheet.prototype._setRowColInfo = function (index, value, property, isRow, sheetArea) {
                    if (isNullOrUndefined(sheetArea)) {
                        sheetArea = 3;
                    }
                    if ((property === cssHeight || property === cssWidth) && starSizeReg.test(value)) {
                        property = const_starSize;
                    }
                    var self = this;
                    var modelManager = self._modelManager;
                    var oldValue;
                    switch (property) {
                        case const_resizable:
                            oldValue = modelManager.getResizable(isRow, sheetArea, index);
                            break;
                        case 'pageBreak':
                            oldValue = modelManager.getPageBreak(isRow, sheetArea, index);
                            break;
                        case const_isVisible:
                            oldValue = modelManager.getVisible(isRow, sheetArea, index);
                            break;
                        case cssHeight:
                            oldValue = modelManager.getSize(isRow, sheetArea, index);
                            break;
                        case cssWidth:
                            oldValue = modelManager.getSize(isRow, sheetArea, index);
                            break;
                    }
                    var cancel = true;
                    if (isRow) {
                        cancel = self._raiseRowChanging(index, sheetArea, property, value, oldValue);
                    } else {
                        cancel = self._raiseColumnChanging(index, sheetArea, property, value, oldValue);
                    }
                    if (!cancel) {
                        return cancel;
                    }
                    switch (property) {
                        case const_resizable:
                            modelManager.do('setResizable', isRow, sheetArea, index, value);
                            break;
                        case 'pageBreak':
                            modelManager.do('setPageBreak', isRow, sheetArea, index, value);
                            break;
                        case const_isVisible:
                            modelManager.do('setVisible', isRow, sheetArea, index, value);
                            if (isRow && _supportsCalc && sheetArea === 3 && oldValue !== value) {
                                self.recalcRows([index]);
                            }
                            break;
                        case cssHeight:
                            modelManager.do('setSize', isRow, sheetArea, index, value);
                            if (_supportsCalc && sheetArea === 3 && oldValue !== value && (oldValue === 0 || value === 0)) {
                                self.recalcRows([index]);
                            }
                            break;
                        case cssWidth:
                            modelManager.do('setSize', isRow, sheetArea, index, value);
                            if (_supportsCalc && sheetArea === 3 && oldValue !== value && (oldValue === 0 || value === 0)) {
                                self.recalcCols([index]);
                            }
                            break;
                        case const_starSize:
                            modelManager.do('setStarSize', isRow, sheetArea, index, value);
                            break;
                    }
                    if (isRow) {
                        self._raiseRowChanged(index, sheetArea, property, value, oldValue);
                    } else {
                        self._raiseColumnChanged(index, sheetArea, property, value, oldValue);
                    }
                    return true;
                };
                Worksheet.prototype.getColumnResizable = function (col, sheetArea) {
                    return this._modelManager.getResizable(false, sheetArea, col);
                };
                Worksheet.prototype.setColumnResizable = function (col, value, sheetArea) {
                    this._setRowColInfo(col, value, const_resizable, false, sheetArea);
                };
                Worksheet.prototype.getRowHeight = function (row, sheetArea, getDynamicSize) {
                    var self = this;
                    if (isNullOrUndefined(sheetArea)) {
                        sheetArea = 3;
                    }
                    if (getDynamicSize) {
                        return self._modelManager.getStarSize(true, sheetArea, row);
                    }
                    if (sheetArea === 3 || sheetArea === 2) {
                        var rowCount = self.getRowCount(sheetArea);
                        if (row < 0 || row >= rowCount) {
                            return 0;
                        }
                        var providers = self._rowStateProviders;
                        for (var i = 0; i < providers.length; i++) {
                            var p = providers[i];
                            if (!p._isVisible(row)) {
                                return 0;
                            }
                        }
                    }
                    var defaults = self.defaults;
                    var dh = defaults.rowHeight;
                    if (sheetArea === 1) {
                        dh = defaults.colHeaderRowHeight;
                    }
                    var h = self._modelManager.getSize(true, sheetArea, row);
                    return (h || h === 0) ? h : Math_floor(dh);
                };
                Worksheet.prototype._getActualRowHeight = function (row, sheetArea) {
                    if (isNullOrUndefined(sheetArea)) {
                        sheetArea = 3;
                    }
                    var self = this;
                    var defaults = self.defaults;
                    var dh = defaults.rowHeight;
                    if (sheetArea === 1) {
                        dh = defaults.colHeaderRowHeight;
                    }
                    var h = self._modelManager.getActualSize(true, sheetArea, row);
                    return (h || h === 0) ? h : Math_floor(dh);
                };
                Worksheet.prototype.setRowHeight = function (row, value, sheetArea) {
                    if (!this._setRowColInfo(row, value, cssHeight, true, sheetArea)) {
                        return;
                    }
                    this._needSyncVScrollbarSize = true;
                    this._invalidate();
                };
                Worksheet.prototype.getRowVisible = function (row, sheetArea, ignoreFilterAndGroup) {
                    var self = this;
                    if (isNullOrUndefined(sheetArea)) {
                        sheetArea = 3;
                    }
                    if (!ignoreFilterAndGroup && (sheetArea === 3 || sheetArea === 2)) {
                        var providers = self._rowStateProviders;
                        for (var i = 0; i < providers.length; i++) {
                            var p = providers[i];
                            if (!p._isVisible(row)) {
                                return false;
                            }
                        }
                    }
                    return this._modelManager.getVisible(true, sheetArea, row);
                };
                Worksheet.prototype.setRowVisible = function (row, value, sheetArea) {
                    var self = this;
                    if (!self._setRowColInfo(row, value, const_isVisible, true, sheetArea)) {
                        return;
                    }
                    self._needSyncVScrollbarSize = true;
                    self._invalidate();
                };
                Worksheet.prototype.getColumnWidth = function (col, sheetArea, getDynamicSize) {
                    var self = this;
                    if (isNullOrUndefined(sheetArea)) {
                        sheetArea = 3;
                    }
                    if (getDynamicSize) {
                        return self._modelManager.getStarSize(false, sheetArea, col);
                    }
                    var defaults = self.defaults, dw = defaults.colWidth;
                    if (sheetArea === 2) {
                        dw = defaults.rowHeaderColWidth;
                    }
                    if (sheetArea === 3 || sheetArea === 1) {
                        var colCount = self.getColumnCount(sheetArea);
                        if (col < 0 || col >= colCount) {
                            return 0;
                        }
                        var providers = self._colStateProviders;
                        for (var i = 0; i < providers.length; i++) {
                            var p = providers[i];
                            if (!p._isVisible(col)) {
                                return 0;
                            }
                        }
                    }
                    var w = this._modelManager.getSize(false, sheetArea, col);
                    return (w || w === 0) ? w : Math_floor(dw);
                };
                Worksheet.prototype._getActualColumnWidth = function (col, sheetArea) {
                    if (isNullOrUndefined(sheetArea)) {
                        sheetArea = 3;
                    }
                    var self = this;
                    var defaults = self.defaults;
                    var dw = defaults.colWidth;
                    if (sheetArea === 2) {
                        dw = defaults.rowHeaderColWidth;
                    }
                    var w = self._modelManager.getActualSize(false, sheetArea, col);
                    return (w || w === 0) ? w : Math_floor(dw);
                };
                Worksheet.prototype.setColumnWidth = function (col, value, sheetArea) {
                    if (!this._setRowColInfo(col, value, cssWidth, false, sheetArea)) {
                        return;
                    }
                    this._needSyncHScrollbarSize = true;
                    this._invalidate();
                };
                Worksheet.prototype.getColumnVisible = function (col, sheetArea) {
                    var self = this;
                    if (isNullOrUndefined(sheetArea)) {
                        sheetArea = 3;
                    }
                    if (sheetArea === 3 || sheetArea === 1) {
                        var providers = self._colStateProviders;
                        for (var i = 0; i < providers.length; i++) {
                            var p = providers[i];
                            if (!p._isVisible(col)) {
                                return false;
                            }
                        }
                    }
                    return self._modelManager.getVisible(false, sheetArea, col);
                };
                Worksheet.prototype.setColumnVisible = function (col, value, sheetArea) {
                    var self = this;
                    if (!self._setRowColInfo(col, value, const_isVisible, false, sheetArea)) {
                        return;
                    }
                    self._needSyncHScrollbarSize = true;
                    self._invalidate();
                };
                Worksheet.prototype.zoom = function (factor) {
                    var self = this;
                    if (arguments.length === 0) {
                        return self._modelManager.getZoomFactor();
                    }
                    factor = convertToFloat(factor);
                    if (!isNotANumber(factor) && isFinite(factor)) {
                        if (factor > 2) {
                            factor = 2;
                        } else if (factor < 0.25) {
                            factor = 0.25;
                        }
                        var oldZoomFactor = self._modelManager.getZoomFactor();
                        self._zoomInternal(factor);
                        self._scrollLeftColOffset = self._scrollLeftColOffset / oldZoomFactor * factor;
                        self._scrollTopRowOffset = self._scrollTopRowOffset / oldZoomFactor * factor;
                        self._needSyncHScrollbarSize = true;
                        self._needSyncVScrollbarSize = true;
                        self._invalidate();
                    }
                    return self;
                };
                Worksheet.prototype._zoomInternal = function (factor) {
                    this._modelManager.do('setZoomFactor', factor);
                    Worksheet._callFeatureHandler(this, const_onLayoutChanged, {
                        changeType: 'zoomSheet'
                    });
                };
                Worksheet.prototype._resetLayout = function () {
                    var self = this;
                    self._layoutModel = keyword_null;
                    self._rowLayoutCache = {
                        colHeader: keyword_null,
                        viewport: keyword_null
                    };
                    self._colLayoutCache = {
                        rowHeader: keyword_null,
                        viewport: keyword_null
                    };
                };
                // 更新控件布局信息
                Worksheet.prototype.invalidateLayout = function () {
                    var self = this;
                    var eventHandler = self._eventHandler;
                    self._modelManager._calcStarSize();
                    self._resetLayout();
                    Worksheet._callFeatureHandler(self, const_beforeLayoutChanged, {
                        changeType: 'invalidateLayout'
                    });
                    if (self._needSyncHScrollbarSize) {
                        self._syncHScrollbarSize();
                        self._needSyncHScrollbarSize = false;
                    }
                    if (self._needSyncVScrollbarSize) {
                        self._syncVScrollbarSize();
                        self._needSyncVScrollbarSize = false;
                    }
                    self._resetLayout();
                    Worksheet._callFeatureHandler(self, const_onLayoutChanged, {
                        changeType: 'invalidateLayout'
                    });
                    if (
                        eventHandler
                        && eventHandler._updateValidationUI
                        && common_1._FocusHelper._isActiveElement(self)
                        && !eventHandler._isClickFloatobjectOrShape(self)
                    ) {
                        eventHandler._updateValidationUI(self._activeRowIndex, self._activeColIndex);
                    }
                    self._dirty = true;
                    var workbook = self.parent;
                    if (workbook && workbook.options.enableAccessibility) {
                        var content = self._getAccessibilityContent();
                        workbook._updateAccessibilityContent(content);
                    }
                };
                Worksheet.prototype._invalidate = function () {
                    var self = this;
                    if (self._layoutSuspended <= 0) {
                        self.invalidateLayout();
                        self.repaint();
                    }
                };
                Worksheet.prototype.getViewportHeight = function (rowViewportIndex) {
                    var self = this;
                    var layout = self._getSheetLayout();
                    if (rowViewportIndex === 0) {
                        return layout._frozenHeight;
                    } else if (rowViewportIndex === 1) {
                        return self._getActualViewportHeight(layout);
                    } else if (rowViewportIndex === 2) {
                        return layout._frozenTrailingHeight;
                    }
                    return 0;
                };
                Worksheet.prototype.getViewportWidth = function (columnViewportIndex) {
                    var layout = this._getSheetLayout();
                    if (columnViewportIndex === 0) {
                        return layout._frozenWidth;
                    } else if (columnViewportIndex === 1) {
                        return this._getActualViewportWidth(layout);
                    } else if (columnViewportIndex === 2) {
                        return layout._frozenTrailingWidth;
                    }
                    return 0;
                };
                Worksheet.prototype.getViewportTopRow = function (rowViewportIndex) {
                    var self = this;
                    var frozenRowCount = getFrozenRowCount(self);
                    if (rowViewportIndex === 0) {
                        return 0;
                    } else if (rowViewportIndex === 1) {
                        return Math_max(frozenRowCount, self._scrollTopRow);
                    } else if (rowViewportIndex === 2) {
                        return Math_max(frozenRowCount, getRowCount(self) - getFrozenTrailingRowCount(self));
                    }
                    return -1;
                };
                Worksheet.prototype.getViewportTopRowOffset = function () {
                    return this._scrollTopRowOffset;
                };
                Worksheet.prototype.getViewportBottomRow = function (rowViewportIndex) {
                    var self = this;
                    if (rowViewportIndex === 2) {
                        return getRowCount(self) - 1;
                    }
                    var topRow = self.getViewportTopRow(rowViewportIndex);
                    var viewportHeight = self.getViewportHeight(rowViewportIndex);
                    var rowHeightTotal = rowViewportIndex === 1 ? self._scrollTopRowOffset : 0;
                    var rowCount = 0;
                    var rc = getRowCount(self) - getFrozenTrailingRowCount(self);
                    if (rowViewportIndex === 0) {
                        rc = Math_min(getFrozenRowCount(self), rc);
                    }
                    for (var index = topRow; (index < rc) && (rowHeightTotal < viewportHeight); index++, rowCount++) {
                        rowHeightTotal += self._getZoomRowHeight(index);
                    }
                    return topRow + rowCount - 1;
                };
                Worksheet.prototype._getViewportFirstVisualRow = function (rowViewportIndex) {
                    var self = this;
                    var topRow = self.getViewportTopRow(rowViewportIndex);
                    var bottomRow = self.getViewportBottomRow(rowViewportIndex);
                    for (var row = topRow; row < bottomRow + 1; row++) {
                        if (row > -1 && self.getRowVisible(row, 3) && self._getZoomRowHeight(row, 3) > 0) {
                            return row;
                        }
                    }
                    return -1;
                };
                Worksheet.prototype.getViewportLeftColumn = function (columnViewportIndex) {
                    var self = this;
                    var frozenColCount = getFrozenColumnCount(self);
                    if (columnViewportIndex === 0) {
                        return 0;
                    } else if (columnViewportIndex === 1) {
                        return Math_max(frozenColCount, self._scrollLeftCol);
                    } else if (columnViewportIndex === 2) {
                        return Math_max(frozenColCount, getColumnCount(self) - getFrozenTrailingColumnCount(self));
                    }
                    return -1;
                };
                Worksheet.prototype.getViewportLeftColumnOffset = function () {
                    return this._scrollLeftColOffset;
                };
                Worksheet.prototype.getViewportRightColumn = function (columnViewportIndex) {
                    var self = this;
                    if (columnViewportIndex === 2) {
                        return getColumnCount(self) - 1;
                    }
                    var leftColumn = self.getViewportLeftColumn(columnViewportIndex);
                    var viewportWidth = self.getViewportWidth(columnViewportIndex);
                    var columnCount = 0;
                    var columnWidthTotal = columnViewportIndex === 1 ? self._scrollLeftColOffset : 0;
                    var cc = getColumnCount(self) - getFrozenTrailingColumnCount(self);
                    if (columnViewportIndex === 0) {
                        cc = Math_min(getFrozenColumnCount(self), cc);
                    }
                    for (var index = leftColumn; (index < cc) && (columnWidthTotal < viewportWidth); index++, columnCount++) {
                        columnWidthTotal += self._getZoomColumnWidth(index);
                    }
                    return leftColumn + columnCount - 1;
                };
                Worksheet.prototype._getViewportFirstVisualColumn = function (columnViewportIndex) {
                    var self = this;
                    var leftColumn = self.getViewportLeftColumn(columnViewportIndex);
                    var rightColumn = self.getViewportRightColumn(columnViewportIndex);
                    for (var col = leftColumn; col < rightColumn + 1; col++) {
                        if (col > -1 && self.getColumnVisible(col, 3) && self._getZoomColumnWidth(col, 3) > 0) {
                            return col;
                        }
                    }
                    return -1;
                };
                Worksheet.prototype.showCell = function (row, col, verticalPosition, horizontalPosition) {
                    this._showCellWithOffset(row, col, verticalPosition, horizontalPosition);
                };
                Worksheet.prototype._showCellWithOffset = function (row, col, verticalPosition, horizontalPosition, rowOffset, colOffset) {
                    var _a;
                    var _b;
                    var self = this;
                    if (row < 0 || row >= getRowCount(self) || col < 0 || col >= getColumnCount(self)) {
                        return;
                    }
                    var scrollByPixel = self.parent && self.parent.options.scrollByPixel;
                    var scrollbarMaxAlign = self.parent && self.parent.options.scrollbarMaxAlign;
                    var columnViewportIndex = self._getColumnViewportIndex(col);
                    var rowViewportIndex = self._getRowViewportIndex(row);
                    var topRow = self.getViewportTopRow(rowViewportIndex);
                    var topRowOffset = self._scrollTopRowOffset;
                    var leftColumn = self.getViewportLeftColumn(columnViewportIndex);
                    var leftColumnOffset = self._scrollLeftColOffset;
                    if (columnViewportIndex === 1 && isNullOrUndefined(colOffset)) {
                        (_a = self._getNewLeftColumnAndOffset(col, horizontalPosition, scrollByPixel, scrollbarMaxAlign), col = _a.col, colOffset = _a.offset);
                    }
                    if (rowViewportIndex === 1 && isNullOrUndefined(rowOffset)) {
                        (_b = self._getNewTopRowAndOffset(row, verticalPosition, scrollByPixel, scrollbarMaxAlign), row = _b.row, rowOffset = _b.offset);
                    }
                    var needRepaint = false;
                    if (rowViewportIndex === 1 && (row !== topRow || rowOffset !== topRowOffset)) {
                        row = Math_min(row, self._getLastVisualScrollRow());
                        self._scrollTopRow = row;
                        self._scrollTopRowOffset = rowOffset;
                        self._syncVScrollbarPosition();
                        needRepaint = true;
                    }
                    if (columnViewportIndex === 1 && (col !== leftColumn || colOffset !== leftColumnOffset)) {
                        col = Math_min(col, self._getLastVisualScrollColumn());
                        self._scrollLeftCol = col;
                        self._scrollLeftColOffset = colOffset;
                        self._syncHScrollbarPosition();
                        needRepaint = true;
                    }
                    if (needRepaint) {
                        var sp = self.parent;
                        if (sp && !sp.options.scrollbarShowMax) {
                            self._needSyncHScrollbarSize = true;
                            self._needSyncVScrollbarSize = true;
                        }
                        self._invalidate();
                    }
                };
                Worksheet.prototype._getRowViewportIndex = function (row) {
                    var self = this;
                    var rowViewportIndex = 1;
                    if (row < getFrozenRowCount(self)) {
                        rowViewportIndex = 0;
                    } else if (row >= getRowCount(self) - getFrozenTrailingRowCount(self)) {
                        rowViewportIndex = 2;
                    }
                    return rowViewportIndex;
                };
                Worksheet.prototype._getColumnViewportIndex = function (col) {
                    var self = this;
                    var columnViewportIndex = 1;
                    if (col < getFrozenColumnCount(self)) {
                        columnViewportIndex = 0;
                    } else if (col >= getColumnCount(self) - getFrozenTrailingColumnCount(self)) {
                        columnViewportIndex = 2;
                    }
                    return columnViewportIndex;
                };
                Worksheet.prototype._getNewTopRowAndOffset = function (row, verticalPosition, scrollByPixel, scrollbarMaxAlign) {
                    var self = this;
                    var cachePool = self._cachePool;
                    var rowViewportIndex = self._getRowViewportIndex(row);
                    var topRow = self.getViewportTopRow(rowViewportIndex);
                    var offset = self._scrollTopRowOffset;
                    var frozenRowCount = getFrozenRowCount(self);
                    var dHeight;
                    var lastVisualRow = self._getLastVisualRow();
                    if (verticalPosition === 0) {
                        if (scrollbarMaxAlign) {
                            var lastRow = lastVisualRow;
                            dHeight = self.getViewportHeight(rowViewportIndex);
                            for (; frozenRowCount <= lastRow; lastRow--) {
                                dHeight -= cachePool._getZoomRowHeight(lastRow);
                                if (dHeight < 0) {
                                    if (row <= lastRow) {
                                        offset = 0;
                                    } else {
                                        row = lastRow;
                                        offset = dHeight;
                                    }
                                    break;
                                }
                            }
                        } else {
                            offset = 0;
                        }
                    } else if (verticalPosition === 1) {
                        var isRowChanged = false;
                        var isRowInLastHalfViewport = false;
                        if (scrollbarMaxAlign) {
                            var lastRow = lastVisualRow;
                            var halfViewportHeight = Math_floor(self.getViewportHeight(rowViewportIndex) / 2);
                            dHeight = halfViewportHeight;
                            for (; frozenRowCount <= lastRow; lastRow--) {
                                dHeight -= cachePool._getZoomRowHeight(lastRow);
                                if (dHeight < 0) {
                                    if (row >= lastRow) {
                                        lastRow--;
                                        dHeight += halfViewportHeight;
                                        isRowInLastHalfViewport = true;
                                    }
                                    break;
                                }
                            }
                            if (isRowInLastHalfViewport) {
                                for (; frozenRowCount <= lastRow; lastRow--) {
                                    dHeight -= cachePool._getZoomRowHeight(lastRow);
                                    if (dHeight < 0) {
                                        row = lastRow;
                                        offset = dHeight;
                                        isRowChanged = true;
                                        break;
                                    }
                                }
                            }
                        }
                        if (!isRowChanged) {
                            dHeight = Math_floor((self.getViewportHeight(rowViewportIndex) - cachePool._getZoomRowHeight(row)) / 2);
                            for (; frozenRowCount < row; row--) {
                                dHeight -= cachePool._getZoomRowHeight(row - 1);
                                if (dHeight < 0) {
                                    row = row - 1;
                                    offset = dHeight;
                                    break;
                                }
                            }
                            if (dHeight > 0 && row === frozenRowCount) {
                                offset = 0;
                            }
                        }
                    } else if (verticalPosition === 2) {
                        dHeight = self.getViewportHeight(rowViewportIndex) - cachePool._getZoomRowHeight(row);
                        for (; frozenRowCount < row; row--) {
                            dHeight -= cachePool._getZoomRowHeight(row - 1);
                            if (dHeight < 0) {
                                row = row - 1;
                                offset = dHeight;
                                break;
                            }
                        }
                        if (dHeight > 0 && row === frozenRowCount) {
                            offset = 0;
                        }
                    } else if (verticalPosition === 3) {
                        if (row > topRow) {
                            var _a = self._getSheetLayout();
                            var _viewportX = _a._viewportX;
                            var _viewportY = _a._viewportY;
                            var _viewportWidth = _a._viewportWidth;
                            var _viewportHeight = _a._viewportHeight;
                            var actualCellRect = self.getCellRect(row, self._activeColIndex);
                            var actualViewportRect = new common_1.Rect(_viewportX, _viewportY, _viewportWidth, _viewportHeight);
                            if (!actualViewportRect.containsRect(actualCellRect, true)) {
                                dHeight = self.getViewportHeight(rowViewportIndex) - cachePool._getZoomRowHeight(row);
                                for (; topRow < row; row--) {
                                    dHeight -= cachePool._getZoomRowHeight(row - 1);
                                    if (dHeight < 0) {
                                        row = row - 1;
                                        offset = dHeight;
                                        break;
                                    }
                                }
                            } else {
                                row = topRow;
                            }
                        } else {
                            offset = 0;
                        }
                    }
                    if (!scrollByPixel && offset < 0) {
                        offset = 0;
                        if (row < lastVisualRow) {
                            row += 1;
                        }
                    }
                    return {
                        row: row,
                        offset: offset
                    };
                };
                Worksheet.prototype._getNewLeftColumnAndOffset = function (col, horizontalPosition, scrollByPixel, scrollbarMaxAlign) {
                    var self = this;
                    var cachePool = self._cachePool;
                    var columnViewportIndex = self._getColumnViewportIndex(col);
                    var leftColumn = self.getViewportLeftColumn(columnViewportIndex);
                    var offset = self._scrollLeftColOffset;
                    var frozenColumnCount = getFrozenColumnCount(self);
                    var dWidth;
                    var lastVisualColumn = self._getLastVisualColumn();
                    if (horizontalPosition === 0) {
                        if (scrollbarMaxAlign) {
                            dWidth = self.getViewportWidth(columnViewportIndex);
                            var lastColumn = lastVisualColumn;
                            for (; frozenColumnCount <= lastColumn; lastColumn--) {
                                dWidth -= cachePool._getZoomColWidth(lastColumn);
                                if (dWidth < 0) {
                                    if (col <= lastColumn) {
                                        offset = 0;
                                    } else {
                                        col = lastColumn;
                                        offset = dWidth;
                                    }
                                    break;
                                }
                            }
                        } else {
                            offset = 0;
                        }
                    } else if (horizontalPosition === 1) {
                        var isColChanged = false;
                        var isColInLastHalfViewport = false;
                        if (scrollbarMaxAlign) {
                            var halfViewportWidth = Math_floor(self.getViewportWidth(columnViewportIndex) / 2);
                            dWidth = halfViewportWidth;
                            var lastColumn = lastVisualColumn;
                            for (; frozenColumnCount <= lastColumn; lastColumn--) {
                                dWidth -= cachePool._getZoomColWidth(lastColumn);
                                if (dWidth < 0) {
                                    if (col >= lastColumn) {
                                        lastColumn--;
                                        dWidth += halfViewportWidth;
                                        isColInLastHalfViewport = true;
                                    }
                                    break;
                                }
                            }
                            if (isColInLastHalfViewport) {
                                for (; frozenColumnCount <= lastColumn; lastColumn--) {
                                    dWidth -= cachePool._getZoomColWidth(lastColumn);
                                    if (dWidth < 0) {
                                        col = lastColumn;
                                        offset = dWidth;
                                        isColChanged = true;
                                        break;
                                    }
                                }
                            }
                        }
                        if (!isColChanged) {
                            dWidth = Math_floor((self.getViewportWidth(columnViewportIndex) - cachePool._getZoomColWidth(col)) / 2);
                            for (; frozenColumnCount < col; col--) {
                                dWidth -= cachePool._getZoomColWidth(col - 1);
                                if (dWidth < 0) {
                                    col = col - 1;
                                    offset = dWidth;
                                    break;
                                }
                            }
                            if (dWidth > 0 && col === frozenColumnCount) {
                                offset = 0;
                            }
                        }
                    } else if (horizontalPosition === 2) {
                        dWidth = self.getViewportWidth(columnViewportIndex) - cachePool._getZoomColWidth(col);
                        for (; frozenColumnCount < col; col--) {
                            dWidth -= cachePool._getZoomColWidth(col - 1);
                            if (dWidth < 0) {
                                col = col - 1;
                                offset = dWidth;
                                break;
                            }
                        }
                        if (dWidth > 0 && col === frozenColumnCount) {
                            offset = 0;
                        }
                    } else if (horizontalPosition === 3) {
                        if (col > leftColumn) {
                            var _a = self._getSheetLayout();
                            var _viewportX = _a._viewportX;
                            var _viewportY = _a._viewportY;
                            var _viewportWidth = _a._viewportWidth;
                            var _viewportHeight = _a._viewportHeight;
                            var actualCellRect = self.getCellRect(self._activeRowIndex, col);
                            var actualViewportRect = new common_1.Rect(_viewportX, _viewportY, _viewportWidth, _viewportHeight);
                            if (!actualViewportRect.containsRect(actualCellRect, true)) {
                                dWidth = self.getViewportWidth(columnViewportIndex) - cachePool._getZoomColWidth(col);
                                for (; leftColumn < col; col--) {
                                    dWidth -= cachePool._getZoomColWidth(col - 1);
                                    if (dWidth < 0) {
                                        col = col - 1;
                                        offset = dWidth;
                                        break;
                                    }
                                }
                            } else {
                                col = leftColumn;
                            }
                        } else {
                            offset = 0;
                        }
                    }
                    if (!scrollByPixel && offset < 0) {
                        offset = 0;
                        if (col < lastVisualColumn) {
                            col += 1;
                        }
                    }
                    return {
                        col: col,
                        offset: offset
                    };
                };
                Worksheet.prototype._getNewTopRow = function (row, verticalPosition) {
                    var self = this;
                    var cachePool = self._cachePool;
                    var rowViewportIndex = self._getRowViewportIndex(row);
                    var topRow = self.getViewportTopRow(rowViewportIndex);
                    var height;
                    if (verticalPosition !== 0) {
                        if (verticalPosition === 1) {
                            height = Math_floor((self.getViewportHeight(rowViewportIndex) - cachePool._getZoomRowHeight(row)) / 2);
                            for (; 0 < row; row--) {
                                height -= cachePool._getZoomRowHeight(row - 1);
                                if (height < 0) {
                                    break;
                                }
                            }
                        } else if (verticalPosition === 2) {
                            height = self.getViewportHeight(rowViewportIndex) - cachePool._getZoomRowHeight(row);
                            for (; 0 < row; row--) {
                                height -= cachePool._getZoomRowHeight(row - 1);
                                if (height < 0) {
                                    break;
                                }
                            }
                        } else if (verticalPosition === 3 && (!(row < topRow || topRow === -1))) {
                            height = self.getViewportHeight(rowViewportIndex) - cachePool._getZoomRowHeight(row);
                            for (; topRow < row; row--) {
                                height -= cachePool._getZoomRowHeight(row - 1);
                                if (height < 0) {
                                    break;
                                }
                            }
                        }
                    }
                    return row;
                };
                Worksheet.prototype.showColumn = function (col, horizontalPosition) {
                    this.showCell(this._scrollTopRow, col, 0, horizontalPosition);
                };
                Worksheet.prototype.showRow = function (row, verticalPosition) {
                    this.showCell(row, this._scrollLeftCol, verticalPosition, 0);
                };
                Worksheet.prototype.suspendEvent = function () {
                    this._eventSuspended++;
                };
                Worksheet.prototype.resumeEvent = function () {
                    this._eventSuspended--;
                    if (this._eventSuspended < 0) {
                        this._eventSuspended = 0;
                    }
                };
                Worksheet.prototype.isEventSuspended = function () {
                    return this._eventSuspended > 0;
                };
                Worksheet.prototype.currentTheme = function (value) {
                    var self = this;
                    if (arguments.length === 0) {
                        if (!self._currentTheme) {
                            self._resetCurrentTheme();
                        }
                        return self._currentTheme;
                    }
                    if (typeof value === const_string) {
                        if (theme_1.Themes[value]) {
                            value = theme_1.Themes[value];
                        } else {
                            value = new theme_1.Theme(value);
                        }
                    }
                    self._currentTheme = value;
                    self._render._resetDefaultFont();
                    self._clearStyleCache();
                    self._invalidate();
                    return self;
                };
                Worksheet.prototype._getDefaultTheme = function () {
                    var themeStyle = common_1._ThemeStyleHelper._getCssClassThemeStyle('');
                    var themeVersion = convertToInt(themeStyle.zIndex);
                    var theme = theme_1.Themes.Office2007;
                    if (themeVersion > 2007) {
                        theme = theme_1.Themes.Office;
                    }
                    return theme;
                };
                Worksheet.prototype._resetCurrentTheme = function () {
                    this._currentTheme = this._getDefaultTheme();
                    this._clearStyleCache();
                };
                Worksheet.prototype.reset = function () {
                    var self = this;
                    self._resetImp();
                    self._invalidate();
                };
                Worksheet.prototype._resetImp = function () {
                    var self = this;
                    var selectedState = self._isSelectedImp();
                    self._initializeActiveCell();
                    self._activeRowViewportIndex = 0;
                    self._activeColViewportIndex = 0;
                    self._initOptions();
                    self._layoutModel = keyword_null;
                    self._rowLayoutCache = {
                        colHeader: keyword_null,
                        viewport: keyword_null
                    };
                    self._colLayoutCache = {
                        rowHeader: keyword_null,
                        viewport: keyword_null
                    };
                    self._scrollTopRow = 0;
                    self._scrollTopRowOffset = 0;
                    self._scrollLeftCol = 0;
                    self._scrollLeftColOffset = 0;
                    self.frozenRowCount(0);
                    self.frozenColumnCount(0);
                    self.frozenTrailingRowCount(0);
                    self.frozenTrailingColumnCount(0);
                    Worksheet._callFeatureHandler(self, 'beforeSetHost');
                    var parent = self.parent;
                    if (parent) {
                        var activeSheet = parent.getActiveSheet();
                        if (activeSheet && self.name() === activeSheet.name()) {
                            self._setHost(parent._vp);
                        }
                    }
                    self._styleComposeCache = [{}, {}, {}, {}];
                    self._cachePool = new common_1._CachePool(self);
                    self._composedDefaultStyle = {};
                    if (_supportsCalc) {
                        self.resetCalc();
                    }
                    self._modelManager = new worksheet_model_1._SheetModelManager(self, Worksheet._defaultRowCount, Worksheet._defaultColCount, Worksheet._defaultColHeaderRowCount, Worksheet._defaultRowHeaderColumnCount, self.name());
                    self.defaults = self._modelManager.defaults;
                    self._isSelectedImp(selectedState);
                    self._resetCurrentTheme();
                    self._namedStyles = {};
                    self._needSyncHScrollbarSize = true;
                    self._needSyncVScrollbarSize = true;
                    if (self.parent && self.parent._paintSuspended) {
                        self._layoutSuspended = self.parent._paintSuspended;
                    } else {
                        self._layoutSuspended = 0;
                    }
                    if (self.parent && self.parent._eventSuspended) {
                        self._eventSuspended = self.parent._eventSuspended;
                    } else {
                        self._eventSuspended = 0;
                    }
                    self._dirtySuspended = 0;
                    self._disposed = false;
                    self._containerDiv = keyword_null;
                    self._rowStateProviders = [];
                    self._colStateProviders = [];
                    self._isUndo = false;
                    Worksheet._callFeatureHandler(self, 'init');
                };
                Worksheet.prototype._initOptions = function () {
                    var self = this;
                    $_each(defaultOptions, function (prop, value) {
                        if (!isNullOrUndefined(value)) {
                            var propertyValue = value;
                            if (prop === 'gridline') {
                                propertyValue = {
                                    color: common_1._ThemeStyleHelper._getCssClassThemeStyle('gc-gridlineColor').borderTopColor,
                                    showVerticalGridline: true,
                                    showHorizontalGridline: true
                                };
                            } else if (typeof propertyValue === 'object') {
                                propertyValue = domUtil_1.GC$.extend({}, value);
                            }
                            self.options[prop] = propertyValue;
                        }
                    });
                };
                Worksheet.prototype._onAttached = function (parent) {
                    var self = this;
                    self.parent = parent;
                    for (var i = self._layoutSuspended; i < parent._paintSuspended; i++) {
                        self.suspendPaint();
                    }
                    self._eventSuspended = parent._eventSuspended;
                    Worksheet._callFeatureHandler(self, 'attach', parent);
                };
                Worksheet.prototype._sameRange = function (range, range1) {
                    if (range.row === range1.row &&
                        range.col === range1.col &&
                        range.rowCount === range1.rowCount &&
                        range.colCount === range1.colCount) {
                        return true;
                    } else {
                        return false;
                    }
                };
                Worksheet.prototype._compareRange = function (baseRange, row, col, rowCount, colCount) {
                    var compareRange = this._getsArrayFormulas(row, col, rowCount, colCount).ranges;
                    for (var i = 0; i < compareRange.length; i++) {
                        for (var j = 0; j < baseRange.length; j++) {
                            if (this._sameRange(baseRange[i], compareRange[j])) {
                                return true;
                            }
                        }
                    }
                    return false;
                };
                Worksheet.prototype._checkArrayFormulaInsertCopyCells = function (row, column, rowCount, columnCount, shiftCells) {
                    var checkInsertCopyCells = false;
                    if (shiftCells !== undefined) {
                        if (shiftCells === 0) {
                            var moveRangeArrayFormulas = this._getsArrayFormulas(row, column, rowCount, this.getColumnCount() - column).ranges;
                            if (moveRangeArrayFormulas.length > 0) {
                                if (row - 1 > 0) {
                                    checkInsertCopyCells = this._compareRange(moveRangeArrayFormulas, row - 1, column, 1, this.getColumnCount() - column);
                                }
                                if (!checkInsertCopyCells) {
                                    checkInsertCopyCells = this._compareRange(moveRangeArrayFormulas, row + rowCount, column, 1, this.getColumnCount() - column);
                                }
                                if (!checkInsertCopyCells) {
                                    checkInsertCopyCells = this._compareRange(moveRangeArrayFormulas, row, column, rowCount, 1);
                                }
                            }
                        } else {
                            var moveRangeArrayFormulas = this._getsArrayFormulas(row, column, this.getRowCount() - row, columnCount).ranges;
                            if (moveRangeArrayFormulas.length > 0) {
                                if (row - 1 > 0) {
                                    checkInsertCopyCells = this._compareRange(moveRangeArrayFormulas, row - 1, column, this.getRowCount() - row, 1);
                                }
                                if (!checkInsertCopyCells) {
                                    checkInsertCopyCells = this._compareRange(moveRangeArrayFormulas, row + rowCount, column, this.getRowCount() - row, 1);
                                }
                                if (!checkInsertCopyCells) {
                                    checkInsertCopyCells = this._compareRange(moveRangeArrayFormulas, row, column, 1, columnCount);
                                }
                            }
                        }
                    } else {
                        checkInsertCopyCells = true;
                    }
                    return checkInsertCopyCells;
                };
                Worksheet.prototype._canChange = function (row, column, rowCount, columnCount, lockErrorMsg, arrayFormulaErrorMsg, isAllowDragInsert, shiftCells, isIgnoreFilterOutRow) {
                    var self = this;
                    if (
                        !isAllowDragInsert
                        && self.options.isProtected
                        && self._isAnyCellInRangeLocked(common_1._createRange(row, column, rowCount, columnCount), isIgnoreFilterOutRow)
                    ) {
                        lockErrorMsg && self._raiseInvalidOperation(1, lockErrorMsg);
                        return false;
                    }
                    var checkInsertCopyCells = this._checkArrayFormulaInsertCopyCells(row, column, rowCount, columnCount, shiftCells);
                    if (_supportsCalc && checkInsertCopyCells && !self._checkArrayFormula(row, column, rowCount, columnCount)) {
                        arrayFormulaErrorMsg && self._raiseInvalidOperation(1, arrayFormulaErrorMsg);
                        return false;
                    }
                    return true;
                };
                Worksheet.prototype.clear = function (row, column, rowCount, columnCount, area, storageType, ignoreFilteredOutRow, ignoreTable, ignorePivotTable) {
                    if (area !== 0) {
                        this._clearCore(row, column, rowCount, columnCount, area, storageType, ignoreFilteredOutRow, ignoreTable, ignorePivotTable);
                    }
                };
                Worksheet.prototype._clearCore = function (row, column, rowCount, columnCount, area, storageType, ignoreFilteredOutRow, ignoreTable, ignorePivotTable) {
                    var self = this;
                    var supportsCalc = _supportsCalc;
                    try {
                        supportsCalc && self.suspendCalcService();
                        self.suspendPaint();
                        var defaults = self.defaults;
                        var r = void 0;
                        var c = void 0;
                        var i = void 0;
                        var j = void 0;
                        var viewport = 3;
                        var e = {
                            changeType: 'clear',
                            row: row,
                            col: column,
                            rowCount: rowCount,
                            colCount: columnCount,
                            sheetArea: area,
                            type: storageType,
                            ignoreTable: ignoreTable,
                            ignorePivotTable: ignorePivotTable,
                            canClear: true
                        };

                        Worksheet._callFeatureHandler(self, const_onLayoutChanged, e);
                        if (!e.canClear) {
                            return;
                        }
                        if (isNullOrUndefined(area) || area === viewport) {
                            if (supportsCalc && !self._checkArrayFormula(row, column, rowCount, columnCount)) {
                                return false;
                            }
                            if (storageType & 1 && self.getDataSource && self.getDataSource()) {
                                self.suspendEvent();
                                for (r = row; r < row + rowCount; r++) {
                                    if (ignoreFilteredOutRow && self._isRowFilterOut && self._isRowFilterOut(r)) {
                                        continue;
                                    }
                                    for (c = column; c < column + columnCount; c++) {
                                        self.setValue(r, c, keyword_null, area);
                                    }
                                }
                                self.resumeEvent();
                            }
                        }
                        var modelManager = self._modelManager;
                        var calcBlock = supportsCalc && self._getCalcModel();
                        r = row === -1 ? 0 : row;
                        var rc = row === -1 ? modelManager.getRowCount(area) : rowCount;
                        c = column === -1 ? 0 : column;
                        var cc = column === -1 ? modelManager.getColumnCount(area) : columnCount;
                        var hiddenRowList = [];
                        for (var rowIndex = r; rowIndex < rc + r; rowIndex++) {
                            if (ignoreFilteredOutRow && self._isRowFilterOut && self._isRowFilterOut(rowIndex)) {
                                hiddenRowList.push(rowIndex);
                            }
                        }
                        modelManager.do('clear', r, c, rc, cc, storageType, hiddenRowList, area);
                        if (calcBlock && (storageType & 1)) {
                            calcBlock._unlinkCellExpression(r, c, rc, cc);
                            calcBlock.clear(r, c, rc, cc, modelManager._getChangesForCalcEngine());
                        }
                        if ((storageType & 8) && (!(row >= 0 && column >= 0))) {
                            if (column >= 0) {
                                for (j = 0; j < cc; j++) {
                                    self.setTag(-1, c + j, keyword_null, area);
                                }
                            } else if (row >= 0) {
                                for (i = 0; i < rc; i++) {
                                    if (ignoreFilteredOutRow && self._isRowFilterOut && self._isRowFilterOut(r + i)) {
                                        continue;
                                    }
                                    self.setTag(r + i, -1, keyword_null, area);
                                }
                            } else {
                                self.setTag(-1, -1, keyword_null, area);
                            }
                        }
                        if ((storageType & 256) && (!(row >= 0 && column >= 0))) {
                            if (column >= 0) {
                                for (j = 0; j < cc; j++) {
                                    self.setHyperlink(-1, c + j, keyword_null, area);
                                }
                            } else if (row >= 0) {
                                for (i = 0; i < rc; i++) {
                                    if (ignoreFilteredOutRow && self._isRowFilterOut && self._isRowFilterOut(r + i)) {
                                        continue;
                                    }
                                    self.setHyperlink(-1, -1, keyword_null);
                                }
                            }
                        }
                        if ((storageType & 2) && (!(row >= 0 && column >= 0))) {
                            if (column >= 0) {
                                for (j = 0; j < cc; j++) {
                                    self.setStyle(-1, c + j, keyword_null, area);
                                }
                            } else if (row >= 0) {
                                for (i = 0; i < rc; i++) {
                                    if (ignoreFilteredOutRow && self._isRowFilterOut && self._isRowFilterOut(r + i)) {
                                        continue;
                                    }
                                    self.setStyle(r + i, -1, keyword_null, area);
                                }
                            } else {
                                self.setStyle(-1, -1, keyword_null, area);
                            }
                        }
                        if (storageType & 32) {
                            if (row < 0) {
                                for (j = 0; j < cc; j++) {
                                    self.setColumnVisible(c + j, true, area);
                                    self.setColumnResizable(c + j, true, area);
                                    self.setColumnWidth(c + j, (area === 2) ? defaults.rowHeaderColWidth : defaults.colWidth, area);
                                }
                            }
                            if (column < 0) {
                                for (i = 0; i < rc; i++) {
                                    if (ignoreFilteredOutRow && self._isRowFilterOut && self._isRowFilterOut(r + i)) {
                                        continue;
                                    }
                                    self.setRowVisible(r + i, true, area);
                                    self.setRowResizable(r + i, true, area);
                                    self.setRowHeight(r + i, (area === 1) ? defaults.colHeaderRowHeight : defaults.rowHeight, area);
                                }
                            }
                        }
                        if ((isNullOrUndefined(area) || area === viewport) && (supportsCalc && (storageType & 1) === 1)) {
                            var calcModel = self._getCalcModel();
                            if (calcModel) {
                                calcModel._addCellsToDirty(row, column, rowCount, columnCount);
                            }
                        }
                        var changedCells = [];
                        for (i = 0; i < rc; i++) {
                            for (j = 0; j < cc; j++) {
                                changedCells.push({
                                    row: r + i,
                                    col: c + j
                                });
                            }
                        }
                        self._raiseRangeDataChanged(row, column, rc, cc, changedCells, 2, area);
                    } finally {
                        self.resumePaint();
                        supportsCalc && self.resumeCalcService(false);
                    }
                };
                Worksheet.prototype._adjustActiveCellToSelectable = function () {
                    var self = this;
                    var options = self.options;
                    var protectionOption = options.protectionOptions;
                    if (options.isProtected && protectionOption) {
                        var allowSelectLockedCells = protectionOption.allowSelectLockedCells;
                        var allowSelectUnlockedCells = protectionOption.allowSelectUnlockedCells;
                        if (
                            (allowSelectLockedCells === false && allowSelectUnlockedCells !== false)
                            || (allowSelectLockedCells !== false && allowSelectUnlockedCells === false)
                        ) {
                            var oldRow = self._activeRowIndex;
                            var oldCol = self._activeColIndex;
                            if (!self._canSelect(oldRow, oldCol)) {
                                self._clearSelectionImp();
                                self._moveActiveCellRight(oldRow, oldCol, true);
                                self._moveActiveCellEnd(4, oldRow, oldCol);
                            }
                        }
                    }
                };
                Worksheet.prototype.setArray = function (row, column, array, setFormula) {
                    var self = this;
                    var supportsCalc = _supportsCalc;
                    setFormula = supportsCalc && setFormula;
                    var rowCount = getRowCount(self);
                    var columnCount = getColumnCount(self);
                    if (array && 0 <= row && row < rowCount && 0 <= column && column < columnCount) {
                        supportsCalc && self.suspendCalcService();
                        self.suspendPaint();
                        try {
                            var r_1;
                            var c_1;
                            $_each(array, function (i, v) {
                                if (!(domUtil_1.GC$.isArray(v))) {
                                    r_1 = row + i;
                                    c_1 = column;
                                    if (r_1 < rowCount && c_1 < columnCount) {
                                        if (setFormula) {
                                            self.setFormula(r_1, c_1, v);
                                        } else {
                                            self.setValue(r_1, c_1, v, 3, true);
                                        }
                                    }
                                } else {
                                    $_each(v, function (j, vv) {
                                        r_1 = row + i;
                                        c_1 = column + j;
                                        if (r_1 < rowCount && c_1 < columnCount) {
                                            if (setFormula) {
                                                self.setFormula(r_1, c_1, vv);
                                            } else {
                                                self.setValue(r_1, c_1, vv, 3, true);
                                            }
                                        }
                                    });
                                }
                            });
                        } finally {
                            supportsCalc && self.resumeCalcService();
                            self.resumePaint();
                        }
                    }
                };
                Worksheet.prototype.getArray = function (row, column, rowCount, columnCount, getFormula) {
                    var self = this;
                    var array = [];
                    var rc = getRowCount(self);
                    var cc = getColumnCount(self);
                    getFormula = getFormula && _supportsCalc;
                    if (0 <= row && row < rc && 0 <= column && column < cc) {
                        if (row + rowCount > rc) {
                            rowCount = rc - row;
                        }
                        if (column + columnCount > cc) {
                            columnCount = cc - column;
                        }
                        for (var i = 0; i < rowCount; i++) {
                            array[i] = [];
                            for (var j = 0; j < columnCount; j++) {
                                if (getFormula) {
                                    array[i][j] = self.getFormula(row + i, column + j);
                                } else {
                                    array[i][j] = self.getValue(row + i, column + j);
                                }
                            }
                        }
                    }
                    return array;
                };
                Worksheet.prototype.setTag = function (row, col, tag, sheetArea) {
                    if (isNullOrUndefined(sheetArea)) {
                        sheetArea = 3;
                    }
                    var self = this;
                    if (sheetArea !== 0) {
                        var modelManager = self._modelManager;
                        var rowCount = modelManager.getRowCount(sheetArea);
                        var colCount = modelManager.getColumnCount(sheetArea);
                        if (row < -1 || row >= rowCount || col < -1 || col >= colCount) {
                            return;
                        }
                        tag = tryConvertDateToOADate(tag);
                        var oldTag = void 0;
                        var isEventsSuspended = (self._eventSuspended > 0);
                        if (!isEventsSuspended) {
                            oldTag = self.getTag(row, col, sheetArea);
                        }
                        modelManager.do('setValueForKey', row, col, const_tag, tag, sheetArea);
                        if (modelManager._inTransaction > 0) {
                            modelManager._changes.push({
                                type: 'setTag',
                                row,
                                col,
                                tag: oldTag
                            });
                        }
                        if (oldTag !== tag) {
                            if (row !== -1 && col !== -1) {
                                if (!isEventsSuspended) {
                                    self._raiseCellChanged(const_tag, row, col, sheetArea, oldTag, tag);
                                } else {
                                    self._clearCameraShapeCache(self, [
                                        {
                                            row: row,
                                            col: col
                                        }
                                    ], 0);
                                }
                            } else if (row !== -1 && col === -1) {
                                self._raiseRowChanged(row, sheetArea, const_tag, tag, oldTag);
                            } else if (row === -1 && col !== -1) {
                                self._raiseColumnChanged(col, sheetArea, const_tag, tag, oldTag);
                            }
                        }
                    }
                };
                Worksheet.prototype.getTag = function (row, col, sheetArea) {
                    var self = this;
                    if (isNullOrUndefined(sheetArea)) {
                        sheetArea = 3;
                    }
                    if (sheetArea !== 0) {
                        var tag = self._modelManager.getValueForKey(row, col, const_tag, sheetArea);
                        return tryConvertOADateToDate(tag);
                    }
                    return keyword_null;
                };
                Worksheet.prototype.tag = function (value) {
                    var self = this;
                    if (arguments.length === 0) {
                        var tag = self._modelManager.getValueForKey(-1, -1, const_tag, 3);
                        return tryConvertOADateToDate(tag);
                    }
                    self._modelManager.do('setValueForKey', -1, -1, const_tag, tryConvertDateToOADate(value), 3);
                    return self;
                };
                Worksheet.prototype.getParent = function () {
                    return this.parent;
                };
                Worksheet.prototype.getDirtyRows = function () {
                    return getDirtyOrInsertRows(this, true);
                };
                Worksheet.prototype.getInsertRows = function () {
                    return getDirtyOrInsertRows(this, false);
                };
                Worksheet.prototype.getDeletedRows = function () {
                    var rows = [];
                    var deletedRows = this._deletedRows;
                    if (deletedRows) {
                        $_each(deletedRows, function (i, v) {
                            if (v && !domUtil_1.GC$.isFunction(v)) {
                                rows.push({
                                    row: v.row,
                                    originalItem: v.data
                                });
                            }
                        });
                    }
                    return rows;
                };
                Worksheet.prototype.hasPendingChanges = function () {
                    var self = this;
                    var deletedRows = self._deletedRows;
                    if (deletedRows && deletedRows.length > 0) {
                        return true;
                    }
                    var dirtyNodes = self._modelManager._getDirtyNodes();
                    return !$_isEmptyObject(dirtyNodes);
                };
                Worksheet.prototype.clearPendingChanges = function (clearChangeInfo) {
                    var self = this;
                    if (isNullOrUndefined(clearChangeInfo) || $_isEmptyObject(clearChangeInfo)) {
                        self._modelManager._clearDirtyNodes();
                        self._deletedRows = [];
                        Worksheet._callFeatureHandler(self, 'clearPendingChanges');
                        return;
                    }
                    var row = clearChangeInfo.row;
                    var col = clearChangeInfo.col;
                    var rowCount = clearChangeInfo.rowCount;
                    var colCount = clearChangeInfo.colCount;
                    var clearType = clearChangeInfo.clearType;
                    clearType = clearType || ClearPendingChangeType.dirty;
                    if ((clearType & 1) === ClearPendingChangeType.dirty) {
                        self._clearDirtyChanges(row, col, rowCount, colCount);
                    }
                    if ((clearType & 2) === ClearPendingChangeType.insert) {
                        self._clearInsertChanges(row, col, rowCount, colCount);
                    }
                    if ((clearType & 4) === ClearPendingChangeType.delete) {
                        self._clearDeleteChanges(row, col, rowCount, colCount);
                    }
                };
                Worksheet.prototype._clearDirtyChanges = function (row, col, rowCount, colCount) {
                    var self = this;
                    var modelManager = self._modelManager;
                    var isClearWholeRowCol = self._isClearWholeRowCol(row, col, rowCount, colCount);
                    var isWholeRow = self._isWholeRow(col, colCount);
                    if (isClearWholeRowCol) {
                        modelManager._clearAllDirtyChangeNodes();
                        Worksheet._callFeatureHandler(self, 'clearPendingChanges');
                    } else {
                        modelManager._clearDirtyChangeNodes(isWholeRow, row, col, rowCount, colCount);
                    }
                };
                Worksheet.prototype._clearInsertChanges = function (row, col, rowCount, colCount) {
                    var self = this;
                    var modelManager = self._modelManager;
                    var isClearWholeRowCol = self._isClearWholeRowCol(row, col, rowCount, colCount);
                    var isWholeRow = self._isWholeRow(col, colCount);
                    modelManager._clearInsertChangeNodes(isClearWholeRowCol, isWholeRow, row, rowCount);
                };
                Worksheet.prototype._clearDeleteChanges = function (row, col, rowCount, colCount) {
                    var self = this;
                    if (self._isClearWholeRowCol(row, col, rowCount, colCount)) {
                        self._deletedRows = [];
                        return;
                    }
                    if (self._isWholeRow(col, colCount)) {
                        var deletedRows = self._deletedRows;
                        if (deletedRows) {
                            var needDeleteRowIndex_1 = [];
                            $_each(deletedRows, function (i, v) {
                                if (v) {
                                    var rowIndex = v.row;
                                    if (row <= rowIndex && rowIndex < row + rowCount) {
                                        needDeleteRowIndex_1.push(i);
                                    }
                                }
                            });
                            var length_1 = needDeleteRowIndex_1.length;
                            for (var i = length_1 - 1; i >= 0; i--) {
                                self._deletedRows.splice(needDeleteRowIndex_1[i], 1);
                            }
                        }
                    }
                };
                Worksheet.prototype._isWholeRow = function (col, colCount) {
                    return isNullOrUndefined(col) || col === -1 || (col === 0 && this.getColumnCount() === colCount);
                };
                Worksheet.prototype._isWholeCol = function (row, rowCount) {
                    return isNullOrUndefined(row) || row === -1 || (row === 0 && rowCount === this.getRowCount());
                };
                Worksheet.prototype._isClearWholeRowCol = function (row, col, rowCount, colCount) {
                    return this._isWholeRow(row, rowCount) && this._isWholeRow(col, colCount);
                };
                Worksheet.prototype.getDirtyCells = function (row, col, rowCount, colCount) {
                    var self = this;
                    if (isNullOrUndefined(row)) {
                        row = -1;
                    }
                    if (isNullOrUndefined(col)) {
                        col = -1;
                    }
                    if (isNullOrUndefined(rowCount) || rowCount <= 0) {
                        rowCount = 1;
                    }
                    if (isNullOrUndefined(colCount) || colCount <= 0) {
                        colCount = 1;
                    }
                    var cells = [];
                    var dirtyNodes = self._modelManager._getDirtyNodes();
                    if (!$_isEmptyObject(dirtyNodes)) {
                        var rowArray = [];
                        if (row >= 0) {
                            for (var rowIndex = row; rowIndex < row + rowCount; rowIndex++) {
                                rowArray.push(rowIndex);
                            }
                        } else {
                            for (var r in dirtyNodes) {
                                if (hasOwnProperty(dirtyNodes, r)) {
                                    rowArray.push(convertToInt(r));
                                }
                            }
                        }
                        var dirtyRow_1;
                        var node_2;
                        $_each(rowArray, function (i, index) {
                            dirtyRow_1 = dirtyNodes[index];
                            if (dirtyRow_1 && dirtyRow_1.rs === 'e') {
                                if (col >= 0) {
                                    for (var columnIndex = col; columnIndex < col + colCount; columnIndex++) {
                                        node_2 = dirtyRow_1[columnIndex];
                                        if (node_2) {
                                            cells.push(getDirtyValue(self, index, columnIndex, node_2.oldValue));
                                        }
                                    }
                                } else {
                                    for (var colIndex in dirtyRow_1) {
                                        if (!isNotANumber(colIndex)) {
                                            node_2 = dirtyRow_1[colIndex];
                                            if (node_2) {
                                                cells.push(getDirtyValue(self, index, convertToInt(colIndex), node_2.oldValue));
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    }
                    return cells;
                };
                Worksheet.prototype.suspendDirty = function () {
                    this._dirtySuspended++;
                    this._modelManager._suspendDirty();
                };
                Worksheet.prototype.resumeDirty = function () {
                    var self = this;
                    self._dirtySuspended--;
                    if (self._dirtySuspended < 0) {
                        self._dirtySuspended = 0;
                    }
                    self._modelManager._resumeDirty();
                };
                Worksheet.prototype.isDirtySuspended = function () {
                    return this._dirtySuspended > 0;
                };
                Worksheet.prototype._init = function (name) {
                    this._setBounds(new common_1.Rect(0, 0, 0, 0));
                    this._resetImp();
                    this._setNameCore(name);
                };
                Worksheet.prototype._getCanvasOffset = function () {
                    var sheet = this;
                    var canvas = sheet._getCanvas();
                    var t = {
                        top: 0,
                        left: 0
                    };
                    if (canvas && canvas.parentElement) {
                        t = domUtil_1.GC$(canvas).offset();
                        if (t) {
                            t.top += DOCUMENT.body.clientTop || 0;
                            t.left += DOCUMENT.body.clientLeft || 0;
                        }
                    }
                    var canvasOffset = canvas && canvas.canvasOffset;
                    if (canvasOffset) {
                        t = canvasOffset;
                    }
                    return t;
                };
                Worksheet.prototype._setHost = function (host) {
                    if (!host) {
                        return;
                    }
                    var self = this;
                    self._disposed = false;
                    var oldCanvas = self._canvas;
                    if (oldCanvas) {
                        self._dispose(false);
                    }
                    var canvas = _createElement('canvas');
                    var enableAccessibility = self.parent && self.parent.options.enableAccessibility;
                    var innerHTML = enableAccessibility ? '' : getSR().NeedCanvasSupport;
                    domUtil_1.GC$(canvas)
                        .attr('id', host.getAttribute('id') + '_vp')
                        .attr('gcUIElement', 'gcWorksheetCanvas')
                        .html(innerHTML)
                        .appendTo(host);
                    common_1._DPIHelper._adjustDevicePixel(canvas, keyword_null, self);
                    self._canvas = canvas;
                    self._doResize();
                    self.repaint();
                    if (self.parent) {
                        self.parent._paintWorkbookBackgroundImage();
                    }
                    Worksheet._callFeatureHandler(self, 'setHost', domUtil_1.GC$(canvas));
                };
                Worksheet.prototype._appendRowAccessibilityContent = function (rowData, row, freezeStart, freezeEnd, start, end, trailingFreezeStart, trailingFreezeEnd, sheetArea) {
                    var sheet = this;
                    for (var c = freezeStart; c < freezeEnd; c++) {
                        var cellText = sheet.getText(row, c, sheetArea);
                        rowData.push('"' + cellText + '"');
                    }
                    for (var c = start; c < end; c++) {
                        var cellText = sheet.getText(row, c, sheetArea);
                        rowData.push('"' + cellText + '"');
                    }
                    for (var c = trailingFreezeStart; c < trailingFreezeEnd; c++) {
                        var cellText = sheet.getText(row, c, sheetArea);
                        rowData.push('"' + cellText + '"');
                    }
                };
                Worksheet.prototype._getWholeViewportAccessibilityContent = function () {
                    var sheet = this;
                    var topRow = sheet.getViewportTopRow(1);
                    var bottomRow = sheet.getViewportBottomRow(1);
                    var leftCol = sheet.getViewportLeftColumn(1);
                    var rightCol = sheet.getViewportRightColumn(1);
                    var rowCount = bottomRow - topRow + 1;
                    var colCount = rightCol - leftCol + 1;
                    var colHeaderRowCount = sheet.getRowCount(core_enum_1.SheetArea.colHeader);
                    var rowHeaderColumnCount = sheet.getColumnCount(core_enum_1.SheetArea.rowHeader);
                    var frozenColumnCount = sheet.frozenColumnCount();
                    var frozenTrailingColumnCount = getFrozenTrailingColumnCount(sheet);
                    var sheetColumnCount = sheet.getColumnCount();
                    var frozenRowCount = sheet.frozenRowCount();
                    var frozenTrailingRowCount = getFrozenTrailingRowCount(sheet);
                    var sheetRowCount = sheet.getRowCount();
                    var stringBuilder = [];
                    for (var r = 0; r < colHeaderRowCount; r++) {
                        var colHeaderRowData = [];
                        sheet._appendRowAccessibilityContent(colHeaderRowData, r, 0, frozenColumnCount, leftCol, leftCol + colCount, sheetColumnCount - frozenTrailingColumnCount, sheetColumnCount, core_enum_1.SheetArea.colHeader);
                        stringBuilder.push(colHeaderRowData.join(','));
                    }
                    for (var r = 0; r < frozenRowCount; r++) {
                        var rowData = [];
                        for (var c = 0; c < rowHeaderColumnCount; c++) {
                            var rowHeaderCellText = sheet.getText(r, c, core_enum_1.SheetArea.rowHeader);
                            rowData.push('"' + rowHeaderCellText + '"');
                        }
                        sheet._appendRowAccessibilityContent(rowData, r, 0, frozenColumnCount, leftCol, leftCol + colCount, sheetColumnCount - frozenTrailingColumnCount, sheetColumnCount);
                        stringBuilder.push(rowData.join(','));
                    }
                    for (var r = topRow; r < topRow + rowCount; r++) {
                        var rowData = [];
                        for (var c = 0; c < rowHeaderColumnCount; c++) {
                            var rowHeaderCellText = sheet.getText(r, c, core_enum_1.SheetArea.rowHeader);
                            rowData.push('"' + rowHeaderCellText + '"');
                        }
                        sheet._appendRowAccessibilityContent(rowData, r, 0, frozenColumnCount, leftCol, leftCol + colCount, sheetColumnCount - frozenTrailingColumnCount, sheetColumnCount);
                        stringBuilder.push(rowData.join(','));
                    }
                    for (var r = sheetRowCount - frozenTrailingRowCount; r < sheetRowCount; r++) {
                        var rowData = [];
                        for (var c = 0; c < rowHeaderColumnCount; c++) {
                            var rowHeaderCellText = sheet.getText(r, c, core_enum_1.SheetArea.rowHeader);
                            rowData.push('"' + rowHeaderCellText + '"');
                        }
                        sheet._appendRowAccessibilityContent(rowData, r, 0, frozenColumnCount, leftCol, leftCol + colCount, sheetColumnCount - frozenTrailingColumnCount, sheetColumnCount);
                        stringBuilder.push(rowData.join(','));
                    }
                    return stringBuilder.join(';');
                };
                Worksheet.prototype._getAccessibilityContent = function (target) {
                    var self = this;
                    if (common_1.util._isMacOS()) {
                        return self._getWholeViewportAccessibilityContent();
                    }
                    var row = self._activeRowIndex;
                    var col = self._activeColIndex;
                    var sheetArea = core_enum_1.SheetArea.viewport;
                    if (target && !isNullOrUndefined(target.row) && !isNullOrUndefined(target.col)) {
                        row = target.row;
                        col = target.col;
                        sheetArea = target.hitTestType;
                    }
                    var resource = getSR();
                    var prefix = '';
                    var text = self.getText(row, col, sheetArea);
                    var formula;
                    var comment;
                    if (sheetArea === core_enum_1.SheetArea.rowHeader) {
                        prefix = resource.ARIA_RowHeader + ' ';
                    } else if (sheetArea === core_enum_1.SheetArea.colHeader) {
                        prefix = resource.ARIA_ColumnHeader + ' ';
                    } else if (isNullOrUndefined(sheetArea) || sheetArea === core_enum_1.SheetArea.viewport) {
                        formula = self.getFormula(row, col);
                        comment = self.comments && self.comments.get(row, col);
                    }
                    return prefix + self._getAccessibilityContentOfCell(row, col, text, formula, comment && comment.text());
                };
                Worksheet.prototype._getAccessibilityContentOfCell = function (row, col, text, formula, comment) {
                    var resource = getSR();
                    var content = resource.ARIA_Cell + ' ' + common_1.util._indexToLetters(col + 1) + (row + 1) + ' ';
                    if (!isNullOrUndefined(text) && text !== '') {
                        content += _StringHelper._format(resource.ARIA_HasValue, [text]) + ', ';
                    }
                    if (!isNullOrUndefined(formula)) {
                        content += _StringHelper._format(resource.ARIA_HasFormula, [formula]) + ', ';
                    }
                    if (!isNullOrUndefined(comment)) {
                        content += _StringHelper._format(resource.ARIA_HasComment, [comment]);
                    }
                    return content;
                };
                Worksheet.prototype._doResize = function () {
                    var sheet = this;
                    var canvas = sheet._getCanvas();
                    if (!canvas || !canvas.parentNode) {
                        return;
                    }
                    var computedStyle = getComputedStyle(canvas.parentNode);
                    var parentWidthCss = computedStyle.width;
                    var parentHeightCss = computedStyle.height;
                    var pxIndex = parentWidthCss.indexOf('px');
                    if (pxIndex > 0) {
                        parentWidthCss = parentWidthCss.substring(0, pxIndex);
                    }
                    pxIndex = parentHeightCss.indexOf('px');
                    if (pxIndex > 0) {
                        parentHeightCss = parentHeightCss.substring(0, pxIndex);
                    }
                    var parentWidth = convertToInt(parentWidthCss);
                    var parentHeight = convertToInt(parentHeightCss);
                    if (isNotANumber(parentWidth)) {
                        parentWidth = domUtil_1.GC$(canvas.parentNode).width();
                    }
                    if (isNotANumber(parentHeight)) {
                        parentHeight = domUtil_1.GC$(canvas.parentNode).height();
                    }
                    if (parentWidth === 0 || parentHeight === 0) {
                        return;
                    }
                    var width = Math_max(parentWidth, 0);
                    var height = Math_max(parentHeight, 0);
                    canvas.style.display = 'none';
                    canvas.style.display = '';
                    canvas.width = width;
                    canvas.height = height;
                    canvas.style.width = width + 'px';
                    canvas.style.height = height + 'px';
                    width = canvas.clientWidth || canvas.width;
                    height = canvas.clientHeight || canvas.height;
                    sheet._bounds.width = width;
                    sheet._bounds.height = height;
                    common_1._DPIHelper._setSize(canvas, width, height);
                    sheet.invalidateLayout();
                };
                Worksheet.prototype._dispose = function (clearCache, hasActiveSheet) {
                    var self = this;
                    if (self._disposed === true) {
                        return;
                    }
                    common_1._DPIHelper._disposeSheet(self);
                    if (self.isEditing && self.isEditing()) {
                        self._endEditCore();
                    }
                    Worksheet._callFeatureHandler(self, 'dispose', {
                        clearCache: clearCache,
                        isSheetDestroy: true,
                        hasActiveSheet: hasActiveSheet
                    });
                    var canvas = self._canvas;
                    var parentNode;
                    if (canvas) {
                        parentNode = canvas.parentNode;
                        if (parentNode) {
                            parentNode.removeChild(canvas);
                        }
                        self._canvas = keyword_null;
                    }
                    self._disposeStringWidthPre();
                    if (self._modelManager) {
                        self._modelManager._dispose(clearCache);
                    }
                    if (clearCache !== false) {
                        self._disposed = true;
                        var cutCopyIndicatorManager = self._cutCopyIndicatorManager;
                        if (cutCopyIndicatorManager) {
                            cutCopyIndicatorManager._dispose();
                        }
                        self.parent = keyword_null;
                        self._modelManager = keyword_null;
                        if (self._cachePool) {
                            self._cachePool._dispose();
                            self._cachePool = keyword_null;
                        }
                        if (self._imageLoader) {
                            self._imageLoader._dispose();
                            self._imageLoader = keyword_null;
                        }
                        if (common_1._FocusHelper._isActiveElement(self)) {
                            common_1._FocusHelper._setActiveElement(keyword_null, true);
                        }
                        if (self._clipboardHelper) {
                            self._clipboardHelper = keyword_null;
                        }
                        self._rowStateProviders = keyword_null;
                        self._colStateProviders = keyword_null;
                    }
                };
                Worksheet.prototype._disposeStringWidthPre = function () {
                    var pre = this._editingPre;
                    if (pre) {
                        domUtil_1.GC$(pre).remove();
                        this._editingPre = keyword_undefined;
                    }
                };
                Worksheet.prototype._getValueImp = function (modelManager, row, col, sheetArea, valueType) {
                    if (isNullOrUndefined(sheetArea)) {
                        sheetArea = 3;
                    }
                    if (sheetArea === 3 && this._considerDynamicArray) {
                        var anchor = modelManager.getDynamicArrayInfo(row, col);
                        if (anchor && anchor.isValid && (row !== anchor.row || col !== anchor.col)) {
                            return keyword_null;
                        }
                    }
                    var vpCalcSheetModel = this._vpCalcSheetModel;
                    if (!this.loading && vpCalcSheetModel) {
                        var calcService = vpCalcSheetModel.getCalcService();
                        if (calcService.calcOnDemand && sheetArea === 3 && !calcService.IsSuspended()) {
                            var x = vpCalcSheetModel._getCellCalc(row, col);
                            if (x && x._dirty === true) {
                                x._dirty = false;
                                delete x._preDirty;
                                delete x._nextDirty;
                                vpCalcSheetModel.recalculateCell(row, col);
                                this._getSheetSource()._triggerRangChangedEventAsync();
                            }
                        }
                    }
                    var t = modelManager.getValue(row, col, sheetArea, this.loading, valueType);
                    t = tryConvertOADateToDate(t);
                    return t;
                };
                Worksheet.prototype._getActualRange = function (range, sheetArea) {
                    if (isNullOrUndefined(sheetArea)) {
                        sheetArea = 3;
                    }
                    var actualRange = common_1._createRange(-1, -1, -1, -1);
                    if (range) {
                        var self_2 = this;
                        var row = range.row;
                        var col = range.col;
                        var rowCount = range.rowCount;
                        var colCount = range.colCount;
                        if (col === -1) {
                            col = 0;
                            colCount = self_2.getColumnCount(sheetArea);
                        }
                        if (row === -1) {
                            row = 0;
                            rowCount = self_2.getRowCount(sheetArea);
                        }
                        actualRange.col = col;
                        actualRange.row = row;
                        actualRange.colCount = colCount;
                        actualRange.rowCount = rowCount;
                    }
                    return actualRange;
                };
                Worksheet.prototype.getRangeRect = function (rowViewportIndex, colViewportIndex, range) {
                    var rect = new common_1.Rect(-1, -1, -1, -1);
                    var self = this;
                    var layout = self._getSheetLayout();
                    if (layout.width === 0 || layout.height === 0) {
                        return rect;
                    }
                    var colLayouts = self._getViewportColumnLayout(colViewportIndex);
                    var rowLayouts = self._getViewportRowLayout(rowViewportIndex);
                    if (!colLayouts || colLayouts.length === 0 || !rowLayouts || rowLayouts.length === 0) {
                        return rect;
                    }
                    var actualRange = self._getActualRange(range);
                    var cachePool = self._cachePool;
                    var row1 = actualRange.row;
                    var row2 = actualRange.row + actualRange.rowCount - 1;
                    var col1 = actualRange.col;
                    var col2 = actualRange.col + actualRange.colCount - 1;
                    var firstRow = getFrozenRowCount(self);
                    var lastRow = getRowCount(self) - getFrozenTrailingRowCount(self) - 1;
                    var firstCol = getFrozenColumnCount(self);
                    var lastCol = getColumnCount(self) - getFrozenTrailingColumnCount(self) - 1;
                    var vLeftCol = colLayouts[0].col;
                    var vRightCol = colLayouts[colLayouts.length - 1].col;
                    var vTopRow = rowLayouts[0].row;
                    var vBottomRow = rowLayouts[rowLayouts.length - 1].row;
                    function getPrevVisualCol(col, endCol) {
                        while (col > endCol) {
                            col--;
                            if (self.getColumnVisible(col)) {
                                return col;
                            }
                        }
                        return col;
                    }
                    function getNextVisualCol(col, endCol) {
                        while (col < endCol) {
                            col++;
                            if (self.getColumnVisible(col)) {
                                return col;
                            }
                        }
                        return col;
                    }
                    function getPrevVisualRow(row, endRow) {
                        while (row > endRow) {
                            row--;
                            if (self.getRowVisible(row)) {
                                return row;
                            }
                        }
                        return row;
                    }
                    function getNextVisualRow(row, endRow) {
                        while (row < endRow) {
                            row++;
                            if (self.getRowVisible(row)) {
                                return row;
                            }
                        }
                        return row;
                    }
                    if (col1 < vLeftCol) {
                        col1 = getPrevVisualCol(vLeftCol, col1);
                    }
                    if (col2 > vRightCol) {
                        col2 = getNextVisualCol(vRightCol, col2);
                    }
                    if (row1 < vTopRow) {
                        row1 = getPrevVisualRow(vTopRow, row1);
                    }
                    if (row2 > vBottomRow) {
                        row2 = getNextVisualRow(vBottomRow, row2);
                    }
                    if (col2 < col1 || row2 < row1) {
                        return rect;
                    }
                    if (colViewportIndex === 0) {
                        if (col1 < firstCol) {
                            rect.x = layout._frozenX + getColsWidth(cachePool, 0, col1 - 1);
                            rect.width = getColsWidth(cachePool, col1, col2);
                        }
                    } else if (colViewportIndex === 1) {
                        if (col1 <= lastCol && col2 >= firstCol) {
                            if (col1 < vLeftCol) {
                                rect.x = colLayouts[0].x - getColsWidth(cachePool, col1, vLeftCol - 1);
                            } else {
                                rect.x = colLayouts[0].x + getColsWidth(cachePool, vLeftCol, col1 - 1);
                            }
                            rect.width = getColsWidth(cachePool, col1, col2);
                        }
                    } else if (colViewportIndex === 2 && col2 > lastCol) {
                        if (col1 < vLeftCol) {
                            rect.x = layout._frozenTrailingX - getColsWidth(cachePool, col1, vLeftCol - 1);
                        } else {
                            rect.x = layout._frozenTrailingX + getColsWidth(cachePool, vLeftCol, col1 - 1);
                        }
                        rect.width = getColsWidth(cachePool, col1, col2);
                    }
                    if (rowViewportIndex === 0) {
                        if (row1 < firstRow) {
                            rect.y = layout._frozenY + getRowsHeight(cachePool, 0, row1 - 1);
                            rect.height = getRowsHeight(cachePool, row1, row2);
                        }
                    } else if (rowViewportIndex === 1) {
                        if (row1 <= lastRow && row2 >= firstRow) {
                            if (row1 < vTopRow) {
                                rect.y = rowLayouts[0].y - getRowsHeight(cachePool, row1, vTopRow - 1);
                            } else {
                                rect.y = rowLayouts[0].y + getRowsHeight(cachePool, vTopRow, row1 - 1);
                            }
                            rect.height = getRowsHeight(cachePool, row1, row2);
                        }
                    } else if (rowViewportIndex === 2 && row2 > lastRow) {
                        if (row1 < vTopRow) {
                            rect.y = layout._frozenTrailingY - getRowsHeight(cachePool, row1, vTopRow - 1);
                        } else {
                            rect.y = layout._frozenTrailingY + getRowsHeight(cachePool, vTopRow, row1 - 1);
                        }
                        rect.height = getRowsHeight(cachePool, row1, row2);
                    }
                    return rect;
                };
                Worksheet.prototype.isintersectWithArrayFormula = function (range) {
                    var calcModel = this._getCalcModel();
                    if (calcModel) {
                        for (var i = range.row; i < range.row + range.rowCount; i++) {
                            for (var j = range.col; j < range.col + range.colCount; j++) {
                                if (calcModel._intersectWithArrayFormula(i, j, 1, 1)) {
                                    return true;
                                }
                            }
                        }
                    }
                    return false;
                };
                Worksheet.prototype._getRangeWholeRect = function (range) {
                    var self = this;
                    var rect = new common_1.Rect(-1, -1, -1, -1);
                    var layout = self._getSheetLayout();
                    if (layout.width === 0 || layout.height === 0) {
                        return rect;
                    }
                    var actualRange = self._getActualRange(range);
                    var frozenColCount = getFrozenColumnCount(self);
                    var frozenRowCount = getFrozenRowCount(self);
                    var frozenTrailingColCount = getFrozenTrailingColumnCount(self);
                    var frozenTrailingRowCount = getFrozenTrailingRowCount(self);
                    var cachePool = self._cachePool;
                    var row1 = actualRange.row;
                    var row2 = actualRange.row + actualRange.rowCount - 1;
                    var col1 = actualRange.col;
                    var col2 = actualRange.col + actualRange.colCount - 1;
                    var rowCount = getRowCount(self);
                    var colCount = getColumnCount(self);
                    var colLayout;
                    var rowLayout;
                    if (col1 < frozenColCount) {
                        rect.x = layout._frozenX + getColsWidth(cachePool, 0, col1 - 1);
                        rect.width = getColsWidth(cachePool, col1, Math_min(col2, frozenColCount - 1));
                        if (frozenColCount <= col2 && col2 < colCount - frozenTrailingColCount) {
                            colLayout = self._getViewportColumnLayout(1);
                            if (colLayout && colLayout.length > 0) {
                                rect.width += getColsWidth(cachePool, colLayout[0].col, Math_min(col2, colLayout[colLayout.length - 1].col)) + self._scrollLeftColOffset;
                            }
                        } else if (col2 >= colCount - frozenTrailingColCount) {
                            colLayout = self._getViewportColumnLayout(2);
                            if (colLayout && colLayout.length > 0) {
                                rect.width = colLayout[0].x - rect.x;
                                rect.width += getColsWidth(cachePool, colCount - frozenTrailingColCount, Math_min(col2, colCount - 1));
                            }
                        }
                    } else if (col1 < colCount - frozenTrailingColCount) {
                        colLayout = self._getViewportColumnLayout(1);
                        if (!colLayout || colLayout.length === 0 || col1 > colLayout[colLayout.length - 1].col || col2 < colLayout[0].col) {
                            return rect;
                        }
                        rect.x = layout._viewportX + getColsWidth(cachePool, colLayout[0].col, col1 - 1) + self._scrollLeftColOffset;
                        if (frozenColCount <= col2 && col2 < colCount - frozenTrailingColCount) {
                            rect.width = getColsWidth(cachePool, Math_max(col1, colLayout[0].col), Math_min(col2, colLayout[colLayout.length - 1].col));
                        } else if (col2 >= colCount - frozenTrailingColCount) {
                            colLayout = self._getViewportColumnLayout(2);
                            if (colLayout && colLayout.length > 0) {
                                rect.width = colLayout[0].x - rect.x;
                                rect.width += getColsWidth(cachePool, colCount - frozenTrailingColCount, Math_min(col2, colCount - 1));
                            }
                        }
                    } else if (col1 < colCount) {
                        colLayout = self._getViewportColumnLayout(2);
                        if (colLayout && colLayout.length > 0) {
                            rect.x = layout._frozenTrailingX + getColsWidth(cachePool, colLayout[0].col, col1 - 1);
                            rect.width = getColsWidth(cachePool, col1, Math_min(col2, colCount - 1));
                        }
                    }
                    if (row1 < frozenRowCount) {
                        rect.y = layout._frozenY + getRowsHeight(cachePool, 0, row1 - 1);
                        rect.height = getRowsHeight(cachePool, row1, Math_min(row2, frozenRowCount - 1));
                        if (frozenRowCount <= row2 && row2 < rowCount - frozenTrailingRowCount) {
                            rowLayout = self._getViewportRowLayout(1);
                            if (rowLayout && rowLayout.length > 0) {
                                rect.height += getRowsHeight(cachePool, rowLayout[0].row, Math_min(row2, rowLayout[rowLayout.length - 1].row)) + self._scrollTopRowOffset;
                            }
                        } else if (row2 >= rowCount - frozenTrailingRowCount) {
                            rowLayout = self._getViewportRowLayout(2);
                            if (rowLayout && rowLayout.length > 0) {
                                rect.height = rowLayout[0].y - rect.y;
                                rect.height += getRowsHeight(cachePool, rowCount - frozenTrailingRowCount, Math_min(row2, rowCount - 1));
                            }
                        }
                    } else if (row1 < rowCount - frozenTrailingRowCount) {
                        rowLayout = self._getViewportRowLayout(1);
                        if (!rowLayout || rowLayout.length === 0 || row1 > rowLayout[rowLayout.length - 1].row || row2 < rowLayout[0].row) {
                            return rect;
                        }
                        rect.y = layout._viewportY + getRowsHeight(cachePool, rowLayout[0].row, row1 - 1) + self._scrollTopRowOffset;
                        if (frozenRowCount <= row2 && row2 < rowCount - frozenTrailingRowCount) {
                            rect.height = getRowsHeight(cachePool, Math_max(row1, rowLayout[0].row), Math_min(row2, rowLayout[rowLayout.length - 1].row));
                        } else if (row2 >= rowCount - frozenTrailingRowCount) {
                            rowLayout = self._getViewportRowLayout(2);
                            if (rowLayout && rowLayout.length > 0) {
                                rect.height = rowLayout[0].y - rect.y;
                                rect.height += getRowsHeight(cachePool, rowCount - frozenTrailingRowCount, Math_min(row2, rowCount - 1));
                            }
                        }
                    } else if (row1 < rowCount) {
                        rowLayout = self._getViewportRowLayout(2);
                        if (rowLayout && rowLayout.length > 0) {
                            rect.y = layout._frozenTrailingY + getRowsHeight(cachePool, rowLayout[0].row, row1 - 1);
                            rect.height += getRowsHeight(cachePool, row1, Math_min(row2, rowCount - 1));
                        }
                    }
                    return rect;
                };
                Worksheet.prototype._getCanvas = function () {
                    return this._canvas;
                };
                Worksheet.prototype._getStringWidth = function (value, font) {
                    return this._getStringWidthByCanvas(value, font) + 1;
                };
                Worksheet.prototype._getStringWidthByCanvas = function (value, font) {
                    var currentFont = '';
                    var render = this._render;
                    if (font) {
                        currentFont = font;
                    } else {
                        currentFont = render._getZoomFont(render._getDefaultFont());
                    }
                    return common_1._WordWrapHelper._measureText(value, currentFont);
                };
                Worksheet.prototype._getColumnViewportIndexFromX = function (x) {
                    var self = this;
                    var layout = self._getSheetLayout();
                    var colViewportIndex = keyword_null;
                    var viewportX = layout._viewportX;
                    var viewportWidth = self._getActualViewportWidth(layout);
                    var frozenTrailingX = layout._frozenTrailingX;
                    var frozenTrailingWidth = layout._frozenTrailingWidth;
                    if (layout._headerX < x && x < layout._headerX + layout._rowHeaderWidth) {
                        colViewportIndex = -1;
                    } else if (layout._frozenX < x && x < layout._frozenX + layout._frozenWidth) {
                        colViewportIndex = 0;
                    } else if (viewportX < x && x < viewportX + viewportWidth) {
                        colViewportIndex = 1;
                    } else if (frozenTrailingX < x && x < frozenTrailingX + frozenTrailingWidth) {
                        colViewportIndex = 2;
                    }
                    return colViewportIndex;
                };
                Worksheet.prototype._getRowViewportIndexFromY = function (y) {
                    var self = this;
                    var layout = self._getSheetLayout();
                    var rowViewportIndex = keyword_null;
                    var viewportY = layout._viewportY;
                    var viewportHeight = self._getActualViewportHeight(layout);
                    var frozenTrailingY = layout._frozenTrailingY;
                    var frozenTrailingHeight = layout._frozenTrailingHeight;
                    if (layout._headerY < y && y < layout._headerY + layout._colHeaderHeight) {
                        rowViewportIndex = -1;
                    } else if (layout._frozenY < y && y < layout._frozenY + layout._frozenHeight) {
                        rowViewportIndex = 0;
                    } else if (viewportY < y && y < viewportY + viewportHeight) {
                        rowViewportIndex = 1;
                    } else if (frozenTrailingY < y && y < frozenTrailingY + frozenTrailingHeight) {
                        rowViewportIndex = 2;
                    }
                    return rowViewportIndex;
                };
                Worksheet.prototype._getRowIndexFromY = function (y, rowViewportIndex) {
                    var rowLayouts;
                    if (rowViewportIndex === -1) {
                        rowLayouts = this._getColumnHeaderRowLayout();
                    } else {
                        rowLayouts = this._getViewportRowLayout(rowViewportIndex);
                    }
                    if (rowLayouts) {
                        var rowLayout = rowLayouts.findY(y);
                        if (rowLayout) {
                            return rowLayout.row;
                        }
                    }
                };
                Worksheet.prototype._getColumnIndexFromX = function (x, colViewportIndex) {
                    var colLayouts;
                    if (colViewportIndex === -1) {
                        colLayouts = this._getRowHeaderColumnLayout();
                    } else {
                        colLayouts = this._getViewportColumnLayout(colViewportIndex);
                    }
                    if (colLayouts) {
                        var colLayout = colLayouts.findX(x);
                        if (colLayout) {
                            return colLayout.col;
                        }
                    }
                };
                Worksheet.prototype._isActiveCell = function (r, c) {
                    var self = this;
                    return (
                        self._activeRowIndex <= r
                        && r < self._activeRowIndex + self._activeRowCount
                        && self._activeColIndex <= c
                        && c < self._activeColIndex + self._activeColCount
                    );
                };
                Worksheet.prototype._isColumnSelected = function (c) {
                    return this._modelManager._isColumnSelected(c);
                };
                Worksheet.prototype._isRowSelected = function (r) {
                    return this._modelManager._isRowSelected(r);
                };
                Worksheet.prototype._isSelected = function (r, c, sheetArea, considerAdjacentCell) {
                    var self = this;
                    var sheetRowCount = getRowCount(self);
                    var sheetColCount = getColumnCount(self);
                    return this._modelManager._isSelected(r, c, sheetArea, sheetRowCount, sheetColCount, considerAdjacentCell);
                };
                Worksheet.prototype._isAllSelected = function (r, c, sheetArea) {
                    var self = this;
                    var sheetRowCount = getRowCount(self);
                    var sheetColCount = getColumnCount(self);
                    return this._modelManager._isAllSelected(r, c, sheetArea, sheetRowCount, sheetColCount);
                };
                Worksheet.prototype._isHover = function (r, c, sheetArea) {
                    var self = this;
                    var inSpans;
                    var span;
                    var hovered;
                    var target = self._currentTarget;
                    if (target && !target.resizeInfo && !isNullOrUndefined(sheetArea)) {
                        var hitTestType = target.hitTestType;
                        var target_row = target.row;
                        var target_col = target.col;
                        if (sheetArea === 1) {
                            inSpans = false;
                            span = self._modelManager.findSpan(target_row, target_col, 1);
                            if (span) {
                                inSpans = span.contains(r, c, 1, 1);
                            }
                            hovered = (r === target_row && c === target_col) || (inSpans);
                            return (hitTestType === sheetArea && hovered);
                        } else if (sheetArea === 2) {
                            inSpans = false;
                            span = self._modelManager.findSpan(target_row, target_col, 2);
                            if (span) {
                                inSpans = span.contains(r, c, 1, 1);
                            }
                            hovered = (r === target_row && c === target_col) || (inSpans);
                            return (hitTestType === sheetArea && hovered);
                        } else if (sheetArea === 3) {
                            return (hitTestType === sheetArea && r === target_row && c === target_col);
                        } else if (sheetArea === 0) {
                            return (hitTestType === sheetArea);
                        }
                    }
                    return false;
                };
                Worksheet.prototype._getSheetArea = function (rowViewportIndex, colViewportIndex) {
                    if (rowViewportIndex >= 0 && rowViewportIndex <= 2 && colViewportIndex >= 0) {
                        return 3;
                    } else if (rowViewportIndex >= 0 && rowViewportIndex <= 2 && colViewportIndex < 0) {
                        return 2;
                    } else if (rowViewportIndex < 0 && colViewportIndex >= 0) {
                        return 1;
                    } else if (rowViewportIndex < 0 && colViewportIndex < 0) {
                        return 0;
                    }
                    return keyword_null;
                };
                Worksheet.prototype._setFocus = function (doNotGetCellTypeFocus) {
                    var eventHandler = this._eventHandler;
                    if (eventHandler) {
                        eventHandler._setFocus(doNotGetCellTypeFocus);
                    }
                };
                Worksheet.prototype._getHost = function () {
                    var self = this;
                    var host;
                    var workbook = self.parent;
                    host = workbook && workbook._host;
                    if (!host) {
                        var sheetCanvas = self._canvas;
                        host = sheetCanvas && sheetCanvas.parentElement;
                    }
                    return host;
                };
                Worksheet.prototype._initializeActiveCell = function () {
                    var self = this;
                    var row = 0;
                    var col = 0;
                    var rowCount = 1;
                    var colCount = 1;
                    self._activeRowIndex = row;
                    self._activeColIndex = col;
                    self._activeRowCount = rowCount;
                    self._activeColCount = colCount;
                    self._leadingCellRow = row;
                    self._leadingCellCol = col;
                };
                Worksheet.prototype._getZoomRowHeight = function (row, sheetArea, keepOriginalValue) {
                    var self = this;
                    var height = self.getRowHeight(row, sheetArea);
                    var zoomFactor = self.zoom();
                    if (zoomFactor !== 1) {
                        height *= zoomFactor;
                    }
                    return keepOriginalValue ? height : Math_ceil(height);
                };
                Worksheet.prototype._getZoomColumnWidth = function (col, sheetArea, keepOriginalValue) {
                    var self = this;
                    var width = self.getColumnWidth(col, sheetArea);
                    var zoomFactor = self.zoom();
                    if (zoomFactor !== 1) {
                        width *= zoomFactor;
                    }
                    return keepOriginalValue ? width : Math_ceil(width);
                };
                Worksheet.prototype._createLayout = function () {
                    var self = this;
                    var sheetBounds = self._getBounds();
                    var options = self.options;
                    var offsetLeft = options.sheetAreaOffset.left;
                    var offsetTop = options.sheetAreaOffset.top;
                    var bounds = new common_1.Rect(sheetBounds.x + offsetLeft, sheetBounds.y + offsetTop, Math_max(0, sheetBounds.width - offsetLeft), Math_max(0, sheetBounds.height - offsetTop));
                    var totalWidth = bounds.width;
                    var totalHeight = bounds.height;
                    var isFrozenTrailingRowStickToEdge = frozenTrailingRowStickToEdge(self);
                    var isFrozenTrailingColumnStickToEdge = frozenTrailingColumnStickToEdge(self);
                    var layout = {
                        x: bounds.x,
                        y: bounds.y,
                        width: bounds.width,
                        height: bounds.height,
                        _rowHeaderWidth: 0,
                        _colHeaderHeight: 0,
                        _frozenWidth: 0,
                        _frozenHeight: 0,
                        _frozenTrailingWidth: 0,
                        _frozenTrailingHeight: 0,
                        _footerHeight: 0,
                        _footerWidth: 0,
                        _footerX: 0,
                        _footerY: 0,
                        _frozenX: 0,
                        _frozenY: 0,
                        _frozenTrailingX: 0,
                        _frozenTrailingY: 0,
                        _viewportX: 0,
                        _viewportY: 0,
                        _viewportHeight: 0,
                        _viewportWidth: 0,
                        _grayAreaX: 0,
                        _grayAreaY: 0,
                        _grayAreaHeight: 0,
                        _grayAreaWidth: 0,
                        _headerX: 0,
                        _headerY: 0,
                        _headerCornerRect: function () {
                            var owner = this;
                            return new common_1.Rect(owner.x, owner.y, owner._rowHeaderWidth, owner._colHeaderHeight);
                        },
                        _colHeaderRect: function (colViewportIndex) {
                            var owner = this;
                            if (colViewportIndex === 0) {
                                return new common_1.Rect(owner._frozenX, owner.y, owner._frozenWidth, owner._colHeaderHeight);
                            } else if (colViewportIndex === 1) {
                                return new common_1.Rect(owner._viewportX, owner.y, self._getActualViewportWidth(owner), owner._colHeaderHeight);
                            } else if (colViewportIndex === 2) {
                                return new common_1.Rect(owner._frozenTrailingX, owner.y, owner._frozenTrailingWidth, owner._colHeaderHeight);
                            }
                            return keyword_null;
                        },
                        _rowHeaderRect: function (rowViewportIndex) {
                            var owner = this;
                            if (rowViewportIndex === 0) {
                                return new common_1.Rect(owner.x, owner._frozenY, owner._rowHeaderWidth, owner._frozenHeight);
                            } else if (rowViewportIndex === 1) {
                                return new common_1.Rect(owner.x, owner._viewportY, owner._rowHeaderWidth, self._getActualViewportHeight(owner));
                            } else if (rowViewportIndex === 2) {
                                return new common_1.Rect(owner.x, owner._frozenTrailingY, owner._rowHeaderWidth, owner._frozenTrailingHeight);
                            }
                            return keyword_null;
                        },
                        _viewportRect: function (rowViewportIndex, colViewportIndex) {
                            var owner = this;
                            if (rowViewportIndex === 0) {
                                if (colViewportIndex === 0) {
                                    return new common_1.Rect(owner._frozenX, owner._frozenY, owner._frozenWidth, owner._frozenHeight);
                                } else if (colViewportIndex === 1) {
                                    return new common_1.Rect(owner._viewportX, owner._frozenY, self._getActualViewportWidth(owner), owner._frozenHeight);
                                } else if (colViewportIndex === 2) {
                                    return new common_1.Rect(owner._frozenTrailingX, owner._frozenY, owner._frozenTrailingWidth, owner._frozenHeight);
                                }
                            } else if (rowViewportIndex === 1) {
                                if (colViewportIndex === 0) {
                                    return new common_1.Rect(owner._frozenX, owner._viewportY, owner._frozenWidth, self._getActualViewportHeight(owner));
                                } else if (colViewportIndex === 1) {
                                    return new common_1.Rect(owner._viewportX, owner._viewportY, self._getActualViewportWidth(owner), self._getActualViewportHeight(owner));
                                } else if (colViewportIndex === 2) {
                                    return new common_1.Rect(owner._frozenTrailingX, owner._viewportY, owner._frozenTrailingWidth, self._getActualViewportHeight(owner));
                                }
                            } else if (rowViewportIndex === 2) {
                                if (colViewportIndex === 0) {
                                    return new common_1.Rect(owner._frozenX, owner._frozenTrailingY, owner._frozenWidth, owner._frozenTrailingHeight);
                                } else if (colViewportIndex === 1) {
                                    return new common_1.Rect(owner._viewportX, owner._frozenTrailingY, self._getActualViewportWidth(owner), owner._frozenTrailingHeight);
                                } else if (colViewportIndex === 2) {
                                    return new common_1.Rect(owner._frozenTrailingX, owner._frozenTrailingY, owner._frozenTrailingWidth, owner._frozenTrailingHeight);
                                }
                            }
                            return keyword_null;
                        }
                    };
                    if (self._getOutlineLayout) {
                        var groupLayout = self._getOutlineLayout();
                        var outlineBorder = 0;
                        if (groupLayout.width > 0) {
                            layout.x += groupLayout.width + outlineBorder;
                            totalWidth -= groupLayout.width + outlineBorder;
                        }
                        if (groupLayout.height > 0) {
                            layout.y += groupLayout.height + outlineBorder;
                            totalHeight -= groupLayout.height + outlineBorder;
                        }
                    }
                    var r;
                    var rc;
                    var c;
                    var cc;
                    if (options.rowHeaderVisible) {
                        cc = self.getColumnCount(2);
                        for (c = 0; c < cc; c++) {
                            layout._rowHeaderWidth += self._getZoomColumnWidth(c, 2);
                        }
                    }
                    if (options.colHeaderVisible) {
                        rc = self.getRowCount(1);
                        for (r = 0; r < rc; r++) {
                            layout._colHeaderHeight += self._getZoomRowHeight(r, 1);
                        }
                    }
                    var frozenColCount = getFrozenColumnCount(self);
                    if (frozenColCount > 0) {
                        cc = getColumnCount(self);
                        for (c = 0; c < frozenColCount && c < cc; c++) {
                            if (self.getColumnVisible(c)) {
                                layout._frozenWidth += self._getZoomColumnWidth(c);
                            }
                        }
                    }
                    var frozenRowCount = getFrozenRowCount(self);
                    if (frozenRowCount > 0) {
                        rc = getRowCount(self);
                        for (r = 0; r < frozenRowCount && r < rc; r++) {
                            if (self.getRowVisible(r)) {
                                layout._frozenHeight += self._getZoomRowHeight(r);
                            }
                        }
                    }
                    var frozenTrailingColCount = getFrozenTrailingColumnCount(self);
                    if (frozenTrailingColCount > 0) {
                        cc = getColumnCount(self);
                        for (c = Math_max(frozenColCount, cc - frozenTrailingColCount); c < cc; c++) {
                            layout._frozenTrailingWidth += self._getZoomColumnWidth(c);
                        }
                    }
                    var frozenTrailingRowCount = getFrozenTrailingRowCount(self);
                    if (frozenTrailingRowCount > 0) {
                        rc = getRowCount(self);
                        for (r = Math_max(frozenRowCount, rc - frozenTrailingRowCount); r < rc; r++) {
                            layout._frozenTrailingHeight += self._getZoomRowHeight(r);
                        }
                    }
                    layout._headerX = layout.x;
                    layout._headerY = layout.y;
                    layout._frozenX = layout._headerX + layout._rowHeaderWidth;
                    layout._frozenY = layout._headerY + layout._colHeaderHeight;
                    layout._viewportX = layout._frozenX + layout._frozenWidth;
                    layout._viewportY = layout._frozenY + layout._frozenHeight;
                    totalWidth -= layout._rowHeaderWidth;
                    totalHeight -= layout._colHeaderHeight;
                    totalWidth -= layout._frozenWidth;
                    totalHeight -= layout._frozenHeight;
                    totalWidth -= layout._frozenTrailingWidth;
                    totalHeight -= layout._frozenTrailingHeight;
                    totalWidth -= layout._grayAreaWidth;
                    totalHeight -= layout._grayAreaHeight;
                    totalHeight -= layout._footerHeight;
                    rc = getRowCount(self);
                    cc = getColumnCount(self);
                    var actualViewportWidth = 0;
                    var viewportColCount = cc - frozenTrailingColCount;
                    if (viewportColCount > 0) {
                        actualViewportWidth += self._scrollLeftColOffset;
                        for (c = Math_max(frozenColCount, self._scrollLeftCol); c < viewportColCount && actualViewportWidth < totalWidth; c++) {
                            actualViewportWidth += self._getZoomColumnWidth(c);
                        }
                    }
                    var tempViewportWidth = Math_max(0, totalWidth);
                    if (actualViewportWidth < tempViewportWidth) {
                        layout._grayAreaWidth = tempViewportWidth - actualViewportWidth;
                        layout._viewportWidth = actualViewportWidth;
                        tempViewportWidth = actualViewportWidth;
                    } else {
                        layout._viewportWidth = tempViewportWidth;
                    }
                    var actualViewportHeight = 0;
                    var viewportRowCount = rc - frozenTrailingRowCount;
                    if (viewportRowCount > 0) {
                        actualViewportHeight += self._scrollTopRowOffset;
                        for (r = Math_max(frozenRowCount, self._scrollTopRow); r < viewportRowCount && actualViewportHeight < totalHeight; r++) {
                            actualViewportHeight += self._getZoomRowHeight(r);
                        }
                    }
                    var tempViewportHeight = Math_max(0, totalHeight);
                    if (actualViewportHeight < tempViewportHeight) {
                        layout._grayAreaHeight = tempViewportHeight - actualViewportHeight;
                        layout._viewportHeight = actualViewportHeight;
                        tempViewportHeight = actualViewportHeight;
                    } else {
                        layout._viewportHeight = tempViewportHeight;
                    }
                    layout._frozenTrailingX = layout._viewportX + tempViewportWidth;
                    layout._frozenTrailingY = layout._viewportY + tempViewportHeight;
                    if (!isFrozenTrailingColumnStickToEdge) {
                        layout._grayAreaX = layout._frozenTrailingX + layout._frozenTrailingWidth;
                    } else {
                        layout._grayAreaX = layout._viewportX + layout._viewportWidth;
                        layout._frozenTrailingX += layout._grayAreaWidth;
                    }
                    if (!isFrozenTrailingRowStickToEdge) {
                        layout._grayAreaY = layout._frozenTrailingY + layout._frozenTrailingHeight;
                    } else {
                        layout._grayAreaY = layout._viewportY + layout._viewportHeight;
                        layout._frozenTrailingY += layout._grayAreaHeight;
                    }
                    layout._footerX = layout._headerX;
                    layout._footerY = layout.y + layout.height - layout._footerHeight;
                    return layout;
                };
                Worksheet.prototype._getSheetLayout = function () {
                    var self = this;
                    if (!self._layoutModel) {
                        self._layoutModel = self._createLayout();
                    }
                    return self._layoutModel;
                };
                Worksheet.prototype._getColumnLayout = function (colViewportIndex, sheetArea) {
                    if (isNullOrUndefined(sheetArea) || sheetArea === 3 || sheetArea === 1) {
                        return this._getViewportColumnLayout(colViewportIndex);
                    } else if (sheetArea === 2) {
                        return this._getRowHeaderColumnLayout();
                    }
                    return keyword_null;
                };
                Worksheet.prototype._getRowHeaderColumnLayout = function () {
                    var self = this;
                    if (!self._colLayoutCache.rowHeader) {
                        self._colLayoutCache.rowHeader = self._createRowHeaderColumnLayout();
                    }
                    return self._colLayoutCache.rowHeader;
                };
                Worksheet.prototype._getViewportColumnLayout = function (colViewportIndex) {
                    var self = this;
                    if (!self._colLayoutCache.viewport) {
                        self._colLayoutCache.viewport = {};
                    }
                    if (!self._colLayoutCache.viewport[colViewportIndex]) {
                        self._colLayoutCache.viewport[colViewportIndex] = self._createViewportColumnLayout(colViewportIndex);
                    }
                    return self._colLayoutCache.viewport[colViewportIndex];
                };
                Worksheet.prototype._createRowHeaderColumnLayout = function () {
                    var colLayouts = new worksheet_model_1._LayoutModel();
                    var layout = this._getSheetLayout();
                    var colX = layout._headerX;
                    var colWidth;
                    var colCount = this.getColumnCount(2);
                    for (var col = 0; col < colCount; col++) {
                        colWidth = this._getZoomColumnWidth(col, 2);
                        colLayouts.push(new worksheet_model_1._Layout(-1, col, colX, -1, colWidth, -1));
                        colX += colWidth;
                    }
                    return colLayouts;
                };
                Worksheet.prototype._createViewportColumnLayout = function (colViewportIndex) {
                    var self = this;
                    var colLayouts = new worksheet_model_1._LayoutModel();
                    var layout = self._getSheetLayout();
                    var colCount = getColumnCount(self);
                    var col;
                    var colX;
                    var colWidth;
                    var cachePool = self._cachePool;
                    var frozenColCount = getFrozenColumnCount(self);
                    var frozenTrailingColCount = getFrozenTrailingColumnCount(self);
                    if (colViewportIndex === 0) {
                        colX = layout._frozenX;
                        colCount = Math_min(frozenColCount, colCount);
                        for (col = 0; col < colCount; col++) {
                            colWidth = cachePool._getZoomColWidth(col);
                            colLayouts.push(new worksheet_model_1._Layout(-1, col, colX, -1, colWidth, -1));
                            colX += colWidth;
                        }
                    } else if (colViewportIndex === 1) {
                        var isFrozenTrailingColumnStickToEdge = frozenTrailingColumnStickToEdge(self);
                        var offset = self._scrollLeftColOffset;
                        colX = layout._viewportX + offset;
                        colCount = isFrozenTrailingColumnStickToEdge ? colCount - frozenTrailingColCount : colCount + frozenTrailingColCount;
                        var viewportWidth = self._getActualViewportWidth(layout) - offset;
                        var leftCol = Math_max(frozenColCount, self._scrollLeftCol);
                        for (col = leftCol; (viewportWidth > 0 && col < colCount); col++) {
                            colWidth = cachePool._getZoomColWidth(col);
                            colLayouts.push(new worksheet_model_1._Layout(-1, col, colX, -1, colWidth, -1));
                            colX += colWidth;
                            viewportWidth -= colWidth;
                        }
                    } else if (colViewportIndex === 2) {
                        colX = layout._frozenTrailingX;
                        for (col = Math_max(frozenColCount, colCount - frozenTrailingColCount); col < colCount; col++) {
                            colWidth = cachePool._getZoomColWidth(col);
                            colLayouts.push(new worksheet_model_1._Layout(-1, col, colX, -1, colWidth, -1));
                            colX += colWidth;
                        }
                    }
                    return colLayouts;
                };
                Worksheet.prototype._getRowLayout = function (rowViewportIndex, sheetArea) {
                    if (isNullOrUndefined(sheetArea) || sheetArea === 3 || sheetArea === 2) {
                        return this._getViewportRowLayout(rowViewportIndex);
                    } else if (sheetArea === 1) {
                        return this._getColumnHeaderRowLayout();
                    }
                    return keyword_null;
                };
                Worksheet.prototype._getAllRowLayout = function (sheetArea) {
                    var rowLayout = new worksheet_model_1._LayoutModel();
                    for (var index = 0; index < 3; index++) {
                        var layout = this._getRowLayout(index, sheetArea);
                        if (layout && layout.length > 0) {
                            rowLayout = (domUtil_1.GC$.merge(rowLayout, layout));
                        }
                    }
                    return rowLayout;
                };
                Worksheet.prototype._getAllColumnLayout = function (sheetArea) {
                    var columnLayout = new worksheet_model_1._LayoutModel();
                    for (var index = 0; index < 3; index++) {
                        var layout = this._getColumnLayout(index, sheetArea);
                        if (layout && layout.length > 0) {
                            columnLayout = (domUtil_1.GC$.merge(columnLayout, layout));
                        }
                    }
                    return columnLayout;
                };
                Worksheet.prototype._getColumnHeaderRowLayout = function () {
                    var self = this;
                    if (!self._rowLayoutCache.colHeader) {
                        self._rowLayoutCache.colHeader = self._createColumnHeaderRowLayout();
                    }
                    return self._rowLayoutCache.colHeader;
                };
                Worksheet.prototype._getViewportRowLayout = function (viewportIndex) {
                    var self = this;
                    if (!self._rowLayoutCache.viewport) {
                        self._rowLayoutCache.viewport = {};
                    }
                    if (!self._rowLayoutCache.viewport[viewportIndex]) {
                        self._rowLayoutCache.viewport[viewportIndex] = self._createViewportRowLayout(viewportIndex);
                    }
                    return self._rowLayoutCache.viewport[viewportIndex];
                };
                Worksheet.prototype._createColumnHeaderRowLayout = function () {
                    var rowLayouts = new worksheet_model_1._LayoutModel();
                    var layout = this._getSheetLayout();
                    var rowY = layout._headerY;
                    var rowHeight;
                    var rowCount = this.getRowCount(1);
                    for (var row = 0; row < rowCount; row++) {
                        rowHeight = this._getZoomRowHeight(row, 1);
                        rowLayouts.push(new worksheet_model_1._Layout(row, -1, -1, rowY, -1, rowHeight));
                        rowY += rowHeight;
                    }
                    return rowLayouts;
                };
                Worksheet.prototype._createViewportRowLayout = function (rowViewportIndex) {
                    var self = this;
                    var rowLayouts = new worksheet_model_1._LayoutModel();
                    var frozenRowCount = getFrozenRowCount(self);
                    var frozenTrailingRowCount = getFrozenTrailingRowCount(self);
                    var layout = self._getSheetLayout();
                    var rowCount = getRowCount(self);
                    var row;
                    var rowY;
                    var rowHeight;
                    var cachePool = self._cachePool;
                    if (rowViewportIndex === 0) {
                        rowY = layout._frozenY;
                        rowCount = Math_min(frozenRowCount, rowCount);
                        for (row = 0; row < rowCount; row++) {
                            rowHeight = cachePool._getZoomRowHeight(row);
                            rowLayouts.push(new worksheet_model_1._Layout(row, -1, -1, rowY, -1, rowHeight));
                            rowY += rowHeight;
                        }
                    } else if (rowViewportIndex === 1) {
                        var isFrozenTrailingRowStickToEdge = frozenTrailingRowStickToEdge(self);
                        var offset = self._scrollTopRowOffset;
                        rowY = layout._viewportY + offset;
                        rowCount = isFrozenTrailingRowStickToEdge ? rowCount - frozenTrailingRowCount : rowCount + frozenTrailingRowCount;
                        var viewportHeight = self._getActualViewportHeight(layout) - offset;
                        var topRow = Math_max(frozenRowCount, self._scrollTopRow);
                        for (row = topRow; (viewportHeight > 0 && row < rowCount); row++) {
                            rowHeight = cachePool._getZoomRowHeight(row);
                            rowLayouts.push(new worksheet_model_1._Layout(row, -1, -1, rowY, -1, rowHeight));
                            rowY += rowHeight;
                            viewportHeight -= rowHeight;
                        }
                    } else if (rowViewportIndex === 2) {
                        rowY = layout._frozenTrailingY;
                        for (row = Math_max(frozenRowCount, rowCount - frozenTrailingRowCount); row < rowCount; row++) {
                            rowHeight = cachePool._getZoomRowHeight(row);
                            rowLayouts.push(new worksheet_model_1._Layout(row, -1, -1, rowY, -1, rowHeight));
                            rowY += rowHeight;
                        }
                    }
                    return rowLayouts;
                };
                Worksheet.prototype._getCellLayout = function (rowViewportIndex, colViewportIndex, sheetArea, needAutoMerge) {
                    var self = this;
                    var rowCount = self.getRowCount(sheetArea);
                    var colCount = self.getColumnCount(sheetArea);
                    var rowLayoutModel = self._getRowLayout(rowViewportIndex, sheetArea);
                    var colLayoutModel = self._getColumnLayout(colViewportIndex, sheetArea);
                    var cellLayoutModel = new worksheet_model_1._LayoutModel();
                    if (rowLayoutModel && rowLayoutModel.length > 0 && colLayoutModel && colLayoutModel.length > 0) {
                        var topRow = rowLayoutModel[0].row;
                        var leftCol = colLayoutModel[0].col;
                        var bottomRow = rowLayoutModel[rowLayoutModel.length - 1].row;
                        var rightCol = colLayoutModel[colLayoutModel.length - 1].col;
                        var spans = self._modelManager.getSpans(common_1._createRange(topRow, leftCol, bottomRow - topRow + 1, rightCol - leftCol + 1), sheetArea);
                        if (needAutoMerge && self._autoMergeManager) {
                            var autoMergeSpans = self._autoMergeManager._getSpans(sheetArea);
                            spans = spans.concat(autoMergeSpans);
                        }
                        if (spans.length > 0) {
                            self._addCellLayout(spans, topRow, leftCol, bottomRow, rightCol, cellLayoutModel, rowCount, colCount, sheetArea, rowLayoutModel, colLayoutModel);
                        }
                    }
                    return cellLayoutModel;
                };
                Worksheet.prototype._getCellLayoutByCell = function (rowViewportIndex, colViewportIndex, sheetArea, row, col) {
                    var self = this;
                    var rowCount = self.getRowCount(sheetArea);
                    var colCount = self.getColumnCount(sheetArea);
                    var rowLayoutModel = self._getRowLayout(rowViewportIndex, sheetArea);
                    var colLayoutModel = self._getColumnLayout(colViewportIndex, sheetArea);
                    var cellLayoutModel = new worksheet_model_1._LayoutModel();
                    if (rowLayoutModel && rowLayoutModel.length > 0 && colLayoutModel && colLayoutModel.length > 0) {
                        var topRow = rowLayoutModel[0].row;
                        var leftCol = colLayoutModel[0].col;
                        var spanCell = self.getSpan(row, col, sheetArea);
                        if (spanCell) {
                            var spans = [];
                            spans.push(spanCell);
                            self._addCellLayout(spans, topRow, leftCol, spanCell.row + spanCell.rowCount, spanCell.col + spanCell.colCount, cellLayoutModel, rowCount, colCount, sheetArea, rowLayoutModel, colLayoutModel);
                        }
                        if (cellLayoutModel.length > 0) {
                            return cellLayoutModel[0];
                        }
                        return keyword_null;
                    }
                    return keyword_null;
                };
                Worksheet.prototype._addCellLayout = function (spans, topRow, leftCol, bottomRow, rightCol, cellLayoutModel, rowCount, colCount, sheetArea, rowLayoutModel, colLayoutModel) {
                    var spanCount = spans.length;
                    if (spanCount <= 0) {
                        return;
                    }
                    var self = this;
                    var i;
                    var lastRow = bottomRow + 1;
                    var lastCol = rightCol + 1;
                    var heights = [];
                    var widths = [];
                    var xs = [];
                    var ys = [];
                    var x = 0;
                    var y = 0;
                    for (i = topRow - 1; i >= 0; i--) {
                        heights[i] = self._getZoomRowHeight(i, sheetArea);
                        y -= heights[i];
                        ys[i] = y;
                    }
                    y = 0;
                    for (i = topRow; i < lastRow; i++) {
                        ys[i] = y;
                        heights[i] = self._getZoomRowHeight(i, sheetArea);
                        y += heights[i];
                    }
                    for (i = leftCol - 1; i >= 0; i--) {
                        widths[i] = self._getZoomColumnWidth(i, sheetArea);
                        x -= widths[i];
                        xs[i] = x;
                    }
                    x = 0;
                    for (i = leftCol; i < lastCol; i++) {
                        xs[i] = x;
                        widths[i] = self._getZoomColumnWidth(i, sheetArea);
                        x += widths[i];
                    }
                    for (var k = 0; k < spanCount; k++) {
                        var cellSpan = spans[k];
                        if (cellSpan.intersect(topRow, leftCol, bottomRow - topRow + 1, rightCol - leftCol + 1)) {
                            var lastRow1 = cellSpan.row + cellSpan.rowCount;
                            if (lastRow1 > lastRow) {
                                for (i = lastRow; i < lastRow1; i++) {
                                    heights.push(self._getZoomRowHeight(i, sheetArea));
                                    ys.push(ys[i - 1] + heights[i]);
                                }
                                lastRow = lastRow1;
                            }
                            var lastCol1 = cellSpan.col + cellSpan.colCount;
                            if (lastCol1 > lastCol) {
                                for (i = lastCol; i < lastCol1; i++) {
                                    widths.push(self._getZoomColumnWidth(i, sheetArea));
                                    xs.push(xs[i - 1] + widths[i]);
                                }
                                lastCol = lastCol1;
                            }
                            var spanX = xs[cellSpan.col];
                            var spanY = ys[cellSpan.row];
                            var width = 0;
                            var height = 0;
                            var row = void 0;
                            var col = void 0;
                            for (col = cellSpan.col; col < cellSpan.col + cellSpan.colCount && col < colCount; col++) {
                                width += widths[col];
                            }
                            for (row = cellSpan.row; row < cellSpan.row + cellSpan.rowCount && row < rowCount; row++) {
                                height += heights[row];
                            }
                            cellLayoutModel.push(new worksheet_model_1._Layout(cellSpan.row, cellSpan.col, colLayoutModel[0].x + spanX, rowLayoutModel[0].y + spanY, width, height, cellSpan.rowCount, cellSpan.colCount, cellSpan.isAutoMerge));
                        }
                    }
                };
                Worksheet.prototype._syncHScrollbarPosition = function () {
                    var self = this;
                    var workbook = self.parent;
                    var newLefCol = self._getScrollableColumn(self._scrollLeftCol);
                    var newLeftColOffset = self._scrollLeftColOffset;
                    if (newLefCol !== -1 && newLefCol !== self._scrollLeftCol) {
                        self._scrollLeftCol = newLefCol;
                    }
                    var scrollbarH = workbook && workbook._hScrollbar;
                    if (scrollbarH) {
                        var isPixelScroll = scrollbarH._scrollType === core_enum_1.ScrollType.pixels;
                        var newValue = isPixelScroll ? self._getVisibleColumnPosition(newLefCol) - newLeftColOffset : self._getVisibleColIndex(newLefCol);
                        scrollbarH.value(newValue);
                    }
                };
                Worksheet.prototype._syncVScrollbarPosition = function () {
                    var self = this;
                    var workbook = self.parent;
                    var newTopRow = self._getScrollableRow(self._scrollTopRow);
                    var newTopRowOffset = self._scrollTopRowOffset;
                    if (newTopRow !== -1 && newTopRow !== self._scrollTopRow) {
                        self._scrollTopRow = newTopRow;
                    }
                    var scrollbarV = workbook && workbook._vScrollbar;
                    if (scrollbarV) {
                        var isPixelScroll = scrollbarV._scrollType === core_enum_1.ScrollType.pixels;
                        var newValue = isPixelScroll ? self._getVisibleRowPosition(newTopRow) - newTopRowOffset : self._getVisibleRowIndex(newTopRow);
                        scrollbarV.value(newValue);
                    }
                };
                Worksheet.prototype._syncHScrollbarSize = function () {
                    var self = this;
                    var sp = self.parent;
                    if (sp && sp._hScrollbar) {
                        var isPixelScroll = sp.options.scrollByPixel;
                        sp._hScrollbar._scrollType = isPixelScroll ? core_enum_1.ScrollType.pixels : core_enum_1.ScrollType.continuous;
                    }
                    if (sp && sp._resizeHScrollBar) {
                        if (sp.options.scrollbarAppearance === core_enum_1.ScrollbarAppearance.mobile) {
                            sp._refreshMobileScrollbar();
                        }
                        if (sp.options.scrollIgnoreHidden) {
                            self._columnIndexInfo = self._getColumnIndexInfo(true);
                        }
                        sp._resizeHScrollBar();
                    }
                };
                Worksheet.prototype._syncVScrollbarSize = function () {
                    var self = this;
                    var sp = self.parent;
                    if (sp && sp._vScrollbar) {
                        var isPixelScroll = sp.options.scrollByPixel;
                        sp._vScrollbar._scrollType = isPixelScroll ? core_enum_1.ScrollType.pixels : core_enum_1.ScrollType.continuous;
                    }
                    if (sp && sp._resizeVScrollBar) {
                        if (sp.options.scrollbarAppearance === core_enum_1.ScrollbarAppearance.mobile) {
                            sp._refreshMobileScrollbar();
                        }
                        if (sp.options.scrollIgnoreHidden) {
                            self._rowIndexInfo = self._getRowIndexInfo(true);
                        }
                        sp._resizeVScrollBar();
                    }
                };
                Worksheet.prototype._getFirstPageLeftColumn = function () {
                    var self = this;
                    var firstLeftCol = 0;
                    var frozenColCount = getFrozenColumnCount(self);
                    if (frozenColCount > 0) {
                        firstLeftCol = self._getNextVisualColumn(frozenColCount - 1);
                    } else {
                        firstLeftCol = self._getFirstVisualColumn();
                    }
                    return firstLeftCol;
                };
                Worksheet.prototype._getFirstPageTopRow = function () {
                    var self = this;
                    var firsTopRow = 0;
                    var frozenRowCount = getFrozenRowCount(self);
                    if (frozenRowCount > 0) {
                        firsTopRow = self._getNextVisualRow(frozenRowCount - 1);
                    } else {
                        firsTopRow = self._getFirstVisualRow();
                    }
                    return firsTopRow;
                };
                Worksheet.prototype._getFirstVisualColumn = function (sheetArea) {
                    return this._getNextVisualColumn(-1, sheetArea);
                };
                Worksheet.prototype._getNextVisualColumn = function (col, sheetArea, ignoreFrozenTrailingCol) {
                    var self = this;
                    var colCount = self.getColumnCount(sheetArea);
                    var endCol = ignoreFrozenTrailingCol ? colCount - 1 : colCount - 1 - getFrozenTrailingColumnCount(self);
                    while (col < endCol) {
                        col++;
                        if (self.getColumnVisible(col, sheetArea) && self._getZoomColumnWidth(col, sheetArea) > 0) {
                            return col;
                        }
                    }
                    return keyword_null;
                };
                Worksheet.prototype._getPrevVisualColumn = function (col, sheetArea, ignoreFrozenCol) {
                    var self = this;
                    var minCol = ignoreFrozenCol ? 0 : getFrozenColumnCount(self);
                    while (col > minCol) {
                        col--;
                        if (self.getColumnVisible(col, sheetArea) && self._getZoomColumnWidth(col, sheetArea) > 0) {
                            return col;
                        }
                    }
                    return keyword_null;
                };
                Worksheet.prototype._getFirstVisualRow = function (sheetArea) {
                    return this._getNextVisualRow(-1, sheetArea);
                };
                Worksheet.prototype._getNextVisualRow = function (row, sheetArea, ignoreFrozenTrailingRow) {
                    var self = this;
                    var rowCount = self.getRowCount(sheetArea);
                    var endRow = ignoreFrozenTrailingRow ? rowCount - 1 : rowCount - 1 - getFrozenTrailingRowCount(self);
                    while (row < endRow) {
                        row++;
                        if (self.getRowVisible(row, sheetArea) && self._getZoomRowHeight(row, sheetArea) > 0) {
                            return row;
                        }
                    }
                    return keyword_null;
                };
                Worksheet.prototype._getPrevVisualRow = function (row, sheetArea, ignoreFrozenRow) {
                    var self = this;
                    var minRow = ignoreFrozenRow ? 0 : getFrozenRowCount(self);
                    while (row > minRow) {
                        row--;
                        if (self.getRowVisible(row, sheetArea) && self._getZoomRowHeight(row, sheetArea) > 0) {
                            return row;
                        }
                    }
                    return keyword_null;
                };
                Worksheet.prototype._invalidateVScrollbar = function () {
                    this._needSyncVScrollbarSize = true;
                    this._syncVScrollbarPosition();
                };
                Worksheet.prototype._invalidateHScrollbar = function () {
                    this._needSyncHScrollbarSize = true;
                    this._syncHScrollbarPosition();
                };
                Worksheet.prototype._getVisibleRowPosition = function (rowIndex) {
                    var self = this;
                    var frozenRowCount = getFrozenRowCount(self);
                    var rowCount = getRowCount(self) - getFrozenTrailingRowCount(self) - frozenRowCount;
                    var startRow = frozenRowCount;
                    var lastRow = startRow + rowCount - 1;
                    var totalHeight = 0;
                    if (rowIndex <= startRow) {
                        return totalHeight;
                    }
                    if (rowIndex > lastRow) {
                        rowIndex = lastRow;
                    }
                    for (var row = startRow; row < rowIndex; row++) {
                        var rowHeight = self._getZoomRowHeight(row);
                        totalHeight += rowHeight;
                    }
                    return totalHeight;
                };
                Worksheet.prototype._getVisibleColumnPosition = function (columnIndex) {
                    var self = this;
                    var frozenColumnCount = getFrozenColumnCount(self);
                    var columnCount = getColumnCount(self) - getFrozenTrailingColumnCount(self) - frozenColumnCount;
                    var startColumn = frozenColumnCount;
                    var lastColumn = startColumn + columnCount - 1;
                    var totalWidth = 0;
                    if (columnIndex <= startColumn) {
                        return totalWidth;
                    }
                    if (columnIndex > lastColumn) {
                        columnIndex = lastColumn;
                    }
                    for (var column = startColumn; column < columnIndex; column++) {
                        var columnWidth = self._getZoomColumnWidth(column);
                        totalWidth += columnWidth;
                    }
                    return totalWidth;
                };
                Worksheet.prototype._getVisibleRowIndex = function (originalIndex) {
                    var sp = this.parent;
                    if (sp && sp.options.scrollIgnoreHidden) {
                        var visibleRowIndexInfo = this._getRowIndexInfo().visibleIndex;
                        return visibleRowIndexInfo[originalIndex];
                    }
                    return originalIndex;
                };
                Worksheet.prototype._getOriginalRowIndex = function (visibleIndex) {
                    var sp = this.parent;
                    if (sp && sp.options.scrollIgnoreHidden) {
                        var originalRowIndexInfo = this._getRowIndexInfo().originalIndex;
                        return originalRowIndexInfo[visibleIndex];
                    }
                    return visibleIndex;
                };
                Worksheet.prototype._getVisibleColIndex = function (originalIndex) {
                    var sp = this.parent;
                    if (sp && sp.options.scrollIgnoreHidden) {
                        var visibleColIndexInfo = this._getColumnIndexInfo().visibleIndex;
                        return visibleColIndexInfo[originalIndex];
                    }
                    return originalIndex;
                };
                Worksheet.prototype._getOriginalColIndex = function (visibleIndex) {
                    var sp = this.parent;
                    if (sp && sp.options.scrollIgnoreHidden) {
                        var originalColIndexInfo = this._getColumnIndexInfo().originalIndex;
                        return originalColIndexInfo[visibleIndex];
                    }
                    return visibleIndex;
                };


                Worksheet.prototype._getColumnIndexInfo = function (isUpdate) {
                    var self = this;
                    if (self._columnIndexInfo && !isUpdate) {
                        return self._columnIndexInfo;
                    }
                    var frozenColCount = getFrozenColumnCount(self);
                    var columnCount = getColumnCount(self) - getFrozenTrailingColumnCount(self) - frozenColCount;
                    var startColumn = frozenColCount;
                    var lastColumn = startColumn + columnCount - 1;
                    var cachePool = self._cachePool;
                    var columnIndexInfo = {
                        visibleIndex: {},
                        originalIndex: {}
                    };
                    if (lastColumn - startColumn + 1 <= 0) {
                        return columnIndexInfo;
                    }
                    var index = 0;
                    var col;
                    for (col = startColumn; col <= lastColumn; col++) {
                        columnIndexInfo.originalIndex[index] = col;
                        columnIndexInfo.visibleIndex[col] = index;
                        if (cachePool._getZoomColWidth(col) > 0) {
                            index++;
                        }
                    }
                    col--;
                    index--;
                    while (cachePool._getZoomColWidth(col) <= 0 && col >= startColumn) {
                        columnIndexInfo.originalIndex[index] = col;
                        columnIndexInfo.visibleIndex[col] = index;
                        col--;
                    }
                    return columnIndexInfo;
                };
                Worksheet.prototype._getRowIndexInfo = function (isUpdate) {
                    var self = this;
                    if (self._rowIndexInfo && !isUpdate) {
                        return self._rowIndexInfo;
                    }
                    var frozenRowCount = getFrozenRowCount(self);
                    var rowCount = getRowCount(self) - getFrozenTrailingRowCount(self) - frozenRowCount;
                    var startRow = frozenRowCount;
                    var lastRow = startRow + rowCount - 1;
                    var cachePool = self._cachePool;
                    var rowIndexInfo = {
                        visibleIndex: {},
                        originalIndex: {}
                    };
                    if (lastRow - startRow + 1 <= 0) {
                        return rowIndexInfo;
                    }
                    var index = 0;
                    var row;
                    for (row = startRow; row <= lastRow; row++) {
                        rowIndexInfo.originalIndex[index] = row;
                        rowIndexInfo.visibleIndex[row] = index;
                        if (cachePool._getZoomRowHeight(row) > 0) {
                            index++;
                        }
                    }
                    row--;
                    index--;
                    while (cachePool._getZoomRowHeight(row) <= 0 && row >= startRow) {
                        rowIndexInfo.originalIndex[index] = row;
                        rowIndexInfo.visibleIndex[row] = index;
                        row--;
                    }
                    return rowIndexInfo;
                };
                Worksheet.prototype._getScrollableRow = function (startRow, previous) {
                    var self = this, newTopRow;
                    var min = getFrozenRowCount(self);
                    var max = getRowCount(self) - getFrozenTrailingRowCount(self) - 1;
                    if (previous) {
                        if (startRow > max) {
                            startRow = max;
                        }
                        newTopRow = self._getPrevVisualRow(startRow + 1);
                        if (newTopRow !== keyword_null && newTopRow >= min) {
                            return newTopRow;
                        }
                    } else {
                        if (startRow < min) {
                            startRow = min;
                        }
                        newTopRow = self._getNextVisualRow(startRow - 1);
                        if (newTopRow !== keyword_null && newTopRow <= max) {
                            return newTopRow;
                        }
                    }
                    return -1;
                };
                Worksheet.prototype._getScrollableColumn = function (startCol, previous) {
                    var self = this, newLeftCol;
                    var min = getFrozenColumnCount(self);
                    var max = getColumnCount(self) - getFrozenTrailingColumnCount(self) - 1;
                    if (previous) {
                        if (startCol > max) {
                            startCol = max;
                        }
                        newLeftCol = self._getPrevVisualColumn(startCol + 1);
                        if (newLeftCol !== keyword_null && newLeftCol >= min) {
                            return newLeftCol;
                        }
                    } else {
                        if (startCol < min) {
                            startCol = min;
                        }
                        newLeftCol = self._getNextVisualColumn(startCol - 1);
                        if (newLeftCol !== keyword_null && newLeftCol <= max) {
                            return newLeftCol;
                        }
                    }
                    return -1;
                };
                Worksheet.prototype._getTopRowWhenLastRowShowComplete = function (viewportHeight, startRow, endRow) {
                    if (endRow < startRow) {
                        return endRow;
                    }
                    var totalHeight = 0;
                    var cachePool = this._cachePool;
                    var topRow = endRow;
                    for (var row = endRow; row >= startRow; row--) {
                        var rowHeight = cachePool._getZoomRowHeight(row);
                        if (rowHeight <= 0) {
                            continue;
                        }
                        totalHeight += rowHeight;
                        if (totalHeight > viewportHeight) {
                            break;
                        }
                        topRow = row;
                    }
                    return topRow;
                };
                Worksheet.prototype._getTopRowWhenLastRowShowCompleteForPixelScroll = function (viewportHeight, startRow, endRow) {
                    var totalHeight = 0;
                    var topRow = endRow;
                    var offset = 0;
                    for (var row = endRow; row >= startRow; row--) {
                        var rowHeight = this._getZoomRowHeight(row);
                        if (rowHeight <= 0) {
                            continue;
                        }
                        totalHeight += rowHeight;
                        topRow = row;
                        if (totalHeight >= viewportHeight) {
                            offset = viewportHeight - totalHeight;
                            break;
                        }
                    }
                    return { _row: topRow, _offset: offset };
                };
                Worksheet.prototype._getLeftColWhenLastColShowComplete = function (viewportWidth, startColumn, endColumn) {
                    if (endColumn < startColumn) {
                        return endColumn;
                    }
                    var totalWidth = 0;
                    var cachePool = this._cachePool;
                    var leftColumn = endColumn;
                    for (var col = endColumn; col >= startColumn; col--) {
                        var columnWidth = cachePool._getZoomColWidth(col);
                        if (columnWidth <= 0) {
                            continue;
                        }
                        totalWidth += columnWidth;
                        if (totalWidth > viewportWidth) {
                            break;
                        }
                        leftColumn = col;
                    }
                    return leftColumn;
                };
                Worksheet.prototype._getLeftColWhenLastColShowCompleteForPixelScroll = function (viewportWidth, startColumn, endColumn) {
                    var totalWidth = 0;
                    var leftColumn = endColumn;
                    var offset = 0;
                    for (var col = endColumn; col >= startColumn; col--) {
                        var columnWidth = this._getZoomColumnWidth(col);
                        if (columnWidth <= 0) {
                            continue;
                        }
                        leftColumn = col;
                        totalWidth += columnWidth;
                        if (totalWidth >= viewportWidth) {
                            offset = viewportWidth - totalWidth;
                            break;
                        }
                    }
                    return { _col: leftColumn, _offset: offset };
                };
                Worksheet.prototype._getPageValueH = function () {
                    var self = this;
                    var layout = self._getSheetLayout();
                    var viewportColLayout = self._getColumnLayout(1, 3);
                    var totalWidth = 0;
                    var count = 0;
                    if (viewportColLayout) {
                        for (var i = 0; i < viewportColLayout.length; i++) {
                            var columnWidth = viewportColLayout[i].width;
                            totalWidth += columnWidth;
                            if (columnWidth > 0) {
                                count++;
                            }
                        }
                    }
                    count = count === 0 ? 1 : count;
                    var average = totalWidth / count;
                    if (average === 0) {
                        return 1;
                    }
                    return Math_floor(self._getActualViewportWidth(layout) / average);
                };
                Worksheet.prototype._getPageValueV = function () {
                    var self = this;
                    var layout = self._getSheetLayout();
                    var viewportRowLayout = self._getRowLayout(1, 3);
                    var totalHeight = 0;
                    var count = 0;
                    if (viewportRowLayout) {
                        for (var i = 0; i < viewportRowLayout.length; i++) {
                            var rowHeight = viewportRowLayout[i].height;
                            totalHeight += rowHeight;
                            if (rowHeight > 0) {
                                count++;
                            }
                        }
                    }
                    count = count === 0 ? 1 : count;
                    var average = totalHeight / count;
                    if (average === 0) {
                        return 1;
                    }
                    return Math_floor(self._getActualViewportHeight(layout) / average);
                };
                Worksheet.prototype._getLastVisualScrollRow = function (sheetArea) {
                    if (isNullOrUndefined(sheetArea)) {
                        sheetArea = 3;
                    }
                    var self = this;
                    var sp = self.parent;
                    var startRow = getFrozenRowCount(self);
                    var frozenTrailingRowCount = getFrozenTrailingRowCount(self);
                    if (sp && sp.options.scrollbarMaxAlign) {
                        var layout = self._getSheetLayout();
                        return self._getTopRowWhenLastRowShowComplete(self._getActualViewportHeight(layout), startRow, getRowCount(self) - frozenTrailingRowCount - 1);
                    }
                    var rowCount = self.getRowCount(sheetArea);
                    if (sheetArea === 3 || sheetArea === 2) {
                        rowCount = rowCount - frozenTrailingRowCount;
                    }
                    var lastScrollRow = self._getPrevVisualRow(rowCount, sheetArea);
                    if (lastScrollRow === keyword_null) {
                        lastScrollRow = startRow;
                    }
                    return lastScrollRow;
                };
                Worksheet.prototype._getLastVisualScrollColumn = function (sheetArea) {
                    if (isNullOrUndefined(sheetArea)) {
                        sheetArea = 3;
                    }
                    var self = this;
                    var sp = self.parent;
                    var startColumn = getFrozenColumnCount(self);
                    if (sp && sp.options.scrollbarMaxAlign) {
                        var layout = self._getSheetLayout();
                        return self._getLeftColWhenLastColShowComplete(self._getActualViewportWidth(layout), startColumn, getColumnCount(self) - getFrozenTrailingColumnCount(self) - 1);
                    }
                    var colCount = self.getColumnCount(sheetArea);
                    if (sheetArea === 3 || sheetArea === 1) {
                        colCount = colCount - getFrozenTrailingColumnCount(self);
                    }
                    var lastScrollColumn = self._getPrevVisualColumn(colCount, sheetArea);
                    if (lastScrollColumn === keyword_null) {
                        lastScrollColumn = startColumn;
                    }
                    return lastScrollColumn;
                };
                Worksheet.prototype._getLastNonNullRowAndCol = function () {
                    var self = this;
                    var lastNonNullRow = getFrozenRowCount(self);
                    var lastNonNullCol = getFrozenColumnCount(self);
                    var maxRowIndex = getRowCount(self) - getFrozenTrailingRowCount(self) - 1;
                    var maxColIndex = getColumnCount(self) - getFrozenTrailingColumnCount(self) - 1;
                    var modelManager = self._modelManager;
                    var viewportLastNonNullRow = modelManager.getLastNonNullRow(3);
                    if (viewportLastNonNullRow > lastNonNullRow) {
                        lastNonNullRow = viewportLastNonNullRow;
                    }
                    var viewportLastNonNullColumn = modelManager.getLastNonNullCol(3);
                    if (viewportLastNonNullColumn > lastNonNullCol) {
                        lastNonNullCol = viewportLastNonNullColumn;
                    }
                    var rowHeaderLastNonNullRow = modelManager.getLastNonNullRow(2);
                    if (rowHeaderLastNonNullRow > lastNonNullRow) {
                        lastNonNullRow = rowHeaderLastNonNullRow;
                    }
                    var colHeaderLastNonNullColumn = modelManager.getLastNonNullCol(1);
                    if (colHeaderLastNonNullColumn > lastNonNullCol) {
                        lastNonNullCol = colHeaderLastNonNullColumn;
                    }
                    var features = Worksheet._features;
                    if (features) {
                        $_each(features, function (n, f) {
                            var t = f.lastNonNullRowAndCol;
                            if (t) {
                                var r = t.call(self);
                                lastNonNullRow = Math_max(lastNonNullRow, r.lastNonNullRow);
                                lastNonNullCol = Math_max(lastNonNullCol, r.lastNonNullCol);
                            }
                        });
                    }
                    if (lastNonNullRow > maxRowIndex) {
                        lastNonNullRow = maxRowIndex;
                    }
                    if (lastNonNullCol > maxColIndex) {
                        lastNonNullCol = maxColIndex;
                    }
                    return {
                        lastNonNullRow: lastNonNullRow,
                        lastNonNullCol: lastNonNullCol
                    };
                };
                Worksheet.prototype.getLastNonNullRow = function () {
                    return this._getLastNonNullRowAndCol().lastNonNullRow;
                };
                Worksheet.prototype.getLastNonNullColumn = function () {
                    return this._getLastNonNullRowAndCol().lastNonNullCol;
                };
                Worksheet.prototype._setTopRow = function (row, newTopRowOffset, oldTopRowInTouch) {
                    var self = this;
                    var oldTopRow = self._scrollTopRow;
                    var oldTopRowOffset = self._scrollTopRowOffset;
                    var lastRow = self._getLastVisualScrollRow();
                    var touchIgnoreJudge = !isNullOrUndefined(oldTopRowInTouch);
                    if (oldTopRow >= self.getRowCount() && row > lastRow) {
                        row = lastRow;
                    }
                    if (row >= self._getFirstPageTopRow() && row <= lastRow && (touchIgnoreJudge || row !== oldTopRow || newTopRowOffset !== oldTopRowOffset)) {
                        var sp = self.parent;
                        if (sp) {
                            sp._scrollService && sp._scrollService._vScrollTo(self, row, newTopRowOffset || 0, oldTopRowInTouch);
                            self._syncVScrollbarPosition();
                        }
                        if (sp && !sp.options.scrollbarShowMax) {
                            self._syncVScrollbarSize();
                        }
                    }
                };
                Worksheet.prototype._setLeftColumn = function (col, newLeftColOffset, oldLeftColInTouch) {
                    var self = this;
                    var oldLeftCol = self._scrollLeftCol;
                    var oldLeftColOffset = self._scrollLeftColOffset;
                    var lastCol = self._getLastVisualScrollColumn();
                    var touchIgnoreJudge = !isNullOrUndefined(oldLeftColInTouch);
                    if (oldLeftCol >= self.getColumnCount() && col > lastCol) {
                        col = lastCol;
                    }
                    if (col >= self._getFirstPageLeftColumn() && col <= lastCol && (touchIgnoreJudge || col !== oldLeftCol || newLeftColOffset !== oldLeftColOffset)) {
                        var sp = self.parent;
                        if (sp) {
                            sp._scrollService && sp._scrollService._hScrollTo(self, col, newLeftColOffset || 0, oldLeftColInTouch);
                            self._syncHScrollbarPosition();
                        }
                        if (sp && !sp.options.scrollbarShowMax) {
                            self._syncHScrollbarSize();
                        }
                    }
                };
                Worksheet.prototype._getCellTypeHitInfo = function (target, x, y) {
                    var self = this;
                    var r = target.row;
                    var c = target.col;
                    var sheetArea = target.hitTestType;
                    if (isNullOrUndefined(r) || isNullOrUndefined(c)) {
                        return keyword_null;
                    }
                    var span = self.getSpan(r, c, sheetArea);
                    if (span) {
                        r = span.row;
                        c = span.col;
                    }
                    if (self._autoMergeManager) {
                        var autoMergeSpan = self._autoMergeManager._getSpan(r, c, sheetArea);
                        if (autoMergeSpan) {
                            r = autoMergeSpan.row;
                            c = autoMergeSpan.col;
                        }
                    }
                    var cellStyle = self._getActualStyleImp(r, c, sheetArea);
                    var rowViewportIndex = sheetArea === 1 ? -1 : keyword_undefined;
                    var colViewportIndex = sheetArea === 2 ? -1 : keyword_undefined;
                    var cellRect = self.getCellRect(r, c, rowViewportIndex, colViewportIndex, true);
                    var context = {
                        sheet: self,
                        row: r,
                        col: c,
                        sheetArea: sheetArea
                    };
                    var ct = (cellStyle.cellType || self._getDefaultCellType(sheetArea));
                    return ct._getHitInfoWrapper(x, y, cellStyle, cellRect, context);
                };
                Worksheet.prototype._disposeUserEvents = function () {
                    this.unbindAll();
                    this._unbindAll();
                };
                Worksheet.prototype._isAnyCellInRangeLocked = function (range, isIgnoreFilterOutRow) {
                    var ar = this._getActualRange(range);
                    var row = ar.row;
                    var col = ar.col;
                    var endRow = row + ar.rowCount;
                    var endCol = col + ar.colCount;
                    var style;
                    for (var r = row; r < endRow; r++) {
                        for (var c = col; c < endCol; c++) {
                            var span = this.getSpan(r, c);
                            var actualRow = span ? span.row : r;
                            var actualCol = span ? span.col : c;
                            style = this.getActualStyle(actualRow, actualCol);
                            var shouldSkip = isIgnoreFilterOutRow && this._isRowFilterOut(r);
                            if (style.locked === true && !shouldSkip) {
                                return true;
                            }
                        }
                    }
                    return false;
                };
                Worksheet.prototype._isValidRange = function (row, column, rowCount, columnCount, maxRowCount, maxColumnCount) {
                    if (-1 <= row && row < maxRowCount && -1 <= column && column < maxColumnCount) {
                        if (row === -1 && column === -1) {
                            return true;
                        } else if (row === -1) {
                            if (columnCount !== 0 && column + columnCount <= maxColumnCount) {
                                return true;
                            }
                        } else if (column === -1) {
                            if (rowCount !== 0 && row + rowCount <= maxRowCount) {
                                return true;
                            }
                        } else if (columnCount !== 0 && column + columnCount <= maxColumnCount && rowCount !== 0 && row + rowCount <= maxRowCount) {
                            return true;
                        }
                    }
                    return false;
                };
                Worksheet.prototype._hasPartSpans = function (row, column, rowCount, columnCount) {
                    var self = this;
                    if (row < 0 && column < 0) {
                        return false;
                    }
                    if (row < 0) {
                        var columnHeaderSpanModel = self._modelManager._getSpanModel(1);
                        if (columnHeaderSpanModel && columnHeaderSpanModel.spans && columnHeaderSpanModel.spans.length > 0) {
                            return self._modelManager._hasPartSpans(-1, column, -1, columnCount, 1);
                        }
                    }
                    if (column < 0) {
                        var rowHeaderSpanModel = self._modelManager._getSpanModel(2);
                        if (rowHeaderSpanModel && rowHeaderSpanModel.spans && rowHeaderSpanModel.spans.length > 0) {
                            return self._modelManager._hasPartSpans(row, -1, rowCount, -1, 2);
                        }
                    }
                    var spanModel = self._modelManager._getSpanModel(3);
                    if (spanModel && spanModel.spans && spanModel.spans.length > 0) {
                        return self._modelManager._hasPartSpans(row, column, rowCount, columnCount, 3);
                    }
                    return false;
                };
                Worksheet.prototype.suspendPaint = function () {
                    var self = this;
                    var count = self._layoutSuspended;
                    self._layoutSuspended++;
                    if (count === 0) {
                        Worksheet._callFeatureHandler(self, const_onPaintSuspend, {
                            suspend: true
                        });
                    }
                };
                Worksheet.prototype.resumePaint = function () {
                    var self = this;
                    self._layoutSuspended--;
                    if (self._layoutSuspended <= 0) {
                        self._layoutSuspended = 0;
                        Worksheet._callFeatureHandler(self, const_onPaintSuspend, {
                            suspend: false
                        });
                        if (self._isActive()) {
                            self._invalidate();
                        }
                    }
                };
                Worksheet.prototype._isActive = function () {
                    var parent = this.parent;
                    return !parent || parent.getActiveSheet() === this;
                };
                Worksheet.prototype.isPaintSuspended = function () {
                    return this._layoutSuspended > 0;
                };
                Worksheet.prototype._cellRangeInflate = function (spans, cellRange) {
                    var self = this;
                    var spansLength = spans && spans.length;
                    for (var i = 0; i < spansLength; i++) {
                        var cr = spans[i];
                        if (cellRange.intersect(cr.row, cr.col, cr.rowCount, cr.colCount)) {
                            spans.splice(i, 1);
                            return self._cellRangeInflate(spans, cellRange.union(cr));
                        }
                    }
                    return cellRange;
                };
                Worksheet.prototype.getClipboardHelperObj = function () {
                    var clipboardHelper = this._getClipboardHelper();
                    return {
                        isCutting: clipboardHelper._isCutting,
                        ranges: clipboardHelper._ranges,
                        showInsertCopyPasteCells: clipboardHelper._showInsertCopyPasteCells
                    };
                };
                Worksheet.prototype._getClipboardHelper = function () {
                    var self = this;
                    var parent = self.parent;
                    if (!self._clipboardHelper) {
                        self._clipboardHelper = parent && parent._clipboardHelper;
                    }
                    return self._clipboardHelper;
                };
                Worksheet.prototype._getImageLoader = function () {
                    if (!this._imageLoader) {
                        var self_3 = this;
                        self_3._imageLoader = new imageLoader_1._ImageLoader(function () {
                            if (self_3._imageLoader) {
                                if (self_3.parent && self_3.parent._tasks && self_3.parent._tasks.endingCallback) {

                                } else {
                                    self_3.repaint();
                                }
                            }
                        });
                    }
                    return this._imageLoader;
                };
                Worksheet.prototype._commandManager = function () {
                    var self = this;
                    var parent = self.parent;
                    if (parent) {
                        return parent.commandManager();
                    }
                };
                Worksheet.prototype._raiseInvalidOperation = function (invalidType, message) {
                    this._trigger(common_1.Events.InvalidOperation, {
                        sheet: this,
                        sheetName: this.name(),
                        invalidType: invalidType,
                        message: message
                    });
                };
                Worksheet.prototype._raiseCellChanged = function (propertyName, row, column, sheetArea, oldValue, value) {
                    if (this._eventSuspended === 0) {
                        var args = {
                            sheet: this,
                            sheetName: this.name(),
                            row: row,
                            col: column,
                            sheetArea: sheetArea,
                            propertyName: propertyName,
                            oldValue: oldValue,
                            newValue: value,
                            isUndo: this._isUndo
                        };
                        this._trigger(common_1.Events.CellChanged, args);
                        var modelManager = this._modelManager;
                        modelManager._addEventItem(['cellChanged', propertyName, row, column, sheetArea, value, oldValue]);
                    }
                };
                Worksheet.prototype._raiseValueChanged = function (row, column, oldValue, newValue) {
                    this._trigger(common_1.Events.ValueChanged, {
                        sheet: this,
                        sheetName: this.name(),
                        row: row,
                        col: column,
                        oldValue: oldValue,
                        newValue: newValue
                    });
                };
                Worksheet.prototype._raiseColumnChanging = function (col, sheetArea, propertyName, value, oldValue) {
                    if (this._eventSuspended === 0) {
                        var args = {
                            sheet: this,
                            sheetName: this.name(),
                            col: col,
                            sheetArea: sheetArea,
                            propertyName: propertyName,
                            newValue: value,
                            oldValue: oldValue,
                            cancel: false
                        };
                        if (propertyName === 'addColumns' || propertyName === 'deleteColums') {
                            args.count = value;
                        }
                        this._trigger(common_1.Events.ColumnChanging, args);
                        if (args.cancel === true) {
                            return false;
                        }
                        var modelManager = this._modelManager;
                        modelManager._addEventItem(['columnChanging', col, sheetArea, propertyName, oldValue, value]);
                    }
                    return true;
                };
                Worksheet.prototype._raiseColumnChanged = function (col, sheetArea, propertyName, value, oldValue) {
                    if (this._eventSuspended === 0) {
                        var args = {
                            sheet: this,
                            sheetName: this.name(),
                            col: col,
                            sheetArea: sheetArea,
                            propertyName: propertyName,
                            newValue: value,
                            oldValue: oldValue,
                            isUndo: this._isUndo
                        };
                        if (propertyName === 'addColumns' || propertyName === 'deleteColumns') {
                            args.count = value;
                        }
                        this._trigger(common_1.Events.ColumnChanged, args);
                        var modelManager = this._modelManager;
                        modelManager._addEventItem(['columnChanged', col, sheetArea, propertyName, oldValue, value]);
                    } else {
                        this._clearCameraShapeCache(this, [
                            {
                                col: col
                            }
                        ], 1);
                    }
                };
                Worksheet.prototype._dispatchRangChangedIncludeTables = function (row, rowCount, col, colCount) {
                    var tableList;
                    var tableNames = [];
                    if (this.tables) {
                        tableList = this.tables._findCompletelyContainsByRange(row, rowCount, col, colCount);
                        for (var i = 0; i < tableList.length; i++) {
                            tableNames.push(tableList[i].name());
                        }
                        if (tableNames.length > 0) {
                            var argsIncludeTables = {
                                isUndo: this._isUndo,
                                sheet: this,
                                sheetName: this.name(),
                                row: row,
                                col: col,
                                rowCount: rowCount,
                                colCount: colCount,
                                tableNames: tableNames,
                                action: 2
                            };
                            this._trigger(common_1.Events.RangeChanged, argsIncludeTables);
                            var modelManager = this._modelManager;
                            modelManager._addEventItem(
                                ['rangeChanged', row, rowCount, col, colCount]
                            );
                        }
                    }
                };
                Worksheet.prototype._raiseRowChanging = function (row, sheetArea, propertyName, value, oldValue) {
                    if (this._eventSuspended === 0) {
                        var args = {
                            sheet: this,
                            sheetName: this.name(),
                            row: row,
                            sheetArea: sheetArea,
                            propertyName: propertyName,
                            newValue: value,
                            oldValue: oldValue,
                            cancel: false
                        };
                        if (propertyName === 'addRows' || propertyName === 'deleteRows') {
                            args.count = value;
                        }
                        this._trigger(common_1.Events.RowChanging, args);
                        if (args.cancel === true) {
                            return false;
                        }
                        var modelManager = this._modelManager;
                        modelManager._addEventItem(
                            ['rowChanging', row, sheetArea, propertyName, oldValue, value]
                        );
                    }
                    return true;
                };
                Worksheet.prototype._raiseRowChanged = function (row, sheetArea, propertyName, value, oldValue) {
                    if (this._eventSuspended === 0) {
                        var args = {
                            sheet: this,
                            sheetName: this.name(),
                            row: row,
                            sheetArea: sheetArea,
                            propertyName: propertyName,
                            newValue: value,
                            oldValue: oldValue,
                            isUndo: this._isUndo
                        };
                        if (propertyName === 'addRows' || propertyName === 'deleteRows') {
                            args.count = value;
                        }
                        this._trigger(common_1.Events.RowChanged, args);
                        var modelManager = this._modelManager;
                        modelManager._addEventItem(
                            ['rowChanged', row, sheetArea, propertyName, oldValue, value]
                        );
                    } else {
                        this._clearCameraShapeCache(this,
                            [
                                {
                                    row: row
                                }
                            ],
                            2
                        );
                    }
                };
                Worksheet.prototype._raiseZoomChanged = function (newZoomFactor, oldZoomFactor) {
                    if (oldZoomFactor !== newZoomFactor) {
                        this._trigger(common_1.Events.ViewZoomed, {
                            sheet: this,
                            sheetName: this.name(),
                            oldZoomFactor: newZoomFactor,
                            newZoomFactor: oldZoomFactor
                        });
                        this._trigger(common_1.Events.UserZooming, {
                            sheet: this,
                            sheetName: this.name(),
                            oldZoomFactor: newZoomFactor,
                            newZoomFactor: oldZoomFactor
                        });
                    }
                };
                Worksheet.prototype._raiseSelectionChanging = function (oldSelection, newSelection) {
                    if (!this._isDeselecting && this._eventHandler._notEqualSelecions(oldSelection, newSelection)) {
                        this._trigger(common_1.Events.SelectionChanging, {
                            sheet: this,
                            sheetName: this.name(),
                            oldSelections: oldSelection,
                            newSelections: newSelection
                        });
                        return true;
                    }
                    return false;
                };
                Worksheet.prototype._raiseSelectionChanged = function (oldSelections) {
                    this._trigger(common_1.Events.SelectionChanged, {
                        sheet: this,
                        sheetName: this.name(),
                        oldSelections: oldSelections,
                        newSelections: this.getSelections()
                    });
                };
                Worksheet.prototype._raiseRangeDataChanged = function (row, column, rowCount, columnCount, changedCells, action, sheetArea, value, tableNames, isUndo) {
                    var args = {
                        sheet: this,
                        sheetName: this.name(),
                        row: row,
                        col: column,
                        rowCount: rowCount,
                        colCount: columnCount,
                        changedCells: changedCells,
                        action: action
                    };
                    var argsIncludeTables = {
                        sheet: this,
                        sheetName: this.name(),
                        row: row,
                        col: column,
                        rowCount: rowCount,
                        colCount: columnCount,
                        changedCells: changedCells,
                        isUndo: !!isUndo,
                        action: action
                    };
                    if (sheetArea) {
                        args.sheetArea = sheetArea;
                        argsIncludeTables.sheetArea = sheetArea;
                    }
                    if (value) {
                        args.value = value;
                    }
                    if (changedCells && changedCells.length > 0) {
                        if (tableNames && tableNames.length > 0) {
                            argsIncludeTables.tableNames = tableNames;
                        }
                        this._trigger(common_1.Events.RangeChanged, argsIncludeTables);
                        this._trigger(common_1.Events.FormulatextboxRangeChanged, args);
                    }
                };
                Worksheet.prototype._raiseEditorStatusChanged = function (oldStatus, newStatus) {
                    var args = {
                        sheet: this,
                        sheetName: this.name(),
                        oldStatus: oldStatus,
                        newStatus: newStatus
                    };
                    this._trigger(common_1.Events.EditorStatusChanged, args);
                };
                Worksheet.prototype._getElem = function () {
                    if (!this._$elem) {
                        this._$elem = domUtil_1.GC$(_createElement('input'));
                    }
                    return this._$elem;
                };
                Worksheet.prototype._getPasteSkipInvisibleRange = function () {
                    var self = this;
                    return self.parent && self.parent.options.pasteSkipInvisibleRange;
                };
                Worksheet.prototype._getNextInvisibleCount = function (currentIndex, nextCount, isRow) {
                    var self = this;
                    var invisibleCount = 0;
                    var getSize = self.getColumnWidth;
                    var maxCount = self.getColumnCount();
                    if (isRow) {
                        getSize = self.getRowHeight;
                        maxCount = self.getRowCount();
                    }
                    currentIndex = currentIndex < 0 ? 0 : currentIndex;
                    for (var i = currentIndex; i < currentIndex + nextCount; i++) {
                        if (i < maxCount && getSize.call(self, i) === 0) {
                            invisibleCount++;
                            nextCount++;
                        }
                    }
                    return invisibleCount;
                };
                Worksheet.prototype._getPrevInvisibleCount = function (currentIndex, prevCount, isRow) {
                    var self = this;
                    var invisibleCount = 0;
                    var getSize = self.getColumnWidth;
                    if (isRow) {
                        getSize = self.getRowHeight;
                    }
                    currentIndex = currentIndex < 0 ? 0 : currentIndex;
                    for (var i = currentIndex; i > currentIndex - prevCount && i > 0; i--) {
                        if (getSize.call(self, i) === 0) {
                            invisibleCount++;
                            prevCount++;
                        }
                    }
                    return invisibleCount;
                };
                Worksheet.prototype._getActualInvisibleCount = function (currentIndex, actualCount, isRow) {
                    var self = this;
                    var invisbleCount = 0;
                    var getSize = self.getColumnWidth;
                    if (isRow) {
                        getSize = self.getRowHeight;
                    }
                    currentIndex = currentIndex < 0 ? 0 : currentIndex;
                    for (var i = currentIndex; i < currentIndex + actualCount; i++) {
                        if (getSize.call(self, i) === 0) {
                            invisbleCount++;
                        }
                    }
                    return invisbleCount;
                };
                Worksheet.prototype.bind = function (type, data, fn) {
                    this._getElem().bind(type + _gcSheet, data, fn);
                };
                Worksheet.prototype.unbind = function (type, fn) {
                    this._getElem().unbind(type + _gcSheet, fn);
                };
                Worksheet.prototype._trigger = function (type, data, ignoreEventSuspended) {
                    if (this.updateEventsData) {
                        this.updateEventsData(type, data);
                    }
                    if (this._eventSuspended === 0 || ignoreEventSuspended) {
                        this._getElem().trigger(type, data);
                    }
                };
                Worksheet.prototype.unbindAll = function () {
                    this.unbind(_gcSheet);
                };
                Worksheet.prototype._bind = function (type, data, fn) {
                    if (type.indexOf('.') >= 0) {
                        this.bind(type, data, fn);
                    } else {
                        this.bind(type + _gcSheetInternal, data, fn);
                    }
                };
                Worksheet.prototype._unbind = function (type, fn) {
                    if (type.indexOf('.') >= 0) {
                        this.unbind(type, fn);
                    } else {
                        this.unbind(type + _gcSheetInternal, fn);
                    }
                };
                Worksheet.prototype._unbindAll = function () {
                    this.unbind(_gcSheetInternal);
                };
                Worksheet.prototype._getBounds = function () {
                    var bounds = this._bounds;
                    return new common_1.Rect(bounds.x, bounds.y, bounds.width, bounds.height);
                };
                Worksheet.prototype._setBounds = function (rect) {
                    this._bounds = new common_1.Rect(rect.x, rect.y, rect.width, rect.height);
                };
                Worksheet.prototype.scroll = function (vPixels, hPixels) {
                    var worksheet = this;
                    var workbook = worksheet.parent;
                    if (workbook) {
                        var workbook_options = workbook.options;
                        var scrollByPixel = workbook_options.scrollByPixel;
                        var scrollPixel = workbook_options.scrollPixel;
                        var scrollService = workbook._scrollService;
                        var scrollbarShowMax = workbook_options.scrollbarShowMax;
                        var showHorizontalScrollbar = workbook_options.showHorizontalScrollbar;
                        var showVerticalScrollbar = workbook_options.showVerticalScrollbar;
                        if (hPixels !== 0) {
                            var colInfo = scrollService._getNewLeftColForPixelScroll(worksheet, Math.round(hPixels) / scrollPixel);
                            var index = colInfo._col, offset = scrollByPixel ? colInfo._offset : 0;
                            if (index !== worksheet._scrollLeftCol || offset !== worksheet._scrollLeftColOffset) {
                                scrollService._hScrollTo(worksheet, index, offset);
                                if (showHorizontalScrollbar) {
                                    worksheet._syncHScrollbarPosition();
                                    if (!scrollbarShowMax) {
                                        worksheet._needSyncHScrollbarSize = true;
                                    }
                                }
                            }
                        }
                        if (vPixels !== 0) {
                            var rowInfo = scrollService._getNewTopRowForPixelScroll(worksheet, Math.round(vPixels) / scrollPixel);
                            var index = rowInfo._row;
                            var offset = scrollByPixel ? rowInfo._offset : 0;
                            if (index !== worksheet._scrollTopRow || offset !== worksheet._scrollTopRowOffset) {
                                scrollService._vScrollTo(worksheet, index, offset);
                                if (showVerticalScrollbar) {
                                    worksheet._syncVScrollbarPosition();
                                    if (!scrollbarShowMax) {
                                        worksheet._needSyncVScrollbarSize = true;
                                    }
                                }
                            }
                        }
                    }
                };
                Worksheet.prototype.isCtrlPressed = function (hitTestType) {
                    return this._eventHandler && this._eventHandler.ctrl;
                };
                Worksheet.prototype.deselectIgnoreSpan = function () {
                    return false;
                };
                Worksheet.prototype._onVerticalScroll = function (hostWorkbook, data) {
                    var sheet = this;
                    var zoomFactor = sheet.zoom();
                    var data_newValue = data.newValue;
                    var data_oldValue = data.oldValue;
                    var data_scrollEventType = data.scrollEventType;
                    var scrollByPixel = hostWorkbook.options.scrollByPixel;
                    var scrollPixel = hostWorkbook.options.scrollPixel;
                    var v;
                    var newV;
                    data_oldValue = data.oldValue = isNullOrUndefined(data_oldValue) ? 0 : (scrollByPixel ? Math_round(data_oldValue) : convertToInt(data_oldValue + '', 10));
                    sheet._needSyncVScrollbarSize = false;
                    var firstPageTopRow = sheet._getFirstPageTopRow();
                    var lastVisualScrollRow = sheet._getLastVisualScrollRow();
                    var scrollbarShowMax = hostWorkbook.options.scrollbarShowMax;
                    var offset = 0;
                    if (scrollByPixel) {
                        data_newValue = Math_round(data_newValue);
                        var detailY = data_newValue - data_oldValue;
                        if (data_scrollEventType !== core_enum_1._ScrollEventType.thumbTrack) {
                            detailY *= scrollPixel * zoomFactor;
                            data_newValue = data_oldValue + detailY;
                            if (data_newValue < 0) {
                                data_newValue = 0;
                            }
                        }
                        if (!scrollbarShowMax) {
                            sheet._needSyncVScrollbarSize = true;
                            if (data_scrollEventType === core_enum_1._ScrollEventType.smallIncrement && data_newValue === data_oldValue) {
                                data_newValue += scrollPixel * zoomFactor;
                            } else {
                                data.ignoreUpdatePosition = true;
                            }
                        }
                        var frozenRowCount = sheet.frozenRowCount();
                        var rowCount = sheet.getRowCount() - sheet.frozenTrailingRowCount() - frozenRowCount;
                        var startRow = frozenRowCount;
                        var lastRow = startRow + rowCount - 1;
                        var totalHeight = 0;
                        var currentRowHeight = 0;
                        for (var row = startRow; row <= lastRow; row++) {
                            currentRowHeight = sheet._getZoomRowHeight(row);
                            totalHeight += currentRowHeight;
                            if (totalHeight >= data_newValue) {
                                offset = totalHeight - data_newValue - currentRowHeight;
                                v = row;
                                break;
                            }
                        }
                        if (isNullOrUndefined(v)) {
                            v = lastRow;
                            offset = -sheet._getZoomRowHeight(lastRow);
                            data_newValue = totalHeight;
                        }
                    } else {
                        v = convertToInt(data_newValue + '', 10);
                        v = sheet._getOriginalRowIndex(v);
                        if (data_scrollEventType === core_enum_1._ScrollEventType.largeDecrement || data_scrollEventType === core_enum_1._ScrollEventType.smallDecrement) {
                            if (data_scrollEventType === core_enum_1._ScrollEventType.largeDecrement) {
                                v = sheet._getPrevPageTopRow();
                            }
                            newV = sheet._getScrollableRow(v, true);
                            if (newV !== -1 && newV !== v) {
                                v = newV;
                            }
                            if (!scrollbarShowMax) {
                                sheet._needSyncVScrollbarSize = true;
                                data.ignoreUpdatePosition = true;
                            }
                        } else if (data_scrollEventType === core_enum_1._ScrollEventType.largeIncrement || data_scrollEventType === core_enum_1._ScrollEventType.smallIncrement) {
                            if (data_scrollEventType === core_enum_1._ScrollEventType.largeIncrement) {
                                v = sheet._getPageBottomRow();
                                if (v === sheet._scrollTopRow) {
                                    v++;
                                }
                            }
                            if (!scrollbarShowMax) {
                                sheet._needSyncVScrollbarSize = true;
                                if (data_scrollEventType === core_enum_1._ScrollEventType.smallIncrement && data_newValue === data_oldValue) {
                                    v++;
                                }
                            }
                            newV = sheet._getScrollableRow(v);
                            if (newV !== -1 && newV !== v) {
                                v = newV;
                            }
                        }
                        if (v < firstPageTopRow) {
                            v = firstPageTopRow;
                        }
                        if (v > lastVisualScrollRow) {
                            v = lastVisualScrollRow;
                        }
                    }
                    var scrollValue = scrollByPixel ? Math_round(data_newValue) : sheet._getVisibleRowIndex(v);
                    if (data.newValue !== scrollValue) {
                        data.newValue = scrollValue;
                    }
                    var newValueWithOffset = scrollValue;
                    var rowHeight = sheet._getZoomRowHeight(v);
                    if (rowHeight !== 0) {
                        newValueWithOffset += Math_abs(offset) / rowHeight;
                    }
                    data.newValueWithOffset = scrollByPixel ? scrollValue : newValueWithOffset;
                    if (data_oldValue !== scrollValue || scrollByPixel) {
                        hostWorkbook._scrollService._doScroll(sheet, v, offset);
                    }
                };
                Worksheet.prototype._onVerticalScrollStop = function (hostWorkbook) {
                    var sheet = this;
                    var scrollbarV = hostWorkbook._vScrollbar;
                    var isPixelScroll = scrollbarV._scrollType === core_enum_1.ScrollType.pixels;
                    if (!isPixelScroll) {
                        var value = sheet._getOriginalRowIndex(scrollbarV.value());
                        var firstPageTopRow = sheet._getFirstPageTopRow();
                        var lastVisualScrollRow = sheet._getLastVisualScrollRow();
                        if (value < firstPageTopRow) {
                            scrollbarV.value(sheet._getVisibleRowIndex(firstPageTopRow));
                        } else if (value > lastVisualScrollRow) {
                            scrollbarV.value(sheet._getVisibleRowIndex(lastVisualScrollRow));
                        }
                    }
                    hostWorkbook._removeTooltip();
                    if (!hostWorkbook.options.scrollbarShowMax) {
                        if (hostWorkbook._scrollService.scrolling) {
                            sheet._needSyncVScrollbarSize = true;
                        } else {
                            hostWorkbook._resizeVScrollBar();
                        }
                    }
                };
                Worksheet.prototype._onHorizontalScroll = function (hostWorkbook, data) {
                    var sheet = this;
                    var zoomFactor = sheet.zoom();
                    var data_newValue = data.newValue;
                    var data_oldValue = data.oldValue;
                    var data_scrollEventType = data.scrollEventType;
                    var scrollByPixel = hostWorkbook.options.scrollByPixel;
                    var scrollPixel = hostWorkbook.options.scrollPixel;
                    var v;
                    var newV;
                    data_oldValue = data.oldValue = isNullOrUndefined(data_oldValue) ? 0 : (scrollByPixel ? Math_round(data_oldValue) : convertToInt(data_oldValue + '', 10));
                    sheet._needSyncHScrollbarSize = false;
                    var firstPageLeftColumn = sheet._getFirstPageLeftColumn();
                    var lastVisualScrollColumn = sheet._getLastVisualScrollColumn();
                    var scrollbarShowMax = hostWorkbook.options.scrollbarShowMax;
                    var offset = 0;
                    if (scrollByPixel) {
                        data_newValue = Math_round(data_newValue);
                        var detailX = data_newValue - data_oldValue;
                        if (data_scrollEventType !== core_enum_1._ScrollEventType.thumbTrack) {
                            detailX *= scrollPixel * zoomFactor;
                            data_newValue = data_oldValue + detailX;
                            if (data_newValue < 0) {
                                data_newValue = 0;
                            }
                        }
                        if (!scrollbarShowMax) {
                            sheet._needSyncHScrollbarSize = true;
                            if (data_scrollEventType === core_enum_1._ScrollEventType.smallIncrement && data_newValue === data_oldValue) {
                                data_newValue += scrollPixel * zoomFactor;
                            } else {
                                data.ignoreUpdatePosition = true;
                            }
                        }
                        var frozenColumnCount = sheet.frozenColumnCount();
                        var columnCount = sheet.getColumnCount() - sheet.frozenTrailingColumnCount() - frozenColumnCount;
                        var startColumn = frozenColumnCount;
                        var lastColumn = startColumn + columnCount - 1;
                        var totalWidth = 0;
                        var currentColumnWidth = 0;
                        for (var column = startColumn; column <= lastColumn; column++) {
                            currentColumnWidth = sheet._getZoomColumnWidth(column);
                            totalWidth += currentColumnWidth;
                            if (totalWidth >= data_newValue) {
                                offset = totalWidth - data_newValue - currentColumnWidth;
                                v = column;
                                break;
                            }
                        }
                        if (isNullOrUndefined(v)) {
                            v = lastColumn;
                            offset = -sheet._getZoomColumnWidth(lastColumn);
                            data_newValue = totalWidth;
                        }
                    } else {
                        v = convertToInt(data_newValue + '', 10);
                        v = sheet._getOriginalColIndex(v);
                        if (data_scrollEventType === core_enum_1._ScrollEventType.largeDecrement || data_scrollEventType === core_enum_1._ScrollEventType.smallDecrement) {
                            if (data_scrollEventType === core_enum_1._ScrollEventType.largeDecrement) {
                                v = sheet._getPrevPageLeftColumn();
                            }
                            newV = sheet._getScrollableColumn(v, true);
                            if (newV !== -1 && newV !== v) {
                                v = newV;
                            }
                            if (!scrollbarShowMax) {
                                sheet._needSyncHScrollbarSize = true;
                                data.ignoreUpdatePosition = true;
                            }
                        } else if (data_scrollEventType === core_enum_1._ScrollEventType.largeIncrement || data_scrollEventType === core_enum_1._ScrollEventType.smallIncrement) {
                            if (data_scrollEventType === core_enum_1._ScrollEventType.largeIncrement) {
                                v = sheet._getPageRightColumn();
                                if (v === sheet._scrollLeftCol) {
                                    v++;
                                }
                            }
                            if (!scrollbarShowMax) {
                                sheet._needSyncHScrollbarSize = true;
                                if (data_scrollEventType === core_enum_1._ScrollEventType.smallIncrement && data_newValue === data_oldValue) {
                                    v++;
                                }
                            }
                            newV = sheet._getScrollableColumn(v);
                            if (newV !== -1 && newV !== v) {
                                v = newV;
                            }
                        }
                        if (v < firstPageLeftColumn) {
                            v = firstPageLeftColumn;
                        }
                        if (v > lastVisualScrollColumn) {
                            v = lastVisualScrollColumn;
                        }
                    }
                    var scrollValue = scrollByPixel ? Math_round(data_newValue) : sheet._getVisibleColIndex(v);
                    if (data.newValue !== scrollValue) {
                        data.newValue = scrollValue;
                    }
                    var newValueWithOffset = scrollValue;
                    var colWidth = sheet._getZoomColumnWidth(v);
                    if (colWidth !== 0) {
                        newValueWithOffset += Math_abs(offset) / colWidth;
                    }
                    data.newValueWithOffset = scrollByPixel ? scrollValue : newValueWithOffset;
                    if (data_oldValue !== scrollValue || scrollByPixel) {
                        hostWorkbook._scrollService._doScroll(sheet, v, offset, true);
                    }
                };
                Worksheet.prototype._onHorizontalScrollStop = function (hostWorkbook) {
                    var sheet = this;
                    var scrollbarH = hostWorkbook._hScrollbar;
                    if (sheet && scrollbarH) {
                        var isPixelScroll = scrollbarH._scrollType === core_enum_1.ScrollType.pixels;
                        if (!isPixelScroll) {
                            var value = sheet._getOriginalColIndex(scrollbarH.value());
                            var firstPageLeftColumn = sheet._getFirstPageLeftColumn();
                            var lastVisualScrollColumn = sheet._getLastVisualScrollColumn();
                            if (value < firstPageLeftColumn) {
                                scrollbarH.value(sheet._getVisibleColIndex(firstPageLeftColumn));
                            } else if (value > lastVisualScrollColumn) {
                                scrollbarH.value(sheet._getVisibleColIndex(lastVisualScrollColumn));
                            }
                        }
                        hostWorkbook._removeTooltip();
                        if (!hostWorkbook.options.scrollbarShowMax) {
                            if (hostWorkbook._scrollService.scrolling) {
                                sheet._needSyncHScrollbarSize = true;
                            } else {
                                hostWorkbook._resizeHScrollBar();
                            }
                        }
                    }
                };
                Worksheet.prototype._resizeHScrollBar = function (scrollbarMaxAlign, scrollbarShowMax, scrollbarH) {
                    var sheet = this;
                    var isPixelScroll = scrollbarH && scrollbarH._scrollType === core_enum_1.ScrollType.pixels;
                    var frozenColCount = sheet.frozenColumnCount();
                    var columnCount = sheet.getColumnCount() - sheet.frozenTrailingColumnCount() - frozenColCount;
                    var startColumn = frozenColCount;
                    var layout = sheet._getSheetLayout();
                    var viewportWidth = sheet._getActualViewportWidth(layout);
                    var endColumn = columnCount === 0 ? startColumn : startColumn + columnCount - 1;
                    var scrollLeftCol = sheet._scrollLeftCol;
                    var scrollLeftColOffset = sheet._scrollLeftColOffset;
                    var leftCol;
                    var endOffset = 0;
                    if (scrollbarMaxAlign) {
                        if (isPixelScroll) {
                            var _a = sheet._getLeftColWhenLastColShowCompleteForPixelScroll(viewportWidth, startColumn, endColumn);
                            var _col = _a._col;
                            var _offset = _a._offset;
                            leftCol = _col;
                            endOffset = _offset;
                        } else {
                            leftCol = sheet._getLeftColWhenLastColShowComplete(viewportWidth, startColumn, endColumn);
                        }
                        endColumn = leftCol;
                    } else {
                        if (isPixelScroll) {
                            endOffset = -sheet._getZoomColumnWidth(endColumn);
                        }
                    }
                    if (!scrollbarShowMax) {
                        var lastNonNullRowAndCol = sheet._getLastNonNullRowAndCol();
                        var lastNonNullCol = lastNonNullRowAndCol.lastNonNullCol;
                        var maxDirtyEndColumn = sheet._getLeftColWhenLastColShowComplete(viewportWidth, startColumn, lastNonNullCol);
                        if (maxDirtyEndColumn === startColumn) {
                            maxDirtyEndColumn++;
                            if (maxDirtyEndColumn > endColumn) {
                                maxDirtyEndColumn = endColumn;
                            }
                        }
                        if (scrollLeftCol > maxDirtyEndColumn) {
                            endColumn = scrollLeftCol < endColumn ? scrollLeftCol : endColumn;
                        } else {
                            endColumn = maxDirtyEndColumn;
                        }
                        endOffset = scrollLeftColOffset;
                    } else {
                        if (isPixelScroll && !scrollbarMaxAlign) {
                            endOffset = -sheet._getZoomColumnWidth(endColumn);
                        }
                    }
                    if (scrollLeftCol > endColumn) {
                        sheet._scrollLeftCol = endColumn;
                        sheet._scrollLeftColOffset = isPixelScroll ? endOffset : 0;
                    } else if (scrollLeftCol === endColumn && endOffset > scrollLeftColOffset) {
                        sheet._scrollLeftColOffset = isPixelScroll ? endOffset : 0;
                    }
                    var newLeftCol = sheet._getScrollableColumn(sheet._scrollLeftCol);
                    if (newLeftCol !== -1 && newLeftCol !== sheet._scrollLeftCol) {
                        sheet._scrollLeftCol = newLeftCol;
                    }
                    if (scrollbarH) {
                        var minimum = 0;
                        var maximum = 0;
                        var pageValue = 0;
                        var value = 0;
                        if (!isPixelScroll) {
                            minimum = sheet._getVisibleColIndex(startColumn);
                            maximum = sheet._getVisibleColIndex(endColumn);
                            pageValue = sheet._getPageValueH();
                            value = sheet._getVisibleColIndex(sheet._scrollLeftCol);
                            if (pageValue < 1) {
                                pageValue = 1;
                            }
                        } else {
                            minimum = sheet._getVisibleColumnPosition(startColumn);
                            maximum = sheet._getVisibleColumnPosition(endColumn) - endOffset;
                            pageValue = viewportWidth;
                            value = sheet._getVisibleColumnPosition(sheet._scrollLeftCol) - sheet._scrollLeftColOffset;
                        }
                        scrollbarH._minimum(minimum);
                        scrollbarH._maximum(maximum);
                        scrollbarH._pageValue(pageValue);
                        scrollbarH._refreshLayout();
                        scrollbarH.value(value);
                    }
                };
                Worksheet.prototype._resizeVScrollBar = function (scrollbarMaxAlign, scrollbarShowMax, scrollbarV) {
                    var sheet = this;
                    var isPixelScroll = scrollbarV && scrollbarV._scrollType === core_enum_1.ScrollType.pixels;
                    var frozenRowCount = sheet.frozenRowCount();
                    var rowCount = sheet.getRowCount() - sheet.frozenTrailingRowCount() - frozenRowCount;
                    var startRow = frozenRowCount;
                    var layout = sheet._getSheetLayout();
                    var endRow = rowCount === 0 ? startRow : startRow + rowCount - 1;
                    var scrollTopRow = sheet._scrollTopRow;
                    var scrollTopRowOffset = sheet._scrollTopRowOffset;
                    var topRow, endOffset = 0;
                    var viewportHeight = sheet._getActualViewportHeight(layout);
                    if (scrollbarMaxAlign) {
                        if (isPixelScroll) {
                            var _a = sheet._getTopRowWhenLastRowShowCompleteForPixelScroll(viewportHeight, startRow, endRow);
                            var _row = _a._row;
                            var _offset = _a._offset;
                            topRow = _row;
                            endOffset = _offset;
                        } else {
                            topRow = sheet._getTopRowWhenLastRowShowComplete(viewportHeight, startRow, endRow);
                        }
                        endRow = topRow;
                    } else {
                        if (isPixelScroll) {
                            endOffset = -sheet._getZoomRowHeight(endRow);
                        }
                    }
                    if (!scrollbarShowMax) {
                        var lastNonNullRowAndCol = sheet._getLastNonNullRowAndCol();
                        var lastNonNullRow = lastNonNullRowAndCol.lastNonNullRow;
                        var maxDirtyEndRow = sheet._getTopRowWhenLastRowShowComplete(viewportHeight, startRow, lastNonNullRow);
                        if (maxDirtyEndRow === startRow) {
                            maxDirtyEndRow++;
                            if (maxDirtyEndRow > endRow) {
                                maxDirtyEndRow = endRow;
                            }
                        }
                        if (scrollTopRow > maxDirtyEndRow) {
                            endRow = scrollTopRow < endRow ? scrollTopRow : endRow;
                        } else {
                            endRow = maxDirtyEndRow;
                        }
                        endOffset = scrollTopRowOffset;
                    } else {
                        if (isPixelScroll && !scrollbarMaxAlign) {
                            endOffset = -sheet._getZoomRowHeight(endRow);
                        }
                    }
                    if (scrollTopRow > endRow) {
                        sheet._scrollTopRow = endRow;
                        sheet._scrollTopRowOffset = isPixelScroll ? endOffset : 0;
                    } else if (scrollTopRow === endRow && endOffset > scrollTopRowOffset) {
                        sheet._scrollTopRowOffset = isPixelScroll ? endOffset : 0;
                    }
                    var newTopRow = sheet._getScrollableRow(sheet._scrollTopRow);
                    if (newTopRow !== -1 && newTopRow !== sheet._scrollTopRow) {
                        sheet._scrollTopRow = newTopRow;
                    }
                    if (scrollbarV) {
                        var minimum = 0;
                        var maximum = 0;
                        var pageValue = 0;
                        var value = 0;
                        if (!isPixelScroll) {
                            minimum = sheet._getVisibleRowIndex(startRow);
                            maximum = sheet._getVisibleRowIndex(endRow);
                            pageValue = sheet._getPageValueV();
                            value = sheet._getVisibleRowIndex(sheet._scrollTopRow);
                            if (pageValue < 1) {
                                pageValue = 1;
                            }
                        } else {
                            minimum = sheet._getVisibleRowPosition(startRow);
                            maximum = sheet._getVisibleRowPosition(endRow) - endOffset;
                            pageValue = viewportHeight;
                            value = sheet._getVisibleRowPosition(sheet._scrollTopRow) - sheet._scrollTopRowOffset;
                        }
                        scrollbarV._minimum(minimum);
                        scrollbarV._maximum(maximum);
                        scrollbarV._pageValue(pageValue);
                        scrollbarV._refreshLayout();
                        scrollbarV.value(value);
                    }
                };
                Worksheet.prototype._onCultureChanged = function () {
                    var sheet = this;
                    var rowCount = sheet.getRowCount();
                    var colCount = sheet.getColumnCount();
                    for (var row = 0; row < rowCount; row++) {
                        for (var col = 0; col < colCount; col++) {
                            var value = sheet.getValue(row, col);
                            if (!(value instanceof Date)) {
                                continue;
                            }
                            var style = sheet.getStyle(row, col);
                            if (style) {
                                style._setActualAutoFormatter(value);
                            }
                            sheet._setStyleObject(row, col, style);
                        }
                    }
                };
                Worksheet._ID = 1;
                Worksheet._defaultOptions = defaultOptions;
                Worksheet._defaultRowCount = 200;
                Worksheet._defaultColCount = 20;
                Worksheet._defaultRowHeaderColumnCount = 1;
                Worksheet._defaultColHeaderRowCount = 1;
                return Worksheet;
            }());
            exports.Worksheet = Worksheet;
            common_1._defineFeature(Worksheet);
            var Worksheet_prototype = Worksheet.prototype;
            Worksheet_prototype.visible = defProperty('visible', true, function (value) {
                var self = this, parent = self.parent;
                var sheets = parent.sheets;
                var sheetCount = sheets.length;
                var index = domUtil_1.GC$.inArray(self, sheets);
                var activeSheetIndex = parent.getActiveSheetIndex();
                if (value) {
                    if (activeSheetIndex < 0) {
                        parent._setActiveSheetIndexImp(index, 1);
                        if (parent._tabStrip && parent._tabStrip._firstTab < 0) {
                            parent._tabStrip._firstTab = index;
                        }
                    } else {
                        parent._doTabHSResize();
                    }
                } else if (index === activeSheetIndex) {
                    var n = index + 1;
                    while (n < sheetCount && !sheets[n].visible()) {
                        n++;
                    }
                    if (n >= sheetCount) {
                        n = index - 1;
                        while (n >= 0 && !sheets[n].visible()) {
                            n--;
                        }
                    }
                    if (parent._tabStrip && n < parent._tabStrip._firstTab) {
                        parent._tabStrip._firstTab = n;
                    }
                    if (n < 0) {
                        self._dispose(false);
                        parent._activeSheetIndex = n;
                        parent._doResize();
                    } else {
                        parent._setActiveSheetIndexImp(n, 1);
                    }
                } else {
                    parent._doTabHSResize();
                }
            });
            Worksheet_prototype.frozenColumnCount = defProperty('frozenColumnCount', 0, function (value) {
                var self = this;
                if (self._scrollLeftCol < value) {
                    self._scrollLeftCol = value;
                } else if (value === '' || value === 0 || value === null) {
                    self._scrollLeftCol = 0;
                }
                self._needSyncHScrollbarSize = true;
                self._invalidate();
            }, function (value) {
                return value >= 0;
            });
            Worksheet_prototype.frozenRowCount = defProperty('frozenRowCount', 0, function (value) {
                var self = this;
                if (self._scrollTopRow < value) {
                    self._scrollTopRow = value;
                } else if (value === '' || value === 0 || value === null) {
                    self._scrollTopRow = 0;
                }
                self._needSyncVScrollbarSize = true;
                self._invalidate();
            }, function (value) {
                return value >= 0;
            });
            function _composeTableFooterStyle(sheet, row, col, style, sheetArea) {
                if (row === -1 && col === -1) {
                    return;
                }
                if (isNullOrUndefined(sheetArea)) {
                    sheetArea = 3;
                }
                if (sheetArea === 3) {
                    var table = sheet.tables && sheet.tables.find(row, col);
                    if (table && table._showFooter && row === table.footerIndex()) {
                        Worksheet._callFeatureHandler(sheet, 'composeTableFooterList', {
                            table: table,
                            row: row,
                            col: col,
                            style: style
                        });
                    }
                }
            }
        }),
        'CalcEngine': (function (module, exports) {
            module.exports = GC.Spread.CalcEngine;
        }),
        'Common': (function (module, exports) {
            module.exports = GC.Spread;
        }),
        'SheetsCalc': (function (module, exports) {
            module.exports = GC.Spread.Sheets.CalcEngine;
        })
    });
    return GC;
};
//# sourceMappingURL=gc.spread.sheets.core.14.2.5.js.map